import React, { useEffect, useMemo, useRef, useState } from 'react';
import { AlertSeverity, Category, Child, CustomMode, MonitoringAlert, SafetyPlaybook } from '../types';
import {
  Bar,
  BarChart,
  CartesianGrid,
  PolarAngleAxis,
  PolarGrid,
  Radar as RadarComponent,
  RadarChart,
  Tooltip,
  XAxis,
  YAxis,
} from 'recharts';
import { useNavigate } from 'react-router-dom';
import {
  diagnosePsychScenarioFromAlerts,
  InappropriateContentSubtype,
  PsychScenarioId,
  ThreatExposureSubtype,
} from '../services/psychDiagnosticService';
import { fetchPlaybooks, sendRemoteCommand } from '../services/firestoreService';
import { getDefenseActionsWithPlaybooks } from '../services/ruleEngineService';

interface PsychologicalInsightViewProps {
  theme: 'light' | 'dark';
  child?: Child;
  alerts?: MonitoringAlert[];
  lang?: 'ar' | 'en';
  onAcceptPlan: (plan: Partial<CustomMode>) => string | void;
  onApplyModeToChild?: (childId: string, modeId?: string) => Promise<void> | void;
  onPlanExecutionResult?: (summary: { done: number; failed: number; skipped: number }) => void;
  onSaveExecutionEvidence?: (payload: PlanExecutionEvidencePayload) => Promise<string | void> | string | void;
}

interface InterventionStep {
  week: string;
  goal: string;
  action: string;
}

interface GuidanceScenario {
  id: PsychScenarioId;
  title: string;
  icon: string;
  severity: AlertSeverity;
  severityColor: string;
  symptoms: string[];
  lurePatterns: string[];
  prevention: string[];
  interventionProgram: InterventionStep[];
  dialogues: {
    situation: string;
    opener: string;
    advice: string;
  }[];
  alertTemplates: string[];
  incidentPlan: string[];
}

interface AutoExecutionStep {
  id: string;
  title: string;
  description: string;
  command:
    | 'takeScreenshot'
    | 'blockApp'
    | 'setVideoSource'
    | 'setAudioSource'
    | 'startLiveStream'
    | 'lockDevice'
    | 'playSiren'
    | 'lockscreenBlackout'
    | 'walkieTalkieEnable'
    | 'cutInternet'
    | 'blockCameraAndMic'
    | 'notifyParent';
  value: any;
  minSeverity: AlertSeverity;
  enabledByDefault: boolean;
}

type AutoStepStatus = 'idle' | 'pending' | 'done' | 'error' | 'skipped';
type PlanVideoSource = 'camera_front' | 'camera_back' | 'screen';
type PlanAudioSource = 'mic' | 'system';
type PlanTimelineStatus = 'done' | 'error' | 'skipped' | 'info';
type ScenarioSectionKey =
  | 'symptoms'
  | 'lurePatterns'
  | 'prevention'
  | 'incidentPlan'
  | 'alertTemplates'
  | 'interventionProgram'
  | 'dialogues';
type PreviewSectionKey = 'symptoms' | 'lurePatterns';

interface PreviewOperationalInsight {
  badge: string;
  whyNow: string;
  immediateAction: string;
  toneClass: string;
}

interface PlanTimelineEntry {
  id: string;
  title: string;
  detail: string;
  status: PlanTimelineStatus;
  at: Date;
}

interface PlanExecutionEvidencePayload {
  childId: string;
  childName: string;
  scenarioId: PsychScenarioId;
  threatSubtype?: ThreatExposureSubtype;
  contentSubtype?: InappropriateContentSubtype;
  scenarioTitle: string;
  severity: AlertSeverity;
  dominantPlatform: string;
  summary: { done: number; failed: number; skipped: number };
  timeline: Array<{
    title: string;
    detail: string;
    status: PlanTimelineStatus;
    at: string;
  }>;
}

const severityRank: Record<AlertSeverity, number> = {
  [AlertSeverity.LOW]: 1,
  [AlertSeverity.MEDIUM]: 2,
  [AlertSeverity.HIGH]: 3,
  [AlertSeverity.CRITICAL]: 4,
};

const scenarioBlockedDomains: Record<PsychScenarioId, string[]> = {
  bullying: ['discord.com', 'telegram.org'],
  threat_exposure: ['discord.com', 'telegram.org', 'snapchat.com'],
  gaming: ['roblox.com', 'epicgames.com', 'discord.com'],
  inappropriate_content: ['reddit.com', 'xvideos.com', 'pornhub.com'],
  cyber_crime: ['pastebin.com', 'discord.com', 'telegram.org'],
  crypto_scams: ['binance.com', 'okx.com', 'telegram.org'],
  phishing_links: ['bit.ly', 'tinyurl.com', 't.me', 'discord.com'],
  self_harm: ['reddit.com', 'discord.com', 'telegram.org'],
  sexual_exploitation: ['snapchat.com', 'telegram.org', 'discord.com'],
  account_theft_fraud: ['bit.ly', 'tinyurl.com', 't.me', 'discord.com'],
  gambling_betting: ['stake.com', '1xbet.com', 'bet365.com'],
  privacy_tracking: ['grabify.link', 'iplogger.org', 'shorturl.at'],
  harmful_challenges: ['tiktok.com', 'youtube.com', 'discord.com'],
};

const guidanceScenariosBase: GuidanceScenario[] = [
  {
    id: 'bullying',
    title: 'التنمر الإلكتروني',
    icon: '🧩',
    severity: AlertSeverity.HIGH,
    severityColor: 'bg-rose-600',
    symptoms: [
      'تجنب الطفل تطبيقات محددة أو حذف الرسائل بسرعة.',
      'تغير المزاج بعد فترات استخدام قصيرة.',
      'انسحاب اجتماعي أو رفض الذهاب للمدرسة دون مبرر واضح.',
    ],
    lurePatterns: [
      'مجموعات تستفز الطفل ثم تنشر لقطات محرجة.',
      'حسابات وهمية لإهانة متكررة وإقصاء اجتماعي.',
      'تعليقات تحريضية تدفع الطفل للرد الانفعالي.',
    ],
    prevention: [
      'تشديد الخصوصية: من يراسل/يشاهد المنشورات.',
      'منع الرسائل من الغرباء داخل الألعاب والمنصات.',
      'تدريب الطفل على قاعدة: وثّق، احظر، بلّغ، لا ترد.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'احتواء فوري', action: 'جلسة دعم + توثيق الأدلة + حظر الحسابات المؤذية.' },
      { week: 'الأسبوع 2', goal: 'إيقاف الاستنزاف', action: 'تحديث إعدادات الخصوصية ومراقبة نقاط التماس عالية الخطر.' },
      { week: 'الأسبوع 3', goal: 'استعادة الثقة', action: 'حوار تدريجي وإشراك المدرسة إذا كانت البيئة مشتركة.' },
      { week: 'الأسبوع 4', goal: 'تثبيت التعافي', action: 'خطة متابعة أسبوعية قصيرة مع قياس تحسن السلوك.' },
    ],
    dialogues: [
      {
        situation: 'افتتاح بلا لوم',
        opener: 'أنا معك، وأي إساءة وصلت لك ليست خطأك. احكي لي بهدوء.',
        advice: 'لا تبدأ بالأسئلة الاتهامية، ابدأ بالأمان النفسي.',
      },
      {
        situation: 'تعطيل الضرر',
        opener: 'سنوقف الحسابات المسيئة الآن، ونحفظ الأدلة قبل أي حذف.',
        advice: 'التوثيق يسبق الحذف دائمًا.',
      },
      {
        situation: 'تثبيت الثقة',
        opener: 'إبلاغك لنا قوة، وليس ضعفًا. نحن فريق واحد.',
        advice: 'أعد تعريف الشجاعة بأنها طلب مساعدة مبكر.',
      },
    ],
    alertTemplates: [
      'تنبيه متوسط: مؤشرات ضغط اجتماعي رقمية، يُنصح بحوار هادئ اليوم.',
      'تنبيه مرتفع: نمط تنمر متكرر، ابدأ مسار التوثيق والحظر.',
    ],
    incidentPlan: [
      'طمأنة الطفل فورًا: لا لوم ولا عقوبة لحظة الإبلاغ.',
      'حفظ الأدلة: لقطات شاشة، أسماء الحسابات، التوقيت.',
      'حظر وإبلاغ داخل المنصة.',
      'ضبط الخصوصية وتقييد الرسائل من الغرباء.',
      'متابعة نفسية خلال 72 ساعة.',
    ],
  },
  {
    id: 'threat_exposure',
    title: 'التهديد والابتزاز',
    icon: '🚨',
    severity: AlertSeverity.CRITICAL,
    severityColor: 'bg-red-700',
    symptoms: [
      'خوف واضح عند وصول إشعارات من جهة بعينها.',
      'إخفاء الهاتف أو حذف محادثات بشكل متسارع.',
      'طلب مال/بطاقات بشكل غير مبرر أو توتر حاد.',
    ],
    lurePatterns: [
      'بناء ثقة زائفة ثم طلب صور أو معلومات خاصة.',
      'تهديد بالنشر أو التشهير بعد الحصول على محتوى حساس.',
      'ابتزاز مالي عبر بطاقات الهدايا أو التحويلات الرقمية.',
    ],
    prevention: [
      'قاعدة ذهبية: لا صور خاصة، لا رموز تحقق، لا تفاوض.',
      'تفعيل 2FA للحسابات الرئيسية.',
      'تعليم الطفل استخدام زر المساعدة الفوري داخل التطبيق.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'إيقاف النزف', action: 'تطبيق خطة 10 دقائق بالكامل وتصعيد الحماية.' },
      { week: 'الأسبوع 2', goal: 'تحصين الحسابات', action: 'تغيير كلمات المرور، مراجعة الجلسات، إغلاق المسارات المكشوفة.' },
      { week: 'الأسبوع 3', goal: 'دعم نفسي', action: 'جلسات تفريغ قلق، وتأكيد عدم الذنب على الطفل.' },
      { week: 'الأسبوع 4', goal: 'منع التكرار', action: 'تحديث سياسات الأسرة الرقمية ورفع وعي الطفل.' },
    ],
    dialogues: [
      {
        situation: 'إيقاف التصعيد',
        opener: 'سلامتك أولًا. لن نرد على أي تهديد، وسنتعامل رسميًا.',
        advice: 'لا دفع، لا تفاوض، لا حذف قبل التوثيق.',
      },
      {
        situation: 'تثبيت الأمان',
        opener: 'لن تواجه هذا وحدك، سنحل الموضوع خطوة بخطوة.',
        advice: 'أبرز أن الطفل ضحية وليس مذنبًا.',
      },
      {
        situation: 'التحرك القانوني',
        opener: 'سنجمع الدليل ثم نبلّغ القنوات المعتمدة لحمايتك.',
        advice: 'حفظ الهوية الرقمية للجهة المهددة مهم قبل الإبلاغ.',
      },
    ],
    alertTemplates: [
      'تنبيه حرج: احتمال تهديد/ابتزاز مباشر. ابدأ خطة 10 دقائق الآن.',
      'تنبيه حرج: سلوك حذف محادثات + خوف + طلب مالي، يلزم تدخل فوري.',
    ],
    incidentPlan: [
      'لا تفاوض ولا دفع تحت أي ضغط.',
      'حفظ الأدلة الرقمية فورًا.',
      'إيقاف التواصل مع المبتز وحظره.',
      'تأمين الحسابات (تغيير كلمة المرور + 2FA).',
      'إبلاغ المنصة والجهة المختصة حسب الإجراءات المحلية.',
    ],
  },
  {
    id: 'gaming',
    title: 'إدمان الألعاب',
    icon: '🎮',
    severity: AlertSeverity.HIGH,
    severityColor: 'bg-indigo-600',
    symptoms: [
      'سهر مفرط واضطراب نوم متكرر.',
      'عصبية عالية عند سحب الجهاز أو انتهاء الوقت.',
      'تراجع دراسي وانسحاب من أنشطة واقعية.',
    ],
    lurePatterns: [
      'مكافآت يومية تبني تعلقًا قهريًا.',
      'ضغط الأصدقاء في الفرق التنافسية.',
      'مشتريات داخل اللعبة تعزز مطاردة الخسارة.',
    ],
    prevention: [
      'تفعيل Bedtime تلقائي.',
      'جدولة وقت اللعب وربطه بالمهام اليومية.',
      'قفل المشتريات بكلمة مرور ولي الأمر.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'استقرار النوم', action: 'تثبيت وقت نوم ومنع الاستخدام الليلي.' },
      { week: 'الأسبوع 2', goal: 'خفض تدريجي', action: 'تقليل 10%-15% من الاستخدام اليومي.' },
      { week: 'الأسبوع 3', goal: 'بدائل واقعية', action: 'إدخال نشاط بديل ثابت (رياضة/هواية).' },
      { week: 'الأسبوع 4', goal: 'تثبيت السلوك', action: 'نظام مكافآت مرتبط بالالتزام الدراسي والسلوكي.' },
    ],
    dialogues: [
      {
        situation: 'اتفاق منصف',
        opener: 'أنا لا أريد المنع الكامل، فقط نحتاج توازنًا يحميك.',
        advice: 'اختر صيغة شراكة لا صيغة عقاب.',
      },
      {
        situation: 'تنظيم تدريجي',
        opener: 'خلّنا نبدأ بخطة أسبوع، ثم نراجع سوا النتائج.',
        advice: 'التغيير التدريجي ينجح أكثر من القطع المفاجئ.',
      },
      {
        situation: 'دعم المهارة',
        opener: 'مهارتك ممتازة، ونريدها تستمر بدون أن تضر نومك ودراستك.',
        advice: 'اربط الثناء بضوابط الاستخدام.',
      },
    ],
    alertTemplates: [
      'تنبيه نوم: استخدام متأخر متكرر، يُنصح بتفعيل وضع النوم.',
      'تنبيه سلوكي: تجاوزات وقت الشاشة مع انفعال عند الإيقاف.',
    ],
    incidentPlan: [
      'تهدئة الموقف وعدم الدخول في صدام لحظي.',
      'تفعيل وضع النوم وإغلاق التطبيقات عالية الاستهلاك.',
      'تحديد خطة أسبوع خفض تدريجي.',
      'إدخال نشاط بديل يومي.',
      'مراجعة أسبوعية بالأرقام لا بالانطباعات.',
    ],
  },
  {
    id: 'inappropriate_content',
    title: 'المحتوى غير المناسب',
    icon: '🛡️',
    severity: AlertSeverity.HIGH,
    severityColor: 'bg-violet-700',
    symptoms: [
      'إغلاق مفاجئ للشاشة عند الاقتراب.',
      'تصفح خفي متكرر أو تاريخ محذوف باستمرار.',
      'توتر أو خجل زائد بعد التواجد على الإنترنت.',
    ],
    lurePatterns: [
      'روابط مضللة داخل فيديوهات أو ألعاب.',
      'حسابات فضولية تنشر مواد صادمة بعناوين بريئة.',
      'نوافذ منبثقة تستدرج الطفل خارج بيئة آمنة.',
    ],
    prevention: [
      'SafeSearch + DNS فلترة حسب العمر.',
      'قائمة مواقع/تطبيقات موثوقة فقط.',
      'رسالة أسرية ثابتة: أغلق وبلّغ بلا عقوبة.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'حماية فورية', action: 'تقوية الفلاتر وإزالة المصادر المكشوفة.' },
      { week: 'الأسبوع 2', goal: 'حوار تربوي', action: 'نقاش آمن عن المحتوى الصادم وطرق التبليغ.' },
      { week: 'الأسبوع 3', goal: 'بدائل صحية', action: 'إحلال محتوى مناسب للعمر ومراقب.' },
      { week: 'الأسبوع 4', goal: 'تثبيت العادة', action: 'مراجعة أسبوعية للتعرضات وتعديل الضبط.' },
    ],
    dialogues: [
      {
        situation: 'إزالة الخوف',
        opener: 'لو ظهر شيء مزعج، أغلقه وتعال مباشرة، ما فيه عقاب.',
        advice: 'أزل وصمة الاعتراف من البداية.',
      },
      {
        situation: 'توجيه عملي',
        opener: 'نعدل الإعدادات سوا حتى ما يتكرر الوصول لهذا المحتوى.',
        advice: 'الحوار يجب أن ينتهي بخطوة تقنية واضحة.',
      },
      {
        situation: 'تثبيت القاعدة',
        opener: 'أي رابط غريب أو محتوى صادم: لا فتح، فقط بلّغ.',
        advice: 'التكرار اليومي يبني سلوك الأمان.',
      },
    ],
    alertTemplates: [
      'تنبيه محتوى: محاولات وصول لتصنيفات محجوبة أعلى من المعتاد.',
      'تنبيه وقائي: يُنصح بتحديث مرشحات المحتوى لهذا العمر.',
    ],
    incidentPlan: [
      'إيقاف المصدر المسبب (رابط/حساب/تطبيق).',
      'مراجعة الفلاتر وإعدادات البحث الآمن.',
      'حوار احتواء قصير مع الطفل دون لوم.',
      'تفعيل قائمة بدائل آمنة للمحتوى.',
      'متابعة 7 أيام لقياس التكرار.',
    ],
  },
  {
    id: 'cyber_crime',
    title: 'الانحراف السيبراني',
    icon: '👨‍💻',
    severity: AlertSeverity.HIGH,
    severityColor: 'bg-slate-800',
    symptoms: [
      'استخدام أدوات غير موثوقة بصيغة هجومية.',
      'الحديث عن اختراق حسابات باعتباره إنجازًا.',
      'إخفاء الهوية بشكل مبالغ دون مبرر واقعي.',
    ],
    lurePatterns: [
      'قنوات تقدم سكربتات جاهزة بدافع الفضول.',
      'مجموعات تعطي مهام تخريبية كمنافسة.',
      'تحفيز اجتماعي حول القوة التقنية مقابل كسر القوانين.',
    ],
    prevention: [
      'حظر مصادر الأدوات المجهولة.',
      'شرح الفرق بين التعلم الأمني القانوني والتعدي.',
      'توجيه الموهبة إلى منصات CTF تعليمية بإشراف.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'احتواء السلوك', action: 'إيقاف الأدوات الخطرة ومراجعة الجهاز.' },
      { week: 'الأسبوع 2', goal: 'بديل قانوني', action: 'بدء مسار تعلم أخلاقي للأمن السيبراني.' },
      { week: 'الأسبوع 3', goal: 'وعي قانوني', action: 'جلسة عواقب جنائية مبسطة ومباشرة.' },
      { week: 'الأسبوع 4', goal: 'التزام مستمر', action: 'خطة استخدام تقنية خاضعة لمراجعة أسبوعية.' },
    ],
    dialogues: [
      {
        situation: 'إعادة توجيه المهارة',
        opener: 'ذكاؤك التقني مهم، والأفضل تحويله لمسار احترافي قانوني.',
        advice: 'اعترف بالموهبة أولًا ثم أعد توجيهها.',
      },
      {
        situation: 'حدود واضحة',
        opener: 'أي هجوم رقمي قد يصبح قضية جنائية تؤثر على مستقبلك.',
        advice: 'وضح العواقب بدون تهويل عاطفي.',
      },
      {
        situation: 'مسار بديل',
        opener: 'نختار معًا منصة تدريب قانونية ونبني مهاراتك بشكل آمن.',
        advice: 'البديل العملي يقلل العودة للسلوك الخطر.',
      },
    ],
    alertTemplates: [
      'تنبيه سلوكي: نشاط تقني هجومي متكرر يحتاج إعادة توجيه فوري.',
      'تنبيه تقني: تثبيت أدوات مجهولة المصدر على جهاز الطفل.',
    ],
    incidentPlan: [
      'إيقاف الأدوات المجهولة فورًا.',
      'فحص الجهاز وإزالة المصادر غير الموثوقة.',
      'جلسة توضيح قانوني قصيرة.',
      'إدراج مسار تعلم أخلاقي بديل.',
      'متابعة التزام أسبوعية.',
    ],
  },
  {
    id: 'phishing_links',
    title: 'التصيد والروابط الخبيثة',
    icon: '🔗',
    severity: AlertSeverity.CRITICAL,
    severityColor: 'bg-cyan-700',
    symptoms: [
      'استقبال روابط مختصرة أو صفحات دخول غير مألوفة بشكل متكرر.',
      'طلب رموز تحقق أو كلمة مرور بحجة التحقق من الحساب.',
      'خروج مفاجئ من الحسابات أو تنبيهات تسجيل دخول غير معروفة.',
    ],
    lurePatterns: [
      'رسائل عاجلة تطلب تحديث كلمة المرور فوراً.',
      'صفحات تسجيل دخول مزيفة مشابهة للمنصات المعروفة.',
      'روابط جوائز/هدايا تقود إلى جمع بيانات الحساب.',
    ],
    prevention: [
      'قاعدة ثابتة: لا فتح روابط حساسة قبل التحقق من الرابط الكامل.',
      'تفعيل 2FA وعدم مشاركة رموز التحقق مطلقاً.',
      'استخدام مدير كلمات مرور لتفادي إدخال بيانات في صفحات مزيفة.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'احتواء فوري', action: 'عزل الروابط، تغيير كلمات المرور، وإغلاق الجلسات المشبوهة.' },
      { week: 'الأسبوع 2', goal: 'تحصين الحسابات', action: 'تفعيل 2FA لكل الحسابات ومراجعة إعدادات الاسترداد.' },
      { week: 'الأسبوع 3', goal: 'رفع الوعي', action: 'تدريب عملي على التحقق من الروابط والبريد.' },
      { week: 'الأسبوع 4', goal: 'منع التكرار', action: 'قائمة نطاقات محظورة وتنبيهات استباقية للأسرة.' },
    ],
    dialogues: [
      {
        situation: 'إيقاف الضرر',
        opener: 'لن نفتح أي رابط جديد الآن. سنراجع كل الروابط معاً بخطوات واضحة.',
        advice: 'ابدأ بالطمأنة ثم انتقل مباشرة للإجراء التقني.',
      },
      {
        situation: 'تأمين الحساب',
        opener: 'سنغيّر كلمات المرور ونفعل التحقق الثنائي فوراً لحمايتك.',
        advice: 'اجعل الطفل شريكاً في عملية الأمان لا مجرد متلقي أوامر.',
      },
      {
        situation: 'تعزيز السلوك',
        opener: 'أي رابط يطلب كلمة مرور أو رمز تحقق يعتبر مشبوهاً حتى يثبت العكس.',
        advice: 'كرّر القاعدة يومياً حتى تتحول لعادات ثابتة.',
      },
    ],
    alertTemplates: [
      'تنبيه حرج: نمط تصيد/روابط خبيثة مرصود. تم تفعيل عزل الرابط وتأمين الحسابات.',
      'تنبيه متابعة: جارٍ تدوير كلمات المرور والتحقق من جلسات الدخول.',
    ],
    incidentPlan: [
      'إيقاف فتح الروابط المشبوهة فوراً.',
      'تغيير كلمات المرور للحسابات المتأثرة.',
      'تفعيل 2FA وإغلاق كل الجلسات النشطة غير الموثوقة.',
      'توثيق الرابط والرسالة الأصلية قبل الحذف.',
      'إبلاغ المنصة عن رسالة التصيد.',
    ],
  },
  {
    id: 'crypto_scams',
    title: 'الاحتيال المالي الرقمي',
    icon: '💸',
    severity: AlertSeverity.MEDIUM,
    severityColor: 'bg-amber-600',
    symptoms: [
      'اندفاع تجاه أرباح سريعة غير مفهومة.',
      'طلب مفاجئ لبطاقات أو تحويلات رقمية.',
      'الترويج لقنوات استثمار غير موثوقة بين الأصدقاء.',
    ],
    lurePatterns: [
      'وعود بعوائد مضمونة خلال وقت قصير.',
      'روابط Airdrop/محافظ مزيفة.',
      'ضغط من مؤثرين أو مجموعات توصيات مجهولة.',
    ],
    prevention: [
      'إيقاف أي تحويل بلا موافقة ولي الأمر.',
      'حظر الكلمات والقنوات الاحتيالية المتكررة.',
      'تعليم قواعد التحقق المالي الأساسي.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'تجميد المخاطر', action: 'وقف المدفوعات غير المعتمدة ومراجعة الحركة المالية.' },
      { week: 'الأسبوع 2', goal: 'تنظيف المصادر', action: 'حظر القنوات المشبوهة وتدقيق الروابط.' },
      { week: 'الأسبوع 3', goal: 'رفع الوعي', action: 'جلسة وعي مالي للأسرة مع أمثلة احتيال شائعة.' },
      { week: 'الأسبوع 4', goal: 'ضبط دائم', action: 'حدود مالية شهرية وإشعارات فورية.' },
    ],
    dialogues: [
      {
        situation: 'تصحيح المفهوم',
        opener: 'أي ربح سريع مضمون غالبًا خطر، خلنا نتحقق قبل أي خطوة.',
        advice: 'التوعية المالية المبكرة تقلل التورط.',
      },
      {
        situation: 'حدود الأسرة',
        opener: 'أي معاملة رقمية لازم تمر بمراجعة ولي الأمر.',
        advice: 'تحويل القاعدة إلى إجراء واضح داخل التطبيق.',
      },
      {
        situation: 'بدائل آمنة',
        opener: 'نتعلم الاستثمار الصحيح من مصادر موثوقة بدل القنوات العشوائية.',
        advice: 'استبدل المنع المجرد بمسار تعلم بديل.',
      },
    ],
    alertTemplates: [
      'تنبيه مالي: نشاط تحويل غير اعتيادي يحتاج مراجعة فورية.',
      'تنبيه احتيال: رصد تفاعل مع قنوات ربح سريع مجهولة.',
    ],
    incidentPlan: [
      'إيقاف أي عملية دفع قيد التنفيذ.',
      'حصر الحسابات والقنوات المتورطة.',
      'تأمين وسيلة الدفع المرتبطة.',
      'إبلاغ المنصة/البنك حسب الحالة.',
      'جلسة توعية مالية مباشرة للطفل.',
    ],
  },
  {
    id: 'self_harm',
    title: 'إيذاء النفس',
    icon: '🆘',
    severity: AlertSeverity.CRITICAL,
    severityColor: 'bg-rose-700',
    symptoms: [
      'عبارات يأس أو كراهية للذات بشكل متكرر.',
      'انعزال حاد وتراجع سريع في العناية اليومية.',
      'بحث أو تفاعل مع محتوى يؤذي النفس.',
    ],
    lurePatterns: [
      'مجموعات رقمية تمجّد إيذاء الذات.',
      'رسائل تشجع على تحديات مؤذية.',
      'تطبيع المحتوى اليائس على أنه حل للمشاعر.',
    ],
    prevention: [
      'رفع مستوى الفلترة لمحتوى إيذاء النفس.',
      'قناة تواصل يومية قصيرة مع الطفل بلا لوم.',
      'خطة أمان أسرية واضحة للحالات الحرجة.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'أمان فوري', action: 'تأمين البيئة الرقمية + تواجد أسري قريب + مراقبة لصيقة.' },
      { week: 'الأسبوع 2', goal: 'تفريغ الضغوط', action: 'جلسات دعم منظمة وتحديد محفزات التدهور.' },
      { week: 'الأسبوع 3', goal: 'استعادة الروتين', action: 'تنظيم النوم والنشاط البدني وتقليل العزلة.' },
      { week: 'الأسبوع 4', goal: 'منع الانتكاس', action: 'متابعة دورية بخطة تحذير مبكر.' },
    ],
    dialogues: [
      {
        situation: 'الاحتواء',
        opener: 'سلامتك أهم من أي شيء، وأنا هنا معك الآن.',
        advice: 'ابدأ بالأمان والتواجد الفعلي قبل أي نقاش تحليلي.',
      },
      {
        situation: 'فتح الحوار',
        opener: 'لو في أفكار مؤذية، تكلم معي فورًا بدون خوف من العقاب.',
        advice: 'خفّض نبرة الحكم وركّز على الاستماع.',
      },
      {
        situation: 'التصعيد المسؤول',
        opener: 'سنطلب دعمًا مختصًا لحمايتك، وهذا دليل قوة.',
        advice: 'التصعيد المبكر أفضل من الانتظار.',
      },
    ],
    alertTemplates: [
      'تنبيه حرج جداً: مؤشرات إيذاء النفس تتطلب تدخلًا فوريًا.',
      'تنبيه متابعة: تم تفعيل خطة أمان ومراقبة لصيقة.',
    ],
    incidentPlan: [
      'تأمين الطفل فورًا وعدم تركه منفردًا عند الخطر المرتفع.',
      'إزالة/حظر المحتوى والحسابات المحرضة على الأذى.',
      'فتح قناة تواصل مباشر وهادئ مع الطفل.',
      'توثيق المؤشرات الرقمية الأساسية.',
      'التصعيد لمختص دعم نفسي بشكل عاجل عند الضرورة.',
    ],
  },
  {
    id: 'sexual_exploitation',
    title: 'الاستدراج والاستغلال الجنسي',
    icon: '🚫',
    severity: AlertSeverity.CRITICAL,
    severityColor: 'bg-fuchsia-700',
    symptoms: [
      'تواصل سري مع حسابات مجهولة أكبر عمرًا.',
      'طلب صور خاصة أو معلومات شخصية حساسة.',
      'خوف واضح بعد محادثات خاصة متكررة.',
    ],
    lurePatterns: [
      'بناء ثقة سريع ثم طلب محتوى خاص.',
      'وعود وهمية بالحب أو الدعم مقابل السرية.',
      'تهديد بالنشر بعد جمع صور/معلومات.',
    ],
    prevention: [
      'منع الرسائل من الغرباء افتراضيًا.',
      'تعليم قاعدة: لا صور خاصة، لا أسرار مع الغرباء.',
      'مراجعة دورية لقنوات الدردشة عالية المخاطر.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'احتواء عاجل', action: 'إيقاف التواصل + حفظ الأدلة + حماية الحساب.' },
      { week: 'الأسبوع 2', goal: 'أمان رقمي', action: 'تغيير كلمات المرور وتفعيل 2FA ومراجعة الجلسات.' },
      { week: 'الأسبوع 3', goal: 'دعم نفسي', action: 'جلسة احتواء تعالج الذنب والخوف.' },
      { week: 'الأسبوع 4', goal: 'منع التكرار', action: 'خطة حماية تواصل اجتماعي مخصصة.' },
    ],
    dialogues: [
      {
        situation: 'إزالة الذنب',
        opener: 'أنت لست مذنبًا، المسؤولية على من استغلك.',
        advice: 'ثبّت أن الطفل ضحية لحماية الاستجابة النفسية.',
      },
      {
        situation: 'إيقاف التفاعل',
        opener: 'سنوقف التواصل الآن ونحفظ كل الأدلة قبل أي حذف.',
        advice: 'لا تفاوض ولا ردود انفعالية.',
      },
      {
        situation: 'الحماية الرسمية',
        opener: 'سنستخدم القنوات الرسمية لحمايتك ومحاسبة الطرف المؤذي.',
        advice: 'التوثيق الدقيق يسرّع الاستجابة الرسمية.',
      },
    ],
    alertTemplates: [
      'تنبيه حرج: مؤشرات استدراج/استغلال جنسي مرصودة.',
      'تنبيه متابعة: تم عزل التواصل وبدء مسار الإبلاغ.',
    ],
    incidentPlan: [
      'قطع التواصل مع الحساب المؤذي فورًا.',
      'حفظ معرفات الحسابات والرسائل والتوقيت.',
      'تأمين الحسابات المرتبطة وتغيير كلمات المرور.',
      'تفعيل حماية مشددة للدردشة والخصوصية.',
      'إبلاغ المنصة والجهات المختصة حسب الإجراءات.',
    ],
  },
  {
    id: 'account_theft_fraud',
    title: 'سرقة الحسابات والاحتيال',
    icon: '🔐',
    severity: AlertSeverity.HIGH,
    severityColor: 'bg-blue-700',
    symptoms: [
      'طلبات متكررة لرمز التحقق أو إعادة تعيين كلمة المرور.',
      'رسائل تنبيه دخول من أجهزة غير معروفة.',
      'تغييرات غير مبررة في إعدادات الحساب.',
    ],
    lurePatterns: [
      'صفحات تسجيل دخول مزيفة.',
      'روابط دعم فني مزعومة تسحب بيانات الاعتماد.',
      'انتحال صفة صديق/منصة لطلب الأكواد.',
    ],
    prevention: [
      'تفعيل 2FA على كل الحسابات المهمة.',
      'استخدام كلمات مرور فريدة ومدير كلمات مرور.',
      'مراجعة جلسات الدخول والأجهزة الموثوقة أسبوعيًا.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'استعادة التحكم', action: 'تدوير كلمات المرور وإغلاق كل الجلسات.' },
      { week: 'الأسبوع 2', goal: 'تقوية التعافي', action: 'تحديث وسائل الاسترداد وتأكيد البريد/الهاتف.' },
      { week: 'الأسبوع 3', goal: 'منع إعادة الاختراق', action: 'حظر الروابط المشبوهة وتدقيق التطبيقات.' },
      { week: 'الأسبوع 4', goal: 'تثبيت الممارسات', action: 'فحص أمني دوري مختصر للحسابات.' },
    ],
    dialogues: [
      {
        situation: 'التهدئة',
        opener: 'يمكننا استعادة الحساب بخطوات منظمة، لا داعي للذعر.',
        advice: 'حوّل الموقف إلى خطة عملية واضحة.',
      },
      {
        situation: 'الإجراء الفوري',
        opener: 'سنغير كلمات المرور ونغلق كل الأجهزة غير الموثوقة الآن.',
        advice: 'الأولوية لإيقاف الجلسات النشطة المخترقة.',
      },
      {
        situation: 'التوعية',
        opener: 'أي طلب لرمز التحقق يعتبر خطرًا حتى يثبت العكس.',
        advice: 'ثبّت قاعدة عدم مشاركة OTP مطلقًا.',
      },
    ],
    alertTemplates: [
      'تنبيه مرتفع: اشتباه محاولة سرقة حساب.',
      'تنبيه متابعة: تم تدوير كلمات المرور وإغلاق الجلسات.',
    ],
    incidentPlan: [
      'إغلاق كل الجلسات وتسجيل الخروج من كل الأجهزة.',
      'تغيير كلمات المرور وتحديث وسائل الاسترداد.',
      'فحص البريد والرسائل لروابط احتيال إضافية.',
      'مراجعة صلاحيات التطبيقات الخارجية.',
      'توثيق الحادث ورفع بلاغ للمنصة.',
    ],
  },
  {
    id: 'gambling_betting',
    title: 'المقامرة والمراهنات',
    icon: '🎰',
    severity: AlertSeverity.HIGH,
    severityColor: 'bg-yellow-700',
    symptoms: [
      'اندفاع نحو رهانات أو صناديق حظ داخل الألعاب.',
      'محاولات شراء متكررة غير مبررة.',
      'توتر واضح بعد الخسارة ومحاولة تعويضها فورًا.',
    ],
    lurePatterns: [
      'منصات تراهن بوعود ربح سريع.',
      'مؤثرون يروّجون لقمار رقمي مموه.',
      'ربط التقدم في اللعبة بمشتريات احتمالية.',
    ],
    prevention: [
      'إيقاف المدفوعات داخل التطبيقات افتراضيًا.',
      'حد إنفاق شهري مع إشعار فوري.',
      'توعية مالية حول وهم الاسترداد السريع.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'تجميد المخاطر', action: 'تعطيل المشتريات والبطاقات المرتبطة.' },
      { week: 'الأسبوع 2', goal: 'تفكيك العادة', action: 'حظر تطبيقات المراهنة وتتبع محفزات الاستخدام.' },
      { week: 'الأسبوع 3', goal: 'بدائل صحية', action: 'أنشطة بديلة تولد إنجازًا غير مالي.' },
      { week: 'الأسبوع 4', goal: 'ثبات سلوكي', action: 'مراجعة التزام أسبوعية مع ولي الأمر.' },
    ],
    dialogues: [
      {
        situation: 'تصحيح التوقع',
        opener: 'الرهان ليس استثمارًا، وغالبًا ينتهي بخسارة أكبر.',
        advice: 'قدّم أمثلة عملية بدون محاضرة طويلة.',
      },
      {
        situation: 'الحدود',
        opener: 'من اليوم لا توجد أي عملية شراء أو رهان دون مراجعة.',
        advice: 'حوّل الحدود إلى إعدادات تقنية ثابتة.',
      },
      {
        situation: 'البديل',
        opener: 'نختار نشاطًا يعطيك متعة بدون خسارة مالية.',
        advice: 'البدائل السريعة تقلل الانتكاس.',
      },
    ],
    alertTemplates: [
      'تنبيه مرتفع: نشاط مراهنات/مشتريات احتمالية متكرر.',
      'تنبيه متابعة: تم تفعيل حدود الإنفاق وحظر مصادر الرهان.',
    ],
    incidentPlan: [
      'تجميد المشتريات والمدفوعات فورًا.',
      'حظر تطبيقات ومواقع الرهان.',
      'مراجعة سجل الإنفاق مع ولي الأمر.',
      'وضع خطة بدائل يومية قصيرة.',
      'متابعة أسبوعية للالتزام.',
    ],
  },
  {
    id: 'privacy_tracking',
    title: 'الخصوصية والتتبع الرقمي',
    icon: '📍',
    severity: AlertSeverity.HIGH,
    severityColor: 'bg-teal-700',
    symptoms: [
      'مشاركة مفرطة للموقع أو البيانات الشخصية.',
      'ظهور روابط تتبع أو طلبات صلاحيات غير منطقية.',
      'تسريب صور/معلومات يمكن ربطها بالهوية.',
    ],
    lurePatterns: [
      'روابط تجمع عنوان IP والموقع دون علم الطفل.',
      'تطبيقات تجسس متنكرة كأدوات مساعدة.',
      'استدراج لجمع معلومات المدرسة/السكن/الروتين.',
    ],
    prevention: [
      'تعطيل مشاركة الموقع غير الضرورية.',
      'مراجعة أذونات التطبيقات دوريًا.',
      'تدريب الطفل على إخفاء البيانات الحساسة من المنشورات.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'تقليل الانكشاف', action: 'إغلاق صلاحيات التتبع وإزالة التطبيقات المشبوهة.' },
      { week: 'الأسبوع 2', goal: 'تنظيف الأثر', action: 'حذف المنشورات الحساسة وضبط الخصوصية.' },
      { week: 'الأسبوع 3', goal: 'توعية عملية', action: 'تدريب الطفل على فحص الروابط قبل فتحها.' },
      { week: 'الأسبوع 4', goal: 'صيانة مستمرة', action: 'مراجعة أسبوعية سريعة لإعدادات الأمان.' },
    ],
    dialogues: [
      {
        situation: 'وعي الخصوصية',
        opener: 'معلومة بسيطة عنك قد تُستغل، فلنحمِ تفاصيلك من الآن.',
        advice: 'اجعل الرسالة توعوية وليست تخويفية.',
      },
      {
        situation: 'فحص الجهاز',
        opener: 'سنراجع أذونات التطبيقات ونغلق أي صلاحية غير ضرورية.',
        advice: 'الخطوة التقنية يجب أن تكون فورية.',
      },
      {
        situation: 'سلوك يومي',
        opener: 'قبل أي نشر: هل هذا يكشف موقعك أو بياناتك؟',
        advice: 'سؤال بسيط يرفع الوعي اليومي.',
      },
    ],
    alertTemplates: [
      'تنبيه مرتفع: مؤشرات تتبع/انتهاك خصوصية مرصودة.',
      'تنبيه متابعة: تم تقليل صلاحيات التتبع وتنظيف الأثر الرقمي.',
    ],
    incidentPlan: [
      'إيقاف مشاركة الموقع والبيانات الحساسة.',
      'إزالة التطبيقات المشبوهة ومراجعة الأذونات.',
      'تنظيف المحتوى المنشور الذي يكشف الهوية.',
      'حظر روابط التتبع المعروفة.',
      'متابعة إعدادات الخصوصية أسبوعيًا.',
    ],
  },
  {
    id: 'harmful_challenges',
    title: 'المجموعات الضارة والتحديات الخطرة',
    icon: '⚠️',
    severity: AlertSeverity.CRITICAL,
    severityColor: 'bg-orange-700',
    symptoms: [
      'تفاعل مع تحديات تؤذي الجسد أو النفس.',
      'اندفاع لتصوير سلوكيات خطرة لإثبات الذات.',
      'ضغط جماعي رقمي يدفع للمخاطرة العالية.',
    ],
    lurePatterns: [
      'ترندات تحريضية تتحدى حدود السلامة.',
      'مجموعات مغلقة تكافئ السلوك الخطر بالقبول الاجتماعي.',
      'محتوى يقلل من خطورة الأذى الحقيقي.',
    ],
    prevention: [
      'حظر الوسوم والقنوات المرتبطة بالتحديات الخطرة.',
      'تثقيف الطفل بقاعدة: لا تجربة أي تحدي دون موافقة الأسرة.',
      'رفع إشراف الوالدين على الفيديوهات القصيرة.',
    ],
    interventionProgram: [
      { week: 'الأسبوع 1', goal: 'احتواء فوري', action: 'عزل المنصات/المجموعات المحرضة.' },
      { week: 'الأسبوع 2', goal: 'تفكيك التأثير', action: 'جلسة تحليل ضغط الأقران وكيفية الرفض.' },
      { week: 'الأسبوع 3', goal: 'بدائل انتماء', action: 'إشراك الطفل في مجموعات آمنة إيجابية.' },
      { week: 'الأسبوع 4', goal: 'تثبيت الحماية', action: 'مراقبة دورية للترندات والتفاعل.' },
    ],
    dialogues: [
      {
        situation: 'وقف السلوك',
        opener: 'أي تحدي يعرّضك للخطر سيتوقف فورًا، سلامتك أولًا.',
        advice: 'الحزم مطلوب مع الحفاظ على لغة داعمة.',
      },
      {
        situation: 'فك الضغط',
        opener: 'الرفض ليس ضعفًا، بل قرار شجاع يحميك.',
        advice: 'أعد تعريف الشجاعة بعيدًا عن المخاطرة.',
      },
      {
        situation: 'بديل آمن',
        opener: 'نبحث عن تحديات إيجابية تبني مهاراتك بدون أذى.',
        advice: 'البدائل الواقعية تقلل العودة للمجموعات الضارة.',
      },
    ],
    alertTemplates: [
      'تنبيه حرج: رصد تفاعل مع تحديات خطرة/مجموعات ضارة.',
      'تنبيه متابعة: تم عزل المصادر وبدء تدخل تربوي عاجل.',
    ],
    incidentPlan: [
      'إيقاف فوري للتحدي أو المشاركة الجارية.',
      'حظر القنوات/الحسابات المحرضة.',
      'جلسة دعم عاجلة مع الطفل حول ضغط المجموعة.',
      'تفعيل رقابة لصيقة قصيرة المدى على المحتوى المرئي.',
      'متابعة يومية حتى زوال مؤشرات الخطر.',
    ],
  },
];

type GuidanceScenarioExtension = {
  symptoms?: string[];
  lurePatterns?: string[];
  prevention?: string[];
  interventionProgram?: InterventionStep[];
  dialogues?: GuidanceScenario['dialogues'];
  alertTemplates?: string[];
  incidentPlan?: string[];
};

const scenarioKnowledgeExtensions: Record<PsychScenarioId, GuidanceScenarioExtension> = {
  bullying: {
    symptoms: [
      'انخفاض مفاجئ في التحصيل أو رفض المشاركة الصفية بعد نشاط رقمي.',
      'شكاوى متكررة من صداع أو أرق قبل النوم بسبب انتظار رسائل مسيئة.',
      'تجنب التقاط الصور أو الظهور في فعاليات بسبب الخوف من السخرية.',
      'استخدام عبارات جلد ذاتي مثل "أنا السبب" أو "أنا فاشل".',
      'طلب تبديل المدرسة أو الفريق دون تفسير واضح ومقنع.',
    ],
    lurePatterns: [
      'ابتزاز اجتماعي عبر تهديد بنشر محادثات خاصة خارج سياقها.',
      'تحويل المزاح الجماعي إلى حملات تشويه مستمرة ومجدولة.',
      'استفزاز الطفل ليرد بعنف ثم استخدام رده ضده أمام المعلمين.',
      'انتحال شخصية زميل مقرب لجمع معلومات حساسة ثم تسريبها.',
      'استخدام استطلاعات أو "تصويتات" لإذلال الطفل علنًا.',
    ],
    prevention: [
      'اتفاق أسري واضح: أي إساءة رقمية تُبلغ خلال نفس اليوم بدون عقوبة على الإبلاغ.',
      'تجهيز ردود قصيرة جاهزة للرفض: "هذا غير مقبول" ثم الحظر دون نقاش.',
      'مراجعة أسبوعية لسجل التنبيهات مع المدرسة عند وجود تقاطع واقعي.',
    ],
    alertTemplates: [
      'تنبيه مرتفع: مؤشرات تنمر ممتد عبر أكثر من منصة مع أثر نفسي واضح.',
    ],
    incidentPlan: [
      'توثيق السياق الكامل (قبل/أثناء/بعد الإساءة) بدل لقطة مفردة فقط.',
      'تنسيق قناة اتصال واحدة بين المنزل والمدرسة لمنع تضارب الرسائل.',
    ],
    dialogues: [
      {
        situation: 'إزالة الشعور بالذنب',
        opener: 'حتى لو رددت بعصبية، المسؤولية الأساسية على من بدأ الأذى.',
        advice: 'افصل بين السلوك ورد الفعل حتى لا يحمل الطفل عبئًا كاملًا.',
      },
      {
        situation: 'استعادة التحكم',
        opener: 'سنضع خطة من 3 خطوات اليوم كي تشعر أنك مسيطر على الموقف.',
        advice: 'إعطاء الطفل دورًا عمليًا يقلل العجز ويزيد الالتزام.',
      },
    ],
  },
  threat_exposure: {
    symptoms: [
      'تجنب فتح الكاميرا أو الميكروفون رغم اعتياده السابق على ذلك.',
      'قلق شديد عند طلب رمز تحقق أو أي بيانات مالية.',
      'طلب حذف الحسابات بالكامل فجأة دون سبب تقني واضح.',
      'نوبات بكاء أو ارتباك بعد مكالمات قصيرة من أرقام غير محفوظة.',
      'رفض الحديث عن شخص/حساب بعينه مع تغير نبرة الصوت.',
    ],
    lurePatterns: [
      'جمع معلومات تدريجيًا ثم الانتقال السريع إلى لغة تهديد.',
      'ادعاء امتلاك صور/بيانات إضافية لإجبار الطفل على الامتثال.',
      'طلب تنفيذ مهام متصاعدة زمنيًا تحت ضغط العدّ التنازلي.',
      'استغلال أسرار عائلية أو مدرسية لخلق خوف من الفضيحة.',
      'تحويل الابتزاز من رقمي إلى واقعي عبر تهديد بالوصول للمحيط القريب.',
    ],
    prevention: [
      'قاعدة أساسية: أي رسالة تهديد تُحوّل مباشرة لولي الأمر دون رد.',
      'إخفاء بيانات التواصل العائلية من الحسابات العامة بالكامل.',
      'تمرين عملي شهري على سيناريو ابتزاز وهمي وخطوات الاستجابة.',
    ],
    alertTemplates: [
      'تنبيه حرج: رصد نمط تهديد مباشر مع مطالب تصعيدية زمنية.',
    ],
    incidentPlan: [
      'تثبيت هوية المبتز (معرّفات الحساب/الرقم/البصمة الزمنية) قبل أي إجراء واسع.',
      'فصل الحسابات الحرجة عن الجهاز المعرّض لحين اكتمال الاحتواء.',
    ],
    dialogues: [
      {
        situation: 'تفكيك الخوف',
        opener: 'لغة التهديد مصممة لإرباكك، لكن لدينا خطة أقوى من هذا الضغط.',
        advice: 'سمِّ الهدف النفسي للمبتز حتى يفقد تأثيره.',
      },
      {
        situation: 'قرار عدم الدفع',
        opener: 'الدفع لا ينهي الابتزاز غالبًا، لذلك سنحميك بطرق صحيحة.',
        advice: 'قدّم البديل العملي فورًا حتى لا يبدو القرار نظريًا فقط.',
      },
    ],
  },
  gaming: {
    symptoms: [
      'تأخر متكرر في النوم يتبعه إرهاق صباحي واضح.',
      'فقدان الاهتمام بأنشطة كان يستمتع بها خارج الشاشة.',
      'انفعال شديد عند أي انقطاع إنترنت أو فقدان جولة.',
      'تراجع العلاقات الأسرية بسبب الارتباط المستمر باللعبة.',
      'الكذب حول مدة الاستخدام أو الإنفاق داخل اللعبة.',
    ],
    lurePatterns: [
      'أنظمة مكافآت متقطعة تدفع للعودة المتكررة دون توقف.',
      'ضغط الفريق/العشيرة للحضور اليومي خوفًا من الطرد.',
      'عروض موسمية محدودة الوقت تخلق شعور "الفرصة الأخيرة".',
      'ربط المكانة الاجتماعية الرقمية بعدد الساعات أو المشتريات.',
      'رسائل إشعار مصممة لإعادة تنشيط الطفل بعد أي انقطاع.',
    ],
    prevention: [
      'تثبيت جدول لعب مرئي ومتفق عليه مع فترات راحة إلزامية.',
      'ربط الاستمرار في اللعب بمؤشرات توازن: نوم، دراسة، حركة بدنية.',
      'تعطيل الإشعارات الجاذبة خارج نافذة اللعب المحددة.',
    ],
    alertTemplates: [
      'تنبيه متوسط: ارتفاع نمط اللعب القهري مع أثر على النوم والانضباط.',
    ],
    incidentPlan: [
      'تفعيل "تهدئة 48 ساعة" مع بدائل ممتعة وليس منعًا عقابيًا فقط.',
      'تحليل لحظات الذروة (متى/لماذا) لإعادة تصميم الروتين اليومي.',
    ],
    dialogues: [
      {
        situation: 'اتفاق واقعي',
        opener: 'لن نلغي اللعب، سنضبطه ليخدمك بدل ما يستهلكك.',
        advice: 'الرسالة المتوازنة تقلل مقاومة الطفل للتغيير.',
      },
      {
        situation: 'إدارة الانتكاسة',
        opener: 'إذا زادت الساعات يومًا، نصحح اليوم التالي بدون جلد ذات.',
        advice: 'خطط التعافي السريعة أفضل من الصرامة غير القابلة للاستمرار.',
      },
    ],
  },
  inappropriate_content: {
    symptoms: [
      'فضول قهري للبحث عن محتوى أكثر صدمة مع الوقت.',
      'تطبيع لغوي لمشاهد عنف/إيحاءات لم تكن مألوفة سابقًا.',
      'استخدام وضع التصفح الخفي بشكل يومي مفرط.',
      'تغير صورة الجسد أو العلاقات نتيجة مقارنة غير صحية.',
      'تراجع عتبة التعاطف مع مشاهد الإيذاء أو الإذلال.',
    ],
    lurePatterns: [
      'خوارزميات تقترح محتوى أكثر حدة بعد كل مشاهدة قصيرة.',
      'عناوين صادمة تستخدم الفضول كبوابة انتقال تدريجي.',
      'روابط "للكبار فقط" تُتداول داخل مجموعات أقران مغلقة.',
      'تحديات مشاهدة متطرفة لقياس "الجرأة" بين الأصدقاء.',
      'دمج المحتوى الإباحي/العنيف داخل مقاطع تبدو ترفيهية بالبداية.',
    ],
    prevention: [
      'تطبيق SafeSearch وDNS عائلي مع مراجعة شهرية لفعاليته.',
      'حوار تثقيفي عن الحدود الرقمية بدل الاقتصار على المنع.',
      'ربط أي خرق لقواعد المحتوى بخطة تعلم تعويضية قصيرة.',
    ],
    alertTemplates: [
      'تنبيه مرتفع: تكرار تعرض لمحتوى غير مناسب مع تغيّر سلوكي مرافق.',
    ],
    incidentPlan: [
      'تحديد مصدر الانكشاف (بحث/اقتراح/رابط صديق) قبل وضع العلاج.',
      'إعادة تهيئة التوصيات عبر مسح السجل والتفاعل الإيجابي البديل.',
    ],
    dialogues: [
      {
        situation: 'حوار بلا وصم',
        opener: 'سأشرح لك لماذا هذا المحتوى يؤذيك دون تخويف أو إهانة.',
        advice: 'التركيز على الأثر يحافظ على الثقة أكثر من التخجيل.',
      },
      {
        situation: 'تصحيح المفاهيم',
        opener: 'ليس كل ما يُعرض طبيعيًا أو صحيًا، خلّنا نفكك الرسائل معًا.',
        advice: 'بناء التفكير النقدي يقلل العودة العفوية للمحتوى المؤذي.',
      },
    ],
  },
  cyber_crime: {
    symptoms: [
      'اهتمام مفاجئ بأدوات اختراق أو سكربتات غير مفهومة للعمر.',
      'محاولات متكررة لتجاوز صلاحيات التطبيقات أو المدرسة.',
      'تباهي بـ"اختبار الأنظمة" دون فهم العواقب القانونية.',
      'الانخراط في مجتمعات تتبادل أدوات هجوم أو تسريب بيانات.',
      'تجارب على حسابات الأصدقاء بدعوى المزاح التقني.',
    ],
    lurePatterns: [
      'مجتمعات تعرض "أدوات مجانية" مقابل تجربة على أهداف حقيقية.',
      'وعود بالهيبة الرقمية مقابل تنفيذ مهام هجوم بسيطة.',
      'تحديات اختراق مدرسية/ألعاب تمنح شهرة زائفة سريعة.',
      'بيع بيانات أو حسابات مسروقة داخل قنوات شبه مغلقة.',
      'تحويل الفضول التقني لمسار عدائي عبر قدوة منحرفة.',
    ],
    prevention: [
      'تحويل الفضول لمسار قانوني: CTF آمن، برمجة دفاعية، أمن أخلاقي.',
      'توضيح العواقب القانونية الواقعية بلغة عمرية واضحة.',
      'متابعة مجتمعات الطفل التقنية وتقييم نبرة المحتوى دوريًا.',
    ],
    alertTemplates: [
      'تنبيه مرتفع: مؤشرات انتقال من فضول تقني إلى سلوك اختراقي تنفيذي.',
    ],
    incidentPlan: [
      'عزل الأدوات المشبوهة وتجميد بيئة التنفيذ فورًا.',
      'إعداد مسار بديل رسمي لتعلم الأمن السيبراني الأخلاقي.',
    ],
    dialogues: [
      {
        situation: 'تحويل المسار',
        opener: 'مهارتك التقنية قيمة، ونريدها في مسار يحمي الناس لا يؤذيهم.',
        advice: 'اعترف بالقدرة ثم أعد توجيهها بدل شيطنة الطفل.',
      },
      {
        situation: 'وعي قانوني',
        opener: 'بعض الأفعال الرقمية تُسجَّل قانونيًا حتى لو كانت "تجربة".',
        advice: 'اربط القانون بأمثلة عملية حتى يكون ملموسًا.',
      },
    ],
  },
  phishing_links: {
    symptoms: [
      'الضغط على روابط مجهولة قبل التحقق من المصدر.',
      'إدخال بيانات حساب في صفحات تشبه الأصل مع فروق طفيفة.',
      'مشاركة رمز تحقق لمرة واحدة بعد رسالة إقناع مستعجلة.',
      'فقدان وصول مؤقت للحسابات بعد نقر رابط قصير.',
      'تزايد رسائل "استعادة الحساب" دون سبب معروف.',
    ],
    lurePatterns: [
      'رسائل عاجلة تدّعي تعليق الحساب وتتطلب إجراء فوريًا.',
      'جوائز وهمية مرتبطة بتسجيل دخول عبر صفحة مزيفة.',
      'انتحال صفة صديق مع رابط "مهم جدًا" خارج السياق المعتاد.',
      'اختصارات روابط تخفي الوجهة الحقيقية للصفحة.',
      'نوافذ دفع أو تحديث أمان مزيفة تحصد بيانات البطاقة.',
    ],
    prevention: [
      'قاعدة الرابط الآمن: افحص النطاق قبل أي إدخال بيانات.',
      'منع إدخال OTP خارج التطبيق الرسمي مهما كانت الرسالة مقنعة.',
      'استخدام مدير كلمات مرور لا يملأ النماذج على نطاق مزيف.',
    ],
    alertTemplates: [
      'تنبيه حرج: احتمال تصيد نشط بعد مشاركة بيانات أو رمز تحقق.',
    ],
    incidentPlan: [
      'تغيير كلمات المرور من جهاز موثوق غير مصاب.',
      'إغلاق جميع الجلسات النشطة ومراجعة الأجهزة المتصلة بالحساب.',
    ],
    dialogues: [
      {
        situation: 'إيقاف الاندفاع',
        opener: 'أي رسالة مستعجلة هي إشارة توقف، وليست إشارة تنفيذ.',
        advice: 'زرع عادة "توقف 30 ثانية" قبل النقر يقلل الحوادث كثيرًا.',
      },
      {
        situation: 'تعلم من الحادث',
        opener: 'الخطأ قابل للإصلاح، والمهم أن نتعلم نمط الخداع القادم.',
        advice: 'حول الحادث إلى تمرين معرفي وليس لحظة تأنيب.',
      },
    ],
  },
  crypto_scams: {
    symptoms: [
      'حديث متكرر عن أرباح سريعة مضمونة دون مخاطر.',
      'الانضمام لقنوات توصيات استثمارية مجهولة الهوية.',
      'تحويلات صغيرة تجريبية تتزايد تدريجيًا دون إشراف.',
      'ضغط نفسي عند فوات "فرصة عملة" مزعومة.',
      'تكرار كلمات تسويقية مثل "مؤكد/مضمون/سري".',
    ],
    lurePatterns: [
      'مجموعات تضخ عملة ثم تدعو للبيع على المتابعين المتأخرين.',
      'منصات وهمية تعرض أرباحًا مصطنعة داخل لوحة مزيفة.',
      'وعود استرداد خسائر سريعة مقابل تحويل إضافي.',
      'انتحال خبير تداول مع لقطات أرباح مفبركة.',
      'استخدام مؤثرين صغار لإضفاء شرعية وهمية على المشروع.',
    ],
    prevention: [
      'منع أي تحويل مالي دون مراجعة ولي الأمر المسبقة.',
      'تطبيق قاعدة: إذا بدا الربح غير منطقي فهو غالبًا احتيال.',
      'حصر التعلم المالي في منصات تعليمية موثوقة فقط.',
    ],
    alertTemplates: [
      'تنبيه مرتفع: مؤشرات احتيال مالي رقمي مع قابلية خسارة مباشرة.',
    ],
    incidentPlan: [
      'تجميد أي تحويلات إضافية فورًا حتى اكتمال التحقق.',
      'توثيق المحافظ/العناوين/المعرفات قبل محاولة الاسترداد.',
    ],
    dialogues: [
      {
        situation: 'تفكيك الوهم',
        opener: 'المحتال يبيع السرعة، بينما الاستثمار الحقيقي يبيع الانضباط.',
        advice: 'ضع مقارنة مباشرة بين الوعد الاحتيالي والمسار الصحيح.',
      },
      {
        situation: 'حماية مستقبلية',
        opener: 'سنبني لك قائمة تحقق قبل أي قرار مالي على الإنترنت.',
        advice: 'وجود Checklist يخفف قرارات الاندفاع اللحظي.',
      },
    ],
  },
  self_harm: {
    symptoms: [
      'منشورات تحمل يأسًا أو انعدام قيمة الذات بشكل متكرر.',
      'انعزال حاد مع تراجع العناية بالنفس.',
      'التخلص من أشياء محببة أو رسائل وداعية مبطنة.',
      'اضطراب أكل/نوم حاد مرتبط بحالة نفسية متدهورة.',
      'بحث عن طرق إيذاء أو مجموعات تشجع السلوك المؤذي.',
    ],
    lurePatterns: [
      'مجتمعات تمجّد الألم النفسي وتطبع إيذاء الذات.',
      'محتوى بصري محفّز يقدم الإيذاء كحل للتخفيف.',
      'أقران يدفعون للتحديات المؤذية تحت شعار "إثبات القوة".',
      'رسائل تعزل الطفل عن مصادر الدعم الحقيقي.',
      'سرديات رومانسية تربط المعاناة بالقيمة الشخصية.',
    ],
    prevention: [
      'خطة أمان شخصية مكتوبة مع جهات اتصال فورية واضحة.',
      'مراقبة إشارات التدهور اليومي (نوم/مزاج/شهية/انسحاب).',
      'إحالة مختص نفسي مبكر عند أي إشارة حرجة متكررة.',
    ],
    alertTemplates: [
      'تنبيه حرج جدًا: مؤشرات إيذاء ذاتي تتطلب تدخلًا نفسيًا فوريًا.',
    ],
    incidentPlan: [
      'إزالة الوسائل المحتملة للإيذاء من البيئة القريبة مباشرة.',
      'عدم ترك الطفل وحيدًا عند وجود مؤشرات خطر حادة.',
    ],
    dialogues: [
      {
        situation: 'أمان فوري',
        opener: 'سلامتك أهم من أي شيء الآن، وسأبقى معك خطوة بخطوة.',
        advice: 'الرسالة الأولى يجب أن تكون أمانًا لا تحقيقًا.',
      },
      {
        situation: 'طلب المساعدة',
        opener: 'طلب المساعدة الطبية والنفسية هو قرار قوة وليس ضعفًا.',
        advice: 'أزل الوصمة عن التدخل المختص مبكرًا.',
      },
    ],
  },
  sexual_exploitation: {
    symptoms: [
      'سرية مفرطة حول جهة تواصل رقمية محددة.',
      'تلقي هدايا/رصيد/امتيازات رقمية بلا تفسير واضح.',
      'قلق شديد عند الحديث عن الصور أو الكاميرا.',
      'تبدل مفاجئ في اللغة الجنسية غير الملائمة للعمر.',
      'رفض مشاركة أي تفاصيل عن علاقات رقمية "خاصة جدًا".',
    ],
    lurePatterns: [
      'بناء ارتباط عاطفي سريع ثم طلب سرية مطلقة.',
      'اختبار الحدود تدريجيًا عبر طلب صور "عادية" أولًا.',
      'استخدام الذنب العاطفي لإجبار الطفل على الاستمرار.',
      'تهديد بكشف المحادثات لإبقاء السيطرة.',
      'نقل التواصل لمنصات أقل رقابة وأكثر اختفاءً.',
    ],
    prevention: [
      'تعليم قاعدة: لا صور خاصة تحت أي ظرف أو علاقة.',
      'رفع إعدادات السلامة للتواصل ومنع الغرباء افتراضيًا.',
      'تدريب الطفل على كلمات استغاثة أسرية متفق عليها.',
    ],
    alertTemplates: [
      'تنبيه حرج: نمط استدراج جنسي محتمل مع تصاعد في طلبات الخصوصية.',
    ],
    incidentPlan: [
      'إيقاف التواصل فورًا مع حفظ كل الأدلة قبل الحظر.',
      'البدء بإجراءات بلاغ رسمية عبر القنوات المعتمدة.',
    ],
    dialogues: [
      {
        situation: 'إزالة العار',
        opener: 'أي استغلال حصل ليس خطأك، والمسؤولية كاملة على المعتدي.',
        advice: 'منع لوم الضحية أساس نجاح الاستجابة.',
      },
      {
        situation: 'تثبيت الحدود',
        opener: 'جسمك وخصوصيتك خط أحمر، ولا أحد يملك حق تجاوزهما.',
        advice: 'عزّز الحدود بطريقة حازمة وداعمة في آن واحد.',
      },
    ],
  },
  account_theft_fraud: {
    symptoms: [
      'تسجيل خروج متكرر من الحسابات دون تدخل من الطفل.',
      'استقبال رموز استعادة غير مطلوبة على البريد/الهاتف.',
      'تغيرات مفاجئة في إعدادات الحساب أو البريد البديل.',
      'رسائل لأصدقاء الطفل لم يرسلها هو فعليًا.',
      'إنفاق/مشتريات مجهولة من حسابات مرتبطة.',
    ],
    lurePatterns: [
      'صفحات تسجيل دخول مقلدة تطلب بيانات الحساب.',
      'روابط تحديث أمان مزيفة مع شعار منصة موثوقة.',
      'خداع عبر دعم فني مزيف يطلب رمز التحقق.',
      'استغلال كلمات مرور مكررة عبر تسريبات قديمة.',
      'سرقة جلسة عبر ملفات تعريف ارتباط أو أجهزة عامة.',
    ],
    prevention: [
      'استخدام كلمات مرور فريدة لكل منصة مع مدير كلمات مرور.',
      'تفعيل 2FA وربط الحساب ببريد استرداد آمن ومستقل.',
      'مراجعة نشاط تسجيل الدخول أسبوعيًا واكتشاف الأجهزة الغريبة.',
    ],
    alertTemplates: [
      'تنبيه مرتفع: مؤشرات استيلاء على حساب أو محاولة اختراق متقدمة.',
    ],
    incidentPlan: [
      'تدوير جميع كلمات المرور المرتبطة بالحساب المخترق.',
      'إلغاء صلاحيات التطبيقات الخارجية غير الموثوقة فورًا.',
    ],
    dialogues: [
      {
        situation: 'احتواء سريع',
        opener: 'سنستعيد الحساب بخطوات واضحة، والوقت هنا مهم جدًا.',
        advice: 'إعطاء تسلسل واضح يقلل الذعر ويرفع التركيز.',
      },
      {
        situation: 'تعلم أمني',
        opener: 'بعد الاسترداد، سنبني حماية تمنع تكرار نفس الثغرة.',
        advice: 'حوّل الحادث إلى ترقية فعلية في عادات الأمان.',
      },
    ],
  },
  gambling_betting: {
    symptoms: [
      'انشغال مستمر بنتائج مباريات/رهانات بدل الأنشطة اليومية.',
      'طلب أموال متكرر مع مبررات غير متسقة.',
      'تقلب مزاج حاد مرتبط بالمكسب والخسارة اللحظية.',
      'إخفاء سجل المدفوعات أو استخدام بطاقات مسبقة الدفع.',
      'مطاردة الخسارة عبر مضاعفة الرهان بعد كل هبوط.',
    ],
    lurePatterns: [
      'عروض ترحيبية مجانية تقود تدريجيًا لمخاطر مالية عالية.',
      'إشعارات "استرجاع الخسارة الآن" لتشجيع الاندفاع.',
      'ربط الرهان بهوية اجتماعية داخل مجموعات الأصدقاء.',
      'تحويل المقامرة إلى تحديات يومية قصيرة سهلة الدخول.',
      'استخدام عملات داخل اللعبة لإخفاء الطابع القماري.',
    ],
    prevention: [
      'حظر منصات المراهنة وعمليات الدفع المرتبطة بها تقنيًا.',
      'وضع سقف إنفاق رقمي صفري للحسابات الحساسة.',
      'برنامج بدائل فوري (رياضة/نشاط جماعي/مكافآت غير مالية).',
    ],
    alertTemplates: [
      'تنبيه مرتفع: سلوك مراهنة متكرر مع مخاطر خسارة مالية متصاعدة.',
    ],
    incidentPlan: [
      'إيقاف وسائل الدفع وربط الإشعارات المالية بولي الأمر.',
      'مراجعة يومية للإنفاق لمدة أسبوعين بعد الحادث.',
    ],
    dialogues: [
      {
        situation: 'فك دائرة الخسارة',
        opener: 'محاولة تعويض الخسارة بسرعة تزيدها غالبًا، فلنوقف الحلقة الآن.',
        advice: 'اشرح مفهوم "مطاردة الخسارة" بلغة بسيطة قابلة للفهم.',
      },
      {
        situation: 'بديل المكافأة',
        opener: 'سنبدل إثارة الرهان بإثارة إنجاز حقيقية تحقق لك تقديرًا ثابتًا.',
        advice: 'البديل الإيجابي يمنع الفراغ الذي يعيد السلوك القديم.',
      },
    ],
  },
  privacy_tracking: {
    symptoms: [
      'معرفة أطراف خارجية بتفاصيل مكان/وقت لم يُشاركها الطفل.',
      'تطبيقات غريبة ذات صلاحيات موقع وميكروفون مفرطة.',
      'رسائل تهديد مبنية على معلومات شخصية دقيقة.',
      'استهلاك بطارية/بيانات غير طبيعي بشكل مستمر.',
      'ظهور روابط تتبع في المحادثات على أنها "اختبار بسيط".',
    ],
    lurePatterns: [
      'إرسال روابط قصيرة تدّعي معرفة من زار الحساب.',
      'تطبيقات "خدمات مجانية" تطلب صلاحيات تجسسية كاملة.',
      'جمع صور/بيانات خلفية لاستخدامها في الدوكسينغ.',
      'استخدام مسابقات وهمية لاستخراج العنوان والمدرسة.',
      'ابتزاز ببيانات الموقع لإجبار الطفل على الاستجابة.',
    ],
    prevention: [
      'مراجعة شهرية لصلاحيات التطبيقات وإزالة أي صلاحية غير لازمة.',
      'تعطيل مشاركة الموقع الدائمة والاكتفاء بـ"أثناء الاستخدام".',
      'منع نشر صور تكشف العنوان أو المدرسة أو الروتين اليومي.',
    ],
    alertTemplates: [
      'تنبيه مرتفع: احتمال تتبع/تجسس رقمي مع تسريب بيانات حساسة.',
    ],
    incidentPlan: [
      'فحص الجهاز أمنيًا وحذف التطبيقات المشبوهة فورًا.',
      'تغيير كلمات المرور وإعادة تعيين إعدادات الخصوصية الأساسية.',
    ],
    dialogues: [
      {
        situation: 'رفع الوعي',
        opener: 'المعلومة الصغيرة قد تكشف حياتك اليومية بالكامل إذا تراكمت.',
        advice: 'اشرح مبدأ "تجميع البيانات" بدل التخويف المباشر.',
      },
      {
        situation: 'انضباط المشاركة',
        opener: 'قبل أي نشر، نسأل: هل هذا يكشف مكاننا أو روتيننا؟',
        advice: 'سؤال واحد ثابت قبل النشر يقلل التسريبات تلقائيًا.',
      },
    ],
  },
  harmful_challenges: {
    symptoms: [
      'محاولات تصوير سلوك خطير بهدف النشر والحصول على تفاعل.',
      'تكرار عبارات تحدي مثل "إذا لم تفعل فأنت ضعيف".',
      'إصابات طفيفة متكررة مع تفسيرات غير مقنعة.',
      'اندفاع قوي نحو إثبات الذات أمام مجموعة رقمية معينة.',
      'تجاهل عواقب السلامة مقابل "الترند" والانتشار.',
    ],
    lurePatterns: [
      'تحديات تصاعدية تبدأ بسيطة ثم تقفز إلى إيذاء حقيقي.',
      'ربط القبول الاجتماعي بتنفيذ سلوك خطر أمام الكاميرا.',
      'الضغط عبر العد التنازلي أو تهديد بالإقصاء من المجموعة.',
      'استخدام مكافآت رقمية/متابعين كحافز للمجازفة.',
      'تضليل المخاطر عبر قصص نجاح مزيفة دون ذكر الإصابات.',
    ],
    prevention: [
      'سياسة أسرية واضحة: أي تحدي جسدي/مؤذٍ مرفوض فورًا.',
      'تعزيز بدائل تحديات إيجابية (رياضة/مهارة/مشروع إبداعي).',
      'مراجعة دورية للترندات الشائعة مع شرح مخاطرها الواقعية.',
    ],
    alertTemplates: [
      'تنبيه حرج: ارتباط بنمط تحديات خطرة قد يقود لإيذاء مباشر.',
    ],
    incidentPlan: [
      'تعليق الحسابات/المجموعات المحرضة مؤقتًا حتى استقرار السلوك.',
      'تقييم طبي فوري عند أي علامة إصابة أو إرهاق شديد.',
    ],
    dialogues: [
      {
        situation: 'تفكيك ضغط الأقران',
        opener: 'القوة الحقيقية هي رفض ما يؤذيك حتى لو صفق له الآخرون.',
        advice: 'حوّل تعريف الشجاعة من المخاطرة إلى حماية النفس.',
      },
      {
        situation: 'بناء انتماء آمن',
        opener: 'سنبحث عن مجموعة إيجابية تقدّرك بدون شروط خطرة.',
        advice: 'الانتماء البديل يقلل الرجوع للمجموعة الضارة.',
      },
    ],
  },
};

const normalizeListEntry = (value: string) => value.replace(/\s+/g, ' ').trim();

const mergeUniqueStrings = (base: string[], extension: string[] = []) => {
  const seen = new Set<string>();
  const merged: string[] = [];
  [...base, ...extension].forEach((value) => {
    const normalized = normalizeListEntry(value);
    if (!normalized || seen.has(normalized)) return;
    seen.add(normalized);
    merged.push(normalized);
  });
  return merged;
};

const mergeInterventionSteps = (base: InterventionStep[], extension: InterventionStep[] = []) => {
  const seen = new Set<string>();
  const merged: InterventionStep[] = [];
  [...base, ...extension].forEach((step) => {
    const key = `${normalizeListEntry(step.week)}|${normalizeListEntry(step.goal)}|${normalizeListEntry(step.action)}`;
    if (seen.has(key)) return;
    seen.add(key);
    merged.push({
      week: normalizeListEntry(step.week),
      goal: normalizeListEntry(step.goal),
      action: normalizeListEntry(step.action),
    });
  });
  return merged;
};

const mergeDialogues = (
  base: GuidanceScenario['dialogues'],
  extension: GuidanceScenario['dialogues'] = []
) => {
  const seen = new Set<string>();
  const merged: GuidanceScenario['dialogues'] = [];
  [...base, ...extension].forEach((dialogue) => {
    const key = [
      normalizeListEntry(dialogue.situation),
      normalizeListEntry(dialogue.opener),
      normalizeListEntry(dialogue.advice),
    ].join('|');
    if (seen.has(key)) return;
    seen.add(key);
    merged.push({
      situation: normalizeListEntry(dialogue.situation),
      opener: normalizeListEntry(dialogue.opener),
      advice: normalizeListEntry(dialogue.advice),
    });
  });
  return merged;
};

const guidanceScenarios: GuidanceScenario[] = guidanceScenariosBase.map((scenario) => {
  const extension = scenarioKnowledgeExtensions[scenario.id];
  if (!extension) return scenario;
  return {
    ...scenario,
    symptoms: mergeUniqueStrings(scenario.symptoms, extension.symptoms),
    lurePatterns: mergeUniqueStrings(scenario.lurePatterns, extension.lurePatterns),
    prevention: mergeUniqueStrings(scenario.prevention, extension.prevention),
    alertTemplates: mergeUniqueStrings(scenario.alertTemplates, extension.alertTemplates),
    incidentPlan: mergeUniqueStrings(scenario.incidentPlan, extension.incidentPlan),
    interventionProgram: mergeInterventionSteps(scenario.interventionProgram, extension.interventionProgram),
    dialogues: mergeDialogues(scenario.dialogues, extension.dialogues),
  };
});

const SCENARIO_CONTENT_MINIMUMS = {
  symptoms: 7,
  lurePatterns: 7,
  prevention: 6,
  incidentPlan: 6,
  alertTemplates: 3,
  dialogues: 4,
} as const;

if (import.meta.env.DEV) {
  const lowCoverage = guidanceScenarios
    .map((scenario) => {
      const gaps: string[] = [];
      if (scenario.symptoms.length < SCENARIO_CONTENT_MINIMUMS.symptoms) gaps.push('symptoms');
      if (scenario.lurePatterns.length < SCENARIO_CONTENT_MINIMUMS.lurePatterns) gaps.push('lurePatterns');
      if (scenario.prevention.length < SCENARIO_CONTENT_MINIMUMS.prevention) gaps.push('prevention');
      if (scenario.incidentPlan.length < SCENARIO_CONTENT_MINIMUMS.incidentPlan) gaps.push('incidentPlan');
      if (scenario.alertTemplates.length < SCENARIO_CONTENT_MINIMUMS.alertTemplates) gaps.push('alertTemplates');
      if (scenario.dialogues.length < SCENARIO_CONTENT_MINIMUMS.dialogues) gaps.push('dialogues');
      return gaps.length ? { id: scenario.id, gaps } : null;
    })
    .filter(Boolean) as Array<{ id: PsychScenarioId; gaps: string[] }>;

  if (lowCoverage.length) {
    console.warn('[PsychologicalInsightView] Scenario encyclopedia coverage gaps detected:', lowCoverage);
  }
}

const severityClassMap: Record<AlertSeverity, string> = {
  [AlertSeverity.CRITICAL]: 'bg-red-100 text-red-700 border-red-200',
  [AlertSeverity.HIGH]: 'bg-orange-100 text-orange-700 border-orange-200',
  [AlertSeverity.MEDIUM]: 'bg-amber-100 text-amber-700 border-amber-200',
  [AlertSeverity.LOW]: 'bg-emerald-100 text-emerald-700 border-emerald-200',
};

const severityTextMap: Record<AlertSeverity, string> = {
  [AlertSeverity.CRITICAL]: 'حرج',
  [AlertSeverity.HIGH]: 'مرتفع',
  [AlertSeverity.MEDIUM]: 'متوسط',
  [AlertSeverity.LOW]: 'منخفض',
};

const scenarioGlassStyles: Record<PsychScenarioId, { tint: string; ring: string; button: string }> = {
  bullying: {
    tint: 'from-fuchsia-500/25 via-rose-400/20 to-pink-500/25',
    ring: 'shadow-fuchsia-500/20',
    button: 'from-fuchsia-500 to-rose-600',
  },
  threat_exposure: {
    tint: 'from-red-500/25 via-rose-500/20 to-orange-500/25',
    ring: 'shadow-red-500/25',
    button: 'from-red-500 to-rose-700',
  },
  gaming: {
    tint: 'from-indigo-500/25 via-blue-500/20 to-violet-500/25',
    ring: 'shadow-indigo-500/20',
    button: 'from-indigo-500 to-violet-600',
  },
  inappropriate_content: {
    tint: 'from-violet-500/25 via-fuchsia-500/20 to-indigo-500/25',
    ring: 'shadow-violet-500/20',
    button: 'from-violet-500 to-fuchsia-600',
  },
  cyber_crime: {
    tint: 'from-slate-500/25 via-cyan-500/20 to-slate-700/25',
    ring: 'shadow-slate-500/25',
    button: 'from-slate-600 to-cyan-700',
  },
  phishing_links: {
    tint: 'from-cyan-500/25 via-sky-500/20 to-blue-500/25',
    ring: 'shadow-cyan-500/20',
    button: 'from-cyan-500 to-blue-600',
  },
  crypto_scams: {
    tint: 'from-amber-500/25 via-orange-500/20 to-yellow-500/25',
    ring: 'shadow-amber-500/20',
    button: 'from-amber-500 to-orange-600',
  },
  self_harm: {
    tint: 'from-rose-600/25 via-red-500/20 to-pink-500/25',
    ring: 'shadow-rose-500/25',
    button: 'from-rose-600 to-red-700',
  },
  sexual_exploitation: {
    tint: 'from-fuchsia-600/25 via-pink-500/20 to-purple-500/25',
    ring: 'shadow-fuchsia-500/25',
    button: 'from-fuchsia-600 to-pink-700',
  },
  account_theft_fraud: {
    tint: 'from-blue-500/25 via-sky-500/20 to-indigo-500/25',
    ring: 'shadow-blue-500/20',
    button: 'from-blue-500 to-indigo-600',
  },
  gambling_betting: {
    tint: 'from-yellow-500/25 via-amber-500/20 to-orange-500/25',
    ring: 'shadow-yellow-500/20',
    button: 'from-yellow-500 to-amber-600',
  },
  privacy_tracking: {
    tint: 'from-teal-500/25 via-cyan-500/20 to-emerald-500/25',
    ring: 'shadow-teal-500/20',
    button: 'from-teal-500 to-emerald-600',
  },
  harmful_challenges: {
    tint: 'from-orange-500/25 via-rose-500/20 to-red-500/25',
    ring: 'shadow-orange-500/25',
    button: 'from-orange-500 to-red-600',
  },
};

const inferScenarioId = (child?: Child): GuidanceScenario['id'] => {
  const profile = child?.psychProfile;
  if (profile?.priorityScenario) {
    return profile.priorityScenario;
  }

  const hay = (profile?.recentKeywords || []).join(' ');
  if (
    hay.includes('إيذاء النفس') ||
    hay.includes('انتحار') ||
    hay.toLowerCase().includes('self harm') ||
    hay.toLowerCase().includes('suicide')
  ) {
    return 'self_harm';
  }
  if (
    hay.includes('استدراج') ||
    hay.includes('استغلال جنسي') ||
    hay.toLowerCase().includes('grooming') ||
    hay.toLowerCase().includes('predator')
  ) {
    return 'sexual_exploitation';
  }
  if (
    hay.includes('سرقة حساب') ||
    hay.includes('اختراق الحساب') ||
    hay.toLowerCase().includes('account stolen') ||
    hay.toLowerCase().includes('credential')
  ) {
    return 'account_theft_fraud';
  }
  if (
    hay.includes('مراهنة') ||
    hay.includes('قمار') ||
    hay.toLowerCase().includes('gambling') ||
    hay.toLowerCase().includes('bet')
  ) {
    return 'gambling_betting';
  }
  if (
    hay.includes('خصوصية') ||
    hay.includes('تتبع') ||
    hay.toLowerCase().includes('tracking') ||
    hay.toLowerCase().includes('dox')
  ) {
    return 'privacy_tracking';
  }
  if (
    hay.includes('تحدي خطير') ||
    hay.includes('مجموعة ضارة') ||
    hay.toLowerCase().includes('dangerous challenge')
  ) {
    return 'harmful_challenges';
  }
  if (hay.includes('تهديد') || hay.includes('ابتزاز')) return 'threat_exposure';
  if (hay.includes('تنمر')) return 'bullying';
  if (hay.toLowerCase().includes('phishing') || hay.includes('تصيد') || hay.includes('رابط')) return 'phishing_links';
  if (hay.includes('سهر') || hay.includes('إدمان') || hay.includes('لعب')) return 'gaming';
  if (hay.includes('اختراق') || hay.includes('سكربت')) return 'cyber_crime';
  if (hay.includes('استثمار') || hay.includes('تحويل')) return 'crypto_scams';
  if (hay.includes('إباحية') || hay.includes('محتوى')) return 'inappropriate_content';
  return 'bullying';
};

const scenarioToCategory = (
  scenarioId: PsychScenarioId,
  threatSubtype: ThreatExposureSubtype = 'direct_threat',
  contentSubtype: InappropriateContentSubtype = 'sexual_content',
  severity: AlertSeverity = AlertSeverity.MEDIUM
): Category => {
  switch (scenarioId) {
    case 'bullying':
      return Category.BULLYING;
    case 'threat_exposure':
      if (threatSubtype === 'financial_blackmail') return Category.SCAM;
      if (threatSubtype === 'sexual_blackmail') return Category.SEXUAL_EXPLOITATION;
      return Category.BLACKMAIL;
    case 'gaming':
      return Category.SAFE;
    case 'inappropriate_content':
      return contentSubtype === 'violent_content' ? Category.VIOLENCE : Category.ADULT_CONTENT;
    case 'cyber_crime':
      if (severity === AlertSeverity.CRITICAL) return Category.TAMPER;
      if (severityRank[severity] >= severityRank[AlertSeverity.HIGH]) return Category.PREDATOR;
      return Category.SAFE;
    case 'crypto_scams':
      return Category.SCAM;
    case 'phishing_links':
      return Category.PHISHING_LINK;
    case 'self_harm':
      return Category.SELF_HARM;
    case 'sexual_exploitation':
      return threatSubtype === 'sexual_blackmail' ? Category.BLACKMAIL : Category.SEXUAL_EXPLOITATION;
    case 'account_theft_fraud':
      return Category.SCAM;
    case 'gambling_betting':
      return Category.SCAM;
    case 'privacy_tracking':
      return Category.PREDATOR;
    case 'harmful_challenges':
      return severityRank[severity] >= severityRank[AlertSeverity.HIGH] ? Category.VIOLENCE : Category.SELF_HARM;
    default:
      return Category.BULLYING;
  }
};

interface ThreatTrackProfile {
  id: ThreatExposureSubtype;
  badgeLabelAr: string;
  badgeLabelEn: string;
  narrativeAr: string;
  narrativeEn: string;
  incidentPlanAr: string[];
  incidentPlanEn: string[];
  alertTemplatesAr: string[];
  alertTemplatesEn: string[];
  preferWalkie: boolean;
  preferBlackout: boolean;
  preferCutInternet: boolean;
  preferSiren: boolean;
}

const threatTrackProfiles: Record<ThreatExposureSubtype, ThreatTrackProfile> = {
  direct_threat: {
    id: 'direct_threat',
    badgeLabelAr: 'تهديد مباشر',
    badgeLabelEn: 'Direct Threat',
    narrativeAr:
      'الخطر الحالي أقرب إلى تهديد مباشر؛ الأولوية لعزل التواصل المؤذي، تثبيت القناة الصوتية الآمنة، وتوثيق الأدلة فوراً.',
    narrativeEn:
      'The current pattern matches direct threat exposure. Prioritize immediate containment, safe voice channel, and evidence capture.',
    incidentPlanAr: [
      'لا تفاوض ولا رد انفعالي مع الحساب المهدد.',
      'تفعيل القفل الوقائي الفوري مع شاشة حماية.',
      'تشغيل قناة تواصل مباشر (Walkie) مع الطفل.',
      'التقاط أدلة الشاشة ثم رفع بلاغ المنصة.',
      'تصعيد فوري لولي الأمر المناوب عند استمرار التهديد.',
    ],
    incidentPlanEn: [
      'Do not negotiate or react emotionally to the threatening account.',
      'Enable immediate protective lock and blackout screen.',
      'Open a direct walkie channel with the child.',
      'Capture screen evidence, then report on platform.',
      'Escalate to on-duty guardian if threat persists.',
    ],
    alertTemplatesAr: [
      'تنبيه حرج: نمط تهديد مباشر مرصود. تم تفعيل الاحتواء الوقائي.',
      'تنبيه متابعة: تم توثيق الأدلة وينتظر الإبلاغ الرسمي للمنصة.',
    ],
    alertTemplatesEn: [
      'Critical alert: direct threat pattern detected. Protective containment enabled.',
      'Follow-up alert: evidence captured, pending official platform report.',
    ],
    preferWalkie: true,
    preferBlackout: true,
    preferCutInternet: false,
    preferSiren: true,
  },
  financial_blackmail: {
    id: 'financial_blackmail',
    badgeLabelAr: 'ابتزاز مالي',
    badgeLabelEn: 'Financial Blackmail',
    narrativeAr:
      'الخطر الحالي يتضمن ضغطاً مالياً؛ الأولوية لقطع مسارات الدفع، عزل الشبكة مؤقتاً، وتأمين الحسابات المرتبطة بالتحويل.',
    narrativeEn:
      'The current pattern indicates financial blackmail. Prioritize payment freeze, temporary network quarantine, and account hardening.',
    incidentPlanAr: [
      'إيقاف أي تحويل أو دفع فوري تحت الضغط.',
      'تفعيل عزل الشبكة مؤقتاً حتى انتهاء المراجعة.',
      'تأمين الحسابات المالية وتغيير كلمات المرور.',
      'توثيق الرسائل المالية وروابط الدفع المشبوهة.',
      'إبلاغ المنصة وخدمة الدفع عن محاولة الابتزاز.',
    ],
    incidentPlanEn: [
      'Stop all pressured transfers or payments immediately.',
      'Enable temporary network quarantine during investigation.',
      'Harden financial accounts and rotate passwords.',
      'Preserve payment requests and suspicious links as evidence.',
      'Report blackmail attempt to platform and payment provider.',
    ],
    alertTemplatesAr: [
      'تنبيه حرج: نمط ابتزاز مالي مرصود. تم تجميد مسارات الدفع مؤقتاً.',
      'تنبيه متابعة: تحقق من الحسابات المالية وتوثيق روابط التحويل جارٍ.',
    ],
    alertTemplatesEn: [
      'Critical alert: financial blackmail pattern detected. Payment channels temporarily frozen.',
      'Follow-up alert: financial account verification and transfer-link evidence in progress.',
    ],
    preferWalkie: false,
    preferBlackout: false,
    preferCutInternet: true,
    preferSiren: false,
  },
  sexual_blackmail: {
    id: 'sexual_blackmail',
    badgeLabelAr: 'ابتزاز جنسي',
    badgeLabelEn: 'Sexual Blackmail',
    narrativeAr:
      'الخطر الحالي يشير إلى ابتزاز جنسي؛ الأولوية للتأمين الفوري، منع التفاوض، حفظ الأدلة، وبدء مسار إبلاغ رسمي سريع.',
    narrativeEn:
      'The current pattern indicates sexual blackmail. Prioritize immediate protection, no negotiation, evidence preservation, and fast formal reporting.',
    incidentPlanAr: [
      'لا تفاوض ولا إرسال أي محتوى إضافي مطلقاً.',
      'تفعيل القفل الوقائي وشاشة الحماية فوراً.',
      'التقاط الأدلة (المعرفات/الرسائل/الوقت) قبل أي حذف.',
      'فتح قناة Walkie لدعم الطفل وطمأنته فورياً.',
      'بدء مسار إبلاغ رسمي للمنصة والجهات المختصة.',
    ],
    incidentPlanEn: [
      'Do not negotiate and never send any additional content.',
      'Enable immediate protective lock and safety blackout screen.',
      'Capture identifiers/messages/timestamps before any deletion.',
      'Open walkie channel for immediate reassurance and support.',
      'Trigger fast formal reporting to platform and authorities.',
    ],
    alertTemplatesAr: [
      'تنبيه حرج جداً: اشتباه ابتزاز جنسي. تم تفعيل الحماية الفورية.',
      'تنبيه متابعة: حفظ الأدلة وبدء مسار الإبلاغ الرسمي.',
    ],
    alertTemplatesEn: [
      'Extreme alert: suspected sexual blackmail. Immediate protection has been activated.',
      'Follow-up alert: evidence preserved and formal reporting flow started.',
    ],
    preferWalkie: true,
    preferBlackout: true,
    preferCutInternet: false,
    preferSiren: false,
  },
};

const inferThreatSubtypeFromKeywords = (keywords: string[]): ThreatExposureSubtype => {
  const hay = (keywords || []).join(' ').toLowerCase();
  if (
    hay.includes('ابتزاز جنسي') ||
    hay.includes('استغلال جنسي') ||
    hay.includes('sextortion') ||
    hay.includes('private photos') ||
    hay.includes('nude')
  ) {
    return 'sexual_blackmail';
  }
  if (
    hay.includes('ابتزاز مالي') ||
    hay.includes('تحويل') ||
    hay.includes('دفع') ||
    hay.includes('gift card') ||
    hay.includes('wallet')
  ) {
    return 'financial_blackmail';
  }
  return 'direct_threat';
};

interface ContentTrackProfile {
  id: InappropriateContentSubtype;
  badgeLabelAr: string;
  badgeLabelEn: string;
  narrativeAr: string;
  narrativeEn: string;
  incidentPlanAr: string[];
  incidentPlanEn: string[];
  alertTemplatesAr: string[];
  alertTemplatesEn: string[];
  preferBlackout: boolean;
  preferSiren: boolean;
}

const contentTrackProfiles: Record<InappropriateContentSubtype, ContentTrackProfile> = {
  sexual_content: {
    id: 'sexual_content',
    badgeLabelAr: 'محتوى جنسي',
    badgeLabelEn: 'Sexual Content',
    narrativeAr:
      'المؤشر الحالي يرتبط بتعرض لمحتوى جنسي غير مناسب؛ الأولوية لتشديد الفلترة، التهدئة، وحوار احتوائي بلا لوم.',
    narrativeEn:
      'Current pattern indicates exposure to sexual explicit content. Prioritize tighter filtering, calm handling, and non-blaming guidance.',
    incidentPlanAr: [
      'إيقاف المصدر المسبب فوراً (رابط/حساب/تطبيق).',
      'رفع مستوى الفلترة وSafeSearch بحسب العمر.',
      'جلسة حوار قصيرة بلا لوم مع الطفل.',
      'تفعيل قائمة مواقع بديلة آمنة.',
      'متابعة أسبوعية لقياس التكرار.',
    ],
    incidentPlanEn: [
      'Block the source immediately (link/account/app).',
      'Increase filtering and SafeSearch strictness.',
      'Run a short non-blaming discussion with the child.',
      'Provide trusted safe alternatives.',
      'Track recurrence weekly.',
    ],
    alertTemplatesAr: [
      'تنبيه مرتفع: تعرض محتمل لمحتوى جنسي غير مناسب. تم تشديد الفلترة.',
      'تنبيه متابعة: تم تنفيذ خطة احتواء تربوي ومراجعة مصدر الوصول.',
    ],
    alertTemplatesEn: [
      'High alert: potential sexual explicit-content exposure. Filtering has been tightened.',
      'Follow-up alert: educational containment plan and source review completed.',
    ],
    preferBlackout: false,
    preferSiren: false,
  },
  violent_content: {
    id: 'violent_content',
    badgeLabelAr: 'محتوى عنيف',
    badgeLabelEn: 'Violent Content',
    narrativeAr:
      'المؤشر الحالي يرتبط بتعرض متكرر لمحتوى عنيف/تحريضي؛ الأولوية للاحتواء الفوري، التهدئة، وتقليل محفزات العنف.',
    narrativeEn:
      'Current pattern indicates repeated exposure to violent/harmful content. Prioritize immediate containment and de-escalation.',
    incidentPlanAr: [
      'إيقاف المصدر العنيف وحظر الحساب/القناة المرتبطة.',
      'تفعيل شاشة حماية مؤقتة مع رسالة تهدئة.',
      'مراجعة سجل المشاهدة وتحديد نقاط الاستدراج.',
      'جلسة توعية حول الفرق بين المحتوى الترفيهي والتحريض.',
      'متابعة يومية قصيرة حتى استقرار النمط.',
    ],
    incidentPlanEn: [
      'Block the violent source and related account/channel.',
      'Enable temporary safety blackout with calming message.',
      'Review watch history and lure vectors.',
      'Run a brief guidance talk about harmful content.',
      'Track daily until pattern stabilizes.',
    ],
    alertTemplatesAr: [
      'تنبيه حرج: تعرض متكرر لمحتوى عنيف/تحريضي. تم بدء الاحتواء الوقائي.',
      'تنبيه متابعة: جارٍ تقليل محفزات العنف ومراجعة القنوات المرتبطة.',
    ],
    alertTemplatesEn: [
      'Critical alert: repeated violent-content exposure detected. Protective containment started.',
      'Follow-up alert: violence triggers are being reduced and channels reviewed.',
    ],
    preferBlackout: true,
    preferSiren: true,
  },
};

const inferContentSubtypeFromKeywords = (keywords: string[]): InappropriateContentSubtype => {
  const hay = (keywords || []).join(' ').toLowerCase();
  if (
    hay.includes('violent') ||
    hay.includes('gore') ||
    hay.includes('عنيف') ||
    hay.includes('تحريض') ||
    hay.includes('دموي')
  ) {
    return 'violent_content';
  }
  return 'sexual_content';
};

const PsychologicalInsightView: React.FC<PsychologicalInsightViewProps> = ({
  theme,
  child,
  alerts = [],
  lang = 'ar',
  onAcceptPlan,
  onApplyModeToChild,
  onPlanExecutionResult,
  onSaveExecutionEvidence,
}) => {
  const profile = child?.psychProfile;
  const navigate = useNavigate();
  const primaryCardRef = useRef<HTMLDivElement | null>(null);
  const radarContainerRef = useRef<HTMLDivElement | null>(null);
  const trendContainerRef = useRef<HTMLDivElement | null>(null);
  const [radarSize, setRadarSize] = useState({ width: 0, height: 0 });
  const [trendSize, setTrendSize] = useState({ width: 0, height: 0 });
  const diagnosis = useMemo(
    () => diagnosePsychScenarioFromAlerts(child?.name || '', alerts),
    [child?.name, alerts]
  );

  const [activeScenarioId, setActiveScenarioId] = useState<GuidanceScenario['id']>(
    diagnosis?.scenarioId || inferScenarioId(child)
  );
  const [expandedScenarioId, setExpandedScenarioId] = useState<GuidanceScenario['id'] | null>(
    diagnosis?.scenarioId || inferScenarioId(child)
  );
  const [expandedSectionMap, setExpandedSectionMap] = useState<Record<string, boolean>>({});
  const [copiedPlan, setCopiedPlan] = useState(false);
  const [autoSelection, setAutoSelection] = useState<Record<string, boolean>>({});
  const [autoStatus, setAutoStatus] = useState<Record<string, AutoStepStatus>>({});
  const [isAutoRunning, setIsAutoRunning] = useState(false);
  const [autoRunSummary, setAutoRunSummary] = useState('');
  const [executionTimeline, setExecutionTimeline] = useState<PlanTimelineEntry[]>([]);
  const [timelineFilter, setTimelineFilter] = useState<'all' | PlanTimelineStatus>('all');
  const [isSavingExecutionEvidence, setIsSavingExecutionEvidence] = useState(false);
  const [planVideoSource, setPlanVideoSource] = useState<PlanVideoSource>('screen');
  const [planAudioSource, setPlanAudioSource] = useState<PlanAudioSource>('mic');
  const [playbooks, setPlaybooks] = useState<SafetyPlaybook[]>([]);
  const [blackoutMessage, setBlackoutMessage] = useState(
    lang === 'ar'
      ? 'تم قفل الجهاز لدواعي الأمان. يرجى التواصل مع الوالدين.'
      : 'Device locked for safety. Please contact a parent.'
  );

  const activeScenario = useMemo(
    () => guidanceScenarios.find((s) => s.id === activeScenarioId) || guidanceScenarios[0],
    [activeScenarioId]
  );
  const recentKeywordsSignature = (child?.psychProfile?.recentKeywords || []).join('||');

  const threatSubtype = useMemo<ThreatExposureSubtype>(() => {
    if (activeScenario.id !== 'threat_exposure') return 'direct_threat';
    return diagnosis?.threatSubtype || inferThreatSubtypeFromKeywords(child?.psychProfile?.recentKeywords || []);
  }, [activeScenario.id, recentKeywordsSignature, diagnosis?.threatSubtype]);

  const contentSubtype = useMemo<InappropriateContentSubtype>(() => {
    if (activeScenario.id !== 'inappropriate_content') return 'sexual_content';
    return diagnosis?.contentSubtype || inferContentSubtypeFromKeywords(child?.psychProfile?.recentKeywords || []);
  }, [activeScenario.id, recentKeywordsSignature, diagnosis?.contentSubtype]);

  const activeThreatTrack = useMemo(
    () => threatTrackProfiles[threatSubtype],
    [threatSubtype]
  );

  const activeContentTrack = useMemo(
    () => contentTrackProfiles[contentSubtype],
    [contentSubtype]
  );

  const resolvedIncidentPlan = useMemo(() => {
    if (activeScenario.id === 'threat_exposure') {
      return lang === 'ar' ? activeThreatTrack.incidentPlanAr : activeThreatTrack.incidentPlanEn;
    }
    if (activeScenario.id === 'inappropriate_content') {
      return lang === 'ar' ? activeContentTrack.incidentPlanAr : activeContentTrack.incidentPlanEn;
    }
    return activeScenario.incidentPlan;
  }, [activeScenario.id, activeScenario.incidentPlan, activeThreatTrack, activeContentTrack, lang]);

  const resolvedAlertTemplates = useMemo(() => {
    if (activeScenario.id === 'threat_exposure') {
      return lang === 'ar' ? activeThreatTrack.alertTemplatesAr : activeThreatTrack.alertTemplatesEn;
    }
    if (activeScenario.id === 'inappropriate_content') {
      return lang === 'ar' ? activeContentTrack.alertTemplatesAr : activeContentTrack.alertTemplatesEn;
    }
    return activeScenario.alertTemplates;
  }, [activeScenario.id, activeScenario.alertTemplates, activeThreatTrack, activeContentTrack, lang]);

  const fallbackBlackoutMessage = useMemo(
    () =>
      lang === 'ar'
        ? 'تم قفل الجهاز لدواعي الأمان. يرجى التواصل مع الوالدين.'
        : 'Device locked for safety. Please contact a parent.',
    [lang]
  );

  useEffect(() => {
    setActiveScenarioId(diagnosis?.scenarioId || inferScenarioId(child));
    setExpandedScenarioId(diagnosis?.scenarioId || inferScenarioId(child));
  }, [
    child?.id,
    child?.psychProfile?.priorityScenario,
    recentKeywordsSignature,
    diagnosis?.scenarioId,
  ]);

  useEffect(() => {
    let mounted = true;
    const loadPlaybooks = async () => {
      if (!child?.parentId) {
        if (mounted) setPlaybooks([]);
        return;
      }
      try {
        const stored = await fetchPlaybooks(child.parentId);
        if (!mounted) return;
        setPlaybooks(stored);
      } catch (error) {
        if (!mounted) return;
        console.warn('Failed to load psychological playbooks:', error);
        setPlaybooks([]);
      }
    };
    void loadPlaybooks();
    return () => {
      mounted = false;
    };
  }, [child?.parentId]);

  useEffect(() => {
    if (!blackoutMessage.trim()) {
      setBlackoutMessage(fallbackBlackoutMessage);
    }
  }, [blackoutMessage, fallbackBlackoutMessage]);

  useEffect(() => {
    const el = primaryCardRef.current;
    if (!el) return;
    requestAnimationFrame(() => {
      el.scrollIntoView({ behavior: 'auto', block: 'start' });
      el.focus({ preventScroll: true });
    });
  }, [child?.id]);

  useEffect(() => {
    const node = radarContainerRef.current;
    if (!node) return;

    let raf = 0;
    const checkReady = () => {
      cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => {
        const rect = node.getBoundingClientRect();
        setRadarSize({
          width: Math.max(0, Math.floor(rect.width)),
          height: Math.max(0, Math.floor(rect.height)),
        });
      });
    };

    checkReady();
    const observer = new ResizeObserver(checkReady);
    observer.observe(node);
    return () => {
      cancelAnimationFrame(raf);
      observer.disconnect();
    };
  }, [child?.id]);

  useEffect(() => {
    const node = trendContainerRef.current;
    if (!node) return;

    let raf = 0;
    const checkReady = () => {
      cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => {
        const rect = node.getBoundingClientRect();
        setTrendSize({
          width: Math.max(0, Math.floor(rect.width)),
          height: Math.max(0, Math.floor(rect.height)),
        });
      });
    };

    checkReady();
    const observer = new ResizeObserver(checkReady);
    observer.observe(node);
    return () => {
      cancelAnimationFrame(raf);
      observer.disconnect();
    };
  }, [child?.id]);

  if (!child || !profile) {
    return <div className="p-20 text-center font-black">جاري تحليل النبض النفسي...</div>;
  }

  const stabilityScore = Math.round((profile.moodScore + (100 - profile.anxietyLevel)) / 2);
  const readinessScore = profile.incidentReadinessScore ?? Math.max(35, 95 - profile.anxietyLevel);
  const frustrationScore = Math.max(0, Math.min(100, Math.round(100 - profile.moodScore)));
  const aggressionScore = Math.max(
    0,
    Math.min(
      100,
      Math.round(
        profile.anxietyLevel * 0.4 +
          profile.isolationRisk * 0.35 +
          frustrationScore * 0.25
      )
    )
  );
  const quickAdvisorTip =
    (diagnosis?.scenarioId === activeScenario.id ? diagnosis?.topSignals?.[0]?.suggestedAction : undefined) ||
    activeScenario.dialogues[0]?.advice ||
    resolvedIncidentPlan[0] ||
    profile.recommendation;

  const radarData = [
    { subject: 'قلق', A: profile.anxietyLevel, fullMark: 100 },
    { subject: 'إحباط', A: frustrationScore, fullMark: 100 },
    { subject: 'عزلة', A: profile.isolationRisk, fullMark: 100 },
    { subject: 'عدوانية', A: aggressionScore, fullMark: 100 },
    { subject: 'هدوء', A: profile.moodScore, fullMark: 100 },
  ];

  const weeklyTrend =
    profile.weeklyTrend && profile.weeklyTrend.length > 0
      ? profile.weeklyTrend
      : [
          { label: 'الاثنين', value: 58 },
          { label: 'الثلاثاء', value: 62 },
          { label: 'الأربعاء', value: 55 },
          { label: 'الخميس', value: 64 },
          { label: 'الجمعة', value: 60 },
        ];

  const riskSignals = useMemo(() => {
    const diagnosticSignals = diagnosis?.topSignals || [];
    const profileSignals = profile.riskSignals || [];
    const merged = [...diagnosticSignals, ...profileSignals];
    if (merged.length > 0) {
      const unique = new Map<string, (typeof merged)[number]>();
      for (const signal of merged) {
        const key = `${signal.title}-${signal.severity}`;
        if (!unique.has(key)) {
          unique.set(key, signal);
        }
      }
      return Array.from(unique.values()).slice(0, 4);
    }
    return [
      {
        id: `fallback-${activeScenario.id}`,
        title: activeScenario.title,
        severity: activeScenario.severity,
        reason: activeScenario.symptoms[0],
        suggestedAction: resolvedIncidentPlan[0] || activeScenario.incidentPlan[0],
      },
    ];
  }, [diagnosis?.topSignals, profile.riskSignals, activeScenario, resolvedIncidentPlan]);

  const childAlerts = useMemo(() => {
    const norm = (value?: string) => (value || '').toLowerCase().replace(/\s+/g, ' ').trim();
    const childNameNorm = norm(child.name);
    return alerts
      .filter((alert) => {
        const alertNameNorm = norm(alert.childName);
        return (
          !!alertNameNorm &&
          !!childNameNorm &&
          (alertNameNorm === childNameNorm ||
            alertNameNorm.includes(childNameNorm) ||
            childNameNorm.includes(alertNameNorm))
        );
      })
      .sort((a, b) => new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime());
  }, [alerts, child.name]);

  const dominantPlatform = useMemo(() => {
    const count = new Map<string, number>();
    for (const alert of childAlerts) {
      const key = (alert.platform || 'Unknown').trim();
      count.set(key, (count.get(key) || 0) + 1);
    }
    const sorted = Array.from(count.entries()).sort((a, b) => b[1] - a[1]);
    return sorted[0]?.[0] || childAlerts[0]?.platform || 'Discord';
  }, [childAlerts]);

  const dominantSeverity: AlertSeverity =
    diagnosis?.topSignals?.[0]?.severity || childAlerts[0]?.severity || activeScenario.severity;

  const cyberRiskStage = useMemo(() => {
    if (activeScenario.id !== 'cyber_crime') return null;
    if (dominantSeverity === AlertSeverity.CRITICAL) {
      return { badgeAr: 'مرحلة احتواء', badgeEn: 'Containment Stage' };
    }
    if (severityRank[dominantSeverity] >= severityRank[AlertSeverity.HIGH]) {
      return { badgeAr: 'مرحلة إنذار', badgeEn: 'Warning Stage' };
    }
    return { badgeAr: 'مرحلة رصد', badgeEn: 'Observation Stage' };
  }, [activeScenario.id, dominantSeverity]);

  const highRiskApp = useMemo(() => {
    const apps = child.appUsage || [];
    if (apps.length === 0) return null;
    const platformNorm = dominantPlatform.toLowerCase();
    const direct = apps.find((app) => app.appName.toLowerCase().includes(platformNorm));
    if (direct) return direct;
    const fallback = apps.find((app) =>
      ['discord', 'telegram', 'roblox', 'tiktok', 'snapchat', 'youtube'].some((name) =>
        app.appName.toLowerCase().includes(name)
      )
    );
    return fallback || apps[0];
  }, [child.appUsage, dominantPlatform]);

  const blockedDomains = useMemo(
    () => scenarioBlockedDomains[activeScenario.id] || [],
    [activeScenario.id]
  );

  const playbookDrivenSteps = useMemo<AutoExecutionStep[]>(() => {
    const category = scenarioToCategory(activeScenario.id, threatSubtype, contentSubtype, dominantSeverity);
    const actions = getDefenseActionsWithPlaybooks(category, dominantSeverity, playbooks);

    const priorityToSeverity = (priority: string): AlertSeverity => {
      if (priority === 'critical') return AlertSeverity.CRITICAL;
      if (priority === 'high') return AlertSeverity.HIGH;
      if (priority === 'medium') return AlertSeverity.MEDIUM;
      return AlertSeverity.LOW;
    };

    return actions
      .map((action) => ({
        id: `pb-${action.id}`,
        title: lang === 'ar' ? `إجراء بروتوكول: ${action.label}` : `Playbook Action: ${action.label}`,
        description:
          lang === 'ar'
            ? 'خطوة مسترجعة من بروتوكولات الحماية المخصصة للعائلة.'
            : 'A family-configured action restored from safety playbooks.',
        command: action.command as AutoExecutionStep['command'],
        value: action.payload ?? true,
        minSeverity: priorityToSeverity(action.priority),
        enabledByDefault: true,
      }));
  }, [activeScenario.id, contentSubtype, dominantSeverity, lang, playbooks, threatSubtype]);

  useEffect(() => {
    if (activeScenario.id === 'gaming') {
      setPlanVideoSource('screen');
      setPlanAudioSource('system');
      return;
    }
    if (activeScenario.id === 'bullying') {
      setPlanVideoSource('camera_front');
      setPlanAudioSource('mic');
      return;
    }
    if (activeScenario.id === 'threat_exposure') {
      if (threatSubtype === 'financial_blackmail') {
        setPlanVideoSource('screen');
        setPlanAudioSource('system');
        return;
      }
      setPlanVideoSource('camera_front');
      setPlanAudioSource('mic');
      return;
    }
    if (activeScenario.id === 'inappropriate_content') {
      if (contentSubtype === 'violent_content') {
        setPlanVideoSource('camera_front');
        setPlanAudioSource('mic');
        return;
      }
      setPlanVideoSource('screen');
      setPlanAudioSource('system');
      return;
    }
    if (activeScenario.id === 'phishing_links') {
      setPlanVideoSource('screen');
      setPlanAudioSource('system');
      return;
    }
    if (
      activeScenario.id === 'account_theft_fraud' ||
      activeScenario.id === 'crypto_scams' ||
      activeScenario.id === 'gambling_betting' ||
      activeScenario.id === 'privacy_tracking'
    ) {
      setPlanVideoSource('screen');
      setPlanAudioSource('system');
      return;
    }
    if (
      activeScenario.id === 'self_harm' ||
      activeScenario.id === 'sexual_exploitation' ||
      activeScenario.id === 'harmful_challenges'
    ) {
      setPlanVideoSource('camera_front');
      setPlanAudioSource('mic');
      return;
    }
    setPlanVideoSource('screen');
    setPlanAudioSource('mic');
  }, [activeScenario.id, child?.id, contentSubtype, threatSubtype]);

  const digitalBalanceNarrative = useMemo(() => {
    const appLabel = highRiskApp?.appName || dominantPlatform;
    if (activeScenario.id === 'threat_exposure') {
      const base = lang === 'ar' ? activeThreatTrack.narrativeAr : activeThreatTrack.narrativeEn;
      return `${base} (${appLabel}).`;
    }
    if (activeScenario.id === 'inappropriate_content') {
      const base = lang === 'ar' ? activeContentTrack.narrativeAr : activeContentTrack.narrativeEn;
      return `${base} (${appLabel}).`;
    }
    if (activeScenario.id === 'bullying') {
      return `نوصي بتشديد الخصوصية داخل ${appLabel}، تقييد المراسلة من الغرباء، وتفعيل بروتوكول "وثّق/احظر/بلّغ" تلقائياً.`;
    }
    if (activeScenario.id === 'gaming') {
      return `نوصي بضبط ${appLabel} عبر وضع متوازن: جلسات لعب مجدولة + إيقاف الإشعارات المشتتة + منع الانضمام لغرف عامة مرتفعة المخاطر.`;
    }
    if (activeScenario.id === 'self_harm') {
      return `نوصي بخطة أمان فورية على ${appLabel}: احتواء مباشر، تقليل العزلة الرقمية، ومراقبة لصيقة للمحفزات عالية الخطورة.`;
    }
    if (activeScenario.id === 'sexual_exploitation') {
      return `نوصي بعزل قنوات التواصل الحساسة على ${appLabel}، حماية الحساب فوراً، وربط خطة الإبلاغ الرسمي بالأدلة.`;
    }
    if (activeScenario.id === 'account_theft_fraud') {
      return `نوصي بتدوير كلمات المرور للحسابات المرتبطة بـ ${appLabel}، إغلاق الجلسات النشطة، وتفعيل حماية استرداد مشددة.`;
    }
    if (activeScenario.id === 'gambling_betting') {
      return `نوصي بإيقاف المشتريات المرتبطة بـ ${appLabel}، تفعيل حدود إنفاق، واستبدال نمط الرهان بأنشطة بديلة.`;
    }
    if (activeScenario.id === 'privacy_tracking') {
      return `نوصي بتقليل أثر ${appLabel} على الخصوصية: ضبط الأذونات، إيقاف التتبع، وتنظيف البيانات المكشوفة.`;
    }
    if (activeScenario.id === 'harmful_challenges') {
      return `نوصي بعزل مجموعات الترندات الخطرة على ${appLabel}، مع خطة تدخل تربوي عاجل ومتابعة يومية قصيرة.`;
    }
    return `نوصي بخطة توازن رقمي مخصصة لـ ${appLabel}: تقليل سطح التعرض، رفع الرقابة اللحظية، وتفعيل استجابة تلقائية عند ارتفاع المخاطر.`;
  }, [activeScenario.id, activeContentTrack, activeThreatTrack, dominantPlatform, highRiskApp?.appName, lang]);

  const autoExecutionSteps = useMemo<AutoExecutionStep[]>(
    () => {
      const baseSteps: AutoExecutionStep[] = [
      {
        id: 'snapshot',
        title: 'توثيق فوري',
        description: 'أخذ لقطة شاشة فورية لإثبات الحالة الحالية.',
        command: 'takeScreenshot',
        value: true,
        minSeverity: AlertSeverity.LOW,
        enabledByDefault: true,
      },
      {
        id: 'block-app',
        title: 'حظر التطبيق الأعلى خطورة',
        description: highRiskApp
          ? `تفعيل حظر ${highRiskApp.appName} مؤقتًا لحين مراجعة المشرف.`
          : 'لا يوجد تطبيق مرصود ليتم حظره تلقائيًا.',
        command: 'blockApp',
        value: highRiskApp
          ? { appId: highRiskApp.id, isBlocked: true, reason: 'digital_balance_auto' }
          : null,
        minSeverity: AlertSeverity.MEDIUM,
        enabledByDefault: !!highRiskApp,
      },
      {
        id: 'video-source',
        title: 'ضبط مصدر الصورة',
        description: 'تحديد مصدر البث: شاشة الجهاز.',
        command: 'setVideoSource',
        value: planVideoSource,
        minSeverity: AlertSeverity.HIGH,
        enabledByDefault: true,
      },
      {
        id: 'audio-source',
        title: 'ضبط مصدر الصوت',
        description: 'تحديد مصدر الصوت: ميكروفون الجهاز.',
        command: 'setAudioSource',
        value: planAudioSource,
        minSeverity: AlertSeverity.HIGH,
        enabledByDefault: true,
      },
      {
        id: 'start-stream',
        title: 'بدء بث رقابي مباشر',
        description: 'تشغيل بث مباشر للمراجعة السريعة من ولي الأمر.',
        command: 'startLiveStream',
        value: {
          videoSource: planVideoSource,
          audioSource: planAudioSource,
          source: 'digital_balance_auto',
        },
        minSeverity: AlertSeverity.HIGH,
        enabledByDefault: true,
      },
      {
        id: 'lock-device',
        title: 'قفل وقائي مؤقت',
        description: 'قفل مؤقت للجهاز حتى اكتمال التقييم.',
        command: 'lockDevice',
        value: true,
        minSeverity: AlertSeverity.CRITICAL,
        enabledByDefault: true,
      },
      {
        id: 'blackout-screen',
        title: 'شاشة سوداء برسالة حماية',
        description: 'تفعيل حجب الجهاز مع رسالة إرشادية للطفل حتى مراجعة الوالدين.',
        command: 'lockscreenBlackout',
        value: { enabled: true, source: 'digital_balance_auto' },
        minSeverity: AlertSeverity.HIGH,
        enabledByDefault:
          activeScenario.id === 'bullying' ||
          activeScenario.id === 'self_harm' ||
          activeScenario.id === 'sexual_exploitation' ||
          activeScenario.id === 'harmful_challenges' ||
          (activeScenario.id === 'threat_exposure' && activeThreatTrack.preferBlackout) ||
          (activeScenario.id === 'inappropriate_content' && activeContentTrack.preferBlackout),
      },
      {
        id: 'walkie-enable',
        title: 'تفعيل قناة Walkie-Talkie',
        description: 'تفعيل قناة التواصل الصوتي الفوري بين الوالد والطفل.',
        command: 'walkieTalkieEnable',
        value: { enabled: true, source: 'mic' },
        minSeverity: AlertSeverity.HIGH,
        enabledByDefault:
          activeScenario.id === 'self_harm' ||
          activeScenario.id === 'sexual_exploitation' ||
          activeScenario.id === 'harmful_challenges' ||
          (activeScenario.id === 'threat_exposure' && activeThreatTrack.preferWalkie),
      },
      {
        id: 'net-quarantine',
        title: 'عزل الشبكة مؤقتاً',
        description: 'قطع اتصال الإنترنت مؤقتاً لمنع التحويلات أو استكمال المسارات الخطرة.',
        command: 'cutInternet',
        value: true,
        minSeverity: AlertSeverity.HIGH,
        enabledByDefault:
          (activeScenario.id === 'threat_exposure' && activeThreatTrack.preferCutInternet) ||
          activeScenario.id === 'phishing_links' ||
          activeScenario.id === 'account_theft_fraud',
      },
      {
        id: 'siren',
        title: 'صافرة ردع',
        description: 'تشغيل صافرة في الحالات الحرجة جدًا.',
        command: 'playSiren',
        value: true,
        minSeverity: AlertSeverity.CRITICAL,
        enabledByDefault:
          activeScenario.id === 'harmful_challenges' ||
          (activeScenario.id === 'threat_exposure' && activeThreatTrack.preferSiren) ||
          (activeScenario.id === 'inappropriate_content' && activeContentTrack.preferSiren),
      },
      ];

      const merged = [...baseSteps];
      for (const step of playbookDrivenSteps) {
        if (!merged.some((existing) => existing.command === step.command)) {
          merged.push(step);
        }
      }
      return merged;
    },
    [
      activeContentTrack,
      activeScenario.id,
      activeThreatTrack,
      highRiskApp,
      planAudioSource,
      planVideoSource,
      playbookDrivenSteps,
    ]
  );

  useEffect(() => {
    const initSelection: Record<string, boolean> = {};
    const initStatus: Record<string, AutoStepStatus> = {};
    for (const step of autoExecutionSteps) {
      initSelection[step.id] = step.enabledByDefault;
      initStatus[step.id] = 'idle';
    }
    setAutoSelection(initSelection);
    setAutoStatus(initStatus);
    setAutoRunSummary('');
    setExecutionTimeline([]);
    setTimelineFilter('all');
  }, [child?.id, activeScenario.id, dominantSeverity, highRiskApp?.id, autoExecutionSteps]);

  const pushTimeline = (entry: Omit<PlanTimelineEntry, 'id' | 'at'>) => {
    setExecutionTimeline((prev) =>
      [
        {
          id: `timeline-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
          at: new Date(),
          ...entry,
        },
        ...prev,
      ].slice(0, 40)
    );
  };

  const buildSuggestedPlan = (): Partial<CustomMode> => {
    const frequentApps = [...(child.appUsage || [])]
      .sort((a, b) => b.minutesUsed - a.minutesUsed)
      .slice(0, 3)
      .map((app) => app.appName);

    return {
      name: `Digital Balance Mode - ${child.name}`,
      icon: 'DB',
      color: 'bg-indigo-900',
      allowedApps: frequentApps.length > 0 ? frequentApps : ['School App', 'WhatsApp'],
      allowedUrls: [],
      blacklistedUrls: blockedDomains,
      isInternetCut:
        dominantSeverity === AlertSeverity.CRITICAL ||
        (activeScenario.id === 'threat_exposure' && activeThreatTrack.preferCutInternet) ||
        activeScenario.id === 'phishing_links' ||
        activeScenario.id === 'account_theft_fraud',
      isDeviceLocked: false,
      isScreenDimmed: true,
      cameraEnabled: dominantSeverity !== AlertSeverity.CRITICAL,
      micEnabled: true,
      internetStartTime: '06:00',
      internetEndTime: '22:00',
      activeDays: [0, 1, 2, 3, 4, 5, 6],
      preferredVideoSource: planVideoSource,
      preferredAudioSource: planAudioSource,
      autoStartLiveStream: severityRank[dominantSeverity] >= severityRank[AlertSeverity.HIGH],
      autoTakeScreenshot: true,
      blackoutOnApply:
        severityRank[dominantSeverity] >= severityRank[AlertSeverity.HIGH] &&
        (activeScenario.id === 'threat_exposure'
          ? activeThreatTrack.preferBlackout
          : activeScenario.id === 'inappropriate_content'
            ? activeContentTrack.preferBlackout
            : true),
      blackoutMessage: blackoutMessage.trim() || fallbackBlackoutMessage,
      enableWalkieTalkieOnApply:
        activeScenario.id === 'bullying' ||
        activeScenario.id === 'self_harm' ||
        activeScenario.id === 'sexual_exploitation' ||
        activeScenario.id === 'harmful_challenges' ||
        (activeScenario.id === 'threat_exposure' && activeThreatTrack.preferWalkie),
    };
  };

  const handleApplyEmergencyPlan = () => {
    const suggested = buildSuggestedPlan();
    onAcceptPlan(suggested);
    navigate('/modes', { state: { suggestedMode: suggested } });
  };

  const toggleAutoStep = (stepId: string) => {
    if (isAutoRunning) return;
    setAutoSelection((prev) => ({ ...prev, [stepId]: !prev[stepId] }));
  };

  const runAutoExecutionPlan = async () => {
    if (isAutoRunning) return;
    setIsAutoRunning(true);
    setAutoRunSummary('');
    pushTimeline({
      title: lang === 'ar' ? 'بدء التنفيذ' : 'Execution started',
      detail:
        lang === 'ar'
          ? `بدء تشغيل الخطة على ${child.name}.`
          : `Started running the plan for ${child.name}.`,
      status: 'info',
    });

    let done = 0;
    let failed = 0;
    let skipped = 0;
    const currentSeverityRank = severityRank[dominantSeverity];

    for (const step of autoExecutionSteps) {
      if (!autoSelection[step.id]) {
        setAutoStatus((prev) => ({ ...prev, [step.id]: 'skipped' }));
        pushTimeline({
          title: step.title,
          detail: lang === 'ar' ? 'تم التخطي (غير محدد).' : 'Skipped (not selected).',
          status: 'skipped',
        });
        skipped += 1;
        continue;
      }

      if (currentSeverityRank < severityRank[step.minSeverity]) {
        setAutoStatus((prev) => ({ ...prev, [step.id]: 'skipped' }));
        pushTimeline({
          title: step.title,
          detail:
            lang === 'ar'
              ? `تم التخطي لأن مستوى الخطر الحالي أقل من الحد الأدنى (${step.minSeverity}).`
              : `Skipped because current severity is below minimum (${step.minSeverity}).`,
          status: 'skipped',
        });
        skipped += 1;
        continue;
      }

      if (step.command === 'blockApp' && !highRiskApp) {
        setAutoStatus((prev) => ({ ...prev, [step.id]: 'skipped' }));
        pushTimeline({
          title: step.title,
          detail: lang === 'ar' ? 'تم التخطي لعدم وجود تطبيق عالي الخطورة.' : 'Skipped (no high-risk app).',
          status: 'skipped',
        });
        skipped += 1;
        continue;
      }

      try {
        setAutoStatus((prev) => ({ ...prev, [step.id]: 'pending' }));
        let commandValue = step.value;
        if (step.command === 'lockscreenBlackout') {
          commandValue = {
            enabled: true,
            message: blackoutMessage.trim() || fallbackBlackoutMessage,
            source: 'digital_balance_auto',
          };
        }
        if (step.command === 'walkieTalkieEnable') {
          commandValue = {
            enabled: true,
            source: planAudioSource,
            sourceTag: 'digital_balance_auto',
          };
        }
        await sendRemoteCommand(child.id, step.command, commandValue);
        setAutoStatus((prev) => ({ ...prev, [step.id]: 'done' }));
        pushTimeline({
          title: step.title,
          detail: lang === 'ar' ? 'تم التنفيذ بنجاح.' : 'Executed successfully.',
          status: 'done',
        });
        done += 1;
      } catch (error) {
        console.error(`Auto step failed: ${step.id}`, error);
        setAutoStatus((prev) => ({ ...prev, [step.id]: 'error' }));
        pushTimeline({
          title: step.title,
          detail: lang === 'ar' ? 'فشل التنفيذ.' : 'Execution failed.',
          status: 'error',
        });
        failed += 1;
      }
    }

    const summary = { done, skipped, failed };
    setIsAutoRunning(false);
    setAutoRunSummary(
      lang === 'ar'
        ? `تم تنفيذ ${done} خطوة، تخطي ${skipped}، وفشل ${failed}.`
        : `Executed ${done} steps, skipped ${skipped}, failed ${failed}.`
    );
    pushTimeline({
      title: lang === 'ar' ? 'ملخص التنفيذ' : 'Execution summary',
      detail:
        lang === 'ar'
          ? `${done} تم، ${skipped} تخطي، ${failed} فشل.`
          : `${done} done, ${skipped} skipped, ${failed} failed.`,
      status: failed > 0 ? 'error' : 'done',
    });
    onPlanExecutionResult?.(summary);
    return summary;
  };

  const runPlanAndCreateMode = async () => {
    await runAutoExecutionPlan();
    const suggested = buildSuggestedPlan();
    const modeId = onAcceptPlan(suggested);
    pushTimeline({
      title: lang === 'ar' ? 'حفظ الوضع الذكي' : 'Smart mode saved',
      detail:
        lang === 'ar'
          ? `تم حفظ الوضع ${suggested.name || ''}.`
          : `Saved mode ${suggested.name || ''}.`,
      status: 'done',
    });
    if (!modeId) {
      pushTimeline({
        title: lang === 'ar' ? 'معرف الوضع' : 'Mode ID',
        detail:
          lang === 'ar'
            ? 'تم حفظ الوضع بدون معرف فوري، يمكن تطبيقه من صفحة الأوضاع.'
            : 'Mode saved without immediate id. You can apply it from Modes page.',
        status: 'info',
      });
      navigate('/modes', { state: { suggestedMode: suggested } });
      return;
    }
    if (onApplyModeToChild) {
      try {
        await onApplyModeToChild(child.id, modeId);
        pushTimeline({
          title: lang === 'ar' ? 'تطبيق الوضع' : 'Mode applied',
          detail:
            lang === 'ar'
              ? `تم تطبيق الوضع على ${child.name}.`
              : `Applied mode to ${child.name}.`,
          status: 'done',
        });
      } catch (error) {
        pushTimeline({
          title: lang === 'ar' ? 'تطبيق الوضع' : 'Mode apply',
          detail: lang === 'ar' ? 'فشل تطبيق الوضع.' : 'Failed to apply mode.',
          status: 'error',
        });
        console.error('Apply mode from pulse failed', error);
      }
    }
  };

  const stepStateClass = (status: AutoStepStatus) => {
    if (status === 'done') return 'bg-emerald-100 text-emerald-700 border-emerald-200';
    if (status === 'pending') return 'bg-indigo-100 text-indigo-700 border-indigo-200';
    if (status === 'error') return 'bg-rose-100 text-rose-700 border-rose-200';
    if (status === 'skipped') return 'bg-slate-100 text-slate-500 border-slate-200';
    return 'bg-slate-50 text-slate-500 border-slate-100';
  };

  const stepStateLabel = (status: AutoStepStatus) => {
    if (lang === 'ar') {
      if (status === 'done') return 'تم';
      if (status === 'pending') return 'قيد التنفيذ';
      if (status === 'error') return 'فشل';
      if (status === 'skipped') return 'تخطي';
      return 'جاهز';
    }
    if (status === 'done') return 'Done';
    if (status === 'pending') return 'Running';
    if (status === 'error') return 'Failed';
    if (status === 'skipped') return 'Skipped';
    return 'Idle';
  };

  const timelineBadgeClass = (status: PlanTimelineStatus) => {
    if (status === 'done') return 'bg-emerald-100 text-emerald-700 border-emerald-200';
    if (status === 'error') return 'bg-rose-100 text-rose-700 border-rose-200';
    if (status === 'skipped') return 'bg-slate-100 text-slate-600 border-slate-200';
    return 'bg-indigo-100 text-indigo-700 border-indigo-200';
  };

  const timelineStatusLabel = (status: PlanTimelineStatus) => {
    if (lang !== 'ar') return status;
    if (status === 'done') return 'تم';
    if (status === 'error') return 'فشل';
    if (status === 'skipped') return 'تخطي';
    return 'معلومة';
  };

  const filteredExecutionTimeline = useMemo(() => {
    if (timelineFilter === 'all') return executionTimeline;
    return executionTimeline.filter((entry) => entry.status === timelineFilter);
  }, [executionTimeline, timelineFilter]);

  const executionSummary = useMemo(() => {
    return executionTimeline.reduce(
      (acc, entry) => {
        if (entry.status === 'done') acc.done += 1;
        if (entry.status === 'error') acc.failed += 1;
        if (entry.status === 'skipped') acc.skipped += 1;
        return acc;
      },
      { done: 0, failed: 0, skipped: 0 }
    );
  }, [executionTimeline]);

  const saveExecutionTimelineToVault = async () => {
    if (!onSaveExecutionEvidence || executionTimeline.length === 0 || isSavingExecutionEvidence) return;

    setIsSavingExecutionEvidence(true);
    try {
      const recordId = await onSaveExecutionEvidence({
        childId: child.id,
        childName: child.name,
        scenarioId: activeScenario.id,
        threatSubtype: activeScenario.id === 'threat_exposure' ? threatSubtype : undefined,
        contentSubtype: activeScenario.id === 'inappropriate_content' ? contentSubtype : undefined,
        scenarioTitle: activeScenario.title,
        severity: dominantSeverity,
        dominantPlatform,
        summary: executionSummary,
        timeline: executionTimeline.map((entry) => ({
          title: entry.title,
          detail: entry.detail,
          status: entry.status,
          at: entry.at.toISOString(),
        })),
      });

      pushTimeline({
        title: lang === 'ar' ? 'حفظ في الخزنة' : 'Saved to vault',
        detail:
          lang === 'ar'
            ? 'تم حفظ سجل التنفيذ كدليل في الأرشيف الجنائي.'
            : 'Execution timeline was saved as forensic evidence.',
        status: 'done',
      });

      if (recordId) {
        navigate('/vault', { state: { openAlertId: recordId, presetFilter: 'pulse' } });
      }
    } catch (error) {
      console.error('Save execution evidence failed', error);
      pushTimeline({
        title: lang === 'ar' ? 'حفظ في الخزنة' : 'Save to vault',
        detail:
          lang === 'ar'
            ? 'فشل حفظ سجل التنفيذ في الخزنة.'
            : 'Failed to save execution timeline to vault.',
        status: 'error',
      });
    } finally {
      setIsSavingExecutionEvidence(false);
    }
  };

  const exportExecutionTimeline = () => {
    if (filteredExecutionTimeline.length === 0) return;

    const exportPayload = filteredExecutionTimeline.map((entry) => ({
      title: entry.title,
      detail: entry.detail,
      status: entry.status,
      timestamp: entry.at.toISOString(),
      childName: child.name,
      scenarioId: activeScenario.id,
      severity: dominantSeverity,
    }));

    const blob = new Blob([JSON.stringify(exportPayload, null, 2)], {
      type: 'application/json;charset=utf-8',
    });
    const objectUrl = URL.createObjectURL(blob);
    const anchor = document.createElement('a');
    anchor.href = objectUrl;
    anchor.download = `amanah-execution-timeline-${child.id}-${Date.now()}.json`;
    document.body.appendChild(anchor);
    anchor.click();
    anchor.remove();
    URL.revokeObjectURL(objectUrl);
  };

  const copyIncidentPlan = async () => {
    const payload = [
      `خطة 10 دقائق: ${activeScenario.title}`,
      ...resolvedIncidentPlan.map((step, idx) => `${idx + 1}. ${step}`),
    ].join('\n');

    try {
      await navigator.clipboard.writeText(payload);
      setCopiedPlan(true);
      setTimeout(() => setCopiedPlan(false), 1500);
    } catch {
      setCopiedPlan(false);
    }
  };

  const previewCount = 2;
  const sectionStateKey = (scenarioId: PsychScenarioId, section: ScenarioSectionKey) =>
    `${scenarioId}:${section}`;
  const isSectionExpanded = (scenarioId: PsychScenarioId, section: ScenarioSectionKey) =>
    !!expandedSectionMap[sectionStateKey(scenarioId, section)];
  const toggleSectionExpansion = (scenarioId: PsychScenarioId, section: ScenarioSectionKey) => {
    const key = sectionStateKey(scenarioId, section);
    setExpandedSectionMap((prev) => ({ ...prev, [key]: !prev[key] }));
  };

  const scenarioOperationalContext: Record<PsychScenarioId, { riskLabel: string; responseWindow: string }> = {
    bullying: { riskLabel: 'أذى اجتماعي ونفسي ممتد', responseWindow: '48 ساعة' },
    threat_exposure: { riskLabel: 'تهديد مباشر وابتزاز متصاعد', responseWindow: 'فوريًا خلال نفس الساعة' },
    gaming: { riskLabel: 'استنزاف سلوكي وإدمان نمطي', responseWindow: '72 ساعة' },
    inappropriate_content: { riskLabel: 'تعرض لمحتوى مؤذٍ وتطبيع تدريجي', responseWindow: '48 ساعة' },
    cyber_crime: { riskLabel: 'انحراف تقني عالي المخاطر', responseWindow: 'خلال 24 ساعة' },
    crypto_scams: { riskLabel: 'خسارة مالية واحتيال استثماري', responseWindow: 'خلال 24 ساعة' },
    phishing_links: { riskLabel: 'سرقة حسابات وبيانات اعتماد', responseWindow: 'فوريًا خلال نفس الساعة' },
    self_harm: { riskLabel: 'خطر نفسي وجسدي حرج', responseWindow: 'فوريًا مع تصعيد مختص' },
    sexual_exploitation: { riskLabel: 'استغلال جنسي وضغط سري', responseWindow: 'فوريًا خلال نفس الساعة' },
    account_theft_fraud: { riskLabel: 'استيلاء على الحسابات والهوية', responseWindow: 'خلال 24 ساعة' },
    gambling_betting: { riskLabel: 'نزيف مالي واعتياد مخاطرة', responseWindow: '48 ساعة' },
    privacy_tracking: { riskLabel: 'انتهاك خصوصية وتتبّع مؤذٍ', responseWindow: 'خلال 24 ساعة' },
    harmful_challenges: { riskLabel: 'إيذاء بدني تحت ضغط الترند', responseWindow: 'فوريًا خلال نفس اليوم' },
  };

  const buildSectionDetail = (
    scenarioId: PsychScenarioId,
    section: Exclude<ScenarioSectionKey, 'interventionProgram' | 'dialogues'>,
    item: string,
    rank: number
  ) => {
    const hasScenarioContext = Object.prototype.hasOwnProperty.call(
      scenarioOperationalContext,
      scenarioId as string
    );
    const resolvedScenarioId = hasScenarioContext ? scenarioId : activeScenario.id;
    const context = scenarioOperationalContext[resolvedScenarioId] || {
      riskLabel: 'مخاطر رقمية عامة',
      responseWindow: '48 ساعة',
    };

    if (import.meta.env.DEV && !hasScenarioContext) {
      console.warn('[PsychologicalInsightView] Missing scenario context for buildSectionDetail:', {
        requestedScenarioId: scenarioId,
        resolvedScenarioId,
        section,
      });
    }

    const rankLabel =
      rank === 1 ? 'أولوية قصوى' : rank === 2 ? 'أولوية عالية' : 'أولوية متابعة';

    if (section === 'symptoms') {
      return `${rankLabel}: هذا العرض يرتبط بخطر "${context.riskLabel}". الإجراء العملي: راقب التكرار والزمن والسياق، وابدأ تدخلًا أوليًا خلال ${context.responseWindow}.`;
    }
    if (section === 'lurePatterns') {
      return `${rankLabel}: هذا النمط يُستخدم عادةً لاختبار قابلية الاستجابة ثم التصعيد. الإجراء العملي: تدريب الطفل على إيقاف التفاعل فورًا مع توثيق الدليل والإبلاغ خلال ${context.responseWindow}.`;
    }
    if (section === 'prevention') {
      return `${rankLabel}: طبّق هذه الوقاية كإعداد دائم ثم راجع أثرها أسبوعيًا. مؤشر النجاح: انخفاض تعرض "${context.riskLabel}" وتراجع التنبيهات المرتبطة.`;
    }
    if (section === 'incidentPlan') {
      return `${rankLabel}: هذه الخطوة تشغيلية ضمن خطة الاستجابة. نفّذها مع ختم زمني وتوثيق نتيجة واضح لضمان قابلية التدقيق والتحسين اللاحق.`;
    }
    return `${rankLabel}: صياغة إنذار تشغيلي لهذه الحالة. الأفضل ربط الرسالة بإجراء تنفيذي مباشر يتناسب مع "${context.riskLabel}".`;
  };

  const openScenarioSection = (scenarioId: PsychScenarioId, section: PreviewSectionKey) => {
    setActiveScenarioId(scenarioId);
    setExpandedScenarioId(scenarioId);
    const key = sectionStateKey(scenarioId, section);
    setExpandedSectionMap((prev) => ({ ...prev, [key]: true }));
    if (typeof window !== 'undefined') {
      const targetId = `scenario-${scenarioId}-${section}-details`;
      window.setTimeout(() => {
        const target = document.getElementById(targetId);
        if (!target) return;
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 120);
    }
  };

  const buildPreviewOperationalInsight = (
    section: PreviewSectionKey,
    item: string,
    rank: number
  ): PreviewOperationalInsight => {
    const isPrimary = rank === 1;
    const normalized = item.toLowerCase();

    if (section === 'symptoms') {
      if (normalized.includes('حذف') || normalized.includes('إخفاء')) {
        return {
          badge: isPrimary ? 'إشارة حرجة مبكرة' : 'إشارة عالية الشيوع',
          whyNow: 'الإخفاء المتكرر يعني غالبًا وجود ضغط نشط يخشى الطفل كشفه.',
          immediateAction: 'إجراء فوري: مراجعة هادئة لآخر 24 ساعة مع تفعيل حفظ الأدلة قبل الحذف.',
          toneClass: isPrimary ? 'bg-rose-100 text-rose-700 border-rose-200' : 'bg-amber-100 text-amber-700 border-amber-200',
        };
      }
      if (normalized.includes('مزاج') || normalized.includes('توتر')) {
        return {
          badge: isPrimary ? 'أولوية تدخل سلوكي' : 'إشارة عالية الشيوع',
          whyNow: 'تغير المزاج بعد الاستخدام مؤشر مبكر على محتوى ضاغط أو علاقة مؤذية.',
          immediateAction: 'إجراء فوري: فحص قصير بعد كل جلسة استخدام وربط النتيجة بسجل التنبيهات.',
          toneClass: isPrimary ? 'bg-rose-100 text-rose-700 border-rose-200' : 'bg-amber-100 text-amber-700 border-amber-200',
        };
      }
      if (normalized.includes('انسحاب') || normalized.includes('المدرسة')) {
        return {
          badge: isPrimary ? 'تأثير اجتماعي مباشر' : 'إشارة عالية الشيوع',
          whyNow: 'انتقال الأثر من الشاشة إلى المدرسة/العلاقات يعني أن الحالة تتصاعد.',
          immediateAction: 'إجراء فوري: تدخل أسري خلال 72 ساعة مع متابعة مدرسية قصيرة.',
          toneClass: isPrimary ? 'bg-rose-100 text-rose-700 border-rose-200' : 'bg-amber-100 text-amber-700 border-amber-200',
        };
      }
      return {
        badge: isPrimary ? 'مؤشر خطر مرتفع' : 'مؤشر متكرر',
        whyNow: 'هذا العرض غالبًا يظهر قبل التفاقم الكامل للحالة.',
        immediateAction: 'إجراء فوري: توثيق التكرار ثم مناقشته مع الطفل في جلسة دعم مركزة.',
        toneClass: isPrimary ? 'bg-rose-100 text-rose-700 border-rose-200' : 'bg-amber-100 text-amber-700 border-amber-200',
      };
    }

    if (normalized.includes('تهديد') || normalized.includes('ابتزاز') || normalized.includes('نشر')) {
      return {
        badge: isPrimary ? 'ابتزاز محتمل' : 'نمط ضغط متكرر',
        whyNow: 'التهديد بالنشر عادةً يسبق طلبات تصعيد مالية أو سلوكية.',
        immediateAction: 'إجراء فوري: لا تفاوض، توثيق فوري، حظر الحساب، وبدء الإبلاغ.',
        toneClass: isPrimary ? 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200' : 'bg-indigo-100 text-indigo-700 border-indigo-200',
      };
    }
    if (normalized.includes('حسابات وهمية') || normalized.includes('ثقة')) {
      return {
        badge: isPrimary ? 'استدراج مباشر' : 'استدراج شائع',
        whyNow: 'بناء الثقة المزيفة هو أسرع مدخل لاستخراج معلومات حساسة.',
        immediateAction: 'إجراء فوري: تطبيق قاعدة عدم مشاركة أي معلومة شخصية مع حساب جديد.',
        toneClass: isPrimary ? 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200' : 'bg-indigo-100 text-indigo-700 border-indigo-200',
      };
    }
    if (normalized.includes('مجموعات') || normalized.includes('إقصاء') || normalized.includes('إهانة')) {
      return {
        badge: isPrimary ? 'ضغط مجموعة مؤذٍ' : 'استدراج اجتماعي',
        whyNow: 'الضغط الجماعي يرفع سرعة الاستجابة الانفعالية ويقلل حكم الطفل السليم.',
        immediateAction: 'إجراء فوري: عزل المجموعة ثم تدريب الطفل على عبارات رفض جاهزة.',
        toneClass: isPrimary ? 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200' : 'bg-indigo-100 text-indigo-700 border-indigo-200',
      };
    }
    return {
      badge: isPrimary ? 'طريقة استدراج فعّالة' : 'طريقة استدراج شائعة',
      whyNow: 'هذه الطريقة تُستخدم عادةً لاختبار قابلية الطفل للاستجابة السريعة.',
      immediateAction: 'إجراء فوري: إيقاف التفاعل + حفظ الدليل + إبلاغ ولي الأمر فورًا.',
      toneClass: isPrimary ? 'bg-fuchsia-100 text-fuchsia-700 border-fuchsia-200' : 'bg-indigo-100 text-indigo-700 border-indigo-200',
    };
  };

  const renderRadarAxisTick = (tickProps: any) => {
    const { x, y, cx, cy, payload } = tickProps;
    const dx = x - cx;
    const dy = y - cy;
    const length = Math.sqrt(dx * dx + dy * dy) || 1;

    // Keep Arabic labels away from polygon edges, especially left/right axes.
    const radialOffset = Math.abs(dx) > Math.abs(dy) ? 34 : dy > 0 ? 28 : 24;
    const tx = x + (dx / length) * radialOffset;
    const ty = y + (dy / length) * radialOffset + (dy > 0 ? 5 : -3);

    let textAnchor: 'middle' | 'start' | 'end' = 'middle';
    if (Math.abs(dx) > 8) {
      textAnchor = dx > 0 ? 'start' : 'end';
    }

    return (
      <text
        x={tx}
        y={ty}
        textAnchor={textAnchor}
        dominantBaseline="central"
        direction="rtl"
        unicodeBidi="plaintext"
        fill="#64748b"
        fontSize={14}
        fontWeight={800}
        fontFamily="Cairo"
      >
        {payload?.value}
      </text>
    );
  };

  return (
    <div className="max-w-6xl mx-auto space-y-10 pb-72 animate-in fade-in" dir="rtl">
      <div className="bg-slate-900 rounded-[4rem] p-12 text-white shadow-2xl border-b-8 border-indigo-600">
        <h2 className="text-5xl font-black tracking-tighter mb-2">Amanah Pulse Pro</h2>
        <p className="text-indigo-300 font-bold text-lg opacity-90">
          تحليل الاستقرار الرقمي والنبض العاطفي لـ {child.name}
        </p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
        <div
          ref={primaryCardRef}
          tabIndex={-1}
          className="bg-[#f4f6fa] rounded-[3.5rem] p-8 md:p-10 shadow-xl border border-[#e8ecf3] h-full flex flex-col items-center focus:outline-none focus-visible:ring-4 focus-visible:ring-indigo-200"
        >
          <div className="w-full flex justify-center mb-9">
            <div className="px-8 py-4 bg-[#eef1f6] rounded-full">
              <h3 className="text-[2rem] md:text-[2.2rem] leading-none font-black text-slate-800 text-center">
                مؤشرات التوازن النفسي
              </h3>
            </div>
          </div>
          <div ref={radarContainerRef} className="w-full h-[26rem] relative flex items-center justify-center min-w-0">
            {radarSize.width > 40 && radarSize.height > 40 ? (
              <RadarChart width={radarSize.width} height={radarSize.height} cx="50%" cy="50%" outerRadius="64%" data={radarData}>
                <PolarGrid stroke="#d3dae5" strokeWidth={1.5} />
                <PolarAngleAxis dataKey="subject" tick={renderRadarAxisTick} />
                <RadarComponent
                  name="Amanah Pulse"
                  dataKey="A"
                  stroke="#5f63df"
                  strokeWidth={6}
                  fill="#7b80e7"
                  fillOpacity={0.38}
                />
              </RadarChart>
            ) : (
              <div className="h-full w-full rounded-3xl bg-[#eef2f9]" />
            )}
          </div>
          <div className="w-full mt-3 pt-2">
            <div className="max-w-md mx-auto grid grid-cols-[1fr_auto_1fr] items-center gap-6 text-center">
              <div>
                <p className="text-6xl md:text-7xl leading-none font-black text-rose-500">{profile.anxietyLevel}</p>
                <p className="mt-2 text-xl md:text-2xl font-black text-slate-400">القلق</p>
              </div>
              <div className="h-32 md:h-36 w-px bg-slate-300"></div>
              <div>
                <p className="text-6xl md:text-7xl leading-none font-black text-indigo-600">{stabilityScore}</p>
                <p className="mt-2 text-xl md:text-2xl font-black text-slate-400">الاستقرار</p>
              </div>
            </div>
          </div>
        </div>

        <div className="bg-indigo-50 rounded-[4rem] p-10 shadow-2xl border border-indigo-100 flex flex-col justify-between gap-6">
          <div className="space-y-4">
            <h3 className="text-2xl font-black text-slate-800">بروتوكول الرد المقترح</h3>
            <div className="bg-white p-7 rounded-[2.5rem] border border-indigo-100 italic font-bold text-indigo-900 leading-relaxed">
              {profile.recommendation}
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-white border border-indigo-100 rounded-2xl p-4 text-center">
                <p className="text-[11px] font-black text-slate-500 mb-1">جاهزية إدارة الحادث</p>
                <p className="text-3xl font-black text-indigo-700">{readinessScore}</p>
              </div>
              <div className="bg-white border border-indigo-100 rounded-2xl p-4 text-center">
                <p className="text-[11px] font-black text-slate-500 mb-1">العاطفة الغالبة</p>
                <p className="text-xl font-black text-slate-800">{profile.dominantEmotion}</p>
              </div>
            </div>
          </div>
          <button
            onClick={handleApplyEmergencyPlan}
            className="py-5 bg-slate-900 text-white rounded-[2rem] font-black text-lg shadow-2xl active:scale-95 transition-all"
          >
            تفعيل وضع الحماية المتوازن
          </button>
        </div>
      </div>

      <section className="bg-white rounded-[3rem] p-8 border border-slate-100 shadow-xl space-y-4">
        <div className="flex items-center justify-between flex-wrap gap-3">
          <h3 className="text-xl font-black text-slate-900">نتيجة التحليل التشخيصي للتنبيهات</h3>
          {diagnosis ? (
            <span className="px-4 py-2 rounded-full bg-indigo-100 text-indigo-700 text-xs font-black">
              دقة التشخيص: {diagnosis.confidence}%
            </span>
          ) : (
            <span className="px-4 py-2 rounded-full bg-slate-100 text-slate-600 text-xs font-black">
              لا توجد تنبيهات كافية للتحليل
            </span>
          )}
        </div>

        {diagnosis ? (
          <>
            <p className="text-xs font-bold text-slate-600">
              تم تحليل {diagnosis.analyzedAlertCount} تنبيه خاص بالطفل، وتم ترجيح سيناريو{' '}
              <span className="text-indigo-700 font-black">{activeScenario.title}</span> اعتمادًا على الشدة + الفئة +
              السياق النصي + حداثة الحدث.
            </p>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              {diagnosis.reasons.map((reason, idx) => (
                <div key={idx} className="bg-slate-50 border border-slate-100 rounded-2xl p-4">
                  <p className="text-xs font-bold text-slate-700 leading-relaxed">{reason}</p>
                </div>
              ))}
            </div>
          </>
        ) : (
          <p className="text-xs font-bold text-slate-500">
            سيتم تفعيل الربط التلقائي فور توفر تنبيهات مرتبطة بهذا الطفل.
          </p>
        )}
      </section>

      <section className="bg-white rounded-[3rem] p-8 border border-slate-100 shadow-xl space-y-6">
        <h3 className="text-2xl font-black text-slate-900">مؤشرات الخطر الحالية</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {riskSignals.map((signal) => (
            <article key={signal.id} className="bg-slate-50 border border-slate-100 rounded-2xl p-5 space-y-3">
              <div className="flex items-center justify-between gap-2">
                <h4 className="font-black text-sm text-slate-900">{signal.title}</h4>
                <span
                  className={`px-3 py-1 rounded-full border text-[10px] font-black ${severityClassMap[signal.severity]}`}
                >
                  {severityTextMap[signal.severity]}
                </span>
              </div>
              <p className="text-xs font-bold text-slate-700 leading-relaxed">{signal.reason}</p>
              <p className="text-xs font-black text-indigo-700">إجراء مقترح: {signal.suggestedAction}</p>
            </article>
          ))}
        </div>

        <div className="bg-slate-50 border border-slate-100 rounded-[2rem] p-5">
          <p className="text-[11px] font-black text-slate-500 mb-3">اتجاه النبض خلال الأسبوع</p>
          <div ref={trendContainerRef} className="w-full h-56 min-w-0">
            {trendSize.width > 40 && trendSize.height > 40 ? (
              <BarChart width={trendSize.width} height={trendSize.height} data={weeklyTrend} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
                <XAxis dataKey="label" tick={{ fill: '#64748b', fontSize: 11, fontWeight: 700 }} />
                <YAxis domain={[0, 100]} tick={{ fill: '#64748b', fontSize: 11, fontWeight: 700 }} />
                <Tooltip cursor={{ fill: '#eef2ff' }} />
                <Bar dataKey="value" fill="#6366f1" radius={[10, 10, 0, 0]} />
              </BarChart>
            ) : (
              <div className="h-full w-full rounded-2xl bg-slate-100" />
            )}
          </div>
        </div>
      </section>

      <section className="bg-gradient-to-br from-indigo-700 to-indigo-500 rounded-[3rem] p-8 text-white shadow-2xl border border-indigo-300/30 space-y-5">
        <div className="flex flex-wrap items-start justify-between gap-4">
          <div className="space-y-2 max-w-3xl">
            <h3 className="text-2xl md:text-3xl font-black tracking-tight">
              {lang === 'ar' ? 'خطة التوازن الرقمي' : 'Digital Balance Plan'}
            </h3>
            <p className="text-indigo-100 font-bold leading-relaxed">{digitalBalanceNarrative}</p>
          </div>
          <div className="flex flex-col gap-2 text-xs font-black">
            <span className="px-3 py-1 rounded-full bg-white/15 border border-white/20">
              {lang === 'ar' ? 'السيناريو' : 'Scenario'}: {activeScenario.title}
            </span>
            {activeScenario.id === 'threat_exposure' && (
              <span className="px-3 py-1 rounded-full bg-rose-500/25 border border-rose-200/50">
                {lang === 'ar' ? 'المسار' : 'Track'}:{' '}
                {lang === 'ar' ? activeThreatTrack.badgeLabelAr : activeThreatTrack.badgeLabelEn}
              </span>
            )}
            {activeScenario.id === 'inappropriate_content' && (
              <span className="px-3 py-1 rounded-full bg-amber-400/25 border border-amber-100/50">
                {lang === 'ar' ? 'المسار' : 'Track'}:{' '}
                {lang === 'ar' ? activeContentTrack.badgeLabelAr : activeContentTrack.badgeLabelEn}
              </span>
            )}
            {activeScenario.id === 'cyber_crime' && cyberRiskStage && (
              <span className="px-3 py-1 rounded-full bg-cyan-400/25 border border-cyan-100/50">
                {lang === 'ar' ? 'المرحلة' : 'Stage'}:{' '}
                {lang === 'ar' ? cyberRiskStage.badgeAr : cyberRiskStage.badgeEn}
              </span>
            )}
            <span className="px-3 py-1 rounded-full bg-white/15 border border-white/20">
              {lang === 'ar' ? 'المنصة' : 'Platform'}: {highRiskApp?.appName || dominantPlatform}
            </span>
            <span className="px-3 py-1 rounded-full bg-white/15 border border-white/20">
              {lang === 'ar' ? 'الحدة' : 'Severity'}: {dominantSeverity}
            </span>
          </div>
        </div>

        <div className="flex flex-wrap gap-2">
          {blockedDomains.map((domain) => (
            <span key={domain} className="px-3 py-1 rounded-lg text-[11px] font-black bg-white/15 border border-white/20">
              {domain}
            </span>
          ))}
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label className="text-xs font-black text-indigo-100 flex flex-col gap-2">
            {lang === 'ar' ? 'مصدر الصورة' : 'Video Source'}
            <select
              value={planVideoSource}
              onChange={(event) => setPlanVideoSource(event.target.value as PlanVideoSource)}
              className="bg-white/15 border border-white/30 rounded-xl px-3 py-2 text-white font-black outline-none"
            >
              <option className="text-slate-900" value="camera_front">
                {lang === 'ar' ? 'الكاميرا الأمامية' : 'Front Camera'}
              </option>
              <option className="text-slate-900" value="camera_back">
                {lang === 'ar' ? 'الكاميرا الخلفية' : 'Back Camera'}
              </option>
              <option className="text-slate-900" value="screen">
                {lang === 'ar' ? 'الشاشة' : 'Screen'}
              </option>
            </select>
          </label>
          <label className="text-xs font-black text-indigo-100 flex flex-col gap-2">
            {lang === 'ar' ? 'مصدر الصوت' : 'Audio Source'}
            <select
              value={planAudioSource}
              onChange={(event) => setPlanAudioSource(event.target.value as PlanAudioSource)}
              className="bg-white/15 border border-white/30 rounded-xl px-3 py-2 text-white font-black outline-none"
            >
              <option className="text-slate-900" value="mic">
                {lang === 'ar' ? 'الميكروفون' : 'Microphone'}
              </option>
              <option className="text-slate-900" value="system">
                {lang === 'ar' ? 'صوت النظام' : 'System Audio'}
              </option>
            </select>
          </label>
        </div>

        <label className="text-xs font-black text-indigo-100 flex flex-col gap-2">
          {lang === 'ar' ? 'رسالة شاشة الحجب الوقائي' : 'Blackout Screen Message'}
          <input
            value={blackoutMessage}
            onChange={(event) => setBlackoutMessage(event.target.value)}
            className="bg-white/15 border border-white/30 rounded-xl px-3 py-2 text-white font-bold outline-none placeholder:text-indigo-200/70"
            placeholder={
              lang === 'ar'
                ? 'مثال: تم قفل الجهاز لدواعي الأمان. يرجى التواصل مع الوالدين.'
                : 'Example: Device locked for safety. Please contact a parent.'
            }
          />
        </label>

        <div className="flex flex-wrap gap-3">
          <button
            onClick={handleApplyEmergencyPlan}
            className="px-5 py-3 rounded-xl bg-white text-indigo-700 font-black text-sm shadow active:scale-95"
          >
            {lang === 'ar' ? 'إنشاء وضع ذكي مقترح' : 'Create Suggested Smart Mode'}
          </button>
          <button
            onClick={runAutoExecutionPlan}
            disabled={isAutoRunning}
            className="px-5 py-3 rounded-xl bg-slate-900 text-white font-black text-sm shadow disabled:opacity-50 active:scale-95"
          >
            {isAutoRunning
              ? lang === 'ar'
                ? 'جارٍ التنفيذ...'
                : 'Running...'
              : lang === 'ar'
                ? 'تنفيذ الخطة تلقائياً'
                : 'Execute Plan Automatically'}
          </button>
          <button
            onClick={runPlanAndCreateMode}
            disabled={isAutoRunning}
            className="px-5 py-3 rounded-xl bg-emerald-500 text-white font-black text-sm shadow disabled:opacity-50 active:scale-95"
          >
            {isAutoRunning
              ? lang === 'ar'
                ? 'جارٍ التنفيذ...'
                : 'Running...'
              : lang === 'ar'
                ? 'تنفيذ + حفظ + تطبيق'
                : 'Execute + Save as Mode'}
          </button>
        </div>
      </section>

      <section className="bg-white rounded-[3rem] p-8 border border-slate-100 shadow-xl space-y-5">
        <div>
          <h3 className="text-xl font-black text-slate-900">
            {lang === 'ar' ? 'خطوات التنفيذ التلقائي' : 'Auto Execution Steps'}
          </h3>
          <p className="text-xs font-bold text-slate-500 mt-1">
            {lang === 'ar'
              ? 'يتم تشغيل الأوامر المختارة مباشرة على جهاز الطفل بناءً على مستوى الخطر الحالي.'
              : 'Selected commands run directly on the child device based on the current risk severity.'}
          </p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
          {autoExecutionSteps.map((step) => {
            const checked = !!autoSelection[step.id];
            const status = autoStatus[step.id] || 'idle';
            return (
              <article key={step.id} className="rounded-2xl border border-slate-100 bg-slate-50 p-4 space-y-3">
                <div className="flex items-center justify-between gap-2">
                  <div className="space-y-1">
                    <h4 className="font-black text-sm text-slate-900">{step.title}</h4>
                    <p className="text-xs font-bold text-slate-600 leading-relaxed">{step.description}</p>
                  </div>
                  <button
                    onClick={() => toggleAutoStep(step.id)}
                    disabled={isAutoRunning}
                    className={`w-12 h-7 rounded-full p-1 transition-all disabled:opacity-50 ${checked ? 'bg-indigo-600' : 'bg-slate-300'}`}
                  >
                    <span
                      className={`block w-5 h-5 rounded-full bg-white shadow transition-transform ${
                        checked ? '-translate-x-5' : 'translate-x-0'
                      }`}
                    />
                  </button>
                </div>

                <div className="flex flex-wrap items-center justify-between gap-2">
                  <span className="px-3 py-1 rounded-lg text-[10px] font-black bg-slate-200 text-slate-700">
                    {lang === 'ar' ? 'الحد الأدنى' : 'Min'}: {step.minSeverity}
                  </span>
                  <span className={`px-3 py-1 rounded-lg text-[10px] font-black border ${stepStateClass(status)}`}>
                    {stepStateLabel(status)}
                  </span>
                </div>
              </article>
            );
          })}
        </div>

        {autoRunSummary && (
          <div className="rounded-2xl border border-indigo-100 bg-indigo-50 text-indigo-700 px-4 py-3 text-xs font-black">
            {autoRunSummary}
          </div>
        )}

        <div className="rounded-2xl border border-slate-100 bg-slate-50 p-4 space-y-3">
          <div className="flex flex-wrap items-center justify-between gap-2">
            <h4 className="text-sm font-black text-slate-900">
              {lang === 'ar' ? 'السجل الزمني للتنفيذ' : 'Execution Timeline'}
            </h4>
            <div className="flex items-center gap-2">
              <span className="text-[10px] font-black text-slate-500">
                {lang === 'ar'
                  ? `${filteredExecutionTimeline.length} / ${executionTimeline.length} أحداث`
                  : `${filteredExecutionTimeline.length} / ${executionTimeline.length} events`}
              </span>
              <button
                onClick={saveExecutionTimelineToVault}
                disabled={
                  executionTimeline.length === 0 ||
                  isSavingExecutionEvidence ||
                  !onSaveExecutionEvidence
                }
                className="px-3 py-1 rounded-lg bg-emerald-600 text-white text-[10px] font-black disabled:opacity-40"
              >
                {isSavingExecutionEvidence
                  ? lang === 'ar'
                    ? 'جارٍ الحفظ...'
                    : 'Saving...'
                  : lang === 'ar'
                    ? 'حفظ بالخزنة'
                    : 'Save to Vault'}
              </button>
              <button
                onClick={exportExecutionTimeline}
                disabled={filteredExecutionTimeline.length === 0}
                className="px-3 py-1 rounded-lg bg-indigo-600 text-white text-[10px] font-black disabled:opacity-40"
              >
                {lang === 'ar' ? 'تصدير JSON' : 'Export JSON'}
              </button>
            </div>
          </div>

          <div className="flex flex-wrap gap-2">
            {(['all', 'done', 'error', 'skipped', 'info'] as const).map((statusKey) => {
              const isActive = timelineFilter === statusKey;
              const label =
                statusKey === 'all'
                  ? lang === 'ar'
                    ? 'الكل'
                    : 'All'
                  : timelineStatusLabel(statusKey);
              return (
                <button
                  key={statusKey}
                  onClick={() => setTimelineFilter(statusKey)}
                  className={`px-3 py-1 rounded-lg text-[10px] font-black border ${
                    isActive
                      ? 'bg-slate-900 text-white border-slate-900'
                      : 'bg-white text-slate-600 border-slate-200'
                  }`}
                >
                  {label}
                </button>
              );
            })}
          </div>

          {filteredExecutionTimeline.length > 0 ? (
            <div className="space-y-2 max-h-56 overflow-y-auto custom-scrollbar pr-1">
              {filteredExecutionTimeline.map((entry) => (
                <article
                  key={entry.id}
                  className="bg-white border border-slate-100 rounded-xl px-3 py-2 flex items-start justify-between gap-3"
                >
                  <div className="space-y-1">
                    <p className="text-xs font-black text-slate-900">{entry.title}</p>
                    <p className="text-[11px] font-bold text-slate-600">{entry.detail}</p>
                  </div>
                  <div className="flex flex-col items-end gap-1 shrink-0">
                    <span className={`px-2 py-0.5 rounded-md border text-[10px] font-black ${timelineBadgeClass(entry.status)}`}>
                      {timelineStatusLabel(entry.status)}
                    </span>
                    <span className="text-[10px] font-bold text-slate-400">
                      {entry.at.toLocaleTimeString(lang === 'ar' ? 'ar-EG' : 'en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                      })}
                    </span>
                  </div>
                </article>
              ))}
            </div>
          ) : (
            <p className="text-[11px] font-bold text-slate-500">
              {lang === 'ar'
                ? executionTimeline.length > 0
                  ? 'لا توجد أحداث ضمن الفلتر الحالي.'
                  : 'ابدأ التنفيذ لعرض سجل الخطوات تلقائيًا.'
                : executionTimeline.length > 0
                  ? 'No events for the selected filter.'
                  : 'Run the plan to populate execution timeline.'}
            </p>
          )}
        </div>
      </section>

      <section className="space-y-5">
        <div>
          <h3 className="text-3xl font-black text-slate-900 tracking-tighter mb-2">مركز النبض النفسي</h3>
          <p className="text-slate-500 font-bold">بطاقات مدمجة قابلة للتمدد: ملخص سريع ثم عرض التفاصيل داخل نفس البطاقة.</p>
        </div>

        <div className="space-y-5 pt-1">
          {guidanceScenarios.map((scenario) => {
            const isExpanded = expandedScenarioId === scenario.id;
            const isActiveScenario = activeScenarioId === scenario.id;
            const glass = scenarioGlassStyles[scenario.id];
            const incidentSteps =
              scenario.id === 'threat_exposure'
                ? isActiveScenario
                  ? resolvedIncidentPlan
                  : scenario.incidentPlan
                : scenario.id === 'inappropriate_content'
                  ? isActiveScenario
                    ? resolvedIncidentPlan
                    : scenario.incidentPlan
                  : scenario.incidentPlan;
            const alertTemplates =
              scenario.id === 'threat_exposure'
                ? isActiveScenario
                  ? resolvedAlertTemplates
                  : scenario.alertTemplates
                : scenario.id === 'inappropriate_content'
                  ? isActiveScenario
                    ? resolvedAlertTemplates
                    : scenario.alertTemplates
                  : scenario.alertTemplates;
            const canExpandSymptoms = scenario.symptoms.length > previewCount;
            const canExpandLurePatterns = scenario.lurePatterns.length > previewCount;

            return (
              <article
                key={scenario.id}
                className={`relative w-full overflow-hidden rounded-[3rem] border border-slate-100 bg-white/55 backdrop-blur-xl shadow-xl shadow-slate-900/10 transition-all duration-300 ${
                  isExpanded ? 'ring-2 ring-white/70' : ''
                }`}
              >
                <div className={`pointer-events-none absolute inset-0 bg-gradient-to-br ${glass.tint}`} />
                <div className="relative p-5 space-y-4">
                  <header className="flex items-start justify-between gap-3">
                    <button
                      type="button"
                      onClick={() => {
                        setActiveScenarioId(scenario.id);
                        setExpandedScenarioId((prev) => (prev === scenario.id ? null : scenario.id));
                      }}
                      className="flex items-center gap-3 text-right"
                    >
                      <div className="h-12 w-12 rounded-2xl bg-white/85 shadow-[0_2px_8px_rgba(15,23,42,0.08)] flex items-center justify-center text-2xl">
                        {scenario.icon}
                      </div>
                      <div>
                        <h4 className="text-base md:text-lg font-black text-slate-900">{scenario.title}</h4>
                        <p className="text-[11px] font-black text-slate-600">
                          مستوى الخطر: {severityTextMap[scenario.severity]}
                        </p>
                      </div>
                    </button>

                    <button
                      type="button"
                      onClick={() => {
                        setActiveScenarioId(scenario.id);
                        setExpandedScenarioId((prev) => (prev === scenario.id ? null : scenario.id));
                      }}
                      className={`shrink-0 px-3 py-2 rounded-xl text-[11px] font-black text-white bg-gradient-to-r ${glass.button} shadow-lg`}
                    >
                      {isExpanded ? 'إخفاء التفاصيل' : 'اعرض المزيد'}
                    </button>
                  </header>

                  {!isExpanded && (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <div className="rounded-2xl bg-slate-50/85 border border-slate-100 p-3 space-y-2 shadow-sm">
                        <div className="flex items-center justify-between gap-2">
                          <p className="text-[11px] font-black text-slate-500">الأعراض (أعلى إشارتين)</p>
                          <button
                            type="button"
                            onClick={() => openScenarioSection(scenario.id, 'symptoms')}
                            className="px-2.5 py-1 rounded-lg bg-slate-900 text-white text-[10px] font-black"
                          >
                            {canExpandSymptoms ? 'تفاصيل موسعة' : 'فتح القسم التفصيلي'}
                          </button>
                        </div>
                        <div className="space-y-2">
                          {scenario.symptoms.slice(0, 2).map((item, idx) => {
                            const preview = buildPreviewOperationalInsight('symptoms', item, idx + 1);
                            return (
                              <article key={`${item}-${idx}`} className="rounded-2xl border border-slate-100 bg-white/95 p-3 space-y-1.5 shadow-sm">
                                <div className="flex items-center justify-between gap-2">
                                  <span className={`px-2 py-0.5 rounded-md border text-[10px] font-black ${preview.toneClass}`}>
                                    {preview.badge}
                                  </span>
                                  <span className="text-[10px] font-black text-slate-500">#{idx + 1}</span>
                                </div>
                                <p className="text-xs font-black text-slate-800 leading-relaxed">{item}</p>
                                <p className="text-[11px] font-bold text-slate-600">لماذا الآن: {preview.whyNow}</p>
                                <p className="text-[11px] font-bold text-slate-700">{preview.immediateAction}</p>
                              </article>
                            );
                          })}
                        </div>
                      </div>
                      <div className="rounded-2xl bg-slate-50/85 border border-slate-100 p-3 space-y-2 shadow-sm">
                        <div className="flex items-center justify-between gap-2">
                          <p className="text-[11px] font-black text-slate-500">طرق الاستدراج (أعلى نمطين)</p>
                          <button
                            type="button"
                            onClick={() => openScenarioSection(scenario.id, 'lurePatterns')}
                            className="px-2.5 py-1 rounded-lg bg-slate-900 text-white text-[10px] font-black"
                          >
                            {canExpandLurePatterns ? 'تفاصيل موسعة' : 'فتح القسم التفصيلي'}
                          </button>
                        </div>
                        <div className="space-y-2">
                          {scenario.lurePatterns.slice(0, 2).map((item, idx) => {
                            const preview = buildPreviewOperationalInsight('lurePatterns', item, idx + 1);
                            return (
                              <article key={`${item}-${idx}`} className="rounded-2xl border border-slate-100 bg-white/95 p-3 space-y-1.5 shadow-sm">
                                <div className="flex items-center justify-between gap-2">
                                  <span className={`px-2 py-0.5 rounded-md border text-[10px] font-black ${preview.toneClass}`}>
                                    {preview.badge}
                                  </span>
                                  <span className="text-[10px] font-black text-slate-500">#{idx + 1}</span>
                                </div>
                                <p className="text-xs font-black text-slate-800 leading-relaxed">{item}</p>
                                <p className="text-[11px] font-bold text-slate-600">لماذا الآن: {preview.whyNow}</p>
                                <p className="text-[11px] font-bold text-slate-700">{preview.immediateAction}</p>
                              </article>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  )}

                  {isExpanded && (
                    <div className="space-y-4 pt-3">
                      {scenario.id === 'threat_exposure' && isActiveScenario && (
                        <div className="rounded-xl bg-rose-50/80 border border-rose-200 px-3 py-2 text-[11px] font-black text-rose-700">
                          المسار النشط: {lang === 'ar' ? activeThreatTrack.badgeLabelAr : activeThreatTrack.badgeLabelEn}
                        </div>
                      )}
                      {scenario.id === 'inappropriate_content' && isActiveScenario && (
                        <div className="rounded-xl bg-amber-50/80 border border-amber-200 px-3 py-2 text-[11px] font-black text-amber-700">
                          المسار النشط: {lang === 'ar' ? activeContentTrack.badgeLabelAr : activeContentTrack.badgeLabelEn}
                        </div>
                      )}
                      {scenario.id === 'cyber_crime' && isActiveScenario && cyberRiskStage && (
                        <div className="rounded-xl bg-cyan-50/80 border border-cyan-200 px-3 py-2 text-[11px] font-black text-cyan-700">
                          المرحلة النشطة: {lang === 'ar' ? cyberRiskStage.badgeAr : cyberRiskStage.badgeEn}
                        </div>
                      )}

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div
                          id={`scenario-${scenario.id}-symptoms-details`}
                          className="rounded-2xl bg-slate-50/85 border border-slate-100 p-4 space-y-2 shadow-sm"
                        >
                          <div className="flex items-center justify-between gap-2">
                            <p className="text-[11px] font-black text-slate-500">الأعراض التفصيلية</p>
                            <button
                              type="button"
                              onClick={() => toggleSectionExpansion(scenario.id, 'symptoms')}
                              disabled={!canExpandSymptoms}
                              className={`px-2.5 py-1 rounded-lg text-[10px] font-black ${
                                canExpandSymptoms ? 'bg-slate-900 text-white' : 'bg-slate-200 text-slate-500 cursor-not-allowed'
                              }`}
                            >
                              {canExpandSymptoms
                                ? isSectionExpanded(scenario.id, 'symptoms')
                                  ? 'عرض أقل'
                                  : 'تفاصيل موسعة'
                                : 'كل العناصر ظاهرة'}
                            </button>
                          </div>
                          <div className="space-y-2">
                            {(isSectionExpanded(scenario.id, 'symptoms')
                              ? scenario.symptoms
                              : scenario.symptoms.slice(0, previewCount)
                            ).map((item, idx) => (
                              <article key={`${item}-${idx}`} className="rounded-2xl bg-white/95 border border-slate-100 p-3 space-y-1 shadow-sm">
                                <p className="text-xs font-black text-slate-800">{idx + 1}. {item}</p>
                                <p className="text-[11px] font-bold text-slate-600">
                                  {buildSectionDetail(scenario.id, 'symptoms', item, idx + 1)}
                                </p>
                              </article>
                            ))}
                          </div>
                        </div>

                        <div
                          id={`scenario-${scenario.id}-lurePatterns-details`}
                          className="rounded-2xl bg-slate-50/85 border border-slate-100 p-4 space-y-2 shadow-sm"
                        >
                          <div className="flex items-center justify-between gap-2">
                            <p className="text-[11px] font-black text-slate-500">طرق الاستدراج التفصيلية</p>
                            <button
                              type="button"
                              onClick={() => toggleSectionExpansion(scenario.id, 'lurePatterns')}
                              disabled={!canExpandLurePatterns}
                              className={`px-2.5 py-1 rounded-lg text-[10px] font-black ${
                                canExpandLurePatterns ? 'bg-slate-900 text-white' : 'bg-slate-200 text-slate-500 cursor-not-allowed'
                              }`}
                            >
                              {canExpandLurePatterns
                                ? isSectionExpanded(scenario.id, 'lurePatterns')
                                  ? 'عرض أقل'
                                  : 'تفاصيل موسعة'
                                : 'كل العناصر ظاهرة'}
                            </button>
                          </div>
                          <div className="space-y-2">
                            {(isSectionExpanded(scenario.id, 'lurePatterns')
                              ? scenario.lurePatterns
                              : scenario.lurePatterns.slice(0, previewCount)
                            ).map((item, idx) => (
                              <article key={`${item}-${idx}`} className="rounded-2xl bg-white/95 border border-slate-100 p-3 space-y-1 shadow-sm">
                                <p className="text-xs font-black text-slate-800">{idx + 1}. {item}</p>
                                <p className="text-[11px] font-bold text-slate-600">
                                  {buildSectionDetail(scenario.id, 'lurePatterns', item, idx + 1)}
                                </p>
                              </article>
                            ))}
                          </div>
                        </div>
                      </div>

                      <div className="rounded-2xl bg-slate-50/85 border border-slate-100 p-4 space-y-2 shadow-sm">
                        <div className="flex items-center justify-between gap-2">
                          <p className="text-[11px] font-black text-slate-500">إجراءات الوقاية (موسعة)</p>
                          <button
                            type="button"
                            onClick={() => toggleSectionExpansion(scenario.id, 'prevention')}
                            className="px-2.5 py-1 rounded-lg bg-slate-900 text-white text-[10px] font-black"
                          >
                            {isSectionExpanded(scenario.id, 'prevention') ? 'عرض أقل' : 'تفاصيل موسعة'}
                          </button>
                        </div>
                        <div className="space-y-2">
                          {(isSectionExpanded(scenario.id, 'prevention')
                            ? scenario.prevention
                            : scenario.prevention.slice(0, previewCount)
                          ).map((item, idx) => (
                            <article key={`${item}-${idx}`} className="rounded-2xl bg-white/95 border border-slate-100 p-3 space-y-1 shadow-sm">
                              <p className="text-xs font-black text-slate-800">{idx + 1}. {item}</p>
                              <p className="text-[11px] font-bold text-slate-600">
                                {buildSectionDetail(scenario.id, 'prevention', item, idx + 1)}
                              </p>
                            </article>
                          ))}
                        </div>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div className="rounded-2xl bg-slate-50/85 border border-slate-100 p-4 space-y-2 shadow-sm">
                          <div className="flex items-center justify-between gap-2">
                            <p className="text-[11px] font-black text-slate-500">خطة 10 دقائق (تفصيل)</p>
                            <button
                              type="button"
                              onClick={() => toggleSectionExpansion(scenario.id, 'incidentPlan')}
                              className="px-2.5 py-1 rounded-lg bg-slate-900 text-white text-[10px] font-black"
                            >
                              {isSectionExpanded(scenario.id, 'incidentPlan') ? 'عرض أقل' : 'تفاصيل موسعة'}
                            </button>
                          </div>
                          <div className="space-y-2">
                            {(isSectionExpanded(scenario.id, 'incidentPlan')
                              ? incidentSteps
                              : incidentSteps.slice(0, previewCount)
                            ).map((step, idx) => (
                              <article key={`${step}-${idx}`} className="rounded-2xl bg-white/95 border border-slate-100 p-3 space-y-1 shadow-sm">
                                <p className="text-xs font-black text-slate-800">{idx + 1}. {step}</p>
                                <p className="text-[11px] font-bold text-slate-600">
                                  {buildSectionDetail(scenario.id, 'incidentPlan', step, idx + 1)}
                                </p>
                              </article>
                            ))}
                          </div>
                        </div>

                        <div className="rounded-2xl bg-slate-50/85 border border-slate-100 p-4 space-y-2 shadow-sm">
                          <div className="flex items-center justify-between gap-2">
                            <p className="text-[11px] font-black text-slate-500">رسائل التنبيه (تفصيل)</p>
                            <button
                              type="button"
                              onClick={() => toggleSectionExpansion(scenario.id, 'alertTemplates')}
                              className="px-2.5 py-1 rounded-lg bg-slate-900 text-white text-[10px] font-black"
                            >
                              {isSectionExpanded(scenario.id, 'alertTemplates') ? 'عرض أقل' : 'تفاصيل موسعة'}
                            </button>
                          </div>
                          <div className="space-y-2">
                            {(isSectionExpanded(scenario.id, 'alertTemplates')
                              ? alertTemplates
                              : alertTemplates.slice(0, previewCount)
                            ).map((template, idx) => (
                              <article key={`${template}-${idx}`} className="rounded-2xl bg-white/95 border border-slate-100 p-3 space-y-1 shadow-sm">
                                <p className="text-xs font-black text-slate-800">{idx + 1}. {template}</p>
                                <p className="text-[11px] font-bold text-slate-600">
                                  {buildSectionDetail(scenario.id, 'alertTemplates', template, idx + 1)}
                                </p>
                              </article>
                            ))}
                          </div>
                        </div>
                      </div>

                      <div className="rounded-2xl bg-slate-50/85 border border-slate-100 p-4 space-y-2 shadow-sm">
                        <div className="flex items-center justify-between gap-2">
                          <p className="text-[11px] font-black text-slate-500">برنامج التدخل العلاجي (موسع)</p>
                          <button
                            type="button"
                            onClick={() => toggleSectionExpansion(scenario.id, 'interventionProgram')}
                            className="px-2.5 py-1 rounded-lg bg-slate-900 text-white text-[10px] font-black"
                          >
                            {isSectionExpanded(scenario.id, 'interventionProgram') ? 'عرض أقل' : 'تفاصيل موسعة'}
                          </button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                          {(isSectionExpanded(scenario.id, 'interventionProgram')
                            ? scenario.interventionProgram
                            : scenario.interventionProgram.slice(0, previewCount)
                          ).map((step, idx) => (
                            <article key={`${step.week}-${idx}`} className="rounded-2xl bg-white/95 border border-slate-100 p-3 space-y-1 shadow-sm">
                              <p className="text-[10px] font-black text-indigo-600">{step.week}</p>
                              <p className="text-xs font-black text-slate-800">{step.goal}</p>
                              <p className="text-[11px] font-bold text-slate-600">{step.action}</p>
                              <p className="text-[11px] font-bold text-slate-500">
                                شرح تنفيذي: ابدأ بهدف "{step.goal}" عبر إجراء "{step.action}" مع مراجعة أثره خلال 7 أيام.
                              </p>
                            </article>
                          ))}
                        </div>
                      </div>

                      <div className="rounded-2xl bg-slate-50/85 border border-slate-100 p-4 space-y-2 shadow-sm">
                        <div className="flex items-center justify-between gap-2">
                          <p className="text-[11px] font-black text-slate-500">الحوارات التربوية (موسعة)</p>
                          <button
                            type="button"
                            onClick={() => toggleSectionExpansion(scenario.id, 'dialogues')}
                            className="px-2.5 py-1 rounded-lg bg-slate-900 text-white text-[10px] font-black"
                          >
                            {isSectionExpanded(scenario.id, 'dialogues') ? 'عرض أقل' : 'تفاصيل موسعة'}
                          </button>
                        </div>
                        <div className="space-y-2">
                          {(isSectionExpanded(scenario.id, 'dialogues')
                            ? scenario.dialogues
                            : scenario.dialogues.slice(0, previewCount)
                          ).map((dialogue, idx) => (
                            <article key={`${dialogue.situation}-${idx}`} className="rounded-2xl bg-white/95 border border-slate-100 p-3 space-y-1 shadow-sm">
                              <p className="text-[11px] font-black text-slate-500">{dialogue.situation}</p>
                              <p className="text-xs font-black text-slate-800">{dialogue.opener}</p>
                              <p className="text-[11px] font-bold text-slate-600">{dialogue.advice}</p>
                              <p className="text-[11px] font-bold text-slate-500">
                                إرشاد تطبيقي: ابدأ بالاحتواء ثم اسأل سؤالًا مفتوحًا، واختم بخطوة أمان واحدة قابلة للتنفيذ فورًا.
                              </p>
                            </article>
                          ))}
                        </div>
                      </div>

                      {isActiveScenario && (
                        <div className="flex items-center justify-between gap-3 flex-wrap">
                          <p className="text-xs font-black text-slate-700">{quickAdvisorTip}</p>
                          <button
                            onClick={copyIncidentPlan}
                            className="px-4 py-2 text-[11px] font-black rounded-xl bg-slate-900 text-white"
                          >
                            {copiedPlan ? 'تم النسخ' : 'نسخ الخطة'}
                          </button>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </article>
            );
          })}
        </div>
      </section>

    </div>
  );
};

export default PsychologicalInsightView;
