import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import React, { useState, useMemo, useEffect } from 'react';
import { useLocation } from 'react-router-dom';
import { AlertSeverity, Classification, ContentType } from '@/types';
import { ICONS, AmanahShield } from '@/constants';
import { canPerform } from '@/services/rbacService';
import { getCustodyLogs, updateEvidenceClassification, deleteEvidenceSecurely } from '@/services/firestoreService';
const EvidenceVaultView = ({ records, currentUser }) => {
    const location = useLocation();
    const [selectedId, setSelectedId] = useState(null);
    const [custodyLogs, setCustodyLogs] = useState([]);
    const [isDetailsLoading, setIsDetailsLoading] = useState(false);
    // Filters State
    const [filters, setFilters] = useState({
        childId: 'ALL',
        severity: [],
        contentType: [],
        classification: 'ALL',
        search: ''
    });
    const selectedRecord = useMemo(() => records.find(r => r.evidence_id === selectedId), [records, selectedId]);
    useEffect(() => {
        if (selectedId) {
            setIsDetailsLoading(true);
            getCustodyLogs(selectedId).then(logs => {
                setCustodyLogs(logs);
                setIsDetailsLoading(false);
            });
        }
    }, [selectedId]);
    useEffect(() => {
        if (location.state && location.state.openAlertId) {
            setSelectedId(location.state.openAlertId);
        }
    }, [location.state]);
    const filtered = useMemo(() => {
        return records.filter(r => {
            const matchSearch = r.summary.toLowerCase().includes(filters.search.toLowerCase()) || r.suspectUsername.toLowerCase().includes(filters.search.toLowerCase());
            const matchChild = filters.childId === 'ALL' || r.child_id === filters.childId;
            const matchSev = filters.severity.length === 0 || filters.severity.includes(r.severity);
            const matchType = filters.contentType.length === 0 || filters.contentType.includes(r.content_type);
            const matchClass = filters.classification === 'ALL' || r.classification === filters.classification;
            return matchSearch && matchChild && matchSev && matchType && matchClass;
        }).sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
    }, [records, filters]);
    const handleToggleHold = async () => {
        if (!selectedRecord || !canPerform(currentUser.role, 'evidence.legal_hold'))
            return;
        const newClass = selectedRecord.classification === Classification.LEGAL_HOLD ? Classification.NORMAL : Classification.LEGAL_HOLD;
        await updateEvidenceClassification(selectedRecord.evidence_id, newClass, currentUser.id, "تغيير يدوي للحالة الجنائية");
        alert(`تم تحديث تصنيف الدليل إلى: ${newClass}`);
    };
    const handleDelete = async () => {
        if (!selectedRecord || !canPerform(currentUser.role, 'evidence.delete'))
            return;
        if (selectedRecord.classification === Classification.LEGAL_HOLD)
            return alert("ممنوع حذف دليل قيد الحجز القانوني!");
        const reason = prompt("يرجى كتابة سبب الحذف للتدقيق الجنائي (MFA Simulation):");
        if (!reason)
            return;
        if (window.confirm("سيتم تدمير هذا السجل نهائياً. هل أنت متأكد؟")) {
            await deleteEvidenceSecurely(selectedRecord.evidence_id, currentUser.id, reason);
            setSelectedId(null);
        }
    };
    return (_jsxs("div", { className: "fixed inset-x-0 bottom-0 top-24 flex bg-slate-50 animate-in fade-in", dir: "rtl", children: [_jsxs("aside", { className: "w-[320px] border-l border-slate-200 bg-white flex flex-col p-8 space-y-10 shadow-sm z-20 overflow-y-auto custom-scrollbar", children: [_jsxs("div", { className: "space-y-4", children: [_jsx("h4", { className: "text-[11px] font-black text-slate-400 uppercase tracking-widest px-2", children: "\u0627\u0644\u0628\u062D\u062B \u0648\u0627\u0644\u0645\u0635\u0641\u0627\u0629" }), _jsx("div", { className: "relative", children: _jsx("input", { type: "text", placeholder: "\u0628\u062D\u062B \u0641\u064A \u0627\u0644\u0645\u0644\u062E\u0635 \u0623\u0648 \u0627\u0644\u0645\u0634\u062A\u0628\u0647...", value: filters.search, onChange: e => setFilters({ ...filters, search: e.target.value }), className: "w-full bg-slate-50 border border-slate-100 rounded-2xl px-6 py-4 text-xs font-bold outline-none focus:border-indigo-500 transition-all" }) })] }), _jsxs("div", { className: "space-y-8", children: [_jsx(FilterSection, { label: "\u0627\u0644\u062A\u0635\u0646\u064A\u0641 \u0627\u0644\u062C\u0646\u0627\u0626\u064A", children: _jsxs("select", { value: filters.classification, onChange: e => setFilters({ ...filters, classification: e.target.value }), className: "w-full bg-slate-50 border border-slate-100 p-4 rounded-xl text-xs font-black outline-none", children: [_jsx("option", { value: "ALL", children: "\u0643\u0627\u0641\u0629 \u0627\u0644\u062A\u0635\u0646\u064A\u0641\u0627\u062A" }), _jsx("option", { value: Classification.NORMAL, children: "\u0639\u0627\u062F\u064A (Normal)" }), _jsx("option", { value: Classification.RESTRICTED, children: "\u0645\u0642\u064A\u062F (Restricted)" }), _jsx("option", { value: Classification.LEGAL_HOLD, children: "\u062D\u062C\u0632 \u0642\u0627\u0646\u0648\u0646\u064A (Legal Hold)" })] }) }), _jsx(FilterSection, { label: "\u0645\u0633\u062A\u0648\u0649 \u0627\u0644\u062E\u0637\u0648\u0631\u0629", children: _jsx("div", { className: "flex flex-wrap gap-2", children: [AlertSeverity.CRITICAL, AlertSeverity.HIGH, AlertSeverity.MEDIUM, AlertSeverity.LOW].map(sev => (_jsx("button", { onClick: () => setFilters(prev => ({ ...prev, severity: prev.severity.includes(sev) ? prev.severity.filter(s => s !== sev) : [...prev.severity, sev] })), className: `px-4 py-2 rounded-xl text-[10px] font-black border-2 transition-all ${filters.severity.includes(sev) ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg' : 'bg-white border-slate-100 text-slate-400'}`, children: sev.toUpperCase() }, sev))) }) }), _jsx(FilterSection, { label: "\u0646\u0648\u0639 \u0627\u0644\u0645\u062D\u062A\u0648\u0649", children: _jsx("div", { className: "grid grid-cols-2 gap-2", children: [ContentType.IMAGE, ContentType.TEXT, ContentType.AUDIO, ContentType.VIDEO].map(type => (_jsxs("button", { onClick: () => setFilters(prev => ({ ...prev, contentType: prev.contentType.includes(type) ? prev.contentType.filter(t => t !== type) : [...prev.contentType, type] })), className: `p-3 rounded-xl text-[9px] font-black border-2 transition-all flex items-center gap-2 ${filters.contentType.includes(type) ? 'bg-slate-900 border-slate-900 text-white shadow-md' : 'bg-white border-slate-50 text-slate-400'}`, children: [_jsx("span", { children: type === ContentType.IMAGE ? '🖼️' : type === ContentType.TEXT ? '📝' : '🔊' }), _jsx("span", { children: type.toUpperCase() })] }, type))) }) })] }), _jsx("div", { className: "mt-auto pt-8 border-t border-slate-50 space-y-4", children: _jsxs("div", { className: "bg-indigo-50 p-6 rounded-3xl border border-indigo-100", children: [_jsx("p", { className: "text-[10px] font-black text-indigo-900 mb-1", children: "\u0627\u0644\u0648\u0635\u0648\u0644 \u0627\u0644\u0633\u064A\u0627\u062F\u064A: \u0646\u0634\u0637" }), _jsxs("p", { className: "text-[8px] font-bold text-indigo-600 leading-relaxed uppercase", children: ["Role: ", currentUser.role] })] }) })] }), _jsxs("main", { className: "flex-1 bg-slate-50/50 flex flex-col min-w-0 border-l border-slate-200", children: [_jsxs("header", { className: "p-8 bg-white border-b border-slate-200 flex justify-between items-center flex-shrink-0", children: [_jsxs("div", { children: [_jsx("h2", { className: "text-2xl font-black text-slate-900 tracking-tighter", children: "\u0633\u062C\u0644 \u0627\u0644\u0623\u062F\u0644\u0629 \u0627\u0644\u062C\u0646\u0627\u0626\u064A\u0629" }), _jsxs("p", { className: "text-slate-400 font-bold text-xs uppercase tracking-widest mt-1", children: ["\u0625\u062C\u0645\u0627\u0644\u064A \u0627\u0644\u0645\u0643\u062A\u0634\u0641\u0627\u062A: ", filtered.length] })] }), _jsx("div", { className: "flex gap-3", children: _jsx("button", { className: "p-3 bg-white border border-slate-200 rounded-xl text-slate-400 hover:text-indigo-600 shadow-sm transition-all", children: _jsx(ICONS.Rocket, {}) }) })] }), _jsx("div", { className: "flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4", children: filtered.length === 0 ? (_jsxs("div", { className: "h-full flex flex-col items-center justify-center text-slate-300 gap-4 opacity-40 grayscale", children: [_jsx("div", { className: "text-8xl", children: "\uD83C\uDFDB\uFE0F" }), _jsx("p", { className: "font-black text-xl", children: "\u0644\u0627 \u062A\u0648\u062C\u062F \u0623\u062F\u0644\u0629 \u0645\u0637\u0627\u0628\u0642\u0629 \u0644\u0644\u0645\u0648\u0627\u0635\u0641\u0627\u062A." })] })) : filtered.map(item => (_jsxs("button", { onClick: () => setSelectedId(item.evidence_id), className: `w-full bg-white p-6 rounded-[2.5rem] border-2 transition-all text-right flex items-center gap-6 group hover:shadow-xl ${selectedId === item.evidence_id ? 'border-indigo-600 ring-4 ring-indigo-50 shadow-2xl' : 'border-white shadow-sm'}`, children: [_jsx("div", { className: `w-16 h-16 rounded-[1.5rem] flex items-center justify-center text-3xl shadow-inner flex-shrink-0 ${item.severity === AlertSeverity.CRITICAL ? 'bg-red-50 text-red-600' : 'bg-indigo-50 text-indigo-600'}`, children: item.content_type === ContentType.IMAGE ? '🖼️' : '📝' }), _jsxs("div", { className: "flex-1 min-w-0 space-y-1", children: [_jsxs("div", { className: "flex justify-between items-center", children: [_jsxs("h4", { className: "font-black text-slate-800 text-lg truncate group-hover:text-indigo-600 transition-colors", children: ["@", item.suspectUsername] }), _jsxs("span", { className: "text-[9px] font-mono font-black text-slate-300", children: ["# ", item.evidence_id.split('-')[0]] })] }), _jsxs("p", { className: "text-sm font-bold text-slate-500 truncate leading-relaxed", children: ["\"", item.summary, "\""] }), _jsxs("div", { className: "flex items-center gap-4 pt-2", children: [_jsx("span", { className: "text-[10px] font-black px-3 py-1 bg-slate-100 rounded-lg text-slate-400", children: item.childName }), _jsx("span", { className: "text-[10px] font-black px-3 py-1 bg-indigo-50 rounded-lg text-indigo-400", children: item.platform }), item.classification === Classification.LEGAL_HOLD && _jsx("span", { className: "text-[10px] font-black px-3 py-1 bg-red-600 rounded-lg text-white animate-pulse", children: "\uD83D\uDD12 HOLD" })] })] }), _jsx(ICONS.Dashboard, { className: "w-5 h-5 text-slate-200 group-hover:text-indigo-600 transition-all" })] }, item.evidence_id))) })] }), _jsx("section", { className: "w-[480px] bg-white flex flex-col border-r border-slate-200 shadow-2xl z-30 animate-in slide-in-from-left duration-500 overflow-hidden", children: !selectedRecord ? (_jsxs("div", { className: "h-full flex flex-col items-center justify-center p-12 text-center space-y-6 opacity-30 grayscale", children: [_jsx("div", { className: "w-32 h-32 bg-slate-50 rounded-[3rem] flex items-center justify-center text-6xl shadow-inner", children: "\uD83D\uDC41\uFE0F" }), _jsxs("div", { className: "space-y-2", children: [_jsx("h3", { className: "text-2xl font-black text-slate-800", children: "\u0627\u062E\u062A\u0631 \u062F\u0644\u064A\u0644\u0627\u064B \u0644\u0644\u0645\u0631\u0627\u062C\u0639\u0629" }), _jsx("p", { className: "text-sm font-bold text-slate-500 leading-relaxed px-10", children: "\u0633\u064A\u062A\u0645 \u0639\u0631\u0636 \u0628\u064A\u0627\u0646\u0627\u062A \u0633\u0644\u0633\u0644\u0629 \u0627\u0644\u0639\u0647\u062F\u0629\u060C \u0627\u0644\u0645\u062D\u062A\u0648\u0649 \u0627\u0644\u062E\u0627\u0645\u060C \u0648\u0627\u0644\u062A\u062D\u0644\u064A\u0644 \u0627\u0644\u062C\u0646\u0627\u0626\u064A \u0647\u0646\u0627 \u0644\u062F\u0639\u0645 \u0627\u0644\u0645\u0642\u0627\u0636\u0627\u0629." })] })] })) : (_jsxs("div", { className: "flex flex-col h-full overflow-hidden", children: [_jsxs("header", { className: "p-8 border-b border-slate-100 bg-[#050510] text-white flex-shrink-0", children: [_jsxs("div", { className: "flex justify-between items-start mb-6", children: [_jsxs("div", { className: "flex items-center gap-4", children: [_jsx("div", { className: "w-12 h-12 bg-white/5 rounded-2xl flex items-center justify-center border border-white/10 shadow-inner", children: _jsx(AmanahShield, { className: "w-8 h-8" }) }), _jsxs("div", { children: [_jsx("h3", { className: "text-xl font-black tracking-tighter leading-none mb-1", children: "\u0645\u0644\u0641 \u0627\u0644\u062F\u0644\u064A\u0644 \u0627\u0644\u0633\u064A\u0627\u062F\u064A" }), _jsx("p", { className: "text-[8px] font-mono text-indigo-400 uppercase tracking-[0.3em]", children: "Status: Tamper_Verified" })] })] }), _jsx("button", { onClick: () => setSelectedId(null), className: "text-white/40 hover:text-white p-2 hover:bg-white/5 rounded-xl transition-all", children: _jsx(ICONS.Close, {}) })] }), _jsxs("div", { className: "bg-white/5 p-4 rounded-2xl border border-white/5 flex justify-between items-center", children: [_jsxs("div", { className: "text-right", children: [_jsx("p", { className: "text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1", children: "Integrity Hash (SHA-256)" }), _jsx("code", { className: "text-[10px] font-mono text-indigo-300 truncate w-64 block", children: selectedRecord.sha256 })] }), _jsx("span", { className: `px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest ${selectedRecord.severity === AlertSeverity.CRITICAL ? 'bg-red-600' : 'bg-amber-500'}`, children: selectedRecord.severity })] })] }), _jsxs("div", { className: "flex-1 overflow-y-auto custom-scrollbar p-8 space-y-12", children: [_jsxs("div", { className: "space-y-4", children: [_jsxs("h4", { className: "text-sm font-black text-slate-900 px-2 flex items-center gap-3", children: [_jsx("span", { className: "w-2 h-2 bg-indigo-600 rounded-full" }), "\u0645\u0639\u0627\u064A\u0646\u0629 \u0627\u0644\u0645\u062D\u062A\u0648\u0649 (Raw Feed)"] }), selectedRecord.content_type === ContentType.IMAGE && selectedRecord.imageData ? (_jsxs("div", { className: "relative rounded-[2.5rem] overflow-hidden border-4 border-slate-50 shadow-xl group", children: [_jsx("img", { src: selectedRecord.imageData, className: "w-full h-auto" }), _jsx("div", { className: "absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center", children: _jsx("button", { className: "bg-white text-slate-900 px-6 py-3 rounded-2xl font-black text-xs shadow-2xl", children: "\u0645\u0639\u0627\u064A\u0646\u0629 \u0643\u0627\u0645\u0644\u0629 \uD83D\uDD0D" }) })] })) : (_jsxs("div", { className: "bg-slate-50 p-8 rounded-[2.5rem] border border-slate-100 italic font-bold text-slate-700 leading-relaxed text-lg shadow-inner", children: ["\"", selectedRecord.content || selectedRecord.summary, "\""] }))] }), _jsxs("div", { className: "space-y-6", children: [_jsxs("h4", { className: "text-sm font-black text-slate-900 px-2 flex items-center gap-3", children: [_jsx("span", { className: "w-2 h-2 bg-emerald-500 rounded-full" }), "\u0633\u0644\u0633\u0644\u0629 \u0627\u0644\u0639\u0647\u062F\u0629 (Chain of Custody)"] }), _jsxs("div", { className: "space-y-6 relative pr-4", children: [_jsx("div", { className: "absolute top-0 bottom-0 right-4 w-px bg-slate-100" }), custodyLogs.length > 0 ? custodyLogs.map((log, idx) => (_jsxs("div", { className: "relative pr-10", children: [_jsx("div", { className: "absolute top-1 right-0 w-8 h-8 rounded-xl bg-white border-2 border-slate-100 flex items-center justify-center text-[10px] shadow-sm", children: log.action === 'create' ? '✨' : log.action === 'export' ? '📂' : '👁️' }), _jsxs("div", { className: "text-right", children: [_jsx("p", { className: "text-[10px] font-black text-slate-400 font-mono mb-1", children: new Date(log.created_at).toLocaleString() }), _jsx("p", { className: "text-xs font-black text-slate-700", children: log.action === 'create' ? 'إنشاء الدليل الأصلي' : log.action === 'export' ? 'تصدير نسخة جنائية' : 'مراجعة الدليل' }), _jsxs("p", { className: "text-[9px] text-indigo-500 font-bold mt-1 uppercase tracking-tighter", children: ["Actor: ", log.actorName] })] })] }, idx))) : (_jsx("div", { className: "pr-10 text-slate-400 text-xs font-bold animate-pulse", children: "\u062C\u0627\u0631\u064A \u062C\u0644\u0628 \u0633\u062C\u0644 \u0627\u0644\u0648\u0635\u0648\u0644 \u0645\u0646 \u0627\u0644\u0633\u062D\u0627\u0628\u0629..." }))] })] }), _jsxs("div", { className: "grid grid-cols-2 gap-4", children: [_jsx(MetaBox, { label: "\u0647\u0648\u064A\u0629 \u0627\u0644\u0637\u0641\u0644", val: selectedRecord.childName }), _jsx(MetaBox, { label: "\u0627\u0644\u0645\u0646\u0635\u0629", val: selectedRecord.platform }), _jsx(MetaBox, { label: "\u0648\u0642\u062A \u0627\u0644\u0631\u0635\u062F", val: new Date(selectedRecord.created_at).toLocaleTimeString() }), _jsx(MetaBox, { label: "\u0627\u0644\u062A\u0635\u0646\u064A\u0641", val: selectedRecord.classification })] })] }), _jsxs("div", { className: "p-8 bg-slate-50 border-t border-slate-200 flex gap-4 flex-shrink-0 pb-12", children: [_jsx("button", { onClick: handleToggleHold, disabled: !canPerform(currentUser.role, 'evidence.legal_hold'), className: `flex-1 h-16 rounded-[1.5rem] font-black text-xs shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 border-2 ${selectedRecord.classification === Classification.LEGAL_HOLD ? 'bg-red-600 border-red-600 text-white' : 'bg-white border-slate-200 text-slate-700 hover:bg-slate-100 disabled:opacity-30'}`, children: _jsx("span", { children: selectedRecord.classification === Classification.LEGAL_HOLD ? '🔓 فك الحجز' : '🔒 حجز قانوني' }) }), _jsx("button", { disabled: !canPerform(currentUser.role, 'evidence.export') || selectedRecord.classification === Classification.RESTRICTED, className: "flex-1 h-16 bg-indigo-600 text-white rounded-[1.5rem] font-black text-xs shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3 disabled:opacity-30", children: _jsx("span", { children: "\uD83D\uDCC2 \u062A\u0635\u062F\u064A\u0631 (Export)" }) }), _jsx("button", { onClick: handleDelete, disabled: !canPerform(currentUser.role, 'evidence.delete') || selectedRecord.classification === Classification.LEGAL_HOLD, className: "w-16 h-16 bg-white text-red-600 border-2 border-red-50 rounded-[1.5rem] flex items-center justify-center text-xl hover:bg-red-600 hover:text-white transition-all shadow-sm disabled:opacity-30", children: _jsx(ICONS.Trash, {}) })] })] })) })] }));
};
const FilterSection = ({ label, children }) => (_jsxs("div", { className: "space-y-3", children: [_jsx("label", { className: "text-[10px] font-black text-slate-400 uppercase tracking-widest px-2", children: label }), children] }));
const MetaBox = ({ label, val }) => (_jsxs("div", { className: "p-4 bg-slate-50 border border-slate-100 rounded-2xl", children: [_jsx("p", { className: "text-[9px] font-black text-slate-400 uppercase mb-1", children: label }), _jsx("p", { className: "text-xs font-black text-slate-800 truncate", children: val })] }));
export default EvidenceVaultView;
