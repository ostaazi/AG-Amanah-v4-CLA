rules_version = '2';

/**
 * Amanah Parental Control - Firestore Security Rules
 * Phase 3.1: Security Hardening
 * ===================================================
 *
 * Security Model:
 * - Deny-by-default policy
 * - Role-Based Access Control (RBAC): Parent, Child, Supervisor
 * - Tenant isolation: parents can only access their own data
 * - Immutable audit logs
 * - Input validation via regex rules
 */

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper Functions
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the user is the parent owner implies parentId == auth.uid
    function isParent(parentId) {
      return isAuthenticated() && request.auth.uid == parentId;
    }

    // Check if the user is the child owner of the document
    function isChild(childId) {
      return isAuthenticated() && request.auth.uid == childId;
    }

    // Check if the user is a supervisor for the given parent
    function isSupervisor(parentId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/supervisors/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/supervisors/$(request.auth.uid)).data.parentId == parentId;
    }

    function canManageFamily(parentId) {
      return isParent(parentId) || isSupervisor(parentId);
    }

    // Validation Helpers
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }

    function isValidId(id) {
      return id.matches('^[a-zA-Z0-9_-]{1,128}$');
    }

    /**
     * Parents Collection
     * - Parents: Full control over their profile
     * - Anonymous devices: Read ONLY for pairing (looking up parentId via pairingKey)
     */
    match /parents/{parentId} {
      // الوالد له صلاحية كاملة
      allow read: if isParent(parentId);
      allow update: if isParent(parentId);
      allow create: if isAuthenticated() && request.auth.uid == parentId;
      allow delete: if false;

      // Phase 4.8.2: Secure Pairing Approval sub-collection
      match /pairingRequests/{requestId} {
        // Create: Child device (anonymous) can create a request
        allow create: if isAuthenticated() && 
          request.resource.data.parentId == parentId &&
          request.resource.data.status == 'PENDING';
        
        // Read: Parent OR the Child device that created the request (poll for status)
        allow read: if isParent(parentId) || 
          (isAuthenticated() && request.auth.uid == requestId);
        
        // Update: Parent (APROVE/REJECT)
        allow update: if isParent(parentId);
        
        // Delete: Parent only
        allow delete: if isParent(parentId);
      }
    }

    // Phase 4.8.2: Robust Pairing lookup via Key document
    match /pairingKeys/{key} {
      // DEBUG: Allowing public read temporarily to isolate Auth issues
      allow get: if true;
    }

    /**
     * Children Collection
     * - Parents/Supervisors: Read/Update
     * - Child: Read ONLY their own config, Create for initial pairing
     */
    match /children/{childId} {
      // Read: Parent, Supervisor, or the Child themselves
      allow read: if canManageFamily(resource.data.parentId) || isChild(childId);

      // Create: Parent or Anonymous child during pairing
      allow create: if (isParent(request.resource.data.parentId) || isAuthenticated()) && isValidId(childId);

      // Update: Parent or Supervisor
      allow update: if canManageFamily(resource.data.parentId);

      // Delete: Parent only
      allow delete: if isParent(resource.data.parentId);
    }

    /**
     * Supervisors Collection
     */
    match /supervisors/{supervisorId} {
      allow read: if isParent(resource.data.parentId) || request.auth.uid == supervisorId;
      allow create: if isParent(request.resource.data.parentId);
      allow update: if isParent(resource.data.parentId) || request.auth.uid == supervisorId;
      allow delete: if isParent(resource.data.parentId);
    }

    /**
     * Alerts Collection
     * - Parents/Supervisors: Read, Resolve
     * - Children: Create (reporting issues)
     */
    match /alerts/{alertId} {
      // Read: Parent or Supervisor
      allow read: if canManageFamily(resource.data.parentId);

      // Create: Allowed for authenticated users (Child reporting or System)
      // Must include parentId to associate with family
      allow create: if isAuthenticated() &&
        request.resource.data.keys().hasAll(['parentId', 'status']) &&
        request.resource.data.status == 'NEW';

      // Update: Parent/Supervisor can resolve/dismiss
      allow update: if canManageFamily(resource.data.parentId);

      // Delete: Parent only
      allow delete: if isParent(resource.data.parentId);
    }

    /**
     * Activities Collection (Audit Logs)
     * - Parents/Supervisors: Read
     * - Children: Create (logging usage)
     */
    match /activities/{activityId} {
      allow read: if canManageFamily(resource.data.parentId);

      // Create: Allowed for logging
      allow create: if isAuthenticated() && request.resource.data.keys().hasAll(['parentId', 'type']);

      // Immutable
      allow update, delete: if false;
    }

    /**
     * 2FA Secrets
     */
    match /twoFactorSecrets/{parentId} {
      allow read, write: if isParent(parentId);
    }

    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
