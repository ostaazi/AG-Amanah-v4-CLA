import React, { useEffect, useMemo, useState } from 'react';
import { Child } from '../../types';
import {
  DeviceVulnerabilityFindingRecord,
  VulnerabilityHistoryEntry,
  ParentVulnerabilityFinding,
  ParentVulnerabilityScanSnapshot,
  deriveUndoCommandForChildAction,
  logChildVulnerabilityHistoryEvent,
  logParentVulnerabilityHistoryEvent,
  runParentDeviceVulnerabilityScan,
  subscribeToChildVulnerabilityHistory,
  subscribeToChildVulnerabilityFindings,
  subscribeToParentVulnerabilityHistory,
  subscribeToParentVulnerabilityFindings,
} from '../../services/vulnerabilityIntelService';
import {
  isParentAndroidSecurityBridgeAvailable,
  openParentSecuritySetting,
  type ParentSecuritySettingTarget,
} from '../../services/parentAndroidSecurityService';
import { formatDateTimeDefault } from '../../services/dateTimeFormat';

interface VulnerabilityCenterViewProps {
  lang: 'ar' | 'en';
  parentId: string;
  children: Child[];
  onSendCommand: (childId: string, command: string, payload?: any) => Promise<void>;
  onRequireStepUp?: (
    reason: 'LOCKDOWN' | 'DELETE_EVIDENCE' | 'EXPORT_EVIDENCE' | 'SENSITIVE_SETTINGS',
    action: () => void | Promise<void>
  ) => Promise<void>;
}

type VulnerabilityFinding = ParentVulnerabilityFinding &
  Record<string, any> & {
    autoCommand?: {
      command?: string;
      payload?: any;
    };
  };

const severityClass = (severity: string): string => {
  switch (String(severity || '').toUpperCase()) {
    case 'CRITICAL':
      return 'bg-rose-50 text-rose-700 border-rose-200';
    case 'HIGH':
      return 'bg-amber-50 text-amber-700 border-amber-200';
    case 'MEDIUM':
      return 'bg-cyan-50 text-cyan-700 border-cyan-200';
    default:
      return 'bg-slate-50 text-slate-600 border-slate-200';
  }
};

const UNDO_WINDOW_MS = 24 * 60 * 60 * 1000;

type UndoBlockReason =
  | 'NOT_REMEDIATION'
  | 'NOT_SUCCESS'
  | 'NOT_UNDOABLE'
  | 'OWNER_MISMATCH'
  | 'ALREADY_USED'
  | 'EXPIRED';

const VulnerabilityCenterView: React.FC<VulnerabilityCenterViewProps> = ({
  lang,
  parentId,
  children,
  onSendCommand,
  onRequireStepUp,
}) => {
  const [selectedChildId, setSelectedChildId] = useState(children[0]?.id || '');
  const [childRows, setChildRows] = useState<DeviceVulnerabilityFindingRecord[]>([]);
  const [parentSnapshot, setParentSnapshot] = useState<ParentVulnerabilityScanSnapshot | null>(null);
  const [parentHistory, setParentHistory] = useState<VulnerabilityHistoryEntry[]>([]);
  const [childHistory, setChildHistory] = useState<VulnerabilityHistoryEntry[]>([]);
  const [runningParentScan, setRunningParentScan] = useState(false);
  const [runningChildScan, setRunningChildScan] = useState(false);
  const [actionBusyId, setActionBusyId] = useState('');
  const [parentActionBusyId, setParentActionBusyId] = useState('');
  const [undoBusyId, setUndoBusyId] = useState('');
  const [actionError, setActionError] = useState('');
  const [actionOk, setActionOk] = useState('');

  useEffect(() => {
    if (!selectedChildId && children[0]?.id) {
      setSelectedChildId(children[0].id);
    }
  }, [children, selectedChildId]);

  useEffect(() => {
    if (!parentId) return () => {};
    const unsubChild = subscribeToChildVulnerabilityFindings(parentId, setChildRows);
    const unsubParent = subscribeToParentVulnerabilityFindings(parentId, setParentSnapshot);
    return () => {
      unsubChild();
      unsubParent();
    };
  }, [parentId]);

  useEffect(() => {
    if (!parentId) return () => {};
    return subscribeToParentVulnerabilityHistory(parentId, setParentHistory, 30);
  }, [parentId]);

  useEffect(() => {
    const childId = selectedChildId || children[0]?.id;
    if (!childId) {
      setChildHistory([]);
      return () => {};
    }
    return subscribeToChildVulnerabilityHistory(childId, setChildHistory, 40);
  }, [parentId, selectedChildId, children]);

  const t = useMemo(
    () =>
      lang === 'ar'
        ? {
            title: 'مركز الثغرات المتقدم',
            subtitle:
              'مراقبة والاستجابة لتهديدات zero-click و zero-day على جهاز الطفل وجهاز الوالد.',
            runParent: 'فحص جهاز الوالد',
            runChild: 'فحص جهاز الطفل',
            parentRisk: 'مخاطر جهاز الوالد',
            childRisk: 'مخاطر جهاز الطفل',
            noChildData: 'لا توجد نتائج فحص لجهاز الطفل حتى الآن.',
            noParentData: 'لا توجد نتائج فحص لجهاز الوالد حتى الآن.',
            findings: 'نتائج الفحص',
            watchlist: 'قائمة المراقبة النشطة',
            guidance: 'إرشادات الإصلاح',
            bilingualExplain: 'تفسير عربي + English',
            autoFix: 'تنفيذ إصلاح آلي',
            openSetting: 'فتح إعداد الإصلاح',
            childSelector: 'اختر جهاز الطفل',
            score: 'درجة المخاطر',
            lastScan: 'آخر فحص',
            parentDevice: 'ملخص جهاز الوالد',
            nativeBridge: 'فحص نظام أندرويد (Native)',
            active: 'نشط',
            inactive: 'غير نشط',
            deviceOwner: 'Device Owner',
            history: 'السجل الزمني',
            parentHistory: 'سجل جهاز الوالد',
            childHistory: 'سجل جهاز الطفل',
            noHistory: 'لا يوجد سجل بعد.',
            undo: 'تراجع (Undo)',
            scanEvent: 'فحص',
            remediationEvent: 'إصلاح',
            undoEvent: 'تراجع',
            runBusy: 'جارٍ التنفيذ...',
            actionOk: 'تم تنفيذ الإجراء.',
            unknown: 'غير متاح',
            undoExpired: 'انتهت صلاحية التراجع لهذه العملية.',
            undoAlreadyUsed: 'تم تنفيذ التراجع مسبقاً لهذه العملية.',
            undoOwnerMismatch: 'لا يمكن التراجع عن عملية لا تخص حسابك.',
            undoUnavailable: 'هذه العملية غير قابلة للتراجع.',
            undoExpiresAt: 'ينتهي التراجع في',
          }
        : {
            title: 'Advanced Vulnerability Center',
            subtitle: 'Monitor and respond to zero-click and zero-day exposures across parent and child devices.',
            runParent: 'Scan Parent Surface',
            runChild: 'Scan Child Device',
            parentRisk: 'Parent Risk',
            childRisk: 'Child Risk',
            noChildData: 'No child vulnerability scan data yet.',
            noParentData: 'No parent vulnerability scan data yet.',
            findings: 'Findings',
            watchlist: 'Active Watchlist',
            guidance: 'Remediation Guidance',
            bilingualExplain: 'Arabic + English Explanation',
            autoFix: 'Run Auto Fix',
            openSetting: 'Open Fix Setting',
            childSelector: 'Select child device',
            score: 'Risk score',
            lastScan: 'Last scan',
            parentDevice: 'Parent Device Summary',
            nativeBridge: 'Android Native System Scan',
            active: 'Active',
            inactive: 'Inactive',
            deviceOwner: 'Device Owner',
            history: 'Timeline History',
            parentHistory: 'Parent Device History',
            childHistory: 'Child Device History',
            noHistory: 'No history yet.',
            undo: 'Undo',
            scanEvent: 'Scan',
            remediationEvent: 'Remediation',
            undoEvent: 'Undo',
            runBusy: 'Running...',
            actionOk: 'Action executed successfully.',
            unknown: 'N/A',
            undoExpired: 'Undo window expired for this action.',
            undoAlreadyUsed: 'Undo was already used for this action.',
            undoOwnerMismatch: 'Cannot undo an action that is not owned by this account.',
            undoUnavailable: 'This action is not eligible for undo.',
            undoExpiresAt: 'Undo expires at',
          },
    [lang]
  );

  const selectedChildRow = useMemo(() => {
    if (selectedChildId) {
      const matched = childRows.find((row) => row.childId === selectedChildId);
      if (matched) return matched;
    }
    return childRows[0];
  }, [childRows, selectedChildId]);

  const selectedChildFindings = useMemo<VulnerabilityFinding[]>(() => {
    if (!selectedChildRow?.findings) return [];
    return selectedChildRow.findings as VulnerabilityFinding[];
  }, [selectedChildRow]);

  const safeLogParentHistory = async (
    event: Parameters<typeof logParentVulnerabilityHistoryEvent>[1]
  ) => {
    try {
      await logParentVulnerabilityHistoryEvent(parentId, event);
    } catch (error) {
      console.warn('[vulnerability-center] parent history log failed:', error);
    }
  };

  const safeLogChildHistory = async (
    childId: string,
    event: Parameters<typeof logChildVulnerabilityHistoryEvent>[2]
  ) => {
    try {
      await logChildVulnerabilityHistoryEvent(parentId, childId, event);
    } catch (error) {
      console.warn('[vulnerability-center] child history log failed:', error);
    }
  };

  const runParentScan = async () => {
    if (!parentId) return;
    const ts = Date.now();
    setRunningParentScan(true);
    setActionError('');
    setActionOk('');
    try {
      await runParentDeviceVulnerabilityScan(parentId);
      setActionOk(t.actionOk);
    } catch (error: any) {
      await safeLogParentHistory({
        eventType: 'SCAN',
        actionKind: 'SCAN',
        status: 'FAILED',
        scanTimestampMs: ts,
        summaryEn: 'Parent security scan failed.',
        summaryAr: 'فشل فحص أمان جهاز الوالد.',
        actor: 'PARENT_APP',
        metadata: { error: String(error?.message || '') },
      });
      setActionError(String(error?.message || (lang === 'ar' ? 'فشل فحص الوالد' : 'Parent scan failed')));
    } finally {
      setRunningParentScan(false);
    }
  };

  const runChildScan = async () => {
    if (!selectedChildRow?.childId) return;
    const childId = selectedChildRow.childId;
    const childName = selectedChildRow.childName || children.find((item) => item.id === childId)?.name || '';
    const ts = Date.now();
    setRunningChildScan(true);
    setActionError('');
    setActionOk('');
    try {
      const payload = {
        enabled: true,
        deep: true,
        includeParentSurface: true,
        source: 'vulnerability_center_manual',
      };
      await onSendCommand(childId, 'runVulnerabilityScan', payload);
      await safeLogChildHistory(childId, {
        childName,
        eventType: 'SCAN',
        actionKind: 'COMMAND',
        status: 'INFO',
        scanTimestampMs: ts,
        summaryEn: 'Child vulnerability scan requested by parent.',
        summaryAr: 'تم طلب فحص ثغرات جهاز الطفل بواسطة الوالد.',
        command: 'runVulnerabilityScan',
        payload,
        actor: 'PARENT_APP',
      });
      setActionOk(t.actionOk);
    } catch (error: any) {
      await safeLogChildHistory(childId, {
        childName,
        eventType: 'SCAN',
        actionKind: 'COMMAND',
        status: 'FAILED',
        scanTimestampMs: ts,
        summaryEn: 'Child vulnerability scan request failed.',
        summaryAr: 'فشل طلب فحص ثغرات جهاز الطفل.',
        command: 'runVulnerabilityScan',
        actor: 'PARENT_APP',
        metadata: { error: String(error?.message || '') },
      });
      setActionError(String(error?.message || (lang === 'ar' ? 'فشل فحص الطفل' : 'Child scan failed')));
    } finally {
      setRunningChildScan(false);
    }
  };

  const runAutoFix = async (finding: VulnerabilityFinding) => {
    const command = finding?.autoCommand?.command;
    if (!command || !selectedChildRow?.childId) return;
    const childId = selectedChildRow.childId;
    const childName = selectedChildRow.childName || children.find((item) => item.id === childId)?.name || '';
    const payload = finding?.autoCommand?.payload ?? true;
    const undo = deriveUndoCommandForChildAction(command, payload);
    const ts = Date.now();

    setActionBusyId(finding.id);
    setActionError('');
    setActionOk('');
    try {
      await onSendCommand(childId, command, payload);
      await safeLogChildHistory(childId, {
        childName,
        eventType: 'REMEDIATION',
        actionKind: 'COMMAND',
        status: 'SUCCESS',
        scanTimestampMs: ts,
        severity: String(finding.severity || ''),
        findingId: String(finding.id || ''),
        titleEn: finding.titleEn || '',
        titleAr: finding.titleAr || '',
        summaryEn: `Applied remediation command "${command}".`,
        summaryAr: `تم تنفيذ أمر الإصلاح "${command}".`,
        command,
        payload,
        undoCommand: undo?.command,
        undoPayload: undo?.payload,
        actor: 'PARENT_APP',
        metadata: undo ? { undoExpiresAtMs: ts + UNDO_WINDOW_MS } : undefined,
      });
      setActionOk(t.actionOk);
    } catch (error: any) {
      await safeLogChildHistory(childId, {
        childName,
        eventType: 'REMEDIATION',
        actionKind: 'COMMAND',
        status: 'FAILED',
        scanTimestampMs: ts,
        severity: String(finding.severity || ''),
        findingId: String(finding.id || ''),
        titleEn: finding.titleEn || '',
        titleAr: finding.titleAr || '',
        summaryEn: `Remediation command "${command}" failed.`,
        summaryAr: `فشل تنفيذ أمر الإصلاح "${command}".`,
        command,
        payload,
        actor: 'PARENT_APP',
        metadata: { error: String(error?.message || '') },
      });
      setActionError(String(error?.message || (lang === 'ar' ? 'فشل تنفيذ الإصلاح' : 'Auto-fix failed')));
    } finally {
      setActionBusyId('');
    }
  };

  const toSettingTarget = (value?: string): ParentSecuritySettingTarget | null => {
    if (!value) return null;
    const normalized = value.trim().toLowerCase();
    const supported: ParentSecuritySettingTarget[] = [
      'system_update',
      'developer_options',
      'security',
      'device_lock',
      'unknown_sources',
      'accessibility',
    ];
    return supported.includes(normalized as ParentSecuritySettingTarget)
      ? (normalized as ParentSecuritySettingTarget)
      : null;
  };

  const runParentAutoAction = async (finding: ParentVulnerabilityFinding) => {
    if (finding.autoAction?.type !== 'OPEN_SETTING') return;
    const target = toSettingTarget(finding.autoAction.target);
    if (!target) return;
    const ts = Date.now();

    setParentActionBusyId(finding.id);
    setActionError('');
    setActionOk('');
    try {
      const opened = await openParentSecuritySetting(target);
      if (!opened) {
        throw new Error(
          lang === 'ar' ? 'تعذر فتح الإعداد على هذا الجهاز' : 'Unable to open setting on this device'
        );
      }
      await safeLogParentHistory({
        eventType: 'REMEDIATION',
        actionKind: 'OPEN_SETTING',
        status: 'SUCCESS',
        scanTimestampMs: ts,
        findingId: finding.id,
        severity: finding.severity,
        titleEn: finding.titleEn,
        titleAr: finding.titleAr,
        summaryEn: `Opened parent security setting (${target}).`,
        summaryAr: `تم فتح إعداد أمان جهاز الوالد (${target}).`,
        actor: 'PARENT_APP',
        metadata: { settingTarget: target },
      });
      setActionOk(t.actionOk);
    } catch (error: any) {
      await safeLogParentHistory({
        eventType: 'REMEDIATION',
        actionKind: 'OPEN_SETTING',
        status: 'FAILED',
        scanTimestampMs: ts,
        findingId: finding.id,
        severity: finding.severity,
        titleEn: finding.titleEn,
        titleAr: finding.titleAr,
        summaryEn: `Failed to open parent security setting (${target}).`,
        summaryAr: `فشل فتح إعداد أمان جهاز الوالد (${target}).`,
        actor: 'PARENT_APP',
        metadata: { settingTarget: target, error: String(error?.message || '') },
      });
      setActionError(String(error?.message || (lang === 'ar' ? 'فشل تنفيذ الإجراء' : 'Action failed')));
    } finally {
      setParentActionBusyId('');
    }
  };

  const historyEventLabel = (eventType: VulnerabilityHistoryEntry['eventType']) => {
    if (eventType === 'UNDO') return t.undoEvent;
    if (eventType === 'REMEDIATION') return t.remediationEvent;
    return t.scanEvent;
  };

  const historySummary = (entry: VulnerabilityHistoryEntry) => {
    if (lang === 'ar') return entry.summaryAr || entry.titleAr || entry.summaryEn || entry.titleEn || '-';
    return entry.summaryEn || entry.titleEn || entry.summaryAr || entry.titleAr || '-';
  };

  const getUndoExpiryMs = (entry: VulnerabilityHistoryEntry): number => {
    const metadata = entry.metadata && typeof entry.metadata === 'object' ? entry.metadata : undefined;
    const explicitExpiry = Number((metadata as any)?.undoExpiresAtMs);
    if (Number.isFinite(explicitExpiry) && explicitExpiry > 0) {
      return explicitExpiry;
    }
    return entry.scanTimestampMs + UNDO_WINDOW_MS;
  };

  const usedUndoForHistoryIds = useMemo(() => {
    const ids = new Set<string>();
    childHistory.forEach((entry) => {
      if (entry.eventType !== 'UNDO' || entry.status !== 'SUCCESS') return;
      const undoOf = String((entry.metadata as any)?.undoOfHistoryId || '').trim();
      if (undoOf) ids.add(undoOf);
    });
    return ids;
  }, [childHistory]);

  const getUndoBlockReason = (entry: VulnerabilityHistoryEntry): UndoBlockReason | null => {
    if (entry.eventType !== 'REMEDIATION') return 'NOT_REMEDIATION';
    if (entry.status !== 'SUCCESS') return 'NOT_SUCCESS';
    if (!entry.undoAvailable || !entry.undoCommand) return 'NOT_UNDOABLE';
    if (entry.parentId && entry.parentId !== parentId) return 'OWNER_MISMATCH';
    if (usedUndoForHistoryIds.has(entry.id)) return 'ALREADY_USED';
    if (Date.now() > getUndoExpiryMs(entry)) return 'EXPIRED';
    return null;
  };

  const undoBlockReasonLabel = (reason: UndoBlockReason): string => {
    if (reason === 'EXPIRED') return t.undoExpired;
    if (reason === 'ALREADY_USED') return t.undoAlreadyUsed;
    if (reason === 'OWNER_MISMATCH') return t.undoOwnerMismatch;
    return t.undoUnavailable;
  };

  const runUndoAction = async (entry: VulnerabilityHistoryEntry) => {
    const blockReason = getUndoBlockReason(entry);
    if (blockReason) {
      const childId = entry.childId || selectedChildRow?.childId;
      if (childId) {
        await safeLogChildHistory(childId, {
          childName: entry.childName,
          eventType: 'UNDO',
          actionKind: 'COMMAND',
          status: 'FAILED',
          scanTimestampMs: Date.now(),
          findingId: entry.findingId,
          severity: entry.severity,
          titleEn: entry.titleEn,
          titleAr: entry.titleAr,
          summaryEn: `Undo blocked: ${blockReason}.`,
          summaryAr: `تم منع التراجع: ${blockReason}.`,
          command: entry.undoCommand,
          payload: entry.undoPayload ?? true,
          actor: 'PARENT_APP',
          metadata: { undoOfHistoryId: entry.id, blockedReason: blockReason },
        });
      }
      setActionError(undoBlockReasonLabel(blockReason));
      return;
    }

    const childId = entry.childId || selectedChildRow?.childId;
    if (!childId) return;

    setUndoBusyId(entry.id);
    setActionError('');
    setActionOk('');
    const ts = Date.now();
    try {
      await onSendCommand(childId, entry.undoCommand, entry.undoPayload ?? true);
      await safeLogChildHistory(childId, {
        childName: entry.childName,
        eventType: 'UNDO',
        actionKind: 'COMMAND',
        status: 'SUCCESS',
        scanTimestampMs: ts,
        findingId: entry.findingId,
        severity: entry.severity,
        titleEn: entry.titleEn,
        titleAr: entry.titleAr,
        summaryEn: `Undo executed for "${entry.command || 'action'}".`,
        summaryAr: `تم تنفيذ التراجع عن "${entry.command || 'action'}".`,
        command: entry.undoCommand,
        payload: entry.undoPayload ?? true,
        actor: 'PARENT_APP',
        metadata: {
          undoOfHistoryId: entry.id,
          undoWindowMs: UNDO_WINDOW_MS,
          originalUndoExpiresAtMs: getUndoExpiryMs(entry),
        },
      });
      setActionOk(t.actionOk);
    } catch (error: any) {
      await safeLogChildHistory(childId, {
        childName: entry.childName,
        eventType: 'UNDO',
        actionKind: 'COMMAND',
        status: 'FAILED',
        scanTimestampMs: ts,
        findingId: entry.findingId,
        severity: entry.severity,
        titleEn: entry.titleEn,
        titleAr: entry.titleAr,
        summaryEn: `Undo failed for "${entry.command || 'action'}".`,
        summaryAr: `فشل التراجع عن "${entry.command || 'action'}".`,
        command: entry.undoCommand,
        payload: entry.undoPayload ?? true,
        actor: 'PARENT_APP',
        metadata: {
          undoOfHistoryId: entry.id,
          undoWindowMs: UNDO_WINDOW_MS,
          originalUndoExpiresAtMs: getUndoExpiryMs(entry),
          error: String(error?.message || ''),
        },
      });
      setActionError(
        String(error?.message || (lang === 'ar' ? 'فشل تنفيذ التراجع' : 'Undo action failed'))
      );
    } finally {
      setUndoBusyId('');
    }
  };

  const runUndoWithStepUp = async (entry: VulnerabilityHistoryEntry) => {
    const blockReason = getUndoBlockReason(entry);
    if (blockReason) {
      setActionError(undoBlockReasonLabel(blockReason));
      return;
    }
    const action = () => runUndoAction(entry);
    if (onRequireStepUp) {
      await onRequireStepUp('SENSITIVE_SETTINGS', action);
      return;
    }
    await action();
  };

  return (
    <div className="rounded-[2rem] bg-white border border-slate-100 p-5 shadow-sm space-y-4" dir={lang === 'ar' ? 'rtl' : 'ltr'}>
      <div className="rounded-2xl bg-slate-900 text-white p-6 border-b-8 border-rose-700">
        <h4 className="text-2xl font-black">{t.title}</h4>
        <p className="text-xs font-bold text-slate-200 mt-2">{t.subtitle}</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div className="rounded-xl border border-slate-100 bg-slate-50 p-4">
          <p className="text-[11px] font-black text-slate-500">{t.parentRisk}</p>
          <p className="text-3xl font-black text-rose-700 mt-2">{parentSnapshot?.riskScore ?? 0}</p>
            <p className="text-[11px] font-bold text-slate-500 mt-2">
              {t.lastScan}:{' '}
              {parentSnapshot?.scannedAt
                ? formatDateTimeDefault(parentSnapshot.scannedAt, { includeSeconds: true })
                : t.unknown}
            </p>
          <button
            onClick={() => void runParentScan()}
            disabled={runningParentScan}
            className="mt-3 w-full py-2 rounded-lg bg-rose-700 text-white text-sm font-black disabled:opacity-50"
          >
            {runningParentScan ? t.runBusy : t.runParent}
          </button>
          <div className="mt-3 rounded-lg border border-slate-200 bg-white px-3 py-2 text-[11px] font-black text-slate-700">
            {t.nativeBridge}:{' '}
            {isParentAndroidSecurityBridgeAvailable() || parentSnapshot?.nativeScanAvailable
              ? t.active
              : t.inactive}
          </div>
        </div>

        <div className="rounded-xl border border-slate-100 bg-slate-50 p-4">
          <p className="text-[11px] font-black text-slate-500">{t.childRisk}</p>
          <p className="text-3xl font-black text-amber-700 mt-2">{selectedChildRow?.riskScore ?? 0}</p>
            <p className="text-[11px] font-bold text-slate-500 mt-2">
              {t.lastScan}:{' '}
              {selectedChildRow?.scanTimestamp
                ? formatDateTimeDefault(selectedChildRow.scanTimestamp, { includeSeconds: true })
                : t.unknown}
            </p>
          <button
            onClick={() => void runChildScan()}
            disabled={runningChildScan || !selectedChildRow?.childId}
            className="mt-3 w-full py-2 rounded-lg bg-amber-700 text-white text-sm font-black disabled:opacity-50"
          >
            {runningChildScan ? t.runBusy : t.runChild}
          </button>
        </div>
      </div>

      <div className="rounded-xl border border-slate-100 bg-slate-50 p-3">
        <p className="text-[11px] font-black text-slate-500 mb-2">{t.childSelector}</p>
        <select
          value={selectedChildId}
          onChange={(event) => setSelectedChildId(event.target.value)}
          className="w-full px-3 py-2 rounded-lg border border-slate-200 bg-white text-sm font-black"
        >
          {children.map((child) => (
            <option key={child.id} value={child.id}>
              {child.name}
            </option>
          ))}
        </select>
      </div>

      {actionError && (
        <div className="rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-[12px] font-black text-rose-700">
          {actionError}
        </div>
      )}
      {actionOk && (
        <div className="rounded-xl border border-emerald-200 bg-emerald-50 px-3 py-2 text-[12px] font-black text-emerald-700">
          {actionOk}
        </div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div className="rounded-xl border border-slate-100 bg-white p-4">
          <p className="text-[11px] font-black text-slate-500">{t.findings}</p>
          {!selectedChildRow ? (
            <p className="text-sm font-bold text-slate-500 mt-3">{t.noChildData}</p>
          ) : selectedChildFindings.length === 0 ? (
            <p className="text-sm font-bold text-slate-500 mt-3">{t.noChildData}</p>
          ) : (
            <div className="space-y-2 mt-3">
              {selectedChildFindings.map((finding) => {
                const severity = String(finding.severity || 'LOW');
                const autoSupported = typeof finding?.autoCommand?.command === 'string' && finding.autoCommand.command.length > 0;
                return (
                  <div key={String(finding.id)} className="rounded-xl border border-slate-100 bg-slate-50 p-3">
                    <div className="flex items-start justify-between gap-2">
                      <div>
                        <p className="text-sm font-black text-slate-900">
                          {lang === 'ar' ? finding.titleAr : finding.titleEn}
                        </p>
                        <p className="text-[11px] font-black text-slate-500 mt-1">{String(finding.id || '')}</p>
                      </div>
                      <span className={`px-2 py-1 rounded-lg border text-[11px] font-black ${severityClass(severity)}`}>
                        {severity}
                      </span>
                    </div>

                    <div className="mt-2 rounded-lg border border-slate-200 bg-white p-2">
                      <p className="text-[10px] font-black text-slate-400">{t.bilingualExplain}</p>
                      <p className="text-[12px] font-bold text-slate-700 mt-1">{finding.detailAr || ''}</p>
                      <p className="text-[12px] font-bold text-slate-700 mt-1">{finding.detailEn || ''}</p>
                    </div>

                    <div className="mt-2 rounded-lg border border-slate-200 bg-white p-2">
                      <p className="text-[10px] font-black text-slate-400">{t.guidance}</p>
                      <p className="text-[12px] font-bold text-slate-700 mt-1">{finding.guidanceAr || ''}</p>
                      <p className="text-[12px] font-bold text-slate-700 mt-1">{finding.guidanceEn || ''}</p>
                    </div>

                    {autoSupported && (
                      <button
                        onClick={() => void runAutoFix(finding)}
                        disabled={actionBusyId === finding.id}
                        className="mt-2 w-full py-2 rounded-lg bg-indigo-600 text-white text-xs font-black disabled:opacity-50"
                      >
                        {actionBusyId === finding.id ? t.runBusy : t.autoFix}
                      </button>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>

        <div className="rounded-xl border border-slate-100 bg-white p-4">
          <p className="text-[11px] font-black text-slate-500">{t.parentDevice}</p>
          <div className="grid grid-cols-2 gap-2 mt-2 text-[11px] font-bold text-slate-700">
            <div>API: {parentSnapshot?.deviceSummary?.apiLevel ?? t.unknown}</div>
            <div>{parentSnapshot?.deviceSummary?.osVersion ?? t.unknown}</div>
            <div>{parentSnapshot?.deviceSummary?.securityPatchLevel || t.unknown}</div>
            <div>{parentSnapshot?.deviceSummary?.deviceModel || t.unknown}</div>
            <div>
              {t.deviceOwner}:{' '}
              {typeof parentSnapshot?.deviceSummary?.isDeviceOwner === 'boolean'
                ? parentSnapshot.deviceSummary.isDeviceOwner
                  ? 'Yes'
                  : 'No'
                : t.unknown}
            </div>
          </div>

          <p className="text-[11px] font-black text-slate-500">{t.watchlist}</p>
          {!parentSnapshot ? (
            <p className="text-sm font-bold text-slate-500 mt-3">{t.noParentData}</p>
          ) : (
            <div className="space-y-2 mt-3">
              {(parentSnapshot.watchlist || []).length > 0 ? (
                (parentSnapshot.watchlist || []).map((item) => (
                  <div key={item.advisoryId} className="rounded-xl border border-slate-100 bg-slate-50 p-3">
                    <p className="text-sm font-black text-slate-900">{item.advisoryId}</p>
                    <p className="text-[11px] font-bold text-slate-600 mt-1">{item.title}</p>
                    <p className="text-[10px] font-black text-slate-500 mt-2">
                      {item.platform} | {item.riskType}
                    </p>
                  </div>
                ))
              ) : (
                <p className="text-sm font-bold text-slate-500">{t.noParentData}</p>
              )}
            </div>
          )}

          {parentSnapshot?.findings && parentSnapshot.findings.length > 0 && (
            <>
              <p className="text-[11px] font-black text-slate-500 mt-4">{t.findings}</p>
              <div className="space-y-2 mt-2">
                {parentSnapshot.findings.map((finding) => (
                  <div key={finding.id} className="rounded-xl border border-slate-100 bg-slate-50 p-3">
                    <div className="flex items-start justify-between gap-2">
                      <p className="text-sm font-black text-slate-900">
                        {lang === 'ar' ? finding.titleAr : finding.titleEn}
                      </p>
                      <span
                        className={`px-2 py-1 rounded-lg border text-[11px] font-black ${severityClass(finding.severity)}`}
                      >
                        {finding.severity}
                      </span>
                    </div>
                    <p className="text-[12px] font-bold text-slate-700 mt-2">
                      {lang === 'ar' ? finding.detailAr : finding.detailEn}
                    </p>
                    <p className="text-[11px] font-black text-slate-500 mt-2">
                      {lang === 'ar' ? finding.guidanceAr : finding.guidanceEn}
                    </p>
                    {finding.autoAction?.type === 'OPEN_SETTING' && (
                      <button
                        onClick={() => void runParentAutoAction(finding)}
                        disabled={parentActionBusyId === finding.id}
                        className="mt-2 w-full py-2 rounded-lg bg-indigo-600 text-white text-xs font-black disabled:opacity-50"
                      >
                        {parentActionBusyId === finding.id ? t.runBusy : t.openSetting}
                      </button>
                    )}
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      </div>

      <div className="rounded-xl border border-slate-100 bg-white p-4">
        <p className="text-[11px] font-black text-slate-500">{t.history}</p>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-3">
          <div className="rounded-xl border border-slate-100 bg-slate-50 p-3">
            <p className="text-xs font-black text-slate-700">{t.childHistory}</p>
            {childHistory.length === 0 ? (
              <p className="text-sm font-bold text-slate-500 mt-3">{t.noHistory}</p>
            ) : (
              <div className="space-y-2 mt-3">
                {childHistory.slice(0, 8).map((entry) => {
                  const undoCandidate =
                    entry.eventType === 'REMEDIATION' && entry.undoAvailable && Boolean(entry.undoCommand);
                  const undoBlockReason = getUndoBlockReason(entry);
                  return (
                    <div key={entry.id} className="rounded-lg border border-slate-100 bg-white p-3">
                      <div className="flex items-center justify-between gap-2">
                        <span
                          className={`px-2 py-1 rounded-md border text-[10px] font-black ${severityClass(
                            entry.severity || entry.topSeverity || 'LOW'
                          )}`}
                        >
                          {historyEventLabel(entry.eventType)}
                        </span>
                        <span className="text-[10px] font-black text-slate-500">
                          {formatDateTimeDefault(entry.scanTimestampMs, { includeSeconds: true })}
                        </span>
                      </div>
                      <p className="text-[12px] font-bold text-slate-700 mt-2">{historySummary(entry)}</p>
                      {undoCandidate && (
                        <p className="text-[10px] font-black text-slate-500 mt-2">
                          {t.undoExpiresAt}:{' '}
                          {formatDateTimeDefault(getUndoExpiryMs(entry), { includeSeconds: true })}
                        </p>
                      )}
                      {undoCandidate && !undoBlockReason && (
                        <button
                          onClick={() => void runUndoWithStepUp(entry)}
                          disabled={undoBusyId === entry.id}
                          className="mt-2 w-full py-2 rounded-lg bg-amber-700 text-white text-xs font-black disabled:opacity-50"
                        >
                          {undoBusyId === entry.id ? t.runBusy : t.undo}
                        </button>
                      )}
                      {undoCandidate && undoBlockReason && (
                        <p className="text-[11px] font-black text-amber-700 mt-2">
                          {undoBlockReasonLabel(undoBlockReason)}
                        </p>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          <div className="rounded-xl border border-slate-100 bg-slate-50 p-3">
            <p className="text-xs font-black text-slate-700">{t.parentHistory}</p>
            {parentHistory.length === 0 ? (
              <p className="text-sm font-bold text-slate-500 mt-3">{t.noHistory}</p>
            ) : (
              <div className="space-y-2 mt-3">
                {parentHistory.slice(0, 8).map((entry) => (
                  <div key={entry.id} className="rounded-lg border border-slate-100 bg-white p-3">
                    <div className="flex items-center justify-between gap-2">
                      <span
                        className={`px-2 py-1 rounded-md border text-[10px] font-black ${severityClass(
                          entry.severity || entry.topSeverity || 'LOW'
                        )}`}
                      >
                        {historyEventLabel(entry.eventType)}
                      </span>
                      <span className="text-[10px] font-black text-slate-500">
                        {formatDateTimeDefault(entry.scanTimestampMs, { includeSeconds: true })}
                      </span>
                    </div>
                    <p className="text-[12px] font-bold text-slate-700 mt-2">{historySummary(entry)}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityCenterView;




