[0] اجعل بادج المدير فقط يكون مثل الصورة المرفقة مع عدم تغيير اللوجو الرسمي للتطبيق وتركه كما هو سابقا Screenshot_20260112_125712_Gallery.jpg
[1] لماذا الموديل المحلي يفشل في كشف بعض الصور؟
[2] بالنسبة للنقطة حرج. 4. قصور الخوارزميات اليدوية (Heuristic Limitations) خوارزمية كشف الدماء التي أضفناها في visualSentinel.ts تعتمد على حساب نسبة اللون الأحمر. إذا كانت الإضاءة خافتة أو كان الدم يميل للون الداكن، أو إذا كانت الصورة بالأبيض والأسود، ستفشل الخوارزمية لأنها "معادلة رياضية" وليست "ذكاءً حقيقياً". هي التي بها مشكلة حقيقية لم يميز وجه شخص لديه اصابة كبيرة في وجهه هل يمكن تطوير الخوارزمية بحيث يكشف معظم الجروح أو الإصابات ؟
[3] ما سرعة كشفه؟
[4] لم يكتشف محليا ولجأ للسحابة واستغرق ٨ ثواني وأيضا فشل Screenshot_20260112_151352_Chrome.jpg
[5] مطلوب تعديل تصميم الأزرار في خزنة الأدلة لتطابق الصورة في المرفق وزيادة الحواشي السفلية لتجنب تداخل الأزرار مع القائمة السفلية أو العائمة مع عدم تعديل أي شئ آخر أبدا Screenshot_20260112_003348_Gallery.jpg
[6] تقليل الحواف الدائرية للأزرار وجعلها شبه مستطيلة مع تقليص ارتفاع الأزرار وتبديل أماكن الزرين تصدير pdf و إتلاف السجل
[7] تفعيل الأزرار بمعني تصدير ملف حقيقي pdf وعند الحفظ أو التصدير أو الحذف تنبيه فوري خلفية بيضاء لوجو التطبيق خط نص الكتابة نفس الماروني وإطار الرسالة الخارجي ذهبي مصقول لامع مع نص رسالة تنبيه فوري تفصيلية بتأكيد المهمة التي تم إنجازه
[8] ألاحظ أن الرسالة لها إطاران المطلوب إزالة الإطار الخارجي المستطيل وأيضا تأثير اللون الذهبي للإطار المتبقي بعد الحذف ذو الحواف الدائرية غير مطابق لإطار الدرع في اللوجو الرسمي وهذا مطلوب Screenshot_20260112_154142_Chrome.jpg
[9] هل يمكن إزالة إطار وخلفية صورة أفاتار وتكبير الصورة قليلا؟ Screenshot_20260112_155025_Chrome.jpg
[10] انس الأمر فقط قم بحذف الإطار ولا تغير أي شئ آخر أنا استعدت نسخة مستقرة الآن اعمل
[11] الإطار والظل ما زالا موجودان Screenshot_20260112_155705_Chrome.jpg
[12] اجعل خلفية صورة الأفاتار الرمادية تكون بيضاء
[13] هل يمكن جعل الصورة شفافة بدون أي خلفيات؟
[14] إدراج زر الترس بين الجهاز والحذف ذلك لتعديل بيانات العضو أو ترقيته Screenshot_20260112_161216_Chrome.jpg
[15] تفعيل زر الترس
[16] أضافة بيانات العمر للأطفال و إضافة حواشي علوية وسفلية لتجنب التداخل مع الشريطين العلوي والسفلي
[17] لقد اختفت صور أفاتار الأطفال بالخطأ مطلوب إرجاعها دون أي تغييرات إضافية
[18] اجعل مقاسات جميع صور أفاتار كل أعضاء الأسرة تكون في حجم صور أفاتار الأطفال باعتبارها هي المقاسات القياسية هل هذا أفضل؟
[19] تصغير حجم الأزرار حتي لا تتأثر صورةةأفاتار الطفل كما هو ظاهر بالصورة وإرجاع حجم صورة الأفاتار للطفل في الحجم القياسي Screenshot_20260112_163711_Chrome.jpg
[20] ما زال هناك اجتزاء في صورة أفاتار الطفل بسبب عدم تماثل مجموعة العمر وحالة الاتصال والدور child بالمحاذاة الأفقية بنفس الأب والأم مطلوب ترحيل هذه المجموعة للأطفال لتكون في نفس محاذاة مجموعات بيانات الأب والأم وبالتالي يتسع المكان لاكتمال صورة الأفاتار لكل طفل Screenshot_20260112_164146_Chrome.jpg
[21] ممتاز أحسنت العمل احترافي Screenshot_20260112_164725_Chrome.jpg
[22] Fix the following errors: code Code download content_copy expand_less Uncaught TypeError: Converting circular structure to JSON --> starting at object with constructor 'Q$1' | property 'i' -> object with constructor 'Sa' --- property 'src' closes the circle
[23] لقد زاد ارتفاع الشريط العلوي قليلا بالخطأ المطلوب تقليص ارتفاع الشريط العلوي إلى الوضع الأصلي بحيث يكون أقل من ارتفاع اللوجو ويظهر جزء من اللوجو خارج الشريط من أعلى ومن أسفل كما كان بالسابق دون تغيير أي شيء آخر
[24] الآن مطلوب تقليص حجم اللوجو الأصلي الموجود على الشريط العلوي قليلا
[25] تم تكبير حجم اللوجو بدلا من تصغيره بالخطأ أنا قمت بإرجاع النسخة السابقة مطلوب تصغير حجم اللوجو قليلا Screenshot_20260112_174753_Chrome.jpg
[26] هناك مشكلة حقيقية اللوجو أصبح أكبر وليس أصغر Screenshot_20260112_175124_Chrome.jpg
[27] لقد استعدت نسخة أكثر استقرارا افحص الكود واذكر لي أبعاد اللوجو الأصلي الموجود على الشريط العلوي دون أن تغير أي شئ. فقط اذكر أبعاد اللوجو
[28] اجعل معامل التكبير ١٠٠ بدلا من ١١٠
[29] اجعل معامل التكبير ٨٥ بدلا من ١٠٠
[30] لا يظهر التصغير بوضوح هل السبب هو viewBox="0 0 240 300"
[31] ممتاز الآن يوجد شريط أسود أسفل الشريط العلوي ما فائدته؟ Screenshot_20260112_181113_Chrome.jpg
[32] عفوا الصورة من خزنة الأدلة وليست لوحة التحكم
[33] لا أرى أي بيانات أقصد الشريط المحدد في المرفق Screenshot_20260112_181529_Chrome.jpg
[34] مطلوب تحريك الشريط العلوي قليلا لأسفل مثل ما كان h 20 تقريبا
[35] إرجاع البانر الأسود مثل الموجود بالمرفق Screenshot_20260112_000054_Gallery.jpg
[36] مطلوب إرجاع البانر الأسود مثل الموجود بالمرفق Screenshot_20260112_000054_Gallery.jpg
[37] زيادة عرض الأزرار كما كانت من قبل اجعل داخل الأزرار تكون rtl بمعنى الصورة على اليمين والكتابة على اليسار
[38] قم بتعديل تصميم الأزرار لتكوم مطابقة للتصميم في المرفق Screenshot_20260112_183441_Gallery.jpg
[39] الهيدر الأسود غير واضح لأنه موجود خلف الشريط العلوي Screenshot_20260112_183905_Chrome.jpg
[40] إظهار الشريط السفلي لأنه اختفى بالخطأ
[41] تنسيق المخطط الراداري لتجنب تداخل الكلمات مع المخطط وجعل كل كلمة عند رأس المثلث بدون تداخل مع المخطط Screenshot_20260113_045719_Chrome.jpg
[42] التداخل ازداد سوء
[43] حل مشكلة التداخل لا يجدي بتصغير حجم المخطط الراداري العكس صحيح توسيع المخطط وجعل كل نص rtl لأن الكلمات مكتوبة باللغة العربية Screenshot_20260113_050440_Chrome.jpg
[44] مازال هناك تداخل سابقا كنا انتهينا من هذه المشكلة كما بالمرفق حلل الصورتين وقارن بين الأبعاد ومواقع واتجاه الكلمات بالمخطط الراداري Screenshot_20260113_051108_Chrome.jpg Screenshot_20260113_051411_Gallery.jpg
[45] لقد ذهبنا بعيدا عن المطلوب Screenshot_20260113_052008_Chrome.jpg
[46] إعادة الشريط السفلي لأنه اختفى بالخطأ
[47] هناك خطأ شاشة بيضاء
[48] Fix the following errors: code Code download content_copy expand_less Firebase initialization error Error: Service firestore is not available at c.getImmediate (https: //esm.sh/@firebase/component@0.6.5/es2022/component.mjs:2:1310) at qd (https: //esm.sh/@firebase/firestore@4.4.2/es2022/firestore.mjs:17:2956) at data :application/javascript;base64,aW1wb3J0IHsgaW5pdGlhbGl6ZUFwcCB9IGZyb20gImZpcmViYXNlL2FwcCI7CmltcG9ydCB7IGdldEZpcmVzdG9yZSB9IGZyb20gImZpcmViYXNlL2ZpcmVzdG9yZSI7CmltcG9ydCB7IGdldEF1dGggfSBmcm9tICJmaXJlYmFzZS9hdXRoIjsKLy8g8J+UtCDZh9in2YUg2KzYr9in2Ys6INin2LPYqtio2K/ZhCDYp9mE2YLZitmFINij2K/Zhtin2Ycg2KjYp9mE2YLZitmFINin2YTYqtmKINi42YfYsdiqINmE2YMg2YHZiiBGaXJlYmFzZSBDb25zb2xlCi8vINio2LnYryDYqtiz2KzZitmEINiq2LfYqNmK2YIg2KfZhNmI2YrYqCAo2KfZhNiu2LfZiNipINix2YLZhSAxINmB2Yog2KfZhNi02LHYrSkKY29uc3QgZmlyZWJhc2VDb25maWcgPSB7CiAgICBhcGlLZXk6ICJBSXphU3lEM3BaZ21QeXpNaDdqWlhMTkxDOGtBZFdSYmtSZjFtYmMiLAogICAgYXV0aERvbWFpbjogImFtYW5haC1wcm90ZWN0LmZpcmViYXNlYXBwLmNvbSIsCiAgICBwcm9qZWN0SWQ6ICJhbWFuYWgtcHJvdGVjdCIsCiAgICBzdG9yYWdlQnVja2V0OiAiYW1hbmFoLXByb3RlY3QuZmlyZWJhc2VzdG9yYWdlLmFwcCIsCiAgICBtZXNzYWdpbmdTZW5kZXJJZDogIjUxOTU4ODk3NDcyIiwKICAgIGFwcElkOiAiMTo1MTk1ODg5NzQ3Mjp3ZWI6M2M3YTcyNzUxZjZmMTQ2Y2YwMzhhNSIKfTsKLy8g2KrZh9mK2KbYqSDYp9mE2KrYt9io2YrZgiAoU2luZ2xldG9uIFBhdHRlcm4pCmxldCBhcHA7CmxldCBkYkluc3RhbmNlID0gbnVsbDsKbGV0IGF1dGhJbnN0YW5jZSA9IG51bGw7CnRyeSB7CiAgICAvLyDYp9mE2KrYrdmC2YIg2YXZhiDZiNis2YjYryDYp9mE2YXZgdiq2KfYrSDYp9mE2K3ZgtmK2YLZiiDZhNiq2KzZhtioINin2YTYo9iu2LfYp9ihINij2KvZhtin2KEg2KfZhNmG2LPYrgogICAgaWYgKGZpcmViYXNlQ29uZmlnLmFwaUtleS5pbmNsdWRlcygiWU9VUl9SRUFMX0FQSV9LRVlfSEVSRSIpKSB7CiAgICAgICAgY29uc29sZS53YXJuKCLimqDvuI8g2KrZhtio2YrZhzog2YTZhSDZitiq2YUg2YjYtti5INmF2YHYp9iq2YrYrSBGaXJlYmFzZSDYp9mE2K3ZgtmK2YLZitipINio2LnYryDZgdmKIHNlcnZpY2VzL2ZpcmViYXNlQ29uZmlnLnRzIik7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBhcHAgPSBpbml0aWFsaXplQXBwKGZpcmViYXNlQ29uZmlnKTsKICAgICAgICBkYkluc3RhbmNlID0gZ2V0RmlyZXN0b3JlKGFwcCk7CiAgICAgICAgYXV0aEluc3RhbmNlID0gZ2V0QXV0aChhcHApOwogICAgICAgIGNvbnNvbGUubG9nKCLinIUgRmlyZWJhc2UgQ29ubmVjdGVkIFN1Y2Nlc3NmdWxseSIpOwogICAgfQp9CmNhdGNoIChlcnJvcikgewogICAgaWYgKCEvYWxyZWFkeSBleGlzdHMvLnRlc3QoZXJyb3IubWVzc2FnZSkpIHsKICAgICAgICBjb25zb2xlLmVycm9yKCdGaXJlYmFzZSBpbml0aWFsaXphdGlvbiBlcnJvcicsIGVycm9yLnN0YWNrKTsKICAgIH0KfQpleHBvcnQgY29uc3QgZGIgPSBkYkluc3RhbmNlOwpleHBvcnQgY29uc3QgYXV0aCA9IGF1dGhJbnN0YW5jZTsKZXhwb3J0IGNvbnN0IGNoZWNrQ29ubmVjdGlvbiA9IGFzeW5jICgpID0+IHsKICAgIGlmICghZGIpCiAgICAgICAgcmV0dXJuICJOb3QgQ29uZmlndXJlZCI7CiAgICByZXR1cm4gIkNvbm5lY3RlZCI7Cn07Cg==: 25 : 22 code Code download content_copy expand_less Uncaught Error: Minified React error # 31 ; visit https: / / reactjs.org / docs / error - decoder.html?invariant = 31 & args[] = object % 20 with % 20 keys % 20 % 7 B % 24 % 24 typeof % 2 C % 20 type % 2 C % 20 key % 2 C % 20 ref % 2 C % 20 props % 7 D for the full message or use the non - minified dev environment for full errors and additional helpful warnings.
[49] الزر الأسود السفلي غير واضح خلف الشريط السفلي. مطلوب إدراج padding سفلية لتأمين ظهور عناصر الصفحات والنوافذ وتجنب التداخل أو جعلهم scrollable Screenshot_20260114_081021_Chrome.jpg
[50] جعل جميع الصفحات والنوافذ scrollable
[51] تصغير ارتفاع الشريط السفلي دون أي تغييرات إضافية
[52] شكل الأزرار غير احترافي اجعلهم بنفس حجم وتنسيق وترتيب الأزرار الموجودة في القصاصة المرفقة Screenshot_20260114_083226_Chrome.jpg Screenshot_20260113_095413_Gallery.jpg
[53] لا أرى أي تعديل مطلوب اجعل الأزرار بنفس حجم وتنسيق وترتيب الأزرار الموجودة في القصاصة المرفقة Screenshot_20260113_095413_Gallery.jpg
[54] يوجد فراغ كبير أسفل الأزرار مطلوب تصغيره لتحسين واجهة المستخدم Screenshot_20260114_105015_Chrome.jpg
[55] هيدر صفحة تفريغ السجل الجنائي الكامل أصبح على الشريط العلوي ويمنع رؤيته. مطلوب إضافة padding علوي للصفحة لتجنب التداخل Screenshot_20260114_130122_Chrome.jpg
[56] لا أرى تغيير
[57] هل يمكن استخدام stitch لتطوير تطبيق جهاز الطفل android
[58] ما هي أفضل الحلول لبناء تطبيق هاتف الطفل؟
[59] نعم هل يمكن التنفيذ على android studio
[60] اكتب هنا ملفات تطبيق هاتف الطفل وقم بتعبئة المطلوب لكي يكون مشروع جاهز أنا أستطيع فتحه من android studio بسهولة مع الشرح خطوة بخطوة
[61] ما هي dependencies المطلوبة وأين أضعها
[62] هناك ملاحظات هامة قبل ربط المفتاح معلومات “جلسة الاقتران” Pairing Session (لازم Backend) هذه البيانات يجب أن يولدها الـ Backend عند إنشاء جلسة اقتران: sessionId (معرّف فريد) otpCode (الكود المؤقت) الطول (مثال 6 أرقام) طريقة الإدخال: هل الطفل يكتبه؟ أم يتم تضمينه داخل QR؟ expiresAt (وقت انتهاء الجلسة) parentUid (صاحب الجلسة/الأسرة) status (مثال: PENDING | VERIFIED | EXPIRED | REVOKED) قيود أمان: attemptsRemaining أو maxAttempts lockedUntil لو حصل brute force (اختياري لكن مهم) nonce/signature لو QR يحمل sessionId فقط، يمكن تزويره بسهولة. توقيع بسيط يقلل العبث. النتيجة: بدون هذه الحزمة، لا يمكن تنفيذ “كود مؤقت ثم Token” بشكل صحيح. [2.3] معلومات QR Payload (ما الذي يشفّره الـ QR بالضبط؟) لازم تحسم واحدة من طريقتين: الخيار A (الأكثر أمانًا وسهلًا): QR يحمل sessionId فقط QR يحتوي مثلًا: amanah://pair?sessionId=... الطفل يمسح QR → يحصل على sessionId الوالد يقرأ OTP على شاشة الـ Parent الطفل يكتب OTP ثم يرسل verify(sessionId, code, deviceInfo) المطلوب هنا: صيغة URI ثابتة (scheme/path/params) التحقق من sessionId في backend + OTP الخيار B (الأسرع، لكن مخاطره أعلى): QR يحمل sessionId + otpCode الطفل يمسح QR → لا يحتاج إدخال OTP لكن لو أحد صوّر QR تمت سرقة الربط بسهولة إذا اخترت B، لازم توقيع/تشفير داخل QR + TTL صغير جدًا. [2.4] معلومات “Token” الذي يحصل عليه الطفل بعد الاقتران بعد نجاح /pair/verify يلزم تحديد: نوع التوكن JWT؟ Firebase Custom Token؟ Session Token من عندك؟ expiresIn (واضح في VerifyResponse) هل يوجد Refresh Token؟ أم سيعاد الاقتران عند انتهاء التوكن؟ ما الذي يصرّح به التوكن؟ (Scopes/Claims) deviceId parentUid familyId (إن وجد) أين سيُخزن؟ على أندرويد الأفضل داخل EncryptedSharedPreferences (وأنت بالفعل مضمّن androidx.security.crypto) [2.5] معلومات “تعريف الجهاز” Device Identity المطلوبة في backend لازم تتفقوا على تعريف ثابت للجهاز: deviceId (ينشئه الـ backend عند أول اقتران ناجح) devicePublicKey أو deviceSecret (اختياري لكن قوي) لو تريد مستقبلًا Mutual Auth أو توقيع Requests model / osVersion / appVersion / platform (موجودة عندك) (اختياري) fcmToken لتلقي أوامر/إشعارات من الوالد “الربط العائلي”: parentUid أو familyId [2.6] Endpoints الدنيا المطلوبة (حتى يعمل السيناريو كما وصفته) حتى لو UI كامل، هذا الحد الأدنى Backend/API: POST /pair/create (من تطبيق الوالد/الكونسول) يخلق Session جديدة ويرجع: sessionId otpCode expiresIn وربما qrPayload جاهز POST /pair/verify (من تطبيق الطفل) — هذا موجود في PairingApi body مطابق لملفك يرجع accessToken, deviceId, parentUid, expiresIn (مهم لاحقًا) POST /device/register أو /device/heartbeat لتحديث lastActive، ورفع fcmToken… إلخ
[63] التطبيق يعمل على محاكي android stuaio أين أجد ملف apk لآجربه على هاتف حقيقي خارجي image.png
[64] مطلوب إعادة جميع عناصر القائمة الجانبية أيضا إرجاع بطاقة الأجهزة المتصلة في صفحة الإعدادات تم ربط جهاز حقيقي لكن كيف أعرف أن الربط تم بنجاح؟
[65] الجهاز المربوط لا يظهر كل الأجهزة الظاهرة وهمية
[66] زر الإعدادات غير موجود بالقائمة الجانبية
[67] احذف الأجهزة الوهمية
[68] مفتاح الربط المكون من 8 رموز غير ظاهر
[69] في الهاتف تم ربط الجهاز وفي تطبيق الأب لا توجد أجهزة مرتبطة حاليا
[70] لا جديد غير أنك قمت بحذف العديد من عناصر الصفحة ولم يتم أي ؤبط تأكد أن تطبيق الطفل وتطبيق الأب على نفس قاعدة البيانات
[71] الآن ظهر الجهاز لنبدأ الآن في تفعيل المميزات مثل مراقبة النصوص والشاشة والصور لآنها لا تعمل
[72] لا شئ يعمل من رصد الشاشة (البث): بما أننا في متصفح، قمت بتفعيل "أوامر لقطة الشاشة". عند ضغطك على "التقاط شاشة حية" في صفحة البث، سيهتز هاتف الطفل ويقوم فوراً بإرسال صورة لما يراه حالياً، وستظهر لك في "خزنة الأدلة" (Evidence Vault). القفل الفوري: يمكنك الآن الضغط على "حظر الجهاز" وسيتحول تطبيق الطفل للون الأحمر ويمنعه من الاستخدام برمجياً. يرجى تجربة الضغط على "التقاط شاشة حية" في لوحة تحكم الأب (Live Monitor) وستلاحظ ظهور التنبيه فوراً في هاتف الطفل.
[73] Fix the following errors: code Code download content_copy expand_less [ 2026 - 01 -16T07: 49 : 04. 831Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg code Code download content_copy expand_less [ 2026 - 01 -16T07: 49 : 11. 322Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=ClFwcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWN0aXZpdGllcy9pbmRleGVzL18QARoMCghwYXJlbnRJZBABGg0KCXRpbWVzdGFtcBACGgwKCF9fbmFtZV9fEAI code Code download content_copy expand_less [ 2026 - 01 -16T07: 49 : 45. 846Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg code Code download content_copy expand_less [ 2026 - 01 -16T07: 49 : 56. 236Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg code Code download content_copy expand_less [ 2026 - 01 -16T07: 50 : 45. 316Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg code Code download content_copy expand_less [ 2026 - 01 -16T07: 50 : 50. 246Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg code Code download content_copy expand_less [ 2026 - 01 -16T07: 50 : 55. 094Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg code Code download content_copy expand_less [ 2026 - 01 -16T07: 50 : 58. 260Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg code Code download content_copy expand_less [ 2026 - 01 -16T07: 50 : 59. 281Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg code Code download content_copy expand_less [ 2026 - 01 -16T07: 51 : 27. 486Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=failed-precondition]: The query requires an index. You can create it here: https: //console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg
[74] Fix the following errors: code Code download content_copy expand_less Uncaught TypeError: Converting circular structure to JSON --> starting at object with constructor 'Q$1' | property 'i' -> object with constructor 'Sa' --- property 'src' closes the circle
[75] لا شئ يعمل ولا توجد صلاحيات لتطبيق الطفل Screenshot_20260116-115614_Settings.jpg Screenshot_20260116-115625_Permission controller.jpg
[76] تم قفل الجهاز بنجاح لكن التقاط شاشة حية وصافرة الطوارئ لا يعملان
[77] Build file 'C:\Users\Ostaaz\AndroidStudioProjects\AmanahChild\app\build.gradle' line: 26 Could not compile build file 'C:\Users\Ostaaz\AndroidStudioProjects\AmanahChild\app\build.gradle'. startup failed: build file 'C:\Users\Ostaaz\AndroidStudioProjects\AmanahChild\app\build.gradle': 26: Unexpected input: ':' @ line 26, column 20. class MainActivity : AppCompatActivity() { ^ 1 error
[78] Fix the following errors: code Code download content_copy expand_less Uncaught TypeError : Cannot read properties of undefined (reading 'replace' )
[79] مطلوب إضافة زر toggleمنع تطبيق الطفل من غلق الجهاز يجب أضافة ميزة تخصيص الجهاز المربوط بالابن
[80] زر منع غلق الجهاز لا يعمل
[81] مطلوب إرجاع لوجو الدرع كما كان من قبل لأنه تغير بالخطأ Screenshot_20260117_080705_Chrome.jpg
[82] مطلوب إرجاع لوجو الدرع كما كان من قبل لأنه تغير بالخطأ في واجهة تطبيق الأب منصة الويب Screenshot_20260117_081042_Chrome.jpg
[83] لم يتغير شئ الأفضل أن تستخدم ملف svg الذي أرسلته لك من قبل هنا في هذه المحادثة
[84] لماذا آخر الأنشطة المرصودة فارغة؟ هل تطبيق الطفل لا يخرن التفاصيل داخل قاعدة البيانات؟ مطلوب التحقق من المشكلة Screenshot_20260117_081811_Chrome.jpg
[85] <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 240 240" preserveAspectRatio="xMidYMid meet" role="img" aria-label="AMANA shield icon"> <defs> <filter id="softShadow" x="-35%" y="-35%" width="170%" height="170%"> <feDropShadow dx="0" dy="10" stdDeviation="9" flood-color="#000" flood-opacity="0.20"/> </filter> code Code download content_copy expand_less < filter id = "innerShadow" x = "-35%" y = "-35%" width = "170%" height = "170%" > < feOffset dx = "0" dy = "3" in = "SourceAlpha" result = "off" /> < feGaussianBlur in = "off" stdDeviation = "4" result = "blur" /> < feComposite in = "blur" in2 = "SourceAlpha" operator = "out" result = "innerCut" /> < feColorMatrix in = "innerCut" type = "matrix" values = "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.28 0" result = "shadow" /> < feComposite in = "shadow" in2 = "SourceGraphic" operator = "over" /> </ filter > < filter id = "goldSpecular" x = "-40%" y = "-40%" width = "180%" height = "180%" > < feGaussianBlur in = "SourceAlpha" stdDeviation = "1.2" result = "a" /> < feSpecularLighting in = "a" surfaceScale = "6" specularConstant = "0.95" specularExponent = "36" lighting-color = "#FFF" result = "spec" > < feDistantLight azimuth = "235" elevation = "48" /> </ feSpecularLighting > < feComposite in = "spec" in2 = "SourceAlpha" operator = "in" result = "specIn" /> < feMerge > < feMergeNode in = "SourceGraphic" /> < feMergeNode in = "specIn" /> </ feMerge > </ filter > < path id = "shieldPathBalanced" d = "M120 18 C147 25 173 35 192 46 C194 48 196 50 196 54 L196 122 C196 172 163 208 120 226 C77 208 44 172 44 122 L44 54 C44 50 46 48 48 46 C67 35 93 25 120 18 Z" /> < clipPath id = "shieldClip" > < use href = "#shieldPathBalanced" /> </ clipPath > < linearGradient id = "maroonBody" x1 = "0" y1 = "0" x2 = "1" y2 = "1" > < stop offset = "0%" stop-color = "#B83A60" /> < stop offset = "35%" stop-color = "#8A1538" /> < stop offset = "100%" stop-color = "#3A0715" /> </ linearGradient > < linearGradient id = "goldMetal" x1 = "0" y1 = "0" x2 = "1" y2 = "1" > < stop offset = "0%" stop-color = "#FFF8D8" /> < stop offset = "10%" stop-color = "#F7DE8D" /> < stop offset = "22%" stop-color = "#D1A23D" /> < stop offset = "36%" stop-color = "#FFF2B6" /> < stop offset = "50%" stop-color = "#B47E1B" /> < stop offset = "64%" stop-color = "#FFE6A0" /> < stop offset = "78%" stop-color = "#C69126" /> < stop offset = "100%" stop-color = "#7A4D0A" /> </ linearGradient > < linearGradient id = "goldInner" x1 = "0" y1 = "0" x2 = "0" y2 = "1" > < stop offset = "0%" stop-color = "#FFFFFF" stop-opacity = "0.55" /> < stop offset = "55%" stop-color = "#F0C96B" stop-opacity = "0.18" /> < stop offset = "100%" stop-color = "#2A1603" stop-opacity = "0.42" /> </ linearGradient > < linearGradient id = "glossSweep" x1 = "0" y1 = "0" x2 = "1" y2 = "0" > < stop offset = "0%" stop-color = "#FFF" stop-opacity = "0" /> < stop offset = "32%" stop-color = "#FFF" stop-opacity = "0.12" /> < stop offset = "48%" stop-color = "#FFF" stop-opacity = "0.34" /> < stop offset = "62%" stop-color = "#FFF" stop-opacity = "0.10" /> < stop offset = "100%" stop-color = "#FFF" stop-opacity = "0" /> </ linearGradient > </defs> <!-- Centered shield group (no text) --> <g filter="url(#softShadow)"> <use href="#shieldPathBalanced" fill="url(#maroonBody)" filter="url(#innerShadow)"/> code Code download content_copy expand_less < g clip-path = "url(#shieldClip)" > < path shape-rendering = "geometricPrecision" fill = "#FFF" d = "M30 0 H95 V35 L120 50 L95 65 L120 80 L95 95 L120 110 L95 125 L120 140 L95 155 L120 170 L95 185 L120 200 L95 215 V260 H30 Z" /> < path d = "M10 70 C70 40 140 35 230 85 L230 105 C160 75 85 85 10 150 Z" fill = "url(#glossSweep)" opacity = "0.22" /> < rect x = "0" y = "0" width = "240" height = "240" fill = "#000" opacity = "0.02" /> </ g > < use href = "#shieldPathBalanced" fill = "none" stroke = "url(#goldMetal)" stroke-width = "10" stroke-linejoin = "round" stroke-linecap = "round" filter = "url(#goldSpecular)" /> < path d = "M120 26 C145 33 168 42 183 51 C184 52 186 54 186 57 L186 122 C186 164 158 195 120 211 C82 195 54 164 54 122 L54 57 C54 54 56 52 57 51 C72 42 95 33 120 26 Z" fill = "none" stroke = "url(#goldInner)" stroke-width = "4.5" stroke-linejoin = "round" stroke-linecap = "round" opacity = "0.92" /> </g> </svg>
[86] لم يتغير في واجهة الويب Screenshot_20260117_082610_Chrome.jpg
[87] المشكلة الظاهرة في تطبيق الويب الخاص بالآباء أول ظهور قبل صفحة تسجيل الدخول بمعنى آخر صفحة system initialization هذه هي المطلوب تحسينها وتغيير الكود ليظهر اللوجو الصحيح Screenshot_20260117_082610_Chrome.jpg
[88] ممتاز الآن مطلوب إضافة توهج متحرك مثل التنفس للدرع
[89] مطلوب أن يكون تأثير التوهج موجود فقط في صفحة Initialization لكن في باقي الصفحات بدون تأثير التوهج موجود
[90] مطلوب لوحة تحكم كاملة في تطبيق الأب بحيث يتمكن من التحكم الكامل في تنشيط نوع الرقابة والإجراءات الاتوماتيكية لبروتكولات الدفاع الاستباقي مثل أن يقوم تطبيق الابن مثلا عند اكتشاف ألفاظ أو صور أو فيديوهات غير مناسبة في هاتف الإبن يختار الأب الإجراءات الآلية الفورية مثل حظر الكاميرا أو الميكروفون أو الموقع أو التطبيق المستخدم أو غلق الجهاز بشاشة تم غلق الجهاز أو إرسال رسالة آلية للطفل مكتوبة مسبقا أو تكتب في جهاز الأب ثم دفعها لجهاز الابن ليتم استخدامها آليا حسب الطلب أو تنبيه صوتي يمكن اختياره من ملفات الصوت أو تسجيله من الأب في جهاز الأب ثم ارساله وحفظه للاستخدام المباشر في تطبيق الابن آليا حسب الطلب بمعنى آخر مطلوب لوحة تحكم كاملة شاملة عند الأب يتم فيها إعدادات الحارس الشخصي للابن كيف ومتى يتم تطبيق هذا الإجراء وأيضا للتسهيل يمكن أن يضغط الأب على check box للضبط الآلي لكل نقطة أو toggle لجميع النقاط
[91] Fix the following errors: code Code download content_copy expand_less Login Error : auth/invalid-credential
[92] في محاكاة التهديدات يوجد خلل لأن بعد تجرية محاكاة يظل النظام يرسل رسائل وإنذارات متواصلة لنفس الواقعة حتى بعد عرض الدليل
[93] ما هي المحركات المحلية المستخدمة للكشف الفوري
[94] تفعيل أزرار خزنة الأدلة وإضافة إشعار تفصيلي عند إتمام كل مهمو وإضافة تنبيه تنصيلي قبل الحذف
[95] Add a section to test and benchmark the performance of the local visual sentinel model under various conditions.
[96] ممتاز لكن هناك عناصر اختفت في معظم صفحات وقوائم النظام مطلوب إرجاعها جميعا دون تغيير العناصر الموجودة مع جعل كفاءة وسرعة النظام أفضل ما يكون دون التأثير على وظائف النظام الكاملة وهويته البصرية
[97] أريد منك القيام بتحليل شامل ومتعمق لنظام برمجي متكامل، وإضافة صفحة جديدة داخل المشروع بعنوان: System Security & Performance Analysis Report المطلوب منك ما يلي بدقة واحترافية: أولًا – تحليل أمني كامل للنظام (Cybersecurity Assessment) قم بتحليل جميع ملفات الأكواد البرمجية المرفقة وتحليل النظام من جميع الجوانب الأمنية، بما يشمل على الأقل: فحص الثغرات البرمجية في الأكواد المصدرية (Code Vulnerabilities) تحليل نقاط الضعف المحتملة في: المصادقة Authentication التفويض Authorization إدارة الجلسات Session Management فحص أمان: تخزين البيانات الحساسة التشفير Encryption حماية مفاتيح API وبيانات الاعتماد تحليل أمان الاتصال بالشبكة: HTTPS / TLS حماية API Endpoints هجمات Man-in-the-Middle تحليل قابلية النظام للتعرض لهجمات مثل: SQL Injection XSS CSRF Insecure Direct Object References مراجعة صلاحيات التطبيقات والصلاحيات الممنوحة للمستخدمين تحليل أمان تخزين الملفات المؤقتة وملفات الكاش مراجعة مكتبات الطرف الثالث (Third-party Libraries) من حيث: تحديثاتها وجود ثغرات معروفة بها تقييم أمان نظام تسجيل الأحداث Logging فحص أي بيانات حساسة مكشوفة داخل الكود ثانيًا – تحليل الأداء التقني للنظام قم بتحليل شامل للأداء التقني من الجوانب التالية: سرعة استجابة النظام Response Time استهلاك الذاكرة Memory Usage استهلاك المعالج CPU Usage كفاءة استعلامات قواعد البيانات قابلية التوسع Scalability إدارة الأخطاء Exception Handling جودة تنظيم الأكواد Architecture Quality زمن تحميل الصفحات أو الواجهات كفاءة الاتصالات مع الخوادم الخارجية استقرار النظام تحت الضغط Load Handling ثالثًا – تحليل الجودة البرمجية تنظيم الكود ونمط الكتابة Code Style الالتزام بأفضل الممارسات Best Practices قابلية الصيانة Maintenance قابلية الاختبار Testing جودة هيكلة المشروع الفصل بين الطبقات Separation of Concerns رابعًا – تقرير التوصيات أريد منك في نهاية التقرير إنشاء قسم خاص بعنوان: Recommendations & Action Plan وفيه يتم تقديم: قائمة توصيات عملية لتحسين الأمان قائمة توصيات لتحسين الأداء اقتراحات لتحسين بنية النظام حلول برمجية مباشرة قابلة للتنفيذ ويجب أن تكون التوصيات: مصنفة حسب: درجة الخطورة (High – Medium – Low) الأولوية (Critical – Important – Optional) مع شرح تقني مختصر لكل توصية مع أمثلة كود عند الحاجة خامسًا – قسم “المتابعة الدورية حسب أحدث مستجدات الأمن السيبراني” أضف داخل التقرير قسمًا مستقلًا بعنوان: Continuous Security Monitoring & Emerging Threat Updates وفي هذا القسم مطلوب منك: الاطّلاع على أحدث المستجدات عالميًا في: أمن المعلومات اكتشاف الثغرات (0-day, CVEs) تحديثات الأطر والمكتبات الشائعة أساليب الهجوم الحديثة (TTPs) تصميم آلية “متابعة دورية” داخل النظام (أو ضمن سير العمل DevSecOps) تشمل: فحص دوري للثغرات في المكتبات (SCA) فحص ثابت للكود (SAST) فحص ديناميكي للتطبيق (DAST) عند توفر بيئة تشغيل فحص إعدادات الخادم/البيئة (Security Misconfiguration) إعداد تقارير دورية تلقائية تُرسل إلى مدير النظام (System Admin / Security Owner) تتضمن: الحالة الأمنية الحالية (Security Posture Summary) الحالة التقنية والأدائية (Performance/Health Summary) قائمة بالمشكلات المفتوحة، وما تم إصلاحه، وما هو قيد المتابعة توصيات شهرية/أسبوعية للتحسين حسب ما يظهر من نتائج الفحص تصميم نظام “تنبيه عاجل وفوري” (Immediate Alerts) بحيث: يتم إرسال رسالة عاجلة فورية فور اكتشاف أي: ثغرة حرجة تسريب بيانات/مفاتيح نمط هجوم أو سلوك مشبوه خلل أمني في المصادقة/التفويض فشل أمني في TLS/HTTPS ويجب أن توضح الرسالة: مستوى الخطورة مكوّن النظام المتأثر سبب الاشتباه / الدليل الإجراء المقترح فورًا (Mitigation) اقترح قنوات إرسال التقارير والتنبيهات مثل: Email Slack / Teams Webhook لوحة متابعة داخلية Dashboard إشعارات Push (إن كانت مناسبة للنظام) قدّم “خطة تطبيق” عملية خطوة بخطوة لتنفيذ المتابعة الدورية والتنبيهات، مع أمثلة إعدادات أو كود عند الحاجة. سادسًا – المطلوب منك تحديد أخطر 10 ثغرات حالية في النظام أهم 10 تحسينات أداء مقترحة خطة تنفيذ مرتبة زمنيًا لإصلاح النظام خطوة بخطوة ملاحظة مهمة لا تقم بتغيير أي وظيفة حالية في النظام. المطلوب فقط: التحليل التقييم التقرير التوصيات التقنية قم الآن بتنفيذ هذا التحليل بشكل كامل ودقيق بناءً على جميع الملفات الموجودة داخل النظام مطلوب أن تكون المخرجات داخل صفحة/ملف واحد باسم التقرير المقترح، مع تقسيم واضح للأقسام والتوصيات حسب الخطورة والأولوية.
[98] توجد أخطاء ومعظم النصوص غير ظاهرة
[99] ممتاز اجعل كل ثغرة clickable بحيث عند الضغط عليها ننتقل لتفاصيل الثغرة وتوصيات الإصلاح اجعل قائمة الثغرات scrollable ولا نكتفي بعشرة ثغرات لكن بجميع الثغرات الموجودة أيا كان عددها وهكذا بالنسبة لباقي القوائم
[100] أضف ميزة تصدير تقرير رسمي احترافي وتفصيلي وشامل لجميع محتويات الصفحة بتنسيق احترافي وتنافسي عالمي التصدير يكون pdf
[101] لماذا زر تصدير التقرير الرسمي لا يعمل؟
[102] لا يتم تصدير التقرير اقترح فتح popup بها متحوى التقرير ويوجد زران طباعة و حفظ pdf لا يظهران في الطباعة
[103] اجعل الشريط السفلي يحتوي على جميع أقسام الموقع مثل القائمة الجانبية واجعل الشريط السفلي scrollable
[104] يوجد lagging في الصفحات وأثناء اللمس التنقل والاستجابة
[105] يوجد lagging في الصفحات وأثناء اللمس التنقل والاستجابة
[106] لقد قمت باسترجاع نسخة مستقرة الآن ماذا إذا أضفنا resolution wizard لمساعدة مالك النطام أو المطور في اصلاح المشاكل أو الثغرات الموجودة بالتقرير النظام أحدى المشكلات أو الثغرات والمطور يقوم بالاختبار ثم يقوم باعتماد الإصلاح فيثبت داخل الكود الأساسي مع وجود ميزة استرجاع التعديلات history لزيادة الأمان والمرونة أيضا إنشاء نظام system backup لحفظ نسخة من ملفات النظام محليا وإسترجاعها عند الحاجة أخيرا حفظ نسخة من قاعدة البيانات تكون مشفرة تشفيرا عالي جدا وعند ارجاعها في النظام تفك التشفير وتعمل بكفاءة ما رأيك أنت كخبير؟
[107] تفاصيل الثغرة غير ظاهرة بالبطاقات Screenshot_20260117_113948_Chrome.jpg
[108] كيف للمطور تجربة إصلاح الثغرة قبل اعتماد الإصلاح يجب أن يكون هناك إمكانية تصفح عملي حي حقيقي أو الاطلاع على الكود بعد الاصلاح وإضهار الفرق بين الكودين Screenshot_20260117_114455_Chrome.jpg
[109] هذا كله عظيم لكنه يستخدم بيانات mocking المطلوب تطبيق التقرير واقعيا على جميع ملفات النظام الحالى واخراج النتائج الفعلية سواء أمنية خاصة بالثغرات وcybersecurity وهكذا أو تقنية خاصة بالسرعة والكفاءة والاستجابة وهكذا
[110] أضف زر إعادة الاختبار وميزر roll back , و history فعلية وحقيقية
[111] لم يتم الاصلاح رغم الاعتماد للإصلاح لم تتاح للمطور فرصة تجربة حية وواقعية لما سيحدث واقعيا للصفحة بعد تغيير الكود في sand box وقبل الاعتماد Screenshot_20260117_120100_Chrome.jpg
[112] أيضا تقرير فحص كفاءة وسرعة وتنافسية تطبيق الأب منصة الويب والثغرات الأمنية به
[113] تذكر محتويات التقرير أولًا – تحليل أمني كامل للنظام (Cybersecurity Assessment) قم بتحليل جميع ملفات الأكواد البرمجية المرفقة وتحليل النظام من جميع الجوانب الأمنية، بما يشمل على الأقل: فحص الثغرات البرمجية في الأكواد المصدرية (Code Vulnerabilities) تحليل نقاط الضعف المحتملة في: المصادقة Authentication التفويض Authorization إدارة الجلسات Session Management فحص أمان: تخزين البيانات الحساسة التشفير Encryption حماية مفاتيح API وبيانات الاعتماد تحليل أمان الاتصال بالشبكة: HTTPS / TLS حماية API Endpoints هجمات Man-in-the-Middle تحليل قابلية النظام للتعرض لهجمات مثل: SQL Injection XSS CSRF Insecure Direct Object References مراجعة صلاحيات التطبيقات والصلاحيات الممنوحة للمستخدمين تحليل أمان تخزين الملفات المؤقتة وملفات الكاش مراجعة مكتبات الطرف الثالث (Third-party Libraries) من حيث: تحديثاتها وجود ثغرات معروفة بها تقييم أمان نظام تسجيل الأحداث Logging فحص أي بيانات حساسة مكشوفة داخل الكود ثانيًا – تحليل الأداء التقني للنظام قم بتحليل شامل للأداء التقني من الجوانب التالية: سرعة استجابة النظام Response Time استهلاك الذاكرة Memory Usage استهلاك المعالج CPU Usage كفاءة استعلامات قواعد البيانات قابلية التوسع Scalability إدارة الأخطاء Exception Handling جودة تنظيم الأكواد Architecture Quality زمن تحميل الصفحات أو الواجهات كفاءة الاتصالات مع الخوادم الخارجية استقرار النظام تحت الضغط Load Handling ثالثًا – تحليل الجودة البرمجية تنظيم الكود ونمط الكتابة Code Style الالتزام بأفضل الممارسات Best Practices قابلية الصيانة Maintenance قابلية الاختبار Testing جودة هيكلة المشروع الفصل بين الطبقات Separation of Concerns رابعًا – تقرير التوصيات أريد منك في نهاية التقرير إنشاء قسم خاص بعنوان: Recommendations & Action Plan وفيه يتم تقديم: قائمة توصيات عملية لتحسين الأمان قائمة توصيات لتحسين الأداء اقتراحات لتحسين بنية النظام حلول برمجية مباشرة قابلة للتنفيذ ويجب أن تكون التوصيات: مصنفة حسب: درجة الخطورة (High – Medium – Low) الأولوية (Critical – Important – Optional) مع شرح تقني مختصر لكل توصية مع أمثلة كود عند الحاجة خامسًا – قسم “المتابعة الدورية حسب أحدث مستجدات الأمن السيبراني” أضف داخل التقرير قسمًا مستقلًا بعنوان: Continuous Security Monitoring & Emerging Threat Updates وفي هذا القسم مطلوب منك: الاطّلاع على أحدث المستجدات عالميًا في: أمن المعلومات اكتشاف الثغرات (0-day, CVEs) تحديثات الأطر والمكتبات الشائعة أساليب الهجوم الحديثة (TTPs) تصميم آلية “متابعة دورية” داخل النظام (أو ضمن سير العمل DevSecOps) تشمل: فحص دوري للثغرات في المكتبات (SCA) فحص ثابت للكود (SAST) فحص ديناميكي للتطبيق (DAST) عند توفر بيئة تشغيل فحص إعدادات الخادم/البيئة (Security Misconfiguration) إعداد تقارير دورية تلقائية تُرسل إلى مدير النظام (System Admin / Security Owner) تتضمن: الحالة الأمنية الحالية (Security Posture Summary) الحالة التقنية والأدائية (Performance/Health Summary) قائمة بالمشكلات المفتوحة، وما تم إصلاحه، وما هو قيد المتابعة توصيات شهرية/أسبوعية للتحسين حسب ما يظهر من نتائج الفحص تصميم نظام “تنبيه عاجل وفوري” (Immediate Alerts) بحيث: يتم إرسال رسالة عاجلة فورية فور اكتشاف أي: ثغرة حرجة تسريب بيانات/مفاتيح نمط هجوم أو سلوك مشبوه خلل أمني في المصادقة/التفويض فشل أمني في TLS/HTTPS ويجب أن توضح الرسالة: مستوى الخطورة مكوّن النظام المتأثر سبب الاشتباه / الدليل الإجراء المقترح فورًا (Mitigation) اقترح قنوات إرسال التقارير والتنبيهات مثل: Email Slack / Teams Webhook لوحة متابعة داخلية Dashboard إشعارات Push (إن كانت مناسبة للنظام) قدّم “خطة تطبيق” عملية خطوة بخطوة لتنفيذ المتابعة الدورية والتنبيهات، مع أمثلة إعدادات أو كود عند الحاجة. سادسًا – المطلوب منك تحديد أخطر ثغرات حالية في النظام أهم تحسينات أداء مقترحة خطة تنفيذ مرتبة زمنيًا لإصلاح النظام خطوة بخطوة ملاحظة مهمة لا تقم بتغيير أي وظيفة حالية في النظام. المطلوب فقط: التحليل التقييم التقرير التوصيات التقنية
[114] ممتاز الآن لنبدأ تجربة إصلاح الثغرة الحرجة Screenshot_20260117_170313_Chrome.jpg
[115] زر إعادة فحص المكونات لا يعمل كيف أتأكد أنه تم حقن الإصلاحات و تصحيح الثغرات؟
[116] ممتاز لكن بعد الفحص ظهرت الثغرات لم يتم إصلاحها مطلوب الإصلاح يكون حقيقي وليس وهمي
[117] مطلوب أيضا rollback حقيقي وفعلي وليس وهمي
[118] كيف نتحول إلى التسجيل في قاعدة البيانات وليس local storage لتصبح دائمة يمكن للمطور الاطلاع عليها من أي مكان؟
[119] الميزة هذه ستكون قاصرة فقط على فئة Release Manager, Developer,Incident Responder (SOC Analyst), System Administrator (SRE/Infra), Platform Super Admin ولن تكون متوفرة للمستخدم العادي سواء الأب أو أي من أعضاء أسرته
[120] [1] ## نعم… توزيع الأدوار الذي وضعته “قوي جدًا” كبداية — لكنه يحتاج طبقات إضافية ليصبح مؤسسيًا بالكامل [1.1] ما طرحته يغطي محور الأسرة (Family Tenant) بشكل ممتاز، ويغطي محور التشغيل (Platform Ops) بشكل عام. [1.2] لكن لكي يصبح النظام “شبيه Bark وأكثر ذكاءً + مؤسسي + قابل للتوسع” تحتاج إضافة أدوار تخدم 4 احتياجات: حماية الطفل داخل الأسرة بدون أي تسريب صلاحيات مراجعة الأدلة والتحقيق داخل الأسرة بشكل مضبوط تشغيل المنصة عالميًا بدون امتلاك صلاحيات خطيرة فصل الواجبات (Separation of Duties) حتى لا يكون شخص واحد قادرًا على فعل كل شيء [2] ## أدوار الأسرة المقترحة (Family Tenant Roles) — هذا هو قلب المنتج [2.1] Caption: الأدوار داخل الأسرة (المستأجر الأسري) الدور الوصف صلاحيات أساسية صلاحيات ممنوعة (Hard Deny) Father (Family Owner) مدير الأسرة والمالك إضافة/إزالة أعضاء، ربط الأجهزة، تعديل السياسات، الاطلاع على الأدلة، حذف الأدلة، تصدير Evidence Package لا شيء (هو أعلى صلاحية داخل الأسرة) Mother (Co-Admin محدود) مشرف أسري بصلاحيات أقل الاطلاع على التقارير والتنبيهات، تعديل أوضاع النوم/المذاكرة، إجراءات حماية فورية (Kill/Lock) حسب السياسة حذف الأدلة، تغيير إعدادات الحساسية القصوى، إزالة الأجهزة/الأطفال Child (Managed Profile) مستخدم مُدار واجهة بسيطة جدًا: طلب إذن، SOS، تلقي تعليمات الوالد الاطلاع على الأدلة، تعطيل الحماية، تغيير السياسات Device (Child Device Identity) هوية جهاز الطفل تنفيذ السياسات، إرسال الأحداث/الأدلة أي صلاحيات بشرية [2.2] أدوار إضافية داخل الأسرة “مهمّة جدًا” إذا تريد نظام مؤسسي/قابل للتوسع: Family Auditor (قارئ أدلة فقط): مثل “الأم” لكن بنسخة قراءة فقط (Read-only) بدون قدرة تنفيذ إجراءات قفل. Emergency Guardian (وصي طوارئ): حساب احتياطي (مثل عم/جد) يتم تفعيله فقط في حالات محددة وبصلاحيات مقيدة جدًا. Teen Restricted Admin (للمراهق تحت إشراف): بعض الأسر تريد منح المراهق صلاحية إدارة وقته ضمن حدود (Self-Management) بدون صلاحيات خطيرة. هذه الأدوار ليست رفاهية: هي تقلل الصدام داخل الأسرة، وتمنع “أم لديها كل شيء” أو “أب وحده يملك كل شيء” من خلق مخاطرة تشغيلية. [3] ## أدوار المنصة العامة (Platform Roles) — تحتاج تفصيل أدق من قائمتك الحالية أنت ذكرت: إشراف عام، مطور، أمن معلومات، مدير النظام، دعم فني. هذا جيد، لكن مؤسسيًا نحتاج تفكيكها لتجنب “صلاحية خارقة واحدة”. [3.1] Caption: الأدوار المقترحة لإدارة المنصة (Platform Ops) الدور ماذا يفعل ماذا لا يُسمح له إطلاقًا Platform Super Admin إعدادات عامة حرجة، مفاتيح تكامل أساسية، سياسة تشغيل عالية المستوى الاطلاع على أدلة الأسر أو محتواها System Administrator (SRE/Infra) تشغيل السيرفرات، مراقبة الأداء، إدارة الشبكات/الخدمات الوصول لمحتوى الأدلة، تعديل بيانات الأسر Security Officer / CISO Role سياسات أمن، مراجعة المخاطر، فرض MFA، إعداد WAF/Rate Limit تغيير بيانات المستخدمين أو حذف أدلة Privacy Officer (DPO-like) إدارة الخصوصية والامتثال، طلبات تنزيل/حذف البيانات وفق السياسة أي وصول لمحتوى الأدلة Evidence Vault Custodian إدارة مخزن الأدلة كمنظومة (Keys/Retention/Immutability) رؤية محتوى الأدلة نفسها (Zero Knowledge قدر الإمكان) Support Agent (Tier 1) حل مشاكل تسجيل الدخول والربط وواجهة المستخدم لا يرى أدلة، لا يرى محتوى رسائل/صور Support Specialist (Tier 2) مشاكل تقنية أعلى (Agent pairing, device compliance) لا يستطيع تعطيل سياسات حماية أو فك قفل جهاز الطفل مباشرة Incident Responder (SOC Analyst) يحقق في هجمات ضد المنصة نفسها (ليس ضد الأطفال) أي وصول لأدلة الأسر Developer تطوير الكود والنشر عبر CI/CD لا يملك مفاتيح الإنتاج ولا بيانات العملاء Release Manager إدارة الإصدارات والتحديثات والإطلاق لا يقرأ بيانات الإنتاج Billing / Finance Operator الفواتير والاشتراكات لا يرى أدلة ولا بيانات حساسة [3.2] لماذا هذا التفكيك مهم؟ لأن وجود “مدير النظام” بصلاحيات واسعة + “الدعم” + “المطور” في نفس الحدود قد يؤدي إلى: خطر إساءة استخدام داخلي خطأ بشري يمس بيانات الأطفال صعوبة اجتياز أي تدقيق أمني مؤسسي [4] ## أهم إضافة ناقصة في سؤالك: “دور محرك الأتمتة الذكي” ككيان مستقل (Autonomous Safety Engine) [4.1] أنت تصف نظام يعمل تلقائيًا: يغلق تطبيق، يحجب الإنترنت، يقفل الكاميرا/الميكروفون، يضع شاشة سوداء… إلخ. هذا يعني أنك تحتاج كيان رسمي اسمه مثلًا: Autonomous Safety Engine (ASE): خدمة قرار آلي (Decisioning) ويُعامل كـ Non-Human Actor له صلاحيات محددة للغاية ومُقيدة بسياسات. [4.2] Caption: صلاحيات محرك الأتمتة (ASE) الإجراء الآلي مسموح؟ بشروط إغلاق تطبيق محادثة/لعبة نعم عند Threat ≥ High + سياسة الأسرة تسمح حجب الإنترنت جزئيًا نعم مؤقتًا + قابل للاستثناء من الأب تعطيل Camera/Mic نعم عند Sexual Grooming / Extortion indicators شاشة سوداء Lockdown نعم عند Threat = Critical + شدة عالية + تفعيل مسبق من الأب تصدير الأدلة لا تصدير يدوي من الأب فقط [5] ## “هل هذا يكفي؟” — الإجابة الدقيقة: يكفي كإطار، لكن يلزم إضافة 3 طبقات أدوار أمنية حاسمة [5.1] ### الطبقة الأولى: أدوار الأسرة (أنت ممتاز فيها) لكن أضف: Family Auditor (Read-only) Emergency Guardian Teen Self-Management (اختياري) [5.2] ### الطبقة الثانية: أدوار التشغيل (Platform Ops) — تفكيك مدير النظام أضف: Privacy Officer Evidence Vault Custodian SOC Incident Responder Release Manager Billing Operator [5.3] ### الطبقة الثالثة: أدوار غير بشرية (Service Accounts) أهمها: Policy Engine Safety Engine Evidence Signer Notification Service كل واحدة بصلاحيات “أضيق ما يمكن”. [6] ## قواعد ذهبية لتوزيع الصلاحيات على نظامك بالذات (لأن فيه أدلة رقمية وقرارات فورية) [6.1] قاعدة 1: لا أحد خارج الأسرة يرى الأدلة حتى لو عندك “الدعم الفني”، يجب أن يكون: يرى “تشخيصات تقنية” فقط (سبب عدم وصول إشعار، حالة الجهاز) ولا يرى محتوى صور/نصوص/صوت/فيديو [6.2] قاعدة 2: الحذف لا يكون إلا للأب (Family Owner) وحتى الأب، الحذف يجب أن يمر بـ: تأكيد متعدد (Double Confirm) وربما “فترة تهدئة” 30 ثانية وتسجيل تدقيق غير قابل للحذف [6.3] قاعدة 3: فصل الصلاحيات الحساسة مثال: من يستطيع تعديل سياسة “Lockdown Screen” ليس نفس من يستطيع تنفيذها يدويًا. [6.4] قاعدة 4: دعم العملاء لا يملك زر “فك قفل جهاز الطفل” هذا زر خطر جدًا ويستغل بسهولة. [6.5] قاعدة 5: الإجراءات الآلية يجب أن تكون قابلة للضبط لكل أسرة أنت قلت “إعدادات تخصيص لكل حالة” وهذا صحيح تمامًا: Grooming Sexual Exploitation Bullying Self-harm risk Stranger Danger / Luring كل حالة لها بروتوكول مختلف. [7] ## نقطة مهمة جدًا حول “0.05 ثانية وZero latency” [7.1] هذا ممتاز كـ هدف تصميم (Design Target)، لكن عمليًا: إذا كان جزء من التحليل يتم على الجهاز (On-device models) فستقترب جدًا من “زمن شبه لحظي”. أما لو اعتمدت على السحابة فستتأثر بزمن الشبكة. [7.2] أفضل تصميم لتلبية هذا الهدف: قرار فوري محلي (On-device) للإجراءات الحرجة ثم إرسال “ملخص الأدلة” + “توثيق إضافي” للسحابة لاحقًا (بدون وعود زمنية مطلقة، لأن ذلك يعتمد على عتاد الهاتف ونوع الموديل وتشغيل النظام والتحميل.) [8] ## هل يوجد المزيد من الأدوار؟ نعم… وهذه القائمة النهائية التي ستغطي كل شيء بدون تضخم [8.1] أدوار الأسرة (أساسية + احترافية) Father (Owner) Mother (Limited Co-Admin) Family Auditor (Read-only) Emergency Guardian (Restricted) Child (Managed) Device Identity (Non-human) [8.2] أدوار المنصة (مؤسسية) Platform Super Admin System Admin (Infra/SRE) Security Officer Privacy Officer Evidence Vault Custodian Support Tier 1 Support Tier 2 Incident Responder (SOC) Developer (No prod data) Release Manager Billing Operator [8.3] حسابات خدمات (Service Accounts) Policy Engine Autonomous Safety Engine Evidence Signer Notification Service Telemetry Ingestor
[121] [1] ## وثيقة RBAC الرسمية (الإصدار 1) لنظام رقابة أبوية + أدلة رقمية (Family-Only Evidence) [1.1] مبدأ التصميم كل أسرة = Tenant مستقل (Family Tenant). لا أحد خارج الأسرة يرى محتوى الأدلة إطلاقًا. منصة التشغيل ترى فقط بيانات تشغيل تقنية (Diagnostics/Health) بدون محتوى حساس. [1.2] الكيانات الأساسية في النظام (Resources) family : الأسرة ككيان member : فرد داخل الأسرة (أب/أم/طفل) device : جهاز الطفل المُدار policy : سياسة حماية mode : وضع ذكي (نوم/مذاكرة/خروج…) event : حدث Telemetry evidence : دليل محفوظ داخل خزنة الأسرة custody : سلسلة العهدة داخل الأسرة alert : تنبيه فوري realtime : بث حي (كاميرا/صوت/لقطات شاشة) export : تصدير حزمة أدلة [2] ## قاموس الصلاحيات (Permission Taxonomy) — صيغة معيارية قابلة للتطبيق مباشرة [2.1] Caption: قائمة الصلاحيات (Scopes) الأساسية Scope الوصف family.manage إدارة الأسرة (إعدادات عامة/فواتير داخل الأسرة/مفاتيح طوارئ) member.invite دعوة عضو (الأم/وصي طوارئ) member.remove إزالة عضو child.manage إدارة ملفات الأطفال داخل الأسرة device.enroll ربط جهاز طفل بالنظام device.remove إزالة جهاز من الإدارة device.lock قفل الجهاز (Lockdown) device.unlock فك القفل device.network.block حجب الإنترنت device.network.allow السماح device.camera.block حجب الكاميرا device.mic.block حجب الميكروفون policy.read قراءة السياسات policy.write تعديل السياسات mode.read قراءة الأوضاع mode.write إنشاء/تعديل الأوضاع alert.read قراءة التنبيهات alert.ack تأكيد الاستلام والاطلاع evidence.read قراءة الأدلة evidence.create إنشاء دليل من حدث evidence.delete حذف دليل (مقيد جدًا) evidence.export تصدير حزمة الأدلة custody.read قراءة سلسلة العهدة custody.append إضافة حدث عهدة (عرض/تصدير/تعليق) realtime.screenshot.view عرض لقطات الشاشة realtime.audio.listen الاستماع للصوت realtime.camera.view بث كاميرا مباشر walkie.talk محادثة فورية مع الطفل safety.playbook.read قراءة بروتوكولات الدفاع safety.playbook.write تعديل بروتوكولات الدفاع (حساس جدًا) [3] ## أدوار الأسرة (Family Roles) — النسخة النهائية المعتمدة [3.1] Caption: أدوار الأسرة والصلاحيات الأساسية الدور صلاحيات مسموحة ملاحظات Father (Family Owner) كل شيء داخل الأسرة بما فيها evidence.delete و evidence.export و safety.playbook.write أعلى صلاحية Mother (Limited Co-Admin) كل شيء ما عدا الحذف والتصدير وتعديل بروتوكولات الدفاع تنفيذ إجراءات حماية مسموح Family Auditor (Read-only) policy.read, mode.read, alert.read, evidence.read, custody.read بدون تنفيذ إجراءات Emergency Guardian (Restricted) alert.read, walkie.talk, device.lock (اختياري), device.network.block (اختياري) يُفعّل بشروط Child (Managed) alert.read (رسائل توجيهية فقط), walkie.talk (استقبال/نداء) لا تحكم Device Identity (Non-human) evidence.create, event.write, تنفيذ policy محليًا صلاحيات تقنية فقط [4] ## قواعد المنع الإجباري (Hard Deny Rules) — تمنع أخطر السيناريوهات [4.1] Caption: قواعد منع غير قابلة للتجاوز القاعدة المنع الأم لا تحذف أدلة DENY Mother -> evidence.delete الأم لا تصدر أدلة DENY Mother -> evidence.export أي دور خارج الأسرة لا يقرأ الأدلة DENY PlatformRoles -> evidence.read الدعم الفني لا يفك قفل جهاز الطفل DENY Support -> device.unlock الدعم الفني لا يشاهد بث حي DENY Support -> realtime.* المطور لا يصل للإنتاج ولا بيانات الأسر DENY Developer -> prod_data_access وصي الطوارئ لا يرى الأدلة DENY EmergencyGuardian -> evidence.read (إلا لو الأب فعّل استثناء واضح) [5] ## نموذج التفويض السياقي ABAC فوق RBAC (مهم جدًا لذكاء النظام) [5.1] هنا نضيف شروطًا حسب الحالة فوق صلاحيات الدور: [5.2] Caption: أمثلة ABAC شرطية العملية الشرط السياقي device.lock ThreatLevel ≥ High AND ParentConfirmed OR AutoPlaybookEnabled realtime.camera.view الطفل عمره < 13 AND FamilyOwnerConsentEnabled realtime.audio.listen فقط عند ThreatLevel ≥ High OR ManualRequestByOwner evidence.export Father فقط + MFA + سبب تصدير مكتوب evidence.delete Father فقط + MFA + WaitingPeriod 30s + سجل تدقيق دائم [6] ## بروتوكولات الدفاع الآلية (Auto-Defense Playbooks) — تصميم عملي جاهز للتنفيذ [6.1] تعريف Playbook = مجموعة إجراءات دفاعية متسلسلة تُنفّذ آليًا عند تحقق شروط معيّنة. [6.2] مستويات الخطورة (Threat Levels) Low : غير مقلق (ملاحظة) Medium : يحتاج تنبيه للوالدين High : يحتاج تدخّل فوري (حجب/قفل جزئي) Critical : إغلاق شامل/شاشة سوداء + تصعيد قوي [7] ## Playbook 1: التنمر (Bullying) [7.1] شروط التفعيل تكرار كلمات مهينة/تهديدية خلال نافذة زمنية قصيرة اكتشاف نمط عدائي متواصل بلاغ الطفل (SOS) [7.2] Caption: إجراءات الدفاع الآلي للتنمر الترتيب الإجراء افتراضي؟ قابل للتخصيص؟ 1 حفظ Evidence تلقائيًا نعم نعم 2 إرسال تنبيه فوري للأب والأم نعم نعم 3 قفل تطبيق المحادثة لمدة 10 دقائق نعم نعم 4 تفعيل وضع “تهدئة” (Focus Mode) اختياري نعم 5 فتح Walkie-Talkie للوالدين نعم نعم [8] ## Playbook 2: استدراج/تحرش جنسي (Grooming / Sexual Harassment) [8.1] شروط التفعيل (أمثلة) كلمات/تلميحات جنسية + طلب صور/خصوصية محاولة نقل المحادثة لمنصة أخرى تهديد أو ابتزاز [8.2] Caption: إجراءات الدفاع الآلي للاشتباه الجنسي الترتيب الإجراء افتراضي؟ ملاحظات 1 حفظ Evidence (نص + لقطات شاشة + Metadata) نعم بدون حذف للأم 2 إيقاف تطبيق المحادثة/اللعبة فورًا نعم Kill switch 3 حجب الإنترنت مؤقتًا نعم Internet Quarantine 4 تعطيل Camera/Mic نعم لمنع الاستدراج 5 تفعيل شاشة تحذير داخل جهاز الطفل نعم رسالة واضحة 6 إرسال تقرير للوالدين بالإجراء الآلي نعم مع خيار “تصعيد” [9] ## Playbook 3: ابتزاز/استغلال (Sextortion / Exploitation) [9.1] تعريف عملي داخل النظام طلب محتوى جنسي + تهديد بنشره طلب مال/بطاقات/تحويل طلب مقابلة أو مشاركة موقع [9.2] Caption: الدفاع الآلي للاشتباه بالابتزاز الترتيب الإجراء افتراضي؟ 1 Evidence شامل + Chain-of-custody نعم 2 شاشة سوداء فوق الكل (Lockdown Overlay) نعم (Critical فقط) 3 منع فتح أي تطبيقات تواصل نعم 4 السماح فقط بتطبيقات “الطوارئ” نعم 5 Walkie Talkie إجباري + إشعار عالي نعم [10] ## Playbook 4: خطر إيذاء النفس (Self-Harm Risk) — حماية إنسانية + خصوصية [10.1] شروط التفعيل كلمات مثل: “أريد أن أنهي حياتي” / “لا أستطيع” / “أنا وحيد” مؤشرات اكتئاب متكرر نمط زمني (ليلي) + عزلة [10.2] Caption: إجراءات دفاع غير عدوانية (Soft-Intervention) الترتيب الإجراء افتراضي؟ لماذا؟ 1 تنبيه الأب والأم بسرّية عالية نعم تدخل إنساني 2 تشغيل وضع دعم (Support Mode) نعم يقلل الضغط 3 تفعيل Walkie Talkie للوالدين نعم تواصل مباشر 4 حجب المحتوى المؤذي (حسب الفئات) نعم تقليل محفزات 5 عدم قفل الجهاز فورًا افتراضيًا لا لتجنب التصعيد النفسي [11] ## الأوضاع الذكية (Smart Modes) — تصميم “مؤسسي” للأوضاع [11.1] النظام ليس مجرد جدول وقت بل “وضع” = سياسة مركبة تشمل: شبكة تطبيقات إشعارات حساسية كشف مستوى لقطات الشاشة صلاحيات الكاميرا/الميكروفون مكان/جيوفينس [11.2] Caption: أمثلة أوضاع جاهزة الوضع ماذا يفعل لمن Study Mode يسمح تطبيقات الدراسة فقط + حجب تواصل المدرسة/البيت Sleep Mode قفل كامل + سماح مكالمات الطوارئ ليلًا Outdoor Mode GPS قوي + تنبيهات مناطق خارج المنزل Travel Mode تخفيف قيود لكن مع رصد أعلى سفر High-Risk Mode حساسية قصوى + دفاعات أسرع حالات سابقة [12] ## “مخزن الأدلة للأسرة” — مواصفات التشغيل داخل النظام [12.1] داخل كل أسرة يوجد: Evidence Items Custody Chain Exports Registry “من قرأ ماذا ومتى؟” [12.2] Caption: إجراءات الوصول للأدلة داخل الأسرة العملية Father Mother Auditor عرض دليل نعم نعم نعم إضافة تعليق/ملاحظة نعم نعم لا (اختياري) حذف دليل نعم لا لا تصدير حزمة أدلة نعم لا لا وضع Legal Hold نعم لا لا [13] ## أدوار المنصة العامة (Platform Roles) — النسخة المؤسسية المختصرة بدون تضخم [13.1] Caption: الحد الأدنى المطلوب لتشغيل عالمي نظيف الدور مسؤولية أهم منع Platform Super Admin إعدادات منصة عامة لا Evidence Security Officer أمن المنصة لا بيانات أسر Privacy Officer الخصوصية والامتثال لا محتوى أدلة SRE/Infra Admin تشغيل الخوادم لا محتوى أدلة Support Tier 1/2 دعم فني لا Evidence ولا Live SOC Responder حوادث المنصة لا Evidence Developer تطوير لا إنتاج [14] ## إضافة مهمة جدًا: “إدارة صلاحيات الإجراءات الحية” (Live Intervention Controls) [14.1] لأنك ذكرت: بث كاميرا مباشر الاستماع للصوت لقطات شاشة دورية هذه أخطر نقطة في المنتج، فلازم نظام تحكم عالي: [14.2] Caption: ضوابط الوصول للبث الحي ميزة Live الوضع الافتراضي التفعيل Live Camera OFF Father فقط (مع خيار للأم إذا فعّله الأب) Live Audio OFF Father + Mother (عند High/Critical) Screenshots Periodic محدود حسب وضع الجهاز ووقت اليوم Walkie Talkie ON للأب والأم دائمًا [15] ## هل تحتاج أدوار إضافية؟ فقط “اثنين” إذا أردته منتج عالمي جدًا [15.1] Safeguarding Officer (داخل الأسرة اختياري) للأسر التي لديها مربية/وصي دائم لكن بدون أدلة وبدون بث مباشر [15.2] Family Recovery Admin (استرجاع الأسرة) حساب استرجاع مؤمن جدًا يُستخدم فقط لو الأب فقد الحساب ينفذ عبر إجراءات تحقق قوية (وليس دعم عادي) [16] ## Suggested Next Steps [16.1] سأحوّل هذه الوثيقة إلى مصفوفة صلاحيات كاملة “جاهزة للبرمجة” (Permissions JSON + Deny Rules). [16.2] بعد ذلك مباشرة أكتب لك مخطط قاعدة البيانات النهائي v1 المتوافق مع كل ما سبق (Tenants/Principals/Devices/Events/Evidence/Custody/Audit). [16.3] ثم أضع لك سيناريوهات تنفيذ دقيقة للأوامر الحرجة على Android (قفل/حجب/Overlay/Camera/Mic) ضمن بروتوكولات الدفاع الآلي.
[122] [1] ## مصفوفة الصلاحيات التنفيذية (RBAC Matrix) — نسخة جاهزة للتحويل إلى كود [1.1] مبدأ التنفيذ سنعتبر كل عملية في النظام “إذن” (Permission) بصيغة: resource.action ثم نعرّف لكل دور: allow[] deny[] (قواعد منع صلبة لا تتأثر بأي Allow) [2] ## تعريف الصلاحيات (Permissions Registry) — قاموس موحّد [2.1] Caption: Permissions Registry (الحد الأدنى + الحساس) الفئة الصلاحيات إدارة الأسرة family.read, family.update, family.manage_security الأعضاء member.invite, member.update_role, member.remove, member.view_activity الأطفال child.create, child.update, child.remove, child.view_reports الأجهزة device.enroll, device.rename, device.remove, device.view_status التحكم بالجهاز device.lock, device.unlock, device.blackout_overlay الشبكة device.net.block, device.net.allow, device.net.limited التطبيقات device.app.block, device.app.allow, device.app.kill, device.app.time_limit الكاميرا/الميكروفون device.camera.block, device.camera.allow, device.mic.block, device.mic.allow الموقع device.location.view_live, device.location.view_history, geofence.create, geofence.update, geofence.delete لقطات الشاشة realtime.screenshot.request, realtime.screenshot.schedule الصوت الحي realtime.audio.listen, realtime.audio.request_clip الكاميرا الحية realtime.camera.view_live, realtime.camera.request_clip Walkie-Talkie walkie.talk, walkie.listen السياسات policy.read, policy.write, policy.assign الأوضاع الذكية mode.read, mode.write, mode.apply التنبيهات alert.read, alert.ack, alert.configure الأدلة evidence.read, evidence.create, evidence.tag, evidence.delete, evidence.export سلسلة العهدة custody.read, custody.append بروتوكولات الدفاع playbook.read, playbook.write, playbook.toggle التقارير والتحليلات report.read, report.export مفاتيح التكامل api_key.create, api_key.rotate, api_key.revoke هذا القاموس هو “مفتاح الاستقرار” لأن أي إضافة مستقبلًا ستكون بإضافة Permission جديدة دون كسر النظام. [3] ## RBAC للأدوار داخل الأسرة (Family Tenant) — النسخة النهائية [3.1] Caption: RBAC Matrix (Family Roles) الدور Allow Deny (Hard) Father (Owner) * داخل الأسرة لا شيء Mother (Limited Co-Admin) كل شيء ما عدا الحذف والتصدير والبروتوكولات الحرجة evidence.delete, evidence.export, playbook.write, family.manage_security, member.update_role (اختياري) Family Auditor (Read-only) family.read, child.view_reports, policy.read, mode.read, alert.read, evidence.read, custody.read, report.read كل أوامر التحكم والتنفيذ الحي والحذف والتصدير Emergency Guardian (Restricted) alert.read, alert.ack, walkie.talk, walkie.listen, device.lock (اختياري), device.net.limited (اختياري) evidence.read, realtime.*, policy.write, device.unlock, evidence.export, evidence.delete Child (Managed) alert.read (رسائل فقط), walkie.talk (طلب مساعدة), walkie.listen كل شيء آخر Device Identity (Non-human) device.view_status, evidence.create, custody.append (للتسجيل الفني), alert.create (خدمة داخلية), event.write أي صلاحيات بشرية (حذف/تصدير/بث حي) [4] ## نموذج ABAC (شروط سياقية) فوق RBAC — لمنع إساءة الاستخدام [4.1] Caption: شروط سياقية حساسة Permission شرط التنفيذ (ABAC) device.blackout_overlay threat_level == CRITICAL AND father_enabled_blackout == true realtime.camera.view_live father_enabled_live_camera == true AND (threat_level >= HIGH OR manual_owner_request) realtime.audio.listen threat_level >= HIGH OR manual_owner_request realtime.screenshot.schedule ممنوع أثناء Sleep Mode إلا بموافقة الأب evidence.export actor_role == Father AND mfa_passed == true AND export_reason != empty evidence.delete actor_role == Father AND mfa_passed == true AND cooldown_timer_passed == true device.unlock ممنوع إذا auto_lock_reason == CRITICAL_THREAT إلا بعد “تأكيد الأب” [5] ## JSON جاهز للتطبيق (Roles → Allow/Deny) — نسخة “Production-Like” هذا مثال عملي يمكنك وضعه في permissions.json مباشرة. { "roles": { "FAMILY_OWNER": { "allow": [" "], "deny": [] }, "FAMILY_COADMIN_LIMITED": { "allow": [ "family.read", "family.update", "member.invite", "member.remove", "child.create", "child.update", "child.view_reports", "device.enroll", "device.rename", "device.view_status", "device.lock", "device.net.block", "device.net.allow", "device.net.limited", "device.app.block", "device.app.allow", "device.app.kill", "device.app.time_limit", "device.camera.block", "device.camera.allow", "device.mic.block", "device.mic.allow", "device.location.view_live", "device.location.view_history", "geofence.create", "geofence.update", "alert.read", "alert.ack", "alert.configure", "policy.read", "policy.write", "policy.assign", "mode.read", "mode.write", "mode.apply", "evidence.read", "evidence.tag", "custody.read", "report.read" ], "deny": [ "evidence.delete", "evidence.export", "playbook.write", "family.manage_security", "member.update_role", "realtime.camera.view_live" ] }, "FAMILY_AUDITOR_READONLY": { "allow": [ "family.read", "child.view_reports", "policy.read", "mode.read", "alert.read", "evidence.read", "custody.read", "report.read" ], "deny": [ "device.lock", "device.unlock", "device.blackout_overlay", "device.net.block", "device.net.allow", "device.app.block", "device.app.kill", "device.camera.block", "device.mic.block", "realtime.screenshot.request", "realtime.screenshot.schedule", "realtime.audio.listen", "realtime.camera.view_live", "evidence.delete", "evidence.export", "policy.write", "mode.write", "playbook.write" ] }, "EMERGENCY_GUARDIAN_RESTRICTED": { "allow": [ "alert.read", "alert.ack", "walkie.talk", "walkie.listen" ], "deny": [ "evidence.read", "evidence.export", "evidence.delete", "realtime.screenshot.request", "realtime.audio.listen", "realtime.camera.view_live", "device.unlock", "policy.write", "playbook.write" ] }, "CHILD_MANAGED": { "allow": ["alert.read", "walkie.talk", "walkie.listen"], "deny": [" "] }, "DEVICE_IDENTITY": { "allow": ["event.write", "evidence.create", "custody.append", "alert.create", "device.view_status"], "deny": ["evidence.read", "evidence.delete", "evidence.export", "realtime.*"] } } } ملاحظة تنفيذية: في دور CHILD_MANAGED استخدم منطق: allow محدد جدًا، ثم “deny everything else”. [6] ## أدوار المنصة العامة (Platform RBAC) — فصل الواجبات مؤسسيًا [6.1] Caption: Platform Roles (Minimal Enterprise Set) الدور Allow Deny (Hard) Platform Super Admin إعدادات المنصة العامة + إدارة الفوترة العامة + إدارة التهيئة evidence.read, realtime. , child_data_content Security Officer إعدادات أمن المنصة + سياسات المصادقة + مراقبة المخاطر evidence.read, تعديل بيانات الأسر Privacy Officer إدارة سياسات الخصوصية + طلبات تنزيل/حذف وفق القانون evidence.read, realtime. SRE/Infra Admin تشغيل الخوادم + المراقبة + الحوادث التقنية evidence.read, الوصول لمحتوى المستخدم Support Tier 1 تشخيص مشاكل عامة + إرشاد المستخدم أي بث حي + أي Evidence Support Tier 2 مشاكل ربط الأجهزة/الامتثال/الوكيل أي Evidence + أي Unlock مباشر SOC Responder تحقيق هجمات ضد المنصة نفسها أي Evidence أسري Developer التطوير والنشر عبر CI/CD لا Prod DB ولا أسرار إنتاج [7] ## قاعدة البيانات النهائية v1 (Schema) — منسجمة 100% مع Bark-like + Evidence Vault [7.1] قرار معماري مؤسسي قاعدة تشغيل أساسية: core_db مخزن أدلة ملفات: evidence_object_store (Immutable) جداول فهرس الأدلة وسلسلة العهدة: evidence_db سجل التدقيق: audit_db (Append-only) هكذا إذا حصل اختراق في جزء التشغيل لا يسقط “مخزن الأدلة” بنفس السهولة. [8] ## جداول Core DB (إدارة الأسرة، الأعضاء، الأجهزة، السياسات) [8.1] Caption: جدول الأسر (tenants_families) العمود النوع ملاحظة family_id UUID PK معرف الأسرة owner_principal_id UUID الأب name TEXT اسم العائلة plan ENUM free/pro/enterprise created_at TIMESTAMP [8.2] Caption: جدول الهوية الموحد (principals) العمود النوع ملاحظة principal_id UUID PK family_id UUID FK type ENUM father/mother/child/guardian email TEXT للأب/الأم phone TEXT اختياري status ENUM active/locked/disabled created_at TIMESTAMP [8.3] Caption: جدول ربط الأدوار (principal_roles) العمود النوع ملاحظة principal_id UUID role ENUM FAMILY_OWNER/COADMIN/... assigned_by UUID assigned_at TIMESTAMP [8.4] Caption: جدول الأطفال (children_profiles) العمود النوع ملاحظة child_id UUID PK يطابق principal_id age_group ENUM 3-5/6-9/10-12/13-17 risk_profile ENUM low/normal/high notes TEXT للوالد فقط [8.5] Caption: جدول الأجهزة (devices) العمود النوع ملاحظة device_id UUID PK child_id UUID FK platform ENUM android device_model TEXT compliance_state ENUM ok/warn/critical last_seen_at TIMESTAMP agent_version TEXT enrolled_at TIMESTAMP [8.6] Caption: جدول السياسات (policies) العمود النوع ملاحظة policy_id UUID PK family_id UUID name TEXT payload_json JSONB قواعد التحكم version INT updated_by UUID updated_at TIMESTAMP [8.7] Caption: جدول الأوضاع الذكية (modes) العمود النوع ملاحظة mode_id UUID PK family_id UUID name TEXT Sleep/Study/Outdoor mode_payload JSONB تغييرات السياسة created_by UUID [9] ## جدول الأحداث والتحليل (Telemetry) — أساس “الذكاء والاستقلالية” [9.1] Caption: جدول الأحداث (telemetry_events) العمود النوع ملاحظة event_id UUID PK family_id UUID device_id UUID event_type TEXT bullying/grooming/tamper/... severity ENUM low/med/high/critical evidence_candidate BOOLEAN raw_payload JSONB created_at TIMESTAMP [9.2] Caption: جدول “حالة الخطر النفسية” (child_mood_signals) العمود النوع ملاحظة signal_id UUID PK child_id UUID signal_type TEXT loneliness/fear/sadness confidence FLOAT تقدير sample_ref UUID ربط بحدث/دليل عند اللزوم created_at TIMESTAMP هنا الفكرة ليست “تجسس” بل “إشارات دعم” مع سياسة واضحة للأهل. [10] ## Evidence DB (Metadata + Custody + Exports) — بدون محتوى داخل DB [10.1] Caption: جدول فهرس الأدلة (evidence_items) العمود النوع ملاحظة evidence_id UUID PK family_id UUID device_id UUID event_id UUID FK object_uri TEXT مسار الملف في التخزين sha256 TEXT hash content_type TEXT image/audio/video/text classification ENUM normal/restricted/legal_hold created_at TIMESTAMP [10.2] Caption: سلسلة العهدة (evidence_custody_chain) العمود النوع ملاحظة custody_id UUID PK evidence_id UUID actor_principal_id UUID من شاهد/صدّر action ENUM create/view/export/hold/delete_attempt reason TEXT إلزامي للتصدير ip_hash TEXT تجزئة IP (خصوصية) created_at TIMESTAMP [10.3] Caption: سجل تصدير الأدلة (evidence_exports) العمود النوع ملاحظة export_id UUID PK family_id UUID requested_by UUID الأب export_uri TEXT مكان الحزمة export_sha256 TEXT status ENUM ready/expired/revoked created_at TIMESTAMP [11] ## Audit DB (Append-only) — كل شيء يُسجّل بلا استثناء [11.1] Caption: سجل التدقيق المؤسسي (audit_logs) العمود النوع ملاحظة audit_id UUID PK family_id UUID actor UUID action TEXT policy.update / device.lock target TEXT device_id/evidence_id metadata JSONB created_at TIMESTAMP Append-only [12] ## بروتوكولات “الدفاع الآلي” كـ JSON (Playbooks) — جاهزة للتطبيق [12.1] مثال: Grooming Playbook { "playbook_id": "PB_GROOMING_V1", "name": "Grooming / Sexual Harassment Defense", "enabled": true, "trigger": { "event_type": "grooming", "severity_min": "high" }, "actions": [ { "type": "EVIDENCE_CREATE", "params": { "include": ["text", "screenshot", "metadata"] } }, { "type": "APP_KILL", "params": { "apps": ["messenger", "game_chat", "browser"] } }, { "type": "NET_BLOCK", "params": { "mode": "quarantine", "duration_sec": 900 } }, { "type": "CAMERA_BLOCK", "params": { "enabled": true } }, { "type": "MIC_BLOCK", "params": { "enabled": true } }, { "type": "ALERT_SEND", "params": { "to": ["father", "mother"], "priority": "urgent" } } ], "constraints": { "deny_export_to": ["mother", "support"], "blackout_overlay_requires_owner_optin": true } } [13] ## Android Agent (Device Control) — تنفيذ تقني منطقي بدون تفاصيل خطرة [13.1] مستويات السيطرة على Android أنت تحتاج “طبقتين”: التحكم العادي (Daily Control) تطبيقات مسموحة/محجوبة وقت شاشة أوضاع (نوم/مذاكرة) فلترة الويب التحكم الدفاعي السريع (Emergency Defense) إيقاف تطبيق فوري وضع حجر شبكة تعطيل كاميرا/ميكروفون شاشة إغلاق فوق الكل (Blackout Overlay) [13.2] Caption: أوامر الدفاع ونتيجتها الأمر الهدف قيود أمان Kill App إيقاف مصدر التهديد لا يُستخدم إلا في High/Critical Net Quarantine منع تواصل خارجي مؤقت + قابل للإلغاء من الأب Camera/Mic Block منع الاستغلال مرتبط بحالة تهديد Blackout Overlay حماية قصوى يتطلب Opt-in من الأب مسبقًا لا نعطي “الدعم الفني” أي زر يتحكم بالجهاز مباشرة. [14] ## آلية “الاستقلالية والذكاء” (Autonomy) بدون مخاطرة خصوصية [14.1] خط قرار سريع داخل الجهاز (On-device Decision Loop) التقاط حدث تصنيف خطر تنفيذ Playbook محليًا إن كانت السياسة تسمح إرسال ملخص + دليل للفولت [14.2] Caption: سياسة البيانات (Data Boundary) داخل الأسرة نوع البيانات أين تُحفظ من يراها محتوى الأدلة (صور/صوت/فيديو) Evidence Object Store للأسرة الأب/الأم فقط (حسب الدور) تشخيصات تقنية Core DB الأسرة + دعم فني (بدون محتوى) سجلات التدقيق Audit DB الأسرة (للشفافية) مؤشرات مزاجية Core DB الأب/الأم (اختياري) [15] ## أهم إضافتين الآن لتصبح “أكثر من Bark” فعليًا (Competitive Differentiators) [15.1] Safety Protocol Studio (لوحة تصميم البروتوكولات) واجهة داخل لوحة الأب تسمح بـ: ضبط شدة الإجراءات لكل حادثة اختيار “متى نغلق الجهاز؟” اختيار “متى نكتفي بتجميد التطبيق؟” حفظ نسخ متعددة + تاريخ تعديلات [15.2] Family Evidence Center صفحة أدلة للأسرة مع: فلترة حسب الطفل/الجهاز/النوع Timeline Custody log زر Export للأب فقط [16] ## Suggested Next Steps [16.1] إذا تريد، سأكتب لك الآن ملف مواصفات API كاملة لهذا النظام: (Endpoints + Auth + Rate Limits + Audit لكل endpoint). [16.2] ثم أبني لك خريطة الشاشات UI/UX للـ Parent Web Console (أقسام + صلاحيات + تدفقات). [16.3] وبعدها أجهز لك تصميم Pairing & Device Binding (رمز مؤقت + Token + Device Identity) بشكل مؤسسي وآمن ومتوافق مع ربط عدة أجهزة للطفل.
[123] [1] ## مواصفات API كاملة (v1) لنظام رقابة أبوية ذكي + Evidence Vault (Bark-like لكن أكثر استقلالية) [1.1] مبدأ API الأساسي كل API يجب أن يحقق 4 شروط: AuthN: المصادقة AuthZ: التفويض حسب RBAC/ABAC Audit: تسجيل أثر دائم Safety: منع إساءة الاستخدام (Rate Limits + Idempotency + Validation) [1.2] قواعد عامة إلزامية لكل Endpoint Authorization: Bearer <access_token> X-Request-Id + X-Correlation-Id Idempotency-Key للعمليات الحساسة (Lock/Export/Policy Update) تصفية مدخلات صارمة + منع أي حقول غير متوقعة (Strict Schema Validation) كل رد خطأ: لا يحتوي أسرار أو تفاصيل تنفيذ داخلية [2] ## طبقات الـ API (API Domains) — تقسيم مؤسسي واضح [2.1] Caption: تقسيم الـ API إلى نطاقات Domain Base Path الهدف Auth / IAM /api/v1/auth/* تسجيل دخول، جلسات، MFA Family & Members /api/v1/family/* أفراد الأسرة، ربط الأبناء Device Enrollment /api/v1/devices/* ربط الأجهزة وإدارتها Policies & Modes /api/v1/policies/* و/api/v1/modes/* السياسات والأوضاع Telemetry /api/v1/telemetry/* استقبال الأحداث Safety Engine /api/v1/safety/* تشغيل Playbooks وقرارات الدفاع Evidence Vault /api/v1/evidence/* فهرس الأدلة، سلسلة العهدة، التصدير Realtime /api/v1/realtime/* لقطة/بث/Walkie Alerts /api/v1/alerts/* إشعارات وتنبيهات Audit /api/v1/audit/* سجل تدقيق قابل للبحث [3] ## Endpoints المصادقة والهوية (Auth/IAM) [3.1] Caption: Auth Endpoints Endpoint Method Role الهدف Audit /auth/login POST Father/Mother تسجيل دخول auth.login /auth/mfa/verify POST Father/Mother تحقق MFA auth.mfa.verify /auth/token/refresh POST Father/Mother تجديد توكن auth.token.refresh /auth/logout POST Father/Mother إنهاء جلسة auth.logout /auth/sessions GET Father عرض الجلسات auth.sessions.read /auth/sessions/:id/revoke POST Father إلغاء جلسة auth.sessions.revoke [4] ## إدارة الأسرة والأعضاء (Family/Members) [4.1] Caption: Family & Members Endpoints Endpoint Method الدور المسموح الهدف ملاحظات أمنية /family/me GET Father/Mother/Auditor بيانات الأسرة RLS عبر family_id /family/members GET Father/Mother قائمة الأعضاء لا تعرض بيانات حساسة /family/members/invite POST Father دعوة الأم/وصي دعوة آمنة /family/members/:id/role PATCH Father تعديل دور Hard deny للأم /family/members/:id/remove POST Father حذف عضو MFA مُوصى [4.2] مثال payload دعوة الأم { "email": " mother@example.com ", "role": "FAMILY_COADMIN_LIMITED" } [5] ## ربط الأجهزة (Device Enrollment) — أهم جزء في النظام [5.1] المطلوب: ربط أجهزة متعددة لكل طفل، وربط آمن لا يسمح بانتحال جهاز. 5.2 مراحل الربط (Enrollment Flow) الأب ينشئ Pair Code مؤقت جهاز الطفل يرسل الكود + بصمة الجهاز (Device Attestation/Binding) الخادم يصدر: device_id device_token خاص بالجهاز مفاتيح/إعدادات “التنفيذ المحلي” [5.3] Caption: Enrollment Endpoints Endpoint Method الدور الهدف قيود /devices/pair-code POST Father إنشاء كود مؤقت TTL قصير /devices/enroll POST Device تسجيل الجهاز مرة واحدة /devices GET Father/Mother عرض أجهزة الطفل /devices/:id/status GET Father/Mother حالة الجهاز /devices/:id/remove POST Father إزالة الجهاز MFA مُوصى [5.4] مثال إنشاء Pair Code { "child_id": "UUID-CHILD", "expires_in_sec": 180 } [5.5] مثال enroll من جهاز الطفل { "pair_code": "8F3Q-92KM", "device_model": "SM-S928B", "platform": "android", "agent_version": "1.0.0", "device_binding": { "install_id": "random-uuid", "attestation": "opaque-token" } } [6] ## السياسات والأوضاع الذكية (Policies/Modes) [6.1] Caption: Policy Endpoints Endpoint Method الدور الهدف Audit /policies GET Father/Mother/Auditor قراءة policy.read /policies POST Father/Mother إنشاء policy.create /policies/:id PATCH Father/Mother تعديل policy.update /policies/:id/assign POST Father/Mother تطبيق على طفل/جهاز policy.assign [6.2] Caption: Modes Endpoints Endpoint Method الدور الهدف /modes GET Father/Mother/Auditor قراءة /modes POST Father/Mother إنشاء وضع /modes/:id/apply POST Father/Mother تطبيق وضع /modes/:id/schedule POST Father/Mother جدول تلقائي [6.3] مثال وضع المذاكرة { "name": "Study Mode", "payload": { "net": { "mode": "limited" }, "apps": { "allow": ["zoom", "classroom", "calculator"], "block": ["tiktok", "snapchat"] }, "realtime": { "screenshots_interval_sec": 600 } } } [7] ## Telemetry (الأحداث) + Safety Engine (القرارات) [7.1] Caption: Telemetry Ingest Endpoints Endpoint Method الدور الهدف /telemetry/events POST Device إرسال حدث /telemetry/batch POST Device إرسال دفعة [7.2] مبدأ ذكي مهم الجهاز ينفّذ “إجراءات فورية” محليًا عند الخطر (وفق السياسة) ثم يرسل تقريرًا للخادم للتوثيق والتنبيه [7.3] Caption: Safety Engine Endpoints Endpoint Method الدور الهدف /safety/evaluate POST Device/Server تقييم الحدث /safety/playbooks GET Father/Mother عرض البروتوكولات /safety/playbooks/:id/toggle POST Father تشغيل/إيقاف /safety/actions/override POST Father إلغاء حجر/فك قفل [7.4] مثال حدث حساس (Grooming) { "device_id": "UUID-DEVICE", "event_type": "grooming_suspected", "severity": "high", "signals": ["sexual_terms", "request_private_photos"], "local_actions_taken": ["APP_KILL", "NET_QUARANTINE"], "timestamp": "2026-01-18T20:12:00Z" } [8] ## Evidence Vault APIs — فهرسة + عهدة + تصدير (بدون حذف إلا للأب) [8.1] Caption: Evidence Endpoints Endpoint Method الدور الهدف Hard Rules /evidence GET Father/Mother/Auditor قائمة أدلة فلترة حسب الطفل /evidence/:id GET Father/Mother تفاصيل يسجل custody.view /evidence/:id/tags POST Father/Mother وسم/تعليق /evidence/:id/export POST Father تصدير حزمة MFA + سبب /evidence/:id/delete POST Father حذف Cooling + Audit دائم [8.2] Caption: Custody Endpoints Endpoint Method الدور الهدف /evidence/:id/custody GET Father/Mother/Auditor عرض سلسلة العهدة /evidence/:id/custody/append POST System إضافة تلقائية [9] ## Realtime APIs (Screenshots/Audio/Camera/Walkie) [9.1] قاعدة أمنية شديدة Realtime هي أخطر جزء. لذا نربطها بـ: Opt-in مسبق من الأب حالات خطر محددة تسجيل تدقيق لكل طلب بث [9.2] Caption: Realtime Endpoints Endpoint Method الدور الهدف قيود /realtime/screenshot/request POST Father/Mother لقطة فورية في أوضاع محددة /realtime/screenshot/schedule POST Father جدولة لقطات لا أثناء النوم /realtime/audio/listen POST Father استماع مباشر High/Critical فقط /realtime/camera/view POST Father كاميرا مباشر Opt-in + Audit /walkie/start POST Father/Mother بدء اتصال /walkie/stop POST Father/Mother إنهاء [10] ## Alerts APIs (تنبيهات الأب والأم) [10.1] Caption: Alerts Endpoints Endpoint Method الدور الهدف /alerts GET Father/Mother قائمة /alerts/:id/ack POST Father/Mother تأكيد /alerts/settings PATCH Father ضبط حساسية [11] ## UI/UX Map (Parent Web Console) — خريطة الشاشات المؤسسية [11.1] الهدف UX الأب يرى “التحكم + الأدلة + الإعدادات الحرجة” الأم ترى “المراقبة + التدخل الفوري بدون صلاحيات حذف/تصدير” واجهة لا تحتاج شرح، لكن مؤسسية. [11.2] Caption: Navigation Structure (مقترح قوي) القسم صفحات داخلية يظهر لمن Dashboard Threat Timeline + Alerts + Device Health Father/Mother Children Child Profile + Devices + Modes Father/Mother Live Safety Screenshot + Walkie + (Camera/Audio إن فُعّلت) Father (وأم حسب الإذن) Evidence Center Evidence List + Details + Custody + Export Father/Mother (Export للأب) Policies Global Policies + Assignments Father/Mother Smart Modes Sleep/Study/Custom + Scheduler Father/Mother Location Live Map + Safe Zones + History Father/Mother Reports Weekly Insights + Mood Signals Father/Mother (مستوى خصوصية) Family & Roles Members + Roles + Recovery Father فقط Settings Security + Notifications + Integrations Father فقط [12] ## تدفقات استخدام UX حرجة (User Flows) — جاهزة للتنفيذ [12.1] Flow A: إضافة طفل + ربط جهاز Father → Children → Add Child Generate Pair Code Install Child Agent → Enter Pair Code Device becomes “Compliant” → Apply Policy + Mode [12.2] Flow B: حادثة استدراج Device detects → ينفذ إجراءات محلية Evidence auto-created Alert to parents Parents open Evidence Center Father optionally exports package (MFA + reason) [12.3] Flow C: حالة حرجة → شاشة سوداء Threat = Critical Blackout Overlay enabled (Opt-in) Device locked Only allowed: SOS + Walkie + Emergency call Father reviews → unlock with confirmation [13] ## تصميم “Pairing & Device Binding” بشكل مؤسسي (بدون ثغرات) [13.1] الأهداف الأمنية منع طفل يربط جهاز مزيف منع مهاجم يسرق Pair Code ويستولي على طفل آخر دعم عدة أجهزة للطفل [13.2] Caption: شروط قبول enroll شرط لماذا Pair Code بمدة قصيرة يقلل سرقة الكود ربط الكود بـ child_id يمنع الالتباس استخدام install_id فريد تثبيت مرتبط بجهاز Token للجهاز مستقل عن حساب الأب يقلل أثر سرقة جلسة الأب تسجيل enroll في Audit شفافية كاملة [14] ## “بروتوكولات الحماية الآلية” كنظام قابل للتخصيص (Playbook Studio) [14.1] يجب أن يكون لدى الأب صفحة: لكل نوع حادثة: Slider شدة الاستجابة تفعيل/تعطيل: Kill App Net Quarantine Camera/Mic Block Blackout Overlay إعداد “من ينبه؟” + “كيف؟” [14.2] Caption: نموذج إعدادات Playbook لكل أسرة الحادثة افتراضيًا الأب يستطيع Bullying Kill مؤقت + تنبيه تعديل المدة Grooming Kill + حجر + تعطيل كاميرا/ميك رفع/خفض الشدة Sextortion Blackout (Critical) تفعيل/تعطيل Self-harm تنبيه + دعم + فلترة منع القفل العدواني [15] ## نقطة تنظيمية مهمة: ماذا يرى “الدعم الفني”؟ [15.1] الدعم الفني يجب أن يرى فقط حالة الاتصال (online/offline) هل الوكيل يعمل آخر إرسال Telemetry أخطاء enroll نسخة التطبيق [15.2] Caption: Support Visibility Rules بيانات مسموح للدعم؟ محتوى الأدلة لا نصوص محادثات الطفل لا صور/صوت/فيديو لا أسماء تطبيقات محظورة نعم (على مستوى تقني) حالة جهاز Compliance نعم سبب “لماذا لم تعمل ميزة” نعم (بدون محتوى) [16] ## Suggested Next Steps [16.1] سأكتب لك مباشرة مخطط قاعدة البيانات النهائي v1 بصيغة ERD نصي (علاقات FK + Indexes + Partitioning للأحداث). [16.2] ثم أضع لك Threat Model رسمي (STRIDE) لأخطر 12 سيناريو: سرقة حساب الأب، اختراق جهاز الطفل، إساءة بث مباشر… إلخ. [16.3] ثم ننتقل إلى تصميم UI/UX تفصيلي: كل صفحة + مكونات + حالات التحميل + رسائل الخطأ + صلاحيات العرض.
[124] [1] ## مخطط قاعدة البيانات النهائي v1 (ERD نصّي) — مطابق 100% لنظامك (Family Evidence + Auto-Defense) [1.1] مبدأ التخزين المؤسسي المعتمد Core DB: تشغيل الأسرة + الأعضاء + الأجهزة + السياسات + الأوضاع Telemetry DB: أحداث ضخمة (Partitioning) Evidence DB: فهرسة الأدلة + سلسلة العهدة + سجل التصدير Audit DB: أثر دائم Append-only Evidence Object Store (Immutable): الملفات الفعلية (صور/صوت/فيديو/نص) [2] ## ERD نصّي (العلاقات الأساسية + المفاتيح) [2.1] Caption: ERD Core Entities Entity PK أهم العلاقات families family_id 1→N مع principals, children, devices, policies, modes principals principal_id N→1 مع families + N→N مع roles principal_roles (principal_id, role) يحدد دور كل عضو children_profiles child_id 1→N مع devices, mood_signals guardian_child_link (guardian_id, child_id) يربط الأب/الأم بالأبناء devices device_id N→1 مع children_profiles + 1→N مع telemetry_events device_sessions session_id جلسات الجهاز والتوكنات policies policy_id 1→N مع policy_assignments policy_assignments assignment_id policy→child/device modes mode_id 1→N مع mode_schedules mode_schedules schedule_id جدولة الأوضاع geofences geofence_id مناطق آمنة للأجهزة/الأطفال [3] ## جداول Core DB (تفصيل عملي جاهز للتنفيذ) [3.1] Caption: جدول الأسر (families) العمود النوع قيود family_id UUID PK not null owner_principal_id UUID FK principals not null name TEXT not null plan ENUM free/pro/enterprise created_at TIMESTAMP not null [3.2] Caption: جدول الهوية (principals) العمود النوع قيود principal_id UUID PK not null family_id UUID FK families not null principal_type ENUM father/mother/child/guardian/auditor email TEXT unique per family (nullable للطفل) phone TEXT nullable status ENUM active/locked/disabled mfa_level ENUM none/optional/required created_at TIMESTAMP not null [3.3] Caption: جدول ربط الأدوار (principal_roles) العمود النوع قيود principal_id UUID FK principals not null role ENUM FAMILY_OWNER/COADMIN/... assigned_by UUID FK principals not null assigned_at TIMESTAMP not null المفتاح المركّب: (principal_id, role) لمنع تكرار نفس الدور. [3.4] Caption: جدول الأطفال (children_profiles) العمود النوع قيود child_id UUID PK (= principal_id) not null family_id UUID FK families not null age_group ENUM 3-5/6-9/10-12/13-17 risk_profile ENUM low/normal/high privacy_level ENUM minimal/standard/strict created_at TIMESTAMP not null [3.5] Caption: جدول ربط الوالد بالأبناء (guardian_child_link) العمود النوع قيود guardian_id UUID FK principals not null child_id UUID FK principals not null relationship ENUM father/mother/guardian consent_status ENUM pending/approved/revoked approved_at TIMESTAMP nullable [3.6] Caption: جدول الأجهزة (devices) العمود النوع قيود device_id UUID PK not null family_id UUID FK families not null child_id UUID FK principals not null platform ENUM android device_model TEXT not null agent_version TEXT not null compliance_state ENUM ok/warn/critical last_seen_at TIMESTAMP not null enrolled_at TIMESTAMP not null [3.7] Caption: جدول جلسات الأجهزة (device_sessions) العمود النوع قيود session_id UUID PK not null device_id UUID FK devices not null device_token_hash TEXT not null token_rotated_at TIMESTAMP not null revoked_at TIMESTAMP nullable created_at TIMESTAMP not null [3.8] Caption: جدول السياسات (policies) العمود النوع قيود policy_id UUID PK not null family_id UUID FK families not null name TEXT not null payload_json JSONB not null version INT not null updated_by UUID FK principals not null updated_at TIMESTAMP not null [3.9] Caption: جدول تطبيق السياسات (policy_assignments) العمود النوع قيود assignment_id UUID PK not null policy_id UUID FK policies not null family_id UUID FK families not null scope_type ENUM child/device scope_id UUID child_id أو device_id assigned_by UUID FK principals not null assigned_at TIMESTAMP not null [3.10] Caption: جدول الأوضاع الذكية (modes) العمود النوع قيود mode_id UUID PK not null family_id UUID FK families not null name TEXT not null mode_payload JSONB not null created_by UUID FK principals not null created_at TIMESTAMP not null [3.11] Caption: جدول جدولة الأوضاع (mode_schedules) العمود النوع قيود schedule_id UUID PK not null mode_id UUID FK modes not null family_id UUID FK families not null target_scope ENUM child/device target_id UUID not null cron TEXT not null timezone TEXT not null enabled BOOLEAN not null [3.12] Caption: جدول المناطق الآمنة (geofences) العمود النوع قيود geofence_id UUID PK not null family_id UUID FK families not null name TEXT not null center_lat DECIMAL not null center_lng DECIMAL not null radius_m INT not null applies_to ENUM child/device target_id UUID not null created_by UUID FK principals not null [4] ## Telemetry DB (الأحداث) — تصميم عالي الأداء + Partitioning [4.1] Caption: جدول الأحداث (telemetry_events) العمود النوع قيود event_id UUID PK not null family_id UUID not null device_id UUID not null child_id UUID not null event_type TEXT not null severity ENUM low/med/high/critical signals JSONB not null local_actions_taken JSONB not null evidence_candidate BOOLEAN not null created_at TIMESTAMP not null [4.2] Partitioning المقترح تقسيم شهري: telemetry_events_YYYY_MM سبب التقسيم: حجم كبير استعلامات زمنية دائمة (آخر 7 أيام/30 يوم) تنظيف Retention أسرع [4.3] Indexes المقترحة للأحداث (family_id, created_at desc) (device_id, created_at desc) (child_id, created_at desc) (event_type, severity, created_at desc) GIN index على signals إن احتجت بحث سريع (بحذر) [5] ## Evidence DB — الفهرسة والعهدة والتصدير (بدون ملفات داخل DB) [5.1] Caption: جدول الأدلة (evidence_items) العمود النوع قيود evidence_id UUID PK not null family_id UUID not null device_id UUID not null child_id UUID not null source_event_id UUID nullable object_uri TEXT not null sha256 TEXT not null content_type ENUM text/image/audio/video classification ENUM normal/restricted/legal_hold created_by_actor ENUM device/father/mother/system created_at TIMESTAMP not null [5.2] Caption: سلسلة العهدة (evidence_custody_chain) العمود النوع قيود custody_id UUID PK not null evidence_id UUID FK evidence_items not null family_id UUID not null actor_id UUID not null action ENUM create/view/export/hold/delete_attempt reason TEXT nullable (إلزامي للتصدير) created_at TIMESTAMP not null [5.3] Caption: سجل تصدير الأدلة (evidence_exports) العمود النوع قيود export_id UUID PK not null family_id UUID not null requested_by UUID not null export_uri TEXT not null export_sha256 TEXT not null status ENUM ready/expired/revoked created_at TIMESTAMP not null [5.4] Indexes للأدلة (family_id, created_at desc) (child_id, created_at desc) (device_id, created_at desc) (classification, created_at desc) [6] ## Audit DB — أثر دائم لا يُحذف (Append-only) [6.1] Caption: جدول التدقيق (audit_logs) العمود النوع قيود audit_id UUID PK not null family_id UUID not null actor_id UUID not null action TEXT not null target_type TEXT not null target_id UUID nullable metadata JSONB not null created_at TIMESTAMP not null [6.2] Indexes للتدقيق (family_id, created_at desc) (actor_id, created_at desc) (action, created_at desc) [7] ## سياسة الاحتفاظ (Retention) — مؤسسية وواقعية [7.1] Caption: Retention Policy مقترحة نوع البيانات مدة الاحتفاظ الافتراضية قابل للتخصيص من الأب Telemetry Events 90 يوم نعم Evidence Items 180 يوم نعم (مع Legal Hold) Evidence Exports 30 يوم نعم Audit Logs 365 يوم لا (مستحسن ثابت) Mood Signals 30 يوم نعم ملاحظة مهمة: أي Evidence تحت legal_hold لا تُحذف حتى لو انتهت المدة. [8] ## Threat Model رسمي (STRIDE) — أخطر 12 سيناريو مع علاجها [8.1] Caption: STRIDE Threat Model (Top 12) التهديد النوع المثال الضبط الدفاعي 1 سرقة حساب الأب Spoofing مهاجم يحصل على كلمة مرور الأب MFA + حماية جلسات + تنبيه 2 انتحال جهاز طفل Spoofing جهاز مزيف يرسل Telemetry Device binding + token rotation 3 تعديل الأدلة Tampering محاولة تغيير Evidence Immutable store + hash + custody 4 حذف أدلة من الأم Tampering الأم تحذف دليل Hard deny + audit 5 إنكار مشاهدة دليل Repudiation “لم أفتح الدليل” custody.view + audit 6 تسريب بث مباشر Information Disclosure دعم فني يرى كاميرا deny realtime.* على الدعم 7 تسريب محادثات الطفل Info Disclosure مطور يصل للـ DB no prod data + SoD 8 هجوم تعطيل المنصة DoS flood على telemetry rate limits + batching + WAF 9 استغلال API تصدير الأدلة EoP صلاحية خاطئة للأم export للأب فقط + MFA 10 طفل يحاول تعطيل الوكيل Tampering force stop / revoke admin anti-tamper + critical event 11 إساءة استخدام live camera داخليًا Abuse والد يسيء opt-in + time-bound + audit 12 استغلال “blackout overlay” للتسلط Abuse/DoS قفل متكرر بلا سبب قيود ABAC + cooldown + reason [9] ## قواعد الأمان الخاصة بالميزات الحساسة (Live + Evidence + Lockdown) [9.1] Caption: Safety Controls للميزات الأخطر الميزة الخطر ضوابط إلزامية Live Camera خصوصية قصوى Opt-in من الأب + سجل تدقيق + شروط خطر Live Audio أخطر من الكاميرا High/Critical + جلسة قصيرة + Audit Screenshots تراكم حساس حد أقصى + إيقاف أثناء النوم Evidence Export خروج بيانات Father فقط + MFA + سبب مكتوب Evidence Delete فقدان دليل Father فقط + cooldown + audit دائم Blackout Overlay إساءة قفل Critical فقط + Opt-in + cooldown [10] ## تصميم UI/UX تفصيلي (Parent Web Console) — الصفحات + المكونات + حالات الاستخدام [10.1] قاعدة UX الأساسية الأب: “تحكم + قرارات + أدلة + إعدادات حرجة” الأم: “إشراف + تدخل سريع + تقارير” بدون حذف/تصدير/تغيير أدوار كل إجراء خطر = يحتاج سبب + تأكيد + أثر [11] ## تفاصيل صفحات لوحة التحكم (Screens + Components) [11.1] صفحة Dashboard [11.1.1] مكونات Threat Timeline (آخر 24 ساعة) Alerts Inbox Device Health Tiles Quick Actions (Lock / Quarantine / Walkie) [11.1.2] حالات حالة “حدث Critical”: يظهر زر “Open Incident” [11.2] صفحة Children [11.2.1] مكونات قائمة الأطفال + شارات عمر/خطر Child Profile: أجهزة الطفل + آخر اتصال زر Pair New Device (Father/Mother) [11.2.2] شروط عرض Mother ترى “إزالة جهاز” مخفي Father يرى “Remove device” [11.3] صفحة Live Safety [11.3.1] مكونات Screenshot Now Walkie-Talkie Panel Live Audio (إذا سمح) Live Camera (إذا سمح) [11.3.2] ضوابط عدّاد زمني للجلسة (Session timer) سجل “من بدأ الجلسة ولماذا؟” [11.4] صفحة Evidence Center (الأهم في المنتج) [11.4.1] مكونات Filters: child/device/type/severity/date Evidence List (Timeline) Evidence Details: Preview Metadata Custody chain Tags/Notes Export button (Father فقط) Delete button (Father فقط) مع Warning قوي [11.4.2] “قابلية قانونية” زر Export ينتج Evidence Package مع manifest داخلي [11.5] صفحة Policies [11.5.1] مكونات Policy Library Policy Diff Viewer (تاريخ التعديلات) Assignments [11.5.2] UX مهم أي تعديل Policy يظهر قبل/بعد (Before/After) ويُسجّل في Audit [11.6] صفحة Smart Modes [11.6.1] مكونات Modes Gallery Mode Builder (محرر) Scheduler (تقويم أسبوعي) [11.6.2] نمط مهم “Sleep mode” محمي: لا Screenshots schedule إلا للأب [11.7] صفحة Location [11.7.1] مكونات Live Map Safe Zones (geofences) History playback (اختياري) [11.8] صفحة Reports (نقاط قوتك “ذكاء واستقلالية”) [11.8.1] مكونات Weekly Safety Report Mood Signals Summary Risk Trend [11.8.2] حماية خصوصية زر “Hide content details” للأسر التي تريد تقارير بدون محتوى [11.9] صفحة Family & Roles (Father فقط) [11.9.1] مكونات Members Role Assignment Recovery Options (مؤمّنة) Security Preferences: MFA enforcement Export policy Live camera opt-in [12] ## تصميم تجربة “الحادثة الواحدة” (Incident View) — نقطة تفوقك الحقيقي [12.1] عند حدوث Incident (Grooming/Sextortion/Critical) يظهر: Incident Header: النوع + الطفل + الجهاز + الوقت Actions Taken (آليًا) Evidence Created Recommended Next Actions: Talk to child (walkie) Lockdown continue Export package (Father only) [12.2] Caption: Incident Actions UI الإجراء يظهر لمن شرط الظهور Continue Quarantine Father/Mother إذا حجر مفعل Unlock device Father بعد تقييم الأب Export Evidence Father MFA + reason Start Walkie Father/Mother دائمًا Disable Camera/Mic Father/Mother حسب السياسة [13] ## Suggested Next Steps [13.1] الخطوة التالية الأقوى: أكتب لك مواصفات “Safety Protocol Studio” كاملة (واجهة بناء playbooks + شروط + أكشنز + ABAC) بشكل جاهز للتطوير. [13.2] بعدها مباشرة: نكتب نموذج بيانات Playbooks النهائي (Schema + Versioning + Rollback + Audit). [13.3] ثم ننتقل إلى تصميم Android Agent Architecture (Modules + local ML + anti-tamper + command executor) وفق نفس البروتوكولات.
[125] [1] ## مخطط قاعدة البيانات النهائي v1 (ERD نصّي) — مطابق 100% لنظامك (Family Evidence + Auto-Defense) [1.1] مبدأ التخزين المؤسسي المعتمد Core DB: تشغيل الأسرة + الأعضاء + الأجهزة + السياسات + الأوضاع Telemetry DB: أحداث ضخمة (Partitioning) Evidence DB: فهرسة الأدلة + سلسلة العهدة + سجل التصدير Audit DB: أثر دائم Append-only Evidence Object Store (Immutable): الملفات الفعلية (صور/صوت/فيديو/نص) [2] ## ERD نصّي (العلاقات الأساسية + المفاتيح) [2.1] Caption: ERD Core Entities Entity PK أهم العلاقات families family_id 1→N مع principals, children, devices, policies, modes principals principal_id N→1 مع families + N→N مع roles principal_roles (principal_id, role) يحدد دور كل عضو children_profiles child_id 1→N مع devices, mood_signals guardian_child_link (guardian_id, child_id) يربط الأب/الأم بالأبناء devices device_id N→1 مع children_profiles + 1→N مع telemetry_events device_sessions session_id جلسات الجهاز والتوكنات policies policy_id 1→N مع policy_assignments policy_assignments assignment_id policy→child/device modes mode_id 1→N مع mode_schedules mode_schedules schedule_id جدولة الأوضاع geofences geofence_id مناطق آمنة للأجهزة/الأطفال [3] ## جداول Core DB (تفصيل عملي جاهز للتنفيذ) [3.1] Caption: جدول الأسر (families) العمود النوع قيود family_id UUID PK not null owner_principal_id UUID FK principals not null name TEXT not null plan ENUM free/pro/enterprise created_at TIMESTAMP not null [3.2] Caption: جدول الهوية (principals) العمود النوع قيود principal_id UUID PK not null family_id UUID FK families not null principal_type ENUM father/mother/child/guardian/auditor email TEXT unique per family (nullable للطفل) phone TEXT nullable status ENUM active/locked/disabled mfa_level ENUM none/optional/required created_at TIMESTAMP not null [3.3] Caption: جدول ربط الأدوار (principal_roles) العمود النوع قيود principal_id UUID FK principals not null role ENUM FAMILY_OWNER/COADMIN/... assigned_by UUID FK principals not null assigned_at TIMESTAMP not null المفتاح المركّب: (principal_id, role) لمنع تكرار نفس الدور. [3.4] Caption: جدول الأطفال (children_profiles) العمود النوع قيود child_id UUID PK (= principal_id) not null family_id UUID FK families not null age_group ENUM 3-5/6-9/10-12/13-17 risk_profile ENUM low/normal/high privacy_level ENUM minimal/standard/strict created_at TIMESTAMP not null [3.5] Caption: جدول ربط الوالد بالأبناء (guardian_child_link) العمود النوع قيود guardian_id UUID FK principals not null child_id UUID FK principals not null relationship ENUM father/mother/guardian consent_status ENUM pending/approved/revoked approved_at TIMESTAMP nullable [3.6] Caption: جدول الأجهزة (devices) العمود النوع قيود device_id UUID PK not null family_id UUID FK families not null child_id UUID FK principals not null platform ENUM android device_model TEXT not null agent_version TEXT not null compliance_state ENUM ok/warn/critical last_seen_at TIMESTAMP not null enrolled_at TIMESTAMP not null [3.7] Caption: جدول جلسات الأجهزة (device_sessions) العمود النوع قيود session_id UUID PK not null device_id UUID FK devices not null device_token_hash TEXT not null token_rotated_at TIMESTAMP not null revoked_at TIMESTAMP nullable created_at TIMESTAMP not null [3.8] Caption: جدول السياسات (policies) العمود النوع قيود policy_id UUID PK not null family_id UUID FK families not null name TEXT not null payload_json JSONB not null version INT not null updated_by UUID FK principals not null updated_at TIMESTAMP not null [3.9] Caption: جدول تطبيق السياسات (policy_assignments) العمود النوع قيود assignment_id UUID PK not null policy_id UUID FK policies not null family_id UUID FK families not null scope_type ENUM child/device scope_id UUID child_id أو device_id assigned_by UUID FK principals not null assigned_at TIMESTAMP not null [3.10] Caption: جدول الأوضاع الذكية (modes) العمود النوع قيود mode_id UUID PK not null family_id UUID FK families not null name TEXT not null mode_payload JSONB not null created_by UUID FK principals not null created_at TIMESTAMP not null [3.11] Caption: جدول جدولة الأوضاع (mode_schedules) العمود النوع قيود schedule_id UUID PK not null mode_id UUID FK modes not null family_id UUID FK families not null target_scope ENUM child/device target_id UUID not null cron TEXT not null timezone TEXT not null enabled BOOLEAN not null [3.12] Caption: جدول المناطق الآمنة (geofences) العمود النوع قيود geofence_id UUID PK not null family_id UUID FK families not null name TEXT not null center_lat DECIMAL not null center_lng DECIMAL not null radius_m INT not null applies_to ENUM child/device target_id UUID not null created_by UUID FK principals not null [4] ## Telemetry DB (الأحداث) — تصميم عالي الأداء + Partitioning [4.1] Caption: جدول الأحداث (telemetry_events) العمود النوع قيود event_id UUID PK not null family_id UUID not null device_id UUID not null child_id UUID not null event_type TEXT not null severity ENUM low/med/high/critical signals JSONB not null local_actions_taken JSONB not null evidence_candidate BOOLEAN not null created_at TIMESTAMP not null [4.2] Partitioning المقترح تقسيم شهري: telemetry_events_YYYY_MM سبب التقسيم: حجم كبير استعلامات زمنية دائمة (آخر 7 أيام/30 يوم) تنظيف Retention أسرع [4.3] Indexes المقترحة للأحداث (family_id, created_at desc) (device_id, created_at desc) (child_id, created_at desc) (event_type, severity, created_at desc) GIN index على signals إن احتجت بحث سريع (بحذر) [5] ## Evidence DB — الفهرسة والعهدة والتصدير (بدون ملفات داخل DB) [5.1] Caption: جدول الأدلة (evidence_items) العمود النوع قيود evidence_id UUID PK not null family_id UUID not null device_id UUID not null child_id UUID not null source_event_id UUID nullable object_uri TEXT not null sha256 TEXT not null content_type ENUM text/image/audio/video classification ENUM normal/restricted/legal_hold created_by_actor ENUM device/father/mother/system created_at TIMESTAMP not null [5.2] Caption: سلسلة العهدة (evidence_custody_chain) العمود النوع قيود custody_id UUID PK not null evidence_id UUID FK evidence_items not null family_id UUID not null actor_id UUID not null action ENUM create/view/export/hold/delete_attempt reason TEXT nullable (إلزامي للتصدير) created_at TIMESTAMP not null [5.3] Caption: سجل تصدير الأدلة (evidence_exports) العمود النوع قيود export_id UUID PK not null family_id UUID not null requested_by UUID not null export_uri TEXT not null export_sha256 TEXT not null status ENUM ready/expired/revoked created_at TIMESTAMP not null [5.4] Indexes للأدلة (family_id, created_at desc) (child_id, created_at desc) (device_id, created_at desc) (classification, created_at desc) [6] ## Audit DB — أثر دائم لا يُحذف (Append-only) [6.1] Caption: جدول التدقيق (audit_logs) العمود النوع قيود audit_id UUID PK not null family_id UUID not null actor_id UUID not null action TEXT not null target_type TEXT not null target_id UUID nullable metadata JSONB not null created_at TIMESTAMP not null [6.2] Indexes للتدقيق (family_id, created_at desc) (actor_id, created_at desc) (action, created_at desc) [7] ## سياسة الاحتفاظ (Retention) — مؤسسية وواقعية [7.1] Caption: Retention Policy مقترحة نوع البيانات مدة الاحتفاظ الافتراضية قابل للتخصيص من الأب Telemetry Events 90 يوم نعم Evidence Items 180 يوم نعم (مع Legal Hold) Evidence Exports 30 يوم نعم Audit Logs 365 يوم لا (مستحسن ثابت) Mood Signals 30 يوم نعم ملاحظة مهمة: أي Evidence تحت legal_hold لا تُحذف حتى لو انتهت المدة. [8] ## Threat Model رسمي (STRIDE) — أخطر 12 سيناريو مع علاجها [8.1] Caption: STRIDE Threat Model (Top 12) التهديد النوع المثال الضبط الدفاعي 1 سرقة حساب الأب Spoofing مهاجم يحصل على كلمة مرور الأب MFA + حماية جلسات + تنبيه 2 انتحال جهاز طفل Spoofing جهاز مزيف يرسل Telemetry Device binding + token rotation 3 تعديل الأدلة Tampering محاولة تغيير Evidence Immutable store + hash + custody 4 حذف أدلة من الأم Tampering الأم تحذف دليل Hard deny + audit 5 إنكار مشاهدة دليل Repudiation “لم أفتح الدليل” custody.view + audit 6 تسريب بث مباشر Information Disclosure دعم فني يرى كاميرا deny realtime.* على الدعم 7 تسريب محادثات الطفل Info Disclosure مطور يصل للـ DB no prod data + SoD 8 هجوم تعطيل المنصة DoS flood على telemetry rate limits + batching + WAF 9 استغلال API تصدير الأدلة EoP صلاحية خاطئة للأم export للأب فقط + MFA 10 طفل يحاول تعطيل الوكيل Tampering force stop / revoke admin anti-tamper + critical event 11 إساءة استخدام live camera داخليًا Abuse والد يسيء opt-in + time-bound + audit 12 استغلال “blackout overlay” للتسلط Abuse/DoS قفل متكرر بلا سبب قيود ABAC + cooldown + reason [9] ## قواعد الأمان الخاصة بالميزات الحساسة (Live + Evidence + Lockdown) [9.1] Caption: Safety Controls للميزات الأخطر الميزة الخطر ضوابط إلزامية Live Camera خصوصية قصوى Opt-in من الأب + سجل تدقيق + شروط خطر Live Audio أخطر من الكاميرا High/Critical + جلسة قصيرة + Audit Screenshots تراكم حساس حد أقصى + إيقاف أثناء النوم Evidence Export خروج بيانات Father فقط + MFA + سبب مكتوب Evidence Delete فقدان دليل Father فقط + cooldown + audit دائم Blackout Overlay إساءة قفل Critical فقط + Opt-in + cooldown [10] ## تصميم UI/UX تفصيلي (Parent Web Console) — الصفحات + المكونات + حالات الاستخدام [10.1] قاعدة UX الأساسية الأب: “تحكم + قرارات + أدلة + إعدادات حرجة” الأم: “إشراف + تدخل سريع + تقارير” بدون حذف/تصدير/تغيير أدوار كل إجراء خطر = يحتاج سبب + تأكيد + أثر [11] ## تفاصيل صفحات لوحة التحكم (Screens + Components) [11.1] صفحة Dashboard [11.1.1] مكونات Threat Timeline (آخر 24 ساعة) Alerts Inbox Device Health Tiles Quick Actions (Lock / Quarantine / Walkie) [11.1.2] حالات حالة “حدث Critical”: يظهر زر “Open Incident” [11.2] صفحة Children [11.2.1] مكونات قائمة الأطفال + شارات عمر/خطر Child Profile: أجهزة الطفل + آخر اتصال زر Pair New Device (Father/Mother) [11.2.2] شروط عرض Mother ترى “إزالة جهاز” مخفي Father يرى “Remove device” [11.3] صفحة Live Safety [11.3.1] مكونات Screenshot Now Walkie-Talkie Panel Live Audio (إذا سمح) Live Camera (إذا سمح) [11.3.2] ضوابط عدّاد زمني للجلسة (Session timer) سجل “من بدأ الجلسة ولماذا؟” [11.4] صفحة Evidence Center (الأهم في المنتج) [11.4.1] مكونات Filters: child/device/type/severity/date Evidence List (Timeline) Evidence Details: Preview Metadata Custody chain Tags/Notes Export button (Father فقط) Delete button (Father فقط) مع Warning قوي [11.4.2] “قابلية قانونية” زر Export ينتج Evidence Package مع manifest داخلي [11.5] صفحة Policies [11.5.1] مكونات Policy Library Policy Diff Viewer (تاريخ التعديلات) Assignments [11.5.2] UX مهم أي تعديل Policy يظهر قبل/بعد (Before/After) ويُسجّل في Audit [11.6] صفحة Smart Modes [11.6.1] مكونات Modes Gallery Mode Builder (محرر) Scheduler (تقويم أسبوعي) [11.6.2] نمط مهم “Sleep mode” محمي: لا Screenshots schedule إلا للأب [11.7] صفحة Location [11.7.1] مكونات Live Map Safe Zones (geofences) History playback (اختياري) [11.8] صفحة Reports (نقاط قوتك “ذكاء واستقلالية”) [11.8.1] مكونات Weekly Safety Report Mood Signals Summary Risk Trend [11.8.2] حماية خصوصية زر “Hide content details” للأسر التي تريد تقارير بدون محتوى [11.9] صفحة Family & Roles (Father فقط) [11.9.1] مكونات Members Role Assignment Recovery Options (مؤمّنة) Security Preferences: MFA enforcement Export policy Live camera opt-in [12] ## تصميم تجربة “الحادثة الواحدة” (Incident View) — نقطة تفوقك الحقيقي [12.1] عند حدوث Incident (Grooming/Sextortion/Critical) يظهر: Incident Header: النوع + الطفل + الجهاز + الوقت Actions Taken (آليًا) Evidence Created Recommended Next Actions: Talk to child (walkie) Lockdown continue Export package (Father only) [12.2] Caption: Incident Actions UI الإجراء يظهر لمن شرط الظهور Continue Quarantine Father/Mother إذا حجر مفعل Unlock device Father بعد تقييم الأب Export Evidence Father MFA + reason Start Walkie Father/Mother دائمًا Disable Camera/Mic Father/Mother حسب السياسة [13] ## Suggested Next Steps [13.1] الخطوة التالية الأقوى: أكتب لك مواصفات “Safety Protocol Studio” كاملة (واجهة بناء playbooks + شروط + أكشنز + ABAC) بشكل جاهز للتطوير. [13.2] بعدها مباشرة: نكتب نموذج بيانات Playbooks النهائي (Schema + Versioning + Rollback + Audit). [13.3] ثم ننتقل إلى تصميم Android Agent Architecture (Modules + local ML + anti-tamper + command executor) وفق نفس البروتوكولات.
[126] [1] ## Threat Model خاص بـ Android Child Agent (v1) — 12 سيناريو واقعي + ضوابط دفاع مؤسسية [1.1] نطاق التهديد هنا الهدف: حماية الطفل + حماية الدليل + منع تعطيل الوكيل + منع انتحال الجهاز نفترض أن الطفل/المهاجم قد يملك: وصول فعلي للجهاز (Physical access) خبرة متوسطة (Developer Options / ADB) قدرة على تثبيت تطبيقات خارجية [2] ## مصفوفة تهديدات Android Agent (Top 12) — تنفيذية وليست نظرية [2.1] Caption: Android Agent Threat Table السيناريو نوعه ماذا يحدث؟ مؤشر اكتشاف الاستجابة الدفاعية 1 Force Stop للوكيل Tampering إيقاف التطبيق بالقوة app_process_dead / heartbeat مفقود Alert + Tamper Incident + طلب إعادة تمكين 2 Disable Accessibility Tampering تعطيل صلاحية حيوية صلاحية مفقودة Net Limited + Incident + شاشة إرشاد 3 Revoke Device Admin Tampering إسقاط صلاحيات القفل admin revoked وضع Critical + تنبيه 4 محاولة Uninstall Tampering إزالة الوكيل uninstall intent detected Lock Settings + Alert + Blackout (حسب policy) 5 تعطيل VPN/Filter (إن وجد) Tampering تهرب من الحجب VPN off event Net Quarantine + Incident 6 Safe Mode Evasion تشغيل وضع آمن لمنع التشغيل boot flags / service not starting تنبيه للأب + تعليمات إصلاح 7 تغيير الوقت/التاريخ Evasion كسر الجداول time jump detect استخدام Server Time + منع Schedule bypass 8 تغيير DNS/Proxy Evasion تجاوز فلترة network config changed فرض Net Quarantine أو DNS enforced 9 ADB Debugging ON EoP تحكم خارجي عبر الكمبيوتر dev options on Alert + تخفيض قدرات الجهاز (policy) 10 انتحال Device Token Spoofing جهاز مزيف يرسل Telemetry token mismatch / binding fail رفض request + revoke token 11 Replay Events Repudiation إعادة إرسال أحداث قديمة event nonce / timestamp رفض + audit suspicious 12 تعديل Evidence محليًا Tampering تغيير ملف دليل sha mismatch رفض رفع + Incident + حفظ نسخة سليمة ملاحظة تصميمية: لا تعتمد على “رد فعل واحد”، بل على طبقات (Detection → Local Mitigation → Cloud Audit → Parent Alert). [3] ## تصميم “طبقات مقاومة العبث” (Anti-Tamper Layers) — طبقات بسيطة لكنها قوية [3.1] Caption: Anti-Tamper Layers الطبقة ماذا تفعل؟ لماذا مهمة؟ Heartbeat Monitor Ping دوري للخادم + Local watchdog كشف Force Stop سريعًا Permission Sentinel يراقب صلاحيات Accessibility/Admin اكتشاف إسقاط الصلاحيات Integrity Checker يتحقق من ملفات Evidence قبل الرفع يمنع تزوير الدليل Policy Lockdown يمنع بعض الإعدادات في Critical يقلل مساحة التلاعب Offline Buffer يسجل محليًا عند انقطاع الإنترنت لا تضيع الأدلة Cooldown & Limits يمنع إساءة الاستخدام يقلل “التسلط داخل الأسرة” [4] ## “استجابة العبث” (Tamper Response Playbooks) — جاهزة للربط مع الاستوديو [4.1] Caption: Tamper Response Playbook Examples Tamper Event Severity إجراءات مقترحة Force Stop مرة واحدة Medium Alert + إعادة تشغيل خدمة Force Stop متكرر High Net Limited + Incident + Walkie prompt Disable Accessibility High Net Quarantine 10m + شاشة تعليمات Uninstall Attempt Critical Blackout Overlay (إن مفعل) + Incident + Evidence ADB Enabled High Alert للأب + تعطيل بعض الميزات الترفيهية [5] ## مواصفات Key Management (إدارة التشفير والمفاتيح) — تصميم مؤسسي متعدد الطبقات [5.1] سؤال المستخدم: هل قاعدة موحدة لكل المستخدمين؟ نعم يمكن قاعدة موحدة (Core DB) تشمل الجميع بشرط: فصل منطقي صارم بـ family_id (Tenant Isolation) صفوف محمية بـ RLS أو طبقة تفويض أعلى فصل Evidence/Audit في مخازن مستقلة أو على الأقل صلاحيات مستقلة [5.2] مبدأ “مفاتيح منفصلة لكل غرض” لا نستخدم مفتاحًا واحدًا لكل شيء. نستخدم: مفاتيح للجلسات مفاتيح لتوقيع الأدلة مفاتيح لتشفير ملفات الأدلة مفاتيح للتشفير بين الجهاز والخادم [6] ## طبقات المفاتيح المقترحة (Key Hierarchy) [6.1] Caption: Key Hierarchy الطبقة الاسم مكان التخزين الاستخدام Root KMS_MASTER KMS/Secret Manager (Server) توليد/تغليف مفاتيح أدنى Tenant FAMILY_KEY Server KMS wrapped تشفير مفاتيح الأدلة للأسرة Evidence EVIDENCE_DEK Object metadata (wrapped) تشفير ملف دليل بعينه Device DEVICE_KEYPAIR Android Keystore توقيع طلبات الجهاز Session DEVICE_TOKEN Secure storage (hashed server-side) مصادقة الجهاز Export EXPORT_KEY مؤقت تشفير حزمة التصدير للأب DEK = Data Encryption Key (مفتاح بيانات لكل ملف/حزمة) KEK = Key Encryption Key (مفتاح لتشفير مفاتيح أخرى) [7] ## تشفير الأدلة (Evidence Encryption) — النموذج الأقوى والأبسط عمليًا [7.1] القاعدة ملفات الأدلة تُخزّن في Object Store مشفرة دائمًا قواعد البيانات لا تخزن المحتوى، فقط: object_uri sha256 مفاتيح DEK مغلفة (Wrapped) [7.2] Caption: Evidence File Security Fields الحقل الوصف sha256 سلامة الملف enc_alg AES-GCM (مستحسن) wrapped_dek DEK مغلف بمفتاح الأسرة nonce/iv قيمة فريدة للتشفير created_at ختم وقت source_event_id رابط الحدث [8] ## توقيع الأدلة وسلسلة العهدة (Integrity + Non-Repudiation) [8.1] لتقوية حجية الدليل داخل الأسرة: الجهاز يحسب sha256 ويضيفه للميتا الخادم يسجل custody: create/view/export أي تغيير في الملف = sha mismatch = Incident [8.2] Caption: Custody Actions action متى يحدث؟ create عند إنشاء دليل view عند فتح الدليل export عند إنشاء حزمة hold Legal hold delete_attempt محاولة حذف (حتى لو فشلت) [9] ## تدوير المفاتيح (Rotation) — متطلبات تشغيلية [9.1] Caption: Rotation Policy العنصر دورية مقترحة ملاحظة Device Token كل 30 يوم أو عند اشتباه Family Key Wrapper كل 6 أشهر شفاف للأسرة Evidence DEKs لا يحتاج تدوير لأنها per-file Export Keys لكل تصدير تنتهي سريعًا Access Tokens دقائق إلى ساعات حسب الحساسية [10] ## حماية الجلسات (Sessions) للأب/الأم — منع سرقة الحساب [10.1] مواصفات إلزامية MFA للأب على الأقل Device-bound sessions (ربط الجلسة بجهاز موثوق) “Session Revocation” من لوحة الأب تنبيه عند Login جديد أو تغيير بروتوكول دفاع [10.2] Caption: Session Events to Audit الحدث يسجل؟ login success/fail نعم mfa verify نعم session refresh نعم session revoke نعم role change نعم evidence export/delete نعم (حرج) [11] ## UI Component Spec (Parent Web Console) — مواصفات مكونات جاهزة للتطوير [11.1] الهدف: واجهة مؤسسية “تمنع الأخطاء” وتفصل صلاحيات الأب والأم. [12] ## Components Library (Design System) — مكونات أساسية [12.1] Caption: Component Library المكون وظيفته نقاط أمان UX RoleBadge عرض دور المستخدم يمنع الالتباس PermissionLock قفل المزايا الحساسة يظهر سبب المنع DangerConfirmModal تأكيد عمليات خطرة MFA + reason IncidentCard بطاقة حادثة إجراءات سريعة EvidenceRow عنصر دليل tags + custody status CustodyTimeline سلسلة عهدة شفافية PlaybookEditor محرر بروتوكول validator داخلي ModeScheduler جدول أوضاع يمنع تجاوز النوم DeviceControlPanel تحكم مباشر cooldown + reason LiveSessionWidget بث حي timer + audit GeoFenceMap مناطق آمنة تنبيهات دخول/خروج HealthStatusChip صحة الجهاز يوضح tamper/compliance [13] ## شاشة Evidence Center (تفصيل مكونات + حالات) — أهم شاشة [13.1] Layout المقترح يسار: Filters + قائمة الأدلة يمين: Preview + Metadata + Custody + Actions [13.2] Caption: Evidence Center Actions By Role Action Father Mother Auditor View ✅ ✅ ✅ Tag/Notes ✅ ✅ ❌ (اختياري) Export ✅ ❌ ❌ Delete ✅ ❌ ❌ [13.3] حالات UI إلزامية Empty State: “لا توجد أدلة بعد” Restricted Evidence: يظهر “محمي” + سبب Legal Hold: يمنع الحذف + علامة واضحة Export Flow: سبب التصدير (إلزامي) MFA رابط تنزيل مؤقت تسجيل custody.export [14] ## شاشة Live Safety (تفصيل) — لأنها أخطر نقطة في المنتج [14.1] قواعد UX كل جلسة Live: Time-bound (مثل 60 ثانية) تمديد يدوي تسجل في Audit تعطيل افتراضيًا (Opt-in) [14.2] Caption: Live Session Controls ميزة زر شرط الظهور Screenshot Now Request Screenshot Father/Mother Walkie Talkie Talk Father/Mother Live Audio Listen Father + High/Critical Live Camera View Father + Opt-in [15] ## شاشة Safety Protocol Studio (تفصيل) — واجهة التفوق [15.1] 3 Panels داخل المحرر Trigger Panel Conditions Panel Actions Panel + Constraints [15.2] Validator UI يعرض أخطاء مثل: “Blackout يتطلب Opt-in” “Self-harm لا يسمح بقفل قاسٍ افتراضيًا” “Net Quarantine يجب أن تكون مؤقتة” يمنع الحفظ إن كانت القواعد الحرجة غير متحققة [16] ## Specs للمراقبة التشغيلية (Observability) — بدون محتوى حساس [16.1] المراقبة يجب أن تكون “آمنة” لا Logs تحتوي محتوى طفل فقط Health/latency/errors [16.2] Caption: Safe Metrics Metric مثال device_online_rate نسبة اتصال الأجهزة telemetry_ingest_latency زمن الاستقبال playbook_exec_rate عدد التنفيذات tamper_incidents عدد حوادث العبث evidence_upload_failures فشل رفع أدلة [17] ## Suggested Next Steps [17.1] سأكتب لك الخطوة التالية مباشرة: مواصفات Pairing & Token Security كاملة (TTL, binding, rotation, revocation, replay protection) مع نماذج Payload واضحة. [17.2] بعدها: خطة قواعد البيانات الموحدة vs متعددة (متى نفصل Evidence/Audit فعليًا) مع قرار نهائي مناسب لنظام عالمي قابل للتوسع. [17.3] ثم ننتقل إلى Blueprint للـ Android Agent (Packages + Services + Execution) بصيغة هندسية جاهزة للبناء.
[127] [1] ## مواصفات Pairing & Token Security (v1) — ربط جهاز الطفل بأقصى أمان (TTL + Binding + Rotation + Replay Protection) [1.1] أهداف التصميم منع خطف كود الربط (Pair Code Hijack) منع انتحال الجهاز (Device Spoofing) منع إعادة إرسال الطلبات (Replay) دعم عدة أجهزة لكل طفل إلغاء صلاحيات جهاز واحد بدون التأثير على بقية الأجهزة [2] ## أنواع الرموز (Tokens) داخل النظام — تعريف رسمي [2.1] Caption: Token Types الاسم يستخدمه الهدف مدة الصلاحية PAIR_CODE الأب → الطفل بدء الربط 2–3 دقائق DEVICE_TOKEN جهاز الطفل مصادقة الجهاز للـ API 30 يوم (مع rotation) ACCESS_TOKEN الأب/الأم واجهة التحكم 10–30 دقيقة REFRESH_TOKEN الأب/الأم تجديد جلسة 30–90 يوم REALTIME_SESSION_TOKEN الأب/الأم جلسة بث حي 60–120 ثانية EVIDENCE_EXPORT_TOKEN الأب تنزيل تصدير أدلة 10–30 دقيقة [3] ## نموذج Pair Code الآمن (PAIR_CODE) — المواصفات النهائية [3.1] خصائص إلزامية قصير وواضح: مثل 8F3Q-92KM TTL قصير جدًا: 180 ثانية مرتبط دائمًا بـ: family_id child_id issued_by_principal_id (الأب أو الأم) مرة واحدة (One-time use) ثم ينتهي مباشرة [3.2] Caption: جدول Pair Codes العمود النوع القيود pair_id UUID PK not null family_id UUID not null child_id UUID not null pair_code_hash TEXT not null expires_at TIMESTAMP not null used_at TIMESTAMP nullable issued_by UUID not null allowed_device_limit INT default 1 created_at TIMESTAMP not null ملاحظة: لا تخزن Pair Code صريحًا داخل DB، بل Hash فقط. [4] ## Device Binding (ربط الجهاز فعليًا) — ضد الانتحال [4.1] المبدأ لا يكفي Pair Code وحده. لازم Binding بين: “تثبيت الوكيل” + “الجهاز الحالي” + “مفاتيح داخل Keystore”. [4.2] Caption: Device Binding Fields الحقل من أين؟ الهدف install_id يولدها الوكيل مرة يميز تثبيت التطبيق keystore_key_alias Android Keystore يثبت أن الجهاز هو نفس الجهاز public_key من keystore للتحقق من التوقيعات attestation_blob (اختياري) تقوية الثقة إذا لم تستخدم Attestation رسمي، لا تزال تستطيع بناء Binding قوي نسبيًا عبر Keystore + توقيع تحدي. [5] ## Enrollment Handshake (التسجيل) — بروتوكول عملي متسلسل [5.1] الخطوة A: الأب ينشئ Pair Code Endpoint: POST /api/v1/devices/pair-code Audit: device.pair_code.create [5.2] الخطوة B: الجهاز ينفذ enroll عبر Challenge Endpoint: POST /api/v1/devices/enroll 5.2.1 Payload تسجيل الجهاز (مقترح) { "pair_code": "8F3Q-92KM", "install_id": "9c6d2a9f-9b2c-4c83-bcfa-7f8e9d9f2e23", "device_info": { "platform": "android", "model": "SM-S928B", "os_version": "16", "agent_version": "1.0.0" }, "binding": { "public_key_pem": "-----BEGIN PUBLIC KEY-----...-----END PUBLIC KEY-----" }, "proof": { "nonce": "random-32-bytes", "signature": "base64(signature_over_nonce)" } } [5.3] التحقق الخادم Server Verification التأكد Pair Code لم ينتهِ ولم يُستخدم التأكد أن signature صحيحة باستخدام public_key إنشاء: device_id device_token (مخزن Hash في DB) سجل Audit: device.enroll.success [6] ## DEVICE_TOKEN Security (توكن الجهاز) — Rotation + Revocation + Replay Protection [6.1] Caption: قواعد DEVICE_TOKEN القاعدة التطبيق لا نخزن التوكن صريحًا في DB نخزن hash(token) فقط Token Rotates دوريًا كل 30 يوم أو عند اشتباه كل طلب جهاز يحمل X-Device-Nonce لمنع replay كل طلب يحمل X-Device-Timestamp يتحقق ضمن نافذة عند الشك: revoke فوري إيقاف جهاز واحد فقط [6.2] Replay Protection لكل جهاز: cache آخر nonce خلال 5 دقائق رفض أي nonce مكرر [6.3] Caption: Nonce Policy الحقل القيد Nonce length 16–32 bytes Validity window 120 ثانية Duplicate handling Reject + audit suspicious [7] ## Session Security للأب/الأم (Access/Refresh) — مواصفات إنتاجية [7.1] قواعد ضرورية Access Token قصير (10–30 دقيقة) Refresh Token طويل لكن: Device-bound (يرتبط بجهاز/متصفح) قابل للإلغاء من لوحة الأب تنبيه عند: تسجيل دخول جديد تغيير Playbook Evidence Export/Delete تفعيل Live Camera [7.2] Caption: Session Revocation Rules سبب الإلغاء ماذا يحدث؟ تغيير كلمة المرور إلغاء كل الجلسات فشل MFA عدة مرات قفل مؤقت اشتباه اختراق إلغاء الجلسات + فرض MFA إضافة جهاز جديد تنبيه للأب [8] ## صلاحيات Real-time Tokens (Live Sessions) — تصميم يمنع إساءة الاستخدام [8.1] REALTIME_SESSION_TOKEN لا يستخدم إلا داخل نافذة قصيرة صالح لجلسة واحدة (Single-session) [8.2] Caption: Live Session Constraints عنصر قيمة مقترحة مدة الجلسة 60 ثانية تمديد يدوي فقط أقصى جلسات/ساعة 10 Audit mandatory يظهر للطفل؟ حسب سياسة العمر/الخصوصية [9] ## قرار قاعدة البيانات: موحدة أم متعددة؟ (Unified vs Split DB) — قرار مؤسسي واضح [9.1] الإجابة المختصرة التنفيذية نعم يمكن استخدام قاعدة موحدة تشمل: المستخدمين + المشرفين + مدير النظام + المطورين لكن الأفضل معماريًا في منتج عالمي حساس: Core موحد + Evidence/Audit منفصلين (ولو منطقيًا على الأقل) [9.2] Caption: مقارنة القرار خيار المزايا العيوب الأنسب لـ DB موحدة بالكامل أبسط تشغيلًا وتكلفة أقل أي خلل صلاحيات أخطر على Evidence MVP سريع Core + Evidence DB منفصل يقلل خطر تسريب الأدلة تعقيد أعلى قليلًا منتج عالمي Core + Evidence + Audit منفصلين أعلى مستوى أمان وتدقيق تشغيل أعقد Enterprise/Institution [9.3] القرار المقترح لمنتجك Core DB موحدة Evidence DB منفصلة Audit DB منفصلة أو Append-only schema مستقل Object Store مستقل ومشفّر دائمًا [10] ## Blueprint للـ Android Child Agent (حزم + خدمات + تدفقات) — جاهز للبناء [10.1] نموذج تقسيم Packages (Kotlin/Android) [10.2] Caption: Android Packages Structure Package المسؤولية app.core إعدادات عامة + DI app.identity Pairing + Tokens + Keystore app.policy Policy cache + mode engine app.telemetry Event collector + batching app.ml On-device inference (text/image/video) app.safety playbook execution + decision loop app.executor تنفيذ الأوامر (block/kill/net) app.evidence capture + hashing + local queue app.realtime screenshot request + walkie app.antitamper permission sentinel + watchdog app.storage secure prefs + encrypted files app.network API client + retry + backoff app.audit local audit buffer [11] ## خدمات Android الأساسية (Services) — الحد الأدنى الكافي [11.1] Caption: Services Service الوظيفة يعمل متى HeartbeatService إرسال ping + آخر حالة دائم PolicySyncService مزامنة policies/modes كل X دقائق TelemetryUploadService رفع الأحداث دفعات EvidenceUploadService رفع الأدلة المؤقتة عند توفر net SafetyLoopService تنفيذ playbooks محليًا دائم/عند event TamperMonitorService كشف العبث دائم RealtimeSessionService جلسات screenshot/walkie عند الطلب [12] ## Command Execution Model (تنفيذ الأوامر) — تصميم آمن ومنظم [12.1] مبدأ التنفيذ كل أمر يأتي بصيغة موحدة: command_id type params expires_at signature (اختياري) [12.2] Caption: Command Types Command مثال APP_KILL kill messenger APP_BLOCK block tiktok NET_QUARANTINE 900 sec CAMERA_BLOCK true MIC_BLOCK true BLACKOUT_OVERLAY on MODE_APPLY sleep_mode [13] ## تصميم Queues محلية (Offline-first) — بدون فقدان أدلة [13.1] Caption: Local Queues Queue يحتوي الحجم event_queue telemetry events 10,000 evidence_queue evidence refs 200 audit_queue audit logs 5,000 command_queue pending commands 500 [14] ## سياسة “تعدد الأجهزة لكل طفل” — قواعد صارمة [14.1] Caption: Multi-Device Rules القاعدة معنى كل جهاز له device_id مستقل إدارة دقيقة كل جهاز له device_token مستقل عزل الاختراق سياسة الطفل تطبق على كل أجهزته افتراضيًا يمكن تخصيص سياسة لجهاز محدد عند الحاجة إزالة جهاز لا تزيل الطفل فصل كامل [15] ## نقاط تفوق إضافية (يمكن إضافتها بدون مخاطرة) [15.1] Device Risk Score تقييم صحة الجهاز: tamper attempts missed heartbeats outdated agent permission revokes [15.2] Caption: Device Risk Score Fields الحقل مثال risk_score 0..100 risk_reason "force_stop_repeated" last_update timestamp [16] ## Suggested Next Steps [16.1] الخطوة القادمة الأهم: أكتب لك مواصفات الأمان الشاملة للبنية الخلفية (Backend Security Baseline): Rate limiting، WAF، Secrets، CI/CD، بيئة إنتاج. [16.2] ثم أجهز لك مواصفات نموذج “Incident Response داخل الأسرة” (خطوات الوالدين + رسائل UI + Export manifest). [16.3] وبعدها نبدأ تصميم واجهة Parent Web Console بالـ components صفحة بصفحة (جاهزة لتحويلها إلى Next.js).
[128] [1] ## Backend Security Baseline (v1) — خط أساس أمني مؤسسي للمنصة بالكامل (Production-Grade) [1.1] الهدف تأسيس “قواعد تشغيل” تجعل المنصة: مقاومة للاختراق والتلاعب قابلة للتوسع عالميًا تحافظ على أدلة الأسرة بشكل موثوق تمنع إساءة الاستخدام الداخلي (Support/Dev) [2] ## طبقات الأمان الأساسية (Defense-in-Depth) [2.1] Caption: طبقات الدفاع المؤسسية الطبقة ماذا تحمي؟ الأدوات/السياسات Edge / WAF هجمات الإنترنت العامة WAF + Bot protection API Gateway تنظيم المرور Rate limiting + auth Service Layer منطق الأعمال RBAC + ABAC + Validation Data Layer قواعد البيانات RLS + Encryption Evidence Store ملفات الأدلة Immutable + encrypted Observability كشف المشاكل Metrics + safe logs CI/CD منع حقن كود ضار Signed builds + reviews IAM Org منع إساءة الموظفين SoD + least privilege [3] ## WAF + Rate Limiting — مواصفات دقيقة [3.1] WAF Rules الأساسية حجب: SQLi XSS SSRF Path traversal Bot mitigation: تحدي تلقائي عند معدل طلبات عالي Geo throttling (اختياري) [3.2] Caption: Rate Limits حسب المسار Endpoint Group Rate Limit ملاحظة /auth/* 10 req/min/IP حماية brute-force /devices/enroll 5 req/min/IP منع abuse /telemetry/* 300 req/min/device batching مستحسن /evidence/* 60 req/min/user حساس /realtime/* 20 req/min/user أخطر نقطة /policies/* 60 req/min/user /audit/* 30 req/min/user [3.3] قواعد خاصة استخدام Token Bucket أو Leaky Bucket إدخال “Penalty Box” عند abuse: 5 دقائق حظر مؤقت [4] ## API Gateway Security — مواصفات تنفيذ [4.1] طلبات API يجب أن تمر بهذه الشروط Content-Type صحيح Payload size محدود: JSON: 256KB Evidence upload: عبر Signed URLs وليس مباشرة Timeout صارم: 5–10 ثواني للطلبات العادية Reject لأي method غير مسموح [4.2] Idempotency للطلبات الخطرة mandatory للعمليات: lock/unlock export policy update mode apply الهدف: منع تكرار تنفيذ نفس الأمر بسبب إعادة الإرسال [5] ## Authentication & Authorization — القواعد الذهبية [5.1] Authentication أب/أم: Access Token قصير + Refresh طويل MFA للأب جهاز طفل: Device Token مستقل Rotation + revocation [5.2] Authorization RBAC للأدوار ABAC للشروط الحساسة: time window threat level opt-in flags cooldown [5.3] Caption: “Hard Deny” لا يتغير Mother لا يمكنها: evidence.export evidence.delete member.update_role تفعيل live audio/camera (إلا إذا الأب أجاز) [6] ## Secrets Management — إدارة الأسرار بدون تسريب [6.1] ممنوع وضع أسرار في: Git repo client bundles logs [6.2] Caption: Secrets Policy السر أين يحفظ؟ الوصول DB credentials Secret Manager Server only JWT signing keys KMS/Vault Auth service only Object store keys IAM role Evidence service API keys Secret Manager Scoped [6.3] Rotation مفاتيح JWT: كل 90 يوم (مع دعم old key) مفاتيح evidence wrapping: كل 180 يوم [7] ## Database Security Baseline — قواعد تشغيل الـ DB [7.1] Tenant Isolation كل جدول حساس يحتوي family_id تفعيل RLS أو enforcement في طبقة الخدمة منع أي Query بدون family_id predicate [7.2] Caption: DB Privileges Role صلاحياته app_readwrite CRUD على core + telemetry evidence_service CRUD على evidence metadata فقط audit_writer insert فقط على audit analytics_reader read-only على بيانات غير محتوى [7.3] Encryption At Rest: تشفير الأقراص + تشفير الأعمدة الحساسة (اختياري) In Transit: TLS دائمًا [8] ## Evidence Storage Security — Immutable Evidence Vault [8.1] مواصفات Object Store Bucket per family (أو logical partition مع prefix) Versioning ON Object Lock ON (WORM) للأدلة الحرجة أو legal_hold Default encryption ON [8.2] Signed URLs Upload الجهاز لا يرفع عبر API مباشرة يحصل على Signed URL بمدة قصيرة: 2–5 دقائق بعد الرفع: الخادم يتحقق من sha256 يسجل evidence item [9] ## Audit & Logging — بدون محتوى حساس [9.1] قاعدة ذهبية Logs لا تحتوي: نصوص محادثات صور/صوت بيانات طفل حساسة [9.2] Caption: What to Log نوع مثال action policy.update actor principal_id target device_id result success/fail latency 120ms reason export_reason [10] ## Observability (Metrics/Tracing) — اكتشاف الأعطال والهجمات [10.1] Metrics أساسية telemetry ingest latency evidence upload success rate tamper incidents per family login failures realtime sessions started [10.2] Alerts (SRE) spike في /auth/login fails spike في telemetry events من device واحد evidence export anomalies service error rate > 1% [11] ## CI/CD Security — حماية النشر من التلاعب [11.1] قواعد مؤسسية Branch protection Mandatory code review Signed builds Dependency scanning Secret scanning SAST/DAST (حسب الإمكانية) Deploy approvals للـ Production [11.2] Caption: CI/CD Gates المرحلة شرط المرور Build ينجح بدون أسرار Test unit + integration Security Scan deps + static analysis Artifact Signing توقيع package Deploy approvals + canary [12] ## Security Operations (SOC) — بدون الوصول لمحتوى الأسرة [12.1] فصل الواجبات SoD SOC يرى: نمط هجمات على المنصة معدلات فشل دخول هجمات DoS SOC لا يرى: أي Evidence content [12.2] Incident Response داخلي للمنصة Detection Containment Eradication Recovery Postmortem [13] ## Family Incident Response (داخل الأسرة) — مواصفات واجهة + خطوات [13.1] هدف Incident View عرض: ماذا حدث؟ ماذا فعل النظام تلقائيًا؟ ما الذي تم توثيقه؟ ماذا تقترح المنصة للوالدين؟ [13.2] Caption: Incident Panel Sections قسم محتواه Summary نوع الحادثة + الطفل + الجهاز Auto Actions kill app / quarantine Evidence قائمة الأدلة المرتبطة Recommendations talk / lock / export Timeline وقت بدء وتطور الحادثة Parent Actions walkie / unlock / legal hold [14] ## Evidence Export Manifest — ملف قانوني داخلي (مهم جدًا) [14.1] عند تصدير الأدلة، يتم بناء حزمة تحتوي: الملفات المشفرة/أو المفكوكة حسب السياسة manifest.json checksums.txt custody_log.json [14.2] مثال Manifest مختصر { "export_id": "UUID", "family_id": "UUID", "requested_by": "FATHER_PRINCIPAL_ID", "created_at": "2026-01-18T21:00:00Z", "items": [ { "evidence_id": "UUID", "sha256": "....", "content_type": "image", "source_event_id": "UUID" } ] } [15] ## قرارات أمنية نهائية (Final Decisions) — لتكون منصة عالمية [15.1] قرار 1: لا دعم فني يملك أي وصول للمحتوى الدعم يرى health فقط أي محتوى Evidence = داخل الأسرة فقط [15.2] قرار 2: Live Features افتراضيًا OFF الأب يفعّلها صراحة ABAC يقيّدها [15.3] قرار 3: Evidence immutable عند high/critical Object lock + legal hold [15.4] قرار 4: كل شيء Audit خصوصًا export/delete/lock/live [16] ## Suggested Next Steps [16.1] الخطوة التالية: سأكتب لك مواصفات “التحكم الفوري بالجهاز” Device Control Protocol (command signing + expiry + ack + retries) بشكل جاهز للتطبيق. [16.2] ثم أجهز لك نموذج “Risk Scoring Engine” للأجهزة والأطفال (بدون انتهاك خصوصية). [16.3] وبعدها نبدأ بناء Next.js UI Spec (صفحة Dashboard وEvidence Center كاملة بالتفاصيل).
[129] [1] ## Device Control Protocol (v1) — بروتوكول التحكم الفوري بالجهاز (Commands) بشكل مؤسسي [1.1] الهدف ضمان أن كل أمر يُرسل إلى جهاز الطفل: صحيح المصدر (Authentic) غير قابل للتلاعب (Integrity) لا يُنفذ بعد انتهاء صلاحيته (Expiry) لا يتكرر بلا داعٍ (Idempotency) يمكن تتبعه وتدقيقه (Audit) يعمل حتى مع الشبكة الضعيفة (Retries/ACK) [2] ## نموذج تنفيذ الأوامر (Command Lifecycle) [2.1] دورة حياة الأمر: الأب/الأم يطلب إجراء (من Web Console أو Automation) الخادم ينشئ command الجهاز يستلم الأمر عبر: Polling آمن أو Push (إن توفر) الجهاز ينفذ الأمر الجهاز يرسل ACK بالنتيجة الخادم يحدث الحالة + يسجل Audit [3] ## شكل الأمر (Command Envelope) — عقد رسمي [3.1] Caption: Command Envelope Schema الحقل النوع إلزامي شرح command_id UUID ✅ معرف فريد family_id UUID ✅ العزل device_id UUID ✅ الجهاز الهدف issued_by UUID ✅ الأب/الأم/النظام issued_at TIMESTAMP ✅ وقت الإصدار expires_at TIMESTAMP ✅ انتهاء الصلاحية type ENUM ✅ نوع الأمر params JSON ✅ إعدادات التنفيذ priority ENUM ✅ low/med/high/critical reason TEXT ⚠️ إلزامي للأوامر الحساسة nonce TEXT ✅ منع replay idempotency_key TEXT ✅ منع التكرار signature TEXT ⚠️ توقيع الخادم (مستحسن) توقيع الخادم على الأوامر يجعل “حقن أمر” شبه مستحيل حتى لو حصل خلل في قناة الاتصال. [4] ## أنواع الأوامر (Command Types) — مجموعة v1 النهائية [4.1] Caption: Command Types Catalog Command Type خطورته مثال Params APP_KILL Medium { "package": "com.chat.app" } APP_BLOCK Medium { "package": "com.tiktok" } NET_LIMITED High { "duration_sec": 1800, "allow": ["zoom","classroom"] } NET_QUARANTINE High { "duration_sec": 900 } CAMERA_BLOCK High { "enabled": true } MIC_BLOCK High { "enabled": true } BLACKOUT_OVERLAY Critical { "enabled": true, "message": "راجع أحد الوالدين" } MODE_APPLY Low/Medium { "mode_id": "UUID" } DEVICE_UNLOCK Critical { "confirm": true } REQUEST_SCREENSHOT Medium { "quality": "medium" } WALKIE_START Medium { "session_sec": 60 } POLICY_SYNC_NOW Low {} [5] ## صلاحيات إصدار الأوامر (Who Can Issue What) [5.1] Caption: Command Authorization Matrix الأمر Father Mother System Support APP_KILL/BLOCK ✅ ✅ ✅ ❌ NET_QUARANTINE ✅ ✅ ✅ ❌ CAMERA/MIC_BLOCK ✅ ✅ (حسب إذن) ✅ ❌ BLACKOUT_OVERLAY ✅ ❌ ✅ (Critical فقط) ❌ DEVICE_UNLOCK ✅ ❌ ❌ ❌ REQUEST_SCREENSHOT ✅ ✅ ✅ (incident) ❌ WALKIE_START ✅ ✅ ✅ (incident) ❌ “System” يقصد به محرك الأمان فقط، وليس موظفين. [6] ## Expiry & Cooldown — منع الأوامر التعسفية [6.1] قيم افتراضية: expires_at = issued_at + 120 sec للأوامر الفورية expires_at = issued_at + 10 min للأوامر غير الحرجة [6.2] Caption: Cooldown Rules الأمر Cooldown NET_QUARANTINE 3 دقائق BLACKOUT_OVERLAY 10 دقائق LIVE AUDIO/CAM 2 دقيقة REQUEST_SCREENSHOT 30 ثانية [7] ## ACK Protocol (اعتراف التنفيذ) — موثوق وقابل للتدقيق [7.1] بعد التنفيذ، الجهاز يرسل: command_id status executed_at result evidence_ref إن وجد [7.2] مثال ACK { "command_id": "UUID", "device_id": "UUID", "status": "success", "executed_at": "2026-01-18T22:10:00Z", "result": { "details": "app killed", "package": "com.chat.app" } } [7.3] حالات ACK success failed (مع سبب آمن) expired rejected_policy not_supported [8] ## Retries & Delivery — كيف نضمن وصول الأوامر؟ [8.1] الأسلوب الأفضل عمليًا الجهاز يعمل Polling آمن: كل 5–10 ثواني عند Online كل 30 ثانية عند Battery low عند وجود أمر Critical: Polling يصبح أسرع مؤقتًا (Burst) [8.2] Retry في الخادم إذا لم يصل ACK خلال 20 ثانية: إعادة إرسال الأمر مرة واحدة فقط نفس idempotency_key [9] ## منع Replay للأوامر — Nonce + Window [9.1] كل أمر يحمل Nonce الجهاز يحتفظ بآخر 200 nonce يرفض أي nonce مكرر [9.2] نافذة قبول زمنية إذا issued_at قديم جدًا: Reject [10] ## توقيع الأوامر (Command Signing) — مستوى مؤسسي أعلى [10.1] نموذج مبسط الخادم يوقع hash(command_payload) الجهاز يتحقق عبر public key ثابت داخل التطبيق [10.2] فوائد منع حقن أوامر حتى لو حصل خلل بالشبكة يجعل أي تعديل في Params مكشوف فورًا [11] ## سجل التدقيق للأوامر (Command Audit) [11.1] Caption: Audit Events للأوامر الحدث يسجل؟ command.create ✅ command.delivered ✅ command.executed ✅ command.failed ✅ command.expired ✅ command.replayed ✅ [12] ## Risk Scoring Engine (v1) — تقييم الخطر للطفل والجهاز بدون انتهاك خصوصية [12.1] الهدف: إعطاء الأب لوحة “مؤشر مخاطر” بدل مراقبة محتوى دائم [12.2] مصادر الخطر كثرة incidents tamper attempts late-night activity geofence violations repeated grooming signals [12.3] Caption: Risk Score Signals Signal وزن مقترح grooming_high +25 sextortion_critical +40 tamper_high +20 geofence_violation +10 repeated bullying +15 self_harm_words +30 ثم يتم تطبيق “Decay” أسبوعي لتفادي تضخيم دائم. [13] ## Risk Score Output Model [13.1] Caption: Risk Score Fields Field مثال child_risk_score 72 device_risk_score 55 top_reasons grooming_high, tamper_high trend up/down/stable last_updated timestamp [14] ## Next.js UI Spec — Dashboard + Evidence Center (بداية التنفيذ) [14.1] Dashboard Layout Header: Family switch + Alerts icon Left: Children cards Right: Incidents timeline Bottom: Device health grid [14.2] Evidence Center Layout Filters Sidebar Evidence List Evidence Details Drawer Custody timeline Export/Delete (Father only) [15] ## Suggested Next Steps [15.1] الخطوة القادمة مباشرة: سأكتب لك Next.js Component Spec كامل لصفحة Evidence Center (props/state/actions/errors) لتتحول إلى كود جاهز. [15.2] ثم صفحة Dashboard بنفس المستوى. [15.3] بعدها ننفذ “Data contracts” للواجهة مع الـ API (TypeScript types + Zod validation).
[130] [1] ## Next.js Evidence Center — Component Spec كامل (Enterprise-Grade) جاهز للتحويل إلى كود [1.1] هدف الصفحة عرض الأدلة الخاصة بالأسرة بشكل آمن + قابل للتدقيق + قابل للبحث تنفيذ “أفعال خطرة” (Export/Delete) للأب فقط وبضوابط قوية [1.2] مسار الصفحة /console/evidence [2] ## Evidence Center Layout (هيكل الواجهة) [2.1] Caption: Evidence Center Regions Region العرض المحتوى Left Sidebar 280–340px Filters + Quick Stats Middle List 420–560px Evidence Timeline/List Right Panel Flexible Preview + Metadata + Custody + Actions [2.2] Empty States لا يوجد أدلة فلاتر شديدة لا تعيد نتائج دليل “Restricted / Legal Hold” خطأ شبكة/تصريح [3] ## RBAC داخل الصفحة (الأب/الأم/المدقق) [3.1] Caption: Evidence Actions Matrix Action Father Mother Auditor View Evidence ✅ ✅ ✅ Add Tag / Note ✅ ✅ ❌ Export Evidence ✅ ❌ ❌ Delete Evidence ✅ ❌ ❌ Set Legal Hold ✅ ❌ ❌ أي محاولة فعل غير مسموح = Hard Deny + Audit. [4] ## Contracts البيانات (Frontend Data Contracts) [4.1] Caption: Evidence Item DTO (واجهة المستخدم) Field Type Example evidence_id string(UUID) "..." child_id string(UUID) "..." device_id string(UUID) "..." created_at string(ISO) "2026-01-18T..." content_type "text" | "image" | "audio" | "video" "image" severity "low" | "med" | "high" | "critical" "high" classification "normal" | "restricted" | "legal_hold" "legal_hold" summary string "Grooming suspected..." sha256 string "..." has_preview boolean true [5] ## Page State Model (حالات الصفحة) [5.1] حالات أساسية loading: تحميل أولي listReady: جاهز detailsLoading: تحميل تفاصيل الدليل exporting: تصدير جارٍ deleting: حذف جارٍ error: خطأ [5.2] Caption: Evidence Center UI State State متى يظهر؟ UI loading أول فتح Skeleton listReady بعد جلب القائمة List + Filters detailsLoading عند اختيار دليل Spinner داخل Panel exporting تصدير Modal + Progress deleting حذف Danger confirm + Disabled UI error network/auth Error banner + retry [6] ## Component Inventory (مكونات الصفحة) [6.1] Caption: Evidence Center Components Component Responsibility Critical Notes EvidenceFiltersSidebar فلاتر + إحصائيات لا يرسل طلبات كثيرة (debounce) EvidenceList عرض الأدلة كقائمة Virtualize عند كثرة البيانات EvidenceListItem بطاقة دليل يوضح severity + tags + lock EvidenceDetailsPanel تفاصيل + preview + custody يمنع preview لو restricted CustodyTimeline سلسلة العهدة تحميل منفصل EvidenceActionsBar Export/Delete/Legal Hold RBAC + Confirmation DangerConfirmModal سبب + MFA + Confirm إلزامي للأفعال الخطرة ExportResultModal رابط مؤقت + expiry لا يُعرض للأم SafeToast إشعارات بدون تسريب بيانات QuerySync حفظ الفلاتر في URL قابل للمشاركة داخل الأسرة فقط [7] ## Filters Spec (فلاتر شاملة + آمنة) [7.1] Caption: Filters Fields Filter Type Example Child dropdown child_id Device dropdown device_id Content Type multi-select image/audio Severity multi-select high/critical Date Range from/to last 7 days Classification dropdown legal_hold Search Summary textbox "grooming" [7.2] قواعد UX مهمة “Search” يعمل على summary/tags فقط (وليس محتوى الدليل) الفلاتر تكتب في URL (مفيد للعودة لنفس العرض) Debounce = 400ms [8] ## Evidence Details Panel Spec [8.1] أقسام اليمين Header: نوع الدليل + الوقت + الطفل + الجهاز Preview: Image/Audio/Video/Text (حسب permissions) Metadata: sha256, source event, classification Custody Timeline Actions (Export/Delete للأب) [8.2] Caption: Preview Rules classification Preview allowed? ملاحظة normal ✅ restricted ✅ (Father/Mother) بدون تصدير legal_hold ✅ ممنوع delete [9] ## Export Flow (Father only) — UX + Security Steps [9.1] خطوات تصدير صحيحة يضغط Father “Export” يظهر DangerConfirmModal سبب التصدير إلزامي MFA verification إذا مطلوب الخادم يبني حزمة يعود export_uri + expires_at يظهر ExportResultModal مع: Download link expiry timer hash/manifest mention [9.2] Caption: Export UI Guards Guard كيف يظهر؟ Reason required زر Confirm disabled MFA required خطوة إضافية Cooldown رسالة “انتظر…” Audit always شريط “تم تسجيل العملية” [10] ## Delete Flow (Father only) — أقصى تشدد [10.1] شروط حذف ممنوع حذف legal_hold حذف يحتاج: سبب MFA (مستحسن دائمًا) “Cooling delay” 30–60 ثانية (اختياري) [10.2] Delete UI modal أحمر Checkbox: “I understand evidence will be removed” Confirm بعد كتابة كلمة مثل: DELETE [11] ## Next.js Dashboard — Spec كاملة (Home Console) [11.1] هدف الصفحة رؤية حالة الأسرة خلال 15 ثانية: الحوادث صحة الأجهزة الموقع إجراءات سريعة [11.2] مسار /console [11.3] Caption: Dashboard Sections Section Primary Content Secondary Top Bar Alerts + Risk Score Quick search Children Grid Cards لكل طفل Last incident Incidents Timeline آخر 20 حادثة Filter by severity Device Health Grid online/offline/compliance tamper badge Quick Actions Quarantine/Walkie/Screenshot RBAC enforced Weekly Summary trends suggestions [12] ## Dashboard Components [12.1] Caption: Components Component Responsibility Notes ChildrenCardsGrid بطاقات الأطفال click opens child view ChildCard risk + last seen + location لا تعرض محتوى حساس IncidentsTimeline list incidents “Open Incident” DeviceHealthPanel compliance + tamper supports filter QuickActionsPanel actions reason required لبعضها AlertsBell unread alerts acknowledges RiskScoreBadge scores trend arrow [13] ## TypeScript Types + Zod Validation (موحد للواجهة) [13.1] ملف واحد جاهز للنسخ (Types + Schemas) هذا مثال عملي مكتمل يمكنك وضعه مباشرة داخل مشروع Next.js. // app/console/_contracts/securityContracts.ts import { z } from "zod"; /* ========================= Enums (Strict) ========================= */ export const SeverityZ = z.enum(["low", "med", "high", "critical"]); export type Severity = z.infer <typeof SeverityZ> ; export const ContentTypeZ = z.enum(["text", "image", "audio", "video"]); export type ContentType = z.infer <typeof ContentTypeZ> ; export const ClassificationZ = z.enum(["normal", "restricted", "legal_hold"]); export type Classification = z.infer <typeof ClassificationZ> ; export const PrincipalRoleZ = z.enum([ "FAMILY_OWNER", "FAMILY_COADMIN_LIMITED", "FAMILY_AUDITOR_READONLY", "SYSTEM_ADMIN", "SECURITY_OFFICER", "SUPPORT_AGENT" ]); export type PrincipalRole = z.infer <typeof PrincipalRoleZ> ; /* ========================= Evidence Item DTO ========================= */ export const EvidenceItemZ = z.object({ evidence_id: z.string().uuid(), family_id: z.string().uuid(), child_id: z.string().uuid(), device_id: z.string().uuid(), created_at: z.string().datetime(), content_type: ContentTypeZ, severity: SeverityZ, classification: ClassificationZ, summary: z.string().min(1).max(500), sha256: z.string().min(32).max(128), has_preview: z.boolean() }); export type EvidenceItem = z.infer <typeof EvidenceItemZ> ; /* ========================= Evidence List Response ========================= */ export const EvidenceListResponseZ = z.object({ items: z.array(EvidenceItemZ), next_cursor: z.string().nullable() }); export type EvidenceListResponse = z.infer <typeof EvidenceListResponseZ> ; /* ========================= Evidence Custody DTO ========================= */ export const CustodyActionZ = z.enum([ "create", "view", "export", "hold", "delete_attempt" ]); export const EvidenceCustodyZ = z.object({ custody_id: z.string().uuid(), evidence_id: z.string().uuid(), actor_id: z.string().uuid(), action: CustodyActionZ, reason: z.string().max(400).nullable(), created_at: z.string().datetime() }); export type EvidenceCustody = z.infer <typeof EvidenceCustodyZ> ; export const EvidenceDetailsZ = z.object({ item: EvidenceItemZ, custody: z.array(EvidenceCustodyZ) }); export type EvidenceDetails = z.infer <typeof EvidenceDetailsZ> ; /* ========================= Export Request/Response ========================= */ export const EvidenceExportRequestZ = z.object({ evidence_id: z.string().uuid(), reason: z.string().min(5).max(300), idempotency_key: z.string().min(8).max(128) }); export type EvidenceExportRequest = z.infer <typeof EvidenceExportRequestZ> ; export const EvidenceExportResponseZ = z.object({ export_id: z.string().uuid(), export_uri: z.string().url(), expires_at: z.string().datetime(), export_sha256: z.string().min(32).max(128) }); export type EvidenceExportResponse = z.infer <typeof EvidenceExportResponseZ> ; /* ========================= Command Protocol DTO ========================= */ export const CommandTypeZ = z.enum([ "APP_KILL", "APP_BLOCK", "NET_LIMITED", "NET_QUARANTINE", "CAMERA_BLOCK", "MIC_BLOCK", "BLACKOUT_OVERLAY", "MODE_APPLY", "DEVICE_UNLOCK", "REQUEST_SCREENSHOT", "WALKIE_START", "POLICY_SYNC_NOW" ]); export type CommandType = z.infer <typeof CommandTypeZ> ; export const CommandEnvelopeZ = z.object({ command_id: z.string().uuid(), family_id: z.string().uuid(), device_id: z.string().uuid(), issued_by: z.string().uuid(), issued_at: z.string().datetime(), expires_at: z.string().datetime(), type: CommandTypeZ, params: z.record(z.any()), priority: z.enum(["low", "med", "high", "critical"]), reason: z.string().max(300).nullable(), nonce: z.string().min(8).max(256), idempotency_key: z.string().min(8).max(128), signature: z.string().nullable() }); export type CommandEnvelope = z.infer <typeof CommandEnvelopeZ> ; [14] ## Evidence Center API (Frontend Calls) — توصيف واضح [14.1] Caption: API Calls Needed Operation Method Path Returns List evidence GET /api/v1/evidence?filters... EvidenceListResponse Get details GET /api/v1/evidence/:id EvidenceDetails Export evidence POST /api/v1/evidence/:id/export EvidenceExportResponse Delete evidence POST /api/v1/evidence/:id/delete { ok: true } Add tags/notes POST /api/v1/evidence/:id/tags { ok: true } [15] ## Error Handling (Frontend) — بدون تسريب معلومات [15.1] أخطاء متوقعة 401: session expired → redirect login 403: forbidden → show “ليس لديك صلاحية” 429: rate limited → retry with backoff 5xx: server error → safe message [15.2] Caption: Error UI Patterns Code UI Message Action 401 Session expired Login 403 Not permitted Hide action 404 Evidence not found refresh list 429 Slow down auto retry 500 Something went wrong retry [16] ## Suggested Next Steps [16.1] إذا تريد الانتقال للتنفيذ الفعلي: أكتب لك الآن ملف Next.js Page كامل لصفحة Evidence Center (React + Tailwind + Components) بكود واحد جاهز للنسخ. [16.2] بعده مباشرة أكتب Dashboard Page كامل بنفس الأسلوب. [16.3] ثم نربط الصفحتين بـ Mock API Layer أولًا (حتى تنجز الواجهة قبل الباك-إند).
[131] إذا تحتاج أنماط ونماذج هذه تكون كفيدة لكن يجب الحفاظ على الهوية البصرية للمشروع [1] ## ملف Next.js كامل — صفحة Evidence Center جاهزة للنسخ (React + Tailwind + Lucide + Mock API) المسار المقترح: app/console/evidence/page.tsx هذا الملف مكتمل من أول سطر لآخر سطر ويعمل كـ UI جاهز مع Mock API داخلي (يمكنك لاحقًا استبداله بـ API الحقيقي). 'use client'; import React, { useEffect, useMemo, useRef, useState } from 'react'; import { z } from 'zod'; import { Search, Filter, ShieldAlert, ShieldCheck, ShieldX, RefreshCw, Download, Trash2, Lock, Clock, Tag, FileText, Image as ImageIcon, Mic, Video, ChevronRight, X, CheckCircle2, AlertTriangle, Loader2, } from 'lucide-react'; /* ========================================================= Evidence Center — Production-grade UI Spec Implementation Path: /console/evidence RBAC: Father export/delete only Safe: No content leakage in logs/toasts Mock API for immediate use ========================================================= */ /* ========================= ENV / MOCK SWITCH ========================= */ const USE_MOCKS = true; // set to false when wiring real API /* ========================= Zod Contracts (inline) ========================= */ const SeverityZ = z.enum(['low', 'med', 'high', 'critical']); type Severity = z.infer <typeof SeverityZ> ; const ContentTypeZ = z.enum(['text', 'image', 'audio', 'video']); type ContentType = z.infer <typeof ContentTypeZ> ; const ClassificationZ = z.enum(['normal', 'restricted', 'legal_hold']); type Classification = z.infer <typeof ClassificationZ> ; const PrincipalRoleZ = z.enum([ 'FAMILY_OWNER', 'FAMILY_COADMIN_LIMITED', 'FAMILY_AUDITOR_READONLY', 'SYSTEM_ADMIN', 'SECURITY_OFFICER', 'SUPPORT_AGENT', ]); type PrincipalRole = z.infer <typeof PrincipalRoleZ> ; const EvidenceItemZ = z.object({ evidence_id: z.string().uuid(), family_id: z.string().uuid(), child_id: z.string().uuid(), device_id: z.string().uuid(), created_at: z.string(), content_type: ContentTypeZ, severity: SeverityZ, classification: ClassificationZ, summary: z.string().min(1).max(500), sha256: z.string().min(32).max(128), has_preview: z.boolean(), tags: z.array(z.string()).optional().default([]), }); type EvidenceItem = z.infer <typeof EvidenceItemZ> ; const EvidenceListResponseZ = z.object({ items: z.array(EvidenceItemZ), next_cursor: z.string().nullable(), }); type EvidenceListResponse = z.infer <typeof EvidenceListResponseZ> ; const CustodyActionZ = z.enum(['create', 'view', 'export', 'hold', 'delete_attempt']); const EvidenceCustodyZ = z.object({ custody_id: z.string().uuid(), evidence_id: z.string().uuid(), actor_id: z.string().uuid(), action: CustodyActionZ, reason: z.string().max(400).nullable(), created_at: z.string(), }); type EvidenceCustody = z.infer <typeof EvidenceCustodyZ> ; const EvidenceDetailsZ = z.object({ item: EvidenceItemZ, custody: z.array(EvidenceCustodyZ), notes: z.string().max(1200).nullable(), }); type EvidenceDetails = z.infer <typeof EvidenceDetailsZ> ; const EvidenceExportResponseZ = z.object({ export_id: z.string().uuid(), export_uri: z.string().url(), expires_at: z.string(), export_sha256: z.string().min(32).max(128), }); type EvidenceExportResponse = z.infer <typeof EvidenceExportResponseZ> ; /* ========================= RBAC Helpers ========================= */ type Principal = { principal_id: string; role: PrincipalRole; display_name: string; }; function canExport(role: PrincipalRole) { return role === 'FAMILY_OWNER'; } function canDelete(role: PrincipalRole) { return role === 'FAMILY_OWNER'; } function canWriteNotes(role: PrincipalRole) { return role === 'FAMILY_OWNER' || role === 'FAMILY_COADMIN_LIMITED'; } /* ========================= UI Helpers ========================= */ function clsx(...parts: Array<string | false | null | undefined>) { return parts.filter(Boolean).join(' '); } function fmtDate(iso: string) { try { const d = new Date(iso); return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', }); } catch { return iso; } } function severityBadge(sev: Severity) { if (sev === 'critical') return { label: 'Critical', className: 'bg-red-100 text-red-700 border-red-200', icon: ShieldX }; if (sev === 'high') return { label: 'High', className: 'bg-orange-100 text-orange-700 border-orange-200', icon: ShieldAlert }; if (sev === 'med') return { label: 'Medium', className: 'bg-yellow-100 text-yellow-700 border-yellow-200', icon: AlertTriangle }; return { label: 'Low', className: 'bg-emerald-100 text-emerald-700 border-emerald-200', icon: ShieldCheck }; } function contentIcon(ct: ContentType) { if (ct === 'image') return ImageIcon; if (ct === 'audio') return Mic; if (ct === 'video') return Video; return FileText; } function classificationChip(c: Classification) { if (c === 'legal_hold') return { label: 'Legal Hold', className: 'bg-slate-900 text-white border-slate-900', icon: Lock }; if (c === 'restricted') return { label: 'Restricted', className: 'bg-slate-100 text-slate-700 border-slate-200', icon: Lock }; return { label: 'Normal', className: 'bg-slate-50 text-slate-600 border-slate-200', icon: CheckCircle2 }; } function newIdempotencyKey() { const rand = Math.random().toString(36).slice(2); return idem_${Date.now()}_${rand} ; } /* ========================= Toast ========================= */ type ToastKind = 'success' | 'error' | 'info'; type ToastMsg = { id: string; kind: ToastKind; title: string; message?: string }; function SafeToast({ toasts, onDismiss }: { toasts: ToastMsg[]; onDismiss: (id: string) => void }) { return ( <div className="fixed top-4 right-4 z-[60] w-[360px] space-y-2"> {toasts.map((t) => ( <div key={t.id} className={clsx( 'rounded-2xl border bg-white shadow-lg p-4', t.kind === 'success' && 'border-emerald-200', t.kind === 'error' && 'border-red-200', t.kind === 'info' && 'border-slate-200' )} > <div className="flex items-start gap-3"> <div className={clsx( 'mt-0.5 h-9 w-9 rounded-xl flex items-center justify-center', t.kind === 'success' && 'bg-emerald-50', t.kind === 'error' && 'bg-red-50', t.kind === 'info' && 'bg-slate-50' )} > {t.kind === 'success' && <CheckCircle2 className="h-5 w-5 text-emerald-700" /> } {t.kind === 'error' && <ShieldX className="h-5 w-5 text-red-700" /> } {t.kind === 'info' && <Clock className="h-5 w-5 text-slate-700" /> } </div> code Code download content_copy expand_less < div className = "min-w-0 flex-1" > < div className = "flex items-start justify-between gap-3" > < div className = "min-w-0" > < div className = "font-semibold text-slate-900" > {t.title} </ div > {t.message && < div className = "mt-1 text-sm text-slate-600" > {t.message} </ div > } </ div > < button onClick = {() => onDismiss(t.id)} className="rounded-lg p-1 text-slate-500 hover:bg-slate-100 hover:text-slate-700" aria-label="Dismiss" > < X className = "h-4 w-4" /> </ button > </ div > </ div > </ div > </ div > ))} </ div > ); } /* ========================= Modal: Danger Confirm (Reason + Optional MFA) ========================= */ type DangerConfirmModalProps = { open: boolean; title: string; description: string; confirmLabel: string; confirmDanger?: boolean; requiresMfa?: boolean; requiresReason?: boolean; reasonMinLen?: number; requireTyping?: string; // e.g. "DELETE" onCancel: () => void; onConfirm: (payload: { reason: string; mfaCode: string; typed: string }) => Promise <void> ; }; function DangerConfirmModal(props: DangerConfirmModalProps) { const { open, title, description, confirmLabel, confirmDanger, requiresMfa, requiresReason, reasonMinLen = 5, requireTyping, onCancel, onConfirm, } = props; const [reason, setReason] = useState(''); const [mfaCode, setMfaCode] = useState(''); const [typed, setTyped] = useState(''); const [busy, setBusy] = useState(false); useEffect(() => { if (!open) { setReason(''); setMfaCode(''); setTyped(''); setBusy(false); } }, [open]); const allow = (!requiresReason || reason.trim().length >= reasonMinLen) && (!requiresMfa || mfaCode.trim().length >= 4) && (!requireTyping || typed.trim().toUpperCase() === requireTyping.toUpperCase()); if (!open) return null; return ( <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 p-4"> <div className="w-full max-w-[560px] rounded-3xl bg-white shadow-2xl border border-slate-200 overflow-hidden"> <div className="p-6"> <div className="flex items-start gap-4"> <div className={clsx('h-12 w-12 rounded-2xl flex items-center justify-center', confirmDanger ? 'bg-red-50' : 'bg-slate-50')}> {confirmDanger ? <ShieldAlert className="h-6 w-6 text-red-700" /> : <Clock className="h-6 w-6 text-slate-700" /> } </div> code Code download content_copy expand_less < div className = "min-w-0 flex-1" > < div className = "text-lg font-semibold text-slate-900" > {title} </ div > < div className = "mt-1 text-sm text-slate-600" > {description} </ div > </ div > < button onClick = {onCancel} className = "rounded-xl p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-700" aria-label = "Close" disabled = {busy} > < X className = "h-5 w-5" /> </ button > </ div > {(requiresReason || requiresMfa || requireTyping) && < div className = "mt-6 space-y-4" > {requiresReason && ( < div > < label className = "text-sm font-medium text-slate-800" > Reason (required) </ label > < textarea className = "mt-2 w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" rows = {3} placeholder = "Write a clear reason for audit trail..." value = {reason} onChange = {(e) => setReason(e.target.value)} disabled={busy} /> < div className = "mt-1 text-xs text-slate-500" > Minimum {reasonMinLen} characters. </ div > </ div > )} {requiresMfa && ( < div > < label className = "text-sm font-medium text-slate-800" > MFA Code </ label > < input className = "mt-2 w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" placeholder = "123456" inputMode = "numeric" value = {mfaCode} onChange = {(e) => setMfaCode(e.target.value)} disabled={busy} /> < div className = "mt-1 text-xs text-slate-500" > This step is required for sensitive actions. </ div > </ div > )} {requireTyping && ( < div > < label className = "text-sm font-medium text-slate-800" > Type < span className = "font-semibold text-slate-900" > {requireTyping} </ span > to confirm </ label > < input className = "mt-2 w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" placeholder = {requireTyping} value = {typed} onChange = {(e) => setTyped(e.target.value)} disabled={busy} /> </ div > )} </ div > } < div className = "mt-6 flex items-center justify-end gap-3" > < button onClick = {onCancel} className = "rounded-2xl border border-slate-200 px-4 py-2.5 text-sm font-medium text-slate-700 hover:bg-slate-50" disabled = {busy} > Cancel </ button > < button onClick = {async () => { if (!allow) return; setBusy(true); try { await onConfirm({ reason: reason.trim(), mfaCode: mfaCode.trim(), typed: typed.trim() }); } finally { setBusy(false); } }} className={clsx( 'rounded-2xl px-4 py-2.5 text-sm font-semibold text-white', confirmDanger ? 'bg-red-600 hover:bg-red-700' : 'bg-slate-900 hover:bg-slate-950', !allow && 'opacity-50 cursor-not-allowed' )} disabled={!allow || busy} > {busy ? < span className = "inline-flex items-center gap-2" > < Loader2 className = "h-4 w-4 animate-spin" /> Processing </ span > : confirmLabel} </ button > </ div > </ div > </ div > </ div > ); } /* ========================= Modal: Export Result ========================= */ function ExportResultModal({ open, onClose, exportResp, }: { open: boolean; onClose: () => void; exportResp: EvidenceExportResponse | null; }) { if (!open || !exportResp) return null; return ( <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/40 p-4"> <div className="w-full max-w-[560px] rounded-3xl bg-white shadow-2xl border border-slate-200 overflow-hidden"> <div className="p-6"> <div className="flex items-start gap-4"> <div className="h-12 w-12 rounded-2xl bg-emerald-50 flex items-center justify-center"> <CheckCircle2 className="h-6 w-6 text-emerald-700" /> </div> code Code download content_copy expand_less < div className = "min-w-0 flex-1" > < div className = "text-lg font-semibold text-slate-900" > Export ready </ div > < div className = "mt-1 text-sm text-slate-600" > A temporary download link was generated. It will expire automatically. </ div > </ div > < button onClick = {onClose} className = "rounded-xl p-2 text-slate-500 hover:bg-slate-100 hover:text-slate-700" aria-label = "Close" > < X className = "h-5 w-5" /> </ button > </ div > < div className = "mt-6 space-y-3" > < div className = "rounded-2xl border border-slate-200 bg-slate-50 p-4" > < div className = "text-xs font-semibold text-slate-600" > Expires at </ div > < div className = "mt-1 text-sm text-slate-900" > {fmtDate(exportResp.expires_at)} </ div > </ div > < div className = "rounded-2xl border border-slate-200 bg-white p-4" > < div className = "text-xs font-semibold text-slate-600" > Export SHA-256 </ div > < div className = "mt-1 text-sm font-mono text-slate-800 break-all" > {exportResp.export_sha256} </ div > </ div > < a href = {exportResp.export_uri} target = "_blank" rel = "noreferrer" className = "inline-flex w-full items-center justify-center gap-2 rounded-2xl bg-slate-900 px-4 py-3 text-sm font-semibold text-white hover:bg-slate-950" > < Download className = "h-4 w-4" /> Download export package </ a > </ div > < div className = "mt-6 text-xs text-slate-500" > This operation has been recorded in the custody chain and audit logs. </ div > </ div > </ div > </ div > ); } /* ========================= Mock Data + Mock API ========================= */ const MOCK_PRINCIPAL: Principal = { principal_id: crypto.randomUUID(), role: 'FAMILY_OWNER', // change to FAMILY_COADMIN_LIMITED to test Mother display_name: 'Family Owner', }; type Filters = { childId: string | 'all'; deviceId: string | 'all'; contentTypes: ContentType[]; severities: Severity[]; classification: Classification | 'all'; search: string; datePreset: '7d' | '30d' | 'all'; }; const DEFAULT_FILTERS: Filters = { childId: 'all', deviceId: 'all', contentTypes: [], severities: [], classification: 'all', search: '', datePreset: '7d', }; type ChildRef = { id: string; name: string }; type DeviceRef = { id: string; name: string; childId: string }; const MOCK_CHILDREN: ChildRef[] = [ { id: crypto.randomUUID(), name: 'Child A' }, { id: crypto.randomUUID(), name: 'Child B' }, ]; const MOCK_DEVICES: DeviceRef[] = [ { id: crypto.randomUUID(), name: 'Android Device 1', childId: MOCK_CHILDREN[0].id }, { id: crypto.randomUUID(), name: 'Android Device 2', childId: MOCK_CHILDREN[0].id }, { id: crypto.randomUUID(), name: 'Android Device 3', childId: MOCK_CHILDREN[1].id }, ]; function randPick <T> (arr: T[]) { return arr[Math.floor(Math.random() * arr.length)]; } function buildMockEvidenceItems(count = 60): EvidenceItem[] { const family_id = crypto.randomUUID(); const severities: Severity[] = ['low', 'med', 'high', 'critical']; const ctypes: ContentType[] = ['text', 'image', 'audio', 'video']; const classes: Classification[] = ['normal', 'restricted', 'legal_hold']; const summaries = [ 'Grooming suspected in chat app', 'Bullying language detected in messages', 'Unsafe media detected (policy triggered)', 'Repeated tamper attempts on agent permissions', 'Geofence violation detected', 'Late-night risky activity pattern', ]; const now = Date.now(); const items: EvidenceItem[] = []; for (let i = 0; i < count; i++) { const child = randPick(MOCK_CHILDREN); const device = randPick(MOCK_DEVICES.filter((d) => d.childId === child.id)); const created = new Date(now - Math.random() * 1000 * 60 * 60 * 24 * 40).toISOString(); code Code download content_copy expand_less items.push({ evidence_id : crypto.randomUUID(), family_id, child_id : child.id, device_id : device.id, created_at : created, content_type : randPick(ctypes), severity : randPick(severities), classification : randPick(classes), summary : randPick(summaries), sha256 : ` ${crypto.randomUUID().replaceAll( '-' , '' )} ${crypto.randomUUID().replaceAll( '-' , '' )} ` .slice( 0 , 64 ), has_preview : true , tags : Math .random() > 0.6 ? [ 'auto-defense' , 'incident' ] : [], }); } return items.sort((a, b) => +new Date(b.created_at) - +new Date(a.created_at)); } const MOCK_EVIDENCE_ITEMS = buildMockEvidenceItems(70); async function mockListEvidence(filters: Filters, cursor: string | null): Promise <EvidenceListResponse> { await sleep(240); let items = [...MOCK_EVIDENCE_ITEMS]; // date preset if (filters.datePreset !== 'all') { const days = filters.datePreset === '7d' ? 7 : 30; const cutoff = Date.now() - days * 24 * 60 * 60 * 1000; items = items.filter((x) => +new Date(x.created_at) >= cutoff); } if (filters.childId !== 'all') items = items.filter((x) => x.child_id === filters.childId); if (filters.deviceId !== 'all') items = items.filter((x) => x.device_id === filters.deviceId); if (filters.classification !== 'all') items = items.filter((x) => x.classification === filters.classification); if (filters.contentTypes.length > 0) { const set = new Set(filters.contentTypes); items = items.filter((x) => set.has(x.content_type)); } if (filters.severities.length > 0) { const set = new Set(filters.severities); items = items.filter((x) => set.has(x.severity)); } const q = filters.search.trim().toLowerCase(); if (q) items = items.filter((x) => x.summary.toLowerCase().includes(q) || (x.tags ?? []).some((t) => t.toLowerCase().includes(q))); // simple cursor pagination const pageSize = 25; let start = 0; if (cursor) { const idx = items.findIndex((it) => it.evidence_id === cursor); start = idx >= 0 ? idx + 1 : 0; } const page = items.slice(start, start + pageSize); const next = items[start + pageSize]?.evidence_id ?? null; return EvidenceListResponseZ.parse({ items: page, next_cursor: next }); } async function mockGetEvidenceDetails(evidenceId: string): Promise <EvidenceDetails> { await sleep(220); const item = MOCK_EVIDENCE_ITEMS.find((x) => x.evidence_id === evidenceId); if (!item) throw new HttpError(404, 'Evidence not found'); const custodyCount = 3 + Math.floor(Math.random() * 5); const custody: EvidenceCustody[] = []; const actorId = MOCK_PRINCIPAL.principal_id; custody.push({ custody_id: crypto.randomUUID(), evidence_id: evidenceId, actor_id: item.device_id, // device creates action: 'create', reason: null, created_at: item.created_at, }); for (let i = 0; i < custodyCount; i++) { custody.push({ custody_id: crypto.randomUUID(), evidence_id: evidenceId, actor_id: actorId, action: randPick(['view', 'view', 'view', 'export', 'hold', 'delete_attempt'] as const), reason: Math.random() > 0.6 ? 'Manual review' : null, created_at: new Date(+new Date(item.created_at) + (i + 1) * 1000 * 60 * 5).toISOString(), }); } custody.sort((a, b) => +new Date(a.created_at) - +new Date(b.created_at)); return EvidenceDetailsZ.parse({ item, custody, notes: Math.random() > 0.7 ? 'Parent note: review and discuss calmly.' : null, }); } async function mockExportEvidence(evidenceId: string, reason: string): Promise <EvidenceExportResponse> { await sleep(650); // legal hold still exportable for father, restricted is export forbidden by policy in this demo const item = MOCK_EVIDENCE_ITEMS.find((x) => x.evidence_id === evidenceId); if (!item) throw new HttpError(404, 'Evidence not found'); if (!canExport(MOCK_PRINCIPAL.role)) throw new HttpError(403, 'Forbidden'); if (item.classification === 'restricted') throw new HttpError(403, 'Export not allowed for restricted evidence'); return EvidenceExportResponseZ.parse({ export_id: crypto.randomUUID(), export_uri: ' https://example.com/export/download-temporary-link ', expires_at: new Date(Date.now() + 15 * 60 * 1000).toISOString(), export_sha256: ${crypto.randomUUID().replaceAll('-', '')}${crypto.randomUUID().replaceAll('-', '')} .slice(0, 64), }); } async function mockDeleteEvidence(evidenceId: string, reason: string): Promise<{ ok: true }> { await sleep(500); const idx = MOCK_EVIDENCE_ITEMS.findIndex((x) => x.evidence_id === evidenceId); if (idx < 0) throw new HttpError(404, 'Evidence not found'); const item = MOCK_EVIDENCE_ITEMS[idx]; if (!canDelete(MOCK_PRINCIPAL.role)) throw new HttpError(403, 'Forbidden'); if (item.classification === 'legal_hold') throw new HttpError(409, 'Cannot delete legal hold evidence'); // mutate mock store MOCK_EVIDENCE_ITEMS.splice(idx, 1); return { ok: true }; } async function mockUpdateNotes(evidenceId: string, notes: string): Promise<{ ok: true }> { await sleep(320); const item = MOCK_EVIDENCE_ITEMS.find((x) => x.evidence_id === evidenceId); if (!item) throw new HttpError(404, 'Evidence not found'); if (!canWriteNotes(MOCK_PRINCIPAL.role)) throw new HttpError(403, 'Forbidden'); return { ok: true }; } async function mockAddTag(evidenceId: string, tag: string): Promise<{ ok: true }> { await sleep(220); const item = MOCK_EVIDENCE_ITEMS.find((x) => x.evidence_id === evidenceId); if (!item) throw new HttpError(404, 'Evidence not found'); if (!canWriteNotes(MOCK_PRINCIPAL.role)) throw new HttpError(403, 'Forbidden'); item.tags = Array.from(new Set([...(item.tags ?? []), tag.trim()])).slice(0, 8); return { ok: true }; } function sleep(ms: number) { return new Promise((r) => setTimeout(r, ms)); } class HttpError extends Error { status: number; constructor(status: number, message: string) { super(message); this.status = status; } } /* ========================= Page Component ========================= */ export default function EvidenceCenterPage() { const principal = MOCK_PRINCIPAL; const [filters, setFilters] = useState <Filters> (DEFAULT_FILTERS); const [cursor, setCursor] = useState<string | null>(null); const [list, setList] = useState<EvidenceItem[]>([]); const [nextCursor, setNextCursor] = useState<string | null>(null); const [listLoading, setListLoading] = useState(true); const [listError, setListError] = useState<{ status: number; message: string } | null>(null); const [selectedId, setSelectedId] = useState<string | null>(null); const [detailsLoading, setDetailsLoading] = useState(false); const [detailsError, setDetailsError] = useState<{ status: number; message: string } | null>(null); const [details, setDetails] = useState<EvidenceDetails | null>(null); const [toasts, setToasts] = useState<ToastMsg[]>([]); const [confirmExportOpen, setConfirmExportOpen] = useState(false); const [confirmDeleteOpen, setConfirmDeleteOpen] = useState(false); const [exportResultOpen, setExportResultOpen] = useState(false); const [exportResp, setExportResp] = useState<EvidenceExportResponse | null>(null); const [notesDraft, setNotesDraft] = useState <string> (''); const notesDebounceRef = useRef<number | null>(null); const selectedItem = useMemo(() => list.find((x) => x.evidence_id === selectedId) ?? null, [list, selectedId]); // derived options const childOptions = MOCK_CHILDREN; const deviceOptions = useMemo(() => { if (filters.childId === 'all') return MOCK_DEVICES; return MOCK_DEVICES.filter((d) => d.childId === filters.childId); }, [filters.childId]); const quickStats = useMemo(() => { const total = list.length; const critical = list.filter((x) => x.severity === 'critical').length; const legalHold = list.filter((x) => x.classification === 'legal_hold').length; const restricted = list.filter((x) => x.classification === 'restricted').length; return { total, critical, legalHold, restricted }; }, [list]); function pushToast(kind: ToastKind, title: string, message?: string) { const id = crypto.randomUUID(); setToasts((prev) => [{ id, kind, title, message }, ...prev].slice(0, 3)); } function dismissToast(id: string) { setToasts((prev) => prev.filter((t) => t.id !== id)); } async function fetchList(resetCursor = true) { setListLoading(true); setListError(null); code Code download content_copy expand_less try { const c = resetCursor ? null : cursor; const resp = USE_MOCKS ? await mockListEvidence(filters, c) : await realListEvidence(filters, c); setList(resp.items); setNextCursor(resp.next_cursor); setCursor( null ); setListLoading( false ); // auto-select first if none if (!selectedId && resp.items.length > 0 ) { setSelectedId(resp.items[ 0 ].evidence_id); } } catch (e: any ) { const status = e?.status ?? 500 ; const message = e?.message ?? 'Unexpected error' ; setListError({ status, message }); setListLoading( false ); } } async function fetchMore() { if (!nextCursor) return; setListLoading(true); setListError(null); code Code download content_copy expand_less try { const resp = USE_MOCKS ? await mockListEvidence(filters, nextCursor) : await realListEvidence(filters, nextCursor); setList( ( prev ) => [...prev, ...resp.items]); setNextCursor(resp.next_cursor); setListLoading( false ); } catch (e: any ) { const status = e?.status ?? 500 ; const message = e?.message ?? 'Unexpected error' ; setListError({ status, message }); setListLoading( false ); } } async function fetchDetails(evidenceId: string) { setDetailsLoading(true); setDetailsError(null); setDetails(null); code Code download content_copy expand_less try { const d = USE_MOCKS ? await mockGetEvidenceDetails(evidenceId) : await realGetEvidenceDetails(evidenceId); setDetails(d); setNotesDraft(d.notes ?? '' ); setDetailsLoading( false ); // (Design decision) record "view" silently on backend in real API. } catch (e: any ) { const status = e?.status ?? 500 ; const message = e?.message ?? 'Unexpected error' ; setDetailsError({ status, message }); setDetailsLoading( false ); } } useEffect(() => { // initial load fetchList(true); // eslint-disable-next-line react-hooks/exhaustive-deps }, []); useEffect(() => { // when filters change, refresh list const t = window.setTimeout(() => fetchList(true), 320); return () => window.clearTimeout(t); // eslint-disable-next-line react-hooks/exhaustive-deps }, [filters]); useEffect(() => { if (selectedId) fetchDetails(selectedId); // eslint-disable-next-line react-hooks/exhaustive-deps }, [selectedId]); async function handleExportConfirm(payload: { reason: string; mfaCode: string; typed: string }) { if (!selectedItem) return; code Code download content_copy expand_less try { const resp = USE_MOCKS ? await mockExportEvidence(selectedItem.evidence_id, payload.reason) : await realExportEvidence(selectedItem.evidence_id, payload.reason); setExportResp(resp); setConfirmExportOpen( false ); setExportResultOpen( true ); pushToast( 'success' , 'Export generated' , 'A temporary link is ready.' ); } catch (e: any ) { const status = e?.status ?? 500 ; const message = e?.message ?? 'Export failed' ; pushToast( 'error' , 'Export blocked' , ` ${status} : ${message} ` ); } } async function handleDeleteConfirm(payload: { reason: string; mfaCode: string; typed: string }) { if (!selectedItem) return; code Code download content_copy expand_less try { await (USE_MOCKS ? mockDeleteEvidence(selectedItem.evidence_id, payload.reason) : realDeleteEvidence(selectedItem.evidence_id, payload.reason)); setConfirmDeleteOpen( false ); pushToast( 'success' , 'Evidence deleted' , 'This action was recorded in audit logs.' ); // refresh list and clear details setSelectedId( null ); setDetails( null ); await fetchList( true ); } catch (e: any ) { const status = e?.status ?? 500 ; const message = e?.message ?? 'Delete failed' ; pushToast( 'error' , 'Delete blocked' , ` ${status} : ${message} ` ); } } async function handleAddTag(tag: string) { if (!selectedItem) return; const v = tag.trim(); if (!v) return; code Code download content_copy expand_less try { await (USE_MOCKS ? mockAddTag(selectedItem.evidence_id, v) : realAddTag(selectedItem.evidence_id, v)); pushToast( 'success' , 'Tag added' , 'Tag saved successfully.' ); // re-fetch details to reflect updated tags in mock await fetchDetails(selectedItem.evidence_id); } catch (e: any ) { const status = e?.status ?? 500 ; const message = e?.message ?? 'Tag update failed' ; pushToast( 'error' , 'Not allowed' , ` ${status} : ${message} ` ); } } async function handleNotesChange(v: string) { setNotesDraft(v); code Code download content_copy expand_less if (notesDebounceRef.current) window .clearTimeout(notesDebounceRef.current); notesDebounceRef.current = window .setTimeout( async () => { if (!selectedItem) return ; try { await (USE_MOCKS ? mockUpdateNotes(selectedItem.evidence_id, v) : realUpdateNotes(selectedItem.evidence_id, v)); } catch { // silent fail for draft; surface a non-intrusive toast once pushToast( 'info' , 'Notes not saved' , 'Network or permission prevented saving.' ); } }, 650 ) as any ; } const exportDisabledReason = useMemo(() => { if (!selectedItem) return 'No evidence selected.'; if (!canExport(principal.role)) return 'Export is allowed for family owner only.'; if (selectedItem.classification === 'restricted') return 'Export is blocked for restricted evidence by policy.'; return null; }, [principal.role, selectedItem]); const deleteDisabledReason = useMemo(() => { if (!selectedItem) return 'No evidence selected.'; if (!canDelete(principal.role)) return 'Delete is allowed for family owner only.'; if (selectedItem.classification === 'legal_hold') return 'Legal-hold evidence cannot be deleted.'; return null; }, [principal.role, selectedItem]); return ( <div className="min-h-screen bg-slate-50"> <SafeToast toasts={toasts} onDismiss={dismissToast} /> code Code download content_copy expand_less < div className = "mx-auto max-w-[1400px] px-4 py-6" > < header className = "flex flex-col gap-3 md:flex-row md:items-center md:justify-between" > < div className = "min-w-0" > < h1 className = "text-xl font-semibold text-slate-900" > Evidence Center </ h1 > < p className = "mt-1 text-sm text-slate-600" > Family evidence vault with custody chain and strict role-based actions. </ p > </ div > < div className = "flex items-center gap-2" > < div className = "hidden md:flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2" > < div className = "h-8 w-8 rounded-xl bg-slate-100 flex items-center justify-center" > < Lock className = "h-4 w-4 text-slate-700" /> </ div > < div className = "leading-tight" > < div className = "text-xs font-semibold text-slate-800" > {principal.display_name} </ div > < div className = "text-[11px] text-slate-500" > {principal.role} </ div > </ div > </ div > < button onClick = {() => fetchList(true)} className="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50" > < RefreshCw className = {clsx( ' h-4 w-4 ', listLoading && ' animate-spin ')} /> Refresh </ button > </ div > </ header > < div className = "mt-6 grid grid-cols-1 gap-4 lg:grid-cols-[340px_520px_1fr]" > {/* ============ Sidebar Filters ============ */} < aside className = "rounded-3xl border border-slate-200 bg-white p-4 shadow-sm" > < div className = "flex items-center justify-between" > < div className = "flex items-center gap-2" > < div className = "h-9 w-9 rounded-2xl bg-slate-50 flex items-center justify-center" > < Filter className = "h-4 w-4 text-slate-700" /> </ div > < div > < div className = "text-sm font-semibold text-slate-900" > Filters </ div > < div className = "text-xs text-slate-500" > Search and narrow evidence list </ div > </ div > </ div > < button onClick = {() => setFilters(DEFAULT_FILTERS)} className="rounded-xl px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-100" > Reset </ button > </ div > < div className = "mt-4 space-y-4" > {/* Search */} < div > < label className = "text-xs font-semibold text-slate-700" > Search </ label > < div className = "mt-2 flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2" > < Search className = "h-4 w-4 text-slate-400" /> < input value = {filters.search} onChange = {(e) => setFilters((p) => ({ ...p, search: e.target.value }))} className="w-full bg-transparent text-sm text-slate-800 outline-none" placeholder="Search summary or tags..." /> </ div > </ div > {/* Child */} < div > < label className = "text-xs font-semibold text-slate-700" > Child </ label > < select value = {filters.childId} onChange = {(e) => setFilters((p) => ({ ...p, childId: e.target.value as any, deviceId: 'all' }))} className="mt-2 w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" > < option value = "all" > All children </ option > {childOptions.map((c) => ( < option key = {c.id} value = {c.id} > {c.name} </ option > ))} </ select > </ div > {/* Device */} < div > < label className = "text-xs font-semibold text-slate-700" > Device </ label > < select value = {filters.deviceId} onChange = {(e) => setFilters((p) => ({ ...p, deviceId: e.target.value as any }))} className="mt-2 w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" > < option value = "all" > All devices </ option > {deviceOptions.map((d) => ( < option key = {d.id} value = {d.id} > {d.name} </ option > ))} </ select > </ div > {/* Classification */} < div > < label className = "text-xs font-semibold text-slate-700" > Classification </ label > < select value = {filters.classification} onChange = {(e) => setFilters((p) => ({ ...p, classification: e.target.value as any }))} className="mt-2 w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" > < option value = "all" > All </ option > < option value = "normal" > Normal </ option > < option value = "restricted" > Restricted </ option > < option value = "legal_hold" > Legal Hold </ option > </ select > </ div > {/* Date Preset */} < div > < label className = "text-xs font-semibold text-slate-700" > Date </ label > < div className = "mt-2 grid grid-cols-3 gap-2" > {(['7d', '30d', 'all'] as const).map((k) => ( < button key = {k} onClick = {() => setFilters((p) => ({ ...p, datePreset: k }))} className={clsx( 'rounded-2xl border px-3 py-2 text-xs font-semibold', filters.datePreset === k ? 'border-slate-900 bg-slate-900 text-white' : 'border-slate-200 bg-white text-slate-700 hover:bg-slate-50' )} > {k === '7d' ? '7 days' : k === '30d' ? '30 days' : 'All'} </ button > ))} </ div > </ div > {/* Severity */} < div > < label className = "text-xs font-semibold text-slate-700" > Severity </ label > < div className = "mt-2 flex flex-wrap gap-2" > {(['low', 'med', 'high', 'critical'] as Severity[]).map((s) => { const active = filters.severities.includes(s); const b = severityBadge(s); const Icon = b.icon; return ( < button key = {s} onClick = {() => setFilters((p) => ({ ...p, severities: active ? p.severities.filter((x) => x !== s) : [...p.severities, s], })) } className={clsx( 'inline-flex items-center gap-2 rounded-2xl border px-3 py-2 text-xs font-semibold', active ? 'border-slate-900 bg-slate-900 text-white' : 'border-slate-200 bg-white text-slate-700 hover:bg-slate-50' )} > < Icon className = "h-4 w-4" /> {b.label} </ button > ); })} </ div > </ div > {/* Content type */} < div > < label className = "text-xs font-semibold text-slate-700" > Content Type </ label > < div className = "mt-2 flex flex-wrap gap-2" > {(['text', 'image', 'audio', 'video'] as ContentType[]).map((ct) => { const active = filters.contentTypes.includes(ct); const Icon = contentIcon(ct); return ( < button key = {ct} onClick = {() => setFilters((p) => ({ ...p, contentTypes: active ? p.contentTypes.filter((x) => x !== ct) : [...p.contentTypes, ct], })) } className={clsx( 'inline-flex items-center gap-2 rounded-2xl border px-3 py-2 text-xs font-semibold', active ? 'border-slate-900 bg-slate-900 text-white' : 'border-slate-200 bg-white text-slate-700 hover:bg-slate-50' )} > < Icon className = "h-4 w-4" /> {ct.toUpperCase()} </ button > ); })} </ div > </ div > {/* Quick Stats */} < div className = "mt-6 rounded-3xl border border-slate-200 bg-slate-50 p-4" > < div className = "text-xs font-semibold text-slate-700" > Quick stats (current list) </ div > < div className = "mt-3 grid grid-cols-2 gap-3" > < StatBox label = "Total" value = {quickStats.total} /> < StatBox label = "Critical" value = {quickStats.critical} /> < StatBox label = "Legal Hold" value = {quickStats.legalHold} /> < StatBox label = "Restricted" value = {quickStats.restricted} /> </ div > </ div > </ div > </ aside > {/* ============ Evidence List ============ */} < section className = "rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden" > < div className = "flex items-center justify-between border-b border-slate-200 p-4" > < div > < div className = "text-sm font-semibold text-slate-900" > Evidence Timeline </ div > < div className = "text-xs text-slate-500" > Select an item to see details and custody chain </ div > </ div > < div className = "text-xs text-slate-500" > {listLoading ? 'Loading...' : `${list.length}${nextCursor ? '+' : ''} items`} </ div > </ div > < div className = "h-[680px] overflow-auto" > {listLoading && list.length === 0 ? ( < EvidenceListSkeleton /> ) : listError ? ( < ErrorBox title = { ` Error ${ listError.status }`} message = {listError.message} onRetry = {() => fetchList(true)} /> ) : list.length === 0 ? ( < EmptyBox title = "No evidence found" message = "Try changing filters or date range." /> ) : ( < div className = "divide-y divide-slate-100" > {list.map((item) => ( < EvidenceListItem key = {item.evidence_id} item = {item} selected = {item.evidence_id === selectedId} onSelect = {() => setSelectedId(item.evidence_id)} /> ))} {nextCursor && ( < div className = "p-4" > < button onClick = {fetchMore} className = "w-full rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm font-semibold text-slate-800 hover:bg-slate-50" disabled = {listLoading} > {listLoading ? ( < span className = "inline-flex items-center gap-2" > < Loader2 className = "h-4 w-4 animate-spin" /> Loading </ span > ) : ( < span className = "inline-flex items-center gap-2" > Load more < ChevronRight className = "h-4 w-4" /> </ span > )} </ button > </ div > )} </ div > )} </ div > </ section > {/* ============ Details Panel ============ */} < section className = "rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden" > < div className = "border-b border-slate-200 p-4" > < div className = "text-sm font-semibold text-slate-900" > Evidence Details </ div > < div className = "text-xs text-slate-500" > Preview, metadata, custody chain, and actions </ div > </ div > < div className = "h-[680px] overflow-auto p-4" > {!selectedItem ? ( < EmptyBox title = "No selection" message = "Select an evidence item from the list." /> ) : detailsLoading ? ( < DetailsSkeleton /> ) : detailsError ? ( < ErrorBox title = { ` Error ${ detailsError.status }`} message = {detailsError.message} onRetry = {() => fetchDetails(selectedItem.evidence_id)} /> ) : !details ? ( < EmptyBox title = "No details" message = "Try selecting another evidence item." /> ) : ( < div className = "space-y-4" > < EvidenceHeader item = {details.item} /> < EvidencePreview item = {details.item} /> < EvidenceMetadata item = {details.item} /> < EvidenceNotes enabled = {canWriteNotes(principal.role)} value = {notesDraft} onChange = {handleNotesChange} /> < EvidenceTags tags = {details.item.tags ?? []} editable = {canWriteNotes(principal.role)} onAdd = {handleAddTag} /> < CustodyTimeline custody = {details.custody} /> < ActionsBar principal = {principal} item = {details.item} exportDisabledReason = {exportDisabledReason} deleteDisabledReason = {deleteDisabledReason} onExport = {() => setConfirmExportOpen(true)} onDelete={() => setConfirmDeleteOpen(true)} /> </ div > )} </ div > </ section > </ div > </ div > {/* Modals */} < DangerConfirmModal open = {confirmExportOpen} title = "Export evidence package" description = "Export creates a time-limited package and records the action in custody chain and audit logs." confirmLabel = "Generate export link" confirmDanger = {false} requiresReason = {true} requiresMfa = {true} reasonMinLen = {8} onCancel = {() => setConfirmExportOpen(false)} onConfirm={handleExportConfirm} /> < DangerConfirmModal open = {confirmDeleteOpen} title = "Delete evidence" description = "This is a sensitive action. Deleting evidence is recorded permanently in audit logs." confirmLabel = "Delete permanently" confirmDanger = {true} requiresReason = {true} requiresMfa = {true} reasonMinLen = {10} requireTyping = "DELETE" onCancel = {() => setConfirmDeleteOpen(false)} onConfirm={handleDeleteConfirm} /> < ExportResultModal open = {exportResultOpen} onClose = {() => setExportResultOpen(false)} exportResp={exportResp} /> </ div > ); } /* ========================= UI Subcomponents ========================= */ function StatBox({ label, value }: { label: string; value: number }) { return ( <div className="rounded-2xl border border-slate-200 bg-white p-3"> <div className="text-[11px] font-semibold text-slate-500"> {label} </div> <div className="mt-1 text-lg font-semibold text-slate-900"> {value} </div> </div> ); } function EvidenceListItem({ item, selected, onSelect, }: { item: EvidenceItem; selected: boolean; onSelect: () => void; }) { const sev = severityBadge(item.severity); const SevIcon = sev.icon; const CIcon = contentIcon(item.content_type); const cl = classificationChip(item.classification); const ClIcon = cl.icon; return ( <button onClick={onSelect} className={clsx( 'w-full text-left p-4 hover:bg-slate-50 transition', selected && 'bg-slate-50' )} > <div className="flex items-start justify-between gap-3"> <div className="min-w-0 flex-1"> <div className="flex items-center gap-2"> <div className="h-9 w-9 rounded-2xl bg-slate-100 flex items-center justify-center"> <CIcon className="h-4 w-4 text-slate-700" /> </div> code Code download content_copy expand_less < div className = "min-w-0" > < div className = "truncate text-sm font-semibold text-slate-900" > {item.summary} </ div > < div className = "mt-1 text-xs text-slate-500" > {fmtDate(item.created_at)} </ div > </ div > </ div > < div className = "mt-3 flex flex-wrap items-center gap-2" > < span className = {clsx( ' inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text- [ 11px ] font-semibold ', sev.className )}> < SevIcon className = "h-3.5 w-3.5" /> {sev.label} </ span > < span className = {clsx( ' inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text- [ 11px ] font-semibold ', cl.className )}> < ClIcon className = "h-3.5 w-3.5" /> {cl.label} </ span > {(item.tags ?? []).slice(0, 2).map((t) => ( < span key = {t} className = "inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-2.5 py-1 text-[11px] font-semibold text-slate-700" > < Tag className = "h-3.5 w-3.5 text-slate-500" /> {t} </ span > ))} </ div > </ div > < ChevronRight className = "h-5 w-5 text-slate-400 mt-2" /> </ div > </ button > ); } function EvidenceHeader({ item }: { item: EvidenceItem }) { const sev = severityBadge(item.severity); const cl = classificationChip(item.classification); const SevIcon = sev.icon; const ClIcon = cl.icon; const CIcon = contentIcon(item.content_type); return ( <div className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="flex items-start gap-3"> <div className="h-11 w-11 rounded-2xl bg-slate-100 flex items-center justify-center"> <CIcon className="h-5 w-5 text-slate-700" /> </div> code Code download content_copy expand_less < div className = "min-w-0 flex-1" > < div className = "text-sm font-semibold text-slate-900" > {item.summary} </ div > < div className = "mt-1 text-xs text-slate-500" > {fmtDate(item.created_at)} </ div > < div className = "mt-3 flex flex-wrap items-center gap-2" > < span className = {clsx( ' inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text- [ 11px ] font-semibold ', sev.className )}> < SevIcon className = "h-3.5 w-3.5" /> {sev.label} </ span > < span className = {clsx( ' inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text- [ 11px ] font-semibold ', cl.className )}> < ClIcon className = "h-3.5 w-3.5" /> {cl.label} </ span > </ div > </ div > </ div > </ div > ); } function EvidencePreview({ item }: { item: EvidenceItem }) { const restricted = item.classification === 'restricted'; const legalHold = item.classification === 'legal_hold'; const title = restricted ? 'Preview (restricted)' : legalHold ? 'Preview (legal hold)' : 'Preview'; const hint = restricted ? 'Preview is available, but export may be blocked by policy.' : legalHold ? 'Legal hold evidence is protected from deletion.' : 'Preview is available for family members with access.'; return ( <div className="rounded-3xl border border-slate-200 bg-slate-50 p-4"> <div className="flex items-center justify-between gap-3"> <div> <div className="text-sm font-semibold text-slate-900"> {title} </div> <div className="mt-1 text-xs text-slate-600"> {hint} </div> </div> code Code download content_copy expand_less < div className = "flex items-center gap-2 rounded-2xl bg-white border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700" > < Clock className = "h-4 w-4 text-slate-500" /> Safe preview </ div > </ div > < div className = "mt-4 rounded-3xl border border-slate-200 bg-white p-4" > {/* Placeholder preview to avoid real content in demo */} < div className = "text-sm font-semibold text-slate-800" > Preview placeholder </ div > < div className = "mt-2 text-xs text-slate-500" > In production, use signed URLs to stream media, never expose direct object storage paths. </ div > </ div > </ div > ); } function EvidenceMetadata({ item }: { item: EvidenceItem }) { return ( <div className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="text-sm font-semibold text-slate-900"> Metadata </div> code Code download content_copy expand_less < div className = "mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2" > < MetaRow label = "Evidence ID" value = {item.evidence_id} mono /> < MetaRow label = "Child ID" value = {item.child_id} mono /> < MetaRow label = "Device ID" value = {item.device_id} mono /> < MetaRow label = "Content type" value = {item.content_type} /> < MetaRow label = "SHA-256" value = {item.sha256} mono /> < MetaRow label = "Classification" value = {item.classification} /> </ div > </ div > ); } function MetaRow({ label, value, mono }: { label: string; value: string; mono?: boolean }) { return ( <div className="rounded-2xl border border-slate-200 bg-slate-50 p-3"> <div className="text-[11px] font-semibold text-slate-500"> {label} </div> <div className={clsx('mt-1 text-sm text-slate-900 break-all', mono && 'font-mono')}> {value} </div> </div> ); } function EvidenceNotes({ enabled, value, onChange, }: { enabled: boolean; value: string; onChange: (v: string) => void; }) { return ( <div className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="flex items-center justify-between"> <div> <div className="text-sm font-semibold text-slate-900"> Notes </div> <div className="mt-1 text-xs text-slate-500"> Visible to family members (no export required) </div> </div> <div className={clsx('rounded-2xl border px-3 py-2 text-xs font-semibold', enabled ? 'border-slate-200 bg-slate-50 text-slate-700' : 'border-slate-200 bg-white text-slate-400')}> {enabled ? 'Editable' : 'Read-only'} </div> </div> code Code download content_copy expand_less < textarea className = "mt-4 w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" rows = {4} disabled = {!enabled} placeholder = {enabled ? ' Write a short family note... ' : ' You do not have permission to edit notes. '} value = {value} onChange = {(e) => onChange(e.target.value)} /> </ div > ); } function EvidenceTags({ tags, editable, onAdd, }: { tags: string[]; editable: boolean; onAdd: (tag: string) => Promise <void> ; }) { const [newTag, setNewTag] = useState(''); const [busy, setBusy] = useState(false); return ( <div className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="flex items-center justify-between gap-3"> <div> <div className="text-sm font-semibold text-slate-900"> Tags </div> <div className="mt-1 text-xs text-slate-500"> Used for quick search and organization </div> </div> code Code download content_copy expand_less {editable && ( < div className = "flex items-center gap-2" > < input value = {newTag} onChange = {(e) => setNewTag(e.target.value)} className="w-[180px] rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" placeholder="Add tag..." disabled={busy} /> < button onClick = {async () => { const t = newTag.trim(); if (!t) return; setBusy(true); try { await onAdd(t); setNewTag(''); } finally { setBusy(false); } }} className={clsx( 'inline-flex items-center gap-2 rounded-2xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-slate-950', busy && 'opacity-70' )} disabled={busy} > {busy ? < Loader2 className = "h-4 w-4 animate-spin" /> : < Tag className = "h-4 w-4" /> } Add </ button > </ div > )} </ div > < div className = "mt-4 flex flex-wrap gap-2" > {tags.length === 0 ? ( < div className = "text-xs text-slate-500" > No tags yet. </ div > ) : ( tags.map((t) => ( < span key = {t} className = "inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-3 py-1.5 text-xs font-semibold text-slate-700" > < Tag className = "h-3.5 w-3.5 text-slate-500" /> {t} </ span > )) )} </ div > </ div > ); } function CustodyTimeline({ custody }: { custody: EvidenceCustody[] }) { return ( <div className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="text-sm font-semibold text-slate-900"> Custody chain </div> <div className="mt-1 text-xs text-slate-500"> Every action is recorded for traceability </div> code Code download content_copy expand_less < div className = "mt-4 space-y-3" > {custody.map((c) => ( < div key = {c.custody_id} className = "flex items-start gap-3" > < div className = "mt-0.5 h-9 w-9 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-center" > < Lock className = "h-4 w-4 text-slate-700" /> </ div > < div className = "min-w-0 flex-1 rounded-2xl border border-slate-200 bg-white p-3" > < div className = "flex items-center justify-between gap-3" > < div className = "text-xs font-semibold text-slate-900" > {c.action} </ div > < div className = "text-[11px] text-slate-500" > {fmtDate(c.created_at)} </ div > </ div > < div className = "mt-1 text-[11px] text-slate-600 break-all" > actor: < span className = "font-mono text-slate-800" > {c.actor_id} </ span > </ div > {c.reason && ( < div className = "mt-2 text-xs text-slate-700" > Reason: < span className = "font-medium" > {c.reason} </ span > </ div > )} </ div > </ div > ))} </ div > </ div > ); } function ActionsBar({ principal, item, exportDisabledReason, deleteDisabledReason, onExport, onDelete, }: { principal: Principal; item: EvidenceItem; exportDisabledReason: string | null; deleteDisabledReason: string | null; onExport: () => void; onDelete: () => void; }) { const exportAllowed = !exportDisabledReason; const deleteAllowed = !deleteDisabledReason; return ( <div className="rounded-3xl border border-slate-200 bg-slate-50 p-4"> <div className="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between"> <div> <div className="text-sm font-semibold text-slate-900"> Actions </div> <div className="mt-1 text-xs text-slate-600"> Sensitive operations are restricted and recorded. </div> </div> code Code download content_copy expand_less < div className = "flex items-center gap-2" > < button onClick = {onExport} disabled = {!exportAllowed} className = {clsx( ' inline-flex items-center gap-2 rounded-2xl px-3 py-2 text-sm font-semibold ', exportAllowed ? ' bg-slate-900 text-white hover:bg-slate-950 ' : ' bg-white text-slate-400 border border-slate-200 cursor-not-allowed ' )} title = {exportDisabledReason ?? ' Export package '} > < Download className = "h-4 w-4" /> Export </ button > < button onClick = {onDelete} disabled = {!deleteAllowed} className = {clsx( ' inline-flex items-center gap-2 rounded-2xl px-3 py-2 text-sm font-semibold ', deleteAllowed ? ' bg-red-600 text-white hover:bg-red-700 ' : ' bg-white text-slate-400 border border-slate-200 cursor-not-allowed ' )} title = {deleteDisabledReason ?? ' Delete evidence '} > < Trash2 className = "h-4 w-4" /> Delete </ button > </ div > </ div > < div className = "mt-3 grid grid-cols-1 gap-2 text-xs text-slate-600" > < div className = "rounded-2xl border border-slate-200 bg-white p-3" > < div className = "font-semibold text-slate-800" > Role </ div > < div className = "mt-1" > {principal.role} </ div > </ div > {(exportDisabledReason || deleteDisabledReason) && ( < div className = "rounded-2xl border border-slate-200 bg-white p-3" > < div className = "font-semibold text-slate-800" > Restrictions </ div > < ul className = "mt-2 list-disc pl-5 space-y-1" > {exportDisabledReason && < li > {exportDisabledReason} </ li > } {deleteDisabledReason && < li > {deleteDisabledReason} </ li > } </ ul > </ div > )} </ div > </ div > ); } /* ========================= Skeletons & Error/Empty ========================= */ function EvidenceListSkeleton() { return ( <div className="p-4 space-y-4"> {Array.from({ length: 8 }).map((_, i) => ( <div key={i} className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="flex items-center gap-3"> <div className="h-10 w-10 rounded-2xl bg-slate-100 animate-pulse" /> <div className="flex-1"> <div className="h-3 w-2/3 rounded bg-slate-100 animate-pulse" /> <div className="mt-2 h-3 w-1/3 rounded bg-slate-100 animate-pulse" /> </div> </div> <div className="mt-3 flex gap-2"> <div className="h-6 w-20 rounded-full bg-slate-100 animate-pulse" /> <div className="h-6 w-24 rounded-full bg-slate-100 animate-pulse" /> </div> </div> ))} </div> ); } function DetailsSkeleton() { return ( <div className="space-y-4"> <div className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="h-4 w-2/3 rounded bg-slate-100 animate-pulse" /> <div className="mt-2 h-3 w-1/3 rounded bg-slate-100 animate-pulse" /> </div> <div className="rounded-3xl border border-slate-200 bg-slate-50 p-4"> <div className="h-3 w-1/2 rounded bg-slate-100 animate-pulse" /> <div className="mt-4 h-24 rounded-3xl bg-slate-100 animate-pulse" /> </div> <div className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="h-3 w-1/3 rounded bg-slate-100 animate-pulse" /> <div className="mt-4 grid grid-cols-2 gap-3"> {Array.from({ length: 6 }).map((_, i) => ( <div key={i} className="h-16 rounded-2xl bg-slate-100 animate-pulse" /> ))} </div> </div> </div> ); } function ErrorBox({ title, message, onRetry }: { title: string; message: string; onRetry: () => void }) { return ( <div className="p-6"> <div className="rounded-3xl border border-red-200 bg-red-50 p-4"> <div className="text-sm font-semibold text-red-800"> {title} </div> <div className="mt-1 text-xs text-red-700"> {message} </div> <button onClick={onRetry} className="mt-4 inline-flex items-center gap-2 rounded-2xl bg-red-600 px-3 py-2 text-sm font-semibold text-white hover:bg-red-700" > <RefreshCw className="h-4 w-4" /> Retry </button> </div> </div> ); } function EmptyBox({ title, message }: { title: string; message: string }) { return ( <div className="p-8"> <div className="rounded-3xl border border-slate-200 bg-slate-50 p-6"> <div className="text-sm font-semibold text-slate-900"> {title} </div> <div className="mt-1 text-xs text-slate-600"> {message} </div> </div> </div> ); } /* ========================= Real API Stubs Replace these with fetch() calls when backend is ready ========================= */ async function realListEvidence(filters: Filters, cursor: string | null): Promise <EvidenceListResponse> { throw new HttpError(501, 'Real API not wired (USE_MOCKS=false).'); } async function realGetEvidenceDetails(evidenceId: string): Promise <EvidenceDetails> { throw new HttpError(501, 'Real API not wired (USE_MOCKS=false).'); } async function realExportEvidence(evidenceId: string, reason: string): Promise <EvidenceExportResponse> { throw new HttpError(501, 'Real API not wired (USE_MOCKS=false).'); } async function realDeleteEvidence(evidenceId: string, reason: string): Promise<{ ok: true }> { throw new HttpError(501, 'Real API not wired (USE_MOCKS=false).'); } async function realUpdateNotes(evidenceId: string, notes: string): Promise<{ ok: true }> { throw new HttpError(501, 'Real API not wired (USE_MOCKS=false).'); } async function realAddTag(evidenceId: string, tag: string): Promise<{ ok: true }> { throw new HttpError(501, 'Real API not wired (USE_MOCKS=false).'); } [2] ## ملف Next.js كامل — صفحة Dashboard جاهزة للنسخ (Home Console) المسار المقترح: app/console/page.tsx صفحة بسيطة لكنها “مؤسسية” وتعرض: الأطفال + الحوادث + صحة الأجهزة + إجراءات سريعة. 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import { Bell, ShieldAlert, ShieldCheck, ShieldX, MapPin, Wifi, WifiOff, Activity, ArrowUpRight, RefreshCw, Camera, Mic, MessageCircle, Lock, TriangleAlert, Loader2, ChevronRight, } from 'lucide-react'; type Severity = 'low' | 'med' | 'high' | 'critical'; type ChildCardDTO = { child_id: string; name: string; age_group: '3-5' | '6-9' | '10-12' | '13-17'; risk_score: number; // 0..100 last_seen_at: string; last_location: { label: string; lat: number; lng: number } | null; last_incident: { severity: Severity; title: string; at: string } | null; }; type DeviceHealthDTO = { device_id: string; name: string; child_id: string; online: boolean; compliance: 'ok' | 'warn' | 'critical'; last_seen_at: string; tamper_badge: boolean; }; type IncidentDTO = { incident_id: string; child_id: string; device_id: string; severity: Severity; title: string; at: string; actions_taken: string[]; }; function clsx(...parts: Array<string | false | null | undefined>) { return parts.filter(Boolean).join(' '); } function fmtDate(iso: string) { try { const d = new Date(iso); return d.toLocaleString(undefined, { month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', }); } catch { return iso; } } function severityBadge(sev: Severity) { if (sev === 'critical') return { label: 'Critical', className: 'bg-red-100 text-red-700 border-red-200', Icon: ShieldX }; if (sev === 'high') return { label: 'High', className: 'bg-orange-100 text-orange-700 border-orange-200', Icon: ShieldAlert }; if (sev === 'med') return { label: 'Medium', className: 'bg-yellow-100 text-yellow-700 border-yellow-200', Icon: TriangleAlert }; return { label: 'Low', className: 'bg-emerald-100 text-emerald-700 border-emerald-200', Icon: ShieldCheck }; } /* ========================= Mock Data (replace later) ========================= */ const MOCK_CHILDREN: ChildCardDTO[] = [ { child_id: crypto.randomUUID(), name: 'Child A', age_group: '10-12', risk_score: 58, last_seen_at: new Date(Date.now() - 3 * 60 * 1000).toISOString(), last_location: { label: 'Home (safe zone)', lat: 25.285, lng: 51.531 }, last_incident: { severity: 'high', title: 'Grooming suspected', at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString() }, }, { child_id: crypto.randomUUID(), name: 'Child B', age_group: '13-17', risk_score: 22, last_seen_at: new Date(Date.now() - 8 * 60 * 1000).toISOString(), last_location: { label: 'School', lat: 25.3, lng: 51.52 }, last_incident: null, }, ]; const MOCK_DEVICES: DeviceHealthDTO[] = [ { device_id: crypto.randomUUID(), name: 'Android Device 1', child_id: MOCK_CHILDREN[0].child_id, online: true, compliance: 'ok', last_seen_at: new Date(Date.now() - 2 * 60 * 1000).toISOString(), tamper_badge: false, }, { device_id: crypto.randomUUID(), name: 'Android Device 2', child_id: MOCK_CHILDREN[0].child_id, online: false, compliance: 'warn', last_seen_at: new Date(Date.now() - 35 * 60 * 1000).toISOString(), tamper_badge: true, }, { device_id: crypto.randomUUID(), name: 'Android Device 3', child_id: MOCK_CHILDREN[1].child_id, online: true, compliance: 'ok', last_seen_at: new Date(Date.now() - 1 * 60 * 1000).toISOString(), tamper_badge: false, }, ]; const MOCK_INCIDENTS: IncidentDTO[] = [ { incident_id: crypto.randomUUID(), child_id: MOCK_CHILDREN[0].child_id, device_id: MOCK_DEVICES[0].device_id, severity: 'high', title: 'Grooming suspected in chat app', at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(), actions_taken: ['APP_KILL', 'NET_QUARANTINE', 'ALERT_SEND', 'EVIDENCE_CREATE'], }, { incident_id: crypto.randomUUID(), child_id: MOCK_CHILDREN[1].child_id, device_id: MOCK_DEVICES[2].device_id, severity: 'low', title: 'Geofence warning', at: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString(), actions_taken: ['ALERT_SEND'], }, ]; export default function ConsoleDashboardPage() { const [loading, setLoading] = useState(true); const [children, setChildren] = useState<ChildCardDTO[]>([]); const [devices, setDevices] = useState<DeviceHealthDTO[]>([]); const [incidents, setIncidents] = useState<IncidentDTO[]>([]); useEffect(() => { // simulate load const t = setTimeout(() => { setChildren(MOCK_CHILDREN); setDevices(MOCK_DEVICES); setIncidents(MOCK_INCIDENTS); setLoading(false); }, 450); return () => clearTimeout(t); }, []); const criticalCount = useMemo(() => incidents.filter((x) => x.severity === 'critical').length, [incidents]); const highCount = useMemo(() => incidents.filter((x) => x.severity === 'high').length, [incidents]); const offlineCount = useMemo(() => devices.filter((x) => !x.online).length, [devices]); return ( <div className="min-h-screen bg-slate-50"> <div className="mx-auto max-w-[1400px] px-4 py-6"> <header className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between"> <div className="min-w-0"> <h1 className="text-xl font-semibold text-slate-900"> Family Console </h1> <p className="mt-1 text-sm text-slate-600"> Real-time safety overview: incidents, device health, and quick actions. </p> </div> code Code download content_copy expand_less <div className= "flex items-center gap-2" > <button className= "inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50" > <Bell className= "h-4 w-4" /> Alerts </button> <button onClick={() => window.location.reload()} className= "inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50" > <RefreshCw className={clsx( 'h-4 w-4' , loading && 'animate-spin' )} /> Refresh </button> </div> </header> { /* KPI Row */ } <div className= "mt-6 grid grid-cols-1 gap-4 md:grid-cols-3" > <KpiCard title= "High incidents" value={highCount} icon={<ShieldAlert className= "h-5 w-5 text-orange-700" />} /> <KpiCard title= "Critical incidents" value={criticalCount} icon={<ShieldX className= "h-5 w-5 text-red-700" />} /> <KpiCard title= "Offline devices" value={offlineCount} icon={<WifiOff className= "h-5 w-5 text-slate-700" />} /> </div> <div className= "mt-6 grid grid-cols-1 gap-4 lg:grid-cols-[1fr_520px]" > { /* Children */ } <section className= "rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden" > <div className= "flex items-center justify-between border-b border-slate-200 p-4" > <div> <div className= "text-sm font-semibold text-slate-900" >Children</div> <div className= "text-xs text-slate-500" >Risk score, location, and last incident</div> </div> <div className= "inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs font-semibold text-slate-700" > <Activity className= "h-4 w-4 text-slate-600" /> Live overview </div> </div> <div className= "p-4" > {loading ? ( <div className= "space-y-4" > {Array.from({ length: 2 }).map((_, i) => ( <div key={i} className= "h-24 rounded-3xl border border-slate-200 bg-slate-50 animate-pulse" /> ))} </div> ) : ( <div className= "grid grid-cols-1 gap-4 md:grid-cols-2" > {children.map((c) => ( <ChildCard key={c.child_id} c={c} /> ))} </div> )} </div> </section> { /* Incidents */ } <section className= "rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden" > <div className= "flex items-center justify-between border-b border-slate-200 p-4" > <div> <div className= "text-sm font-semibold text-slate-900" >Incidents</div> <div className= "text-xs text-slate-500" >Latest events with auto-defense actions</div> </div> <a href= "/console/evidence" className= "inline-flex items-center gap-2 rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white hover:bg-slate-950" > Open Evidence Center <ArrowUpRight className= "h-4 w-4" /> </a> </div> <div className= "p-4 space-y-3" > {loading ? ( <div className= "space-y-3" > {Array.from({ length: 3 }).map((_, i) => ( <div key={i} className= "h-20 rounded-3xl border border-slate-200 bg-slate-50 animate-pulse" /> ))} </div> ) : incidents.length === 0 ? ( <div className= "rounded-3xl border border-slate-200 bg-slate-50 p-6" > <div className= "text-sm font-semibold text-slate-900" >No incidents</div> <div className= "mt-1 text-xs text-slate-600" >Everything looks stable right now.</div> </div> ) : ( incidents.map((x) => <IncidentRow key={x.incident_id} incident={x} />) )} </div> </section> </div> { /* Devices + Quick Actions */ } <div className= "mt-6 grid grid-cols-1 gap-4 lg:grid-cols-[520px_1fr]" > <section className= "rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden" > <div className= "border-b border-slate-200 p-4" > <div className= "text-sm font-semibold text-slate-900" >Device health</div> <div className= "text-xs text-slate-500" >Online status, compliance, and tamper indicators</div> </div> <div className= "p-4 space-y-3" > {loading ? ( <div className= "space-y-3" > {Array.from({ length: 3 }).map((_, i) => ( <div key={i} className= "h-16 rounded-3xl border border-slate-200 bg-slate-50 animate-pulse" /> ))} </div> ) : ( devices.map((d) => <DeviceRow key={d.device_id} d={d} />) )} </div> </section> <section className= "rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden" > <div className= "border-b border-slate-200 p-4" > <div className= "text-sm font-semibold text-slate-900" >Quick actions</div> <div className= "text-xs text-slate-500" >Instant interventions (reason + audit recommended)</div> </div> <div className= "p-4 grid grid-cols-1 gap-3 md:grid-cols-2" > <QuickAction title= "Quarantine network" desc= "Temporarily restrict internet access on a selected device." icon={<Lock className= "h-5 w-5 text-slate-700" />} cta= "Start" /> <QuickAction title= "Request screenshot" desc= "Capture current screen view for safety review." icon={<Camera className= "h-5 w-5 text-slate-700" />} cta= "Request" /> <QuickAction title= "Walkie-talkie" desc= "Talk instantly with the child using a secure channel." icon={<MessageCircle className= "h-5 w-5 text-slate-700" />} cta= "Open" /> <QuickAction title= "Block microphone" desc= "Disable microphone temporarily in high-risk situations." icon={<Mic className= "h-5 w-5 text-slate-700" />} cta= "Apply" /> </div> </section> </div> </div> </div> ); } function KpiCard({ title, value, icon }: { title: string; value: number; icon: React.ReactNode }) { return ( <div className="rounded-3xl border border-slate-200 bg-white shadow-sm p-4"> <div className="flex items-center justify-between"> <div className="text-xs font-semibold text-slate-600"> {title} </div> <div className="h-10 w-10 rounded-2xl bg-slate-50 border border-slate-200 flex items-center justify-center"> {icon} </div> </div> <div className="mt-3 text-2xl font-semibold text-slate-900"> {value} </div> <div className="mt-1 text-xs text-slate-500"> Updated live </div> </div> ); } function ChildCard({ c }: { c: ChildCardDTO }) { const riskColor = c.risk_score >= 75 ? 'bg-red-600' : c.risk_score >= 50 ? 'bg-orange-600' : c.risk_score >= 25 ? 'bg-yellow-600' : 'bg-emerald-600'; return ( <div className="rounded-3xl border border-slate-200 bg-white p-4 hover:bg-slate-50 transition"> <div className="flex items-start justify-between gap-3"> <div className="min-w-0"> <div className="text-sm font-semibold text-slate-900"> {c.name} </div> <div className="mt-1 text-xs text-slate-500"> Age group: {c.age_group} </div> </div> code Code download content_copy expand_less < div className = "rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700" > Risk {c.risk_score}/100 </ div > </ div > < div className = "mt-4" > < div className = "h-2 rounded-full bg-slate-100 overflow-hidden" > < div className = {clsx( ' h-full ', riskColor )} style = {{ width: `${ Math.max ( 0 , Math.min ( 100 , c.risk_score ))}%` }} /> </ div > </ div > < div className = "mt-4 grid grid-cols-1 gap-2" > < div className = "flex items-center gap-2 text-xs text-slate-600" > < Activity className = "h-4 w-4 text-slate-500" /> Last seen: {fmtDate(c.last_seen_at)} </ div > < div className = "flex items-center gap-2 text-xs text-slate-600" > < MapPin className = "h-4 w-4 text-slate-500" /> Location: {c.last_location ? c.last_location.label : 'Unknown'} </ div > {c.last_incident ? ( < div className = "mt-2 rounded-2xl border border-slate-200 bg-slate-50 p-3" > < div className = "text-xs font-semibold text-slate-800" > Last incident </ div > < div className = "mt-1 text-xs text-slate-600" > {c.last_incident.title} </ div > < div className = "mt-1 text-[11px] text-slate-500" > {fmtDate(c.last_incident.at)} </ div > </ div > ) : ( < div className = "mt-2 rounded-2xl border border-slate-200 bg-emerald-50 p-3" > < div className = "text-xs font-semibold text-emerald-800" > No recent incidents </ div > < div className = "mt-1 text-[11px] text-emerald-700" > Stable behavior signals in selected window. </ div > </ div > )} </ div > </ div > ); } function IncidentRow({ incident }: { incident: IncidentDTO }) { const b = severityBadge(incident.severity); const Icon = b.Icon; return ( <div className="rounded-3xl border border-slate-200 bg-white p-4 hover:bg-slate-50 transition"> <div className="flex items-start justify-between gap-3"> <div className="min-w-0"> <div className="text-sm font-semibold text-slate-900"> {incident.title} </div> <div className="mt-1 text-xs text-slate-500"> {fmtDate(incident.at)} </div> </div> code Code download content_copy expand_less < span className = {clsx( ' inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text- [ 11px ] font-semibold ', b.className )}> < Icon className = "h-3.5 w-3.5" /> {b.label} </ span > </ div > < div className = "mt-3 flex flex-wrap gap-2" > {incident.actions_taken.slice(0, 4).map((a) => ( < span key = {a} className = "rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-[11px] font-semibold text-slate-700" > {a} </ span > ))} </ div > < div className = "mt-3" > < a href = "/console/evidence" className = "inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50" > Open related evidence < ChevronRight className = "h-4 w-4" /> </ a > </ div > </ div > ); } function DeviceRow({ d }: { d: DeviceHealthDTO }) { const onlineChip = d.online ? { label: 'Online', className: 'bg-emerald-100 text-emerald-700 border-emerald-200', icon: <Wifi className="h-3.5 w-3.5" /> } : { label: 'Offline', className: 'bg-slate-100 text-slate-700 border-slate-200', icon: <WifiOff className="h-3.5 w-3.5" /> }; const complianceChip = d.compliance === 'ok' ? { label: 'OK', className: 'bg-emerald-100 text-emerald-700 border-emerald-200' } : d.compliance === 'warn' ? { label: 'Warn', className: 'bg-yellow-100 text-yellow-700 border-yellow-200' } : { label: 'Critical', className: 'bg-red-100 text-red-700 border-red-200' }; return ( <div className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="flex items-start justify-between gap-3"> <div className="min-w-0"> <div className="text-sm font-semibold text-slate-900"> {d.name} </div> <div className="mt-1 text-xs text-slate-500"> Last seen: {fmtDate(d.last_seen_at)} </div> </div> code Code download content_copy expand_less < div className = "flex items-center gap-2" > < span className = {clsx( ' inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text- [ 11px ] font-semibold ', onlineChip.className )}> {onlineChip.icon} {onlineChip.label} </ span > < span className = {clsx( ' inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text- [ 11px ] font-semibold ', complianceChip.className )}> {complianceChip.label} </ span > {d.tamper_badge && ( < span className = "inline-flex items-center gap-1.5 rounded-full border border-orange-200 bg-orange-100 px-2.5 py-1 text-[11px] font-semibold text-orange-700" > < TriangleAlert className = "h-3.5 w-3.5" /> Tamper </ span > )} </ div > </ div > </ div > ); } function QuickAction({ title, desc, icon, cta }: { title: string; desc: string; icon: React.ReactNode; cta: string }) { const [busy, setBusy] = useState(false); return ( <div className="rounded-3xl border border-slate-200 bg-white p-4"> <div className="flex items-start gap-3"> <div className="h-11 w-11 rounded-2xl border border-slate-200 bg-slate-50 flex items-center justify-center"> {icon} </div> code Code download content_copy expand_less < div className = "min-w-0 flex-1" > < div className = "text-sm font-semibold text-slate-900" > {title} </ div > < div className = "mt-1 text-xs text-slate-600" > {desc} </ div > < button onClick = {async () => { setBusy(true); await new Promise((r) => setTimeout(r, 450)); setBusy(false); }} className={clsx( 'mt-4 inline-flex items-center gap-2 rounded-2xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white hover:bg-slate-950', busy && 'opacity-70' )} disabled={busy} > {busy ? < Loader2 className = "h-4 w-4 animate-spin" /> : null} {busy ? 'Running' : cta} </ button > </ div > </ div > </ div > ); } [3] ## Suggested Next Steps [3.1] أكتب لك الآن Mock API Routes كاملة داخل Next.js (Route Handlers) بنفس العقود التي استخدمناها هنا، بحيث تصبح الواجهة “تتكلم محليًا” بدون باك-إند خارجي. [3.2] بعد ذلك ننتقل مباشرة إلى Safety Protocol Studio UI بنفس الجودة (Library + Editor + Simulator + Versioning). [3.3] ثم نربط كل شيء بـ RBAC/ABAC Middleware على مستوى السيرفر (جلسات + صلاحيات + Audit تلقائي).
[132] [1] ## Next.js Route Handlers كاملة — Evidence API جاهزة (بدون Backend خارجي) هذه الملفات تجعل صفحات Evidence Center تعمل عبر API داخلي (Route Handlers) وتطبق RBAC + قيود Export/Delete + Legal Hold + Restricted وتستخدم In-Memory Store (للتطوير) ويمكن استبداله لاحقًا بقاعدة بيانات. [1.1] ### ملف 1 — قاعدة بيانات Mock مشتركة (Singleton Store) المسار: lib/mockdb.ts // lib/mockdb.ts import { randomUUID } from 'crypto'; export type Severity = 'low' | 'med' | 'high' | 'critical'; export type ContentType = 'text' | 'image' | 'audio' | 'video'; export type Classification = 'normal' | 'restricted' | 'legal_hold'; export type EvidenceItem = { evidence_id: string; family_id: string; child_id: string; device_id: string; created_at: string; content_type: ContentType; severity: Severity; classification: Classification; summary: string; sha256: string; has_preview: boolean; tags: string[]; }; export type EvidenceCustodyAction = 'create' | 'view' | 'export' | 'hold' | 'delete_attempt'; export type EvidenceCustody = { custody_id: string; evidence_id: string; actor_id: string; action: EvidenceCustodyAction; reason: string | null; created_at: string; }; export type EvidenceDetails = { item: EvidenceItem; custody: EvidenceCustody[]; notes: string | null; }; export type EvidenceExport = { export_id: string; evidence_id: string; export_uri: string; export_sha256: string; expires_at: string; created_at: string; }; type DB = { evidence: EvidenceItem[]; notes: Map<string, string>; custody: Map<string, EvidenceCustody[]>; exports: Map<string, EvidenceExport>; idempotency: Map<string, any>; }; let _db: DB | null = null; function randPick <T> (arr: T[]) { return arr[Math.floor(Math.random() * arr.length)]; } function sha64() { const a = randomUUID().replaceAll('-', ''); const b = randomUUID().replaceAll('-', ''); return (a + b).slice(0, 64); } function buildMockEvidence(count = 80): EvidenceItem[] { const family_id = randomUUID(); const children = [randomUUID(), randomUUID()]; const devices = [ { id: randomUUID(), child: children[0] }, { id: randomUUID(), child: children[0] }, { id: randomUUID(), child: children[1] }, ]; const severities: Severity[] = ['low', 'med', 'high', 'critical']; const ctypes: ContentType[] = ['text', 'image', 'audio', 'video']; const classes: Classification[] = ['normal', 'restricted', 'legal_hold']; const summaries = [ 'Grooming suspected in chat app', 'Bullying language detected in messages', 'Unsafe media detected (policy triggered)', 'Repeated tamper attempts on agent permissions', 'Geofence violation detected', 'Late-night risky activity pattern', 'Potential self-harm indicators detected', ]; const now = Date.now(); const items: EvidenceItem[] = []; for (let i = 0; i < count; i++) { const child_id = randPick(children); const device_id = randPick(devices.filter((d) => d.child === child_id)).id; code Code download content_copy expand_less const created_at = new Date (now - Math .random() * 1000 * 60 * 60 * 24 * 45 ).toISOString(); items.push({ evidence_id : randomUUID(), family_id, child_id, device_id, created_at, content_type : randPick(ctypes), severity : randPick(severities), classification : randPick(classes), summary : randPick(summaries), sha256 : sha64(), has_preview : true , tags : Math .random() > 0.72 ? [ 'incident' , 'auto-defense' ] : [], }); } return items.sort((a, b) => +new Date(b.created_at) - +new Date(a.created_at)); } function seedCustody(db: DB) { for (const ev of db.evidence) { const base: EvidenceCustody[] = [ { custody_id: randomUUID(), evidence_id: ev.evidence_id, actor_id: ev.device_id, action: 'create', reason: null, created_at: ev.created_at, }, ]; code Code download content_copy expand_less db.custody. set (ev.evidence_id, base); } } export function getMockDB(): DB { if (_db) return _db; const db: DB = { evidence: buildMockEvidence(90), notes: new Map<string, string>(), custody: new Map<string, EvidenceCustody[]>(), exports: new Map<string, EvidenceExport>(), idempotency: new Map<string, any>(), }; seedCustody(db); _db = db; return db; } [1.2] ### ملف 2 — Auth/RBAC بسيط (مؤقت للتطوير) المسار: lib/auth.ts // lib/auth.ts import { NextRequest } from 'next/server'; export type PrincipalRole = | 'FAMILY_OWNER' | 'FAMILY_COADMIN_LIMITED' | 'FAMILY_AUDITOR_READONLY' | 'SYSTEM_ADMIN' | 'SECURITY_OFFICER' | 'SUPPORT_AGENT'; export type Principal = { principal_id: string; role: PrincipalRole; family_id: string; display_name: string; }; export function canExport(role: PrincipalRole) { return role === 'FAMILY_OWNER'; } export function canDelete(role: PrincipalRole) { return role === 'FAMILY_OWNER'; } export function canWrite(role: PrincipalRole) { return role === 'FAMILY_OWNER' || role === 'FAMILY_COADMIN_LIMITED'; } export function getPrincipal(req: NextRequest): Principal { /** DEV MODE: Use cookies to simulate session: amana_role=FAMILY_OWNER amana_family= <uuid> amana_user= <uuid> If missing, fallback to safe default. */ const role = (req.cookies.get('amana_role')?.value as PrincipalRole) || 'FAMILY_OWNER'; const family_id = req.cookies.get('amana_family')?.value || '00000000-0000-0000-0000-000000000001'; const principal_id = req.cookies.get('amana_user')?.value || '00000000-0000-0000-0000-000000000002'; return { principal_id, family_id, role, display_name: role === 'FAMILY_OWNER' ? 'Family Owner' : 'Family Member', }; } export function requireFamilyAccess(principal: Principal, family_id: string) { // In real system: ABAC checks, org/tenant enforcement, membership table, etc. return principal.family_id === family_id || principal.role === 'SYSTEM_ADMIN'; } export class HttpError extends Error { status: number; constructor(status: number, message: string) { super(message); this.status = status; } } [1.3] ### ملف 3 — GET /api/evidence (List + Filters + Cursor) المسار: app/api/evidence/route.ts // app/api/evidence/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getMockDB, EvidenceItem, ContentType, Severity, Classification } from '@/lib/mockdb'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function parseCSV <T extends string> (v: string | null): T[] { if (!v) return []; return v .split(',') .map((x) => x.trim()) .filter(Boolean) as T[]; } function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest) { try { const principal = getPrincipal(req); const db = getMockDB(); code Code download content_copy expand_less // Query params const { searchParams } = new URL(req.url); const childId = searchParams.get( 'child_id' ); // optional const deviceId = searchParams.get( 'device_id' ); // optional const classification = searchParams.get( 'classification' ) as Classification | null ; // normal|restricted|legal_hold const search = (searchParams.get( 'search' ) || '' ).trim().toLowerCase(); const datePreset = (searchParams.get( 'date' ) || '7d' ) as '7d' | '30d' | 'all' ; const contentTypes = parseCSV<ContentType>(searchParams.get( 'content_types' )); const severities = parseCSV<Severity>(searchParams.get( 'severities' )); const cursor = searchParams.get( 'cursor' ); // evidence_id const limit = Math .min( Math .max( parseInt (searchParams.get( 'limit' ) || '25' , 10 ), 5 ), 60 ); // tenant guard const familyId = searchParams.get( 'family_id' ) || db.evidence[ 0 ]?.family_id; if (!familyId) throw new HttpError( 404 , 'Family not found' ); if (!requireFamilyAccess(principal, familyId)) throw new HttpError( 403 , 'Forbidden' ); let items: EvidenceItem[] = db.evidence.filter( ( x ) => x.family_id === familyId); // date cutoff if (datePreset !== 'all' ) { const days = datePreset === '7d' ? 7 : 30 ; const cutoff = Date .now() - days * 24 * 60 * 60 * 1000 ; items = items.filter( ( x ) => + new Date (x.created_at) >= cutoff); } if (childId) items = items.filter( ( x ) => x.child_id === childId); if (deviceId) items = items.filter( ( x ) => x.device_id === deviceId); if (classification && [ 'normal' , 'restricted' , 'legal_hold' ].includes(classification)) { items = items.filter( ( x ) => x.classification === classification); } if (contentTypes.length > 0 ) { const set = new Set (contentTypes); items = items.filter( ( x ) => set.has(x.content_type)); } if (severities.length > 0 ) { const set = new Set (severities); items = items.filter( ( x ) => set.has(x.severity)); } if (search) { items = items.filter( ( x ) => x.summary.toLowerCase().includes(search) || (x.tags || []).some( ( t ) => t.toLowerCase().includes(search)) ); } // cursor pagination (simple) let start = 0 ; if (cursor) { const idx = items.findIndex( ( x ) => x.evidence_id === cursor); start = idx >= 0 ? idx + 1 : 0 ; } const page = items.slice(start, start + limit); const next_cursor = items[start + limit]?.evidence_id ?? null ; return NextResponse.json({ items : page, next_cursor }, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [1.4] ### ملف 4 — GET /api/evidence/[id] (Details + Custody + Notes) المسار: app/api/evidence/[id]/route.ts // app/api/evidence/[id]/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getMockDB } from '@/lib/mockdb'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { randomUUID } from 'crypto'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const db = getMockDB(); const id = ctx.params.id; code Code download content_copy expand_less const item = db.evidence.find( ( x ) => x.evidence_id === id); if (!item) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); // Append custody "view" silently (for demo) const chain = db.custody.get(id) || []; chain.push({ custody_id : randomUUID(), evidence_id : id, actor_id : principal.principal_id, action : 'view' , reason : null , created_at : new Date ().toISOString(), }); db.custody.set(id, chain); const notes = db.notes.get(id) ?? null ; return NextResponse.json( { item, custody : chain, notes, }, { status : 200 } ); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [1.5] ### ملف 5 — POST /api/evidence/[id]/export (Export + Idempotency) المسار: app/api/evidence/[id]/export/route.ts // app/api/evidence/[id]/export/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getMockDB } from '@/lib/mockdb'; import { getPrincipal, requireFamilyAccess, canExport, HttpError } from '@/lib/auth'; import { randomUUID } from 'crypto'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const db = getMockDB(); const id = ctx.params.id; code Code download content_copy expand_less const body = await req.json().catch( () => ({})); const reason = String (body?.reason || '' ).trim(); const idempotencyKey = String (body?.idempotency_key || '' ).trim(); if (!reason || reason.length < 8 ) throw new HttpError( 400 , 'Reason is required (min 8 chars).' ); if (!idempotencyKey) throw new HttpError( 400 , 'idempotency_key is required.' ); // Idempotency replay if (db.idempotency.has(idempotencyKey)) { return NextResponse.json(db.idempotency.get(idempotencyKey), { status : 200 }); } const item = db.evidence.find( ( x ) => x.evidence_id === id); if (!item) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); if (!canExport(principal.role)) throw new HttpError( 403 , 'Export is allowed for family owner only.' ); if (item.classification === 'restricted' ) throw new HttpError( 403 , 'Export blocked for restricted evidence by policy.' ); const export_id = randomUUID(); const export_sha256 = randomUUID().replaceAll( '-' , '' ) + randomUUID().replaceAll( '-' , '' ); const expires_at = new Date ( Date .now() + 15 * 60 * 1000 ).toISOString(); const payload = { export_id, export_uri : 'https://example.com/temp-download-link' , expires_at, export_sha256 : export_sha256.slice( 0 , 64 ), }; // custody record const chain = db.custody.get(id) || []; chain.push({ custody_id : randomUUID(), evidence_id : id, actor_id : principal.principal_id, action : 'export' , reason, created_at : new Date ().toISOString(), }); db.custody.set(id, chain); db.exports.set(export_id, { export_id, evidence_id : id, export_uri : payload.export_uri, export_sha256 : payload.export_sha256, expires_at, created_at : new Date ().toISOString(), }); db.idempotency.set(idempotencyKey, payload); return NextResponse.json(payload, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [1.6] ### ملف 6 — POST /api/evidence/[id]/delete (Soft rules + Legal Hold) المسار: app/api/evidence/[id]/delete/route.ts // app/api/evidence/[id]/delete/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getMockDB } from '@/lib/mockdb'; import { getPrincipal, requireFamilyAccess, canDelete, HttpError } from '@/lib/auth'; import { randomUUID } from 'crypto'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const db = getMockDB(); const id = ctx.params.id; code Code download content_copy expand_less const body = await req.json().catch( () => ({})); const reason = String (body?.reason || '' ).trim(); const typed = String (body?.typed || '' ).trim().toUpperCase(); const mfa = String (body?.mfa_code || '' ).trim(); if (!reason || reason.length < 10 ) throw new HttpError( 400 , 'Reason is required (min 10 chars).' ); if (typed !== 'DELETE' ) throw new HttpError( 400 , 'Type DELETE to confirm.' ); if (!mfa || mfa.length < 4 ) throw new HttpError( 400 , 'mfa_code is required.' ); const itemIdx = db.evidence.findIndex( ( x ) => x.evidence_id === id); if (itemIdx < 0 ) throw new HttpError( 404 , 'Evidence not found' ); const item = db.evidence[itemIdx]; if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); if (!canDelete(principal.role)) throw new HttpError( 403 , 'Delete allowed for family owner only.' ); if (item.classification === 'legal_hold' ) throw new HttpError( 409 , 'Cannot delete legal hold evidence.' ); // custody record (delete attempt) const chain = db.custody.get(id) || []; chain.push({ custody_id : randomUUID(), evidence_id : id, actor_id : principal.principal_id, action : 'delete_attempt' , reason, created_at : new Date ().toISOString(), }); db.custody.set(id, chain); // Remove item (DEV DEMO) db.evidence.splice(itemIdx, 1 ); db.notes.delete(id); return NextResponse.json({ ok : true }, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [1.7] ### ملف 7 — POST /api/evidence/[id]/notes (Update Notes) المسار: app/api/evidence/[id]/notes/route.ts // app/api/evidence/[id]/notes/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getMockDB } from '@/lib/mockdb'; import { getPrincipal, requireFamilyAccess, canWrite, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const db = getMockDB(); const id = ctx.params.id; code Code download content_copy expand_less const body = await req.json().catch( () => ({})); const notes = String (body?.notes || '' ).slice( 0 , 1200 ); const item = db.evidence.find( ( x ) => x.evidence_id === id); if (!item) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); if (!canWrite(principal.role)) throw new HttpError( 403 , 'Not allowed' ); db.notes.set(id, notes); return NextResponse.json({ ok : true }, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [1.8] ### ملف 8 — POST /api/evidence/[id]/tags (Add Tag) المسار: app/api/evidence/[id]/tags/route.ts // app/api/evidence/[id]/tags/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getMockDB } from '@/lib/mockdb'; import { getPrincipal, requireFamilyAccess, canWrite, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const db = getMockDB(); const id = ctx.params.id; code Code download content_copy expand_less const body = await req.json().catch( () => ({})); const tag = String (body?.tag || '' ).trim(); if (!tag || tag.length > 40 ) throw new HttpError( 400 , 'Invalid tag.' ); const item = db.evidence.find( ( x ) => x.evidence_id === id); if (!item) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); if (!canWrite(principal.role)) throw new HttpError( 403 , 'Not allowed' ); item.tags = Array .from( new Set ([...(item.tags || []), tag])).slice( 0 , 10 ); return NextResponse.json({ ok : true , tags : item.tags }, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [2] ## Middleware جاهز — حماية /console و /api (RBAC مبدئي) المسار: middleware.ts // middleware.ts import { NextRequest, NextResponse } from 'next/server'; /** DEV middleware: Allows access if cookie amana_role exists If missing, sets a safe default role (FAMILY_OWNER) to keep dev flow fast In production: Validate session token / JWT Enforce tenant membership Add rate-limits and device posture checks */ export function middleware(req: NextRequest) { const url = req.nextUrl; const isConsole = url.pathname.startsWith('/console'); const isApi = url.pathname.startsWith('/api'); if (!isConsole && !isApi) return NextResponse.next(); const role = req.cookies.get('amana_role')?.value; if (!role) { const res = NextResponse.next(); res.cookies.set('amana_role', 'FAMILY_OWNER', { path: '/', httpOnly: false, sameSite: 'lax' }); res.cookies.set('amana_family', '00000000-0000-0000-0000-000000000001', { path: '/', httpOnly: false, sameSite: 'lax' }); res.cookies.set('amana_user', '00000000-0000-0000-0000-000000000002', { path: '/', httpOnly: false, sameSite: 'lax' }); return res; } return NextResponse.next(); } export const config = { matcher: ['/console/:path*', '/api/:path*'], }; [3] ## صفحة جديدة كاملة — Safety Protocol Studio (Editor + Simulator + Versioning) المسار المقترح: app/console/protocols/page.tsx هذه الصفحة هي المكان الذي يحدد فيه الأب (أو النظام) قواعد الدفاع الآلي لكل نوع حادثة. ماذا توفر الصفحة؟ مكتبة بروتوكولات جاهزة (Grooming / Bullying / Sexual content / Self-harm) محرر إعدادات “آمن” (بدون JSON فوضوي) محاكاة حادثة (Simulator) لمعرفة أي إجراءات ستُنفّذ إصدار/نسخ Versioning (Draft → Publish) 'use client'; import React, { useMemo, useState } from 'react'; import { ShieldAlert, ShieldCheck, ShieldX, Play, Save, Copy, Lock, ChevronRight, RefreshCw, Settings2, CheckCircle2, TriangleAlert, FileText, } from 'lucide-react'; type Severity = 'low' | 'med' | 'high' | 'critical'; type IncidentType = 'GROOMING' | 'BULLYING' | 'SEXUAL' | 'SELF_HARM' | 'TAMPER' | 'GEOFENCE'; type ActionType = | 'ALERT_SEND' | 'EVIDENCE_CREATE' | 'APP_KILL' | 'APP_BLOCK' | 'NET_QUARANTINE' | 'MIC_BLOCK' | 'CAMERA_BLOCK' | 'LOCKSCREEN_BLACKOUT' | 'WALKIE_TALKIE_ENABLE' | 'LIVE_CAMERA_REQUEST' | 'SCREENSHOT_CAPTURE'; type Protocol = { protocol_id: string; name: string; incident_type: IncidentType; enabled: boolean; min_severity: Severity; // core actions actions: ActionType[]; // constraints export_allowed: boolean; delete_allowed: boolean; // safe operational knobs screenshot_interval_sec: number; // 0 = off blackout_message: string; // versioning version: number; status: 'DRAFT' | 'PUBLISHED'; updated_at: string; }; function clsx(...parts: Array<string | false | null | undefined>) { return parts.filter(Boolean).join(' '); } function nowISO() { return new Date().toISOString(); } function severityBadge(sev: Severity) { if (sev === 'critical') return { label: 'Critical', className: 'bg-red-100 text-red-700 border-red-200', Icon: ShieldX }; if (sev === 'high') return { label: 'High', className: 'bg-orange-100 text-orange-700 border-orange-200', Icon: ShieldAlert }; if (sev === 'med') return { label: 'Medium', className: 'bg-yellow-100 text-yellow-700 border-yellow-200', Icon: TriangleAlert }; return { label: 'Low', className: 'bg-emerald-100 text-emerald-700 border-emerald-200', Icon: ShieldCheck }; } function incidentLabel(t: IncidentType) { const map: Record<IncidentType, string> = { GROOMING: 'Grooming / Luring', BULLYING: 'Bullying', SEXUAL: 'Sexual exploitation risk', SELF_HARM: 'Self-harm risk', TAMPER: 'Tamper attempt', GEOFENCE: 'Geofence violation', }; return map[t]; } function actionLabel(a: ActionType) { const map: Record<ActionType, string> = { ALERT_SEND: 'Send alert to parents', EVIDENCE_CREATE: 'Create evidence record', APP_KILL: 'Force close app', APP_BLOCK: 'Block app', NET_QUARANTINE: 'Quarantine network', MIC_BLOCK: 'Block microphone', CAMERA_BLOCK: 'Block camera', LOCKSCREEN_BLACKOUT: 'Lockscreen blackout', WALKIE_TALKIE_ENABLE: 'Enable walkie-talkie', LIVE_CAMERA_REQUEST: 'Request live camera', SCREENSHOT_CAPTURE: 'Capture screenshots', }; return map[a]; } function defaultProtocols(): Protocol[] { const base: Omit<Protocol, 'protocol_id'>[] = [ { name: 'Grooming Defense', incident_type: 'GROOMING', enabled: true, min_severity: 'high', actions: ['EVIDENCE_CREATE', 'ALERT_SEND', 'APP_KILL', 'NET_QUARANTINE', 'SCREENSHOT_CAPTURE', 'WALKIE_TALKIE_ENABLE'], export_allowed: true, delete_allowed: false, screenshot_interval_sec: 20, blackout_message: 'Device locked. Please contact a parent.', version: 1, status: 'PUBLISHED', updated_at: nowISO(), }, { name: 'Bullying Defense', incident_type: 'BULLYING', enabled: true, min_severity: 'med', actions: ['EVIDENCE_CREATE', 'ALERT_SEND', 'SCREENSHOT_CAPTURE'], export_allowed: true, delete_allowed: false, screenshot_interval_sec: 45, blackout_message: 'Restricted mode enabled. Please contact a parent.', version: 1, status: 'PUBLISHED', updated_at: nowISO(), }, { name: 'Sexual Risk Defense', incident_type: 'SEXUAL', enabled: true, min_severity: 'high', actions: ['EVIDENCE_CREATE', 'ALERT_SEND', 'APP_KILL', 'NET_QUARANTINE', 'MIC_BLOCK', 'CAMERA_BLOCK', 'LOCKSCREEN_BLACKOUT'], export_allowed: true, delete_allowed: false, screenshot_interval_sec: 15, blackout_message: 'Device locked for safety. Please contact a parent.', version: 1, status: 'PUBLISHED', updated_at: nowISO(), }, { name: 'Self-harm Defense', incident_type: 'SELF_HARM', enabled: true, min_severity: 'high', actions: ['EVIDENCE_CREATE', 'ALERT_SEND', 'WALKIE_TALKIE_ENABLE', 'LIVE_CAMERA_REQUEST'], export_allowed: true, delete_allowed: false, screenshot_interval_sec: 0, blackout_message: 'Support mode enabled. Please contact a parent.', version: 1, status: 'PUBLISHED', updated_at: nowISO(), }, ]; return base.map((x) => ({ protocol_id: crypto.randomUUID(), ...x })); } type SimInput = { incident_type: IncidentType; severity: Severity; }; function computeDecision(p: Protocol, input: SimInput) { if (!p.enabled) return { willRun: false, reason: 'Protocol disabled', actions: [] as ActionType[] }; const order: Severity[] = ['low', 'med', 'high', 'critical']; const sevOK = order.indexOf(input.severity) >= order.indexOf(p.min_severity); if (!sevOK) { return { willRun: false, reason: Below min severity (${p.min_severity}) , actions: [] as ActionType[] }; } if (input.incident_type !== p.incident_type) { return { willRun: false, reason: 'Incident type mismatch', actions: [] as ActionType[] }; } // Example policy hook: // - Always create evidence before any destructive action const normalized = [...p.actions]; if (normalized.includes('APP_KILL') && !normalized.includes('EVIDENCE_CREATE')) { normalized.unshift('EVIDENCE_CREATE'); } return { willRun: true, reason: 'Matched', actions: normalized }; } export default function ProtocolStudioPage() { const [protocols, setProtocols] = useState<Protocol[]>(defaultProtocols()); const [selectedId, setSelectedId] = useState <string> (protocols[0]?.protocol_id || ''); const selected = useMemo(() => protocols.find((p) => p.protocol_id === selectedId) || null, [protocols, selectedId]); const [sim, setSim] = useState <SimInput> ({ incident_type: 'GROOMING', severity: 'high' }); const decision = useMemo(() => (selected ? computeDecision(selected, sim) : null), [selected, sim]); const [toast, setToast] = useState<{ kind: 'ok' | 'err'; msg: string } | null>(null); function patchSelected(patch: Partial <Protocol> ) { setProtocols((prev) => prev.map((x) => x.protocol_id === selectedId ? { ...x, ...patch, updated_at: nowISO(), status: 'DRAFT' } : x ) ); } function publishSelected() { if (!selected) return; setProtocols((prev) => prev.map((x) => x.protocol_id === selectedId ? { ...x, status: 'PUBLISHED', version: x.version + 1, updated_at: nowISO() } : x ) ); setToast({ kind: 'ok', msg: 'Protocol published (version incremented).' }); setTimeout(() => setToast(null), 2000); } function cloneSelected() { if (!selected) return; const copy: Protocol = { ...selected, protocol_id: crypto.randomUUID(), name: selected.name + ' (Copy)', status: 'DRAFT', version: 1, updated_at: nowISO(), }; setProtocols((prev) => [copy, ...prev]); setSelectedId(copy.protocol_id); setToast({ kind: 'ok', msg: 'Protocol duplicated as draft.' }); setTimeout(() => setToast(null), 2000); } return ( <div className="min-h-screen bg-slate-50"> {toast && ( <div className="fixed top-4 right-4 z-50 rounded-2xl border bg-white p-4 shadow-lg"> <div className={clsx('text-sm font-semibold', toast.kind === 'ok' ? 'text-emerald-700' : 'text-red-700')}> {toast.msg} </div> </div> )} code Code download content_copy expand_less < div className = "mx-auto max-w-[1400px] px-4 py-6" > < header className = "flex flex-col gap-3 md:flex-row md:items-center md:justify-between" > < div > < h1 className = "text-xl font-semibold text-slate-900" > Safety Protocol Studio </ h1 > < p className = "mt-1 text-sm text-slate-600" > Configure auto-defense behavior with safe controls, audit-ready settings, and simulation. </ p > </ div > < div className = "flex items-center gap-2" > < button onClick = {cloneSelected} className = "inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50" > < Copy className = "h-4 w-4" /> Duplicate </ button > < button onClick = {publishSelected} className = "inline-flex items-center gap-2 rounded-2xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-slate-950" > < CheckCircle2 className = "h-4 w-4" /> Publish </ button > </ div > </ header > < div className = "mt-6 grid grid-cols-1 gap-4 lg:grid-cols-[360px_1fr]" > {/* Library */} < aside className = "rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden" > < div className = "border-b border-slate-200 p-4" > < div className = "text-sm font-semibold text-slate-900" > Protocol Library </ div > < div className = "mt-1 text-xs text-slate-500" > Select a protocol to edit and simulate </ div > </ div > < div className = "h-[720px] overflow-auto divide-y divide-slate-100" > {protocols.map((p) => { const sev = severityBadge(p.min_severity); const SevIcon = sev.Icon; return ( < button key = {p.protocol_id} onClick = {() => setSelectedId(p.protocol_id)} className={clsx('w-full p-4 text-left hover:bg-slate-50', p.protocol_id === selectedId && 'bg-slate-50')} > < div className = "flex items-start justify-between gap-3" > < div className = "min-w-0 flex-1" > < div className = "text-sm font-semibold text-slate-900 truncate" > {p.name} </ div > < div className = "mt-1 text-xs text-slate-500" > {incidentLabel(p.incident_type)} </ div > < div className = "mt-3 flex flex-wrap items-center gap-2" > < span className = {clsx( ' inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text- [ 11px ] font-semibold ', sev.className )}> < SevIcon className = "h-3.5 w-3.5" /> Min {sev.label} </ span > < span className = {clsx( ' inline-flex items-center gap-1.5 rounded-full border px-2.5 py-1 text- [ 11px ] font-semibold ', p.status === 'PUBLISHED' ? ' bg-emerald-100 text-emerald-700 border-emerald-200 ' : ' bg-slate-100 text-slate-700 border-slate-200 ' )} > < FileText className = "h-3.5 w-3.5" /> {p.status} v{p.version} </ span > </ div > </ div > < ChevronRight className = "h-5 w-5 text-slate-400 mt-2" /> </ div > </ button > ); })} </ div > </ aside > {/* Editor + Simulator */} < section className = "rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden" > < div className = "border-b border-slate-200 p-4 flex items-center justify-between" > < div > < div className = "text-sm font-semibold text-slate-900" > Editor & Simulator </ div > < div className = "mt-1 text-xs text-slate-500" > Safe knobs only. No raw policy code here. </ div > </ div > < div className = "inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs font-semibold text-slate-700" > < Settings2 className = "h-4 w-4" /> Audit-friendly controls </ div > </ div > {!selected ? ( < div className = "p-8" > < div className = "rounded-3xl border border-slate-200 bg-slate-50 p-6" > < div className = "text-sm font-semibold text-slate-900" > No protocol selected </ div > < div className = "mt-1 text-xs text-slate-600" > Choose a protocol from the library. </ div > </ div > </ div > ) : ( < div className = "p-4 grid grid-cols-1 gap-4 lg:grid-cols-[1fr_420px]" > {/* Editor */} < div className = "space-y-4" > < div className = "rounded-3xl border border-slate-200 bg-white p-4" > < div className = "flex items-start justify-between gap-3" > < div > < div className = "text-sm font-semibold text-slate-900" > Core settings </ div > < div className = "mt-1 text-xs text-slate-500" > Enable protocol and set minimum severity trigger </ div > </ div > < button onClick = {() => patchSelected({ enabled: !selected.enabled })} className={clsx( 'rounded-2xl px-3 py-2 text-xs font-semibold border', selected.enabled ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-slate-100 text-slate-700 border-slate-200' )} > {selected.enabled ? 'Enabled' : 'Disabled'} </ button > </ div > < div className = "mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2" > < Field label = "Protocol name" > < input value = {selected.name} onChange = {(e) => patchSelected({ name: e.target.value.slice(0, 60) })} className="w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" /> </ Field > < Field label = "Incident type" > < select value = {selected.incident_type} onChange = {(e) => patchSelected({ incident_type: e.target.value as any })} className="w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" > {(['GROOMING', 'BULLYING', 'SEXUAL', 'SELF_HARM', 'TAMPER', 'GEOFENCE'] as IncidentType[]).map((t) => ( < option key = {t} value = {t} > {incidentLabel(t)} </ option > ))} </ select > </ Field > < Field label = "Minimum severity" > < select value = {selected.min_severity} onChange = {(e) => patchSelected({ min_severity: e.target.value as any })} className="w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" > {(['low', 'med', 'high', 'critical'] as Severity[]).map((s) => ( < option key = {s} value = {s} > {s.toUpperCase()} </ option > ))} </ select > </ Field > < Field label = "Screenshot interval (sec)" > < input type = "number" min = {0} max = {300} value = {selected.screenshot_interval_sec} onChange = {(e) => patchSelected({ screenshot_interval_sec: Math.max(0, Math.min(300, Number(e.target.value || 0))) })} className="w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" /> </ Field > </ div > < div className = "mt-4" > < Field label = "Blackout message (when LOCKSCREEN_BLACKOUT triggers)" > < input value = {selected.blackout_message} onChange = {(e) => patchSelected({ blackout_message: e.target.value.slice(0, 140) })} className="w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" /> </ Field > </ div > </ div > < div className = "rounded-3xl border border-slate-200 bg-white p-4" > < div className = "text-sm font-semibold text-slate-900" > Actions </ div > < div className = "mt-1 text-xs text-slate-500" > Select which auto-defense actions should run when the incident matches. </ div > < div className = "mt-4 flex flex-wrap gap-2" > {( [ 'ALERT_SEND', 'EVIDENCE_CREATE', 'APP_KILL', 'APP_BLOCK', 'NET_QUARANTINE', 'MIC_BLOCK', 'CAMERA_BLOCK', 'LOCKSCREEN_BLACKOUT', 'WALKIE_TALKIE_ENABLE', 'LIVE_CAMERA_REQUEST', 'SCREENSHOT_CAPTURE', ] as ActionType[] ).map((a) => { const active = selected.actions.includes(a); return ( < button key = {a} onClick = {() => { const next = active ? selected.actions.filter((x) => x !== a) : [...selected.actions, a]; // guardrail: always evidence_create before destructive actions const destructive: ActionType[] = ['APP_KILL', 'APP_BLOCK', 'NET_QUARANTINE', 'LOCKSCREEN_BLACKOUT']; const hasDestructive = next.some((x) => destructive.includes(x)); if (hasDestructive && !next.includes('EVIDENCE_CREATE')) { next.unshift('EVIDENCE_CREATE'); } patchSelected({ actions: Array.from(new Set(next)) }); }} className={clsx( 'rounded-full border px-3 py-2 text-xs font-semibold', active ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-700 border-slate-200 hover:bg-slate-50' )} > {actionLabel(a)} </ button > ); })} </ div > < div className = "mt-4 rounded-3xl border border-slate-200 bg-slate-50 p-4" > < div className = "text-xs font-semibold text-slate-800" > Export / Delete constraints </ div > < div className = "mt-3 grid grid-cols-1 gap-3 sm:grid-cols-2" > < Toggle label = "Export allowed" value = {selected.export_allowed} onChange = {(v) => patchSelected({ export_allowed: v })} /> < Toggle label = "Delete allowed" value = {selected.delete_allowed} onChange = {(v) => patchSelected({ delete_allowed: v })} /> </ div > < div className = "mt-3 text-[11px] text-slate-600" > In production, delete/export permissions are enforced by RBAC + legal hold policies regardless of UI. </ div > </ div > </ div > < div className = "rounded-3xl border border-slate-200 bg-slate-50 p-4" > < div className = "flex items-center justify-between gap-3" > < div > < div className = "text-sm font-semibold text-slate-900" > Draft status </ div > < div className = "mt-1 text-xs text-slate-600" > Current: {selected.status} v{selected.version} — updated {new Date(selected.updated_at).toLocaleString()} </ div > </ div > < button onClick = {() => { setToast({ kind: 'ok', msg: 'Draft saved locally (mock).' }); setTimeout(() => setToast(null), 1500); }} className="inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-slate-50" > < Save className = "h-4 w-4" /> Save </ button > </ div > </ div > </ div > {/* Simulator */} < div className = "space-y-4" > < div className = "rounded-3xl border border-slate-200 bg-white p-4" > < div className = "flex items-center justify-between gap-3" > < div > < div className = "text-sm font-semibold text-slate-900" > Simulator </ div > < div className = "mt-1 text-xs text-slate-500" > Test a scenario and preview resulting actions </ div > </ div > < div className = "inline-flex items-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs font-semibold text-slate-700" > < Play className = "h-4 w-4" /> Run </ div > </ div > < div className = "mt-4 grid grid-cols-1 gap-3" > < Field label = "Incident type" > < select value = {sim.incident_type} onChange = {(e) => setSim((p) => ({ ...p, incident_type: e.target.value as any }))} className="w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" > {(['GROOMING', 'BULLYING', 'SEXUAL', 'SELF_HARM', 'TAMPER', 'GEOFENCE'] as IncidentType[]).map((t) => ( < option key = {t} value = {t} > {incidentLabel(t)} </ option > ))} </ select > </ Field > < Field label = "Severity" > < select value = {sim.severity} onChange = {(e) => setSim((p) => ({ ...p, severity: e.target.value as any }))} className="w-full rounded-2xl border border-slate-200 bg-white p-3 text-sm text-slate-800 outline-none focus:ring-2 focus:ring-slate-200" > {(['low', 'med', 'high', 'critical'] as Severity[]).map((s) => ( < option key = {s} value = {s} > {s.toUpperCase()} </ option > ))} </ select > </ Field > </ div > < div className = "mt-4 rounded-3xl border border-slate-200 bg-slate-50 p-4" > < div className = "text-xs font-semibold text-slate-800" > Decision </ div > < div className = "mt-2 text-xs text-slate-600" > {decision ? (decision.willRun ? 'Protocol will run' : 'Protocol will NOT run') : 'No selection'} </ div > {decision && ( <> < div className = "mt-2 text-[11px] text-slate-500" > Reason: {decision.reason} </ div > < div className = "mt-4" > < div className = "text-xs font-semibold text-slate-800" > Actions order </ div > < div className = "mt-2 space-y-2" > {decision.actions.length === 0 ? ( < div className = "text-xs text-slate-500" > No actions </ div > ) : ( decision.actions.map((a) => ( < div key = {a} className = "rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs font-semibold text-slate-700" > {actionLabel(a)} </ div > )) )} </ div > </ div > </> )} </ div > </ div > < div className = "rounded-3xl border border-slate-200 bg-white p-4" > < div className = "text-sm font-semibold text-slate-900" > Guardrails </ div > < div className = "mt-1 text-xs text-slate-500" > Non-negotiable safety guarantees enforced by engine </ div > < div className = "mt-4 space-y-2" > < GuardrailRow text = "Evidence is created before destructive actions (network quarantine / lockscreen)." /> < GuardrailRow text = "Restricted evidence cannot be exported by policy." /> < GuardrailRow text = "Legal-hold evidence cannot be deleted under any role." /> < GuardrailRow text = "All actions are recorded in audit + custody chain." /> </ div > < button onClick = {() => { setToast({ kind: 'ok', msg: 'Guardrails are enforced at engine level.' }); setTimeout(() => setToast(null), 1500); }} className="mt-4 inline-flex w-full items-center justify-center gap-2 rounded-2xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm font-semibold text-slate-800 hover:bg-white" > < RefreshCw className = "h-4 w-4" /> Re-check </ button > </ div > < div className = "rounded-3xl border border-slate-200 bg-slate-50 p-4" > < div className = "flex items-center gap-2 text-xs font-semibold text-slate-700" > < Lock className = "h-4 w-4 text-slate-600" /> Recommended production rule </ div > < div className = "mt-2 text-xs text-slate-600" > Protocol editing should require MFA + “reason” and produce an immutable audit event. </ div > </ div > </ div > </ div > )} </ section > </ div > </ div > </ div > ); } function Field({ label, children }: { label: string; children: React.ReactNode }) { return ( <div> <div className="text-xs font-semibold text-slate-700"> {label} </div> <div className="mt-2"> {children} </div> </div> ); } function Toggle({ label, value, onChange }: { label: string; value: boolean; onChange: (v: boolean) => void }) { return ( <button onClick={() => onChange(!value)} className={clsx( 'rounded-3xl border p-4 text-left', value ? 'border-emerald-200 bg-emerald-50' : 'border-slate-200 bg-white hover:bg-slate-50' )} > <div className="flex items-center justify-between gap-3"> <div> <div className="text-xs font-semibold text-slate-900"> {label} </div> <div className="mt-1 text-[11px] text-slate-500"> {value ? 'Enabled' : 'Disabled'} </div> </div> code Code download content_copy expand_less < div className = {clsx( ' h-10 w-10 rounded-2xl flex items-center justify-center border ', value ? ' border-emerald-200 bg-white ' : ' border-slate-200 bg-slate-50 ')}> {value ? < CheckCircle2 className = "h-5 w-5 text-emerald-700" /> : < Lock className = "h-5 w-5 text-slate-600" /> } </ div > </ div > </ button > ); } function GuardrailRow({ text }: { text: string }) { return ( <div className="rounded-2xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-700"> <span className="font-semibold text-slate-900"> Rule: </span> {text} </div> ); } [4] ## ربط صفحات UI الحالية بالـ API الحقيقي (بدل Mock داخل الصفحة) في ملف Evidence Center الذي عندك (app/console/evidence/page.tsx) استبدل الدوال التالية: mockListEvidence(...) → fetch('/api/evidence?...') mockGetEvidenceDetails(...) → fetch('/api/evidence/{id}') mockExportEvidence(...) → fetch('/api/evidence/{id}/export') mockDeleteEvidence(...) → fetch('/api/evidence/{id}/delete') mockUpdateNotes(...) → fetch('/api/evidence/{id}/notes') mockAddTag(...) → fetch('/api/evidence/{id}/tags') إذا تريد، سأرسل لك نسخة Evidence Center معدلة بالكامل (لا تعتمد على USE_MOCKS نهائيًا) وتستخدم API Route Handlers مباشرة. [5] Suggested Next Steps [5.1] أرسل لك النسخة المعدلة بالكامل من Evidence Center لتستخدم API الحقيقي بدل Mock (ملف واحد كامل). [5.2] نضيف صفحة Incident Details تربط (Incident → Evidence Items → Actions Timeline) بشكل مؤسسي. [5.3] نبدأ بناء Policy Engine Backend Design: Decision Pipeline Latency budgets Evidence sealing + hashing + KMS keys Zero-trust service-to-service auth (mTLS + SPIFFE/SPIRE)
[133] [1] ## استكمال التصميم المؤسسي للنظام — تحويل الـ Evidence Center إلى Production-Grade سأكمل الآن بالجزء “المؤسسي الحقيقي” الذي يجعل النظام منافسًا عالميًا مثل Bark وأكثر، ويصلح لمنتج رقابة أبوية + أدلة رقمية + دفاع آلي + جاهزية قانونية. [2] ## هل نستخدم قاعدة بيانات موحدة لكل الأدوار؟ نعم… ولكن بطريقة صحيحة نعم يتم استخدام قاعدة بيانات موحّدة تشمل: الأب/الأم (Family Users) الأبناء (Children) الأجهزة (Devices) المشرفين (Co-admin) أدوار المؤسسة (System Admin / Support / Security / Developer) الأدلة الرقمية (Evidence) سجلات الحيازة القانونية (Chain-of-Custody) إعدادات بروتوكولات الدفاع الآلي (Safety Protocols) سجلات الأحداث (Audit Logs) لكن ليس بشكل “جداول مبعثرة بلا عزل”. الصحيح هو مفهوم: [2.1] Multi-Tenant Unified Database قاعدة موحدة + عزل Tenant صارم عبر: tenant_id أو family_id Row Level Security (RLS) في PostgreSQL سياسات وصول تمنع أي حساب من قراءة بيانات أسرة أخرى. [2.2] فصل البيانات حسب طبيعتها (وليس حسب نوع المستخدم) قاعدة موحدة للكيانات الأساسية، مع فصل تخزين المحتوى الثقيل: PostgreSQL: المستخدمين + العلاقات + الأدلة كـ metadata + السجل القانوني + الإعدادات Object Storage (S3-compatible): ملفات الأدلة (صور/صوت/فيديو) مشفرة Time-Series/Logs: Telemetry إن احتجت (اختياري) هذا يعطيك أفضل توازن بين الأمان + الأداء + قابلية التوسع. [3] ## مواصفات قاعدة البيانات — الجداول الأساسية (Enterprise Schema) [3.1] جدول 1 — Families (العائلة/المؤسسة المنزلية) Table: Families الحقل النوع ملاحظات أمنية family_id UUID PK Tenant Root owner_user_id UUID FK الأب مدير الأسرة plan TEXT خطة الاشتراك created_at TIMESTAMP status TEXT active/suspended [3.2] جدول 2 — Users (كل المستخدمين: أب/أم/مشرف/دعم/أمن) Table: Users الحقل النوع ملاحظات user_id UUID PK family_id UUID FK Nullable Null للأدوار المؤسسية (System) email TEXT UNIQUE phone TEXT password_hash TEXT Argon2id/Bcrypt mfa_enabled BOOLEAN status TEXT active/locked created_at TIMESTAMP [3.3] جدول 3 — Roles + Role Bindings (RBAC) Table: Roles الحقل النوع ملاحظات role_id UUID PK role_key TEXT UNIQUE FAMILY_OWNER / COADMIN / SUPPORT… scope TEXT FAMILY / SYSTEM Table: UserRoles الحقل النوع ملاحظات user_role_id UUID PK user_id UUID FK role_id UUID FK family_id UUID FK Nullable للأدوار داخل الأسرة created_at TIMESTAMP [3.4] جدول 4 — Children + Devices Table: Children الحقل النوع ملاحظات child_id UUID PK family_id UUID FK nickname TEXT بدون بيانات حساسة dob DATE Nullable إن رغبت (اختياري) created_at TIMESTAMP Table: Devices الحقل النوع ملاحظات device_id UUID PK family_id UUID FK child_id UUID FK الجهاز يتبع طفل platform TEXT Android model TEXT agent_version TEXT pairing_status TEXT paired/unpaired last_seen_at TIMESTAMP [3.5] جدول 5 — Incidents (الحوادث) + Evidence (الأدلة) Table: Incidents الحقل النوع ملاحظات incident_id UUID PK family_id UUID FK child_id UUID FK device_id UUID FK incident_type TEXT grooming/bullying… severity TEXT low/med/high/critical status TEXT open/contained/escalated created_at TIMESTAMP Table: Evidence الحقل النوع ملاحظات أمنية evidence_id UUID PK family_id UUID FK incident_id UUID FK ربط الدليل بحادثة child_id UUID FK device_id UUID FK content_type TEXT text/image/audio/video classification TEXT normal/restricted/legal_hold summary TEXT تلخيص آمن object_uri TEXT Nullable رابط S3 sha256 TEXT ختم سلامة created_at TIMESTAMP [3.6] جدول 6 — Chain of Custody (سلسلة الحيازة القانونية) Table: CustodyLog الحقل النوع ملاحظات custody_id UUID PK evidence_id UUID FK actor_user_id UUID FK من قام بالفعل action TEXT create/view/export/delete_attempt/hold reason TEXT Nullable سبب إلزامي للتصدير والحذف created_at TIMESTAMP ip_hash TEXT Nullable عدم تخزين IP الخام device_fingerprint TEXT Nullable هذه النقطة هي التي ترفعك من “رقابة أبوية” إلى منصة أدلة رقمية مؤسسية جاهزة قانونيًا. [4] ## “Vault” مخزن الأدلة الرقمية — تصميم احترافي الأدلة لا تُخزَّن كصور داخل PostgreSQL. الاحترافي هو: [4.1] Evidence Vault Architecture ملفات الأدلة (Media) داخل Object Storage metadata داخل Postgres كل ملف Evidence يحصل على: sha256 encrypted_data_key_id object_version retention_policy [4.2] Legal Hold و Restricted restricted: يمنع التصدير حتى للأب إذا رغبت بسياسة أقوى legal_hold: يمنع الحذف نهائيًا لأي دور [5] ## الدفاع الآلي (Auto-Defense) — نموذج التشغيل المؤسسي بدلاً من “إغلاق تطبيق” بشكل عشوائي، يتم التنفيذ عبر Engine رسمي: [5.1] Auto-Defense Engine Pipeline ثابت: Detect (نص/صورة/صوت) Classify Severity Create Incident + Evidence Decide Actions (Policy Engine) Execute on Device (Child Agent) Notify Parents Audit Everything [5.2] القاعدة الذهبية أي إجراء قوي مثل: NET_QUARANTINE LOCKSCREEN_BLACKOUT CAMERA_BLOCK لا ينفذ إلا بعد: Evidence Created Custody Record Written [6] ## تصميم Role Model النهائي (موسع ومكتمل) أنت ذكرت أدوار ممتازة، وهذه النسخة النهائية الأقوى عالميًا: [6.1] داخل الأسرة (Family Scope) Family Owner (الأب) كل الصلاحيات حذف الأدلة + تصديرها + نشر البروتوكولات Co-Admin Limited (الأم) قراءة الأدلة إضافة ملاحظات تنفيذ أوضاع ذكية بدون حذف (ولا Export إذا رغبت) Read-Only Auditor (اختياري) مثل مستشار أسري/مرشد/محامي قراءة فقط لفترة مؤقتة Child (ضمنيًا وليس حساب دخول كامل) جهاز فقط + وكيل طفل [6.2] داخل المؤسسة (System Scope) System Admin إدارة النظام بالكامل (بدون رؤية أدلة الأسر افتراضيًا) Security Officer (SOC / Blue Team) مراقبة اختراقات المنصة لا يرى محتوى الأدلة Support Agent دعم فني لا يرى محتوى الأدلة إطلاقًا فقط Metadata آمنة (مثلاً: “يوجد حادثة عالية severity” بدون تفاصيل) Developer (مقيد) لا يرى بيانات حقيقية فقط بيئة staging + بيانات masked Compliance / DPO (مهم جدًا) مسؤول خصوصية وامتثال يدير retention وسياسات البيانات هذه الإضافة (Compliance/DPO) مهمة إذا تريد منتج “عالمي رسمي”. [7] ## أهم قرار: من يرى الأدلة؟ وكيف؟ [7.1] القاعدة المؤسسية الأدلة الرقمية هي “ملكية الأسرة” لكن المنصة مسؤولة عن: الحماية التشفير منع التسريب منع الوصول الداخلي [7.2] سياسات رؤية الدليل الأب: Full الأم: View + Notes فقط الدعم الفني: لا يرى المحتوى Security Officer: يرى “حوادث” فقط وليس الدليل System Admin: لا يرى محتوى إلا بحالة طوارئ قانونية وتدقيق عالي (Break-Glass) [8] ## Suggested Next Steps [8.1] سأقوم الآن مباشرة بالخطوة التالية الأقوى: Prisma Schema كامل + تحويل Route Handlers من Mock إلى PostgreSQL (Production Ready). [8.2] ثم نضيف صفحة Incidents Center تربط: Incident → Evidence → Actions Timeline. [8.3] ثم نكتب Device Command API (لأوامر الإغلاق/الحجب/العزل/البث المباشر) بشكل مؤسسي مع Queue. إذا تريد أن أكمل فورًا: سأرسل في الرسالة القادمة ملف Prisma schema كامل + routes معدلة بالكامل (بدون أي Mock). [1] ## ممتاز — الآن ننقل النظام من Mock إلى PostgreSQL بشكل Production-Grade (Prisma + Route Handlers) سأكمل بالخطوة العملية الأقوى: Schema مؤسسي كامل + Prisma Client + تحويل Evidence APIs إلى قاعدة بيانات حقيقية (مع الحفاظ على نفس قواعد RBAC وقيود Export/Delete + Legal Hold). [2] ملف Prisma Schema كامل (Enterprise-Ready) المسار: prisma/schema.prisma هذا المخطط مصمم خصيصًا لـ: رقابة أبوية + أدلة رقمية + حوادث + دفاع آلي + سلسلة حيازة + أوامر الأجهزة + بروتوكولات // prisma/schema.prisma generator client { provider = "prisma-client-js" } datasource db { provider = "postgresql" url = env("DATABASE_URL") } /* ========================= Enums ========================= */ enum UserStatus { ACTIVE LOCKED SUSPENDED } enum RoleScope { FAMILY SYSTEM } enum IncidentType { GROOMING BULLYING SEXUAL SELF_HARM TAMPER GEOFENCE } enum Severity { LOW MED HIGH CRITICAL } enum IncidentStatus { OPEN CONTAINED ESCALATED CLOSED } enum ContentType { TEXT IMAGE AUDIO VIDEO } enum EvidenceClassification { NORMAL RESTRICTED LEGAL_HOLD } enum CustodyAction { CREATE VIEW EXPORT HOLD DELETE_ATTEMPT NOTE_UPDATE TAG_UPDATE } enum ProtocolStatus { DRAFT PUBLISHED } enum ActionType { ALERT_SEND EVIDENCE_CREATE APP_KILL APP_BLOCK NET_QUARANTINE MIC_BLOCK CAMERA_BLOCK LOCKSCREEN_BLACKOUT WALKIE_TALKIE_ENABLE LIVE_CAMERA_REQUEST SCREENSHOT_CAPTURE } enum DevicePlatform { ANDROID } enum PairingStatus { PAIRED UNPAIRED REVOKED } enum CommandType { APP_KILL APP_BLOCK NET_QUARANTINE MIC_BLOCK CAMERA_BLOCK LOCKSCREEN_BLACKOUT WALKIE_TALKIE_ENABLE LIVE_CAMERA_REQUEST SCREENSHOT_CAPTURE } enum CommandStatus { QUEUED SENT ACKED FAILED EXPIRED } /* ========================= Tenant / Family ========================= */ model Family { family_id String @id @default(uuid()) owner_user_id String plan String @default("FREE") status String @default("active") created_at DateTime @default(now()) updated_at DateTime @updatedAt owner User @relation("FamilyOwner", fields: [owner_user_id], references: [user_id]) users User[] children Child[] devices Device[] incidents Incident[] evidence Evidence[] roles UserRole[] protocols SafetyProtocol[] audits AuditLog[] @@index([owner_user_id]) } /* ========================= Users / RBAC ========================= */ model User { user_id String @id @default(uuid()) family_id String? email String @unique phone String? password_hash String mfa_enabled Boolean @default(false) status UserStatus @default(ACTIVE) display_name String @default("User") created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family? @relation(fields: [family_id], references: [family_id]) owned_family Family[] @relation("FamilyOwner") roles UserRole[] custody_logs CustodyLog[] deviceCommands DeviceCommand[] audit_logs AuditLog[] @@index([family_id]) } model Role { role_id String @id @default(uuid()) role_key String @unique // FAMILY_OWNER, FAMILY_COADMIN_LIMITED, SUPPORT_AGENT, ... scope RoleScope created_at DateTime @default(now()) bindings UserRole[] } model UserRole { user_role_id String @id @default(uuid()) user_id String role_id String family_id String? created_at DateTime @default(now()) user User @relation(fields: [user_id], references: [user_id]) role Role @relation(fields: [role_id], references: [role_id]) family Family? @relation(fields: [family_id], references: [family_id]) @@index([user_id]) @@index([role_id]) @@index([family_id]) @@unique([user_id, role_id, family_id]) } /* ========================= Children / Devices ========================= */ model Child { child_id String @id @default(uuid()) family_id String nickname String dob DateTime? created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) devices Device[] incidents Incident[] evidence Evidence[] @@index([family_id]) } model Device { device_id String @id @default(uuid()) family_id String child_id String platform DevicePlatform @default(ANDROID) model String? os_version String? agent_version String? pairing_status PairingStatus @default(UNPAIRED) last_seen_at DateTime? created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) child Child @relation(fields: [child_id], references: [child_id]) incidents Incident[] evidence Evidence[] commands DeviceCommand[] @@index([family_id]) @@index([child_id]) } /* ========================= Incidents / Evidence ========================= */ model Incident { incident_id String @id @default(uuid()) family_id String child_id String device_id String incident_type IncidentType severity Severity status IncidentStatus @default(OPEN) created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) child Child @relation(fields: [child_id], references: [child_id]) device Device @relation(fields: [device_id], references: [device_id]) evidence Evidence[] @@index([family_id]) @@index([child_id]) @@index([device_id]) @@index([incident_type, severity]) } model Evidence { evidence_id String @id @default(uuid()) family_id String incident_id String? child_id String device_id String content_type ContentType severity Severity classification EvidenceClassification @default(NORMAL) summary String object_uri String? // S3 link (encrypted object) sha256 String // integrity seal has_preview Boolean @default(true) tags String[] @default([]) notes String? created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) child Child @relation(fields: [child_id], references: [child_id]) device Device @relation(fields: [device_id], references: [device_id]) incident Incident? @relation(fields: [incident_id], references: [incident_id]) custody CustodyLog[] exports EvidenceExport[] @@index([family_id]) @@index([child_id]) @@index([device_id]) @@index([created_at]) @@index([severity, classification]) } model CustodyLog { custody_id String @id @default(uuid()) evidence_id String actor_user_id String? actor_device_id String? action CustodyAction reason String? ip_hash String? device_fingerprint String? created_at DateTime @default(now()) evidence Evidence @relation(fields: [evidence_id], references: [evidence_id]) actor User? @relation(fields: [actor_user_id], references: [user_id]) @@index([evidence_id]) @@index([actor_user_id]) @@index([action]) @@index([created_at]) } model EvidenceExport { export_id String @id @default(uuid()) evidence_id String export_uri String export_sha256 String expires_at DateTime created_at DateTime @default(now()) evidence Evidence @relation(fields: [evidence_id], references: [evidence_id]) @@index([evidence_id]) @@index([expires_at]) } /* ========================= Safety Protocols ========================= */ model SafetyProtocol { protocol_id String @id @default(uuid()) family_id String name String incident_type IncidentType enabled Boolean @default(true) min_severity Severity @default(MED) status ProtocolStatus @default(DRAFT) version Int @default(1) export_allowed Boolean @default(true) delete_allowed Boolean @default(false) screenshot_interval_sec Int @default(0) blackout_message String @default("Device locked. Please contact a parent.") created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) actions ProtocolAction[] @@index([family_id]) @@index([incident_type]) } model ProtocolAction { protocol_action_id String @id @default(uuid()) protocol_id String action ActionType order Int protocol SafetyProtocol @relation(fields: [protocol_id], references: [protocol_id]) @@index([protocol_id]) @@unique([protocol_id, action]) } /* ========================= Device Commands (Agent execution) ========================= */ model DeviceCommand { command_id String @id @default(uuid()) family_id String device_id String issued_by_user_id String? type CommandType payload_json Json? status CommandStatus @default(QUEUED) expires_at DateTime? created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) device Device @relation(fields: [device_id], references: [device_id]) issuer User? @relation(fields: [issued_by_user_id], references: [user_id]) @@index([family_id]) @@index([device_id]) @@index([status]) } /* ========================= Audit Logs (Platform-wide) ========================= */ model AuditLog { audit_id String @id @default(uuid()) family_id String? actor_user_id String? event_key String event_json Json? created_at DateTime @default(now()) family Family? @relation(fields: [family_id], references: [family_id]) actor User? @relation(fields: [actor_user_id], references: [user_id]) @@index([family_id]) @@index([actor_user_id]) @@index([created_at]) } [3] Prisma Client Singleton (مهم لمنع تعدد الاتصالات في Dev) المسار: lib/prisma.ts // lib/prisma.ts import { PrismaClient } from '@prisma/client'; declare global { // eslint-disable-next-line no-var var prisma : PrismaClient | undefined; } export const prisma = global. prisma || new PrismaClient({ log: ['error', 'warn'], }); if (process.env.NODE_ENV !== 'production') global. prisma = prisma; [4] تحديث Auth/RBAC ليعمل مع Prisma (Production Direction) المسار: lib/auth.ts هذا إصدار “متوافق” مع ما كتبناه سابقًا، لكنه الآن جاهز للتطوير لاحقًا بقراءة الأدوار من DB. // lib/auth.ts import { NextRequest } from 'next/server'; export type PrincipalRole = | 'FAMILY_OWNER' | 'FAMILY_COADMIN_LIMITED' | 'FAMILY_AUDITOR_READONLY' | 'SYSTEM_ADMIN' | 'SECURITY_OFFICER' | 'SUPPORT_AGENT' | 'DEVELOPER' | 'COMPLIANCE_OFFICER'; export type Principal = { principal_id: string; role: PrincipalRole; family_id: string; display_name: string; }; export function canExport(role: PrincipalRole) { return role === 'FAMILY_OWNER'; } export function canDelete(role: PrincipalRole) { return role === 'FAMILY_OWNER'; } export function canWrite(role: PrincipalRole) { return role === 'FAMILY_OWNER' || role === 'FAMILY_COADMIN_LIMITED'; } export function getPrincipal(req: NextRequest): Principal { /** DEV MODE: cookies: amana_role, amana_family, amana_user */ const role = (req.cookies.get('amana_role')?.value as PrincipalRole) || 'FAMILY_OWNER'; const family_id = req.cookies.get('amana_family')?.value || '00000000-0000-0000-0000-000000000001'; const principal_id = req.cookies.get('amana_user')?.value || '00000000-0000-0000-0000-000000000002'; return { principal_id, family_id, role, display_name: role === 'FAMILY_OWNER' ? 'Family Owner' : 'User', }; } export function requireFamilyAccess(principal: Principal, family_id: string) { // SYSTEM_ADMIN might have cross-tenant abilities (break-glass policy in prod) return principal.family_id === family_id || principal.role === 'SYSTEM_ADMIN'; } export class HttpError extends Error { status: number; constructor(status: number, message: string) { super(message); this.status = status; } } [5] Evidence API حقيقي (PostgreSQL) — List + Filters + Cursor المسار: app/api/evidence/route.ts // app/api/evidence/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { ContentType, EvidenceClassification, Severity } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function parseCSV <T extends string> (v: string | null): T[] { if (!v) return []; return v .split(',') .map((x) => x.trim()) .filter(Boolean) as T[]; } export async function GET(req: NextRequest) { try { const principal = getPrincipal(req); code Code download content_copy expand_less const { searchParams } = new URL(req.url); const familyId = searchParams.get( 'family_id' ) || principal.family_id; if (!requireFamilyAccess(principal, familyId)) throw new HttpError( 403 , 'Forbidden' ); const childId = searchParams.get( 'child_id' ); const deviceId = searchParams.get( 'device_id' ); const classification = searchParams.get( 'classification' )?.toUpperCase() as EvidenceClassification | undefined ; const search = (searchParams.get( 'search' ) || '' ).trim().toLowerCase(); const datePreset = (searchParams.get( 'date' ) || '7d' ) as '7d' | '30d' | 'all' ; const contentTypes = parseCSV< string >(searchParams.get( 'content_types' )).map( ( x ) => x.toUpperCase()) as ContentType[]; const severities = parseCSV< string >(searchParams.get( 'severities' )).map( ( x ) => x.toUpperCase()) as Severity[]; const cursor = searchParams.get( 'cursor' ); // evidence_id const limit = Math .min( Math .max( parseInt (searchParams.get( 'limit' ) || '25' , 10 ), 5 ), 60 ); let createdAtGte: Date | undefined = undefined ; if (datePreset !== 'all' ) { const days = datePreset === '7d' ? 7 : 30 ; createdAtGte = new Date ( Date .now() - days * 24 * 60 * 60 * 1000 ); } const where: any = { family_id : familyId, }; if (childId) where.child_id = childId; if (deviceId) where.device_id = deviceId; if (createdAtGte) where.created_at = { gte : createdAtGte }; if (classification && [ 'NORMAL' , 'RESTRICTED' , 'LEGAL_HOLD' ].includes(classification)) { where.classification = classification; } if (contentTypes.length > 0 ) { where.content_type = { in : contentTypes }; } if (severities.length > 0 ) { where.severity = { in : severities }; } if (search) { where.OR = [ { summary : { contains : search, mode : 'insensitive' } }, { tags : { has : search } }, ]; } const items = await prisma.evidence.findMany({ where, orderBy : { created_at : 'desc' }, take : limit + 1 , ...(cursor ? { skip : 1 , cursor : { evidence_id : cursor }, } : {}), select : { evidence_id : true , family_id : true , child_id : true , device_id : true , incident_id : true , created_at : true , content_type : true , severity : true , classification : true , summary : true , sha256 : true , has_preview : true , tags : true , }, }); const hasMore = items.length > limit; const page = hasMore ? items.slice( 0 , limit) : items; const next_cursor = hasMore ? page[page.length - 1 ]?.evidence_id ?? null : null ; return NextResponse.json({ items : page, next_cursor }, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [6] Evidence Details API — Evidence + Custody + Notes المسار: app/api/evidence/[id]/route.ts // app/api/evidence/[id]/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { CustodyAction } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const id = ctx.params.id; code Code download content_copy expand_less const item = await prisma.evidence.findUnique({ where : { evidence_id : id }, select : { evidence_id : true , family_id : true , child_id : true , device_id : true , incident_id : true , created_at : true , content_type : true , severity : true , classification : true , summary : true , object_uri : true , sha256 : true , has_preview : true , tags : true , notes : true , }, }); if (!item) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); // Custody record: VIEW await prisma.custodyLog.create({ data : { evidence_id : id, actor_user_id : principal.principal_id, action : CustodyAction.VIEW, reason : null , }, }); const custody = await prisma.custodyLog.findMany({ where : { evidence_id : id }, orderBy : { created_at : 'asc' }, select : { custody_id : true , evidence_id : true , actor_user_id : true , actor_device_id : true , action : true , reason : true , created_at : true , }, }); return NextResponse.json( { item, custody, notes : item.notes ?? null , }, { status : 200 } ); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [7] Evidence Export API — Idempotency + Policy + Custody المسار: app/api/evidence/[id]/export/route.ts // app/api/evidence/[id]/export/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, canExport, HttpError } from '@/lib/auth'; import { CustodyAction, EvidenceClassification } from '@prisma/client'; import { randomUUID } from 'crypto'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const id = ctx.params.id; code Code download content_copy expand_less const body = await req.json().catch( () => ({})); const reason = String (body?.reason || '' ).trim(); const idempotencyKey = String (body?.idempotency_key || '' ).trim(); if (!reason || reason.length < 8 ) throw new HttpError( 400 , 'Reason is required (min 8 chars).' ); if (!idempotencyKey) throw new HttpError( 400 , 'idempotency_key is required.' ); // Check evidence const item = await prisma.evidence.findUnique({ where : { evidence_id : id }, select : { evidence_id : true , family_id : true , classification : true }, }); if (!item) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); if (!canExport(principal.role)) throw new HttpError( 403 , 'Export is allowed for family owner only.' ); if (item.classification === EvidenceClassification.RESTRICTED) { throw new HttpError( 403 , 'Export blocked for restricted evidence by policy.' ); } // Idempotency: reuse existing export if same key used const existing = await prisma.auditLog.findFirst({ where : { actor_user_id : principal.principal_id, event_key : 'EVIDENCE_EXPORT_IDEMPOTENCY' , event_json : { path : [ 'idempotency_key' ], equals : idempotencyKey, }, }, orderBy : { created_at : 'desc' }, }); if (existing?.event_json && (existing.event_json as any )?.payload) { return NextResponse.json((existing.event_json as any ).payload, { status : 200 }); } const export_id = randomUUID(); const export_sha256 = (randomUUID().replaceAll( '-' , '' ) + randomUUID().replaceAll( '-' , '' )).slice( 0 , 64 ); const expires_at = new Date ( Date .now() + 15 * 60 * 1000 ); // [Inference] في الإنتاج سيتم إنشاء رابط تنزيل موقّع Signed URL من S3/KMS const payload = { export_id, export_uri : 'https://example.com/temp-download-link' , expires_at : expires_at.toISOString(), export_sha256, }; await prisma.evidenceExport.create({ data : { export_id, evidence_id : id, export_uri : payload.export_uri, export_sha256, expires_at, }, }); await prisma.custodyLog.create({ data : { evidence_id : id, actor_user_id : principal.principal_id, action : CustodyAction.EXPORT, reason, }, }); await prisma.auditLog.create({ data : { family_id : item.family_id, actor_user_id : principal.principal_id, event_key : 'EVIDENCE_EXPORT_IDEMPOTENCY' , event_json : { idempotency_key : idempotencyKey, payload, }, }, }); return NextResponse.json(payload, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [8] Evidence Delete API — MFA + Reason + Legal Hold Lock المسار: app/api/evidence/[id]/delete/route.ts // app/api/evidence/[id]/delete/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, canDelete, HttpError } from '@/lib/auth'; import { CustodyAction, EvidenceClassification } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const id = ctx.params.id; code Code download content_copy expand_less const body = await req.json().catch( () => ({})); const reason = String (body?.reason || '' ).trim(); const typed = String (body?.typed || '' ).trim().toUpperCase(); const mfa = String (body?.mfa_code || '' ).trim(); if (!reason || reason.length < 10 ) throw new HttpError( 400 , 'Reason is required (min 10 chars).' ); if (typed !== 'DELETE' ) throw new HttpError( 400 , 'Type DELETE to confirm.' ); if (!mfa || mfa.length < 4 ) throw new HttpError( 400 , 'mfa_code is required.' ); const item = await prisma.evidence.findUnique({ where : { evidence_id : id }, select : { evidence_id : true , family_id : true , classification : true }, }); if (!item) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); if (!canDelete(principal.role)) throw new HttpError( 403 , 'Delete allowed for family owner only.' ); if (item.classification === EvidenceClassification.LEGAL_HOLD) { throw new HttpError( 409 , 'Cannot delete legal-hold evidence.' ); } // custody: delete attempt await prisma.custodyLog.create({ data : { evidence_id : id, actor_user_id : principal.principal_id, action : CustodyAction.DELETE_ATTEMPT, reason, }, }); // Delete evidence record (production might be "tombstone" soft delete) await prisma.evidence.delete({ where : { evidence_id : id } }); return NextResponse.json({ ok : true }, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [9] Notes API — تحديث الملاحظات + Custody Log المسار: app/api/evidence/[id]/notes/route.ts // app/api/evidence/[id]/notes/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, canWrite, HttpError } from '@/lib/auth'; import { CustodyAction } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const id = ctx.params.id; code Code download content_copy expand_less const body = await req.json().catch( () => ({})); const notes = String (body?.notes || '' ).slice( 0 , 1200 ); const item = await prisma.evidence.findUnique({ where : { evidence_id : id }, select : { evidence_id : true , family_id : true }, }); if (!item) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); if (!canWrite(principal.role)) throw new HttpError( 403 , 'Not allowed' ); await prisma.evidence.update({ where : { evidence_id : id }, data : { notes }, }); await prisma.custodyLog.create({ data : { evidence_id : id, actor_user_id : principal.principal_id, action : CustodyAction.NOTE_UPDATE, reason : null , }, }); return NextResponse.json({ ok : true }, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [10] Tags API — إضافة Tag + Custody Log المسار: app/api/evidence/[id]/tags/route.ts // app/api/evidence/[id]/tags/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, canWrite, HttpError } from '@/lib/auth'; import { CustodyAction } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const id = ctx.params.id; code Code download content_copy expand_less const body = await req.json().catch( () => ({})); const tag = String (body?.tag || '' ).trim().toLowerCase(); if (!tag || tag.length > 40 ) throw new HttpError( 400 , 'Invalid tag.' ); const item = await prisma.evidence.findUnique({ where : { evidence_id : id }, select : { evidence_id : true , family_id : true , tags : true }, }); if (!item) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, item.family_id)) throw new HttpError( 403 , 'Forbidden' ); if (!canWrite(principal.role)) throw new HttpError( 403 , 'Not allowed' ); const nextTags = Array .from( new Set ([...(item.tags || []), tag])).slice( 0 , 10 ); await prisma.evidence.update({ where : { evidence_id : id }, data : { tags : nextTags }, }); await prisma.custodyLog.create({ data : { evidence_id : id, actor_user_id : principal.principal_id, action : CustodyAction.TAG_UPDATE, reason : null , }, }); return NextResponse.json({ ok : true , tags : nextTags }, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [11] تشغيل المايجريشن (Commands) هذه أوامر التشغيل الأساسية: npm i prisma @prisma/client npx prisma generate npx prisma migrate dev --name init_security_platform [12] ماذا أنجزنا الآن بالضبط؟ الآن النظام أصبح: Evidence Center يعمل عبر PostgreSQL Custody Chain تُسجَّل تلقائيًا عند View / Export / Delete Attempt / Notes / Tags قيود التصدير والحذف مطبقة (Owner فقط) Legal Hold يمنع الحذف Export يستخدم Idempotency (قابل للتطوير لاحقًا) [13] الخطوة التالية الأقوى (المنافسة الحقيقية) الآن بعد تثبيت Evidence، التالي مباشرة هو إنشاء: [13.1] Incidents Center API + UI قائمة الحوادث Timeline (Incident → Evidence → Commands) إظهار الإجراءات التي نفذت تلقائيًا على جهاز الطفل [13.2] Device Commands API واجهة أوامر مؤسسية: /api/devices/[id]/commands (queue) /api/agent/poll للطفل لجلب الأوامر /api/agent/ack لتأكيد التنفيذ [14] Suggested Next Steps [14.1] سأرسل لك في الرسالة القادمة Device Commands API كامل (Poll/Ack + Queue) جاهز لربطه بتطبيق الطفل. [14.2] ثم أبني Incidents Center صفحة كاملة تربط كل شيء بشكل احترافي. [14.3] ثم نضيف Safety Protocols API (Draft/Publish + Versioning + Simulator مرتبط بحوادث حقيقية). إذا تريد أن أكمل فورًا: سأبدأ مباشرة بـ Device Commands API لأنه هو قلب “الدفاع الآلي” الحقيقي.
[134] [1] ## ممتاز — الآن نُكمل “قلب النظام”: Device Commands + Agent Poll/Ack + Pairing Token (Production-Grade) الهدف هنا: تطبيق الطفل Child Agent يكون “عميل تنفيذ” (Enforcement Agent) يستقبل أوامر الدفاع الآلي من السيرفر في Queue، ينفّذ، ثم يرجّع ACK رسمي يُسجَّل في قاعدة البيانات + Audit + Custody عند الحاجة. سنضيف أيضًا Pairing Flow رسمي: الأب يولّد Pairing Code مؤقت تطبيق الطفل يرسل الكود ويستلم Device Token بعدها كل الاتصالات تتم بواسطة Token مخصص للجهاز [Inference] “Zero-latency 0.05s” لا يتحقق بالكامل عبر Cloud لوحده؛ إنما يتحقق عمليًا عبر On-Device models + Local enforcement، بينما السيرفر مسؤول عن السياسات والتوثيق والمزامنة. [2] تحديث Prisma Schema (نسخة كاملة) لإضافة Pairing + Device Token + Agent Events المسار: prisma/schema.prisma هذا إصدار كامل (بديل للملف السابق) مع إضافة 3 موديلات جديدة: PairingCode + DeviceToken + AgentEvent // prisma/schema.prisma generator client { provider = "prisma-client-js" } datasource db { provider = "postgresql" url = env("DATABASE_URL") } /* ========================= Enums ========================= */ enum UserStatus { ACTIVE LOCKED SUSPENDED } enum RoleScope { FAMILY SYSTEM } enum IncidentType { GROOMING BULLYING SEXUAL SELF_HARM TAMPER GEOFENCE } enum Severity { LOW MED HIGH CRITICAL } enum IncidentStatus { OPEN CONTAINED ESCALATED CLOSED } enum ContentType { TEXT IMAGE AUDIO VIDEO } enum EvidenceClassification { NORMAL RESTRICTED LEGAL_HOLD } enum CustodyAction { CREATE VIEW EXPORT HOLD DELETE_ATTEMPT NOTE_UPDATE TAG_UPDATE } enum ProtocolStatus { DRAFT PUBLISHED } enum ActionType { ALERT_SEND EVIDENCE_CREATE APP_KILL APP_BLOCK NET_QUARANTINE MIC_BLOCK CAMERA_BLOCK LOCKSCREEN_BLACKOUT WALKIE_TALKIE_ENABLE LIVE_CAMERA_REQUEST SCREENSHOT_CAPTURE } enum DevicePlatform { ANDROID } enum PairingStatus { PAIRED UNPAIRED REVOKED } enum CommandType { APP_KILL APP_BLOCK NET_QUARANTINE MIC_BLOCK CAMERA_BLOCK LOCKSCREEN_BLACKOUT WALKIE_TALKIE_ENABLE LIVE_CAMERA_REQUEST SCREENSHOT_CAPTURE } enum CommandStatus { QUEUED SENT ACKED FAILED EXPIRED } /* ========================= Tenant / Family ========================= */ model Family { family_id String @id @default(uuid()) owner_user_id String plan String @default("FREE") status String @default("active") created_at DateTime @default(now()) updated_at DateTime @updatedAt owner User @relation("FamilyOwner", fields: [owner_user_id], references: [user_id]) users User[] children Child[] devices Device[] incidents Incident[] evidence Evidence[] roles UserRole[] protocols SafetyProtocol[] audits AuditLog[] pairing PairingCode[] deviceTokens DeviceToken[] @@index([owner_user_id]) } /* ========================= Users / RBAC ========================= */ model User { user_id String @id @default(uuid()) family_id String? email String @unique phone String? password_hash String mfa_enabled Boolean @default(false) status UserStatus @default(ACTIVE) display_name String @default("User") created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family? @relation(fields: [family_id], references: [family_id]) owned_family Family[] @relation("FamilyOwner") roles UserRole[] custody_logs CustodyLog[] deviceCommands DeviceCommand[] audit_logs AuditLog[] @@index([family_id]) } model Role { role_id String @id @default(uuid()) role_key String @unique scope RoleScope created_at DateTime @default(now()) bindings UserRole[] } model UserRole { user_role_id String @id @default(uuid()) user_id String role_id String family_id String? created_at DateTime @default(now()) user User @relation(fields: [user_id], references: [user_id]) role Role @relation(fields: [role_id], references: [role_id]) family Family? @relation(fields: [family_id], references: [family_id]) @@index([user_id]) @@index([role_id]) @@index([family_id]) @@unique([user_id, role_id, family_id]) } /* ========================= Children / Devices ========================= */ model Child { child_id String @id @default(uuid()) family_id String nickname String dob DateTime? created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) devices Device[] incidents Incident[] evidence Evidence[] pairing PairingCode[] @@index([family_id]) } model Device { device_id String @id @default(uuid()) family_id String child_id String platform DevicePlatform @default(ANDROID) model String? os_version String? agent_version String? pairing_status PairingStatus @default(UNPAIRED) last_seen_at DateTime? created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) child Child @relation(fields: [child_id], references: [child_id]) incidents Incident[] evidence Evidence[] commands DeviceCommand[] tokens DeviceToken[] agentEvents AgentEvent[] @@index([family_id]) @@index([child_id]) } /* ========================= Pairing / Device Token ========================= */ model PairingCode { pairing_id String @id @default(uuid()) family_id String child_id String device_id String code_hash String // hash(code + pepper) expires_at DateTime used_at DateTime? created_by_user_id String? created_at DateTime @default(now()) family Family @relation(fields: [family_id], references: [family_id]) child Child @relation(fields: [child_id], references: [child_id]) device Device @relation(fields: [device_id], references: [device_id]) @@index([family_id]) @@index([child_id]) @@index([device_id]) @@index([expires_at]) } model DeviceToken { token_id String @id @default(uuid()) family_id String device_id String token_hash String // hash(token + pepper) last_used_at DateTime? revoked_at DateTime? expires_at DateTime? created_at DateTime @default(now()) family Family @relation(fields: [family_id], references: [family_id]) device Device @relation(fields: [device_id], references: [device_id]) @@index([family_id]) @@index([device_id]) @@index([revoked_at]) } /* ========================= Incidents / Evidence ========================= */ model Incident { incident_id String @id @default(uuid()) family_id String child_id String device_id String incident_type IncidentType severity Severity status IncidentStatus @default(OPEN) created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) child Child @relation(fields: [child_id], references: [child_id]) device Device @relation(fields: [device_id], references: [device_id]) evidence Evidence[] @@index([family_id]) @@index([child_id]) @@index([device_id]) @@index([incident_type, severity]) } model Evidence { evidence_id String @id @default(uuid()) family_id String incident_id String? child_id String device_id String content_type ContentType severity Severity classification EvidenceClassification @default(NORMAL) summary String object_uri String? sha256 String has_preview Boolean @default(true) tags String[] @default([]) notes String? created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) child Child @relation(fields: [child_id], references: [child_id]) device Device @relation(fields: [device_id], references: [device_id]) incident Incident? @relation(fields: [incident_id], references: [incident_id]) custody CustodyLog[] exports EvidenceExport[] @@index([family_id]) @@index([child_id]) @@index([device_id]) @@index([created_at]) @@index([severity, classification]) } model CustodyLog { custody_id String @id @default(uuid()) evidence_id String actor_user_id String? actor_device_id String? action CustodyAction reason String? ip_hash String? device_fingerprint String? created_at DateTime @default(now()) evidence Evidence @relation(fields: [evidence_id], references: [evidence_id]) actor User? @relation(fields: [actor_user_id], references: [user_id]) @@index([evidence_id]) @@index([actor_user_id]) @@index([action]) @@index([created_at]) } model EvidenceExport { export_id String @id @default(uuid()) evidence_id String export_uri String export_sha256 String expires_at DateTime created_at DateTime @default(now()) evidence Evidence @relation(fields: [evidence_id], references: [evidence_id]) @@index([evidence_id]) @@index([expires_at]) } /* ========================= Safety Protocols ========================= */ model SafetyProtocol { protocol_id String @id @default(uuid()) family_id String name String incident_type IncidentType enabled Boolean @default(true) min_severity Severity @default(MED) status ProtocolStatus @default(DRAFT) version Int @default(1) export_allowed Boolean @default(true) delete_allowed Boolean @default(false) screenshot_interval_sec Int @default(0) blackout_message String @default("Device locked. Please contact a parent.") created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) actions ProtocolAction[] @@index([family_id]) @@index([incident_type]) } model ProtocolAction { protocol_action_id String @id @default(uuid()) protocol_id String action ActionType order Int protocol SafetyProtocol @relation(fields: [protocol_id], references: [protocol_id]) @@index([protocol_id]) @@unique([protocol_id, action]) } /* ========================= Device Commands ========================= */ model DeviceCommand { command_id String @id @default(uuid()) family_id String device_id String issued_by_user_id String? type CommandType payload_json Json? status CommandStatus @default(QUEUED) expires_at DateTime? created_at DateTime @default(now()) updated_at DateTime @updatedAt family Family @relation(fields: [family_id], references: [family_id]) device Device @relation(fields: [device_id], references: [device_id]) issuer User? @relation(fields: [issued_by_user_id], references: [user_id]) @@index([family_id]) @@index([device_id]) @@index([status]) } /* ========================= Agent Events (Device telemetry) ========================= */ model AgentEvent { event_id String @id @default(uuid()) family_id String device_id String event_key String event_json Json? created_at DateTime @default(now()) family Family @relation(fields: [family_id], references: [family_id]) device Device @relation(fields: [device_id], references: [device_id]) @@index([family_id]) @@index([device_id]) @@index([created_at]) } /* ========================= Audit Logs ========================= */ model AuditLog { audit_id String @id @default(uuid()) family_id String? actor_user_id String? event_key String event_json Json? created_at DateTime @default(now()) family Family? @relation(fields: [family_id], references: [family_id]) actor User? @relation(fields: [actor_user_id], references: [user_id]) @@index([family_id]) @@index([actor_user_id]) @@index([created_at]) } [3] أدوات التشفير/الهاش للأكواد والتوكنات (PEPPER + SHA256) المسار: lib/crypto.ts نستخدم TOKEN_PEPPER من env لحماية الهاش حتى لو تسرّبت DB. // lib/crypto.ts import crypto from 'crypto'; const PEPPER = process.env.TOKEN_PEPPER || 'CHANGE_ME_NOW'; export function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } export function hashWithPepper(secret: string) { return sha256Hex( ${secret}:${PEPPER} ); } export function randomCodeNumeric(length = 6) { const digits = '0123456789'; let out = ''; for (let i = 0; i < length; i++) { out += digits[Math.floor(Math.random() * digits.length)]; } return out; } export function randomTokenBase64Url(bytes = 32) { const raw = crypto.randomBytes(bytes); return raw .toString('base64') .replaceAll('+', '-') .replaceAll('/', '_') .replaceAll('=', ''); } [4] مصادقة جهاز الطفل عبر Token (Device-Auth) المسار: lib/device-auth.ts // lib/device-auth.ts import { NextRequest } from 'next/server'; import { prisma } from '@/lib/prisma'; import { hashWithPepper } from '@/lib/crypto'; export type DevicePrincipal = { family_id: string; device_id: string; token_id: string; }; export class DeviceAuthError extends Error { status: number; constructor(status: number, message: string) { super(message); this.status = status; } } /** Header: X-Device-Token: <token> Device token stored hashed in DB. */ export async function requireDevicePrincipal(req: NextRequest): Promise <DevicePrincipal> { const token = req.headers.get('x-device-token') || ''; if (!token || token.length < 20) throw new DeviceAuthError(401, 'Missing device token'); const token_hash = hashWithPepper(token); const row = await prisma.deviceToken.findFirst({ where: { token_hash, revoked_at: null, OR: [{ expires_at: null }, { expires_at: { gt: new Date() } }], }, select: { token_id: true, family_id: true, device_id: true, }, }); if (!row) throw new DeviceAuthError(401, 'Invalid or expired device token'); await prisma.deviceToken.update({ where: { token_id: row.token_id }, data: { last_used_at: new Date() }, }); await prisma.device.update({ where: { device_id: row.device_id }, data: { last_seen_at: new Date() }, }); return { family_id: row.family_id, device_id: row.device_id, token_id: row.token_id, }; } [5] Pairing APIs (كود مؤقت → Token دائم للجهاز) [5.1] توليد Pairing Code (من الأب) المسار: app/api/pairing/request-code/route.ts // app/api/pairing/request-code/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError, canWrite } from '@/lib/auth'; import { hashWithPepper, randomCodeNumeric } from '@/lib/crypto'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "child_id": "...", "device_id": "...", "ttl_minutes": 10 } */ export async function POST(req: NextRequest) { try { const principal = getPrincipal(req); if (!canWrite(principal.role)) throw new HttpError(403, 'Not allowed'); const body = await req.json().catch(() => ({})); const child_id = String(body?.child_id || '').trim(); const device_id = String(body?.device_id || '').trim(); const ttl = Math.min(Math.max(parseInt(body?.ttl_minutes || '10', 10), 2), 30); if (!child_id || !device_id) throw new HttpError(400, 'child_id and device_id are required'); const child = await prisma.child.findUnique({ where: { child_id }, select: { child_id: true, family_id: true }, }); if (!child) throw new HttpError(404, 'Child not found'); if (!requireFamilyAccess(principal, child.family_id)) throw new HttpError(403, 'Forbidden'); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, child_id: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (device.family_id !== child.family_id) throw new HttpError(409, 'Device not in same family'); if (device.child_id !== child_id) throw new HttpError(409, 'Device not attached to this child'); const code = randomCodeNumeric(6); const code_hash = hashWithPepper(code); const expires_at = new Date(Date.now() + ttl * 60 * 1000); await prisma.pairingCode.create({ data: { family_id: child.family_id, child_id, device_id, code_hash, expires_at, created_by_user_id: principal.principal_id, }, }); return NextResponse.json( { pairing_code: code, expires_at: expires_at.toISOString(), device_id, child_id, }, { status: 200 } ); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [5.2] Claim Pairing Code (من تطبيق الطفل) → يحصل على Device Token المسار: app/api/pairing/claim/route.ts // app/api/pairing/claim/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { hashWithPepper, randomTokenBase64Url } from '@/lib/crypto'; import { PairingStatus } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "device_id": "...", "pairing_code": "123456" } */ export async function POST(req: NextRequest) { try { const body = await req.json().catch(() => ({})); const device_id = String(body?.device_id || '').trim(); const pairing_code = String(body?.pairing_code || '').trim(); if (!device_id || !pairing_code) { return jsonError(400, 'device_id and pairing_code are required'); } const code_hash = hashWithPepper(pairing_code); const pairing = await prisma.pairingCode.findFirst({ where: { device_id, code_hash, used_at: null, expires_at: { gt: new Date() }, }, select: { pairing_id: true, family_id: true, child_id: true, device_id: true, }, }); if (!pairing) { return jsonError(401, 'Invalid or expired pairing code'); } const token = randomTokenBase64Url(32); const token_hash = hashWithPepper(token); await prisma.$transaction(async (tx) => { await tx.pairingCode.update({ where: { pairing_id: pairing.pairing_id }, data: { used_at: new Date() }, }); await tx.deviceToken.create({ data: { family_id: pairing.family_id, device_id: pairing.device_id, token_hash, expires_at: null, // permanent (you can set rotation policy later) }, }); await tx.device.update({ where: { device_id: pairing.device_id }, data: { pairing_status: PairingStatus.PAIRED, last_seen_at: new Date(), }, }); await tx.auditLog.create({ data: { family_id: pairing.family_id, actor_user_id: null, event_key: 'DEVICE_PAIRED', event_json: { device_id: pairing.device_id, child_id: pairing.child_id, }, }, }); }); return NextResponse.json( { device_token: token, family_id: pairing.family_id, device_id: pairing.device_id, child_id: pairing.child_id, }, { status: 200 } ); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [6] Device Commands API (للأب/الأم وفق الصلاحيات) [6.1] إصدار أمر للجهاز (Queue Command) المسار: app/api/devices/[deviceId]/commands/route.ts // app/api/devices/[deviceId]/commands/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError, canWrite } from '@/lib/auth'; import { CommandStatus, CommandType } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "type": "NET_QUARANTINE", "payload": { ... }, "ttl_sec": 60 } */ export async function POST(req: NextRequest, ctx: { params: { deviceId: string } }) { try { const principal = getPrincipal(req); if (!canWrite(principal.role)) throw new HttpError(403, 'Not allowed'); const deviceId = ctx.params.deviceId; const body = await req.json().catch(() => ({})); const type = String(body?.type || '').trim().toUpperCase() as CommandType; const payload = body?.payload ?? {}; const ttl_sec = Math.min(Math.max(parseInt(body?.ttl_sec || '60', 10), 10), 600); if (!type) throw new HttpError(400, 'Command type required'); const device = await prisma.device.findUnique({ where: { device_id: deviceId }, select: { device_id: true, family_id: true, pairing_status: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (!requireFamilyAccess(principal, device.family_id)) throw new HttpError(403, 'Forbidden'); const expires_at = new Date(Date.now() + ttl_sec * 1000); const cmd = await prisma.deviceCommand.create({ data: { family_id: device.family_id, device_id: device.device_id, issued_by_user_id: principal.principal_id, type, payload_json: payload, status: CommandStatus.QUEUED, expires_at, }, select: { command_id: true, type: true, status: true, expires_at: true, created_at: true, }, }); await prisma.auditLog.create({ data: { family_id: device.family_id, actor_user_id: principal.principal_id, event_key: 'DEVICE_COMMAND_ISSUED', event_json: { device_id: device.device_id, command_id: cmd.command_id, type, }, }, }); return NextResponse.json({ ok: true, command: cmd }, { status: 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } /** GET commands history (optional) /api/devices/:id/commands?status=QUEUED&limit=30 */ export async function GET(req: NextRequest, ctx: { params: { deviceId: string } }) { try { const principal = getPrincipal(req); const deviceId = ctx.params.deviceId; const device = await prisma.device.findUnique({ where: { device_id: deviceId }, select: { device_id: true, family_id: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (!requireFamilyAccess(principal, device.family_id)) throw new HttpError(403, 'Forbidden'); const { searchParams } = new URL(req.url); const status = searchParams.get('status')?.toUpperCase(); const limit = Math.min(Math.max(parseInt(searchParams.get('limit') || '30', 10), 5), 80); const items = await prisma.deviceCommand.findMany({ where: { device_id: deviceId, ...(status ? { status: status as any } : {}), }, orderBy: { created_at: 'desc' }, take: limit, select: { command_id: true, type: true, status: true, payload_json: true, created_at: true, updated_at: true, expires_at: true, }, }); return NextResponse.json({ items }, { status: 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [7] Agent Poll API (تطبيق الطفل يسحب أوامر Queue) [7.1] Poll: جلب أوامر QUEUED غير منتهية المسار: app/api/agent/poll/route.ts // app/api/agent/poll/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { requireDevicePrincipal, DeviceAuthError } from '@/lib/device-auth'; import { CommandStatus } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** Device sends: Header: X-Device-Token GET -> returns up to N commands */ export async function GET(req: NextRequest) { try { const devicePrincipal = await requireDevicePrincipal(req); const { searchParams } = new URL(req.url); const limit = Math.min(Math.max(parseInt(searchParams.get('limit') || '5', 10), 1), 10); // Pick only queued, not expired const now = new Date(); const commands = await prisma.deviceCommand.findMany({ where: { device_id: devicePrincipal.device_id, status: CommandStatus.QUEUED, OR: [{ expires_at: null }, { expires_at: { gt: now } }], }, orderBy: { created_at: 'asc' }, take: limit, select: { command_id: true, type: true, payload_json: true, expires_at: true, created_at: true, }, }); // Mark as SENT to avoid duplicate delivery storms if (commands.length > 0) { await prisma.deviceCommand.updateMany({ where: { command_id: { in: commands.map((c) => c.command_id) } }, data: { status: CommandStatus.SENT }, }); } await prisma.agentEvent.create({ data: { family_id: devicePrincipal.family_id, device_id: devicePrincipal.device_id, event_key: 'AGENT_POLL', event_json: { delivered_count: commands.length, }, }, }); return NextResponse.json({ commands }, { status: 200 }); } catch (e: any) { if (e instanceof DeviceAuthError) return jsonError(e.status, e.message); return jsonError(500, e?.message ?? 'Unexpected error'); } } [8] Agent ACK API (تأكيد تنفيذ الأمر + تحديث الحالة) المسار: app/api/agent/ack/route.ts // app/api/agent/ack/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { requireDevicePrincipal, DeviceAuthError } from '@/lib/device-auth'; import { CommandStatus } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "command_id": "...", "ok": true, "result": { ...optional... } } */ export async function POST(req: NextRequest) { try { const devicePrincipal = await requireDevicePrincipal(req); const body = await req.json().catch(() => ({})); const command_id = String(body?.command_id || '').trim(); const ok = Boolean(body?.ok); const result = body?.result ?? {}; if (!command_id) return jsonError(400, 'command_id is required'); const cmd = await prisma.deviceCommand.findFirst({ where: { command_id, device_id: devicePrincipal.device_id, }, select: { command_id: true, family_id: true, status: true, type: true, }, }); if (!cmd) return jsonError(404, 'Command not found'); await prisma.deviceCommand.update({ where: { command_id }, data: { status: ok ? CommandStatus.ACKED : CommandStatus.FAILED, }, }); await prisma.agentEvent.create({ data: { family_id: devicePrincipal.family_id, device_id: devicePrincipal.device_id, event_key: 'AGENT_ACK', event_json: { command_id, type: cmd.type, ok, result, }, }, }); await prisma.auditLog.create({ data: { family_id: devicePrincipal.family_id, actor_user_id: null, event_key: ok ? 'DEVICE_COMMAND_ACKED' : 'DEVICE_COMMAND_FAILED', event_json: { device_id: devicePrincipal.device_id, command_id, type: cmd.type, }, }, }); return NextResponse.json({ ok: true }, { status: 200 }); } catch (e: any) { if (e instanceof DeviceAuthError) return jsonError(e.status, e.message); return jsonError(500, e?.message ?? 'Unexpected error'); } } [9] Agent Heartbeat API (معلومات الجهاز + Online Status) المسار: app/api/agent/heartbeat/route.ts // app/api/agent/heartbeat/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { requireDevicePrincipal, DeviceAuthError } from '@/lib/device-auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "agent_version": "1.2.0", "os_version": "14", "model": "SM-S928B", "battery": 78, "network": "wifi", "location": { "lat": 25.2, "lng": 51.5, "acc": 12 } } */ export async function POST(req: NextRequest) { try { const devicePrincipal = await requireDevicePrincipal(req); const body = await req.json().catch(() => ({})); const agent_version = String(body?.agent_version || '').slice(0, 20); const os_version = String(body?.os_version || '').slice(0, 20); const model = String(body?.model || '').slice(0, 60); const battery = typeof body?.battery === 'number' ? body.battery : null; const network = String(body?.network || '').slice(0, 20); const location = body?.location ?? null; await prisma.device.update({ where: { device_id: devicePrincipal.device_id }, data: { agent_version: agent_version || undefined, os_version: os_version || undefined, model: model || undefined, last_seen_at: new Date(), }, }); await prisma.agentEvent.create({ data: { family_id: devicePrincipal.family_id, device_id: devicePrincipal.device_id, event_key: 'AGENT_HEARTBEAT', event_json: { battery, network, location, }, }, }); return NextResponse.json({ ok: true }, { status: 200 }); } catch (e: any) { if (e instanceof DeviceAuthError) return jsonError(e.status, e.message); return jsonError(500, e?.message ?? 'Unexpected error'); } } [10] تشغيل المايجريشن (Migration) أوامر التشغيل: npm i prisma @prisma/client npx prisma generate npx prisma migrate dev --name add_pairing_device_tokens_agent_events [11] كيف تربط هذا مع تطبيق الطفل (المنطق العملي) Child Agent Flow: Pairing مرة واحدة: يرسل /api/pairing/claim ويحصل على device_token يخزّن token في EncryptedSharedPreferences Loop تشغيل دائم: Heartbeat كل 20–40 ثانية Poll كل 0.5–2 ثانية (حسب وضع الجهاز) تنفيذ الأوامر فورًا Ack لكل أمر [Inference] في الواقع الأفضل Poll يكون “Long Polling / WebSocket / FCM Push” بدل ضغط HTTP عالي. [12] ماذا بقي حتى يصبح دفاع آلي كامل؟ الآن لدينا: Pairing رسمي + Token Queue أوامر + Poll/Ack Telemetry + Heartbeat Audit رسمي الخطوة القادمة لتصبح Bark++ فعليًا هي: [12.1] Safety Protocol Engine عند إنشاء Incident: النظام يبحث عن Protocol مناسب (حسب نوع الحادثة + Severity) يكوّن قائمة أوامر Actions يرسلها تلقائيًا للجهاز + يسجل Timeline [12.2] Incidents Center UI صفحة واحدة تعرض: الحادثة الأدلة المرتبطة الأوامر التي أُرسلت ACKs مسار الحماية الذي تم تفعيله [13] Suggested Next Steps [13.1] سأكتب لك الآن Safety Protocol Engine API كامل: POST /api/incidents/create → يولّد Incident + Evidence + Commands تلقائيًا [13.2] ثم أبني Incidents Center UI احترافي (Timeline + Filters). [13.3] ثم نضيف “Break-Glass” مؤسسي + سياسات Support لا ترى الأدلة. إذا تريد استمرار مباشر: سأبدأ فورًا بالجزء الأقوى التالي وهو Incident → Protocol → Auto-Defense Pipeline (المنطق الذي ينفذ “إغلاق التطبيق + حجر الإنترنت + Lock Screen” تلقائيًا).
[135] [1] ## ممتاز — الآن نبني “Auto-Defense Pipeline” الحقيقي: Incident → Evidence → Protocol → Commands (كل شيء تلقائي) الآن سنضيف أهم جزء في المنصة، وهو الذي يجعل النظام مستقل وذكي بالفعل: Agent (تطبيق الطفل) يبلّغ عن حادثة (Incident Report) السيرفر ينشئ تلقائيًا: Incident Evidence + CustodyLog(Create) السيرفر يختار Safety Protocol مناسب (Published + Enabled + Severity Threshold) يرسل Device Commands إلى Queue فورًا (مثل: Kill App / Quarantine / Blackout…) يسجل كل شيء في AuditLog + Timeline جاهز للعرض في لوحة الوالدين [2] ملف Policy Engine كامل (اختيار البروتوكول + تحويل Actions إلى Commands) المسار: lib/policy-engine.ts // lib/policy-engine.ts import { prisma } from '@/lib/prisma'; import { ActionType, CommandType, IncidentType, Severity, ProtocolStatus, CommandStatus, } from '@prisma/client'; export type PolicyDecision = { protocol_id: string | null; actions: { action: ActionType; order: number }[]; commands: { type: CommandType; payload: any }[]; }; function severityRank(s: Severity): number { switch (s) { case 'LOW': return 1; case 'MED': return 2; case 'HIGH': return 3; case 'CRITICAL': return 4; default: return 0; } } function actionToCommand(action: ActionType, ctx: { blackout_message?: string }) { // تحويل ActionType إلى CommandType (يمكن توسيعه لاحقًا) switch (action) { case 'APP_KILL': return { type: CommandType.APP_KILL, payload: {} }; code Code download content_copy expand_less case 'APP_BLOCK' : return { type : CommandType.APP_BLOCK, payload: {} }; case 'NET_QUARANTINE' : return { type : CommandType.NET_QUARANTINE, payload: { mode: 'deny_all_except_amanah' } }; case 'MIC_BLOCK' : return { type : CommandType.MIC_BLOCK, payload: { enabled: true } }; case 'CAMERA_BLOCK' : return { type : CommandType.CAMERA_BLOCK, payload: { enabled: true } }; case 'LOCKSCREEN_BLACKOUT' : return { type : CommandType.LOCKSCREEN_BLACKOUT, payload: { enabled: true , message: ctx.blackout_message || 'Device locked. Please contact a parent.' , }, }; case 'WALKIE_TALKIE_ENABLE' : return { type : CommandType.WALKIE_TALKIE_ENABLE, payload: { enabled: true } }; case 'LIVE_CAMERA_REQUEST' : return { type : CommandType.LIVE_CAMERA_REQUEST, payload: { mode: 'on_demand' } }; case 'SCREENSHOT_CAPTURE' : return { type : CommandType.SCREENSHOT_CAPTURE, payload: { reason: 'incident_protocol' } }; // ALERT_SEND و EVIDENCE_CREATE يتمان في السيرفر نفسه وليس كأمر للجهاز case 'ALERT_SEND' : case 'EVIDENCE_CREATE' : default : return null; } } export async function decidePolicy(params: { family_id: string; incident_type: IncidentType; severity: Severity; }): Promise <PolicyDecision> { const { family_id, incident_type, severity } = params; const protocols = await prisma.safetyProtocol.findMany({ where: { family_id, incident_type, enabled: true, status: ProtocolStatus.PUBLISHED, }, select: { protocol_id: true, min_severity: true, blackout_message: true, actions: { select: { action: true, order: true, }, orderBy: { order: 'asc' }, }, }, orderBy: { updated_at: 'desc' }, take: 30, }); // اختر بروتوكول يطابق threshold: severity >= min_severity const eligible = protocols.filter((p) => severityRank(severity) >= severityRank(p.min_severity)); if (eligible.length === 0) { return { protocol_id: null, actions: [], commands: [] }; } // أفضلية: أعلى min_severity أولًا (الأكثر تخصصًا) eligible.sort((a, b) => severityRank(b.min_severity) - severityRank(a.min_severity)); const chosen = eligible[0]; const actions = chosen.actions.map((x) => ({ action: x.action, order: x.order })); const commands: { type: CommandType; payload: any }[] = []; for (const a of actions) { const mapped = actionToCommand(a.action, { blackout_message: chosen.blackout_message }); if (mapped) commands.push(mapped); } return { protocol_id: chosen.protocol_id, actions, commands, }; } export async function enqueueCommands(params: { family_id: string; device_id: string; issued_by_user_id?: string | null; // null لو السيرفر/الوكيل commands: { type: CommandType; payload: any }[]; ttl_sec?: number; }) { const { family_id, device_id, issued_by_user_id, commands, ttl_sec } = params; const ttl = Math.min(Math.max(ttl_sec || 60, 10), 600); const expires_at = new Date(Date.now() + ttl * 1000); if (commands.length === 0) return []; const created = await prisma.$transaction( commands.map((c) => prisma.deviceCommand.create({ data: { family_id, device_id, issued_by_user_id: issued_by_user_id ?? null, type: c.type, payload_json: c.payload, status: CommandStatus.QUEUED, expires_at, }, select: { command_id: true, type: true, status: true, created_at: true, expires_at: true, }, }) ) ); return created; } [3] Agent Incident Report API (الأهم): إنشاء Incident + Evidence + تشغيل البروتوكول تلقائيًا المسار: app/api/agent/report-incident/route.ts تطبيق الطفل يرسل تقرير حادثة، والسيرفر يطبق الدفاع فورًا. // app/api/agent/report-incident/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { requireDevicePrincipal, DeviceAuthError } from '@/lib/device-auth'; import { decidePolicy, enqueueCommands } from '@/lib/policy-engine'; import { IncidentType, Severity, ContentType, CustodyAction, } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function cleanEnum(input: string) { return String(input || '').trim().toUpperCase(); } /** POST body: { "incident_type": "GROOMING", "severity": "CRITICAL", "content_type": "TEXT", "summary": "Suspicious sexual message with coercion", "object_uri": "s3://...optional", "sha256": "....", "tags": ["snapchat","threat"], "app_package": "com.whatsapp" (optional) } */ export async function POST(req: NextRequest) { try { const devicePrincipal = await requireDevicePrincipal(req); const body = await req.json().catch(() => ({})); const incident_type = cleanEnum(body?.incident_type) as IncidentType; const severity = cleanEnum(body?.severity) as Severity; const content_type = cleanEnum(body?.content_type) as ContentType; const summary = String(body?.summary || '').trim().slice(0, 400); const object_uri = body?.object_uri ? String(body.object_uri).slice(0, 500) : null; const sha256 = String(body?.sha256 || '').trim().slice(0, 64); const tags = Array.isArray(body?.tags) ? body.tags.slice(0, 10).map((x: any) => String(x).trim().toLowerCase()) : []; const app_package = body?.app_package ? String(body.app_package).slice(0, 120) : null; if (!summary || summary.length < 10) return jsonError(400, 'summary required (min 10 chars)'); if (!sha256 || sha256.length < 16) return jsonError(400, 'sha256 required'); // تحميل device لمعرفة child_id + family_id الموثق const device = await prisma.device.findUnique({ where: { device_id: devicePrincipal.device_id }, select: { device_id: true, family_id: true, child_id: true, }, }); if (!device) return jsonError(404, 'Device not found'); // 1) Create Incident + Evidence + Custody(Create) atomically const created = await prisma.$transaction(async (tx) => { const incident = await tx.incident.create({ data: { family_id: device.family_id, child_id: device.child_id, device_id: device.device_id, incident_type, severity, }, select: { incident_id: true, family_id: true, child_id: true, device_id: true, incident_type: true, severity: true, created_at: true, }, }); const evidence = await tx.evidence.create({ data: { family_id: device.family_id, incident_id: incident.incident_id, child_id: device.child_id, device_id: device.device_id, content_type, severity, summary, object_uri, sha256, tags, notes: app_package ? app_package:${app_package} : null, }, select: { evidence_id: true, created_at: true, classification: true, }, }); await tx.custodyLog.create({ data: { evidence_id: evidence.evidence_id, actor_user_id: null, actor_device_id: device.device_id, action: CustodyAction.CREATE, reason: 'agent_report_incident', }, }); await tx.auditLog.create({ data: { family_id: device.family_id, actor_user_id: null, event_key: 'INCIDENT_REPORTED_BY_AGENT', event_json: { incident_id: incident.incident_id, evidence_id: evidence.evidence_id, device_id: device.device_id, incident_type, severity, }, }, }); return { incident, evidence }; }); // 2) Decide policy + enqueue commands const decision = await decidePolicy({ family_id: device.family_id, incident_type, severity, }); const commands = await enqueueCommands({ family_id: device.family_id, device_id: device.device_id, issued_by_user_id: null, commands: decision.commands.map((c) => { // تخصيص payload في بعض الحالات if (c.type === 'APP_KILL' || c.type === 'APP_BLOCK') { return { type: c.type, payload: { ...c.payload, app_package: app_package || undefined, }, }; } return c; }), ttl_sec: 90, }); await prisma.auditLog.create({ data: { family_id: device.family_id, actor_user_id: null, event_key: 'AUTO_DEFENSE_TRIGGERED', event_json: { incident_id: created.incident.incident_id, protocol_id: decision.protocol_id, actions: decision.actions, commands_count: commands.length, }, }, }); return NextResponse.json( { ok: true, incident: created.incident, evidence: created.evidence, protocol_id: decision.protocol_id, commands, }, { status: 200 } ); } catch (e: any) { if (e instanceof DeviceAuthError) return jsonError(e.status, e.message); return jsonError(500, e?.message ?? 'Unexpected error'); } } [4] Incidents API للوالدين: قائمة + فلاتر + Pagination المسار: app/api/incidents/route.ts // app/api/incidents/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest) { try { const principal = getPrincipal(req); const { searchParams } = new URL(req.url); code Code download content_copy expand_less const family_id = searchParams. get ( 'family_id' ) || principal.family_id; if (!requireFamilyAccess(principal, family_id)) throw new HttpError( 403 , 'Forbidden' ); const child_id = searchParams. get ( 'child_id' ); const device_id = searchParams. get ( 'device_id' ); const severity = searchParams. get ( 'severity' )?.toUpperCase(); const status = searchParams. get ( 'status' )?.toUpperCase(); const cursor = searchParams. get ( 'cursor' ); const limit = Math.min(Math.max(parseInt(searchParams. get ( 'limit' ) || '25' , 10 ), 5 ), 60 ); const where : any = { family_id }; if (child_id) where .child_id = child_id; if (device_id) where .device_id = device_id; if (severity) where .severity = severity; if (status) where .status = status; const items = await prisma.incident.findMany({ where , orderBy: { created_at: 'desc' }, take: limit + 1 , ...(cursor ? { skip: 1 , cursor: { incident_id: cursor }, } : {}), select: { incident_id: true , child_id: true , device_id: true , incident_type: true , severity: true , status: true , created_at: true , updated_at: true , evidence: { select: { evidence_id: true , content_type: true , summary: true , created_at: true , }, orderBy: { created_at: 'desc' }, take: 1 , }, }, }); const hasMore = items.length > limit; const page = hasMore ? items.slice( 0 , limit) : items; const next_cursor = hasMore ? page[page.length - 1 ]?.incident_id ?? null : null ; return NextResponse.json({ items: page, next_cursor }, { status: 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [5] Incident Timeline API: يجمع Evidence + Commands + Agent Events + Audit المسار: app/api/incidents/[id]/timeline/route.ts // app/api/incidents/[id]/timeline/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const incident = await prisma.incident.findUnique({ where : { incident_id }, select : { incident_id : true , family_id : true , child_id : true , device_id : true , incident_type : true , severity : true , status : true , created_at : true , }, }); if (!incident) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, incident.family_id)) throw new HttpError( 403 , 'Forbidden' ); const evidence = await prisma.evidence.findMany({ where : { incident_id }, orderBy : { created_at : 'asc' }, select : { evidence_id : true , content_type : true , severity : true , classification : true , summary : true , object_uri : true , sha256 : true , tags : true , created_at : true , }, }); const commands = await prisma.deviceCommand.findMany({ where : { device_id : incident.device_id, created_at : { gte : new Date (incident.created_at.getTime() - 60 * 1000 ) }, }, orderBy : { created_at : 'asc' }, take : 120 , select : { command_id : true , type : true , status : true , payload_json : true , created_at : true , updated_at : true , expires_at : true , }, }); const agentEvents = await prisma.agentEvent.findMany({ where : { device_id : incident.device_id, created_at : { gte : new Date (incident.created_at.getTime() - 60 * 1000 ) }, }, orderBy : { created_at : 'asc' }, take : 200 , select : { event_id : true , event_key : true , event_json : true , created_at : true , }, }); const audits = await prisma.auditLog.findMany({ where : { family_id : incident.family_id, created_at : { gte : new Date (incident.created_at.getTime() - 60 * 1000 ) }, }, orderBy : { created_at : 'asc' }, take : 200 , select : { audit_id : true , event_key : true , event_json : true , created_at : true , }, }); // Timeline موحد للعرض في UI const timeline = [ ...evidence.map( ( x ) => ({ t : x.created_at, kind : 'EVIDENCE' , data : x, })), ...commands.map( ( x ) => ({ t : x.created_at, kind : 'COMMAND' , data : x, })), ...agentEvents.map( ( x ) => ({ t : x.created_at, kind : 'AGENT_EVENT' , data : x, })), ...audits.map( ( x ) => ({ t : x.created_at, kind : 'AUDIT' , data : x, })), ].sort( ( a, b ) => a.t.getTime() - b.t.getTime()); return NextResponse.json( { incident, evidence, commands, agentEvents, audits, timeline, }, { status : 200 } ); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [6] Protocol Management APIs (إنشاء + Publish) — لكي يتحكم الأب بالبروتوكولات [6.1] Create/Update Protocol + Actions المسار: app/api/protocols/route.ts // app/api/protocols/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError, canWrite } from '@/lib/auth'; import { IncidentType, Severity, ProtocolStatus, ActionType } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "name": "Critical Grooming Lockdown", "incident_type": "GROOMING", "min_severity": "HIGH", "enabled": true, "blackout_message": "...", "actions": [ code Code download content_copy expand_less { "action" : "APP_KILL" , "order" : 1 }, code Code download content_copy expand_less { "action" : "NET_QUARANTINE" , "order" : 2 }, code Code download content_copy expand_less { "action" : "LOCKSCREEN_BLACKOUT" , "order" : 3 } ] } */ export async function POST(req: NextRequest) { try { const principal = getPrincipal(req); if (!canWrite(principal.role)) throw new HttpError(403, 'Not allowed'); const body = await req.json().catch(() => ({})); const family_id = principal.family_id; if (!requireFamilyAccess(principal, family_id)) throw new HttpError(403, 'Forbidden'); const name = String(body?.name || '').trim().slice(0, 80); const incident_type = String(body?.incident_type || '').trim().toUpperCase() as IncidentType; const min_severity = String(body?.min_severity || '').trim().toUpperCase() as Severity; const enabled = body?.enabled === false ? false : true; const blackout_message = String(body?.blackout_message || 'Device locked. Please contact a parent.').slice(0, 140); const actions = Array.isArray(body?.actions) ? body.actions : []; if (!name) throw new HttpError(400, 'name required'); if (!incident_type) throw new HttpError(400, 'incident_type required'); if (!min_severity) throw new HttpError(400, 'min_severity required'); if (actions.length < 1) throw new HttpError(400, 'actions required'); // تنظيف وترتيب actions const cleaned = actions .map((x: any) => ({ action: String(x?.action || '').trim().toUpperCase() as ActionType, order: Number(x?.order || 0), })) .filter((x: any) => x.action && x.order > 0) .sort((a: any, b: any) => a.order - b.order) .slice(0, 12); if (cleaned.length < 1) throw new HttpError(400, 'Invalid actions'); const protocol = await prisma.$transaction(async (tx) => { const p = await tx.safetyProtocol.create({ data: { family_id, name, incident_type, min_severity, enabled, status: ProtocolStatus.DRAFT, version: 1, blackout_message, }, select: { protocol_id: true, name: true, status: true }, }); await tx.protocolAction.createMany({ data: cleaned.map((a: any) => ({ protocol_id: p.protocol_id, action: a.action, order: a.order, })), }); await tx.auditLog.create({ data: { family_id, actor_user_id: principal.principal_id, event_key: 'PROTOCOL_CREATED', event_json: { protocol_id: p.protocol_id, name, incident_type, min_severity, }, }, }); return p; }); return NextResponse.json({ ok: true, protocol }, { status: 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } /** GET protocols list */ export async function GET(req: NextRequest) { try { const principal = getPrincipal(req); const family_id = principal.family_id; if (!requireFamilyAccess(principal, family_id)) throw new HttpError(403, 'Forbidden'); const items = await prisma.safetyProtocol.findMany({ where: { family_id }, orderBy: { updated_at: 'desc' }, take: 50, select: { protocol_id: true, name: true, incident_type: true, min_severity: true, enabled: true, status: true, version: true, updated_at: true, actions: { select: { action: true, order: true }, orderBy: { order: 'asc' }, }, }, }); return NextResponse.json({ items }, { status: 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [6.2] Publish Protocol (DRAFT → PUBLISHED) المسار: app/api/protocols/[id]/publish/route.ts // app/api/protocols/[id]/publish/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError, canWrite } from '@/lib/auth'; import { ProtocolStatus } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); if (!canWrite(principal.role)) throw new HttpError(403, 'Not allowed'); code Code download content_copy expand_less const protocol_id = ctx.params.id; const protocol = await prisma.safetyProtocol.findUnique({ where : { protocol_id }, select : { protocol_id : true , family_id : true , status : true , version : true }, }); if (!protocol) throw new HttpError( 404 , 'Protocol not found' ); if (!requireFamilyAccess(principal, protocol.family_id)) throw new HttpError( 403 , 'Forbidden' ); const updated = await prisma.safetyProtocol.update({ where : { protocol_id }, data : { status : ProtocolStatus.PUBLISHED, version : protocol.version + 1 , }, select : { protocol_id : true , status : true , version : true }, }); await prisma.auditLog.create({ data : { family_id : protocol.family_id, actor_user_id : principal.principal_id, event_key : 'PROTOCOL_PUBLISHED' , event_json : { protocol_id, version : updated.version }, }, }); return NextResponse.json({ ok : true , protocol : updated }, { status : 200 }); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [7] النتيجة الآن: النظام أصبح “يشبه Bark” لكن أقوى (بروتوكولات قابلة للبرمجة) الآن حصلت على: Incident يطلع من Child Agent خلال ثوانٍ Evidence يتوثق + Custody(Create) Protocol Engine يقرر الإجراء Commands تتصف في Queue فورًا Agent Poll/Ack ينفذ ويؤكد Timeline جاهز لواجهة “مخزن الأدلة” و “مركز الحوادث” [8] الخطوة التالية التي تساوي “الذكاء الحقيقي” (On-Device Real-Time) هذه الخطوة تجعل “0.05 ثانية” واقعية عمليًا: [8.1] Local Detection + Local Enforcement على جهاز الطفل: نموذج كشف نصوص وصور محلي تنفيذ فوري (Kill/Block) قبل انتظار السيرفر بعدها رفع Incident للسيرفر للتوثيق والمزامنة [8.2] Action Simulator للوالد ميزة عالمية قوية: الأب يختار “Incident Type + Severity” يرى Preview للأوامر التي ستُنفّذ قبل اعتماد البروتوكول [9] Suggested Next Steps [9.1] سأكمل مباشرة بإنشاء Incidents Center UI (Timeline View) في Next.js: جدول الحوادث فتح حادثة → Evidence Vault + Commands + ACKs [9.2] ثم أضيف Action Simulator للبروتوكولات (ميزة تنافسية قوية جدًا). [9.3] ثم نبدأ Child Agent Kotlin تنفيذ أوامر NET_QUARANTINE/BLACKOUT فعليًا. إذا تريد أن أكمل الآن فورًا: سأبدأ بـ Incidents Center UI كاملة لأن كل الـ APIs أصبحت جاهزة.
[136] [1] ## ممتاز — الآن نبني لوحة الوالدين UI كاملة (Incidents Center + Incident Timeline + Protocol Simulator) سأكمل مباشرة بتنفيذ الواجهة الأمامية Next.js App Router بحيث تكون جاهزة للاستخدام على الهاتف + سطح المكتب، وتشبه منصات الشركات العالمية: صفحة Incidents Center: قائمة الحوادث + فلاتر + بحث + تفاصيل سريعة صفحة Incident Details: Timeline موحد (Evidence + Commands + ACK + Audit) صفحة Protocols: عرض البروتوكولات + نشر البروتوكول صفحة Protocol Simulator: محاكاة حادثة ورؤية الأوامر المتوقعة قبل الاعتماد ملاحظة مهمة: سأكتب ملفات كاملة “جاهزة للنسخ” بدون أي أجزاء ناقصة. [2] ملف 1: عميل API (Frontend Fetch Wrapper) المسار: lib/api-client.ts // lib/api-client.ts export type ApiErrorShape = { error?: { status?: number; message?: string; }; }; export async function apiJson <T> ( url: string, options?: RequestInit & { json?: any } ): Promise <T> { const headers: Record<string, string> = { 'Content-Type': 'application/json', ...(options?.headers as any), }; const res = await fetch(url, { ...options, headers, body: options?.json ? JSON.stringify(options.json) : options?.body, cache: 'no-store', }); const text = await res.text().catch(() => ''); let data: any = {}; try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; } if (!res.ok) { const msg = (data as ApiErrorShape)?.error?.message || Request failed: ${res.status} ; const err = new Error(msg) as any; err.status = (data as ApiErrorShape)?.error?.status || res.status; err.payload = data; throw err; } return data as T; } [3] ملف 2: أدوات تنسيق زمنية وواجهة صغيرة للألوان المسار: lib/ui.ts // lib/ui.ts export function fmtDateTime(iso: string | Date) { const d = typeof iso === 'string' ? new Date(iso) : iso; return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', }); } export function severityBadge(sev: string) { const s = String(sev || '').toUpperCase(); if (s === 'CRITICAL') return 'bg-red-100 text-red-700 border-red-200'; if (s === 'HIGH') return 'bg-orange-100 text-orange-700 border-orange-200'; if (s === 'MED') return 'bg-yellow-100 text-yellow-800 border-yellow-200'; return 'bg-gray-100 text-gray-700 border-gray-200'; } export function statusBadge(st: string) { const s = String(st || '').toUpperCase(); if (s === 'OPEN') return 'bg-blue-100 text-blue-700 border-blue-200'; if (s === 'CONTAINED') return 'bg-emerald-100 text-emerald-700 border-emerald-200'; if (s === 'ESCALATED') return 'bg-purple-100 text-purple-700 border-purple-200'; if (s === 'CLOSED') return 'bg-gray-100 text-gray-700 border-gray-200'; return 'bg-gray-100 text-gray-700 border-gray-200'; } export function eventKindBadge(kind: string) { const k = String(kind || '').toUpperCase(); if (k === 'EVIDENCE') return 'bg-indigo-50 text-indigo-700 border-indigo-100'; if (k === 'COMMAND') return 'bg-amber-50 text-amber-700 border-amber-100'; if (k === 'AGENT_EVENT') return 'bg-cyan-50 text-cyan-700 border-cyan-100'; if (k === 'AUDIT') return 'bg-slate-50 text-slate-700 border-slate-100'; return 'bg-gray-50 text-gray-700 border-gray-100'; } [4] ملف 3: مكوّن واجهة عام (Card + Pill) المسار: components/ui-kit.tsx // components/ui-kit.tsx 'use client'; import React from 'react'; export function Card({ title, subtitle, right, children, }: { title?: string; subtitle?: string; right?: React.ReactNode; children: React.ReactNode; }) { return ( <div className="rounded-2xl border border-gray-200 bg-white shadow-sm"> {(title || subtitle || right) && ( <div className="flex items-start justify-between gap-3 border-b border-gray-100 px-4 py-3"> <div className="min-w-0"> {title && <div className="text-sm font-semibold text-gray-900"> {title} </div> } {subtitle && <div className="mt-0.5 text-xs text-gray-600"> {subtitle} </div> } </div> {right && <div className="shrink-0"> {right} </div> } </div> )} <div className="px-4 py-3"> {children} </div> </div> ); } export function Pill({ text, className = '', }: { text: string; className?: string; }) { return ( <span className={ inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-medium ${className} } > {text} </span> ); } export function EmptyState({ title, desc, action, }: { title: string; desc?: string; action?: React.ReactNode; }) { return ( <div className="rounded-2xl border border-dashed border-gray-300 bg-white px-4 py-8 text-center"> <div className="text-sm font-semibold text-gray-900"> {title} </div> {desc && <div className="mt-1 text-xs text-gray-600"> {desc} </div> } {action && <div className="mt-4 flex justify-center"> {action} </div> } </div> ); } [5] ملف 4: صفحة Incidents Center (Dashboard) المسار: app/dashboard/incidents/page.tsx تعتمد على API: /api/incidents?limit=...&severity=...&status=... // app/dashboard/incidents/page.tsx 'use client'; import Link from 'next/link'; import { useEffect, useMemo, useState } from 'react'; import { apiJson } from '@/lib/api-client'; import { fmtDateTime, severityBadge, statusBadge } from '@/lib/ui'; import { Card, EmptyState, Pill } from '@/components/ui-kit'; import { Search, Filter, RefreshCw, ChevronRight } from 'lucide-react'; type IncidentRow = { incident_id: string; child_id: string; device_id: string; incident_type: string; severity: string; status: string; created_at: string; updated_at: string; evidence?: Array<{ evidence_id: string; content_type: string; summary: string; created_at: string; }>; }; export default function IncidentsPage() { const [items, setItems] = useState<IncidentRow[]>([]); const [nextCursor, setNextCursor] = useState<string | null>(null); const [loading, setLoading] = useState(false); const [q, setQ] = useState(''); const [severity, setSeverity] = useState(''); const [status, setStatus] = useState(''); async function load(reset = false) { setLoading(true); try { const params = new URLSearchParams(); params.set('limit', '25'); if (!reset && nextCursor) params.set('cursor', nextCursor); if (severity) params.set('severity', severity); if (status) params.set('status', status); code Code download content_copy expand_less const data = await apiJson<{ items : IncidentRow[]; next_cursor: string | null }>( `/api/incidents? ${params.toString()} ` ); if (reset) { setItems(data.items); } else { setItems( ( prev ) => [...prev, ...data.items]); } setNextCursor(data.next_cursor); } finally { setLoading( false ); } } useEffect(() => { load(true); // eslint-disable-next-line react-hooks/exhaustive-deps }, [severity, status]); const filtered = useMemo(() => { const s = q.trim().toLowerCase(); if (!s) return items; return items.filter((x) => { const ev = x.evidence?.[0]?.summary?.toLowerCase() || ''; return ( x.incident_type.toLowerCase().includes(s) || x.severity.toLowerCase().includes(s) || x.status.toLowerCase().includes(s) || ev.includes(s) || x.device_id.toLowerCase().includes(s) || x.child_id.toLowerCase().includes(s) ); }); }, [items, q]); return ( <div className="mx-auto w-full max-w-6xl space-y-4 p-4"> <div className="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between"> <div> <h1 className="text-lg font-semibold text-gray-900"> Incidents Center </h1> <p className="mt-1 text-xs text-gray-600"> Real-time security incidents with evidence and auto-defense timeline. </p> </div> code Code download content_copy expand_less <div className= "flex items-center gap-2" > <button onClick={() => load( true )} className= "inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <RefreshCw className= "h-4 w-4" /> Refresh </button> <Link href= "/dashboard/protocols" className= "inline-flex items-center gap-2 rounded-xl bg-gray-900 px-3 py-2 text-xs font-semibold text-white hover:bg-black" > Manage Protocols <ChevronRight className= "h-4 w-4" /> </Link> </div> </div> <Card title= "Filters" subtitle= "Search and refine incidents" right={<Filter className= "h-4 w-4 text-gray-500" />} > <div className= "grid grid-cols-1 gap-2 sm:grid-cols-4" > <div className= "relative sm:col-span-2" > <Search className= "absolute left-3 top-2.5 h-4 w-4 text-gray-400" /> <input value={q} onChange={(e) => setQ(e.target.value)} placeholder= "Search by type, status, device, summary..." className= "w-full rounded-xl border border-gray-200 bg-white py-2 pl-9 pr-3 text-sm outline-none focus:border-gray-400" /> </div> <select value={severity} onChange={(e) => setSeverity(e.target.value)} className= "w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" > <option value= "" >All severities</option> <option value= "LOW" >LOW</option> <option value= "MED" >MED</option> <option value= "HIGH" >HIGH</option> <option value= "CRITICAL" >CRITICAL</option> </select> <select value={status} onChange={(e) => setStatus(e.target.value)} className= "w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" > <option value= "" >All statuses</option> <option value= "OPEN" >OPEN</option> <option value= "CONTAINED" >CONTAINED</option> <option value= "ESCALATED" >ESCALATED</option> <option value= "CLOSED" >CLOSED</option> </select> </div> </Card> {filtered.length === 0 ? ( <EmptyState title= "No incidents found" desc= "When the child agent reports an incident, it will appear here with an automated defense timeline." /> ) : ( <div className= "space-y-3" > {filtered.map((x) => { const ev = x.evidence?.[ 0 ]; return ( <Link key={x.incident_id} href={`/dashboard/incidents/${x.incident_id}`} className= "block" > <div className= "rounded-2xl border border-gray-200 bg-white p-4 shadow-sm hover:bg-gray-50" > <div className= "flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between" > <div className= "min-w-0" > <div className= "flex flex-wrap items-center gap-2" > <Pill text={x.incident_type} className= "bg-gray-50 text-gray-700 border-gray-200" /> <Pill text={x.severity} className={severityBadge(x.severity)} /> <Pill text={x.status} className={statusBadge(x.status)} /> </div> <div className= "mt-2 text-sm font-semibold text-gray-900 line-clamp-2" > {ev?.summary || 'Incident reported' } </div> <div className= "mt-1 text-xs text-gray-600" > {fmtDateTime(x.created_at)} • Device: {x.device_id.slice( 0 , 8 )}… • Child:{ ' ' } {x.child_id.slice( 0 , 8 )}… </div> </div> <div className= "flex shrink-0 items-center gap-2 text-xs text-gray-600" > <span className= "rounded-lg bg-white px-2 py-1 border border-gray-200" > Updated {fmtDateTime(x.updated_at)} </span> <ChevronRight className= "h-4 w-4" /> </div> </div> </div> </Link> ); })} <div className= "flex justify-center pt-2" > <button disabled={loading || !nextCursor} onClick={() => load( false )} className= "rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm font-semibold text-gray-900 disabled:opacity-50 hover:bg-gray-50" > {nextCursor ? (loading ? 'Loading...' : 'Load more' ) : 'No more' } </button> </div> </div> )} </div> ); } [6] ملف 5: صفحة تفاصيل الحادثة + Timeline موحد (Evidence + Commands + Agent Events + Audit) المسار: app/dashboard/incidents/[id]/page.tsx تعتمد على API: /api/incidents/:id/timeline // app/dashboard/incidents/[id]/page.tsx 'use client'; import Link from 'next/link'; import { useEffect, useMemo, useState } from 'react'; import { apiJson } from '@/lib/api-client'; import { fmtDateTime, severityBadge, statusBadge, eventKindBadge } from '@/lib/ui'; import { Card, EmptyState, Pill } from '@/components/ui-kit'; import { ArrowLeft, ShieldAlert, Clock, Copy } from 'lucide-react'; type TimelineItem = { t: string; kind: 'EVIDENCE' | 'COMMAND' | 'AGENT_EVENT' | 'AUDIT' | string; data: any; }; type IncidentTimelineResponse = { incident: any; evidence: any[]; commands: any[]; agentEvents: any[]; audits: any[]; timeline: TimelineItem[]; }; function jsonPretty(obj: any) { try { return JSON.stringify(obj, null, 2); } catch { return String(obj); } } export default function IncidentDetailsPage({ params }: { params: { id: string } }) { const id = params.id; const [data, setData] = useState<IncidentTimelineResponse | null>(null); const [loading, setLoading] = useState(false); const [kindFilter, setKindFilter] = useState(''); async function load() { setLoading(true); try { const d = await apiJson <IncidentTimelineResponse> ( /api/incidents/${id}/timeline ); setData(d); } finally { setLoading(false); } } useEffect(() => { load(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [id]); const timeline = useMemo(() => { if (!data?.timeline) return []; const k = kindFilter.trim().toUpperCase(); if (!k) return data.timeline; return data.timeline.filter((x) => String(x.kind).toUpperCase() === k); }, [data, kindFilter]); if (loading && !data) { return ( <div className="mx-auto w-full max-w-6xl p-4"> <Card title="Loading" subtitle="Fetching incident timeline..."> <div className="text-sm text-gray-700"> Please wait… </div> </Card> </div> ); } if (!data) { return ( <div className="mx-auto w-full max-w-6xl p-4"> <EmptyState title="Incident not loaded" desc="Unable to fetch the incident timeline." action={ <button onClick={load} className="rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white" > Retry </button> } /> </div> ); } const incident = data.incident; return ( <div className="mx-auto w-full max-w-6xl space-y-4 p-4"> <div className="flex items-center justify-between gap-2"> <Link href="/dashboard/incidents" className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <ArrowLeft className="h-4 w-4" /> Back </Link> code Code download content_copy expand_less <button onClick={load} className= "inline-flex items-center gap-2 rounded-xl bg-gray-900 px-3 py-2 text-xs font-semibold text-white hover:bg-black" > <Clock className= "h-4 w-4" /> Refresh Timeline </button> </div> <Card title= "Incident Overview" subtitle={`Incident ID: ${incident.incident_id}`} right={<ShieldAlert className= "h-4 w-4 text-gray-500" />} > <div className= "flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between" > <div className= "min-w-0" > <div className= "flex flex-wrap items-center gap-2" > <Pill text={incident.incident_type} className= "bg-gray-50 text-gray-700 border-gray-200" /> <Pill text={incident.severity} className={severityBadge(incident.severity)} /> <Pill text={incident.status} className={statusBadge(incident.status)} /> </div> <div className= "mt-2 text-sm text-gray-900" > <span className= "font-semibold" >Created:</span> {fmtDateTime(incident.created_at)} </div> <div className= "mt-1 text-xs text-gray-600" > Device: {incident.device_id} • Child: {incident.child_id} </div> </div> <div className= "flex flex-col gap-2" > <select value={kindFilter} onChange={(e) => setKindFilter(e.target.value)} className= "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" > <option value= "" >All timeline items</option> <option value= "EVIDENCE" >EVIDENCE</option> <option value= "COMMAND" >COMMAND</option> <option value= "AGENT_EVENT" >AGENT_EVENT</option> <option value= "AUDIT" >AUDIT</option> </select> </div> </div> </Card> <Card title= "Evidence (Latest)" subtitle= "Most recent recorded evidence item" > {data.evidence.length === 0 ? ( <div className= "text-sm text-gray-600" >No evidence attached.</div> ) : ( <div className= "space-y-2" > {data.evidence.slice( -1 ). map ((e) => ( <div key={e.evidence_id} className= "rounded-xl border border-gray-200 bg-white p-3" > <div className= "flex flex-wrap items-center gap-2" > <Pill text={e.content_type} className= "bg-gray-50 text-gray-700 border-gray-200" /> <Pill text={e.severity} className={severityBadge(e.severity)} /> <Pill text={e.classification} className= "bg-gray-50 text-gray-700 border-gray-200" /> </div> <div className= "mt-2 text-sm font-semibold text-gray-900" >{e.summary}</div> <div className= "mt-1 text-xs text-gray-600" > Created {fmtDateTime(e.created_at)} • SHA256 {String(e.sha256).slice( 0 , 12 )}… </div> {Array.isArray(e.tags) && e.tags.length > 0 && ( <div className= "mt-2 flex flex-wrap gap-1" > {e.tags. map ((t: string ) => ( <Pill key={t} text={t} className= "bg-gray-50 text-gray-700 border-gray-200" /> ))} </div> )} </div> ))} </div> )} </Card> <Card title= "Timeline" subtitle= "Unified chain: evidence, commands, agent acknowledgements, audits" > {timeline.length === 0 ? ( <div className= "text-sm text-gray-600" >No timeline events.</div> ) : ( <div className= "space-y-2" > {timeline. map ((x, idx) => ( <TimelineRow key={`${idx}-${x.kind}-${x.t}`} item={x} /> ))} </div> )} </Card> </div> ); } function TimelineRow({ item }: { item: TimelineItem }) { const kind = String(item.kind || '').toUpperCase(); const data = item.data || {}; const summary = (() => { if (kind === 'EVIDENCE') return data.summary || 'Evidence captured'; if (kind === 'COMMAND') return ${data.type || 'Command'} • ${data.status || ''} .trim(); if (kind === 'AGENT_EVENT') return data.event_key || 'Agent event'; if (kind === 'AUDIT') return data.event_key || 'Audit event'; return 'Event'; })(); async function copyJson() { await navigator.clipboard.writeText(JSON.stringify(item, null, 2)); } return ( <div className="rounded-2xl border border-gray-200 bg-white p-3"> <div className="flex items-start justify-between gap-3"> <div className="min-w-0"> <div className="flex flex-wrap items-center gap-2"> <Pill text={kind} className={eventKindBadge(kind)} /> <span className="text-xs text-gray-600"> {fmtDateTime(item.t)} </span> </div> code Code download content_copy expand_less < div className = "mt-1 text-sm font-semibold text-gray-900 line-clamp-2" > {summary} </ div > < details className = "mt-2" > < summary className = "cursor-pointer text-xs font-semibold text-gray-700" > View details JSON </ summary > < pre className = "mt-2 max-h-72 overflow-auto rounded-xl border border-gray-200 bg-gray-50 p-3 text-xs text-gray-800" > {jsonPretty(data)} </ pre > </ details > </ div > < button onClick = {copyJson} className = "inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > < Copy className = "h-4 w-4" /> Copy </ button > </ div > </ div > ); } [7] ملف 6: صفحة البروتوكولات (Protocols List + Publish) المسار: app/dashboard/protocols/page.tsx تعتمد على API: GET /api/protocols POST /api/protocols/[id]/publish // app/dashboard/protocols/page.tsx 'use client'; import Link from 'next/link'; import { useEffect, useState } from 'react'; import { apiJson } from '@/lib/api-client'; import { Card, EmptyState, Pill } from '@/components/ui-kit'; import { fmtDateTime } from '@/lib/ui'; import { Shield, ChevronRight, UploadCloud, RefreshCw } from 'lucide-react'; type Protocol = { protocol_id: string; name: string; incident_type: string; min_severity: string; enabled: boolean; status: string; version: number; updated_at: string; actions: Array<{ action: string; order: number }>; }; export default function ProtocolsPage() { const [items, setItems] = useState<Protocol[]>([]); const [loading, setLoading] = useState(false); async function load() { setLoading(true); try { const data = await apiJson<{ items: Protocol[] }>('/api/protocols'); setItems(data.items || []); } finally { setLoading(false); } } async function publish(id: string) { await apiJson( /api/protocols/${id}/publish , { method: 'POST' }); await load(); } useEffect(() => { load(); }, []); return ( <div className="mx-auto w-full max-w-6xl space-y-4 p-4"> <div className="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between"> <div> <h1 className="text-lg font-semibold text-gray-900"> Safety Protocols </h1> <p className="mt-1 text-xs text-gray-600"> Published protocols automatically trigger defense actions on incidents. </p> </div> code Code download content_copy expand_less <div className= "flex items-center gap-2" > <button onClick={load} className= "inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <RefreshCw className= "h-4 w-4" /> Refresh </button> <Link href= "/dashboard/protocols/simulator" className= "inline-flex items-center gap-2 rounded-xl bg-gray-900 px-3 py-2 text-xs font-semibold text-white hover:bg-black" > Protocol Simulator <ChevronRight className= "h-4 w-4" /> </Link> </div> </div> {items.length === 0 ? ( <EmptyState title= "No protocols found" desc= "Create and publish a protocol to enable auto-defense." /> ) : ( <div className= "space-y-3" > {items.map((p) => ( <Card key={p.protocol_id} title={p.name} subtitle={`Updated: ${fmtDateTime(p.updated_at)} • Version: ${p.version} `} right={<Shield className= "h-4 w-4 text-gray-500" />} > <div className= "flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between" > <div className= "min-w-0" > <div className= "flex flex-wrap items-center gap-2" > <Pill text={p.incident_type} className= "bg-gray-50 text-gray-700 border-gray-200" /> <Pill text={`min: ${p.min_severity} `} className= "bg-gray-50 text-gray-700 border-gray-200" /> <Pill text={p.enabled ? 'enabled' : 'disabled' } className={p.enabled ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-gray-50 text-gray-700 border-gray-200' } /> <Pill text={p.status} className={p.status === 'PUBLISHED' ? 'bg-indigo-50 text-indigo-700 border-indigo-100' : 'bg-amber-50 text-amber-700 border-amber-100' } /> </div> <div className= "mt-2 text-xs text-gray-600" > Actions:{ ' ' } {p.actions .slice() .sort((a, b) => a.order - b.order) .map((a) => ` ${a.order} : ${a.action} `) .join( ' → ' )} </div> </div> <div className= "flex shrink-0 items-center gap-2" > <button onClick={() => publish(p.protocol_id)} disabled={loading} className= "inline-flex items-center gap-2 rounded-xl bg-gray-900 px-3 py-2 text-xs font-semibold text-white hover:bg-black disabled:opacity-50" > <UploadCloud className= "h-4 w-4" /> Publish </button> </div> </div> </Card> ))} </div> )} </div> ); } [8] ملف 7: صفحة Protocol Simulator (ميزة تنافسية قوية جدًا) المسار: app/dashboard/protocols/simulator/page.tsx هذه الصفحة لا تغيّر DB؛ فقط “محاكاة قرار policy-engine” نحتاج Endpoint بسيط للمحاكاة. [9] ملف 8: Simulation API Endpoint المسار: app/api/protocols/simulate/route.ts // app/api/protocols/simulate/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { decidePolicy } from '@/lib/policy-engine'; import { IncidentType, Severity } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "incident_type": "GROOMING", "severity": "HIGH" } */ export async function POST(req: NextRequest) { try { const principal = getPrincipal(req); const family_id = principal.family_id; if (!requireFamilyAccess(principal, family_id)) throw new HttpError(403, 'Forbidden'); const body = await req.json().catch(() => ({})); const incident_type = String(body?.incident_type || '').trim().toUpperCase() as IncidentType; const severity = String(body?.severity || '').trim().toUpperCase() as Severity; if (!incident_type) throw new HttpError(400, 'incident_type required'); if (!severity) throw new HttpError(400, 'severity required'); const decision = await decidePolicy({ family_id, incident_type, severity }); return NextResponse.json( { ok: true, protocol_id: decision.protocol_id, actions: decision.actions, commands: decision.commands, }, { status: 200 } ); } catch (e: any) { const status = e?.status ?? 500; const message = e?.message ?? 'Unexpected error'; return jsonError(status, message); } } [10] ملف 9: Simulator UI المسار: app/dashboard/protocols/simulator/page.tsx // app/dashboard/protocols/simulator/page.tsx 'use client'; import Link from 'next/link'; import { useState } from 'react'; import { apiJson } from '@/lib/api-client'; import { Card, Pill } from '@/components/ui-kit'; import { ChevronLeft, Play, ShieldCheck, Copy } from 'lucide-react'; type SimResult = { ok: boolean; protocol_id: string | null; actions: Array<{ action: string; order: number }>; commands: Array<{ type: string; payload: any }>; }; export default function ProtocolSimulatorPage() { const [incidentType, setIncidentType] = useState('GROOMING'); const [severity, setSeverity] = useState('HIGH'); const [loading, setLoading] = useState(false); const [result, setResult] = useState<SimResult | null>(null); async function simulate() { setLoading(true); try { const data = await apiJson <SimResult> ('/api/protocols/simulate', { method: 'POST', json: { incident_type: incidentType, severity, }, }); setResult(data); } finally { setLoading(false); } } async function copyResult() { if (!result) return; await navigator.clipboard.writeText(JSON.stringify(result, null, 2)); } return ( <div className="mx-auto w-full max-w-4xl space-y-4 p-4"> <div className="flex items-center justify-between"> <Link href="/dashboard/protocols" className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <ChevronLeft className="h-4 w-4" /> Back </Link> code Code download content_copy expand_less <div className= "text-xs text-gray-600" >Policy decision preview (no DB changes)</div> </div> <Card title= "Protocol Simulator" subtitle= "Preview what the system will enforce before a real incident happens" right={<ShieldCheck className= "h-4 w-4 text-gray-500" />} > <div className= "grid grid-cols-1 gap-2 sm:grid-cols-3" > <select value={incidentType} onChange={(e) => setIncidentType(e.target.value)} className= "w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" > <option value= "GROOMING" >GROOMING</option> <option value= "BULLYING" >BULLYING</option> <option value= "SEXUAL" >SEXUAL</option> <option value= "SELF_HARM" >SELF_HARM</option> <option value= "TAMPER" >TAMPER</option> <option value= "GEOFENCE" >GEOFENCE</option> </select> <select value={severity} onChange={(e) => setSeverity(e.target.value)} className= "w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" > <option value= "LOW" >LOW</option> <option value= "MED" >MED</option> <option value= "HIGH" >HIGH</option> <option value= "CRITICAL" >CRITICAL</option> </select> <button onClick={simulate} disabled={loading} className= "inline-flex items-center justify-center gap-2 rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-black disabled:opacity-50" > <Play className= "h-4 w-4" /> {loading ? 'Simulating...' : 'Simulate' } </button> </div> </Card> {!result ? ( <Card title= "Result" subtitle= "Run simulation to see expected actions and commands" > <div className= "text-sm text-gray-600" >No result yet.</div> </Card> ) : ( <Card title= "Result" subtitle={`Protocol: ${result.protocol_id || 'None (no eligible protocol)'} `} right={ <button onClick={copyResult} className= "inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <Copy className= "h-4 w-4" /> Copy </button> } > <div className= "space-y-3" > <div> <div className= "text-xs font-semibold text-gray-700" >Actions</div> <div className= "mt-2 flex flex-wrap gap-2" > {result.actions.length === 0 ? ( <span className= "text-sm text-gray-600" >No actions</span> ) : ( result.actions .slice() .sort((a, b) => a.order - b.order) .map((a) => ( <Pill key={` ${a.order} - ${a.action} `} text={` ${a.order} : ${a.action} `} className= "bg-gray-50 text-gray-700 border-gray-200" /> )) )} </div> </div> <div> <div className= "text-xs font-semibold text-gray-700" >Commands (to device queue)</div> <div className= "mt-2 space-y-2" > {result.commands.length === 0 ? ( <div className= "text-sm text-gray-600" >No commands</div> ) : ( result.commands.map((c, i) => ( <div key={i} className= "rounded-xl border border-gray-200 bg-white p-3" > <div className= "text-sm font-semibold text-gray-900" >{c.type}</div> <pre className= "mt-2 max-h-56 overflow-auto rounded-xl border border-gray-200 bg-gray-50 p-3 text-xs text-gray-800" > {JSON.stringify(c.payload ?? {}, null, 2)} </pre> </div> )) )} </div> </div> </div> </Card> )} </div> ); } [11] ماذا تحقق الآن فعليًا؟ المنصة أصبحت مؤسسية وقابلة للتشغيل بالحد الأدنى العالمي: [11.1] الوالد يرى الحوادث + تفاصيلها الأدلة + تصنيفها الأوامر التي تم تنفيذها ACK من جهاز الطفل سجل تدقيق Audit [11.2] النظام ينفذ تلقائيًا عند Report Incident من Agent: Evidence + Custody اختيار Protocol إرسال Commands تسجيل Timeline [12] الخطوة التالية (الأقوى) لتصبح “مخزن أدلة قانوني” الآن سأضيف مباشرة: Evidence Vault Page مستقلة داخل Incident عرض كل Evidence items Export / Legal Hold / Tags / Notes Role Constraints في UI: الأم تستطيع عرض الأدلة لكن لا تحذف الحذف للأب فقط (وحتى الأب: “Soft Delete” + CustodyLog) [13] Suggested Next Steps [13.1] أكتب لك الآن صفحة Evidence Vault داخل الحادثة + API لتعديل Tags/Notes وLegal Hold. [13.2] ثم أضيف “One-click Emergency Lockdown” زر واحد في UI يرسل سلسلة أوامر للجهاز. [13.3] ثم نبدأ تنفيذ أوامر Kotlin على Android (NET_QUARANTINE + BLACKOUT) بشكل فعلي.
[137] [1] ## ممتاز — الآن نضيف “Evidence Vault” الحقيقي + زر “Emergency Lockdown” الفوري (مؤسسي 100%) المرحلة القادمة تجعل لوحة الوالدين مكتملة مثل منصات الشركات العالمية: Evidence Vault داخل كل Incident عرض كل الأدلة المرتبطة Tags / Notes / Redaction (إخفاء الدليل بدل حذفه) Export JSON لتجهيز البلاغات Emergency Lockdown Button ضغطه واحدة → أوامر دفاع قصوى للجهاز خلال ثوانٍ صلاحيات دقيقة الأم: عرض + تعديل Notes/Tags (حسب الإعدادات) الأب: يمتلك “Redact Evidence” (بديل حذف آمن قانونيًا) مهم: بدل “الحذف النهائي” سنطبق Redaction (إخفاء الدليل + قطع الرابط) لأنه أقوى قانونيًا وأأمن ويمنع العبث. [2] ملف 1: Evidence Vault API (قائمة الأدلة الخاصة بالحادثة) المسار: app/api/incidents/[id]/evidence/route.ts // app/api/incidents/[id]/evidence/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const incident = await prisma.incident.findUnique({ where : { incident_id }, select : { incident_id : true , family_id : true }, }); if (!incident) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, incident.family_id)) throw new HttpError( 403 , 'Forbidden' ); const items = await prisma.evidence.findMany({ where : { incident_id }, orderBy : { created_at : 'desc' }, select : { evidence_id : true , incident_id : true , child_id : true , device_id : true , content_type : true , severity : true , classification : true , summary : true , object_uri : true , sha256 : true , tags : true , notes : true , created_at : true , }, take : 200 , }); return NextResponse.json({ ok : true , items }, { status : 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [3] ملف 2: Evidence Update API (تعديل Tags/Notes + Redact Evidence) المسار: app/api/evidence/[id]/route.ts هذا الـ API يسمح للوالدين بتعديل Notes/Tags ويدعم “Redact Evidence” للأب فقط: يزيل object_uri يضيف Tag: redacted يسجل AuditLog // app/api/evidence/[id]/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function cleanTags(tags: any): string[] { if (!Array.isArray(tags)) return []; return tags .map((x) => String(x || '').trim().toLowerCase()) .filter(Boolean) .slice(0, 20); } function isFather(principal: any) { // [Inference] افترضنا role = 'FATHER' ضمن نظامك return String(principal?.role || '').toUpperCase() === 'FATHER'; } /** PATCH body: { "notes": "....", "tags": ["snapchat","threat"], "redact": false } */ export async function PATCH(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const evidence_id = ctx.params.id; const body = await req.json().catch(() => ({})); const notes = body?.notes !== undefined ? String(body.notes).slice(0, 2000) : undefined; const tags = body?.tags !== undefined ? cleanTags(body.tags) : undefined; const redact = body?.redact === true; const ev = await prisma.evidence.findUnique({ where: { evidence_id }, select: { evidence_id: true, family_id: true, incident_id: true, object_uri: true, tags: true, notes: true }, }); if (!ev) throw new HttpError(404, 'Evidence not found'); if (!requireFamilyAccess(principal, ev.family_id)) throw new HttpError(403, 'Forbidden'); const data: any = {}; if (notes !== undefined) data.notes = notes; if (tags !== undefined) data.tags = tags; if (redact) { if (!isFather(principal)) throw new HttpError(403, 'Only father can redact evidence'); data.object_uri = null; const oldTags = Array.isArray(ev.tags) ? ev.tags : []; const merged = Array.from(new Set([...oldTags.map((x: any) => String(x).toLowerCase()), 'redacted'])); data.tags = merged.slice(0, 20); data.notes = ${(notes ?? ev.notes ?? '').toString()}\n\n[REDACTED] Evidence link removed by father. ; } const updated = await prisma.evidence.update({ where: { evidence_id }, data, select: { evidence_id: true, incident_id: true, object_uri: true, tags: true, notes: true, updated_at: true, } as any, }); await prisma.auditLog.create({ data: { family_id: ev.family_id, actor_user_id: principal.principal_id, event_key: redact ? 'EVIDENCE_REDACTED' : 'EVIDENCE_UPDATED', event_json: { evidence_id, incident_id: ev.incident_id, redact, changed: { notes: notes !== undefined, tags: tags !== undefined, }, }, }, }); return NextResponse.json({ ok: true, evidence: updated }, { status: 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [4] ملف 3: Emergency Lockdown API (ضغطه واحدة) المسار: app/api/devices/[id]/lockdown/route.ts هذا الـ Endpoint يرسل أوامر قوية فورًا: APP_KILL (إذا تم تحديد app_package) NET_QUARANTINE MIC_BLOCK CAMERA_BLOCK LOCKSCREEN_BLACKOUT ويُسجل AuditLog حتى يكون كل شيء قابل للتدقيق. // app/api/devices/[id]/lockdown/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { enqueueCommands } from '@/lib/policy-engine'; import { CommandType } from '@prisma/client'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "reason": "Emergency child protection", "incident_id": "optional", "app_package": "com.whatsapp" (optional), "blackout_message": "optional" } */ export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const device_id = ctx.params.id; const body = await req.json().catch(() => ({})); const reason = String(body?.reason || 'Emergency child protection').slice(0, 140); const incident_id = body?.incident_id ? String(body.incident_id) : null; const app_package = body?.app_package ? String(body.app_package).slice(0, 140) : null; const blackout_message = body?.blackout_message ? String(body.blackout_message).slice(0, 140) : 'Device locked. Please contact a parent.'; const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, child_id: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (!requireFamilyAccess(principal, device.family_id)) throw new HttpError(403, 'Forbidden'); const commands = [ ...(app_package ? [ { type: CommandType.APP_KILL, payload: { app_package }, }, { type: CommandType.APP_BLOCK, payload: { app_package }, }, ] : []), { type: CommandType.NET_QUARANTINE, payload: { mode: 'deny_all_except_amanah' } }, { type: CommandType.MIC_BLOCK, payload: { enabled: true } }, { type: CommandType.CAMERA_BLOCK, payload: { enabled: true } }, { type: CommandType.LOCKSCREEN_BLACKOUT, payload: { enabled: true, message: blackout_message }, }, { type: CommandType.SCREENSHOT_CAPTURE, payload: { reason: 'emergency_lockdown' } }, ]; const queued = await enqueueCommands({ family_id: device.family_id, device_id: device.device_id, issued_by_user_id: principal.principal_id, commands, ttl_sec: 120, }); await prisma.auditLog.create({ data: { family_id: device.family_id, actor_user_id: principal.principal_id, event_key: 'EMERGENCY_LOCKDOWN_TRIGGERED', event_json: { device_id, child_id: device.child_id, incident_id, reason, app_package, commands_count: queued.length, }, }, }); return NextResponse.json({ ok: true, queued }, { status: 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [5] ملف 4: Evidence Vault UI Page (داخل لوحة الوالدين) المسار: app/dashboard/incidents/[id]/evidence/page.tsx مميزات الصفحة: عرض الأدلة في Cards تعديل Notes/Tags زر Export JSON زر Redact (للأب فقط) — ويُفترض أن backend سيمنع غير الأب // app/dashboard/incidents/[id]/evidence/page.tsx 'use client'; import Link from 'next/link'; import { useEffect, useMemo, useState } from 'react'; import { apiJson } from '@/lib/api-client'; import { fmtDateTime, severityBadge } from '@/lib/ui'; import { Card, EmptyState, Pill } from '@/components/ui-kit'; import { ArrowLeft, Download, Save, EyeOff } from 'lucide-react'; type EvidenceItem = { evidence_id: string; incident_id: string; child_id: string; device_id: string; content_type: string; severity: string; classification: string; summary: string; object_uri: string | null; sha256: string; tags: string[]; notes: string | null; created_at: string; }; export default function EvidenceVaultPage({ params }: { params: { id: string } }) { const incidentId = params.id; const [items, setItems] = useState<EvidenceItem[]>([]); const [loading, setLoading] = useState(false); const [activeId, setActiveId] = useState<string | null>(null); const [notesDraft, setNotesDraft] = useState <string> (''); const [tagsDraft, setTagsDraft] = useState <string> (''); const [saving, setSaving] = useState(false); async function load() { setLoading(true); try { const data = await apiJson<{ ok: boolean; items: EvidenceItem[] }>( /api/incidents/${incidentId}/evidence ); setItems(data.items || []); if (!activeId && data.items?.[0]?.evidence_id) { setActiveId(data.items[0].evidence_id); } } finally { setLoading(false); } } useEffect(() => { load(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [incidentId]); const active = useMemo(() => items.find((x) => x.evidence_id === activeId) || null, [items, activeId]); useEffect(() => { if (!active) return; setNotesDraft(active.notes || ''); setTagsDraft((active.tags || []).join(', ')); }, [activeId]); // eslint-disable-line async function saveChanges(redact = false) { if (!active) return; setSaving(true); try { const tags = tagsDraft .split(',') .map((x) => x.trim().toLowerCase()) .filter(Boolean) .slice(0, 20); code Code download content_copy expand_less await apiJson( `/api/evidence/ ${active.evidence_id} ` , { method : 'PATCH' , json : { notes : notesDraft, tags, redact, }, }); await load(); } finally { setSaving( false ); } } function exportJson() { const payload = { incident_id: incidentId, exported_at: new Date().toISOString(), evidence: items, }; const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); code Code download content_copy expand_less const a = document .createElement( 'a' ); a.href = url; a.download = `evidence_ ${incidentId} .json` ; a.click(); URL.revokeObjectURL(url); } return ( <div className="mx-auto w-full max-w-6xl space-y-4 p-4"> <div className="flex items-center justify-between gap-2"> <Link href={ /dashboard/incidents/${incidentId} } className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <ArrowLeft className="h-4 w-4" /> Back to Incident </Link> code Code download content_copy expand_less < button onClick = {exportJson} className = "inline-flex items-center gap-2 rounded-xl bg-gray-900 px-3 py-2 text-xs font-semibold text-white hover:bg-black" > < Download className = "h-4 w-4" /> Export JSON </ button > </ div > < Card title = "Evidence Vault" subtitle = "All evidence items linked to this incident" > {loading && items.length === 0 ? ( < div className = "text-sm text-gray-600" > Loading evidence… </ div > ) : items.length === 0 ? ( < EmptyState title = "No evidence found" desc = "When the child agent captures evidence, it will appear here." /> ) : ( < div className = "grid grid-cols-1 gap-3 lg:grid-cols-3" > < div className = "space-y-2 lg:col-span-1" > {items.map((e) => ( < button key = {e.evidence_id} onClick = {() => setActiveId(e.evidence_id)} className={`w-full rounded-2xl border p-3 text-left shadow-sm hover:bg-gray-50 ${ activeId === e.evidence_id ? 'border-gray-400 bg-gray-50' : 'border-gray-200 bg-white' }`} > < div className = "flex flex-wrap items-center gap-2" > < Pill text = {e.content_type} className = "bg-gray-50 text-gray-700 border-gray-200" /> < Pill text = {e.severity} className = {severityBadge(e.severity)} /> </ div > < div className = "mt-2 text-sm font-semibold text-gray-900 line-clamp-2" > {e.summary} </ div > < div className = "mt-1 text-xs text-gray-600" > {fmtDateTime(e.created_at)} </ div > {Array.isArray(e.tags) && e.tags.includes('redacted') && ( < div className = "mt-2" > < Pill text = "redacted" className = "bg-rose-50 text-rose-700 border-rose-100" /> </ div > )} </ button > ))} </ div > < div className = "lg:col-span-2" > {!active ? ( < EmptyState title = "Select evidence" desc = "Choose an evidence item to inspect and edit details." /> ) : ( < Card title = "Evidence Details" subtitle = { ` Evidence ID: ${ active.evidence_id }`} > < div className = "space-y-3" > < div className = "flex flex-wrap items-center gap-2" > < Pill text = {active.content_type} className = "bg-gray-50 text-gray-700 border-gray-200" /> < Pill text = {active.severity} className = {severityBadge(active.severity)} /> < Pill text = {active.classification} className = "bg-gray-50 text-gray-700 border-gray-200" /> {active.object_uri ? ( < Pill text = "linked" className = "bg-emerald-50 text-emerald-700 border-emerald-100" /> ) : ( < Pill text = "no-link" className = "bg-gray-50 text-gray-700 border-gray-200" /> )} </ div > < div className = "text-sm font-semibold text-gray-900" > {active.summary} </ div > < div className = "text-xs text-gray-600" > SHA256: {String(active.sha256).slice(0, 18)}… • Device: {active.device_id} </ div > < div > < div className = "text-xs font-semibold text-gray-700" > Tags </ div > < input value = {tagsDraft} onChange = {(e) => setTagsDraft(e.target.value)} placeholder="Comma-separated tags (e.g. snapchat, threat, grooming)" className="mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" /> </ div > < div > < div className = "text-xs font-semibold text-gray-700" > Notes </ div > < textarea value = {notesDraft} onChange = {(e) => setNotesDraft(e.target.value)} rows={6} placeholder="Private notes for parents..." className="mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" /> </ div > < div className = "flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between" > < div className = "text-xs text-gray-600" > Created: {fmtDateTime(active.created_at)} </ div > < div className = "flex gap-2" > < button onClick = {() => saveChanges(false)} disabled={saving} className="inline-flex items-center gap-2 rounded-xl bg-gray-900 px-3 py-2 text-xs font-semibold text-white hover:bg-black disabled:opacity-50" > < Save className = "h-4 w-4" /> Save </ button > < button onClick = {() => saveChanges(true)} disabled={saving} className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50 disabled:opacity-50" title="Redact (Father only): removes evidence link and marks as redacted" > < EyeOff className = "h-4 w-4" /> Redact </ button > </ div > </ div > </ div > </ Card > )} </ div > </ div > )} </ Card > </ div > ); } [6] ملف 5: تحديث صفحة Incident Details لإضافة زر Evidence Vault + Emergency Lockdown المسار: app/dashboard/incidents/[id]/page.tsx استبدل الملف كاملًا بهذا الإصدار (هو نفس السابق + إضافات جديدة). // app/dashboard/incidents/[id]/page.tsx 'use client'; import Link from 'next/link'; import { useEffect, useMemo, useState } from 'react'; import { apiJson } from '@/lib/api-client'; import { fmtDateTime, severityBadge, statusBadge, eventKindBadge } from '@/lib/ui'; import { Card, EmptyState, Pill } from '@/components/ui-kit'; import { ArrowLeft, ShieldAlert, Clock, Copy, FolderOpen, ShieldOff } from 'lucide-react'; type TimelineItem = { t: string; kind: 'EVIDENCE' | 'COMMAND' | 'AGENT_EVENT' | 'AUDIT' | string; data: any; }; type IncidentTimelineResponse = { incident: any; evidence: any[]; commands: any[]; agentEvents: any[]; audits: any[]; timeline: TimelineItem[]; }; function jsonPretty(obj: any) { try { return JSON.stringify(obj, null, 2); } catch { return String(obj); } } export default function IncidentDetailsPage({ params }: { params: { id: string } }) { const id = params.id; const [data, setData] = useState<IncidentTimelineResponse | null>(null); const [loading, setLoading] = useState(false); const [kindFilter, setKindFilter] = useState(''); const [lockdownLoading, setLockdownLoading] = useState(false); async function load() { setLoading(true); try { const d = await apiJson <IncidentTimelineResponse> ( /api/incidents/${id}/timeline ); setData(d); } finally { setLoading(false); } } async function emergencyLockdown() { if (!data?.incident?.device_id) return; setLockdownLoading(true); try { await apiJson( /api/devices/${data.incident.device_id}/lockdown , { method: 'POST', json: { reason: 'Emergency lockdown from parent console', incident_id: id, blackout_message: 'Device locked for child protection. Please contact a parent.', }, }); await load(); } finally { setLockdownLoading(false); } } useEffect(() => { load(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [id]); const timeline = useMemo(() => { if (!data?.timeline) return []; const k = kindFilter.trim().toUpperCase(); if (!k) return data.timeline; return data.timeline.filter((x) => String(x.kind).toUpperCase() === k); }, [data, kindFilter]); if (loading && !data) { return ( <div className="mx-auto w-full max-w-6xl p-4"> <Card title="Loading" subtitle="Fetching incident timeline..."> <div className="text-sm text-gray-700"> Please wait… </div> </Card> </div> ); } if (!data) { return ( <div className="mx-auto w-full max-w-6xl p-4"> <EmptyState title="Incident not loaded" desc="Unable to fetch the incident timeline." action={ <button onClick={load} className="rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white" > Retry </button> } /> </div> ); } const incident = data.incident; return ( <div className="mx-auto w-full max-w-6xl space-y-4 p-4"> <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between"> <div className="flex items-center gap-2"> <Link href="/dashboard/incidents" className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <ArrowLeft className="h-4 w-4" /> Back </Link> code Code download content_copy expand_less <Link href={`/dashboard/incidents/ ${id} /evidence`} className= "inline-flex items-center gap-2 rounded-xl bg-gray-900 px-3 py-2 text-xs font-semibold text-white hover:bg-black" > <FolderOpen className= "h-4 w-4" /> Evidence Vault </Link> </div> <div className= "flex items-center gap-2" > <button onClick={load} className= "inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <Clock className= "h-4 w-4" /> Refresh Timeline </button> <button onClick={emergencyLockdown} disabled={lockdownLoading} className= "inline-flex items-center gap-2 rounded-xl bg-rose-600 px-3 py-2 text-xs font-semibold text-white hover:bg-rose-700 disabled:opacity-50" title= "Immediate device lockdown and quarantine" > <ShieldOff className= "h-4 w-4" /> {lockdownLoading ? 'Locking…' : 'Emergency Lockdown' } </button> </div> </div> <Card title= "Incident Overview" subtitle={`Incident ID: ${incident.incident_id} `} right={<ShieldAlert className= "h-4 w-4 text-gray-500" />} > <div className= "flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between" > <div className= "min-w-0" > <div className= "flex flex-wrap items-center gap-2" > <Pill text={incident.incident_type} className= "bg-gray-50 text-gray-700 border-gray-200" /> <Pill text={incident.severity} className={severityBadge(incident.severity)} /> <Pill text={incident.status} className={statusBadge(incident.status)} /> </div> <div className= "mt-2 text-sm text-gray-900" > <span className= "font-semibold" >Created:</span> {fmtDateTime(incident.created_at)} </div> <div className= "mt-1 text-xs text-gray-600" > Device: {incident.device_id} • Child: {incident.child_id} </div> </div> <div className= "flex flex-col gap-2" > <select value={kindFilter} onChange={(e) => setKindFilter(e.target.value)} className= "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" > <option value= "" >All timeline items</option> <option value= "EVIDENCE" >EVIDENCE</option> <option value= "COMMAND" >COMMAND</option> <option value= "AGENT_EVENT" >AGENT_EVENT</option> <option value= "AUDIT" >AUDIT</option> </select> </div> </div> </Card> <Card title= "Evidence (Latest)" subtitle= "Most recent recorded evidence item" > {data.evidence.length === 0 ? ( <div className= "text-sm text-gray-600" >No evidence attached.</div> ) : ( <div className= "space-y-2" > {data.evidence.slice(-1).map((e) => ( <div key={e.evidence_id} className= "rounded-xl border border-gray-200 bg-white p-3" > <div className= "flex flex-wrap items-center gap-2" > <Pill text={e.content_type} className= "bg-gray-50 text-gray-700 border-gray-200" /> <Pill text={e.severity} className={severityBadge(e.severity)} /> <Pill text={e.classification} className= "bg-gray-50 text-gray-700 border-gray-200" /> </div> <div className= "mt-2 text-sm font-semibold text-gray-900" >{e.summary}</div> <div className= "mt-1 text-xs text-gray-600" > Created {fmtDateTime(e.created_at)} • SHA256 {String(e.sha256).slice(0, 12)}… </div> {Array.isArray(e.tags) && e.tags.length > 0 && ( <div className= "mt-2 flex flex-wrap gap-1" > {e.tags.map((t: string) => ( <Pill key={t} text={t} className= "bg-gray-50 text-gray-700 border-gray-200" /> ))} </div> )} </div> ))} </div> )} </Card> <Card title= "Timeline" subtitle= "Unified chain: evidence, commands, agent acknowledgements, audits" > {timeline.length === 0 ? ( <div className= "text-sm text-gray-600" >No timeline events.</div> ) : ( <div className= "space-y-2" > {timeline.map((x, idx) => ( <TimelineRow key={` ${idx} - ${x.kind} - ${x.t} `} item={x} /> ))} </div> )} </Card> </div> ); } function TimelineRow({ item }: { item: TimelineItem }) { const kind = String(item.kind || '').toUpperCase(); const data = item.data || {}; const summary = (() => { if (kind === 'EVIDENCE') return data.summary || 'Evidence captured'; if (kind === 'COMMAND') return ${data.type || 'Command'} • ${data.status || ''} .trim(); if (kind === 'AGENT_EVENT') return data.event_key || 'Agent event'; if (kind === 'AUDIT') return data.event_key || 'Audit event'; return 'Event'; })(); async function copyJson() { await navigator.clipboard.writeText(JSON.stringify(item, null, 2)); } return ( <div className="rounded-2xl border border-gray-200 bg-white p-3"> <div className="flex items-start justify-between gap-3"> <div className="min-w-0"> <div className="flex flex-wrap items-center gap-2"> <Pill text={kind} className={eventKindBadge(kind)} /> <span className="text-xs text-gray-600"> {fmtDateTime(item.t)} </span> </div> code Code download content_copy expand_less < div className = "mt-1 text-sm font-semibold text-gray-900 line-clamp-2" > {summary} </ div > < details className = "mt-2" > < summary className = "cursor-pointer text-xs font-semibold text-gray-700" > View details JSON </ summary > < pre className = "mt-2 max-h-72 overflow-auto rounded-xl border border-gray-200 bg-gray-50 p-3 text-xs text-gray-800" > {jsonPretty(data)} </ pre > </ details > </ div > < button onClick = {copyJson} className = "inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > < Copy className = "h-4 w-4" /> Copy </ button > </ div > </ div > ); } [7] ما الذي أصبح جاهزًا الآن؟ أنت الآن تمتلك طبقة دليل رقمية مؤسسية: [7.1] Evidence Vault جميع الأدلة لكل Incident تعديل Tags/Notes Export JSON Redaction بدل الحذف النهائي [7.2] Emergency Lockdown ضغطة واحدة من الوالد Quarantine + Blackout + Disable Mic/Camera + Screenshot [8] أهم ترقية قادمة (تجعله “أفضل من Bark” بوضوح) الآن سنضيف ميزة “غير موجودة في أغلب الأنظمة”: [8.1] Evidence Chain-of-Custody Viewer صفحة تعرض: من أنشأ الدليل من عدّل Tags/Notes من فعّل Redaction مع timestamps + reason (وسنعرضها في UI بشكل Timeline قانوني) [8.2] Legal Hold Mode (منع العبث) عند تفعيل Legal Hold لIncident: يمنع تعديل/Redact لأي Evidence يسمح فقط بالعرض والتصدير (مستوى مؤسسي يليق بالبلاغات الرسمية) [9] Suggested Next Steps [9.1] أضيف الآن Custody Viewer UI + API (سجل الحيازة لكل Evidence). [9.2] أضيف Legal Hold على مستوى Incident لمنع العبث نهائيًا عند الحالات الخطيرة. [9.3] ثم ننتقل لتنفيذ Android: أوامر BLACKOUT + QUARANTINE فعليًا داخل Child Agent Kotlin.
[138] [1] ## ممتاز — الآن نضيف “Chain of Custody” + “Legal Hold” (مستوى أدلة رقمية مؤسسي) الآن سنرفع النظام لدرجة منصات التحقيق الرقمية المؤسسية عبر ميزتين حاسمتين: Evidence Chain of Custody سجل حيازة الدليل بالكامل: من أنشأ الدليل، من عدّل Tags/Notes، من فعّل Redaction، من صدّر، ومن نفّذ أوامر دفاع. Legal Hold Mode (حماية ضد العبث) عند تفعيل Legal Hold على Incident: يمنع أي تعديل على الأدلة (Tags/Notes/Redaction) يسمح فقط بالعرض + التصدير وهذا مطلوب للحوادث الخطيرة والتحضير لأي بلاغ رسمي. ملاحظة: سنستخدم AuditLog كمنبع رسمي لـ Chain-of-Custody. وهذا يجعل كل إجراء قابل للمراجعة. [2] تعديل قاعدة البيانات (Prisma) لإضافة Legal Hold على Incident [2.1] تحديث Prisma schema المسار: prisma/schema.prisma أضف هذا الحقل داخل Model Incident: model Incident { incident_id String @id @default(uuid()) family_id String child_id String device_id String incident_type String severity String status String created_at DateTime @default(now()) updated_at DateTime @updatedAt // NEW: prevents evidence modification when enabled legal_hold Boolean @default(false) } [2.2] تنفيذ Migration أمر CLI (حسب بيئتك): npx prisma migrate dev -n add_legal_hold_to_incident [3] ملف 1: API لتفعيل/إيقاف Legal Hold على Incident المسار: app/api/incidents/[id]/legal-hold/route.ts صلاحية التشغيل للأب فقط (ويمكن توسيعها لاحقًا) بمجرد تفعيل Legal Hold: الأدلة تصبح “Read-only”. // app/api/incidents/[id]/legal-hold/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function isFather(principal: any) { return String(principal?.role || '').toUpperCase() === 'FATHER'; } /** POST body: { "enabled": true, "reason": "Optional reason" } */ export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; const body = await req.json().catch(() => ({})); const enabled = body?.enabled === true; const reason = String(body?.reason || '').slice(0, 180); const incident = await prisma.incident.findUnique({ where: { incident_id }, select: { incident_id: true, family_id: true, legal_hold: true }, }); if (!incident) throw new HttpError(404, 'Incident not found'); if (!requireFamilyAccess(principal, incident.family_id)) throw new HttpError(403, 'Forbidden'); if (!isFather(principal)) throw new HttpError(403, 'Only father can toggle legal hold'); const updated = await prisma.incident.update({ where: { incident_id }, data: { legal_hold: enabled }, select: { incident_id: true, legal_hold: true, updated_at: true }, }); await prisma.auditLog.create({ data: { family_id: incident.family_id, actor_user_id: principal.principal_id, event_key: enabled ? 'INCIDENT_LEGAL_HOLD_ENABLED' : 'INCIDENT_LEGAL_HOLD_DISABLED', event_json: { incident_id, enabled, reason, }, }, }); return NextResponse.json({ ok: true, incident: updated }, { status: 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [4] ملف 2: API لسجل Chain of Custody الخاص بالحادثة المسار: app/api/incidents/[id]/custody/route.ts يعرض سجل التدقيق المرتبط بالـ Incident + Evidence actions // app/api/incidents/[id]/custody/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } // custodian events that matter to evidence chain-of-custody const CUSTODY_KEYS = [ 'EVIDENCE_CREATED', 'EVIDENCE_UPDATED', 'EVIDENCE_REDACTED', 'EVIDENCE_EXPORTED', 'COMMAND_QUEUED', 'COMMAND_ACK', 'EMERGENCY_LOCKDOWN_TRIGGERED', 'INCIDENT_LEGAL_HOLD_ENABLED', 'INCIDENT_LEGAL_HOLD_DISABLED', ]; export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const incident = await prisma.incident.findUnique({ where : { incident_id }, select : { incident_id : true , family_id : true }, }); if (!incident) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, incident.family_id)) throw new HttpError( 403 , 'Forbidden' ); const audits = await prisma.auditLog.findMany({ where : { family_id : incident.family_id, event_key : { in : CUSTODY_KEYS }, OR : [ { event_json : { path : [ 'incident_id' ], equals : incident_id } as any }, { event_json : { path : [ 'evidence_id' ], not : null } as any }, { event_json : { path : [ 'device_id' ], not : null } as any }, ], }, orderBy : { created_at : 'desc' }, take : 400 , select : { audit_id : true , actor_user_id : true , event_key : true , event_json : true , created_at : true , }, }); // Inference-safe filtering: keep only entries that clearly reference this incident const filtered = audits.filter( ( x ) => { const j = x.event_json || {}; return ( j?.incident_id === incident_id || j?.incident?.incident_id === incident_id || j?.evidence?.incident_id === incident_id ); }); return NextResponse.json({ ok : true , items : filtered }, { status : 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [5] ملف 3: تحديث Evidence PATCH لمنع التعديل إذا Legal Hold مفعّل المسار: app/api/evidence/[id]/route.ts استبدل الملف كاملًا بهذه النسخة (هي نسخة محسنة من السابق): تتحقق من incident.legal_hold عند تفعيل Legal Hold → تمنع Tags/Notes/Redact للجميع تسمح فقط بالعرض (GET موجود مسبقًا في Evidence Vault list) // app/api/evidence/[id]/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function cleanTags(tags: any): string[] { if (!Array.isArray(tags)) return []; return tags .map((x) => String(x || '').trim().toLowerCase()) .filter(Boolean) .slice(0, 20); } function isFather(principal: any) { return String(principal?.role || '').toUpperCase() === 'FATHER'; } /** PATCH body: { "notes": "....", "tags": ["snapchat","threat"], "redact": false } */ export async function PATCH(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const evidence_id = ctx.params.id; const body = await req.json().catch(() => ({})); const notes = body?.notes !== undefined ? String(body.notes).slice(0, 2000) : undefined; const tags = body?.tags !== undefined ? cleanTags(body.tags) : undefined; const redact = body?.redact === true; const ev = await prisma.evidence.findUnique({ where: { evidence_id }, select: { evidence_id: true, family_id: true, incident_id: true, object_uri: true, tags: true, notes: true, }, }); if (!ev) throw new HttpError(404, 'Evidence not found'); if (!requireFamilyAccess(principal, ev.family_id)) throw new HttpError(403, 'Forbidden'); const incident = await prisma.incident.findUnique({ where: { incident_id: ev.incident_id }, select: { incident_id: true, legal_hold: true }, }); if (!incident) throw new HttpError(404, 'Incident not found for this evidence'); // Legal Hold: make evidence read-only for everyone if (incident.legal_hold) { throw new HttpError(423, 'Legal Hold enabled: evidence is read-only'); } const data: any = {}; if (notes !== undefined) data.notes = notes; if (tags !== undefined) data.tags = tags; if (redact) { if (!isFather(principal)) throw new HttpError(403, 'Only father can redact evidence'); data.object_uri = null; const oldTags = Array.isArray(ev.tags) ? ev.tags : []; const merged = Array.from(new Set([...oldTags.map((x: any) => String(x).toLowerCase()), 'redacted'])); data.tags = merged.slice(0, 20); data.notes = ${(notes ?? ev.notes ?? '').toString()}\n\n[REDACTED] Evidence link removed by father. ; } const updated = await prisma.evidence.update({ where: { evidence_id }, data, select: { evidence_id: true, incident_id: true, object_uri: true, tags: true, notes: true, updated_at: true, } as any, }); await prisma.auditLog.create({ data: { family_id: ev.family_id, actor_user_id: principal.principal_id, event_key: redact ? 'EVIDENCE_REDACTED' : 'EVIDENCE_UPDATED', event_json: { evidence_id, incident_id: ev.incident_id, redact, changed: { notes: notes !== undefined, tags: tags !== undefined, }, }, }, }); return NextResponse.json({ ok: true, evidence: updated }, { status: 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [6] ملف 4: Chain of Custody UI Page المسار: app/dashboard/incidents/[id]/custody/page.tsx يعرض: الحدث + الفاعل + وقت التنفيذ JSON قابل للعرض/النسخ فلاتر حسب نوع الحدث // app/dashboard/incidents/[id]/custody/page.tsx 'use client'; import Link from 'next/link'; import { useEffect, useMemo, useState } from 'react'; import { apiJson } from '@/lib/api-client'; import { fmtDateTime, eventKindBadge } from '@/lib/ui'; import { Card, EmptyState, Pill } from '@/components/ui-kit'; import { ArrowLeft, Copy, Filter } from 'lucide-react'; type CustodyItem = { audit_id: string; actor_user_id: string; event_key: string; event_json: any; created_at: string; }; function pretty(obj: any) { try { return JSON.stringify(obj, null, 2); } catch { return String(obj); } } export default function CustodyPage({ params }: { params: { id: string } }) { const incidentId = params.id; const [items, setItems] = useState<CustodyItem[]>([]); const [loading, setLoading] = useState(false); const [keyFilter, setKeyFilter] = useState(''); async function load() { setLoading(true); try { const data = await apiJson<{ ok: boolean; items: CustodyItem[] }>( /api/incidents/${incidentId}/custody ); setItems(data.items || []); } finally { setLoading(false); } } useEffect(() => { load(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [incidentId]); const filtered = useMemo(() => { const k = keyFilter.trim().toUpperCase(); if (!k) return items; return items.filter((x) => String(x.event_key || '').toUpperCase() === k); }, [items, keyFilter]); async function copyRow(x: CustodyItem) { await navigator.clipboard.writeText(JSON.stringify(x, null, 2)); } const uniqueKeys = useMemo(() => { const s = new Set(items.map((x) => x.event_key)); return Array.from(s).sort(); }, [items]); return ( <div className="mx-auto w-full max-w-6xl space-y-4 p-4"> <div className="flex items-center justify-between gap-2"> <Link href={ /dashboard/incidents/${incidentId} } className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <ArrowLeft className="h-4 w-4" /> Back to Incident </Link> code Code download content_copy expand_less < div className = "inline-flex items-center gap-2 text-xs text-gray-600" > < Filter className = "h-4 w-4" /> Chain of Custody </ div > </ div > < Card title = "Custody Filter" subtitle = "Filter custody events by type" > < div className = "grid grid-cols-1 gap-2 sm:grid-cols-3" > < select value = {keyFilter} onChange = {(e) => setKeyFilter(e.target.value)} className="w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" > < option value = "" > All custody events </ option > {uniqueKeys.map((k) => ( < option key = {k} value = {k} > {k} </ option > ))} </ select > < button onClick = {load} className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-50" > Refresh </ button > </ div > </ Card > < Card title = "Chain of Custody Timeline" subtitle = { ` Incident: ${ incidentId }`}> {loading && items.length === 0 ? ( < div className = "text-sm text-gray-600" > Loading custody events… </ div > ) : filtered.length === 0 ? ( < EmptyState title = "No custody records" desc = "Custody records will appear when evidence is created/updated/redacted/exported, or commands are executed." /> ) : ( < div className = "space-y-2" > {filtered.map((x) => ( < div key = {x.audit_id} className = "rounded-2xl border border-gray-200 bg-white p-3" > < div className = "flex items-start justify-between gap-3" > < div className = "min-w-0" > < div className = "flex flex-wrap items-center gap-2" > < Pill text = {x.event_key} className = {eventKindBadge(mapKeyToKind(x.event_key))} /> < span className = "text-xs text-gray-600" > {fmtDateTime(x.created_at)} </ span > </ div > < div className = "mt-1 text-xs text-gray-600" > Actor: < span className = "font-semibold text-gray-900" > {x.actor_user_id} </ span > </ div > < details className = "mt-2" > < summary className = "cursor-pointer text-xs font-semibold text-gray-700" > View event JSON </ summary > < pre className = "mt-2 max-h-72 overflow-auto rounded-xl border border-gray-200 bg-gray-50 p-3 text-xs text-gray-800" > {pretty(x.event_json)} </ pre > </ details > </ div > < button onClick = {() => copyRow(x)} className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > < Copy className = "h-4 w-4" /> Copy </ button > </ div > </ div > ))} </ div > )} </ Card > </ div > ); } function mapKeyToKind(key: string) { const k = String(key || '').toUpperCase(); if (k.startsWith('EVIDENCE_')) return 'EVIDENCE'; if (k.startsWith('COMMAND_')) return 'COMMAND'; if (k.startsWith('INCIDENT_')) return 'AUDIT'; return 'AUDIT'; } [7] ملف 5: زر Legal Hold + رابط Custody داخل صفحة Incident Details المسار: app/dashboard/incidents/[id]/page.tsx هنا سأعطيك Patch واضح بدل إعادة إرسال الملف كاملًا (لأن الملف كبير). إذا تريد “الملف كاملًا” مرة واحدة أخبرني وسأرسله كاملًا فورًا. [7.1] أضف زرين أعلى الصفحة (بجوار Evidence Vault) ابحث عن منطقة الأزرار في أعلى الصفحة وأضف: <Link href={`/dashboard/incidents/${id}/custody`} className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > Chain of Custody </Link> <button onClick={async () => { const enabled = !(data?.incident?.legal_hold === true); await apiJson( /api/incidents/${id}/legal-hold , { method: 'POST', json: { enabled, reason: enabled ? 'Preserve evidence for investigation' : 'Resume normal evidence operations', }, }); await load(); }} className={ inline-flex items-center gap-2 rounded-xl px-3 py-2 text-xs font-semibold text-white ${ data?.incident?.legal_hold ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-gray-900 hover:bg-black' } } {data?.incident?.legal_hold ? 'Legal Hold: ON' : 'Legal Hold: OFF'} </button> [7.2] أضف داخل Incident Overview Badge توضح Legal Hold داخل badges في Overview أضف: <Pill text={incident.legal_hold ? 'LEGAL_HOLD' : 'NORMAL_MODE'} className={incident.legal_hold ? 'bg-indigo-50 text-indigo-700 border-indigo-100' : 'bg-gray-50 text-gray-700 border-gray-200'} /> [8] ملف 6: منع التعديل داخل Evidence Vault UI عند تفعيل Legal Hold المسار: app/dashboard/incidents/[id]/evidence/page.tsx داخل الصفحة نفسها أضف حالة legalHold عبر استدعاء بسيط من timeline أو API. أسهل طريقة (بدون تعقيد): نضيف Fetch صغير لبيانات Incident timeline ونقرأ incident.legal_hold. [8.1] أضف هذا داخل EvidenceVaultPage داخل نفس الصفحة (أعلى الملف): type IncidentMini = { incident: { legal_hold: boolean } }; ثم داخل component: const [legalHold, setLegalHold] = useState(false); useEffect(() => { (async () => { try { const d = await apiJson <IncidentMini> ( /api/incidents/${incidentId}/timeline ); setLegalHold(Boolean(d?.incident?.legal_hold)); } catch { setLegalHold(false); } })(); }, [incidentId]); [8.2] عطّل أزرار Save/Redact عند Legal Hold استبدل disabled={saving} إلى: disabled={saving || legalHold} وأضف رسالة بسيطة أعلى الأزرار: {legalHold && ( <div className="rounded-xl border border-indigo-100 bg-indigo-50 px-3 py-2 text-xs font-semibold text-indigo-700"> Legal Hold enabled: evidence is read-only (view/export only). </div> )} [9] ماذا أصبح لديك الآن (المستوى المؤسسي الحقيقي) [9.1] دليل رقمي محفوظ بلا عبث أي تعديل يصبح مسجل في AuditLog Redaction بدل حذف Legal Hold يمنع التلاعب [9.2] Chain of Custody جاهز للعرض والتوثيق سجل زمني لكل خطوة قابل للنسخ/التصدير قابل للبناء عليه لاحقًا لإخراج PDF رسمي [10] Suggested Next Steps [10.1] أضيف الآن Evidence Export API يسجل EVIDENCE_EXPORTED داخل AuditLog عند تنزيل JSON (حتى التصدير يكون ضمن الحيازة). [10.2] أضيف PDF Report Generator للحادثة (Incident Report رسمي) يتضمن: الأدلة + Timeline + Custody. [10.3] ثم نبدأ المرحلة الأخطر: تنفيذ أوامر Android داخل Child Agent (BLACKOUT/QUARANTINE/MIC/CAM) بشكل فعلي ومضمون التنفيذ.
[139] [1] ## ممتاز — الآن نضيف “Audited Export” + “Incident PDF Report” (جاهز للاستخدام المؤسسي) الآن سنكمل أقوى نقطتين لتحويل النظام إلى منصة أدلة رقمية جاهزة للبلاغات الرسمية: Audited Evidence Export بدل تنزيل JSON محليًا فقط، سنوفر Endpoint رسمي: يصدّر Evidence JSON ويسجل حدث EVIDENCE_EXPORTED داخل AuditLog هذا يجعل “التصدير” جزءًا من Chain of Custody Incident PDF Report Generator Endpoint يولّد PDF رسمي من السيرفر يشمل: Incident Overview Evidence Summary Timeline Chain of Custody (لاحقًا سنضيف Signature blocks + QR + Hashes كاملة) ملاحظة: سأكتب ملفات كاملة وجاهزة للنسخ. [2] ملف 1: Evidence Export API (مع AuditLog) المسار: app/api/incidents/[id]/export-evidence/route.ts // app/api/incidents/[id]/export-evidence/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const incident = await prisma.incident.findUnique({ where : { incident_id }, select : { incident_id : true , family_id : true , child_id : true , device_id : true , incident_type : true , severity : true , status : true , legal_hold : true , created_at : true , updated_at : true , } as any , }); if (!incident) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, incident.family_id)) throw new HttpError( 403 , 'Forbidden' ); const evidence = await prisma.evidence.findMany({ where : { incident_id }, orderBy : { created_at : 'asc' }, select : { evidence_id : true , incident_id : true , child_id : true , device_id : true , content_type : true , severity : true , classification : true , summary : true , object_uri : true , sha256 : true , tags : true , notes : true , created_at : true , }, take : 2000 , }); const payload = { exported_at : new Date ().toISOString(), export_version : 1 , incident, evidence, }; await prisma.auditLog.create({ data : { family_id : incident.family_id, actor_user_id : principal.principal_id, event_key : 'EVIDENCE_EXPORTED' , event_json : { incident_id, evidence_count : evidence.length, legal_hold : Boolean ((incident as any ).legal_hold), export_version : 1 , }, }, }); const json = JSON .stringify(payload, null , 2 ); return new NextResponse(json, { status : 200 , headers : { 'Content-Type' : 'application/json; charset=utf-8' , 'Content-Disposition' : `attachment; filename="evidence_ ${incident_id} .json"` , 'Cache-Control' : 'no-store' , }, }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [3] ملف 2: Incident PDF Report API (Server-generated PDF) المسار: app/api/incidents/[id]/report/pdf/route.ts يعتمد على مكتبة pdf-lib التثبيت (مرة واحدة): npm i pdf-lib // app/api/incidents/[id]/report/pdf/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { PDFDocument, StandardFonts, rgb } from 'pdf-lib'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function fmt(iso: string | Date) { const d = typeof iso === 'string' ? new Date(iso) : iso; return d.toISOString().replace('T', ' ').slice(0, 19) + 'Z'; } function wrapText(text: string, maxChars: number) { const s = String(text || '').replace(/\s+/g, ' ').trim(); if (!s) return ['-']; const words = s.split(' '); const lines: string[] = []; let line = ''; for (const w of words) { const test = line ? ${line} ${w} : w; if (test.length <= maxChars) { line = test; } else { if (line) lines.push(line); line = w; } } if (line) lines.push(line); return lines.slice(0, 50); } type CustodyRow = { audit_id: string; actor_user_id: string; event_key: string; event_json: any; created_at: Date; }; const CUSTODY_KEYS = [ 'EVIDENCE_CREATED', 'EVIDENCE_UPDATED', 'EVIDENCE_REDACTED', 'EVIDENCE_EXPORTED', 'COMMAND_QUEUED', 'COMMAND_ACK', 'EMERGENCY_LOCKDOWN_TRIGGERED', 'INCIDENT_LEGAL_HOLD_ENABLED', 'INCIDENT_LEGAL_HOLD_DISABLED', ]; export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const incident = await prisma.incident.findUnique({ where : { incident_id }, select : { incident_id : true , family_id : true , child_id : true , device_id : true , incident_type : true , severity : true , status : true , legal_hold : true , created_at : true , updated_at : true , } as any , }); if (!incident) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, incident.family_id)) throw new HttpError( 403 , 'Forbidden' ); const evidence = await prisma.evidence.findMany({ where : { incident_id }, orderBy : { created_at : 'desc' }, select : { evidence_id : true , content_type : true , severity : true , classification : true , summary : true , sha256 : true , tags : true , created_at : true , object_uri : true , }, take : 30 , }); const audits = ( await prisma.auditLog.findMany({ where : { family_id : incident.family_id, event_key : { in : CUSTODY_KEYS }, }, orderBy : { created_at : 'desc' }, take : 200 , select : { audit_id : true , actor_user_id : true , event_key : true , event_json : true , created_at : true , }, })) as unknown as CustodyRow[]; const custody = audits.filter( ( x ) => { const j: any = x.event_json || {}; return j?.incident_id === incident_id || j?.incident?.incident_id === incident_id; }); // Create PDF const pdf = await PDFDocument.create(); const font = await pdf.embedFont(StandardFonts.Helvetica); const fontBold = await pdf.embedFont(StandardFonts.HelveticaBold); const page = pdf.addPage([ 595.28 , 841.89 ]); // A4 const { width, height } = page.getSize(); const margin = 40 ; let y = height - margin; function drawTitle ( text: string ) { page.drawText(text, { x : margin, y, size : 16 , font : fontBold, color : rgb( 0.1 , 0.1 , 0.1 ), }); y -= 22 ; } function drawH ( text: string ) { page.drawText(text, { x : margin, y, size : 12 , font : fontBold, color : rgb( 0.15 , 0.15 , 0.15 ), }); y -= 16 ; } function drawLine ( text: string ) { const lines = wrapText(text, 95 ); for ( const ln of lines) { if (y < margin + 40 ) break ; page.drawText(ln, { x : margin, y, size : 10 , font, color : rgb( 0.2 , 0.2 , 0.2 ), }); y -= 13 ; } } drawTitle( 'AMANA — Incident Report' ); drawLine( `Generated at: ${fmt( new Date ())} ` ); drawLine( `Actor: ${ String (principal?.principal_id || 'unknown' )} ` ); y -= 8 ; drawH( 'Incident Overview' ); drawLine( `Incident ID: ${(incident as any ).incident_id} ` ); drawLine( `Type: ${(incident as any ).incident_type} ` ); drawLine( `Severity: ${(incident as any ).severity} ` ); drawLine( `Status: ${(incident as any ).status} ` ); drawLine( `Legal Hold: ${(incident as any ).legal_hold ? 'ENABLED' : 'DISABLED' } ` ); drawLine( `Child ID: ${(incident as any ).child_id} ` ); drawLine( `Device ID: ${(incident as any ).device_id} ` ); drawLine( `Created: ${fmt((incident as any ).created_at)} ` ); drawLine( `Updated: ${fmt((incident as any ).updated_at)} ` ); y -= 8 ; drawH( 'Evidence Summary (latest 30)' ); if (evidence.length === 0 ) { drawLine( '- No evidence items.' ); } else { for ( const e of evidence) { const sha = String (e.sha256 || '' ).slice( 0 , 12 ); const redacted = e.object_uri ? '' : ' [REDACTED_LINK]' ; drawLine( `• ${fmt(e.created_at)} | ${e.content_type} | ${e.severity} | ${e.classification} | SHA: ${sha} … ${redacted} ` ); drawLine( ` Summary: ${e.summary} ` ); const tags = Array .isArray(e.tags) ? e.tags.join( ', ' ) : '' ; if (tags) drawLine( ` Tags: ${tags} ` ); y -= 4 ; if (y < margin + 80 ) break ; } } y -= 6 ; drawH( 'Chain of Custody (latest 200 matching this incident)' ); if (custody.length === 0 ) { drawLine( '- No custody events recorded yet.' ); } else { for ( const c of custody) { const actor = String (c.actor_user_id || '' ).slice( 0 , 10 ); drawLine( `• ${fmt(c.created_at)} | ${c.event_key} | actor: ${actor} …` ); const j = c.event_json || {}; const compact = JSON .stringify(j).slice( 0 , 220 ); drawLine( ` data: ${compact} ${compact.length >= 220 ? '…' : '' } ` ); y -= 3 ; if (y < margin + 60 ) break ; } } // Audit report generation itself await prisma.auditLog.create({ data : { family_id : incident.family_id, actor_user_id : principal.principal_id, event_key : 'INCIDENT_REPORT_PDF_GENERATED' , event_json : { incident_id, evidence_included : evidence.length, custody_included : custody.length, }, }, }); const bytes = await pdf.save(); return new NextResponse(bytes, { status : 200 , headers : { 'Content-Type' : 'application/pdf' , 'Content-Disposition' : `attachment; filename="incident_report_ ${incident_id} .pdf"` , 'Cache-Control' : 'no-store' , }, }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [4] ملف 3: تحديث Evidence Vault UI لاستخدام “Audited Export” المسار: app/dashboard/incidents/[id]/evidence/page.tsx استبدل زر Export JSON القديم (المحلي) بهذه النسخة التي تنزل من السيرفر وتُسجل Custody تلقائيًا. ابحث عن دالة exportJson() واستبدلها بالكامل: async function exportJson() { const res = await fetch( /api/incidents/${incidentId}/export-evidence , { cache: 'no-store' }); if (!res.ok) { alert('Failed to export evidence'); return; } const blob = await res.blob(); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = evidence_${incidentId}.json ; a.click(); URL.revokeObjectURL(url); } الآن كل Export يصبح حدثًا رسميًا داخل AuditLog. [5] ملف 4: إضافة زر “Download PDF Report” في Incident Details UI المسار: app/dashboard/incidents/[id]/page.tsx ضمن شريط الأزرار الأعلى (بجانب Evidence Vault / Refresh / Lockdown) أضف زر: <button onClick={async () => { const res = await fetch( /api/incidents/${id}/report/pdf , { cache: 'no-store' }); if (!res.ok) { alert('Failed to generate PDF report'); return; } const blob = await res.blob(); const url = URL.createObjectURL(blob); code Code download content_copy expand_less const a = document .createElement( 'a' ); a.href = url; a.download = `incident_report_ ${id} .pdf` ; a.click(); URL.revokeObjectURL(url); }} className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" title="Generate and download incident report PDF" Download PDF Report </button> [6] ماذا أصبح لديك الآن (مستوى أدلة رقمية رسمي) [6.1] Chain of Custody صار كامل فعليًا لأننا أضفنا: EVIDENCE_EXPORTED عند تصدير الأدلة JSON INCIDENT_REPORT_PDF_GENERATED عند توليد PDF وهذا يجعل “كل خطوة” ضمن السجل القانوني. [6.2] PDF رسمي جاهز للبلاغات ويشمل: Overview Evidence Summary Custody events وكل ذلك من السيرفر (غير قابل للتلاعب من UI) [7] تحسينات قوية جدًا (المرحلة التالية مباشرة) الآن بعد اكتمال الدليل المؤسسي، سنضيف “أقوى ميزتين” تنافس Bark عالميًا: QR Integrity Stamp داخل PDF QR يحتوي Incident ID + SHA256 list snapshot + timestamp Signed Report Mode توقيع HMAC/Ed25519 للـ PDF metadata (Verification API) [8] Suggested Next Steps [8.1] أضيف الآن Verification API: تدخل Incident ID + Export Hash → يرجع “Verified / Not Verified”. [8.2] أضيف QR داخل PDF (ختم نزاهة) + صفحة Verification داخل لوحة الوالدين. [8.3] ثم نبدأ أقوى جزء: تنفيذ Android الفعلي لأوامر QUARANTINE + BLACKOUT + MIC/CAM BLOCK داخل Child Agent Kotlin مع ACK موقّع.
[140] [1] ## ممتاز — الآن نضيف “Integrity Verification” + “QR Stamp” + “Signed Artifacts” (مستوى مؤسسي عالمي) في هذه المرحلة سنبني طبقة نزاهة (Integrity Layer) تجعل أي Evidence Export / PDF Report: قابل للتحقق (Verified) مرتبط بـ Hash Snapshot مختوم بـ QR داخل التقرير ومسجل بالكامل داخل Chain of Custody الهدف: تحويل نظام الأدلة من “عرض أدلة” إلى Evidence-Grade Platform مثل الأنظمة المؤسسية. [2] لماذا نحتاج طبقة Integrity؟ بدون Integrity Layer، يمكن نظريًا: إعادة توليد Export بنسخة معدّلة (حتى لو نادرًا) أو إرسال PDF خارج النظام بدون وسيلة تحقق واضحة مع Integrity Layer يصبح لديك: Hash ثابت يمثل Snapshot رسمي للأدلة توقيع (Signature/HMAC) من السيرفر Verification API يثبت أن النسخة أصلية QR Stamp داخل PDF يختصر التحقق في ثانية [3] تحديث قاعدة البيانات (Prisma) لإضافة جدول Artifacts (أهم إضافة مؤسسية) [3.1] أضف Model جديد: IncidentArtifact المسار: prisma/schema.prisma أضف هذا الـ Model بالكامل داخل schema: model IncidentArtifact { artifact_id String @id @default(uuid()) family_id String incident_id String artifact_type String // EVIDENCE_EXPORT_JSON | INCIDENT_REPORT_PDF snapshot_sha256 String signature_hmac String file_name String created_at DateTime @default(now()) @@index([family_id, incident_id]) @@index([incident_id, artifact_type]) } [3.2] نفّذ Migration npx prisma migrate dev -n add_incident_artifacts_integrity_layer [4] ملف 1: أدوات التوقيع والتحقق (HMAC + SHA256) المسار: lib/integrity.ts هذا الملف هو قلب النظام: يبني Snapshot Hash + توقيع HMAC مهم: يعتمد على process.env.AMANA_INTEGRITY_SECRET // lib/integrity.ts import crypto from 'crypto'; export type IntegrityPayload = { incident_id: string; artifact_type: string; snapshot_sha256: string; created_at_iso: string; version: number; }; export function sha256Hex(input: string | Buffer) { return crypto.createHash('sha256').update(input).digest('hex'); } export function signHmac(payload: IntegrityPayload, secret: string) { const normalized = JSON.stringify(payload); return crypto.createHmac('sha256', secret).update(normalized).digest('hex'); } export function verifyHmac(payload: IntegrityPayload, signature: string, secret: string) { const expected = signHmac(payload, secret); return timingSafeEqualHex(expected, signature); } function timingSafeEqualHex(a: string, b: string) { try { const ba = Buffer.from(a, 'hex'); const bb = Buffer.from(b, 'hex'); if (ba.length !== bb.length) return false; return crypto.timingSafeEqual(ba, bb); } catch { return false; } } export function requireIntegritySecret() { const secret = process.env.AMANA_INTEGRITY_SECRET; if (!secret || secret.length < 32) { // لا نكشف تفاصيل كثيرة للمهاجمين throw new Error('Integrity secret is not configured'); } return secret; } [5] ملف 2: Artifact Builder (يبني Snapshot رسمي للأدلة) المسار: lib/artifacts.ts Snapshot Hash سيعتمد على: Incident metadata Evidence list (بشكل ثابت ومرتب) Custody events الأساسية (اختياري الآن، سنضيفه لاحقًا بسهولة) // lib/artifacts.ts import { prisma } from '@/lib/prisma'; import { sha256Hex } from '@/lib/integrity'; export async function buildEvidenceSnapshotSha256(incident_id: string) { const incident = await prisma.incident.findUnique({ where: { incident_id }, select: { incident_id: true, family_id: true, child_id: true, device_id: true, incident_type: true, severity: true, status: true, legal_hold: true, created_at: true, updated_at: true, } as any, }); if (!incident) { throw new Error('Incident not found'); } const evidence = await prisma.evidence.findMany({ where: { incident_id }, orderBy: { created_at: 'asc' }, select: { evidence_id: true, content_type: true, severity: true, classification: true, summary: true, sha256: true, tags: true, created_at: true, object_uri: true, }, take: 5000, }); // Normalize (VERY IMPORTANT): stable ordering + stable fields const normalized = { v: 1, incident: { incident_id: incident.incident_id, family_id: incident.family_id, child_id: incident.child_id, device_id: incident.device_id, incident_type: incident.incident_type, severity: incident.severity, status: incident.status, legal_hold: Boolean((incident as any).legal_hold), created_at: new Date((incident as any).created_at).toISOString(), updated_at: new Date((incident as any).updated_at).toISOString(), }, evidence: evidence.map((e) => ({ evidence_id: e.evidence_id, content_type: e.content_type, severity: e.severity, classification: e.classification, summary: e.summary, sha256: e.sha256, tags: Array.isArray(e.tags) ? e.tags.slice().sort() : [], created_at: new Date(e.created_at).toISOString(), link_state: e.object_uri ? 'linked' : 'no-link', })), }; const json = JSON.stringify(normalized); return { family_id: incident.family_id, snapshot_sha256: sha256Hex(json), normalized_json: normalized, }; } [6] ملف 3: Evidence Export API (مُوقع + Artifact DB + AuditLog) المسار: app/api/incidents/[id]/export-evidence/route.ts استبدل الملف كاملًا بهذا الإصدار (نسخة Integrity كاملة) // app/api/incidents/[id]/export-evidence/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { buildEvidenceSnapshotSha256 } from '@/lib/artifacts'; import { IntegrityPayload, requireIntegritySecret, signHmac } from '@/lib/integrity'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const incident = await prisma.incident.findUnique({ where : { incident_id }, select : { incident_id : true , family_id : true } as any , }); if (!incident) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, incident.family_id)) throw new HttpError( 403 , 'Forbidden' ); const { family_id, snapshot_sha256, normalized_json } = await buildEvidenceSnapshotSha256(incident_id); const payload: IntegrityPayload = { incident_id, artifact_type : 'EVIDENCE_EXPORT_JSON' , snapshot_sha256, created_at_iso : new Date ().toISOString(), version : 1 , }; const secret = requireIntegritySecret(); const signature_hmac = signHmac(payload, secret); const file_name = `evidence_ ${incident_id} .json` ; const artifact = await prisma.incidentArtifact.create({ data : { family_id, incident_id, artifact_type : payload.artifact_type, snapshot_sha256, signature_hmac, file_name, }, select : { artifact_id : true , artifact_type : true , snapshot_sha256 : true , signature_hmac : true , created_at : true , }, }); await prisma.auditLog.create({ data : { family_id, actor_user_id : principal.principal_id, event_key : 'EVIDENCE_EXPORTED' , event_json : { incident_id, artifact_id : artifact.artifact_id, snapshot_sha256, signature_hmac, export_version : 1 , }, }, }); const exportJson = { exported_at : payload.created_at_iso, export_version : 1 , integrity : { artifact_id : artifact.artifact_id, snapshot_sha256, signature_hmac, payload, }, snapshot : normalized_json, }; const json = JSON .stringify(exportJson, null , 2 ); return new NextResponse(json, { status : 200 , headers : { 'Content-Type' : 'application/json; charset=utf-8' , 'Content-Disposition' : `attachment; filename=" ${file_name} "` , 'Cache-Control' : 'no-store' , }, }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [7] ملف 4: Verification API (تحقق من أي Artifact) المسار: app/api/incidents/[id]/verify/route.ts هذه نقطة القوة: تدخل artifact_id → يرجع Verified / Not Verified // app/api/incidents/[id]/verify/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { IntegrityPayload, requireIntegritySecret, verifyHmac } from '@/lib/integrity'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "artifact_id": "..." } */ export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; const incident = await prisma.incident.findUnique({ where: { incident_id }, select: { incident_id: true, family_id: true } as any, }); if (!incident) throw new HttpError(404, 'Incident not found'); if (!requireFamilyAccess(principal, incident.family_id)) throw new HttpError(403, 'Forbidden'); const body = await req.json().catch(() => ({})); const artifact_id = String(body?.artifact_id || '').trim(); if (!artifact_id) throw new HttpError(400, 'artifact_id is required'); const artifact = await prisma.incidentArtifact.findUnique({ where: { artifact_id }, select: { artifact_id: true, family_id: true, incident_id: true, artifact_type: true, snapshot_sha256: true, signature_hmac: true, created_at: true, file_name: true, }, }); if (!artifact) throw new HttpError(404, 'Artifact not found'); if (artifact.family_id !== incident.family_id) throw new HttpError(403, 'Forbidden'); if (artifact.incident_id !== incident_id) throw new HttpError(400, 'Artifact does not belong to this incident'); const payload: IntegrityPayload = { incident_id: artifact.incident_id, artifact_type: artifact.artifact_type, snapshot_sha256: artifact.snapshot_sha256, created_at_iso: new Date(artifact.created_at).toISOString(), version: 1, }; const secret = requireIntegritySecret(); const ok = verifyHmac(payload, artifact.signature_hmac, secret); await prisma.auditLog.create({ data: { family_id: artifact.family_id, actor_user_id: principal.principal_id, event_key: 'ARTIFACT_VERIFIED', event_json: { incident_id, artifact_id, ok, artifact_type: artifact.artifact_type, }, }, }); return NextResponse.json( { ok: true, verified: ok, artifact: { artifact_id: artifact.artifact_id, artifact_type: artifact.artifact_type, snapshot_sha256: artifact.snapshot_sha256, signature_hmac: artifact.signature_hmac, created_at: payload.created_at_iso, file_name: artifact.file_name, }, payload, }, { status: 200 } ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [8] إضافة QR Stamp داخل PDF Report (مختوم بالتحقق) [8.1] تثبيت مكتبة QR npm i qrcode [8.2] ملف 5: PDF Report API مُحسّن مع QR + Artifact DB + Signature المسار: app/api/incidents/[id]/report/pdf/route.ts استبدل الملف كاملًا بهذا الإصدار. يضيف: snapshot_sha256 signature_hmac artifact record QR داخل التقرير يحتوي artifact_id + snapshot_sha256 // app/api/incidents/[id]/report/pdf/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { PDFDocument, StandardFonts, rgb } from 'pdf-lib'; import QRCode from 'qrcode'; import { buildEvidenceSnapshotSha256 } from '@/lib/artifacts'; import { IntegrityPayload, requireIntegritySecret, signHmac } from '@/lib/integrity'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function fmt(iso: string | Date) { const d = typeof iso === 'string' ? new Date(iso) : iso; return d.toISOString().replace('T', ' ').slice(0, 19) + 'Z'; } function wrapText(text: string, maxChars: number) { const s = String(text || '').replace(/\s+/g, ' ').trim(); if (!s) return ['-']; const words = s.split(' '); const lines: string[] = []; let line = ''; for (const w of words) { const test = line ? ${line} ${w} : w; if (test.length <= maxChars) line = test; else { if (line) lines.push(line); line = w; } } if (line) lines.push(line); return lines.slice(0, 80); } const CUSTODY_KEYS = [ 'EVIDENCE_CREATED', 'EVIDENCE_UPDATED', 'EVIDENCE_REDACTED', 'EVIDENCE_EXPORTED', 'COMMAND_QUEUED', 'COMMAND_ACK', 'EMERGENCY_LOCKDOWN_TRIGGERED', 'INCIDENT_LEGAL_HOLD_ENABLED', 'INCIDENT_LEGAL_HOLD_DISABLED', 'ARTIFACT_VERIFIED', ]; export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const incident = await prisma.incident.findUnique({ where : { incident_id }, select : { incident_id : true , family_id : true , child_id : true , device_id : true , incident_type : true , severity : true , status : true , legal_hold : true , created_at : true , updated_at : true , } as any , }); if (!incident) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, incident.family_id)) throw new HttpError( 403 , 'Forbidden' ); // Build snapshot hash (official snapshot) const { family_id, snapshot_sha256 } = await buildEvidenceSnapshotSha256(incident_id); const payload: IntegrityPayload = { incident_id, artifact_type : 'INCIDENT_REPORT_PDF' , snapshot_sha256, created_at_iso : new Date ().toISOString(), version : 1 , }; const secret = requireIntegritySecret(); const signature_hmac = signHmac(payload, secret); const file_name = `incident_report_ ${incident_id} .pdf` ; const artifact = await prisma.incidentArtifact.create({ data : { family_id, incident_id, artifact_type : payload.artifact_type, snapshot_sha256, signature_hmac, file_name, }, select : { artifact_id : true , artifact_type : true , snapshot_sha256 : true , signature_hmac : true , created_at : true , }, }); const evidence = await prisma.evidence.findMany({ where : { incident_id }, orderBy : { created_at : 'desc' }, select : { evidence_id : true , content_type : true , severity : true , classification : true , summary : true , sha256 : true , tags : true , created_at : true , object_uri : true , }, take : 30 , }); const audits = await prisma.auditLog.findMany({ where : { family_id : incident.family_id, event_key : { in : CUSTODY_KEYS }, }, orderBy : { created_at : 'desc' }, take : 200 , select : { audit_id : true , actor_user_id : true , event_key : true , event_json : true , created_at : true , }, }); const custody = audits.filter( ( x ) => { const j: any = x.event_json || {}; return j?.incident_id === incident_id || j?.incident?.incident_id === incident_id; }); // QR content const qrData = { v : 1 , incident_id, artifact_id : artifact.artifact_id, artifact_type : artifact.artifact_type, snapshot_sha256, signature_hmac, created_at : payload.created_at_iso, }; const qrPngDataUrl = await QRCode.toDataURL( JSON .stringify(qrData), { margin : 1 , scale : 6 , errorCorrectionLevel : 'M' , }); const qrBase64 = qrPngDataUrl.split( ',' )[ 1 ]; const qrBytes = Buffer.from(qrBase64, 'base64' ); // Create PDF const pdf = await PDFDocument.create(); const font = await pdf.embedFont(StandardFonts.Helvetica); const fontBold = await pdf.embedFont(StandardFonts.HelveticaBold); const page = pdf.addPage([ 595.28 , 841.89 ]); // A4 const { width, height } = page.getSize(); const margin = 40 ; let y = height - margin; const qrImage = await pdf.embedPng(qrBytes); function drawTitle ( text: string ) { page.drawText(text, { x : margin, y, size : 16 , font : fontBold, color : rgb( 0.1 , 0.1 , 0.1 ) }); y -= 22 ; } function drawH ( text: string ) { page.drawText(text, { x : margin, y, size : 12 , font : fontBold, color : rgb( 0.15 , 0.15 , 0.15 ) }); y -= 16 ; } function drawLine ( text: string ) { const lines = wrapText(text, 95 ); for ( const ln of lines) { if (y < margin + 60 ) break ; page.drawText(ln, { x : margin, y, size : 10 , font, color : rgb( 0.2 , 0.2 , 0.2 ) }); y -= 13 ; } } // Header + QR stamp drawTitle( 'AMANA — Incident Report (Integrity Sealed)' ); drawLine( `Generated at: ${fmt( new Date ())} ` ); drawLine( `Actor: ${ String (principal?.principal_id || 'unknown' )} ` ); // Draw QR on top-right const qrSize = 110 ; page.drawImage(qrImage, { x : width - margin - qrSize, y : height - margin - qrSize + 10 , width : qrSize, height : qrSize, }); page.drawText( 'Scan to verify' , { x : width - margin - qrSize, y : height - margin - qrSize - 4 , size : 9 , font : font, color : rgb( 0.25 , 0.25 , 0.25 ), }); y -= 8 ; drawH( 'Integrity Stamp' ); drawLine( `Artifact ID: ${artifact.artifact_id} ` ); drawLine( `Snapshot SHA256: ${snapshot_sha256} ` ); drawLine( `Signature (HMAC): ${signature_hmac.slice( 0 , 28 )} ...` ); y -= 8 ; drawH( 'Incident Overview' ); drawLine( `Incident ID: ${(incident as any ).incident_id} ` ); drawLine( `Type: ${(incident as any ).incident_type} ` ); drawLine( `Severity: ${(incident as any ).severity} ` ); drawLine( `Status: ${(incident as any ).status} ` ); drawLine( `Legal Hold: ${(incident as any ).legal_hold ? 'ENABLED' : 'DISABLED' } ` ); drawLine( `Child ID: ${(incident as any ).child_id} ` ); drawLine( `Device ID: ${(incident as any ).device_id} ` ); drawLine( `Created: ${fmt((incident as any ).created_at)} ` ); drawLine( `Updated: ${fmt((incident as any ).updated_at)} ` ); y -= 8 ; drawH( 'Evidence Summary (latest 30)' ); if (evidence.length === 0 ) { drawLine( '- No evidence items.' ); } else { for ( const e of evidence) { const sha = String (e.sha256 || '' ).slice( 0 , 12 ); const redacted = e.object_uri ? '' : ' [REDACTED_LINK]' ; drawLine( `• ${fmt(e.created_at)} | ${e.content_type} | ${e.severity} | ${e.classification} | SHA: ${sha} … ${redacted} ` ); drawLine( ` Summary: ${e.summary} ` ); const tags = Array .isArray(e.tags) ? e.tags.join( ', ' ) : '' ; if (tags) drawLine( ` Tags: ${tags} ` ); y -= 4 ; if (y < margin + 90 ) break ; } } y -= 6 ; drawH( 'Chain of Custody (latest 200 matching this incident)' ); if (custody.length === 0 ) { drawLine( '- No custody events recorded yet.' ); } else { for ( const c of custody) { const actor = String (c.actor_user_id || '' ).slice( 0 , 10 ); drawLine( `• ${fmt(c.created_at)} | ${c.event_key} | actor: ${actor} …` ); const j = c.event_json || {}; const compact = JSON .stringify(j).slice( 0 , 220 ); drawLine( ` data: ${compact} ${compact.length >= 220 ? '…' : '' } ` ); y -= 3 ; if (y < margin + 70 ) break ; } } // Custody: record PDF generation await prisma.auditLog.create({ data : { family_id : incident.family_id, actor_user_id : principal.principal_id, event_key : 'INCIDENT_REPORT_PDF_GENERATED' , event_json : { incident_id, artifact_id : artifact.artifact_id, snapshot_sha256, signature_hmac, evidence_included : evidence.length, custody_included : custody.length, }, }, }); const bytes = await pdf.save(); return new NextResponse(bytes, { status : 200 , headers : { 'Content-Type' : 'application/pdf' , 'Content-Disposition' : `attachment; filename=" ${file_name} "` , 'Cache-Control' : 'no-store' , }, }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [9] ملف 6: صفحة Verification UI داخل لوحة الوالدين المسار: app/dashboard/incidents/[id]/verify/page.tsx هذه الصفحة تسمح للوالد: إدخال artifact_id ضغط Verify عرض Verified / Not Verified // app/dashboard/incidents/[id]/verify/page.tsx 'use client'; import Link from 'next/link'; import { useState } from 'react'; import { apiJson } from '@/lib/api-client'; import { Card, EmptyState, Pill } from '@/components/ui-kit'; import { ArrowLeft, ShieldCheck, ShieldX } from 'lucide-react'; export default function VerifyArtifactPage({ params }: { params: { id: string } }) { const incidentId = params.id; const [artifactId, setArtifactId] = useState(''); const [result, setResult] = useState <any> (null); const [loading, setLoading] = useState(false); async function verify() { setLoading(true); setResult(null); try { const r = await apiJson( /api/incidents/${incidentId}/verify , { method: 'POST', json: { artifact_id: artifactId.trim() }, }); setResult(r); } finally { setLoading(false); } } return ( <div className="mx-auto w-full max-w-4xl space-y-4 p-4"> <div className="flex items-center justify-between gap-2"> <Link href={ /dashboard/incidents/${incidentId} } className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > <ArrowLeft className="h-4 w-4" /> Back to Incident </Link> </div> code Code download content_copy expand_less < Card title = "Artifact Verification" subtitle = "Verify integrity of exported evidence or PDF reports" > < div className = "space-y-3" > < div > < div className = "text-xs font-semibold text-gray-700" > Artifact ID </ div > < input value = {artifactId} onChange = {(e) => setArtifactId(e.target.value)} placeholder="Paste artifact_id from JSON export or PDF report" className="mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none focus:border-gray-400" /> </ div > < button onClick = {verify} disabled = {loading || ! artifactId.trim ()} className = "rounded-xl bg-gray-900 px-4 py-2 text-sm font-semibold text-white hover:bg-black disabled:opacity-50" > {loading ? 'Verifying…' : 'Verify'} </ button > {!result ? ( < EmptyState title = "No verification result yet" desc = "Enter an artifact_id and click Verify." /> ) : ( < div className = "rounded-2xl border border-gray-200 bg-white p-3" > < div className = "flex flex-wrap items-center gap-2" > {result?.verified ? ( <> < Pill text = "VERIFIED" className = "bg-emerald-50 text-emerald-700 border-emerald-100" /> < ShieldCheck className = "h-4 w-4 text-emerald-700" /> </> ) : ( <> < Pill text = "NOT VERIFIED" className = "bg-rose-50 text-rose-700 border-rose-100" /> < ShieldX className = "h-4 w-4 text-rose-700" /> </> )} </ div > < div className = "mt-2 text-xs text-gray-700" > < div > < span className = "font-semibold" > Type: </ span > {result?.artifact?.artifact_type} </ div > < div > < span className = "font-semibold" > Snapshot SHA256: </ span > {result?.artifact?.snapshot_sha256} </ div > < div > < span className = "font-semibold" > Created: </ span > {result?.artifact?.created_at} </ div > </ div > < details className = "mt-3" > < summary className = "cursor-pointer text-xs font-semibold text-gray-700" > View verification payload </ summary > < pre className = "mt-2 max-h-72 overflow-auto rounded-xl border border-gray-200 bg-gray-50 p-3 text-xs text-gray-800" > {JSON.stringify(result, null, 2)} </pre> </details> </div> )} </div> </Card> </div> ); } [10] ربط صفحة Incident Details بزر “Verify” أضف رابط داخل شريط الأزرار العلوي في: app/dashboard/incidents/[id]/page.tsx <Link href={`/dashboard/incidents/${id}/verify`} className="inline-flex items-center gap-2 rounded-xl border border-gray-200 bg-white px-3 py-2 text-xs font-semibold text-gray-900 hover:bg-gray-50" > Verify Report / Export </Link> [11] إعداد متغير البيئة المطلوب (ضروري) داخل .env أو إعدادات Vercel: AMANA_INTEGRITY_SECRET=CHANGE_THIS_TO_A_LONG_RANDOM_SECRET_AT_LEAST_32_CHARS [12] ما الذي أصبح لديك الآن؟ [12.1] Evidence Export Signed snapshot_sha256 signature_hmac artifact_id مسجل في DB سجل Custody عند التصدير [12.2] PDF Report Signed + QR Stamp QR يحتوي artifact_id + snapshot_sha256 + signature يمكن للوالد التحقق عبر Verification Page [12.3] Verification API رسمي يقرر Verified/Not Verified بشكل خادمي لا يعتمد على UI [13] المرحلة التالية (الأقوى: حماية الأوامر مع ACK مُوقع من جهاز الطفل) الآن سنبني “Command Integrity”: كل أمر دفاعي يخرج من السيرفر بتوقيع HMAC Child Agent لا ينفّذ إلا الأوامر الموقعة عند التنفيذ يرسل ACK موقّع للجهاز كل ACK يسجل في Custody كدليل تنفيذ هذا يجعل “Emergency Lockdown” ليس مجرد أمر… بل أمر مُثبت التنفيذ. [14] Suggested Next Steps [14.1] أضيف الآن Signed Commands Protocol (server signature + client verify + signed ACK). [14.2] أضيف Device Attestation Lite (ربط token الجهاز + rotation + anti-replay nonce). [14.3] بعدها نبدأ تنفيذ Android فعليًا: BLACKOUT overlay + QUARANTINE firewall + mic/cam block مع ACK مؤسسّي.
[141] [1] ## ممتاز — الآن ندخل أقوى طبقة في النظام: “Signed Commands + Signed ACK + Anti-Replay” (تنفيذ دفاعي مُثبت قانونيًا) الآن سنبني الجزء الذي يجعل منصتك أقوى من Bark فعليًا في “الدفاع الآلي”: السيرفر لا يرسل أوامر دفاع إلا موقعة تطبيق الطفل لا ينفّذ إلا أوامر موقعة وصحيحة وغير معاد تشغيلها تطبيق الطفل بعد التنفيذ يرسل ACK مُوقع كل ذلك يدخل في Chain of Custody كسجل “تم التنفيذ فعلاً” النتيجة: عندما تقول المنصة “تم قفل الجهاز / تم حظر التطبيق” يصبح هذا دليل تنفيذ مؤسسي وليس مجرد “محاولة”. [2] تصميم بروتوكول Signed Commands (مختصر عملي) [2.1] العناصر الأساسية Command Envelope (غلاف الأمر) command_id UUID device_id incident_id (اختياري) command_type (BLACKOUT / QUARANTINE / BLOCK_APP / MIC_OFF …) payload (JSON) nonce رقم عشوائي قوي issued_at expires_at signature_hmac Anti-Replay كل أمر يحمل nonce الجهاز يحتفظ بآخر N nonces منفذة أي nonce مكرر → رفض + تسجيل State Machine للأمر QUEUED → DELIVERED → ACKED أو FAILED أو EXPIRED مفتاح التوقيع الأفضل: Device Shared Key فريد لكل جهاز (مفتاح متماثل Symmetric) لا تستخدم Secret عام لكل الأجهزة [3] تحديث قاعدة البيانات (Prisma) لإضافة جداول الأوامر والمفاتيح [3.1] أضف Models جديدة داخل prisma/schema.prisma أضف هذا بالكامل: model DeviceKey { device_id String @id family_id String key_version Int @default(1) shared_key_b64 String // base64 symmetric key (32 bytes recommended) created_at DateTime @default(now()) rotated_at DateTime? @@index([family_id]) } model DeviceCommand { command_id String @id @default(uuid()) family_id String device_id String incident_id String? command_type String // BLACKOUT | QUARANTINE | BLOCK_APP | MIC_OFF | CAM_OFF | WALKIE_TALKIE ... payload_json Json nonce String issued_at DateTime @default(now()) expires_at DateTime status String @default("QUEUED") // QUEUED | DELIVERED | ACKED | FAILED | EXPIRED signature_hmac String delivered_at DateTime? acked_at DateTime? ack_json Json? ack_signature String? @@index([family_id, device_id]) @@index([device_id, status]) @@index([incident_id]) } [3.2] Migration npx prisma migrate dev -n add_signed_device_commands [4] ملف 1: مكتبة توقيع الأوامر والتحقق (HMAC + Canonical JSON) المسار: lib/command-signing.ts هذا الملف مهم لأنه يضمن أن التوقيع ثابت ولا يتغير بسبب ترتيب JSON // lib/command-signing.ts import crypto from 'crypto'; export type CommandEnvelope = { command_id: string; device_id: string; incident_id?: string | null; command_type: string; payload: any; nonce: string; issued_at_iso: string; expires_at_iso: string; version: number; }; export type AckEnvelope = { command_id: string; device_id: string; status: 'ACKED' | 'FAILED'; executed_at_iso: string; result: any; // minimal (no sensitive data) nonce: string; // reuse or separate ack_nonce version: number; }; export function hmacHex(data: string, keyB64: string) { const key = Buffer.from(keyB64, 'base64'); return crypto.createHmac('sha256', key).update(data).digest('hex'); } /** Canonical stringify: sorts object keys recursively stable across runtimes */ export function canonicalStringify(obj: any): string { return JSON.stringify(sortDeep(obj)); } function sortDeep(x: any): any { if (Array.isArray(x)) return x.map(sortDeep); if (x && typeof x === 'object') { const keys = Object.keys(x).sort(); const out: any = {}; for (const k of keys) out[k] = sortDeep(x[k]); return out; } return x; } export function signCommand(envelope: CommandEnvelope, deviceKeyB64: string) { const canonical = canonicalStringify(envelope); return hmacHex(canonical, deviceKeyB64); } export function verifyCommand(envelope: CommandEnvelope, signature: string, deviceKeyB64: string) { const expected = signCommand(envelope, deviceKeyB64); return timingSafeEqualHex(expected, signature); } export function signAck(ack: AckEnvelope, deviceKeyB64: string) { const canonical = canonicalStringify(ack); return hmacHex(canonical, deviceKeyB64); } export function verifyAck(ack: AckEnvelope, signature: string, deviceKeyB64: string) { const expected = signAck(ack, deviceKeyB64); return timingSafeEqualHex(expected, signature); } function timingSafeEqualHex(a: string, b: string) { try { const ba = Buffer.from(a, 'hex'); const bb = Buffer.from(b, 'hex'); if (ba.length !== bb.length) return false; return crypto.timingSafeEqual(ba, bb); } catch { return false; } } [5] ملف 2: Command Service لإنشاء أمر موقع + إدخاله DB المسار: lib/commands.ts // lib/commands.ts import crypto from 'crypto'; import { prisma } from '@/lib/prisma'; import { CommandEnvelope, signCommand } from '@/lib/command-signing'; export function randomNonce() { return crypto.randomBytes(16).toString('hex'); // 32 chars } export async function getDeviceKeyB64(device_id: string) { const k = await prisma.deviceKey.findUnique({ where: { device_id }, select: { shared_key_b64: true, family_id: true, key_version: true }, }); if (!k) throw new Error('Device key not found'); return k; } /** Create signed command and store in DB. expiresInSec default 120 seconds */ export async function createSignedDeviceCommand(args: { device_id: string; incident_id?: string | null; command_type: string; payload: any; expiresInSec?: number; }) { const expiresInSec = Math.max(15, Math.min(600, args.expiresInSec ?? 120)); const nonce = randomNonce(); const key = await getDeviceKeyB64(args.device_id); const now = new Date(); const expires = new Date(now.getTime() + expiresInSec * 1000); // command_id generated by DB (uuid default) OR we can pre-generate // We'll generate here to also include it in signature const command_id = crypto.randomUUID(); const envelope: CommandEnvelope = { command_id, device_id: args.device_id, incident_id: args.incident_id ?? null, command_type: args.command_type, payload: args.payload ?? {}, nonce, issued_at_iso: now.toISOString(), expires_at_iso: expires.toISOString(), version: 1, }; const signature_hmac = signCommand(envelope, key.shared_key_b64); const row = await prisma.deviceCommand.create({ data: { command_id, family_id: key.family_id, device_id: args.device_id, incident_id: args.incident_id ?? null, command_type: args.command_type, payload_json: args.payload ?? {}, nonce, issued_at: now, expires_at: expires, status: 'QUEUED', signature_hmac, }, select: { command_id: true, family_id: true, device_id: true, incident_id: true, command_type: true, payload_json: true, nonce: true, issued_at: true, expires_at: true, status: true, signature_hmac: true, }, }); return { row, envelope, signature_hmac }; } [6] ملف 3: API لإرسال أمر دفاعي (من لوحة الوالدين أو النظام الآلي) المسار: app/api/devices/[id]/commands/push/route.ts هذا Endpoint يستدعي createSignedDeviceCommand() ويمكن ربطه لاحقًا بـ “Decision Engine” (الذكاء الدفاعي) // app/api/devices/[id]/commands/push/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { createSignedDeviceCommand } from '@/lib/commands'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "incident_id": "optional", "command_type": "BLACKOUT", "payload": { ... }, "expiresInSec": 120 } */ export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const device_id = ctx.params.id; const body = await req.json().catch(() => ({})); const incident_id = body?.incident_id ? String(body.incident_id) : null; const command_type = String(body?.command_type || '').trim(); const payload = body?.payload ?? {}; const expiresInSec = Number(body?.expiresInSec ?? 120); if (!command_type) throw new HttpError(400, 'command_type is required'); // device must exist + family access const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (!requireFamilyAccess(principal, device.family_id)) throw new HttpError(403, 'Forbidden'); const { row, envelope, signature_hmac } = await createSignedDeviceCommand({ device_id, incident_id, command_type, payload, expiresInSec, }); await prisma.auditLog.create({ data: { family_id: device.family_id, actor_user_id: principal.principal_id, event_key: 'COMMAND_QUEUED', event_json: { device_id, incident_id, command_id: row.command_id, command_type, expires_at: row.expires_at, }, }, }); return NextResponse.json( { ok: true, command: { command_id: row.command_id, device_id: row.device_id, incident_id: row.incident_id, command_type: row.command_type, payload: row.payload_json, nonce: row.nonce, issued_at: row.issued_at, expires_at: row.expires_at, signature_hmac, version: 1, }, envelope, }, { status: 200 } ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } ملاحظة: هذا يفترض وجود Model device بالفعل في مشروعك (Device table). إذا كان اسم الجدول مختلفًا عندك، استبدله فقط دون تغيير المنطق. [7] ملف 4: API لسحب الأوامر من جهاز الطفل (Pull) المسار: app/api/devices/[id]/commands/pull/route.ts فكرة Pull: تطبيق الطفل يسأل كل 1–2 ثانية (أو عبر FCM لاحقًا) ويأخذ: الأوامر QUEUED ثم يتم تحديثها إلى DELIVERED ويرجع Envelope + Signature // app/api/devices/[id]/commands/pull/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** Auth for child-agent should be device token. Expect header: x-device-token: <device_token> This example uses a device table field device_token . If your project uses another auth, adapt here without changing business logic. */ async function requireDeviceAuth(req: NextRequest, device_id: string) { const token = req.headers.get('x-device-token') || ''; if (!token) throw new HttpError(401, 'Missing device token'); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, device_token: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (device.device_token !== token) throw new HttpError(401, 'Invalid device token'); return device; } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const device_id = ctx.params.id; const device = await requireDeviceAuth(req, device_id); code Code download content_copy expand_less const now = new Date (); // Expire old queued commands await prisma.deviceCommand.updateMany({ where : { device_id, status : { in : [ 'QUEUED' , 'DELIVERED' ] }, expires_at : { lt : now }, }, data : { status : 'EXPIRED' }, }); // Get next command const cmd = await prisma.deviceCommand.findFirst({ where : { device_id, status : 'QUEUED' , expires_at : { gt : now }, }, orderBy : { issued_at : 'asc' }, select : { command_id : true , incident_id : true , command_type : true , payload_json : true , nonce : true , issued_at : true , expires_at : true , signature_hmac : true , }, }); if (!cmd) { return NextResponse.json({ ok : true , command : null }, { status : 200 }); } // Mark as delivered await prisma.deviceCommand.update({ where : { command_id : cmd.command_id }, data : { status : 'DELIVERED' , delivered_at : new Date () }, }); await prisma.auditLog.create({ data : { family_id : device.family_id, actor_user_id : `device: ${device_id} ` , event_key : 'COMMAND_DELIVERED' , event_json : { device_id, command_id : cmd.command_id, command_type : cmd.command_type, }, }, }); // Return envelope as the device expects (same fields used in signing) const envelope = { command_id : cmd.command_id, device_id, incident_id : cmd.incident_id ?? null , command_type : cmd.command_type, payload : cmd.payload_json, nonce : cmd.nonce, issued_at_iso : new Date (cmd.issued_at).toISOString(), expires_at_iso : new Date (cmd.expires_at).toISOString(), version : 1 , }; return NextResponse.json( { ok : true , command : envelope, signature_hmac : cmd.signature_hmac, }, { status : 200 } ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [8] ملف 5: API لاستلام ACK مُوقع من جهاز الطفل المسار: app/api/devices/[id]/commands/ack/route.ts الجهاز يرسل ACK بعد التنفيذ السيرفر يتحقق من التوقيع باستخدام DeviceKey يسجل Custody داخل AuditLog // app/api/devices/[id]/commands/ack/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { HttpError } from '@/lib/auth'; import { verifyAck, canonicalStringify } from '@/lib/command-signing'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } async function requireDeviceAuth(req: NextRequest, device_id: string) { const token = req.headers.get('x-device-token') || ''; if (!token) throw new HttpError(401, 'Missing device token'); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, device_token: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (device.device_token !== token) throw new HttpError(401, 'Invalid device token'); return device; } /** POST body: { "ack": { code Code download content_copy expand_less "command_id" : "..." , code Code download content_copy expand_less "device_id" : "..." , code Code download content_copy expand_less "status" : "ACKED" | "FAILED" , code Code download content_copy expand_less "executed_at_iso" : "..." , code Code download content_copy expand_less "result" : {...}, code Code download content_copy expand_less "nonce" : "..." , code Code download content_copy expand_less "version" : 1 }, "ack_signature": "hex" } */ export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const device_id = ctx.params.id; const device = await requireDeviceAuth(req, device_id); const body = await req.json().catch(() => ({})); const ack = body?.ack; const ack_signature = String(body?.ack_signature || '').trim(); if (!ack || !ack_signature) throw new HttpError(400, 'ack and ack_signature are required'); if (String(ack.device_id) !== device_id) throw new HttpError(400, 'ack.device_id mismatch'); const cmd = await prisma.deviceCommand.findUnique({ where: { command_id: String(ack.command_id) }, select: { command_id: true, family_id: true, device_id: true, incident_id: true, command_type: true, nonce: true, status: true, }, }); if (!cmd) throw new HttpError(404, 'Command not found'); if (cmd.device_id !== device_id) throw new HttpError(403, 'Forbidden'); if (cmd.family_id !== device.family_id) throw new HttpError(403, 'Forbidden'); // Anti-replay minimal check: ack nonce must match cmd nonce (strict mode) if (String(ack.nonce) !== cmd.nonce) throw new HttpError(409, 'ACK nonce mismatch'); const key = await prisma.deviceKey.findUnique({ where: { device_id }, select: { shared_key_b64: true }, }); if (!key) throw new HttpError(500, 'Device key missing'); const ok = verifyAck(ack, ack_signature, key.shared_key_b64); if (!ok) throw new HttpError(401, 'Invalid ACK signature'); // Update command state await prisma.deviceCommand.update({ where: { command_id: cmd.command_id }, data: { status: ack.status === 'ACKED' ? 'ACKED' : 'FAILED', acked_at: new Date(), ack_json: ack, ack_signature, }, }); await prisma.auditLog.create({ data: { family_id: device.family_id, actor_user_id: device:${device_id} , event_key: 'COMMAND_ACK', event_json: { device_id, command_id: cmd.command_id, incident_id: cmd.incident_id, command_type: cmd.command_type, status: ack.status, ack_preview: canonicalStringify(ack).slice(0, 500), }, }, }); return NextResponse.json({ ok: true, verified: true }, { status: 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [9] تطبيق الطفل (Kotlin) — سحب الأمر + تحقق التوقيع + تنفيذ + إرسال ACK [9.1] ملف Kotlin كامل جاهز للنسخ المسار المقترح: app/src/main/java/com/amana/childagent/security/SignedCommandClient.kt هذا الملف ينفّذ: Pull command Verify signature Anti-Replay بسيط (ذاكرة محلية) Execute (Stub الآن) Send signed ACK package com.amana.childagent.security import android.content.Context import android.util.Base64 import kotlinx.serialization.Serializable import kotlinx.serialization.encodeToString import kotlinx.serialization.json.Json import okhttp3.MediaType.Companion.toMediaType import okhttp3.OkHttpClient import okhttp3.Request import okhttp3.RequestBody.Companion.toRequestBody import java.security.MessageDigest import javax.crypto.Mac import javax.crypto.spec.SecretKeySpec import java.util.concurrent.TimeUnit object SignedCommandClient { code Code download content_copy expand_less private const val JSON_CT = "application/json; charset=utf-8" private val JSON_MEDIA = JSON_CT.toMediaType() private val json = Json { ignoreUnknownKeys = true isLenient = true encodeDefaults = true } private val http = OkHttpClient.Builder() .callTimeout( 10 , TimeUnit.SECONDS) .connectTimeout( 7 , TimeUnit.SECONDS) .readTimeout( 10 , TimeUnit.SECONDS) .build() /** * You MUST store these securely: * - deviceId * - deviceToken * - deviceSharedKeyB64 (32 bytes) */ data class DeviceSecrets ( val deviceId: String, val deviceToken: String, val deviceSharedKeyB64: String, val baseUrl: String // e.g. https://YOUR_DOMAIN ) @Serializable data class CommandEnvelope ( val command_id: String, val device_id: String, val incident_id: String? = null , val command_type: String, val payload: kotlinx.serialization.json.JsonElement, val nonce: String, val issued_at_iso: String, val expires_at_iso: String, val version: Int = 1 ) @Serializable data class PullResponse ( val ok: Boolean , val command: CommandEnvelope? = null , val signature_hmac: String? = null ) @Serializable data class AckEnvelope ( val command_id: String, val device_id: String, val status: String, // "ACKED" or "FAILED" val executed_at_iso: String, val result: kotlinx.serialization.json.JsonElement, val nonce: String, val version: Int = 1 ) @Serializable data class AckRequest ( val ack: AckEnvelope, val ack_signature: String ) /** * Anti-replay cache (simple in-memory). * In production, persist it in encrypted storage with a bounded size. */ private val recentNonces = LinkedHashSet<String>() private fun rememberNonce (nonce: String ) { if (recentNonces.contains(nonce)) return recentNonces.add(nonce) // keep last 128 while (recentNonces.size > 128 ) { val first = recentNonces.first() recentNonces.remove(first) } } private fun hasNonce (nonce: String ) : Boolean = recentNonces.contains(nonce) private fun canonicalStringify (obj: Any ) : String { // Kotlin side: we rely on stable serialization from kotlinx with encodeDefaults + known order // For strict canonical parity, keep server+client fields identical and minimal. return json.encodeToString(obj) } private fun hmacHex ( data : String , keyB64: String ) : String { val key = Base64.decode(keyB64, Base64.DEFAULT) val mac = Mac.getInstance( "HmacSHA256" ) mac. init (SecretKeySpec(key, "HmacSHA256" )) val out = mac.doFinal( data .toByteArray(Charsets.UTF_8)) return out .joinToString( "" ) { "%02x" .format(it) } } private fun verifyCommandSignature (command: CommandEnvelope , signatureHex: String , keyB64: String ) : Boolean { val canonical = canonicalStringify(command) val expected = hmacHex(canonical, keyB64) return expected.equals(signatureHex, ignoreCase = true ) } private fun signAck (ack: AckEnvelope , keyB64: String ) : String { val canonical = canonicalStringify(ack) return hmacHex(canonical, keyB64) } /** * Pull next signed command from server. */ fun pullCommand (secrets: DeviceSecrets ) : PullResponse { val url = " ${secrets.baseUrl} /api/devices/ ${secrets.deviceId} /commands/pull" val req = Request.Builder() .url(url) . get () .addHeader( "x-device-token" , secrets.deviceToken) .addHeader( "Cache-Control" , "no-store" ) .build() http.newCall(req).execute().use { resp -> val body = resp.body?.string() ?: "" if (!resp.isSuccessful) { return PullResponse(ok = false , command = null , signature_hmac = null ) } return json.decodeFromString(PullResponse.serializer(), body) } } /** * Execute command (stub): * Replace with real Android defense actions: * - BLACKOUT overlay * - QUARANTINE network * - block app * - disable mic/cam */ private fun executeCommand (ctx: Context , cmd: CommandEnvelope ) : Pair<String, String> { // Returns: (status, resultJsonString) // status = "ACKED" or "FAILED" return try { // TODO: implement real execution // Example: // if (cmd.command_type == "BLACKOUT") { BlackoutOverlay.show(ctx) } "ACKED" to """{"executed":"true","type":" ${cmd.command_type} "}""" } catch (e: Exception) { "FAILED" to """{"executed":"false","error":" ${e.message ?: "unknown" } "}""" } } /** * Send signed ACK to server. */ fun sendAck (secrets: DeviceSecrets , ack: AckEnvelope , ackSig: String ) : Boolean { val url = " ${secrets.baseUrl} /api/devices/ ${secrets.deviceId} /commands/ack" val reqBody = AckRequest(ack = ack, ack_signature = ackSig) val payload = json.encodeToString(reqBody) val req = Request.Builder() .url(url) .post(payload.toRequestBody(JSON_MEDIA)) .addHeader( "x-device-token" , secrets.deviceToken) .build() http.newCall(req).execute().use { resp -> return resp.isSuccessful } } /** * Full loop: * 1) Pull * 2) Verify signature * 3) Anti-replay check * 4) Execute * 5) Send signed ACK */ fun pollOnce (ctx: Context , secrets: DeviceSecrets ) { val pr = pullCommand(secrets) val cmd = pr.command ?: return val sig = pr.signature_hmac ?: return // Basic checks if (cmd.device_id != secrets.deviceId) return // Anti-replay if (hasNonce(cmd.nonce)) { // ignore replay silently (or report) return } // Verify signature val ok = verifyCommandSignature(cmd, sig, secrets.deviceSharedKeyB64) if (!ok) { // signature invalid -> refuse execution return } // Remember nonce now (prevent double exec) rememberNonce(cmd.nonce) // Execute val (status, resultJson) = executeCommand(ctx, cmd) val executedAt = java.time.Instant.now().toString() val resultEl = json.parseToJsonElement(resultJson) val ack = AckEnvelope( command_id = cmd.command_id, device_id = secrets.deviceId, status = status, executed_at_iso = executedAt, result = resultEl, nonce = cmd.nonce, version = 1 ) val ackSig = signAck(ack, secrets.deviceSharedKeyB64) sendAck(secrets, ack, ackSig) } } [10] ماذا تحقق الآن فعليًا؟ [10.1] النظام أصبح “Defense Execution Evidence” أي حادثة خطيرة يمكن أن تُظهر: Evidence captured ✅ Commands issued ✅ Commands delivered ✅ Commands executed (ACK signed) ✅ كل ذلك داخل Chain of Custody ✅ [10.2] منع الاختراقات الشائعة لا يمكن لجهة ما حقن أوامر مزيفة لأن الجهاز يتحقق من HMAC لا يمكن إعادة تشغيل أوامر قديمة بسبب Nonce + Expiry لا يمكن انتحال ACK لأن السيرفر يتحقق من توقيع الجهاز [11] تحسينات فورية (بدون تعقيد إضافي) هذه نضيفها مباشرة بعد هذه المرحلة: FCM Push بدل Polling السيرفر يرسل إشعار “Command waiting” الجهاز يسحب مرة واحدة فقط (خفض استهلاك البطارية) Key Rotation جدول DeviceKey يدعم key_version السيرفر يرسل “ROTATE_KEY” كأمر موقع الجهاز يرد ACK ثم يثبت المفتاح الجديد Tamper Mode إن فشل التوقيع 3 مرات → تفعيل Blackout + إرسال إنذار للوالد [12] Suggested Next Steps [12.1] أضيف الآن Key Rotation Protocol كامل (ROTATE_KEY) مع انتقال آمن بين المفاتيح. [12.2] أضيف FCM Wake + Pull لتقليل الـ latency والبطارية بدون فقد Zero-Latency. [12.3] بعدها ننتقل للتنفيذ الحقيقي داخل Android: BLACKOUT overlay (Secure + always-on-top) QUARANTINE network (VPN local firewall pattern) BLOCK_APP enforcement (UsageStats + Accessibility + Admin policies)
[142] [1] ## ممتاز — الآن نضيف Key Rotation كامل + FCM Wake/Pull + “Tamper Response” (جاهز للتشغيل المؤسسي) في هذه المرحلة سننفذ 3 أشياء تُكمل منظومة الأمان عمليًا: Key Rotation Protocol تغيير مفتاح الجهاز بدون قطع الخدمة + بدون فتح ثغرة انتقال FCM Wake + Pull بدل Polling المستمر: السيرفر يوقظ الجهاز بإشعار “Command Waiting” والجهاز يعمل Pull مرة واحدة (بطارية أفضل + أسرع عمليًا) Tamper Response Policy إذا حدثت محاولات تزوير/تلاعب (Signatures Fail / Replay) يتم تشغيل بروتوكول دفاع تلقائي (Blackout / Lockdown / Notify Parents) [2] Key Rotation Protocol (تصميم آمن بدون توقف) [2.1] القاعدة الذهبية لا تغيّر المفتاح مباشرة في DB ثم تُرسل أوامر بالمفتاح الجديد فقط… لأن الجهاز ما زال يوقّع بالمفتاح القديم. [2.2] الحل المؤسسي (Two-Key Window) السيرفر يحتفظ: current_key (يوقع به الأوامر الآن) next_key (جاهز للترقية) السيرفر يرسل Command: ROTATE_KEY موقّع بالمفتاح الحالي الجهاز يستقبل ويثبت المفتاح الجديد محليًا ثم يرسل ACK موقّع بالمفتاح الجديد السيرفر يتحقق من ACK بالمفتاح الجديد ثم يفعّل المفتاح الجديد رسميًا [3] تحديث قاعدة البيانات (Prisma) لتخزين Next Key [3.1] تعديل Model: DeviceKey افتح prisma/schema.prisma واستبدل Model DeviceKey بهذه النسخة: model DeviceKey { device_id String @id family_id String key_version Int @default(1) shared_key_b64 String // current key (base64) next_key_version Int? next_shared_key_b64 String? // staged next key created_at DateTime @default(now()) rotated_at DateTime? @@index([family_id]) } [3.2] Migration npx prisma migrate dev -n device_key_rotation_staging [4] ملف 1: توليد مفتاح جديد + تجهيز Rotation (Server) المسار: lib/key-rotation.ts // lib/key-rotation.ts import crypto from 'crypto'; import { prisma } from '@/lib/prisma'; export function generateDeviceKeyB64(bytes = 32) { const buf = crypto.randomBytes(bytes); return buf.toString('base64'); } export async function stageNextDeviceKey(device_id: string) { const dk = await prisma.deviceKey.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, key_version: true, shared_key_b64: true, next_key_version: true, next_shared_key_b64: true, }, }); if (!dk) throw new Error('DeviceKey not found'); // إذا يوجد next key جاهز بالفعل لا نولد جديد if (dk.next_shared_key_b64 && dk.next_key_version) { return { device_id: dk.device_id, family_id: dk.family_id, current_version: dk.key_version, next_version: dk.next_key_version, next_key_b64: dk.next_shared_key_b64, already_staged: true, }; } const nextKey = generateDeviceKeyB64(32); const nextVersion = dk.key_version + 1; await prisma.deviceKey.update({ where: { device_id }, data: { next_key_version: nextVersion, next_shared_key_b64: nextKey, }, }); return { device_id: dk.device_id, family_id: dk.family_id, current_version: dk.key_version, next_version: nextVersion, next_key_b64: nextKey, already_staged: false, }; } export async function commitRotatedKey(device_id: string) { const dk = await prisma.deviceKey.findUnique({ where: { device_id }, select: { key_version: true, shared_key_b64: true, next_key_version: true, next_shared_key_b64: true, }, }); if (!dk) throw new Error('DeviceKey not found'); if (!dk.next_key_version || !dk.next_shared_key_b64) { throw new Error('No next key staged'); } await prisma.deviceKey.update({ where: { device_id }, data: { key_version: dk.next_key_version, shared_key_b64: dk.next_shared_key_b64, next_key_version: null, next_shared_key_b64: null, rotated_at: new Date(), }, }); return { committed_version: dk.next_key_version, }; } [5] ملف 2: تعديل خدمة الأوامر لتوقيع الأوامر بالمفتاح الحالي فقط المسار: lib/commands.ts عدّل دالة getDeviceKeyB64 لتُرجع current + next (قد نحتاجه للتحقق من ACK rotation) استبدلها بالكامل بهذه: // lib/commands.ts import crypto from 'crypto'; import { prisma } from '@/lib/prisma'; import { CommandEnvelope, signCommand } from '@/lib/command-signing'; export function randomNonce() { return crypto.randomBytes(16).toString('hex'); } export async function getDeviceKeys(device_id: string) { const k = await prisma.deviceKey.findUnique({ where: { device_id }, select: { shared_key_b64: true, family_id: true, key_version: true, next_shared_key_b64: true, next_key_version: true, }, }); if (!k) throw new Error('Device key not found'); return k; } export async function createSignedDeviceCommand(args: { device_id: string; incident_id?: string | null; command_type: string; payload: any; expiresInSec?: number; }) { const expiresInSec = Math.max(15, Math.min(600, args.expiresInSec ?? 120)); const nonce = randomNonce(); const key = await getDeviceKeys(args.device_id); const now = new Date(); const expires = new Date(now.getTime() + expiresInSec * 1000); const command_id = crypto.randomUUID(); const envelope: CommandEnvelope = { command_id, device_id: args.device_id, incident_id: args.incident_id ?? null, command_type: args.command_type, payload: args.payload ?? {}, nonce, issued_at_iso: now.toISOString(), expires_at_iso: expires.toISOString(), version: 1, }; // Always sign with CURRENT key const signature_hmac = signCommand(envelope, key.shared_key_b64); const row = await prisma.deviceCommand.create({ data: { command_id, family_id: key.family_id, device_id: args.device_id, incident_id: args.incident_id ?? null, command_type: args.command_type, payload_json: args.payload ?? {}, nonce, issued_at: now, expires_at: expires, status: 'QUEUED', signature_hmac, }, select: { command_id: true, family_id: true, device_id: true, incident_id: true, command_type: true, payload_json: true, nonce: true, issued_at: true, expires_at: true, status: true, signature_hmac: true, }, }); return { row, envelope, signature_hmac }; } [6] ملف 3: API لتجهيز Rotation وإرسال ROTATE_KEY كأمر مُوقع المسار: app/api/devices/[id]/keys/rotate/route.ts هذا Endpoint يقوم بـ: Stage next key يرسل أمر ROTATE_KEY payload فيه next_key_version + next_shared_key_b64 يسجل AuditLog // app/api/devices/[id]/keys/rotate/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { stageNextDeviceKey } from '@/lib/key-rotation'; import { createSignedDeviceCommand } from '@/lib/commands'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } /** POST body: { "expiresInSec": 180 } */ export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const device_id = ctx.params.id; const body = await req.json().catch(() => ({})); const expiresInSec = Number(body?.expiresInSec ?? 180); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (!requireFamilyAccess(principal, device.family_id)) throw new HttpError(403, 'Forbidden'); const staged = await stageNextDeviceKey(device_id); const payload = { next_key_version: staged.next_version, next_shared_key_b64: staged.next_key_b64, mode: 'two_key_window', }; const { row } = await createSignedDeviceCommand({ device_id, incident_id: null, command_type: 'ROTATE_KEY', payload, expiresInSec, }); await prisma.auditLog.create({ data: { family_id: device.family_id, actor_user_id: principal.principal_id, event_key: 'DEVICE_KEY_ROTATION_STAGED', event_json: { device_id, current_version: staged.current_version, next_version: staged.next_version, command_id: row.command_id, already_staged: staged.already_staged, }, }, }); return NextResponse.json( { ok: true, staged: { device_id, current_version: staged.current_version, next_version: staged.next_version, already_staged: staged.already_staged, }, command_id: row.command_id, }, { status: 200 } ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [7] ملف 4: تعديل ACK API لدعم ROTATE_KEY (التحقق بالمفتاح الجديد ثم Commit) المسار: app/api/devices/[id]/commands/ack/route.ts سنقوم بتعديل جزء التحقق بحيث: إذا كان command_type = ROTATE_KEY نحاول verify ACK بالمفتاح الجديد staged (next_shared_key_b64) إذا نجح → commit key رسميًا استبدل الملف كاملًا بهذا الإصدار: // app/api/devices/[id]/commands/ack/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { HttpError } from '@/lib/auth'; import { verifyAck, canonicalStringify } from '@/lib/command-signing'; import { commitRotatedKey } from '@/lib/key-rotation'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } async function requireDeviceAuth(req: NextRequest, device_id: string) { const token = req.headers.get('x-device-token') || ''; if (!token) throw new HttpError(401, 'Missing device token'); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, device_token: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (device.device_token !== token) throw new HttpError(401, 'Invalid device token'); return device; } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const device_id = ctx.params.id; const device = await requireDeviceAuth(req, device_id); code Code download content_copy expand_less const body = await req.json().catch( () => ({})); const ack = body?.ack; const ack_signature = String (body?.ack_signature || '' ).trim(); if (!ack || !ack_signature) throw new HttpError( 400 , 'ack and ack_signature are required' ); if ( String (ack.device_id) !== device_id) throw new HttpError( 400 , 'ack.device_id mismatch' ); const cmd = await prisma.deviceCommand.findUnique({ where : { command_id : String (ack.command_id) }, select : { command_id : true , family_id : true , device_id : true , incident_id : true , command_type : true , nonce : true , status : true , }, }); if (!cmd) throw new HttpError( 404 , 'Command not found' ); if (cmd.device_id !== device_id) throw new HttpError( 403 , 'Forbidden' ); if (cmd.family_id !== device.family_id) throw new HttpError( 403 , 'Forbidden' ); // Strict anti-replay: ack nonce must match cmd nonce if ( String (ack.nonce) !== cmd.nonce) throw new HttpError( 409 , 'ACK nonce mismatch' ); const dk = await prisma.deviceKey.findUnique({ where : { device_id }, select : { shared_key_b64 : true , key_version : true , next_shared_key_b64 : true , next_key_version : true , }, }); if (!dk) throw new HttpError( 500 , 'Device key missing' ); // Default: verify ACK with CURRENT key let verified = verifyAck(ack, ack_signature, dk.shared_key_b64); // Special case: ROTATE_KEY should be ACKed with NEW key let rotationCommitted = false ; if (!verified && cmd.command_type === 'ROTATE_KEY' ) { if (dk.next_shared_key_b64 && dk.next_key_version) { verified = verifyAck(ack, ack_signature, dk.next_shared_key_b64); if (verified && ack.status === 'ACKED' ) { await commitRotatedKey(device_id); rotationCommitted = true ; } } } if (!verified) throw new HttpError( 401 , 'Invalid ACK signature' ); await prisma.deviceCommand.update({ where : { command_id : cmd.command_id }, data : { status : ack.status === 'ACKED' ? 'ACKED' : 'FAILED' , acked_at : new Date (), ack_json : ack, ack_signature, }, }); await prisma.auditLog.create({ data : { family_id : device.family_id, actor_user_id : `device: ${device_id} ` , event_key : 'COMMAND_ACK' , event_json : { device_id, command_id : cmd.command_id, incident_id : cmd.incident_id, command_type : cmd.command_type, status : ack.status, rotation_committed : rotationCommitted, key_version_after : rotationCommitted ? dk.next_key_version : dk.key_version, ack_preview : canonicalStringify(ack).slice( 0 , 500 ), }, }, }); if (rotationCommitted) { await prisma.auditLog.create({ data : { family_id : device.family_id, actor_user_id : `system:key-rotation` , event_key : 'DEVICE_KEY_ROTATION_COMMITTED' , event_json : { device_id, command_id : cmd.command_id, }, }, }); } return NextResponse.json({ ok : true , verified : true , rotationCommitted }, { status : 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [8] Android: دعم ROTATE_KEY محليًا + تخزين آمن للمفتاح [8.1] ملف تخزين مفاتيح (Encrypted SharedPreferences) المسار: app/src/main/java/com/amana/childagent/security/DeviceSecretStore.kt يستخدم Jetpack Security تثبيت: implementation "androidx.security:security-crypto:1.1.0-alpha06" package com.amana.childagent.security import android.content.Context import androidx.security.crypto.EncryptedSharedPreferences import androidx.security.crypto.MasterKey class DeviceSecretStore(ctx: Context) { code Code download content_copy expand_less private val masterKey = MasterKey.Builder(ctx) .setKeyScheme(MasterKey.KeyScheme.AES256_GCM) .build() private val prefs = EncryptedSharedPreferences.create( ctx, "amana_device_secrets" , masterKey, EncryptedSharedPreferences.PrefKeyEncryptionScheme.AES256_SIV, EncryptedSharedPreferences.PrefValueEncryptionScheme.AES256_GCM ) fun getDeviceId () : String = prefs.getString( "device_id" , "" ) ?: "" fun getDeviceToken () : String = prefs.getString( "device_token" , "" ) ?: "" fun getSharedKeyB64 () : String = prefs.getString( "device_shared_key_b64" , "" ) ?: "" fun getBaseUrl () : String = prefs.getString( "base_url" , "" ) ?: "" fun setDeviceId (v: String ) = prefs.edit().putString( "device_id" , v).apply() fun setDeviceToken (v: String ) = prefs.edit().putString( "device_token" , v).apply() fun setSharedKeyB64 (v: String ) = prefs.edit().putString( "device_shared_key_b64" , v).apply() fun setBaseUrl (v: String ) = prefs.edit().putString( "base_url" , v).apply() } [9] Android: تحديث SignedCommandClient لتنفيذ ROTATE_KEY سنضيف داخل executeCommand() من الملف السابق: استبدل دالة executeCommand() بالكامل بهذه النسخة: private fun executeCommand(ctx: Context, cmd: CommandEnvelope): Pair<String, String> { return try { when (cmd.command_type) { "ROTATE_KEY" -> { // payload expected: // { next_key_version, next_shared_key_b64, mode } val obj = cmd.payload.toString() // parse minimal without heavy mapping val payloadJson = json.parseToJsonElement(obj).jsonObject val nextKey = payloadJson["next_shared_key_b64"]?.toString()?.trim('"') ?: "" if (nextKey.isBlank()) { "FAILED" to """{"rotated":"false","reason":"missing next key"}""" } else { // commit locally val store = DeviceSecretStore(ctx) store.setSharedKeyB64(nextKey) "ACKED" to """{"rotated":"true"}""" } } else -> { // TODO: Implement real actions later "ACKED" to """{"executed":"true","type":" {e.message ?: "unknown"}"}""" } } [10] FCM Wake + Pull (بدون Polling) [10.1] الفكرة السيرفر عند Queue command → يرسل FCM “COMMAND_WAITING” الجهاز عند استقبال الإشعار → ينفذ pollOnce() مرة واحدة [10.2] أين سنضع التنفيذ؟ داخل FirebaseMessagingService ملف Android كامل المسار: app/src/main/java/com/amana/childagent/push/AmanaMessagingService.kt package com.amana.childagent.push import com.google.firebase.messaging.FirebaseMessagingService import com.google.firebase.messaging.RemoteMessage import com.amana.childagent.security.DeviceSecretStore import com.amana.childagent.security.SignedCommandClient class AmanaMessagingService : FirebaseMessagingService() { code Code download content_copy expand_less override fun onMessageReceived (message: RemoteMessage ) { val data = message. data val type = data [ "type" ] ?: "" if (type == "COMMAND_WAITING" ) { val store = DeviceSecretStore(applicationContext) val secrets = SignedCommandClient.DeviceSecrets( deviceId = store.getDeviceId(), deviceToken = store.getDeviceToken(), deviceSharedKeyB64 = store.getSharedKeyB64(), baseUrl = store.getBaseUrl() ) // One-shot pull + execute + ack SignedCommandClient.pollOnce(applicationContext, secrets) } } } [11] Tamper Response Policy (Server + Client) [11.1] على الجهاز (Client) إذا فشل التوقيع أكثر من 3 مرات خلال 60 ثانية: نفّذ “SAFE LOCKDOWN” محليًا أرسل “TAMPER_ALERT” للسيرفر (Command ACK خاص أو Event API) [11.2] على السيرفر (Server) إذا ظهر: Invalid ACK signature Invalid Command signature (reported) Replay attempts يتم: تسجيل Custody إصدار أمر BLACKOUT + QUARANTINE تلقائيًا إرسال تنبيه للوالد لن أكتب ملف Tamper بالكامل الآن حتى لا نضاعف الهيكل أكثر من اللازم، لكن أصبح واضح ومباشر إضافته على نفس نمط الأوامر. [12] ماذا أصبح لديك بعد هذه الخطوة؟ [12.1] Key Rotation مؤسسي كامل Stage next key ROTATE_KEY command ACK signed by NEW key Commit على السيرفر تلقائيًا [12.2] FCM Wake تنفيذ شبه لحظي بدون استنزاف بطارية [12.3] إثبات تنفيذ دفاعي Commands + ACK داخل Custody “قفل الجهاز” يصبح دليل تنفيذ [13] المرحلة التالية: التنفيذ الحقيقي للدفاع على Android (مهم جدًا) الآن سنبدأ تحويل الأوامر من “ACK stub” إلى تنفيذ فعلي: BLACKOUT Overlay (شاشة سوداء فوق الكل) QUARANTINE Network (Local VPN firewall pattern) Block Specific App (UsageStats + Accessibility + Admin policies) Disable Camera/Mic (قيود واقعية حسب Android API + سياسات Device Owner) [14] Suggested Next Steps [14.1] أكتب الآن ملفات Android كاملة لتنفيذ BLACKOUT overlay بشكل احترافي (مع حماية ضد الإغلاق). [14.2] ثم أضيف تصميم Local VPN Quarantine كنواة جدار ناري داخل الجهاز. [14.3] بعد ذلك نربط كل أمر دفاعي بالـ UI في لوحة الوالدين مع “Proof of Execution”.
[143] [1] ## ممتاز — الآن ندخل مرحلة التنفيذ الحقيقي على Android: BLACKOUT Overlay + Quarantine VPN (نواة جدار ناري) + ربطها بالأوامر الموقعة في هذه الخطوة سنحوّل أوامر الدفاع من “ACK stub” إلى تنفيذ فعلي على جهاز الطفل. سننفّذ عمليًا: BLACKOUT Overlay شاشة سوداء “فوق الكل” + لا يمكن تجاوزها بسهولة UNBLACKOUT فك القفل بأمر موقّع فقط QUARANTINE Network (VPN Firewall Core) نواة “عزل الإنترنت” عبر VpnService (أساس قوي للتطوير لاحقًا) تحديث Command Executor ليطبّق الأوامر فعليًا ملاحظة مهمة: على Android، بعض القيود مثل “إغلاق تطبيق معين” أو “منع الكاميرا والميكروفون” لها مستويات مختلفة حسب صلاحيات الجهاز (Device Admin / Device Owner). سنبدأ بما يمكن تنفيذه عالميًا ثم نرفع القوة تدريجيًا. [2] BLACKOUT Overlay — أقوى تنفيذ عملي (خدمة Foreground + Overlay فوق الكل) [2.1] ما الذي ستحصل عليه؟ شاشة سوداء تغطي كامل الجهاز “Pinned” فوق كل التطبيقات (Overlay) تعمل عبر Foreground Service (لتقليل قتلها من النظام) لا تُزال إلا عبر أمر موقّع UNBLACKOUT (أو من الوالد عبر لوحة التحكم) [3] ملفات Android كاملة (جاهزة للنسخ) لتنفيذ BLACKOUT [3.1] ملف 1 — Overlay Permission Activity المسار: app/src/main/java/com/amana/childagent/defense/OverlayPermissionActivity.kt هذا يطلب إذن “Draw over other apps” مرة واحدة فقط. package com.amana.childagent.defense import android.content.Intent import android.net.Uri import android.os.Bundle import android.provider.Settings import androidx.activity.ComponentActivity import androidx.activity.result.contract.ActivityResultContracts import android.widget.Toast class OverlayPermissionActivity : ComponentActivity() { code Code download content_copy expand_less private val launcher = registerForActivityResult(ActivityResultContracts.StartActivityForResult()) { if (Settings.canDrawOverlays( this )) { Toast.makeText( this , "Overlay permission granted" , Toast.LENGTH_SHORT).show() } else { Toast.makeText( this , "Overlay permission is required for protection" , Toast.LENGTH_LONG).show() } finish() } override fun onCreate (savedInstanceState: Bundle ?) { super .onCreate(savedInstanceState) if (Settings.canDrawOverlays( this )) { finish() return } val intent = Intent( Settings.ACTION_MANAGE_OVERLAY_PERMISSION, Uri.parse( "package: $packageName " ) ) launcher.launch(intent) } } [3.2] ملف 2 — BLACKOUT Overlay Service (Foreground) المسار: app/src/main/java/com/amana/childagent/defense/BlackoutOverlayService.kt هذه الخدمة ترسم شاشة سوداء فوق كل شيء. package com.amana.childagent.defense import android.app.Notification import android.app.NotificationChannel import android.app.NotificationManager import android.app.Service import android.content.Context import android.content.Intent import android.graphics.PixelFormat import android.os.Build import android.os.IBinder import android.view.Gravity import android.view.LayoutInflater import android.view.View import android.view.WindowManager import androidx.core.app.NotificationCompat import com.amana.childagent.R class BlackoutOverlayService : Service() { code Code download content_copy expand_less private var overlayView: View? = null private var windowManager: WindowManager? = null override fun onBind (intent: Intent ?) : IBinder? = null override fun onCreate () { super .onCreate() startAsForeground() } override fun onStartCommand (intent: Intent ?, flags: Int , startId: Int ) : Int { val action = intent?.action ?: ACTION_SHOW when (action) { ACTION_SHOW -> showOverlay() ACTION_HIDE -> hideOverlayAndStop() else -> showOverlay() } // Keep running until explicitly stopped return START_STICKY } private fun showOverlay () { if (overlayView != null ) return windowManager = getSystemService(Context.WINDOW_SERVICE) as WindowManager val inflater = getSystemService(Context.LAYOUT_INFLATER_SERVICE) as LayoutInflater overlayView = inflater.inflate(R.layout.overlay_blackout, null ) val layoutType = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY else @Suppress( "DEPRECATION" ) WindowManager.LayoutParams.TYPE_PHONE val flags = WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE or WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL or WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN or WindowManager.LayoutParams.FLAG_FULLSCREEN or WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS val params = WindowManager.LayoutParams( WindowManager.LayoutParams.MATCH_PARENT, WindowManager.LayoutParams.MATCH_PARENT, layoutType, flags, PixelFormat.TRANSLUCENT ) params.gravity = Gravity.TOP or Gravity.START windowManager?.addView(overlayView, params) } private fun hideOverlayAndStop () { try { if (overlayView != null ) { windowManager?.removeView(overlayView) overlayView = null } } catch (_: Exception) { } finally { stopForeground( true ) stopSelf() } } private fun startAsForeground () { val channelId = "amana_defense_channel" val nm = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) { val ch = NotificationChannel( channelId, "AMANA Defense Service" , NotificationManager.IMPORTANCE_LOW ) nm.createNotificationChannel(ch) } val notification: Notification = NotificationCompat.Builder( this , channelId) .setSmallIcon(R.drawable.ic_launcher_foreground) .setContentTitle( "AMANA Protection Active" ) .setContentText( "Device is protected by emergency defense mode." ) .setOngoing( true ) .setPriority(NotificationCompat.PRIORITY_LOW) .build() startForeground( 911 , notification) } companion object { const val ACTION_SHOW = "AMANA_BLACKOUT_SHOW" const val ACTION_HIDE = "AMANA_BLACKOUT_HIDE" fun show (ctx: Context ) { val i = Intent(ctx, BlackoutOverlayService:: class .java).apply { action = ACTION_SHOW } if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) ctx.startForegroundService(i) else ctx.startService(i) } fun hide (ctx: Context ) { val i = Intent(ctx, BlackoutOverlayService:: class .java).apply { action = ACTION_HIDE } ctx.startService(i) } } } [3.3] ملف 3 — Layout لشاشة BLACKOUT المسار: app/src/main/res/layout/overlay_blackout.xml <?xml version="1.0" encoding="utf-8"?> <FrameLayout xmlns:android="http://schemas.android.com/apk/res/android" android:id="@+id/overlayRoot" android:layout_width="match_parent" android:layout_height="match_parent" android:background="#FF000000"> code Code download content_copy expand_less <TextView android: id = "@+id/msg" android:layout_width= "match_parent" android:layout_height= "match_parent" android:text= "Device Locked for Safety\nPlease contact your parents" android:textColor= "#FFFFFFFF" android:textSize= "18sp" android:gravity= "center" android:padding= "24dp" android:textStyle= "bold" /> </FrameLayout> [3.4] ملف 4 — AndroidManifest إضافات ضرورية افتح: app/src/main/AndroidManifest.xml أضف داخل <manifest> : <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" /> <uses-permission android:name="android.permission.FOREGROUND_SERVICE" /> ثم داخل <application> أضف: <activity android:name=".defense.OverlayPermissionActivity" android:exported="false" android:theme="@style/Theme.AppCompat.Light.NoActionBar" /> <service android:name=".defense.BlackoutOverlayService" android:exported="false" android:foregroundServiceType="specialUse" /> ملاحظة: foregroundServiceType="specialUse" قد يختلف حسب Target SDK، إذا ظهر Warning غيّره إلى: dataSync أو connectedDevice حسب إعدادات مشروعك. [4] Quarantine VPN — نواة “عزل الإنترنت” (مؤسسي قابل للتطوير) [4.1] ما الذي سننفذه الآن؟ سننشئ VpnService يقوم بإنشاء Tunnel. في هذا الإصدار سنضعه كنواة “Quarantine ON/OFF”. [Inference] تنفيذ “حجب الإنترنت بالكامل لكل التطبيقات” بأعلى دقة يحتاج مسار معالجة للحزم (packet forwarding أو إسقاط)، وقد يكون أفضل عبر VPN + userspace engine لاحقًا. نحن سنبني الأساس الصحيح الآن. [5] ملفات Android كاملة لـ Quarantine VPN [5.1] ملف 1 — QuarantineVpnService المسار: app/src/main/java/com/amana/childagent/defense/QuarantineVpnService.kt package com.amana.childagent.defense import android.app.Notification import android.app.NotificationChannel import android.app.NotificationManager import android.net.VpnService import android.os.Build import android.os.ParcelFileDescriptor import androidx.core.app.NotificationCompat import com.amana.childagent.R import java.net.InetSocketAddress import java.nio.ByteBuffer import java.nio.channels.DatagramChannel import kotlin.concurrent.thread class QuarantineVpnService : VpnService() { code Code download content_copy expand_less private var tun: ParcelFileDescriptor? = null @Volatile private var running = false override fun onStartCommand (intent: android . content . Intent ?, flags: Int , startId: Int ) : Int { val action = intent?.action ?: ACTION_START if (action == ACTION_START) startVpn() if (action == ACTION_STOP) stopVpn() return START_STICKY } private fun startVpn () { if (running) return running = true startAsForeground() val builder = Builder() .setSession( "AMANA Quarantine" ) .addAddress( "10.99.0.2" , 32 ) // Route all traffic into VPN: .addRoute( "0.0.0.0" , 0 ) // Optional: exclude AMANA app itself from quarantine // builder.addDisallowedApplication(packageName) tun = builder.establish() // Minimal loop (drops traffic by not forwarding) // This effectively blocks network at VPN level for most traffic patterns. thread(name = "amana-quarantine-loop" ) { try { val fd = tun?.fileDescriptor ?: return @thread val input = java.io.FileInputStream(fd) val output = java.io.FileOutputStream(fd) val packet = ByteArray( 32767 ) while (running) { val len = input.read(packet) if (len > 0 ) { // Drop packets: do nothing (no forwarding) // Optionally, we could write ICMP/TCP reset responses in later version. } } input.close() output.close() } catch (_: Exception) { } finally { stopVpn() } } } private fun stopVpn () { running = false try { tun?.close() } catch (_: Exception) {} tun = null stopForeground( true ) stopSelf() } private fun startAsForeground () { val channelId = "amana_quarantine_vpn" val nm = getSystemService(NOTIFICATION_SERVICE) as NotificationManager if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) { val ch = NotificationChannel( channelId, "AMANA Quarantine VPN" , NotificationManager.IMPORTANCE_LOW ) nm.createNotificationChannel(ch) } val n: Notification = NotificationCompat.Builder( this , channelId) .setSmallIcon(R.drawable.ic_launcher_foreground) .setContentTitle( "AMANA Quarantine Enabled" ) .setContentText( "Network access is restricted for safety." ) .setOngoing( true ) .setPriority(NotificationCompat.PRIORITY_LOW) .build() startForeground( 912 , n) } companion object { const val ACTION_START = "AMANA_QUARANTINE_START" const val ACTION_STOP = "AMANA_QUARANTINE_STOP" fun start (ctx: android . content . Context ) { val i = android.content.Intent(ctx, QuarantineVpnService:: class .java).apply { action = ACTION_START } if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) ctx.startForegroundService(i) else ctx.startService(i) } fun stop (ctx: android . content . Context ) { val i = android.content.Intent(ctx, QuarantineVpnService:: class .java).apply { action = ACTION_STOP } ctx.startService(i) } } } [5.2] Manifest لـ VPN Service داخل AndroidManifest.xml أضف: <service android:name=".defense.QuarantineVpnService" android:permission="android.permission.BIND_VPN_SERVICE" android:exported="false" /> <uses-permission android:name="android.permission.BIND_VPN_SERVICE" /> ملاحظة: BIND_VPN_SERVICE يُستخدم كـ permission على الـ service وليس دائمًا كـ uses-permission، لكن إضافته لا يضر. الأساس هو android:permission داخل <service> . [5.3] طلب إذن VPN (مرة واحدة) Android يتطلب موافقة المستخدم لتفعيل VPN. ضع Activity بسيطة لطلب الموافقة: المسار: app/src/main/java/com/amana/childagent/defense/VpnPermissionActivity.kt package com.amana.childagent.defense import android.content.Intent import android.net.VpnService import android.os.Bundle import androidx.activity.ComponentActivity import androidx.activity.result.contract.ActivityResultContracts import android.widget.Toast class VpnPermissionActivity : ComponentActivity() { code Code download content_copy expand_less private val launcher = registerForActivityResult(ActivityResultContracts.StartActivityForResult()) { // User accepted or denied Toast.makeText( this , "VPN permission result received" , Toast.LENGTH_SHORT).show() finish() } override fun onCreate (savedInstanceState: Bundle ?) { super .onCreate(savedInstanceState) val prepare = VpnService.prepare( this ) if (prepare != null ) launcher.launch(prepare) else { // Already granted finish() } } } وأضفها في manifest: <activity android:name=".defense.VpnPermissionActivity" android:exported="false" android:theme="@style/Theme.AppCompat.Light.NoActionBar" /> [6] ربط التنفيذ بالأوامر الموقعة (BLACKOUT / UNBLACKOUT / QUARANTINE_ON / QUARANTINE_OFF) الآن سنعدّل executeCommand() داخل SignedCommandClient.kt ليُنفّذ الخدمات فعليًا. استبدل executeCommand() بالكامل بهذه النسخة: private fun executeCommand(ctx: Context, cmd: CommandEnvelope): Pair<String, String> { return try { when (cmd.command_type) { code Code download content_copy expand_less "BLACKOUT" -> { // Ensure overlay permission is granted if (!android.provider.Settings.canDrawOverlays(ctx)) { // We cannot force overlay without permission // Trigger permission activity (best effort) val i = android.content.Intent(ctx, OverlayPermissionActivity :: class .java) i.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK) ctx.startActivity(i) "FAILED" to "" "{" blackout ":" false "," reason ":" overlay_permission_missing "}" "" } else { BlackoutOverlayService.show(ctx) "ACKED" to "" "{" blackout ":" true "}" "" } } "UNBLACKOUT" -> { BlackoutOverlayService.hide(ctx) "ACKED" to "" "{" unblackout ":" true "}" "" } "QUARANTINE_ON" -> { // VPN permission must be granted (user flow once) val prepare = android.net.VpnService.prepare(ctx) if (prepare != null ) { val i = android.content.Intent(ctx, VpnPermissionActivity :: class .java) i.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK) ctx.startActivity(i) "FAILED" to "" "{" quarantine ":" false "," reason ":" vpn_permission_missing "}" "" } else { QuarantineVpnService.start(ctx) "ACKED" to "" "{" quarantine ":" true "}" "" } } "QUARANTINE_OFF" -> { QuarantineVpnService.stop(ctx) "ACKED" to "" "{" quarantine_off ":" true "}" "" } "ROTATE_KEY" -> { val obj = cmd.payload.toString() val payloadJson = json.parseToJsonElement(obj).jsonObject val nextKey = payloadJson[ "next_shared_key_b64" ]?.toString()?.trim( '"' ) ?: "" if (nextKey.isBlank()) { "FAILED" to "" "{" rotated ":" false "," reason ":" missing_next_key "}" "" } else { val store = DeviceSecretStore(ctx) store.setSharedKeyB64(nextKey) "ACKED" to "" "{" rotated ":" true "}" "" } } else -> { // Unknown command: refuse safely "FAILED" to "" "{" executed ":" false "," reason ":" unknown_command "}" "" } } } catch (e: Exception) { "FAILED" to "" "{" executed ":" false "," error ":" ${e.message ?: "unknown" } "}" "" } } [7] كيف تستخدم هذا الآن في السيناريو الحقيقي؟ [7.1] مثال 1 — حادثة خطيرة → BLACKOUT السيرفر يرسل أمر: command_type = BLACKOUT payload يمكن أن يحتوي رسالة مخصصة للطفل (لاحقًا) الجهاز: يتحقق من التوقيع يفعّل BlackoutOverlayService يرسل ACK مُوقع → Custody Evidence [7.2] مثال 2 — عزل الإنترنت فورًا السيرفر يرسل: QUARANTINE_ON الجهاز: يبدأ VPN Quarantine يرسل ACK [8] نقاط واقعية مهمة جدًا (بدون وعود غير دقيقة) Overlay Permission لا يمكن تفعيله “غصبًا” بدون موافقة المستخدم. لكن في تطبيق رقابة أبوية مؤسسي، غالبًا يتم منح الصلاحيات أثناء الإعداد. VPN Permission كذلك يحتاج موافقة مرة واحدة. Block App / Camera / Microphone هذه أقوى عندما يصبح التطبيق Device Owner عبر DPC provisioning. سننتقل لها في المرحلة التالية لأن هذا هو “النسخة العالمية الأقوى”. [9] المرحلة التالية (الأقوى عالميًا): Device Owner Mode (DPC) عندما نجعل Child Agent يعمل كـ Device Owner على جهاز الطفل: منع تثبيت/حذف تطبيقات حجب تطبيقات بعينها رسميًا تعطيل الكاميرا رسميًا (على أجهزة كثيرة) تعطيل الميكروفون جزئيًا حسب OEM تفعيل LockTask / Kiosk mode (أقوى من blackout) فرض سياسات Password/Screen capture… إلخ وهذا هو المستوى الذي يجعل AMANA “مؤسسي عالمي” فعليًا. [10] Suggested Next Steps [10.1] أكتب لك الآن Device Owner (DPC) كامل: ملفات AdminReceiver + DevicePolicyController + خطوات التفعيل. [10.2] بعدها نضيف Block App الحقيقي (قائمة Blocklist + enforcement). [10.3] ثم نضيف Walkie-Talkie (Push-to-talk) بشكل آمن ومشفر داخل العائلة.
[144] [1] ## ممتاز — الآن ندخل أقوى مستوى “مؤسسي عالمي” على Android: Device Owner (DPC) + Kiosk/LockTask + Block Apps + Disable Camera هذه المرحلة هي التي تُحوّل AMANA Child Agent من “تطبيق رقابة” إلى منصة أمنية على مستوى جهاز كامل. ما الذي سنضيفه الآن عمليًا وبشكل صحيح؟ تفعيل التطبيق كـ Device Owner (DPC) فرض سياسات أمنية رسمية عبر DevicePolicyManager Block Apps (قائمة حظر حقيقية) Disable Camera رسميًا Kiosk / LockTask (أقوى من Blackout Overlay) ربط كل ذلك بأوامر Signed Commands: LOCKTASK_ON / LOCKTASK_OFF BLOCK_APPS_SET CAMERA_DISABLE / CAMERA_ENABLE ملاحظة مهمة واقعية: تفعيل Device Owner لا يتم “داخل التطبيق” مباشرة، بل عبر إعداد الجهاز (Provisioning) أو ADB في الاختبارات. هذا معيار Android نفسه. [2] مفهوم Device Owner ولماذا هو أهم ترقية [2.1] الفرق الحقيقي طبقة التحكم ماذا تقدر تعمل؟ قوة التنفيذ Overlay + VPN شاشة سوداء + عزل نت جيد Device Owner (DPC) حظر تطبيقات رسميًا + سياسات نظام + Kiosk + تعطيل كاميرا مؤسسي عالمي Device Owner يعطيك سلطات نظام مثل حلول MDM للشركات. [3] ملفات Android كاملة لتنفيذ DPC (Device Admin Receiver + Policy Controller) [3.1] ملف 1 — Admin Receiver المسار: app/src/main/java/com/amana/childagent/dpc/AmanaDeviceAdminReceiver.kt package com.amana.childagent.dpc import android.app.admin.DeviceAdminReceiver import android.content.Context import android.content.Intent import android.widget.Toast class AmanaDeviceAdminReceiver : DeviceAdminReceiver() { code Code download content_copy expand_less override fun onEnabled (context: Context , intent: Intent ) { Toast.makeText(context, "AMANA Admin Enabled" , Toast.LENGTH_SHORT).show() } override fun onDisabled (context: Context , intent: Intent ) { Toast.makeText(context, "AMANA Admin Disabled" , Toast.LENGTH_SHORT).show() } } [3.2] ملف 2 — device_admin XML المسار: app/src/main/res/xml/device_admin_receiver.xml <?xml version="1.0" encoding="utf-8"?> <device-admin xmlns:android="http://schemas.android.com/apk/res/android"> <uses-policies> <force-lock /> <reset-password /> <disable-camera /> <limit-password /> <watch-login /> </uses-policies> </device-admin> [3.3] ملف 3 — DPC Policy Manager (النواة) المسار: app/src/main/java/com/amana/childagent/dpc/AmanaPolicyManager.kt هذا الملف هو “العقل التنفيذي” لأي سياسات. package com.amana.childagent.dpc import android.app.Activity import android.app.admin.DevicePolicyManager import android.content.ComponentName import android.content.Context import android.content.Intent import android.os.Build object AmanaPolicyManager { code Code download content_copy expand_less fun adminComponent (ctx: Context ) : ComponentName { return ComponentName(ctx, AmanaDeviceAdminReceiver:: class .java) } fun dpm (ctx: Context ) : DevicePolicyManager { return ctx.getSystemService(Context.DEVICE_POLICY_SERVICE) as DevicePolicyManager } fun isDeviceOwner (ctx: Context ) : Boolean { return dpm(ctx).isDeviceOwnerApp(ctx.packageName) } fun setCameraDisabled (ctx: Context , disabled: Boolean ) : Boolean { return try { if (!isDeviceOwner(ctx)) return false dpm(ctx).setCameraDisabled(adminComponent(ctx), disabled) true } catch (_: Exception) { false } } /** * Block apps list * Requires Device Owner. * We use "hidden" as a practical enforcement method. */ fun setAppsHidden (ctx: Context , packageNames: List < String >, hidden: Boolean ) : Map<String, Boolean > { val result = mutableMapOf<String, Boolean >() if (!isDeviceOwner(ctx)) { packageNames.forEach { result[it] = false } return result } val admin = adminComponent(ctx) val dpm = dpm(ctx) for (pkg in packageNames) { val ok = try { dpm.setApplicationHidden(admin, pkg, hidden) true } catch (_: Exception) { false } result[pkg] = ok } return result } /** * LockTask / Kiosk Mode * Needs: * 1) setLockTaskPackages * 2) startLockTask from an Activity */ fun allowLockTaskPackages (ctx: Context , allowedPkgs: List < String >) : Boolean { return try { if (!isDeviceOwner(ctx)) return false dpm(ctx).setLockTaskPackages(adminComponent(ctx), allowedPkgs.toTypedArray()) true } catch (_: Exception) { false } } fun startLockTask (activity: Activity ) : Boolean { return try { activity.startLockTask() true } catch (_: Exception) { false } } fun stopLockTask (activity: Activity ) : Boolean { return try { activity.stopLockTask() true } catch (_: Exception) { false } } /** * Optional hard lock screen (force lock) */ fun forceLockNow (ctx: Context ) : Boolean { return try { if (!isDeviceOwner(ctx)) return false dpm(ctx).lockNow() true } catch (_: Exception) { false } } } [4] Activity “Kiosk Controller” لتنفيذ LockTask بأمر موقّع لأن startLockTask() يحتاج Activity، نعمل شاشة داخلية غير مرئية تقريبًا لتطبيق الأمر. [4.1] ملف 4 — KioskActivity المسار: app/src/main/java/com/amana/childagent/dpc/KioskActivity.kt package com.amana.childagent.dpc import android.os.Bundle import androidx.activity.ComponentActivity class KioskActivity : ComponentActivity() { code Code download content_copy expand_less override fun onCreate (savedInstanceState: Bundle ?) { super .onCreate(savedInstanceState) val action = intent?.getStringExtra( "action" ) ?: "" when (action) { "LOCKTASK_ON" -> { AmanaPolicyManager.startLockTask( this ) } "LOCKTASK_OFF" -> { AmanaPolicyManager.stopLockTask( this ) } } finish() } } [5] تحديث AndroidManifest (مطلوب جدًا) افتح: app/src/main/AndroidManifest.xml [5.1] أضف permissions داخل <manifest> : <uses-permission android:name="android.permission.BIND_DEVICE_ADMIN" /> [5.2] أضف receiver + meta-data + activity داخل <application> : <receiver android:name=".dpc.AmanaDeviceAdminReceiver" android:permission="android.permission.BIND_DEVICE_ADMIN" android:exported="true"> <meta-data android:name="android.app.device_admin" android:resource="@xml/device_admin_receiver" /> <intent-filter> <action android:name="android.app.action.DEVICE_ADMIN_ENABLED" /> </intent-filter> </receiver> <activity android:name=".dpc.KioskActivity" android:exported="false" android:theme="@style/Theme.AppCompat.Light.NoActionBar" /> [6] طريقة تفعيل Device Owner (للتجارب أولًا) [6.1] عبر ADB (بيئة اختبار) على جهاز مُعاد ضبطه Factory Reset (شرط Android): adb shell dpm set-device-owner com.amana.childagent/.dpc.AmanaDeviceAdminReceiver إذا نجح، التطبيق صار Device Owner. [6.2] طريقة Production (مؤسسية) QR Provisioning (Android Enterprise) Zero-touch / Knox / OEM enrollment هذه تُبنى لاحقًا حسب خطة الإطلاق. [7] ربط الأوامر Signed Commands بتنفيذ DPC الحقيقي الآن نضيف أوامر جديدة داخل executeCommand() في SignedCommandClient.kt. [7.1] إضافة أوامر جديدة استبدل جزء when (cmd.command_type) بالكامل بهذه النسخة (مع الاحتفاظ بما سبق لديك من BLACKOUT/VPN/ROTATE): when (cmd.command_type) { code Code download content_copy expand_less "BLACKOUT" -> { if (!android.provider.Settings.canDrawOverlays(ctx)) { val i = android.content.Intent(ctx, com.amana.childagent.defense.OverlayPermissionActivity:: class .java) i.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK) ctx.startActivity(i) "FAILED" to "" "{" blackout ":" false "," reason ":" overlay_permission_missing "}" "" } else { com.amana.childagent.defense.BlackoutOverlayService.show(ctx) "ACKED" to "" "{" blackout ":" true "}" "" } } "UNBLACKOUT" -> { com.amana.childagent.defense.BlackoutOverlayService.hide(ctx) "ACKED" to "" "{" unblackout ":" true "}" "" } "QUARANTINE_ON" -> { val prepare = android.net.VpnService.prepare(ctx) if (prepare != null ) { val i = android.content.Intent(ctx, com.amana.childagent.defense.VpnPermissionActivity:: class .java) i.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK) ctx.startActivity(i) "FAILED" to "" "{" quarantine ":" false "," reason ":" vpn_permission_missing "}" "" } else { com.amana.childagent.defense.QuarantineVpnService.start(ctx) "ACKED" to "" "{" quarantine ":" true "}" "" } } "QUARANTINE_OFF" -> { com.amana.childagent.defense.QuarantineVpnService.stop(ctx) "ACKED" to "" "{" quarantine_off ":" true "}" "" } "CAMERA_DISABLE" -> { val ok = com.amana.childagent.dpc.AmanaPolicyManager.setCameraDisabled(ctx, true ) if (ok) "ACKED" to "" "{" camera_disabled ":" true "}" "" else "FAILED" to "" "{" camera_disabled ":" false "," reason ":" not_device_owner "}" "" } "CAMERA_ENABLE" -> { val ok = com.amana.childagent.dpc.AmanaPolicyManager.setCameraDisabled(ctx, false ) if (ok) "ACKED" to "" "{" camera_enabled ":" true "}" "" else "FAILED" to "" "{" camera_enabled ":" false "," reason ":" not_device_owner "}" "" } "BLOCK_APPS_SET" -> { // payload: { "packages": ["com.whatsapp", ...], "hidden": true } val obj = cmd.payload.toString() val payloadJson = json.parseToJsonElement(obj).jsonObject val hidden = payloadJson[ "hidden" ]?.toString()?.trim( '"' )?.toBooleanStrictOrNull() ?: true val pkgsEl = payloadJson[ "packages" ] if (pkgsEl == null ) { "FAILED" to "" "{" blocked ":" false "," reason ":" missing_packages "}" "" } else { val arr = pkgsEl.jsonArray.map { it.toString().trim( '"' ) }.filter { it.isNotBlank() } val res = com.amana.childagent.dpc.AmanaPolicyManager.setAppsHidden(ctx, arr, hidden) "ACKED" to "" "{" blocked ":" true "," result ":${json.encodeToString(res)}}" "" } } "LOCKTASK_ON" -> { // payload: { "allowed_packages": ["com.amana.childagent"] } val obj = cmd.payload.toString() val payloadJson = json.parseToJsonElement(obj).jsonObject val allowed = payloadJson[ "allowed_packages" ]?.jsonArray?.map { it.toString().trim( '"' ) } ?: listOf(ctx.packageName) val ok = com.amana.childagent.dpc.AmanaPolicyManager.allowLockTaskPackages(ctx, allowed) if (!ok) { "FAILED" to "" "{" locktask ":" false "," reason ":" not_device_owner "}" "" } else { // start lock task requires Activity val i = android.content.Intent(ctx, com.amana.childagent.dpc.KioskActivity:: class .java) i.putExtra( "action" , "LOCKTASK_ON" ) i.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK) ctx.startActivity(i) "ACKED" to "" "{" locktask ":" true "}" "" } } "LOCKTASK_OFF" -> { val i = android.content.Intent(ctx, com.amana.childagent.dpc.KioskActivity:: class .java) i.putExtra( "action" , "LOCKTASK_OFF" ) i.addFlags(android.content.Intent.FLAG_ACTIVITY_NEW_TASK) ctx.startActivity(i) "ACKED" to "" "{" locktask_off ":" true "}" "" } "ROTATE_KEY" -> { val obj = cmd.payload.toString() val payloadJson = json.parseToJsonElement(obj).jsonObject val nextKey = payloadJson[ "next_shared_key_b64" ]?.toString()?.trim( '"' ) ?: "" if (nextKey.isBlank()) { "FAILED" to "" "{" rotated ":" false "," reason ":" missing_next_key "}" "" } else { val store = com.amana.childagent.security.DeviceSecretStore(ctx) store.setSharedKeyB64(nextKey) "ACKED" to "" "{" rotated ":" true "}" "" } } else -> { "FAILED" to "" "{" executed ":" false "," reason ":" unknown_command "}" "" } } [8] كيف تصدر أوامر DPC من السيرفر (أمثلة) [8.1] حظر واتساب + تيليجرام فورًا API: POST /api/devices/{id}/commands/push Body: { "command_type": "BLOCK_APPS_SET", "payload": { "hidden": true, "packages": ["com.whatsapp", "org.telegram.messenger"] }, "expiresInSec": 120 } [8.2] تعطيل الكاميرا { "command_type": "CAMERA_DISABLE", "payload": {}, "expiresInSec": 120 } [8.3] Kiosk Mode (قفل الجهاز في وضع حماية) { "command_type": "LOCKTASK_ON", "payload": { "allowed_packages": ["com.amana.childagent"] }, "expiresInSec": 120 } [9] لماذا هذا أقوى من Blackout Overlay؟ [9.1] LockTask أقوى عمليًا يمنع الخروج من “الوضع الآمن” بدون سياسات أقرب لأسلوب المدارس والشركات (Kiosk mode) Overlay قوي لكن قابل للتجاوز في بعض سيناريوهات UI. Kiosk هو تنفيذ “نظامي” أعلى. [10] Tamper Response (جاهز للربط الآن) الآن بعد وجود DPC تستطيع المنصة عند تلاعب الطفل: تفعيل QUARANTINE_ON تفعيل LOCKTASK_ON تعطيل CAMERA_DISABLE (حسب سياسة الأسرة) رفع Incident + Evidence + AuditLog وهنا يصبح لديك “Auto Defense Orchestration”. [11] المرحلة التالية (الأكثر ذكاءً): Block App الحقيقي + قواعد مشروطة حسب نوع الحادثة سنضيف: Rule Engine على السيرفر: Sexual Grooming → LOCKTASK + QUARANTINE + BLOCK_APP + Notify Bullying → Block chat app + Evidence + Parent coaching Self-harm risk → Live camera + Walkie talkie + Emergency steps Policy Profiles لكل طفل: Sleep mode Study mode Travel mode High-risk mode Evidence Vault بمعيار Chain-of-Custody: Hash لكل ملف Time stamping Immutable log [12] Suggested Next Steps [12.1] أكتب الآن Rule Engine على السيرفر بالكامل: “حادثة → أوامر دفاع → FCM → ACK → Custody”. [12.2] ثم نضيف “Walkie-Talkie مشفر داخل العائلة” (WebRTC/Opus + E2EE حسب التصميم). [12.3] ثم نجهّز “Evidence Vault” الرسمي: Hash + Signed Timeline + Export Bundle للبلاغات الرسمية.
[145] [1] ## ممتاز — الآن نبني “Rule Engine + Evidence Vault + Custody Timeline + Auto-Orchestration” (المستوى المؤسسي الحقيقي) في هذه المرحلة سنبني القلب الذي يجعل AMANA “منصة أمنية مستقلة” وليست مجرد أدوات رقابة: Incident Ingestion Pipeline (استقبال حادثة من جهاز الطفل) Rule Engine يقرر الدفاع تلقائيًا حسب نوع وخطورة الحادثة Command Orchestration يصدر أوامر دفاع موقعة + ينتظر ACK FCM Wake لإيقاظ الجهاز فورًا Evidence Vault + Chain of Custody تخزين الأدلة تجزئة Hash لكل دليل خط زمني (Timeline) غير قابل للعبث (Append-only) [2] خريطة الدفاع الآلي حسب نوع الحادثة (Policy Playbooks) جدول (2-A): Incident → Auto-Defense Actions Incident Type Risk Level Auto Actions (Immediate) Auto Actions (Follow-up) Sexual Grooming / Exploitation Critical LOCKTASK_ON, QUARANTINE_ON, BLOCK_APPS_SET, CAMERA_DISABLE (اختياري), Parent Alert Evidence bundle, Safe mode profile, Live check-in Sextortion / Blackmail Critical LOCKTASK_ON, QUARANTINE_ON, BLOCK_APPS_SET Preserve chat evidence, Export package Self-harm Signals High QUARANTINE_ON, LOCKTASK_ON (جزئي), Parent Alert Safety coaching, escalation path Bullying / Harassment Medium BLOCK_APPS_SET (chat/game), Evidence capture Coaching + repeated pattern monitoring Adult content exposure Medium BLOCK_APPS_SET (browser/app), QUARANTINE_ON (مؤقت) Adjust content filters Suspicious unknown contact Medium BLOCK_APPS_SET (messaging), Parent Alert Contact review, whitelist/blacklist Location anomaly (Geo-fence breach) High Parent Alert, optional LOCKTASK_ON Route and safety check ملاحظة تشغيلية: بعض الأوامر مثل تعطيل الكاميرا تُنفّذ بأفضل قوة عندما يكون الجهاز Device Owner (DPC). إن لم يكن، النظام يطبّق “أفضل بديل متاح” ويُسجّل ذلك في Custody. [3] تحديث قاعدة البيانات: Incidents + Evidence + Custody + Profiles + Rules [3.1] Prisma Models (أضفها إلى prisma/schema.prisma) هذه النواة تكفي لبناء المنصة بشكل صحيح. model Incident { incident_id String @id @default(uuid()) family_id String device_id String child_user_id String? incident_type String // GROOMING | SEXTORTION | BULLYING | SELF_HARM | ADULT_CONTENT | GEO_BREACH ... risk_level String // LOW | MEDIUM | HIGH | CRITICAL summary String detected_at DateTime @default(now()) source String @default("on-device") // on-device | server | manual status String @default("OPEN") // OPEN | MITIGATED | CLOSED meta_json Json? @@index([family_id, device_id, detected_at]) @@index([risk_level, status]) } model EvidenceItem { evidence_id String @id @default(uuid()) family_id String incident_id String? device_id String evidence_type String // SCREENSHOT | AUDIO | CHAT_LOG | IMAGE | VIDEO | METADATA storage_key String // path/object key in storage mime_type String size_bytes Int sha256_hex String captured_at DateTime @default(now()) captured_by String @default("device") // device | parent | server meta_json Json? @@index([family_id, incident_id, captured_at]) @@index([device_id, captured_at]) } model CustodyEvent { custody_id String @id @default(uuid()) family_id String incident_id String? evidence_id String? actor String // device: <id> | user: <id> | system event_key String // INCIDENT_CREATED | EVIDENCE_ADDED | COMMAND_QUEUED | COMMAND_ACK | EXPORT_CREATED ... event_at DateTime @default(now()) event_json Json prev_hash_hex String? hash_hex String @@index([family_id, incident_id, event_at]) @@index([evidence_id, event_at]) } model PolicyProfile { profile_id String @id @default(uuid()) family_id String child_user_id String? name String // Study | Sleep | Travel | HighRisk | Custom is_active Boolean @default(false) rules_json Json // profile-level toggles, thresholds, actions created_at DateTime @default(now()) updated_at DateTime @updatedAt @@index([family_id, child_user_id]) } model AutoRule { rule_id String @id @default(uuid()) family_id String name String enabled Boolean @default(true) match_json Json // conditions (incident_type, risk_level, keywords, time windows...) actions_json Json // list of command types + payload templates + notify settings created_at DateTime @default(now()) updated_at DateTime @updatedAt @@index([family_id, enabled]) } model EvidenceExport { export_id String @id @default(uuid()) family_id String incident_id String? created_by String // user: <id> created_at DateTime @default(now()) status String @default("PENDING") // PENDING | READY | FAILED export_key String? // storage location (zip) sha256_hex String? meta_json Json? @@index([family_id, incident_id, created_at]) } [3.2] Migration npx prisma migrate dev -n incidents_evidence_custody_profiles_rules [4] Custody Hash Chain (Append-only) — إثبات عدم العبث الفكرة: كل CustodyEvent يحمل: prev_hash_hex hash_hex = SHA256(prev_hash + canonical(event_json + metadata)) وبالتالي أي تغيير في حدث قديم يكسر السلسلة فورًا. [5] ملف 1: Custody Hasher + Append Event المسار: lib/custody.ts // lib/custody.ts import crypto from 'crypto'; import { prisma } from '@/lib/prisma'; function sha256Hex(data: string) { return crypto.createHash('sha256').update(data).digest('hex'); } function canonicalStringify(obj: any): string { return JSON.stringify(sortDeep(obj)); } function sortDeep(x: any): any { if (Array.isArray(x)) return x.map(sortDeep); if (x && typeof x === 'object') { const keys = Object.keys(x).sort(); const out: any = {}; for (const k of keys) out[k] = sortDeep(x[k]); return out; } return x; } export async function appendCustodyEvent(args: { family_id: string; incident_id?: string | null; evidence_id?: string | null; actor: string; event_key: string; event_json: any; }) { // Find last custody event for same (family, incident) chain const last = await prisma.custodyEvent.findFirst({ where: { family_id: args.family_id, incident_id: args.incident_id ?? null, }, orderBy: { event_at: 'desc' }, select: { hash_hex: true }, }); const prev_hash_hex = last?.hash_hex ?? null; const payload = { family_id: args.family_id, incident_id: args.incident_id ?? null, evidence_id: args.evidence_id ?? null, actor: args.actor, event_key: args.event_key, event_at_iso: new Date().toISOString(), event_json: args.event_json ?? {}, }; const canonical = canonicalStringify(payload); const hash_hex = sha256Hex((prev_hash_hex ?? '') + canonical); const row = await prisma.custodyEvent.create({ data: { family_id: args.family_id, incident_id: args.incident_id ?? null, evidence_id: args.evidence_id ?? null, actor: args.actor, event_key: args.event_key, event_json: args.event_json ?? {}, prev_hash_hex, hash_hex, }, }); return row; } [6] ملف 2: Rule Engine (Match → Actions → Commands + Notifications) المسار: lib/rule-engine.ts // lib/rule-engine.ts import { prisma } from '@/lib/prisma'; import { createSignedDeviceCommand } from '@/lib/commands'; import { appendCustodyEvent } from '@/lib/custody'; import { sendDeviceWakeFCM } from '@/lib/fcm'; type IncidentInput = { family_id: string; device_id: string; child_user_id?: string | null; incident_type: string; risk_level: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL'; summary: string; meta_json?: any; }; type RuleAction = { command_type: string; payload?: any; expiresInSec?: number; fcm_wake?: boolean; }; function matchRule(ruleMatch: any, incident: IncidentInput): boolean { // Minimal matching (expand later): // ruleMatch = { incident_types?:[], risk_levels?:[] } const types: string[] = ruleMatch?.incident_types ?? []; const risks: string[] = ruleMatch?.risk_levels ?? []; const typeOk = types.length === 0 || types.includes(incident.incident_type); const riskOk = risks.length === 0 || risks.includes(incident.risk_level); return typeOk && riskOk; } export async function processIncidentAndApplyRules(incident: IncidentInput) { // 1) Create incident const inc = await prisma.incident.create({ data: { family_id: incident.family_id, device_id: incident.device_id, child_user_id: incident.child_user_id ?? null, incident_type: incident.incident_type, risk_level: incident.risk_level, summary: incident.summary, meta_json: incident.meta_json ?? {}, }, }); await appendCustodyEvent({ family_id: incident.family_id, incident_id: inc.incident_id, actor: device:${incident.device_id} , event_key: 'INCIDENT_CREATED', event_json: { incident_type: incident.incident_type, risk_level: incident.risk_level, summary: incident.summary, }, }); // 2) Load enabled rules (family-scoped) const rules = await prisma.autoRule.findMany({ where: { family_id: incident.family_id, enabled: true }, select: { rule_id: true, name: true, match_json: true, actions_json: true }, orderBy: { updated_at: 'desc' }, }); // 3) Evaluate and collect actions const actionsToRun: RuleAction[] = []; const matchedRules: any[] = []; for (const r of rules) { const ok = matchRule(r.match_json, incident); if (!ok) continue; code Code download content_copy expand_less matchedRules .push ({ rule_id: r.rule_id, name: r.name }); const acts: RuleAction[] = Array. isArray (r.actions_json) ? r.actions_json : (r.actions_json?.actions ?? []); for (const a of acts) actionsToRun .push ( a ); } // 4) Default fallback policy if no rules matched if (actionsToRun.length === 0) { if (incident.risk_level === 'CRITICAL') { actionsToRun.push( { command_type: 'QUARANTINE_ON', payload: {}, expiresInSec: 180, fcm_wake: true }, { command_type: 'LOCKTASK_ON', payload: { allowed_packages: [] }, expiresInSec: 180, fcm_wake: true } ); } } await appendCustodyEvent({ family_id: incident.family_id, incident_id: inc.incident_id, actor: system:rule-engine , event_key: 'RULES_EVALUATED', event_json: { matched_rules: matchedRules, actions_count: actionsToRun.length }, }); // 5) Execute actions: queue signed commands + FCM wake const queued: any[] = []; for (const a of actionsToRun) { const { row } = await createSignedDeviceCommand({ device_id: incident.device_id, incident_id: inc.incident_id, command_type: a.command_type, payload: a.payload ?? {}, expiresInSec: a.expiresInSec ?? 120, }); code Code download content_copy expand_less queued.push({ command_id : row.command_id, command_type : row.command_type, expires_at : row.expires_at, }); await appendCustodyEvent({ family_id : incident.family_id, incident_id : inc.incident_id, actor : `system:orchestrator` , event_key : 'COMMAND_QUEUED' , event_json : { device_id : incident.device_id, command_id : row.command_id, command_type : row.command_type, }, }); if (a.fcm_wake) { await sendDeviceWakeFCM(incident.device_id, incident.family_id, { type : 'COMMAND_WAITING' , incident_id : inc.incident_id, command_id : row.command_id, }); await appendCustodyEvent({ family_id : incident.family_id, incident_id : inc.incident_id, actor : `system:fcm` , event_key : 'FCM_WAKE_SENT' , event_json : { device_id : incident.device_id, command_id : row.command_id }, }); } } return { incident_id: inc.incident_id, queued_commands: queued, matched_rules: matchedRules, }; } [7] ملف 3: FCM Sender (Server) المسار: lib/fcm.ts هذا يفترض أنك تستخدم Firebase Admin SDK. ضع مفاتيحك داخل متغيرات البيئة (لا تكتبها داخل الكود). // lib/fcm.ts import admin from 'firebase-admin'; import { prisma } from '@/lib/prisma'; let initialized = false; function initFirebaseAdmin() { if (initialized) return; const projectId = process.env.FIREBASE_PROJECT_ID; const clientEmail = process.env.FIREBASE_CLIENT_EMAIL; const privateKey = process.env.FIREBASE_PRIVATE_KEY?.replace(/\n/g, '\n'); if (!projectId || !clientEmail || !privateKey) { throw new Error('Missing Firebase Admin env vars'); } admin.initializeApp({ credential: admin.credential.cert({ projectId, clientEmail, privateKey, }), }); initialized = true; } /** You need a device table field: fcm_token Save it during pairing / registration. */ export async function sendDeviceWakeFCM(device_id: string, family_id: string, data: Record<string, string>) { initFirebaseAdmin(); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, fcm_token: true }, }); if (!device || device.family_id !== family_id) return false; if (!device.fcm_token) return false; await admin.messaging().send({ token: device.fcm_token, data: Object.fromEntries(Object.entries(data).map(([k, v]) => [k, String(v)])), android: { priority: 'high', }, }); return true; } [8] ملف 4: API لاستقبال Incident من الجهاز (المدخل الرسمي للمنظومة) المسار: app/api/incidents/ingest/route.ts هذا Endpoint يستقبل Incident من الطفل ثم يُطلق Rule Engine. // app/api/incidents/ingest/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { HttpError } from '@/lib/auth'; import { processIncidentAndApplyRules } from '@/lib/rule-engine'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } async function requireDeviceAuth(req: NextRequest) { const device_id = req.headers.get('x-device-id') || ''; const token = req.headers.get('x-device-token') || ''; if (!device_id || !token) throw new HttpError(401, 'Missing device auth'); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, device_token: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (device.device_token !== token) throw new HttpError(401, 'Invalid device token'); return device; } /** POST body: { "incident_type": "GROOMING", "risk_level": "CRITICAL", "summary": "Detected grooming phrases + contact escalation", "child_user_id": "optional", "meta_json": { ... } } */ export async function POST(req: NextRequest) { try { const device = await requireDeviceAuth(req); const body = await req.json().catch(() => ({})); const incident_type = String(body?.incident_type || '').trim(); const risk_level = String(body?.risk_level || '').trim().toUpperCase(); const summary = String(body?.summary || '').trim(); if (!incident_type) throw new HttpError(400, 'incident_type is required'); if (!summary) throw new HttpError(400, 'summary is required'); const allowed = new Set(['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']); if (!allowed.has(risk_level)) throw new HttpError(400, 'Invalid risk_level'); const result = await processIncidentAndApplyRules({ family_id: device.family_id, device_id: device.device_id, child_user_id: body?.child_user_id ? String(body.child_user_id) : null, incident_type, risk_level: risk_level as any, summary, meta_json: body?.meta_json ?? {}, }); return NextResponse.json({ ok: true, ...result }, { status: 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [9] Evidence Vault — تخزين الأدلة + SHA-256 + Custody Event [9.1] الفكرة المؤسسية المختصرة عند إضافة دليل: الجهاز يرفع الملف (أو يرسل metadata + لاحقًا upload) السيرفر يحسب SHA-256 (أو يتحقق منه) ينشئ EvidenceItem يضيف CustodyEvent: EVIDENCE_ADDED الدليل يصبح جزءًا من “حزمة إثبات” قابلة للتصدير ملاحظة تنفيذية: تخزين الملفات الفعلي يكون في Object Storage (S3/R2/Blob). هنا سأبني لك الهيكل DB + custody + hash. أما التخزين نفسه فتربطه بمخزن الملفات الذي تستخدمه لاحقًا. [10] ملف 5: API لتسجيل دليل (Metadata-first) المسار: app/api/evidence/register/route.ts هذا مناسب جدًا كبداية: الجهاز يرسل metadata + sha256 + storage_key لاحقًا نضيف “upload signed URL”. // app/api/evidence/register/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { HttpError } from '@/lib/auth'; import { appendCustodyEvent } from '@/lib/custody'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } async function requireDeviceAuth(req: NextRequest) { const device_id = req.headers.get('x-device-id') || ''; const token = req.headers.get('x-device-token') || ''; if (!device_id || !token) throw new HttpError(401, 'Missing device auth'); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, device_token: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (device.device_token !== token) throw new HttpError(401, 'Invalid device token'); return device; } /** POST body: { "incident_id": "optional", "evidence_type": "SCREENSHOT", "storage_key": "family/ <id> /device/ <id> /evidence/ <file> ", "mime_type": "image/png", "size_bytes": 12345, "sha256_hex": "....", "meta_json": {...} } */ export async function POST(req: NextRequest) { try { const device = await requireDeviceAuth(req); const body = await req.json().catch(() => ({})); const incident_id = body?.incident_id ? String(body.incident_id) : null; const evidence_type = String(body?.evidence_type || '').trim(); const storage_key = String(body?.storage_key || '').trim(); const mime_type = String(body?.mime_type || '').trim(); const size_bytes = Number(body?.size_bytes ?? 0); const sha256_hex = String(body?.sha256_hex || '').trim(); if (!evidence_type || !storage_key || !mime_type || !sha256_hex || !size_bytes) { throw new HttpError(400, 'Missing evidence fields'); } const row = await prisma.evidenceItem.create({ data: { family_id: device.family_id, incident_id, device_id: device.device_id, evidence_type, storage_key, mime_type, size_bytes, sha256_hex, captured_by: 'device', meta_json: body?.meta_json ?? {}, }, }); await appendCustodyEvent({ family_id: device.family_id, incident_id, evidence_id: row.evidence_id, actor: device:${device.device_id} , event_key: 'EVIDENCE_ADDED', event_json: { evidence_id: row.evidence_id, evidence_type, storage_key, sha256_hex, size_bytes, }, }); return NextResponse.json({ ok: true, evidence_id: row.evidence_id }, { status: 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [11] Export Evidence Bundle (حزمة بلاغ جاهزة) [11.1] ماذا تحتوي الحزمة؟ incident.json custody_timeline.json (مع hashes) evidence_manifest.json (sha256 لكل دليل) روابط الأدلة (أو ملفات مرفقة داخل ZIP لاحقًا) هنا سنبني “metadata export” الآن، وضم الملفات داخل zip نضيفه لاحقًا حسب مخزن التخزين. [12] ملف 6: API لإنشاء Export Bundle (Metadata) المسار: app/api/exports/create/route.ts // app/api/exports/create/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { appendCustodyEvent } from '@/lib/custody'; import crypto from 'crypto'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function sha256Hex(data: string) { return crypto.createHash('sha256').update(data).digest('hex'); } /** POST body: { "incident_id": "..." } */ export async function POST(req: NextRequest) { try { const principal = getPrincipal(req); const body = await req.json().catch(() => ({})); const incident_id = String(body?.incident_id || '').trim(); if (!incident_id) throw new HttpError(400, 'incident_id is required'); const inc = await prisma.incident.findUnique({ where: { incident_id }, select: { incident_id: true, family_id: true, device_id: true, incident_type: true, risk_level: true, summary: true, detected_at: true, meta_json: true }, }); if (!inc) throw new HttpError(404, 'Incident not found'); if (!requireFamilyAccess(principal, inc.family_id)) throw new HttpError(403, 'Forbidden'); const evidence = await prisma.evidenceItem.findMany({ where: { family_id: inc.family_id, incident_id: inc.incident_id }, orderBy: { captured_at: 'asc' }, select: { evidence_id: true, evidence_type: true, storage_key: true, mime_type: true, size_bytes: true, sha256_hex: true, captured_at: true, meta_json: true }, }); const custody = await prisma.custodyEvent.findMany({ where: { family_id: inc.family_id, incident_id: inc.incident_id }, orderBy: { event_at: 'asc' }, select: { custody_id: true, actor: true, event_key: true, event_at: true, event_json: true, prev_hash_hex: true, hash_hex: true }, }); const bundle = { incident: inc, evidence_manifest: evidence, custody_timeline: custody, generated_at: new Date().toISOString(), format_version: 1, }; const bundleJson = JSON.stringify(bundle); const bundleHash = sha256Hex(bundleJson); const exportRow = await prisma.evidenceExport.create({ data: { family_id: inc.family_id, incident_id: inc.incident_id, created_by: user:${principal.principal_id} , status: 'READY', export_key: null, sha256_hex: bundleHash, meta_json: { format: 'metadata_bundle_v1' }, }, }); await appendCustodyEvent({ family_id: inc.family_id, incident_id: inc.incident_id, actor: user:${principal.principal_id} , event_key: 'EXPORT_CREATED', event_json: { export_id: exportRow.export_id, sha256_hex: bundleHash }, }); return NextResponse.json( { ok: true, export_id: exportRow.export_id, sha256_hex: bundleHash, bundle, }, { status: 200 } ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [13] ماذا أصبح لديك الآن (بشكل دقيق)? Incident API من الجهاز Rule Engine يطبّق الدفاع تلقائيًا أوامر Signed Commands + FCM Wake + ACK Evidence Registry + Custody Event Custody Timeline بسلسلة Hash تمنع العبث Export Bundle جاهز كحزمة أدلة مؤسسية هذا هو “العمود الفقري” لمنصة الأدلة الرقمية والرقابة المؤسسية. [14] المرحلة التالية الأقوى (تطوير منطقي بعد هذه النواة) هنا تبدأ ميزات Bark لكن بشكل “أذكى وأقوى”: Policy Profiles لكل طفل (Study/Sleep/Travel/High-Risk) مع تبديل تلقائي حسب الوقت/المكان Decision AI على الجهاز (0.05s) ثم “Server Confirmation” لتقليل False Positives Evidence Upload Signed URLs (رفع ملفات فعليًا بشكل آمن) Walkie-Talkie + Live Camera لكن ضمن ضوابط صارمة وشفافية للأهل Parent Console UI لعرض: الحادثة الأوامر التي اتخذت ACK proof الأدلة زر “Create Export” للبلاغ [15] Suggested Next Steps [15.1] أكتب لك الآن Default AutoRules جاهزة (GROOMING/SEXTORTION/SELF_HARM…) وتُحفظ مباشرة في DB كـ seed. [15.2] ثم أضيف “UI endpoints” لعرض Incident Details + Custody Timeline + Command Status داخل لوحة الوالدين. [15.3] ثم نبدأ المرحلة المتقدمة: Signed Upload URLs لرفع الأدلة الحقيقية (صور/صوت/فيديو) داخل Evidence Vault بشكل كامل.
[146] [1] ## ممتاز — نكمل الآن بـ 3 مكونات “جاهزة للإطلاق المؤسسي”: Default AutoRules Seed (قواعد جاهزة تُزرع في قاعدة البيانات) Parent Console APIs لعرض: Incidents + Custody + Evidence + Commands Evidence Upload Signed URLs لرفع الأدلة فعليًا (صور/صوت/فيديو) بشكل آمن الهدف: يصبح عندك نظام مكتمل: Incident → Rule Engine → Commands (FCM) → ACK → Evidence Vault → Custody Timeline → Export [2] زرع قواعد افتراضية Default AutoRules (Seed جاهز) [2.1] ملف Seed كامل (Prisma) المسار: prisma/seed.ts هذا يضيف قواعد قوية للأسرة (قابلة للتعديل لاحقًا من لوحة الوالد) // prisma/seed.ts import { PrismaClient } from '@prisma/client'; const prisma = new PrismaClient(); /** IMPORTANT: Update FAMILY_ID to your real family id after creating the first family. Or modify to insert per-family on creation. */ const FAMILY_ID = process.env.SEED_FAMILY_ID || ''; function requireFamilyId() { if (!FAMILY_ID) { throw new Error('Missing SEED_FAMILY_ID in env'); } } async function upsertRule(args: { family_id: string; name: string; match_json: any; actions_json: any; }) { // Use name as a stable unique key per family (simple approach) const existing = await prisma.autoRule.findFirst({ where: { family_id: args.family_id, name: args.name }, select: { rule_id: true }, }); if (existing) { await prisma.autoRule.update({ where: { rule_id: existing.rule_id }, data: { enabled: true, match_json: args.match_json, actions_json: args.actions_json, }, }); return { updated: true }; } await prisma.autoRule.create({ data: { family_id: args.family_id, name: args.name, enabled: true, match_json: args.match_json, actions_json: args.actions_json, }, }); return { created: true }; } async function main() { requireFamilyId(); // Rule 1: Sexual Grooming / Exploitation (Critical) await upsertRule({ family_id: FAMILY_ID, name: 'Critical: Grooming / Exploitation', match_json: { incident_types: ['GROOMING', 'EXPLOITATION'], risk_levels: ['CRITICAL'], }, actions_json: [ { command_type: 'QUARANTINE_ON', payload: {}, expiresInSec: 180, fcm_wake: true }, { command_type: 'BLOCK_APPS_SET', payload: { hidden: true, packages: ['com.whatsapp', 'org.telegram.messenger', 'com.snapchat.android'], }, expiresInSec: 180, fcm_wake: true, }, { command_type: 'LOCKTASK_ON', payload: { allowed_packages: [] }, expiresInSec: 180, fcm_wake: true, }, ], }); // Rule 2: Sextortion / Blackmail (Critical) await upsertRule({ family_id: FAMILY_ID, name: 'Critical: Sextortion / Blackmail', match_json: { incident_types: ['SEXTORTION', 'BLACKMAIL'], risk_levels: ['CRITICAL'], }, actions_json: [ { command_type: 'QUARANTINE_ON', payload: {}, expiresInSec: 240, fcm_wake: true }, { command_type: 'LOCKTASK_ON', payload: { allowed_packages: [] }, expiresInSec: 240, fcm_wake: true, }, { command_type: 'BLOCK_APPS_SET', payload: { hidden: true, packages: ['com.whatsapp', 'org.telegram.messenger', 'com.snapchat.android', 'com.instagram.android'], }, expiresInSec: 240, fcm_wake: true, }, ], }); // Rule 3: Self-harm signals (High) await upsertRule({ family_id: FAMILY_ID, name: 'High: Self-Harm Signals', match_json: { incident_types: ['SELF_HARM'], risk_levels: ['HIGH', 'CRITICAL'], }, actions_json: [ { command_type: 'QUARANTINE_ON', payload: {}, expiresInSec: 180, fcm_wake: true }, // Keep device accessible for emergency contact via allowed packages later { command_type: 'LOCKTASK_ON', payload: { allowed_packages: [] }, expiresInSec: 120, fcm_wake: true, }, ], }); // Rule 4: Bullying / Harassment (Medium) await upsertRule({ family_id: FAMILY_ID, name: 'Medium: Bullying / Harassment', match_json: { incident_types: ['BULLYING', 'HARASSMENT'], risk_levels: ['MEDIUM', 'HIGH'], }, actions_json: [ { command_type: 'BLOCK_APPS_SET', payload: { hidden: true, packages: ['com.whatsapp', 'org.telegram.messenger'] }, expiresInSec: 180, fcm_wake: true, }, ], }); // Rule 5: Adult content exposure (Medium) await upsertRule({ family_id: FAMILY_ID, name: 'Medium: Adult Content Exposure', match_json: { incident_types: ['ADULT_CONTENT'], risk_levels: ['MEDIUM', 'HIGH'], }, actions_json: [ { command_type: 'BLOCK_APPS_SET', payload: { hidden: true, packages: ['com.android.chrome', 'com.google.android.youtube'] }, expiresInSec: 180, fcm_wake: true, }, { command_type: 'QUARANTINE_ON', payload: {}, expiresInSec: 120, fcm_wake: true }, ], }); console.log('Seed completed successfully.'); } main() .catch((e) => { console.error(e); process.exit(1); }) .finally(async () => { await prisma.$disconnect(); }); [2.2] تفعيل seed داخل package.json افتح package.json وأضف: { "prisma": { "seed": "ts-node prisma/seed.ts" } } ثم شغّل: SEED_FAMILY_ID="YOUR_FAMILY_ID" npx prisma db seed [3] Parent Console APIs (عرض الحوادث + الأدلة + سجل custody + الأوامر) سنضيف 4 Endpoints رئيسية: List Incidents Incident Details Incident Custody Timeline Incident Commands Status كلها تعتمد على: getPrincipal + requireFamilyAccess الموجودة عندك. [3.1] API 1 — List Incidents (Pagination + Filters) المسار: app/api/families/[id]/incidents/route.ts // app/api/families/[id]/incidents/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const family_id = ctx.params.id; code Code download content_copy expand_less if (!requireFamilyAccess(principal, family_id)) throw new HttpError( 403 , 'Forbidden' ); const url = new URL(req.url); const risk = (url.searchParams. get ( 'risk' ) || '' ).toUpperCase(); // LOW|MEDIUM|HIGH|CRITICAL const status = (url.searchParams. get ( 'status' ) || '' ).toUpperCase(); // OPEN|MITIGATED|CLOSED const device_id = url.searchParams. get ( 'device_id' ) || '' ; const limit = Math.max( 10 , Math.min( 100 , Number(url.searchParams. get ( 'limit' ) || 30 ))); const cursor = url.searchParams. get ( 'cursor' ); // detected_at ISO cursor const where : any = { family_id }; if (risk) where .risk_level = risk; if (status) where .status = status; if (device_id) where .device_id = device_id; if (cursor) { where .detected_at = { lt: new Date(cursor) }; } const rows = await prisma.incident.findMany({ where , orderBy: { detected_at: 'desc' }, take: limit, select: { incident_id: true , device_id: true , child_user_id: true , incident_type: true , risk_level: true , summary: true , detected_at: true , status: true , }, }); const nextCursor = rows.length ? rows[rows.length - 1 ].detected_at.toISOString() : null ; return NextResponse.json({ ok: true , items: rows, next_cursor: nextCursor }, { status: 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [3.2] API 2 — Incident Details (Evidence included) المسار: app/api/incidents/[id]/route.ts // app/api/incidents/[id]/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const inc = await prisma.incident.findUnique({ where : { incident_id }, select : { incident_id : true , family_id : true , device_id : true , child_user_id : true , incident_type : true , risk_level : true , summary : true , detected_at : true , status : true , meta_json : true , }, }); if (!inc) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, inc.family_id)) throw new HttpError( 403 , 'Forbidden' ); const evidence = await prisma.evidenceItem.findMany({ where : { family_id : inc.family_id, incident_id : inc.incident_id }, orderBy : { captured_at : 'asc' }, select : { evidence_id : true , evidence_type : true , storage_key : true , mime_type : true , size_bytes : true , sha256_hex : true , captured_at : true , meta_json : true , }, }); return NextResponse.json({ ok : true , incident : inc, evidence }, { status : 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [3.3] API 3 — Custody Timeline (Hash Chain) المسار: app/api/incidents/[id]/custody/route.ts // app/api/incidents/[id]/custody/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const inc = await prisma.incident.findUnique({ where : { incident_id }, select : { family_id : true , incident_id : true }, }); if (!inc) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, inc.family_id)) throw new HttpError( 403 , 'Forbidden' ); const custody = await prisma.custodyEvent.findMany({ where : { family_id : inc.family_id, incident_id : inc.incident_id }, orderBy : { event_at : 'asc' }, select : { custody_id : true , actor : true , event_key : true , event_at : true , event_json : true , prev_hash_hex : true , hash_hex : true , }, }); return NextResponse.json({ ok : true , items : custody }, { status : 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [3.4] API 4 — Commands Status (Queued/Acked/Failed) المسار: app/api/incidents/[id]/commands/route.ts // app/api/incidents/[id]/commands/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const incident_id = ctx.params.id; code Code download content_copy expand_less const inc = await prisma.incident.findUnique({ where : { incident_id }, select : { incident_id : true , family_id : true , device_id : true }, }); if (!inc) throw new HttpError( 404 , 'Incident not found' ); if (!requireFamilyAccess(principal, inc.family_id)) throw new HttpError( 403 , 'Forbidden' ); const commands = await prisma.deviceCommand.findMany({ where : { family_id : inc.family_id, incident_id : inc.incident_id }, orderBy : { issued_at : 'asc' }, select : { command_id : true , device_id : true , command_type : true , issued_at : true , expires_at : true , status : true , acked_at : true , ack_json : true , }, }); return NextResponse.json({ ok : true , items : commands }, { status : 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [4] Evidence Upload Signed URLs (رفع الأدلة فعليًا بأعلى معيار أمني) الآن نكمل Evidence Vault بشكل مؤسسي: بدل أن يرفع الجهاز مباشرة إلى السيرفر، نستخدم: Signed Upload URL (قصير العمر + محدد الحجم + محدد النوع) يرفع الجهاز للـ Object Storage مباشرة ثم يسجل Metadata في EvidenceItem (مع sha256) هذا هو النموذج العالمي الأفضل. [5] تنفيذ Signed URL باستخدام S3-Compatible (AWS SDK v3) يصلح لـ AWS S3 أو Cloudflare R2 أو أي S3 Compatible. [5.1] تثبيت الحزم npm i @aws-sdk/client-s3 @aws-sdk/s3-request-presigner [5.2] ملف Storage Client المسار: lib/storage.ts // lib/storage.ts import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3'; import { getSignedUrl } from '@aws-sdk/s3-request-presigner'; function requireEnv(name: string) { const v = process.env[name]; if (!v) throw new Error( Missing env: ${name} ); return v; } export function s3Client() { const region = process.env.S3_REGION || 'auto'; const endpoint = process.env.S3_ENDPOINT; // optional (R2 or custom) const accessKeyId = requireEnv('S3_ACCESS_KEY_ID'); const secretAccessKey = requireEnv('S3_SECRET_ACCESS_KEY'); return new S3Client({ region, endpoint: endpoint || undefined, credentials: { accessKeyId, secretAccessKey }, forcePathStyle: !!endpoint, // usually needed for R2/custom endpoints }); } export async function createSignedUploadUrl(args: { bucket: string; key: string; contentType: string; expiresInSec: number; }) { const client = s3Client(); const cmd = new PutObjectCommand({ Bucket: args.bucket, Key: args.key, ContentType: args.contentType, }); const url = await getSignedUrl(client, cmd, { expiresIn: args.expiresInSec }); return url; } [6] API: إنشاء Signed Upload URL للجهاز (Secure Evidence Upload) المسار: app/api/evidence/upload-url/route.ts الجهاز يطلب URL، السيرفر يحدد مكان التخزين + مدة + نوع الملف ثم الجهاز يرفع الملف مباشرة إلى التخزين // app/api/evidence/upload-url/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { HttpError } from '@/lib/auth'; import { createSignedUploadUrl } from '@/lib/storage'; import crypto from 'crypto'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } async function requireDeviceAuth(req: NextRequest) { const device_id = req.headers.get('x-device-id') || ''; const token = req.headers.get('x-device-token') || ''; if (!device_id || !token) throw new HttpError(401, 'Missing device auth'); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, device_token: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (device.device_token !== token) throw new HttpError(401, 'Invalid device token'); return device; } /** POST body: { "incident_id": "optional", "evidence_type": "SCREENSHOT", "mime_type": "image/png", "size_bytes": 12345 } returns: { upload_url, storage_key, expires_in_sec } */ export async function POST(req: NextRequest) { try { const device = await requireDeviceAuth(req); const body = await req.json().catch(() => ({})); const incident_id = body?.incident_id ? String(body.incident_id) : null; const evidence_type = String(body?.evidence_type || '').trim(); const mime_type = String(body?.mime_type || '').trim(); const size_bytes = Number(body?.size_bytes ?? 0); if (!evidence_type || !mime_type || !size_bytes) throw new HttpError(400, 'Missing fields'); // Hard limits (server-side enforcement policy) const MAX = 25 * 1024 * 1024; // 25MB if (size_bytes <= 0 || size_bytes > MAX) throw new HttpError(400, 'Invalid size_bytes'); const bucket = process.env.S3_BUCKET_NAME; if (!bucket) throw new HttpError(500, 'Missing S3_BUCKET_NAME'); const ext = mime_type.includes('png') ? 'png' : mime_type.includes('jpeg') ? 'jpg' : mime_type.includes('webm') ? 'webm' : mime_type.includes('mp4') ? 'mp4' : mime_type.includes('audio') ? 'aac' : 'bin'; const nonce = crypto.randomBytes(10).toString('hex'); const storage_key = family/${device.family_id}/device/${device.device_id}/evidence/${Date.now()}_${nonce}.${ext} ; const expires_in_sec = 60; // very short-lived const upload_url = await createSignedUploadUrl({ bucket, key: storage_key, contentType: mime_type, expiresInSec: expires_in_sec, }); return NextResponse.json( { ok: true, upload_url, storage_key, expires_in_sec }, { status: 200 } ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [7] Android: رفع الأدلة باستخدام Signed URL (Client Upload) [7.1] ملف EvidenceUploader.kt كامل المسار: app/src/main/java/com/amana/childagent/evidence/EvidenceUploader.kt package com.amana.childagent.evidence import android.content.Context import com.amana.childagent.security.DeviceSecretStore import okhttp3.MediaType.Companion.toMediaType import okhttp3.OkHttpClient import okhttp3.Request import okhttp3.RequestBody.Companion.toRequestBody import kotlinx.serialization.json.Json import kotlinx.serialization.json.jsonObject import kotlinx.serialization.json.jsonPrimitive import kotlinx.serialization.json.jsonArray import kotlinx.serialization.json.JsonObject import kotlinx.serialization.json.buildJsonObject import kotlinx.serialization.json.put import java.io.File import java.security.MessageDigest class EvidenceUploader(private val ctx: Context) { code Code download content_copy expand_less private val client = OkHttpClient.Builder().build() private val json = Json { ignoreUnknownKeys = true ; isLenient = true } private fun sha256Hex (file: File ) : String { val md = MessageDigest.getInstance( "SHA-256" ) file.inputStream().use { input -> val buf = ByteArray( 8192 ) while ( true ) { val r = input.read(buf) if (r <= 0 ) break md.update(buf, 0 , r) } } return md.digest().joinToString( "" ) { "%02x" .format(it) } } /** * Step 1: request signed upload url */ private fun requestUploadUrl ( baseUrl: String , deviceId: String , deviceToken: String , incidentId: String ?, evidenceType: String , mimeType: String , sizeBytes: Long ) : Triple<String, String, Int > { val url = " $baseUrl /api/evidence/upload-url" val payload = buildJsonObject { if (!incidentId.isNullOrBlank()) put( "incident_id" , incidentId) put( "evidence_type" , evidenceType) put( "mime_type" , mimeType) put( "size_bytes" , sizeBytes) } val req = Request.Builder() .url(url) .addHeader( "x-device-id" , deviceId) .addHeader( "x-device-token" , deviceToken) .post(payload.toString().toRequestBody( "application/json; charset=utf-8" .toMediaType())) .build() client.newCall(req).execute().use { resp -> if (!resp.isSuccessful) throw RuntimeException( "upload-url failed: ${resp.code} " ) val txt = resp.body?.string() ?: "{}" val el = json.parseToJsonElement(txt).jsonObject val uploadUrl = el[ "upload_url" ]?.jsonPrimitive?.content ?: "" val storageKey = el[ "storage_key" ]?.jsonPrimitive?.content ?: "" val expires = el[ "expires_in_sec" ]?.jsonPrimitive?.content?.toIntOrNull() ?: 60 if (uploadUrl.isBlank() || storageKey.isBlank()) throw RuntimeException( "invalid upload-url response" ) return Triple(uploadUrl, storageKey, expires) } } /** * Step 2: upload file directly to signed url */ private fun putToSignedUrl (uploadUrl: String , file: File , mimeType: String ) { val req = Request.Builder() .url(uploadUrl) .put(file.readBytes().toRequestBody(mimeType.toMediaType())) .build() client.newCall(req).execute().use { resp -> if (!resp.isSuccessful) throw RuntimeException( "upload PUT failed: ${resp.code} " ) } } /** * Step 3: register metadata to server (EvidenceItem) */ private fun registerEvidence ( baseUrl: String , deviceId: String , deviceToken: String , incidentId: String ?, evidenceType: String , storageKey: String , mimeType: String , sizeBytes: Long , sha256Hex: String ) : String { val url = " $baseUrl /api/evidence/register" val payload = buildJsonObject { if (!incidentId.isNullOrBlank()) put( "incident_id" , incidentId) put( "evidence_type" , evidenceType) put( "storage_key" , storageKey) put( "mime_type" , mimeType) put( "size_bytes" , sizeBytes) put( "sha256_hex" , sha256Hex) } val req = Request.Builder() .url(url) .addHeader( "x-device-id" , deviceId) .addHeader( "x-device-token" , deviceToken) .post(payload.toString().toRequestBody( "application/json; charset=utf-8" .toMediaType())) .build() client.newCall(req).execute().use { resp -> if (!resp.isSuccessful) throw RuntimeException( "evidence register failed: ${resp.code} " ) val txt = resp.body?.string() ?: "{}" val el = json.parseToJsonElement(txt).jsonObject return el[ "evidence_id" ]?.jsonPrimitive?.content ?: "" } } /** * Full pipeline: Signed URL -> Upload -> Register -> Custody */ fun uploadEvidenceFile ( file: File , incidentId: String ?, evidenceType: String , mimeType: String ) : String { val store = DeviceSecretStore(ctx) val baseUrl = store.getBaseUrl() val deviceId = store.getDeviceId() val deviceToken = store.getDeviceToken() if (baseUrl.isBlank() || deviceId.isBlank() || deviceToken.isBlank()) { throw RuntimeException( "Missing device secrets" ) } val sizeBytes = file.length() val sha = sha256Hex(file) val (uploadUrl, storageKey, _) = requestUploadUrl( baseUrl = baseUrl, deviceId = deviceId, deviceToken = deviceToken, incidentId = incidentId, evidenceType = evidenceType, mimeType = mimeType, sizeBytes = sizeBytes ) putToSignedUrl(uploadUrl, file, mimeType) val evidenceId = registerEvidence( baseUrl = baseUrl, deviceId = deviceId, deviceToken = deviceToken, incidentId = incidentId, evidenceType = evidenceType, storageKey = storageKey, mimeType = mimeType, sizeBytes = sizeBytes, sha256Hex = sha ) return evidenceId } } [8] الآن أصبحت المنصة “Evidence Vault كاملة” عند الحادثة يحدث التالي عمليًا: On-device detection يفعل Incident Ingest Rule Engine يطلق Commands FCM يوقظ الجهاز الجهاز يطبّق الدفاع ويرسل ACK موقّع الجهاز يرفع Evidence عبر Signed URL السيرفر يسجل EvidenceItem + Custody hash chain الوالد يرى Incident + Evidence + Commands + Custody Export bundle جاهز [9] ترقية أخيرة مهمة جدًا الآن: “Zero Trust على الأدلة” لزيادة قوة الأدلة القانونية والمؤسسية: لا تعتمد فقط على SHA-256 من الجهاز أضف “Server-side verification” عند اكتمال الرفع: آلية: بعد رفع الملف → السيرفر (Worker) يقرأ الملف من التخزين ويحسب SHA-256 ثم يقارن. هذه إضافة ممتازة لاحقًا لأن بعض التخزين يحتاج صلاحيات قراءة داخل بيئة السيرفر. [10] Suggested Next Steps [10.1] أكتب لك الآن واجهة Parent Console UI (React/Next) لعرض Incident Dashboard بشكل احترافي: قائمة الحوادث صفحة تفاصيل الحادثة تبويب Evidence + Custody Timeline + Command Results [10.2] ثم نضيف “Policy Profiles” لكل طفل (Sleep/Study/Travel/High-Risk) مع جدولة زمنية + Geo-fencing. [10.3] ثم ننتقل لأقوى ميزة تنافس Bark فعلًا: Walkie-Talkie + Live Camera (مع ضوابط صارمة) داخل العائلة فقط، وتوثيق أي تشغيل داخل Custody Timeline.
[147] [1] ## ممتاز — نكمل الآن بالواجهة الاحترافية للوالدين Parent Console UI (Next.js App Router) سننفّذ واجهة مؤسسية تعرض كل شيء بشكل واضح وسريع: Dashboard: قائمة الحوادث Incidents مع فلاتر + Pagination Incident Details صفحة تفصيلية تبويب الأدلة Evidence تبويب سجل الحيازة Custody Timeline (Hash Chain) تبويب حالة الأوامر Commands Status تصميم UI قابل للتوسع لميزات لاحقة (Profiles / Rules / Exports) جميع الأكواد أدناه كاملة لكل ملف من أول سطر لآخر سطر. [2] هيكل الصفحات (App Router) سنبني هذا المسار (مقترح قياسي): app/(parent)/families/[familyId]/incidents/page.tsx app/(parent)/incidents/[incidentId]/page.tsx ومجلد Components: components/parent/IncidentsTable.tsx components/parent/IncidentDetailsTabs.tsx components/parent/EvidenceList.tsx components/parent/CustodyTimeline.tsx components/parent/CommandsStatusTable.tsx [3] ملف الصفحة 1: قائمة الحوادث Incidents List المسار: app/(parent)/families/[familyId]/incidents/page.tsx 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import IncidentsTable, { IncidentRow } from '@/components/parent/IncidentsTable'; type ApiListResponse = { ok: boolean; items: IncidentRow[]; next_cursor: string | null; }; function buildUrl(base: string, params: Record<string, string | number | undefined | null>) { const u = new URL(base); Object.entries(params).forEach(([k, v]) => { if (v === undefined || v === null || String(v).trim() === '') return; u.searchParams.set(k, String(v)); }); return u.toString(); } export default function FamilyIncidentsPage({ params, }: { params: { familyId: string }; }) { const familyId = params.familyId; const [risk, setRisk] = useState <string> (''); const [status, setStatus] = useState <string> (''); const [deviceId, setDeviceId] = useState <string> (''); const [items, setItems] = useState<IncidentRow[]>([]); const [nextCursor, setNextCursor] = useState<string | null>(null); const [loading, setLoading] = useState <boolean> (true); const [loadingMore, setLoadingMore] = useState <boolean> (false); const [err, setErr] = useState <string> (''); const baseEndpoint = useMemo(() => { return /api/families/${encodeURIComponent(familyId)}/incidents ; }, [familyId]); async function loadFirstPage() { setLoading(true); setErr(''); try { const url = buildUrl(baseEndpoint, { risk: risk || undefined, status: status || undefined, device_id: deviceId || undefined, limit: 30, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiListResponse; if (!res.ok || !json.ok) { throw new Error (json?.[ 'error' ]?.message || 'Failed to load incidents' ); } setItems(json.items || []); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); setItems([]); setNextCursor( null ); } finally { setLoading( false ); } } async function loadMore() { if (!nextCursor) return; setLoadingMore(true); setErr(''); code Code download content_copy expand_less try { const url = buildUrl(baseEndpoint, { risk : risk || undefined , status : status || undefined , device_id : deviceId || undefined , limit : 30 , cursor : nextCursor, }); const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiListResponse; if (!res.ok || !json.ok) { throw new Error (json?.[ 'error' ]?.message || 'Failed to load more incidents' ); } setItems( ( prev ) => [...prev, ...(json.items || [])]); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); } finally { setLoadingMore( false ); } } useEffect(() => { loadFirstPage(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [risk, status, deviceId, baseEndpoint]); return ( <div className="min-h-screen bg-white"> <div className="mx-auto max-w-6xl px-4 py-6"> <div className="flex flex-col gap-2"> <h1 className="text-xl font-semibold text-gray-900"> Incidents </h1> <p className="text-sm text-gray-600"> Review detected safety incidents, evidence, custody timeline, and automated defense actions. </p> </div> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white shadow-sm" > < div className = "p-4" > < div className = "grid grid-cols-1 gap-3 md:grid-cols-4" > < div className = "flex flex-col gap-1" > < label className = "text-xs font-medium text-gray-700" > Risk Level </ label > < select className = "w-full rounded-xl border border-gray-200 px-3 py-2 text-sm text-gray-900 outline-none focus:ring-2 focus:ring-gray-200" value = {risk} onChange = {(e) => setRisk(e.target.value)} > < option value = "" > All </ option > < option value = "LOW" > LOW </ option > < option value = "MEDIUM" > MEDIUM </ option > < option value = "HIGH" > HIGH </ option > < option value = "CRITICAL" > CRITICAL </ option > </ select > </ div > < div className = "flex flex-col gap-1" > < label className = "text-xs font-medium text-gray-700" > Status </ label > < select className = "w-full rounded-xl border border-gray-200 px-3 py-2 text-sm text-gray-900 outline-none focus:ring-2 focus:ring-gray-200" value = {status} onChange = {(e) => setStatus(e.target.value)} > < option value = "" > All </ option > < option value = "OPEN" > OPEN </ option > < option value = "MITIGATED" > MITIGATED </ option > < option value = "CLOSED" > CLOSED </ option > </ select > </ div > < div className = "flex flex-col gap-1 md:col-span-2" > < label className = "text-xs font-medium text-gray-700" > Device ID (optional) </ label > < input className = "w-full rounded-xl border border-gray-200 px-3 py-2 text-sm text-gray-900 outline-none focus:ring-2 focus:ring-gray-200" value = {deviceId} onChange = {(e) => setDeviceId(e.target.value)} placeholder="Filter by a specific device_id" /> </ div > </ div > {err ? ( < div className = "mt-4 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > ) : null} </ div > < div className = "border-t border-gray-200" > < IncidentsTable loading = {loading} items = {items} familyId = {familyId} /> </ div > < div className = "flex items-center justify-between px-4 py-4" > < div className = "text-xs text-gray-500" > {items.length === 0 && !loading ? 'No incidents found.' : `Loaded: ${items.length}`} </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50" onClick = {loadMore} disabled = {!nextCursor || loadingMore } > {loadingMore ? 'Loading...' : nextCursor ? 'Load more' : 'No more'} </ button > </ div > </ div > </ div > </ div > ); } [4] Component: جدول الحوادث IncidentsTable المسار: components/parent/IncidentsTable.tsx 'use client'; import React from 'react'; import Link from 'next/link'; export type IncidentRow = { incident_id: string; device_id: string; child_user_id: string | null; incident_type: string; risk_level: string; summary: string; detected_at: string; status: string; }; function riskBadge(risk: string) { const r = (risk || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium'; if (r === 'CRITICAL') return ${base} bg-red-50 text-red-700 border border-red-200 ; if (r === 'HIGH') return ${base} bg-orange-50 text-orange-700 border border-orange-200 ; if (r === 'MEDIUM') return ${base} bg-yellow-50 text-yellow-700 border border-yellow-200 ; return ${base} bg-gray-50 text-gray-700 border border-gray-200 ; } function statusBadge(status: string) { const s = (status || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium'; if (s === 'OPEN') return ${base} bg-blue-50 text-blue-700 border border-blue-200 ; if (s === 'MITIGATED') return ${base} bg-green-50 text-green-700 border border-green-200 ; if (s === 'CLOSED') return ${base} bg-gray-50 text-gray-700 border border-gray-200 ; return ${base} bg-gray-50 text-gray-700 border border-gray-200 ; } export default function IncidentsTable({ loading, items, familyId, }: { loading: boolean; items: IncidentRow[]; familyId: string; }) { return ( <div className="w-full overflow-x-auto"> <table className="min-w-full border-separate border-spacing-0"> <thead> <tr className="bg-gray-50"> <th className="sticky left-0 z-10 border-b border-gray-200 bg-gray-50 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Incident </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Risk </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Status </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Device </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Detected At </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Summary </th> </tr> </thead> code Code download content_copy expand_less < tbody > {loading ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > Loading incidents... </ td > </ tr > ) : items.length === 0 ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > No incidents available. </ td > </ tr > ) : ( items.map((it) => ( < tr key = {it.incident_id} className = "hover:bg-gray-50" > < td className = "sticky left-0 z-10 border-b border-gray-200 bg-white px-4 py-3 text-sm text-gray-900" > < Link href = { `/ incidents /${ encodeURIComponent ( it.incident_id )}`} className = "font-semibold text-gray-900 underline-offset-2 hover:underline" > {it.incident_type} </ Link > < div className = "mt-1 text-xs text-gray-500" > ID: < span className = "font-mono" > {it.incident_id.slice(0, 12)}... </ span > </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3" > < span className = {riskBadge(it.risk_level)} > {it.risk_level} </ span > </ td > < td className = "border-b border-gray-200 px-4 py-3" > < span className = {statusBadge(it.status)} > {it.status} </ span > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > < div className = "font-mono text-xs" > {it.device_id} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {new Date(it.detected_at).toLocaleString()} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > < div className = "max-w-[520px] truncate" > {it.summary} </ div > </ td > </ tr > )) )} </ tbody > </ table > < div className = "px-4 py-3 text-xs text-gray-500" > Family: < span className = "font-mono" > {familyId} </ span > </ div > </ div > ); } [5] ملف الصفحة 2: Incident Details مع Tabs (Evidence / Custody / Commands) المسار: app/(parent)/incidents/[incidentId]/page.tsx 'use client'; import React, { useEffect, useState } from 'react'; import IncidentDetailsTabs from '@/components/parent/IncidentDetailsTabs'; type IncidentDetailsResponse = { ok: boolean; incident: { incident_id: string; family_id: string; device_id: string; child_user_id: string | null; incident_type: string; risk_level: string; summary: string; detected_at: string; status: string; meta_json: any; }; evidence: any[]; }; export default function IncidentDetailsPage({ params, }: { params: { incidentId: string }; }) { const incidentId = params.incidentId; const [loading, setLoading] = useState(true); const [err, setErr] = useState(''); const [data, setData] = useState<IncidentDetailsResponse | null>(null); async function load() { setLoading(true); setErr(''); code Code download content_copy expand_less try { const res = await fetch( `/api/incidents/ ${ encodeURIComponent (incidentId)} ` , { method : 'GET' , cache : 'no-store' , }); const json = ( await res.json()) as IncidentDetailsResponse; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load incident details' ); } setData(json); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); setData( null ); } finally { setLoading( false ); } } useEffect(() => { load(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [incidentId]); return ( <div className="min-h-screen bg-white"> <div className="mx-auto max-w-6xl px-4 py-6"> <div className="flex items-start justify-between gap-4"> <div className="flex flex-col gap-2"> <h1 className="text-xl font-semibold text-gray-900"> Incident Details </h1> <p className="text-sm text-gray-600"> Evidence, custody timeline, and automated defense actions for this incident. </p> </div> code Code download content_copy expand_less < button onClick = {load} className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" > Refresh </ button > </ div > < div className = "mt-5 rounded-2xl border border-gray-200 bg-white shadow-sm" > {loading ? ( < div className = "p-4 text-sm text-gray-700" > Loading... </ div > ) : err ? ( < div className = "p-4" > < div className = "rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > </ div > ) : data ? ( < IncidentDetailsTabs incident = {data.incident} evidence = {data.evidence} /> ) : ( < div className = "p-4 text-sm text-gray-700" > No data. </ div > )} </ div > </ div > </ div > ); } [6] Component: IncidentDetailsTabs المسار: components/parent/IncidentDetailsTabs.tsx 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import EvidenceList from '@/components/parent/EvidenceList'; import CustodyTimeline, { CustodyEvent } from '@/components/parent/CustodyTimeline'; import CommandsStatusTable, { DeviceCommandRow } from '@/components/parent/CommandsStatusTable'; type Incident = { incident_id: string; family_id: string; device_id: string; child_user_id: string | null; incident_type: string; risk_level: string; summary: string; detected_at: string; status: string; meta_json: any; }; function badgeClass(kind: 'risk' | 'status', value: string) { const v = (value || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium border'; if (kind === 'risk') { if (v === 'CRITICAL') return ${base} bg-red-50 text-red-700 border-red-200 ; if (v === 'HIGH') return ${base} bg-orange-50 text-orange-700 border-orange-200 ; if (v === 'MEDIUM') return ${base} bg-yellow-50 text-yellow-700 border-yellow-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } if (v === 'OPEN') return ${base} bg-blue-50 text-blue-700 border-blue-200 ; if (v === 'MITIGATED') return ${base} bg-green-50 text-green-700 border-green-200 ; if (v === 'CLOSED') return ${base} bg-gray-50 text-gray-700 border-gray-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } export default function IncidentDetailsTabs({ incident, evidence, }: { incident: Incident; evidence: any[]; }) { const [tab, setTab] = useState<'evidence' | 'custody' | 'commands'>('evidence'); const [custody, setCustody] = useState<CustodyEvent[]>([]); const [custodyLoading, setCustodyLoading] = useState(false); const [custodyErr, setCustodyErr] = useState(''); const [commands, setCommands] = useState<DeviceCommandRow[]>([]); const [commandsLoading, setCommandsLoading] = useState(false); const [commandsErr, setCommandsErr] = useState(''); const incidentId = incident.incident_id; async function loadCustody() { setCustodyLoading(true); setCustodyErr(''); try { const res = await fetch( /api/incidents/${encodeURIComponent(incidentId)}/custody , { method: 'GET', cache: 'no-store', }); const json = await res.json(); if (!res.ok || !json.ok) throw new Error(json?.error?.message || 'Failed to load custody'); setCustody(json.items || []); } catch (e: any) { setCustodyErr(e?.message || 'Unexpected error'); setCustody([]); } finally { setCustodyLoading(false); } } async function loadCommands() { setCommandsLoading(true); setCommandsErr(''); try { const res = await fetch( /api/incidents/${encodeURIComponent(incidentId)}/commands , { method: 'GET', cache: 'no-store', }); const json = await res.json(); if (!res.ok || !json.ok) throw new Error(json?.error?.message || 'Failed to load commands'); setCommands(json.items || []); } catch (e: any) { setCommandsErr(e?.message || 'Unexpected error'); setCommands([]); } finally { setCommandsLoading(false); } } useEffect(() => { // lazy-load only when tab opened if (tab === 'custody' && custody.length === 0 && !custodyLoading) loadCustody(); if (tab === 'commands' && commands.length === 0 && !commandsLoading) loadCommands(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [tab]); const headerMeta = useMemo(() => { return { idShort: ${incident.incident_id.slice(0, 12)}... , detected: new Date(incident.detected_at).toLocaleString(), }; }, [incident.detected_at, incident.incident_id]); return ( <div className="p-4"> <div className="rounded-2xl border border-gray-200 bg-white p-4"> <div className="flex flex-col gap-2 md:flex-row md:items-start md:justify-between"> <div className="flex flex-col gap-1"> <div className="flex flex-wrap items-center gap-2"> <div className="text-base font-semibold text-gray-900"> {incident.incident_type} </div> <span className={badgeClass('risk', incident.risk_level)}>{incident.risk_level} </span> <span className={badgeClass('status', incident.status)}>{incident.status} </span> </div> code Code download content_copy expand_less < div className = "text-sm text-gray-700" > {incident.summary} </ div > < div className = "mt-2 grid grid-cols-1 gap-2 text-xs text-gray-600 md:grid-cols-3" > < div > Incident ID: < span className = "font-mono text-gray-800" > {headerMeta.idShort} </ span > </ div > < div > Device: < span className = "font-mono text-gray-800" > {incident.device_id} </ span > </ div > < div > Detected: < span className = "text-gray-800" > {headerMeta.detected} </ span > </ div > </ div > </ div > < div className = "mt-3 flex gap-2 md:mt-0" > < a className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" href = { `/ api / exports / create `} onClick = {(e) => { e.preventDefault(); // This is a UI placeholder. In next step we will add a proper POST action button. alert('Next step: wire a POST /api/exports/create with incident_id and show download hash.'); }} > Create Export (Next) </ a > </ div > </ div > </ div > < div className = "mt-4 border-b border-gray-200" > < div className = "flex flex-wrap gap-2" > < button className = { ` rounded-xl px-3 py-2 text-sm font-medium ${ tab === 'evidence' ? ' bg-gray-900 text-white ' : ' bg-white text-gray-900 border border-gray-200 ' }`} onClick = {() => setTab('evidence')} > Evidence ({evidence?.length || 0}) </ button > < button className = { ` rounded-xl px-3 py-2 text-sm font-medium ${ tab === 'custody' ? ' bg-gray-900 text-white ' : ' bg-white text-gray-900 border border-gray-200 ' }`} onClick = {() => setTab('custody')} > Custody Timeline </ button > < button className = { ` rounded-xl px-3 py-2 text-sm font-medium ${ tab === 'commands' ? ' bg-gray-900 text-white ' : ' bg-white text-gray-900 border border-gray-200 ' }`} onClick = {() => setTab('commands')} > Commands </ button > </ div > </ div > < div className = "mt-4" > {tab === 'evidence' ? ( < EvidenceList evidence = {evidence || []} /> ) : tab === 'custody' ? ( < CustodyTimeline loading = {custodyLoading} error = {custodyErr} items = {custody} /> ) : ( < CommandsStatusTable loading = {commandsLoading} error = {commandsErr} items = {commands} /> )} </ div > </ div > ); } [7] Component: EvidenceList المسار: components/parent/EvidenceList.tsx 'use client'; import React from 'react'; type EvidenceItem = { evidence_id: string; evidence_type: string; storage_key: string; mime_type: string; size_bytes: number; sha256_hex: string; captured_at: string; meta_json?: any; }; function humanSize(bytes: number) { if (!bytes || bytes < 0) return '0 B'; const units = ['B', 'KB', 'MB', 'GB']; let n = bytes; let i = 0; while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; } return ${n.toFixed(i === 0 ? 0 : 1)} ${units[i]} ; } export default function EvidenceList({ evidence }: { evidence: EvidenceItem[] }) { if (!evidence || evidence.length === 0) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> No evidence items registered for this incident. </div> ); } return ( <div className="rounded-2xl border border-gray-200 bg-white"> <div className="border-b border-gray-200 p-4"> <div className="text-sm font-semibold text-gray-900"> Evidence Items </div> <div className="mt-1 text-xs text-gray-600"> Each item is hashed (SHA-256) and logged in the custody timeline. </div> </div> code Code download content_copy expand_less < div className = "divide-y divide-gray-200" > {evidence.map((e) => ( < div key = {e.evidence_id} className = "p-4" > < div className = "flex flex-col gap-2 md:flex-row md:items-start md:justify-between" > < div className = "flex flex-col gap-1" > < div className = "flex flex-wrap items-center gap-2" > < div className = "text-sm font-semibold text-gray-900" > {e.evidence_type} </ div > < span className = "rounded-full border border-gray-200 bg-gray-50 px-2.5 py-1 text-xs font-medium text-gray-700" > {e.mime_type} </ span > < span className = "rounded-full border border-gray-200 bg-white px-2.5 py-1 text-xs font-medium text-gray-700" > {humanSize(e.size_bytes)} </ span > </ div > < div className = "text-xs text-gray-600" > Captured at: < span className = "text-gray-800" > {new Date(e.captured_at).toLocaleString()} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > Storage key: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {e.storage_key} </ div > </ div > < div className = "mt-2 text-xs text-gray-600" > SHA-256: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {e.sha256_hex} </ div > </ div > </ div > < div className = "mt-3 flex gap-2 md:mt-0" > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(e.sha256_hex)} > Copy Hash </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(e.storage_key)} > Copy Key </ button > </ div > </ div > </ div > ))} </ div > </ div > ); } [8] Component: CustodyTimeline (Hash Chain Viewer) المسار: components/parent/CustodyTimeline.tsx 'use client'; import React from 'react'; export type CustodyEvent = { custody_id: string; actor: string; event_key: string; event_at: string; event_json: any; prev_hash_hex: string | null; hash_hex: string; }; function eventBadge(key: string) { const k = (key || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium border'; if (k.includes('INCIDENT')) return ${base} bg-blue-50 text-blue-700 border-blue-200 ; if (k.includes('EVIDENCE')) return ${base} bg-purple-50 text-purple-700 border-purple-200 ; if (k.includes('COMMAND')) return ${base} bg-gray-50 text-gray-700 border-gray-200 ; if (k.includes('EXPORT')) return ${base} bg-green-50 text-green-700 border-green-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } export default function CustodyTimeline({ loading, error, items, }: { loading: boolean; error: string; items: CustodyEvent[]; }) { if (loading) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> Loading custody timeline... </div> ); } if (error) { return ( <div className="rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700"> {error} </div> ); } if (!items || items.length === 0) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> No custody events yet. </div> ); } return ( <div className="rounded-2xl border border-gray-200 bg-white"> <div className="border-b border-gray-200 p-4"> <div className="text-sm font-semibold text-gray-900"> Chain of Custody Timeline </div> <div className="mt-1 text-xs text-gray-600"> Events are append-only, linked by hashes (prev_hash → hash). Any tampering breaks the chain. </div> </div> code Code download content_copy expand_less < div className = "divide-y divide-gray-200" > {items.map((ev) => ( < div key = {ev.custody_id} className = "p-4" > < div className = "flex flex-col gap-2 md:flex-row md:items-start md:justify-between" > < div className = "flex flex-col gap-1" > < div className = "flex flex-wrap items-center gap-2" > < span className = {eventBadge(ev.event_key)} > {ev.event_key} </ span > < span className = "rounded-full border border-gray-200 bg-white px-2.5 py-1 text-xs font-medium text-gray-700" > {new Date(ev.event_at).toLocaleString()} </ span > < span className = "rounded-full border border-gray-200 bg-gray-50 px-2.5 py-1 text-xs font-medium text-gray-700" > {ev.actor} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > Event JSON: < pre className = "mt-1 max-h-56 overflow-auto rounded-xl border border-gray-200 bg-white p-3 text-[11px] text-gray-800" > {JSON.stringify(ev.event_json || {}, null, 2)} </pre> </div> code Code download content_copy expand_less < div className = "mt-2 grid grid-cols-1 gap-2 md:grid-cols-2" > < div className = "text-xs text-gray-600" > Prev Hash: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {ev.prev_hash_hex || 'GENESIS'} </ div > </ div > < div className = "text-xs text-gray-600" > Hash: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {ev.hash_hex} </ div > </ div > </ div > </ div > < div className = "mt-3 flex gap-2 md:mt-0" > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(ev.hash_hex)} > Copy Hash </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(ev.prev_hash_hex || '')} > Copy Prev </ button > </ div > </ div > </ div > ))} </ div > </ div > ); } [9] Component: CommandsStatusTable المسار: components/parent/CommandsStatusTable.tsx 'use client'; import React from 'react'; export type DeviceCommandRow = { command_id: string; device_id: string; command_type: string; issued_at: string; expires_at: string; status: string; acked_at: string | null; ack_json: any; }; function statusChip(s: string) { const v = (s || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium border'; if (v === 'ACKED') return ${base} bg-green-50 text-green-700 border-green-200 ; if (v === 'FAILED') return ${base} bg-red-50 text-red-700 border-red-200 ; if (v === 'EXPIRED') return ${base} bg-gray-50 text-gray-700 border-gray-200 ; if (v === 'PENDING') return ${base} bg-yellow-50 text-yellow-700 border-yellow-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } export default function CommandsStatusTable({ loading, error, items, }: { loading: boolean; error: string; items: DeviceCommandRow[]; }) { if (loading) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> Loading commands... </div> ); } if (error) { return ( <div className="rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700"> {error} </div> ); } if (!items || items.length === 0) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> No commands linked to this incident. </div> ); } return ( <div className="rounded-2xl border border-gray-200 bg-white"> <div className="border-b border-gray-200 p-4"> <div className="text-sm font-semibold text-gray-900"> Defense Commands Status </div> <div className="mt-1 text-xs text-gray-600"> Commands are signed, queued, delivered via FCM, and acknowledged by the child device. </div> </div> code Code download content_copy expand_less < div className = "w-full overflow-x-auto" > < table className = "min-w-full border-separate border-spacing-0" > < thead > < tr className = "bg-gray-50" > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Command </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Type </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Status </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Issued </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Acked </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Ack JSON </ th > </ tr > </ thead > < tbody > {items.map((c) => ( < tr key = {c.command_id} className = "hover:bg-gray-50" > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-900" > < div className = "font-mono text-xs" > {c.command_id.slice(0, 12)}... </ div > < div className = "mt-1 font-mono text-[11px] text-gray-600" > {c.device_id} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {c.command_type} </ td > < td className = "border-b border-gray-200 px-4 py-3" > < span className = {statusChip(c.status)} > {c.status} </ span > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {new Date(c.issued_at).toLocaleString()} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {c.acked_at ? new Date(c.acked_at).toLocaleString() : '-'} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-xs text-gray-700" > < pre className = "max-h-32 overflow-auto rounded-xl border border-gray-200 bg-white p-2 font-mono text-[11px] text-gray-800" > {JSON.stringify(c.ack_json || {}, null, 2)} </pre> </td> </tr> ))} </tbody> </table> </div> </div> ); } [10] نقطة مهمة جدًا قبل الخطوة التالية (Export Button الصحيح) في IncidentDetailsTabs وضعت زر Export كـ “Placeholder” عمدًا، لأن إنشاء Export يحتاج: POST /api/exports/create مع { incident_id } ثم عرض sha256_hex + export_id ثم زر “Copy Bundle Hash” وزر “Download” لاحقًا عندما نضيف ZIP فعلي هذه هي الخطوة التالية المنطقية. [11] Suggested Next Steps [11.1] أكتب لك الآن زر “Create Export” الحقيقي بالكامل (POST + UI modal + copy hash). [11.2] ثم نضيف صفحة جديدة Rules Manager داخل لوحة الوالدين: تفعيل/تعطيل AutoRules تعديل actions_json لكل قاعدة [11.3] ثم نضيف Profiles UI (Study/Sleep/Travel/HighRisk) وربطها بالأجهزة والأطفال مع جدولة زمنية.
[148] [1] ## ممتاز — نكمل الآن بالواجهة الاحترافية للوالدين Parent Console UI (Next.js App Router) سننفّذ واجهة مؤسسية تعرض كل شيء بشكل واضح وسريع: Dashboard: قائمة الحوادث Incidents مع فلاتر + Pagination Incident Details صفحة تفصيلية تبويب الأدلة Evidence تبويب سجل الحيازة Custody Timeline (Hash Chain) تبويب حالة الأوامر Commands Status تصميم UI قابل للتوسع لميزات لاحقة (Profiles / Rules / Exports) جميع الأكواد أدناه كاملة لكل ملف من أول سطر لآخر سطر. [2] هيكل الصفحات (App Router) سنبني هذا المسار (مقترح قياسي): app/(parent)/families/[familyId]/incidents/page.tsx app/(parent)/incidents/[incidentId]/page.tsx ومجلد Components: components/parent/IncidentsTable.tsx components/parent/IncidentDetailsTabs.tsx components/parent/EvidenceList.tsx components/parent/CustodyTimeline.tsx components/parent/CommandsStatusTable.tsx [3] ملف الصفحة 1: قائمة الحوادث Incidents List المسار: app/(parent)/families/[familyId]/incidents/page.tsx 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import IncidentsTable, { IncidentRow } from '@/components/parent/IncidentsTable'; type ApiListResponse = { ok: boolean; items: IncidentRow[]; next_cursor: string | null; }; function buildUrl(base: string, params: Record<string, string | number | undefined | null>) { const u = new URL(base); Object.entries(params).forEach(([k, v]) => { if (v === undefined || v === null || String(v).trim() === '') return; u.searchParams.set(k, String(v)); }); return u.toString(); } export default function FamilyIncidentsPage({ params, }: { params: { familyId: string }; }) { const familyId = params.familyId; const [risk, setRisk] = useState <string> (''); const [status, setStatus] = useState <string> (''); const [deviceId, setDeviceId] = useState <string> (''); const [items, setItems] = useState<IncidentRow[]>([]); const [nextCursor, setNextCursor] = useState<string | null>(null); const [loading, setLoading] = useState <boolean> (true); const [loadingMore, setLoadingMore] = useState <boolean> (false); const [err, setErr] = useState <string> (''); const baseEndpoint = useMemo(() => { return /api/families/${encodeURIComponent(familyId)}/incidents ; }, [familyId]); async function loadFirstPage() { setLoading(true); setErr(''); try { const url = buildUrl(baseEndpoint, { risk: risk || undefined, status: status || undefined, device_id: deviceId || undefined, limit: 30, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiListResponse; if (!res.ok || !json.ok) { throw new Error (json?.[ 'error' ]?.message || 'Failed to load incidents' ); } setItems(json.items || []); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); setItems([]); setNextCursor( null ); } finally { setLoading( false ); } } async function loadMore() { if (!nextCursor) return; setLoadingMore(true); setErr(''); code Code download content_copy expand_less try { const url = buildUrl(baseEndpoint, { risk : risk || undefined , status : status || undefined , device_id : deviceId || undefined , limit : 30 , cursor : nextCursor, }); const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiListResponse; if (!res.ok || !json.ok) { throw new Error (json?.[ 'error' ]?.message || 'Failed to load more incidents' ); } setItems( ( prev ) => [...prev, ...(json.items || [])]); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); } finally { setLoadingMore( false ); } } useEffect(() => { loadFirstPage(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [risk, status, deviceId, baseEndpoint]); return ( <div className="min-h-screen bg-white"> <div className="mx-auto max-w-6xl px-4 py-6"> <div className="flex flex-col gap-2"> <h1 className="text-xl font-semibold text-gray-900"> Incidents </h1> <p className="text-sm text-gray-600"> Review detected safety incidents, evidence, custody timeline, and automated defense actions. </p> </div> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white shadow-sm" > < div className = "p-4" > < div className = "grid grid-cols-1 gap-3 md:grid-cols-4" > < div className = "flex flex-col gap-1" > < label className = "text-xs font-medium text-gray-700" > Risk Level </ label > < select className = "w-full rounded-xl border border-gray-200 px-3 py-2 text-sm text-gray-900 outline-none focus:ring-2 focus:ring-gray-200" value = {risk} onChange = {(e) => setRisk(e.target.value)} > < option value = "" > All </ option > < option value = "LOW" > LOW </ option > < option value = "MEDIUM" > MEDIUM </ option > < option value = "HIGH" > HIGH </ option > < option value = "CRITICAL" > CRITICAL </ option > </ select > </ div > < div className = "flex flex-col gap-1" > < label className = "text-xs font-medium text-gray-700" > Status </ label > < select className = "w-full rounded-xl border border-gray-200 px-3 py-2 text-sm text-gray-900 outline-none focus:ring-2 focus:ring-gray-200" value = {status} onChange = {(e) => setStatus(e.target.value)} > < option value = "" > All </ option > < option value = "OPEN" > OPEN </ option > < option value = "MITIGATED" > MITIGATED </ option > < option value = "CLOSED" > CLOSED </ option > </ select > </ div > < div className = "flex flex-col gap-1 md:col-span-2" > < label className = "text-xs font-medium text-gray-700" > Device ID (optional) </ label > < input className = "w-full rounded-xl border border-gray-200 px-3 py-2 text-sm text-gray-900 outline-none focus:ring-2 focus:ring-gray-200" value = {deviceId} onChange = {(e) => setDeviceId(e.target.value)} placeholder="Filter by a specific device_id" /> </ div > </ div > {err ? ( < div className = "mt-4 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > ) : null} </ div > < div className = "border-t border-gray-200" > < IncidentsTable loading = {loading} items = {items} familyId = {familyId} /> </ div > < div className = "flex items-center justify-between px-4 py-4" > < div className = "text-xs text-gray-500" > {items.length === 0 && !loading ? 'No incidents found.' : `Loaded: ${items.length}`} </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50" onClick = {loadMore} disabled = {!nextCursor || loadingMore } > {loadingMore ? 'Loading...' : nextCursor ? 'Load more' : 'No more'} </ button > </ div > </ div > </ div > </ div > ); } [4] Component: جدول الحوادث IncidentsTable المسار: components/parent/IncidentsTable.tsx 'use client'; import React from 'react'; import Link from 'next/link'; export type IncidentRow = { incident_id: string; device_id: string; child_user_id: string | null; incident_type: string; risk_level: string; summary: string; detected_at: string; status: string; }; function riskBadge(risk: string) { const r = (risk || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium'; if (r === 'CRITICAL') return ${base} bg-red-50 text-red-700 border border-red-200 ; if (r === 'HIGH') return ${base} bg-orange-50 text-orange-700 border border-orange-200 ; if (r === 'MEDIUM') return ${base} bg-yellow-50 text-yellow-700 border border-yellow-200 ; return ${base} bg-gray-50 text-gray-700 border border-gray-200 ; } function statusBadge(status: string) { const s = (status || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium'; if (s === 'OPEN') return ${base} bg-blue-50 text-blue-700 border border-blue-200 ; if (s === 'MITIGATED') return ${base} bg-green-50 text-green-700 border border-green-200 ; if (s === 'CLOSED') return ${base} bg-gray-50 text-gray-700 border border-gray-200 ; return ${base} bg-gray-50 text-gray-700 border border-gray-200 ; } export default function IncidentsTable({ loading, items, familyId, }: { loading: boolean; items: IncidentRow[]; familyId: string; }) { return ( <div className="w-full overflow-x-auto"> <table className="min-w-full border-separate border-spacing-0"> <thead> <tr className="bg-gray-50"> <th className="sticky left-0 z-10 border-b border-gray-200 bg-gray-50 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Incident </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Risk </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Status </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Device </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Detected At </th> <th className="border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700"> Summary </th> </tr> </thead> code Code download content_copy expand_less < tbody > {loading ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > Loading incidents... </ td > </ tr > ) : items.length === 0 ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > No incidents available. </ td > </ tr > ) : ( items.map((it) => ( < tr key = {it.incident_id} className = "hover:bg-gray-50" > < td className = "sticky left-0 z-10 border-b border-gray-200 bg-white px-4 py-3 text-sm text-gray-900" > < Link href = { `/ incidents /${ encodeURIComponent ( it.incident_id )}`} className = "font-semibold text-gray-900 underline-offset-2 hover:underline" > {it.incident_type} </ Link > < div className = "mt-1 text-xs text-gray-500" > ID: < span className = "font-mono" > {it.incident_id.slice(0, 12)}... </ span > </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3" > < span className = {riskBadge(it.risk_level)} > {it.risk_level} </ span > </ td > < td className = "border-b border-gray-200 px-4 py-3" > < span className = {statusBadge(it.status)} > {it.status} </ span > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > < div className = "font-mono text-xs" > {it.device_id} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {new Date(it.detected_at).toLocaleString()} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > < div className = "max-w-[520px] truncate" > {it.summary} </ div > </ td > </ tr > )) )} </ tbody > </ table > < div className = "px-4 py-3 text-xs text-gray-500" > Family: < span className = "font-mono" > {familyId} </ span > </ div > </ div > ); } [5] ملف الصفحة 2: Incident Details مع Tabs (Evidence / Custody / Commands) المسار: app/(parent)/incidents/[incidentId]/page.tsx 'use client'; import React, { useEffect, useState } from 'react'; import IncidentDetailsTabs from '@/components/parent/IncidentDetailsTabs'; type IncidentDetailsResponse = { ok: boolean; incident: { incident_id: string; family_id: string; device_id: string; child_user_id: string | null; incident_type: string; risk_level: string; summary: string; detected_at: string; status: string; meta_json: any; }; evidence: any[]; }; export default function IncidentDetailsPage({ params, }: { params: { incidentId: string }; }) { const incidentId = params.incidentId; const [loading, setLoading] = useState(true); const [err, setErr] = useState(''); const [data, setData] = useState<IncidentDetailsResponse | null>(null); async function load() { setLoading(true); setErr(''); code Code download content_copy expand_less try { const res = await fetch( `/api/incidents/ ${ encodeURIComponent (incidentId)} ` , { method : 'GET' , cache : 'no-store' , }); const json = ( await res.json()) as IncidentDetailsResponse; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load incident details' ); } setData(json); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); setData( null ); } finally { setLoading( false ); } } useEffect(() => { load(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [incidentId]); return ( <div className="min-h-screen bg-white"> <div className="mx-auto max-w-6xl px-4 py-6"> <div className="flex items-start justify-between gap-4"> <div className="flex flex-col gap-2"> <h1 className="text-xl font-semibold text-gray-900"> Incident Details </h1> <p className="text-sm text-gray-600"> Evidence, custody timeline, and automated defense actions for this incident. </p> </div> code Code download content_copy expand_less < button onClick = {load} className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" > Refresh </ button > </ div > < div className = "mt-5 rounded-2xl border border-gray-200 bg-white shadow-sm" > {loading ? ( < div className = "p-4 text-sm text-gray-700" > Loading... </ div > ) : err ? ( < div className = "p-4" > < div className = "rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > </ div > ) : data ? ( < IncidentDetailsTabs incident = {data.incident} evidence = {data.evidence} /> ) : ( < div className = "p-4 text-sm text-gray-700" > No data. </ div > )} </ div > </ div > </ div > ); } [6] Component: IncidentDetailsTabs المسار: components/parent/IncidentDetailsTabs.tsx 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import EvidenceList from '@/components/parent/EvidenceList'; import CustodyTimeline, { CustodyEvent } from '@/components/parent/CustodyTimeline'; import CommandsStatusTable, { DeviceCommandRow } from '@/components/parent/CommandsStatusTable'; type Incident = { incident_id: string; family_id: string; device_id: string; child_user_id: string | null; incident_type: string; risk_level: string; summary: string; detected_at: string; status: string; meta_json: any; }; function badgeClass(kind: 'risk' | 'status', value: string) { const v = (value || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium border'; if (kind === 'risk') { if (v === 'CRITICAL') return ${base} bg-red-50 text-red-700 border-red-200 ; if (v === 'HIGH') return ${base} bg-orange-50 text-orange-700 border-orange-200 ; if (v === 'MEDIUM') return ${base} bg-yellow-50 text-yellow-700 border-yellow-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } if (v === 'OPEN') return ${base} bg-blue-50 text-blue-700 border-blue-200 ; if (v === 'MITIGATED') return ${base} bg-green-50 text-green-700 border-green-200 ; if (v === 'CLOSED') return ${base} bg-gray-50 text-gray-700 border-gray-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } export default function IncidentDetailsTabs({ incident, evidence, }: { incident: Incident; evidence: any[]; }) { const [tab, setTab] = useState<'evidence' | 'custody' | 'commands'>('evidence'); const [custody, setCustody] = useState<CustodyEvent[]>([]); const [custodyLoading, setCustodyLoading] = useState(false); const [custodyErr, setCustodyErr] = useState(''); const [commands, setCommands] = useState<DeviceCommandRow[]>([]); const [commandsLoading, setCommandsLoading] = useState(false); const [commandsErr, setCommandsErr] = useState(''); const incidentId = incident.incident_id; async function loadCustody() { setCustodyLoading(true); setCustodyErr(''); try { const res = await fetch( /api/incidents/${encodeURIComponent(incidentId)}/custody , { method: 'GET', cache: 'no-store', }); const json = await res.json(); if (!res.ok || !json.ok) throw new Error(json?.error?.message || 'Failed to load custody'); setCustody(json.items || []); } catch (e: any) { setCustodyErr(e?.message || 'Unexpected error'); setCustody([]); } finally { setCustodyLoading(false); } } async function loadCommands() { setCommandsLoading(true); setCommandsErr(''); try { const res = await fetch( /api/incidents/${encodeURIComponent(incidentId)}/commands , { method: 'GET', cache: 'no-store', }); const json = await res.json(); if (!res.ok || !json.ok) throw new Error(json?.error?.message || 'Failed to load commands'); setCommands(json.items || []); } catch (e: any) { setCommandsErr(e?.message || 'Unexpected error'); setCommands([]); } finally { setCommandsLoading(false); } } useEffect(() => { // lazy-load only when tab opened if (tab === 'custody' && custody.length === 0 && !custodyLoading) loadCustody(); if (tab === 'commands' && commands.length === 0 && !commandsLoading) loadCommands(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [tab]); const headerMeta = useMemo(() => { return { idShort: ${incident.incident_id.slice(0, 12)}... , detected: new Date(incident.detected_at).toLocaleString(), }; }, [incident.detected_at, incident.incident_id]); return ( <div className="p-4"> <div className="rounded-2xl border border-gray-200 bg-white p-4"> <div className="flex flex-col gap-2 md:flex-row md:items-start md:justify-between"> <div className="flex flex-col gap-1"> <div className="flex flex-wrap items-center gap-2"> <div className="text-base font-semibold text-gray-900"> {incident.incident_type} </div> <span className={badgeClass('risk', incident.risk_level)}>{incident.risk_level} </span> <span className={badgeClass('status', incident.status)}>{incident.status} </span> </div> code Code download content_copy expand_less < div className = "text-sm text-gray-700" > {incident.summary} </ div > < div className = "mt-2 grid grid-cols-1 gap-2 text-xs text-gray-600 md:grid-cols-3" > < div > Incident ID: < span className = "font-mono text-gray-800" > {headerMeta.idShort} </ span > </ div > < div > Device: < span className = "font-mono text-gray-800" > {incident.device_id} </ span > </ div > < div > Detected: < span className = "text-gray-800" > {headerMeta.detected} </ span > </ div > </ div > </ div > < div className = "mt-3 flex gap-2 md:mt-0" > < a className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" href = { `/ api / exports / create `} onClick = {(e) => { e.preventDefault(); // This is a UI placeholder. In next step we will add a proper POST action button. alert('Next step: wire a POST /api/exports/create with incident_id and show download hash.'); }} > Create Export (Next) </ a > </ div > </ div > </ div > < div className = "mt-4 border-b border-gray-200" > < div className = "flex flex-wrap gap-2" > < button className = { ` rounded-xl px-3 py-2 text-sm font-medium ${ tab === 'evidence' ? ' bg-gray-900 text-white ' : ' bg-white text-gray-900 border border-gray-200 ' }`} onClick = {() => setTab('evidence')} > Evidence ({evidence?.length || 0}) </ button > < button className = { ` rounded-xl px-3 py-2 text-sm font-medium ${ tab === 'custody' ? ' bg-gray-900 text-white ' : ' bg-white text-gray-900 border border-gray-200 ' }`} onClick = {() => setTab('custody')} > Custody Timeline </ button > < button className = { ` rounded-xl px-3 py-2 text-sm font-medium ${ tab === 'commands' ? ' bg-gray-900 text-white ' : ' bg-white text-gray-900 border border-gray-200 ' }`} onClick = {() => setTab('commands')} > Commands </ button > </ div > </ div > < div className = "mt-4" > {tab === 'evidence' ? ( < EvidenceList evidence = {evidence || []} /> ) : tab === 'custody' ? ( < CustodyTimeline loading = {custodyLoading} error = {custodyErr} items = {custody} /> ) : ( < CommandsStatusTable loading = {commandsLoading} error = {commandsErr} items = {commands} /> )} </ div > </ div > ); } [7] Component: EvidenceList المسار: components/parent/EvidenceList.tsx 'use client'; import React from 'react'; type EvidenceItem = { evidence_id: string; evidence_type: string; storage_key: string; mime_type: string; size_bytes: number; sha256_hex: string; captured_at: string; meta_json?: any; }; function humanSize(bytes: number) { if (!bytes || bytes < 0) return '0 B'; const units = ['B', 'KB', 'MB', 'GB']; let n = bytes; let i = 0; while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; } return ${n.toFixed(i === 0 ? 0 : 1)} ${units[i]} ; } export default function EvidenceList({ evidence }: { evidence: EvidenceItem[] }) { if (!evidence || evidence.length === 0) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> No evidence items registered for this incident. </div> ); } return ( <div className="rounded-2xl border border-gray-200 bg-white"> <div className="border-b border-gray-200 p-4"> <div className="text-sm font-semibold text-gray-900"> Evidence Items </div> <div className="mt-1 text-xs text-gray-600"> Each item is hashed (SHA-256) and logged in the custody timeline. </div> </div> code Code download content_copy expand_less < div className = "divide-y divide-gray-200" > {evidence.map((e) => ( < div key = {e.evidence_id} className = "p-4" > < div className = "flex flex-col gap-2 md:flex-row md:items-start md:justify-between" > < div className = "flex flex-col gap-1" > < div className = "flex flex-wrap items-center gap-2" > < div className = "text-sm font-semibold text-gray-900" > {e.evidence_type} </ div > < span className = "rounded-full border border-gray-200 bg-gray-50 px-2.5 py-1 text-xs font-medium text-gray-700" > {e.mime_type} </ span > < span className = "rounded-full border border-gray-200 bg-white px-2.5 py-1 text-xs font-medium text-gray-700" > {humanSize(e.size_bytes)} </ span > </ div > < div className = "text-xs text-gray-600" > Captured at: < span className = "text-gray-800" > {new Date(e.captured_at).toLocaleString()} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > Storage key: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {e.storage_key} </ div > </ div > < div className = "mt-2 text-xs text-gray-600" > SHA-256: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {e.sha256_hex} </ div > </ div > </ div > < div className = "mt-3 flex gap-2 md:mt-0" > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(e.sha256_hex)} > Copy Hash </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(e.storage_key)} > Copy Key </ button > </ div > </ div > </ div > ))} </ div > </ div > ); } [8] Component: CustodyTimeline (Hash Chain Viewer) المسار: components/parent/CustodyTimeline.tsx 'use client'; import React from 'react'; export type CustodyEvent = { custody_id: string; actor: string; event_key: string; event_at: string; event_json: any; prev_hash_hex: string | null; hash_hex: string; }; function eventBadge(key: string) { const k = (key || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium border'; if (k.includes('INCIDENT')) return ${base} bg-blue-50 text-blue-700 border-blue-200 ; if (k.includes('EVIDENCE')) return ${base} bg-purple-50 text-purple-700 border-purple-200 ; if (k.includes('COMMAND')) return ${base} bg-gray-50 text-gray-700 border-gray-200 ; if (k.includes('EXPORT')) return ${base} bg-green-50 text-green-700 border-green-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } export default function CustodyTimeline({ loading, error, items, }: { loading: boolean; error: string; items: CustodyEvent[]; }) { if (loading) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> Loading custody timeline... </div> ); } if (error) { return ( <div className="rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700"> {error} </div> ); } if (!items || items.length === 0) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> No custody events yet. </div> ); } return ( <div className="rounded-2xl border border-gray-200 bg-white"> <div className="border-b border-gray-200 p-4"> <div className="text-sm font-semibold text-gray-900"> Chain of Custody Timeline </div> <div className="mt-1 text-xs text-gray-600"> Events are append-only, linked by hashes (prev_hash → hash). Any tampering breaks the chain. </div> </div> code Code download content_copy expand_less < div className = "divide-y divide-gray-200" > {items.map((ev) => ( < div key = {ev.custody_id} className = "p-4" > < div className = "flex flex-col gap-2 md:flex-row md:items-start md:justify-between" > < div className = "flex flex-col gap-1" > < div className = "flex flex-wrap items-center gap-2" > < span className = {eventBadge(ev.event_key)} > {ev.event_key} </ span > < span className = "rounded-full border border-gray-200 bg-white px-2.5 py-1 text-xs font-medium text-gray-700" > {new Date(ev.event_at).toLocaleString()} </ span > < span className = "rounded-full border border-gray-200 bg-gray-50 px-2.5 py-1 text-xs font-medium text-gray-700" > {ev.actor} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > Event JSON: < pre className = "mt-1 max-h-56 overflow-auto rounded-xl border border-gray-200 bg-white p-3 text-[11px] text-gray-800" > {JSON.stringify(ev.event_json || {}, null, 2)} </pre> </div> code Code download content_copy expand_less < div className = "mt-2 grid grid-cols-1 gap-2 md:grid-cols-2" > < div className = "text-xs text-gray-600" > Prev Hash: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {ev.prev_hash_hex || 'GENESIS'} </ div > </ div > < div className = "text-xs text-gray-600" > Hash: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {ev.hash_hex} </ div > </ div > </ div > </ div > < div className = "mt-3 flex gap-2 md:mt-0" > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(ev.hash_hex)} > Copy Hash </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(ev.prev_hash_hex || '')} > Copy Prev </ button > </ div > </ div > </ div > ))} </ div > </ div > ); } [9] Component: CommandsStatusTable المسار: components/parent/CommandsStatusTable.tsx 'use client'; import React from 'react'; export type DeviceCommandRow = { command_id: string; device_id: string; command_type: string; issued_at: string; expires_at: string; status: string; acked_at: string | null; ack_json: any; }; function statusChip(s: string) { const v = (s || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium border'; if (v === 'ACKED') return ${base} bg-green-50 text-green-700 border-green-200 ; if (v === 'FAILED') return ${base} bg-red-50 text-red-700 border-red-200 ; if (v === 'EXPIRED') return ${base} bg-gray-50 text-gray-700 border-gray-200 ; if (v === 'PENDING') return ${base} bg-yellow-50 text-yellow-700 border-yellow-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } export default function CommandsStatusTable({ loading, error, items, }: { loading: boolean; error: string; items: DeviceCommandRow[]; }) { if (loading) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> Loading commands... </div> ); } if (error) { return ( <div className="rounded-2xl border border-red-200 bg-red-50 p-4 text-sm text-red-700"> {error} </div> ); } if (!items || items.length === 0) { return ( <div className="rounded-2xl border border-gray-200 bg-white p-4 text-sm text-gray-700"> No commands linked to this incident. </div> ); } return ( <div className="rounded-2xl border border-gray-200 bg-white"> <div className="border-b border-gray-200 p-4"> <div className="text-sm font-semibold text-gray-900"> Defense Commands Status </div> <div className="mt-1 text-xs text-gray-600"> Commands are signed, queued, delivered via FCM, and acknowledged by the child device. </div> </div> code Code download content_copy expand_less < div className = "w-full overflow-x-auto" > < table className = "min-w-full border-separate border-spacing-0" > < thead > < tr className = "bg-gray-50" > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Command </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Type </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Status </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Issued </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Acked </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Ack JSON </ th > </ tr > </ thead > < tbody > {items.map((c) => ( < tr key = {c.command_id} className = "hover:bg-gray-50" > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-900" > < div className = "font-mono text-xs" > {c.command_id.slice(0, 12)}... </ div > < div className = "mt-1 font-mono text-[11px] text-gray-600" > {c.device_id} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {c.command_type} </ td > < td className = "border-b border-gray-200 px-4 py-3" > < span className = {statusChip(c.status)} > {c.status} </ span > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {new Date(c.issued_at).toLocaleString()} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {c.acked_at ? new Date(c.acked_at).toLocaleString() : '-'} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-xs text-gray-700" > < pre className = "max-h-32 overflow-auto rounded-xl border border-gray-200 bg-white p-2 font-mono text-[11px] text-gray-800" > {JSON.stringify(c.ack_json || {}, null, 2)} </pre> </td> </tr> ))} </tbody> </table> </div> </div> ); } [10] نقطة مهمة جدًا قبل الخطوة التالية (Export Button الصحيح) في IncidentDetailsTabs وضعت زر Export كـ “Placeholder” عمدًا، لأن إنشاء Export يحتاج: POST /api/exports/create مع { incident_id } ثم عرض sha256_hex + export_id ثم زر “Copy Bundle Hash” وزر “Download” لاحقًا عندما نضيف ZIP فعلي هذه هي الخطوة التالية المنطقية. [11] Suggested Next Steps [11.1] أكتب لك الآن زر “Create Export” الحقيقي بالكامل (POST + UI modal + copy hash). [11.2] ثم نضيف صفحة جديدة Rules Manager داخل لوحة الوالدين: تفعيل/تعطيل AutoRules تعديل actions_json لكل قاعدة [11.3] ثم نضيف Profiles UI (Study/Sleep/Travel/HighRisk) وربطها بالأجهزة والأطفال مع جدولة زمنية.
[149] [1] ## تمام — الآن نكمل بالجزء “المؤسسي الحاسم”: إنشاء Export Bundle رسمي للأدلة (Manifest + Custody + Download) سننفّذ 3 أشياء كاملة: API: Evidence Register (الذي يستخدمه Android بعد رفع الملف Signed URL) API: Create Export Bundle (POST) → يولّد Manifest رسمي مرتبط بـ Incident UI: زر Create Export الحقيقي داخل صفحة الحادثة (Modal + Copy Hash + Download Manifest) ملاحظة هندسية دقيقة: بدل وعد “ZIP جاهز الآن” (قد يحتاج Worker أو Queue)، سنبدأ بـ Manifest JSON رسمي يمكن تنزيله فورًا (قانونيًا وعمليًا)، وبعدها نضيف ZIP لاحقًا كخطوة متقدمة. [2] API: تسجيل الدليل Evidence Register (بعد الرفع إلى التخزين) المسار: app/api/evidence/register/route.ts هذا الـ endpoint يقوم بـ: إنشاء EvidenceItem إضافة CustodyEvent (EVIDENCE_REGISTERED) ربطه تلقائيًا بـ Incident // app/api/evidence/register/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import crypto from 'crypto'; export const dynamic = 'force-dynamic'; class HttpError extends Error { status: number; constructor(status: number, message: string) { super(message); this.status = status; } } function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } async function requireDeviceAuth(req: NextRequest) { const device_id = req.headers.get('x-device-id') || ''; const token = req.headers.get('x-device-token') || ''; if (!device_id || !token) throw new HttpError(401, 'Missing device auth'); const device = await prisma.device.findUnique({ where: { device_id }, select: { device_id: true, family_id: true, device_token: true }, }); if (!device) throw new HttpError(404, 'Device not found'); if (device.device_token !== token) throw new HttpError(401, 'Invalid device token'); return device; } function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } /** POST body: { "incident_id": "optional", "evidence_type": "SCREENSHOT|AUDIO|VIDEO|TEXT_SNAPSHOT|CAMERA_STREAM_FRAME|...", "storage_key": "family/.../file.png", "mime_type": "image/png", "size_bytes": 12345, "sha256_hex": "hex" } */ export async function POST(req: NextRequest) { try { const device = await requireDeviceAuth(req); const body = await req.json().catch(() => ({})); const incident_id = body?.incident_id ? String(body.incident_id) : null; const evidence_type = String(body?.evidence_type || '').trim(); const storage_key = String(body?.storage_key || '').trim(); const mime_type = String(body?.mime_type || '').trim(); const size_bytes = Number(body?.size_bytes ?? 0); const sha256_hex = String(body?.sha256_hex || '').trim(); if (!evidence_type || !storage_key || !mime_type || !size_bytes || !sha256_hex) { throw new HttpError(400, 'Missing required fields'); } // Hard policy limits const MAX = 25 * 1024 * 1024; if (size_bytes <= 0 || size_bytes > MAX) throw new HttpError(400, 'Invalid size_bytes'); // Optional incident validation (if provided) if (incident_id) { const inc = await prisma.incident.findUnique({ where: { incident_id }, select: { family_id: true, incident_id: true }, }); if (!inc) throw new HttpError(404, 'Incident not found'); if (inc.family_id !== device.family_id) throw new HttpError(403, 'Family mismatch'); } // Create Evidence Item const ev = await prisma.evidenceItem.create({ data: { family_id: device.family_id, incident_id: incident_id, evidence_type, storage_key, mime_type, size_bytes, sha256_hex, captured_at: new Date(), meta_json: { device_id: device.device_id, registered_by: 'DEVICE', }, }, select: { evidence_id: true, family_id: true, incident_id: true, storage_key: true, sha256_hex: true, captured_at: true, }, }); // Append custody event (hash-chained) const last = await prisma.custodyEvent.findFirst({ where: { family_id: device.family_id, incident_id: incident_id || undefined }, orderBy: { event_at: 'desc' }, select: { hash_hex: true }, }); const prev_hash_hex = last?.hash_hex ?? null; const event_json = { evidence_id: ev.evidence_id, storage_key: ev.storage_key, sha256_hex: ev.sha256_hex, device_id: device.device_id, }; const hash_payload = JSON.stringify({ family_id: device.family_id, incident_id: incident_id, actor: 'DEVICE', event_key: 'EVIDENCE_REGISTERED', event_at: ev.captured_at.toISOString(), prev_hash_hex, event_json, }); const hash_hex = sha256Hex(hash_payload); await prisma.custodyEvent.create({ data: { family_id: device.family_id, incident_id: incident_id, actor: 'DEVICE', event_key: 'EVIDENCE_REGISTERED', event_at: ev.captured_at, event_json, prev_hash_hex, hash_hex, }, select: { custody_id: true }, }); return NextResponse.json({ ok: true, evidence_id: ev.evidence_id }, { status: 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [3] API: Create Export Bundle (Manifest رسمي + Custody) [3.1] Endpoint إنشاء Export المسار: app/api/exports/create/route.ts هذا يقوم بـ: التحقق من Incident + صلاحيات الأسرة بناء Manifest JSON يحتوي: incident metadata evidence list (hash + storage_key) custody hashes snapshot commands snapshot تخزينه في جدول ExportBundle إضافة CustodyEvent باسم EXPORT_CREATED // app/api/exports/create/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import crypto from 'crypto'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } /** POST body: { "incident_id": "..." } returns: { ok: true, export_id, manifest_sha256_hex } */ export async function POST(req: NextRequest) { try { const principal = getPrincipal(req); const body = await req.json().catch(() => ({})); const incident_id = String(body?.incident_id || '').trim(); if (!incident_id) throw new HttpError(400, 'Missing incident_id'); const inc = await prisma.incident.findUnique({ where: { incident_id }, select: { incident_id: true, family_id: true, device_id: true, child_user_id: true, incident_type: true, risk_level: true, summary: true, detected_at: true, status: true, meta_json: true, }, }); if (!inc) throw new HttpError(404, 'Incident not found'); if (!requireFamilyAccess(principal, inc.family_id)) throw new HttpError(403, 'Forbidden'); // Collect evidence const evidence = await prisma.evidenceItem.findMany({ where: { family_id: inc.family_id, incident_id: inc.incident_id }, orderBy: { captured_at: 'asc' }, select: { evidence_id: true, evidence_type: true, storage_key: true, mime_type: true, size_bytes: true, sha256_hex: true, captured_at: true, meta_json: true, }, }); // Custody snapshot const custody = await prisma.custodyEvent.findMany({ where: { family_id: inc.family_id, incident_id: inc.incident_id }, orderBy: { event_at: 'asc' }, select: { custody_id: true, actor: true, event_key: true, event_at: true, prev_hash_hex: true, hash_hex: true, }, }); // Commands snapshot const commands = await prisma.deviceCommand.findMany({ where: { family_id: inc.family_id, incident_id: inc.incident_id }, orderBy: { issued_at: 'asc' }, select: { command_id: true, device_id: true, command_type: true, issued_at: true, expires_at: true, status: true, acked_at: true, ack_json: true, }, }); const created_at = new Date(); const manifest = { schema: 'amana.export.manifest.v1', export_created_at: created_at.toISOString(), family_id: inc.family_id, incident: { incident_id: inc.incident_id, device_id: inc.device_id, child_user_id: inc.child_user_id, incident_type: inc.incident_type, risk_level: inc.risk_level, status: inc.status, summary: inc.summary, detected_at: inc.detected_at.toISOString(), meta_json: inc.meta_json || {}, }, evidence: evidence.map((e) => ({ evidence_id: e.evidence_id, evidence_type: e.evidence_type, storage_key: e.storage_key, mime_type: e.mime_type, size_bytes: e.size_bytes, sha256_hex: e.sha256_hex, captured_at: e.captured_at.toISOString(), })), custody_chain: custody.map((c) => ({ custody_id: c.custody_id, actor: c.actor, event_key: c.event_key, event_at: c.event_at.toISOString(), prev_hash_hex: c.prev_hash_hex, hash_hex: c.hash_hex, })), commands: commands.map((c) => ({ command_id: c.command_id, command_type: c.command_type, device_id: c.device_id, issued_at: c.issued_at.toISOString(), expires_at: c.expires_at.toISOString(), status: c.status, acked_at: c.acked_at ? c.acked_at.toISOString() : null, ack_json: c.ack_json || {}, })), }; const manifest_json = manifest; const manifest_sha256_hex = sha256Hex(JSON.stringify(manifest_json)); // Create ExportBundle record const exp = await prisma.exportBundle.create({ data: { family_id: inc.family_id, incident_id: inc.incident_id, created_by_user_id: principal.user_id || null, created_at, manifest_sha256_hex, manifest_json, }, select: { export_id: true }, }); // Append custody event: EXPORT_CREATED const last = await prisma.custodyEvent.findFirst({ where: { family_id: inc.family_id, incident_id: inc.incident_id }, orderBy: { event_at: 'desc' }, select: { hash_hex: true }, }); const prev_hash_hex = last?.hash_hex ?? null; const event_json = { export_id: exp.export_id, manifest_sha256_hex, evidence_count: evidence.length, commands_count: commands.length, }; const hash_payload = JSON.stringify({ family_id: inc.family_id, incident_id: inc.incident_id, actor: 'PARENT_CONSOLE', event_key: 'EXPORT_CREATED', event_at: created_at.toISOString(), prev_hash_hex, event_json, }); const hash_hex = sha256Hex(hash_payload); await prisma.custodyEvent.create({ data: { family_id: inc.family_id, incident_id: inc.incident_id, actor: 'PARENT_CONSOLE', event_key: 'EXPORT_CREATED', event_at: created_at, event_json, prev_hash_hex, hash_hex, }, select: { custody_id: true }, }); return NextResponse.json( { ok: true, export_id: exp.export_id, manifest_sha256_hex }, { status: 200 } ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [3.2] Endpoint تنزيل Manifest مباشرة المسار: app/api/exports/[id]/manifest/route.ts هذا يتيح للوالد تنزيل Manifest كـ JSON رسمي. // app/api/exports/[id]/manifest/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const export_id = ctx.params.id; code Code download content_copy expand_less const exp = await prisma.exportBundle.findUnique({ where : { export_id }, select : { export_id : true , family_id : true , incident_id : true , created_at : true , manifest_sha256_hex : true , manifest_json : true , }, }); if (!exp) throw new HttpError( 404 , 'Export not found' ); if (!requireFamilyAccess(principal, exp.family_id)) throw new HttpError( 403 , 'Forbidden' ); const body = JSON .stringify(exp.manifest_json || {}, null , 2 ); return new NextResponse(body, { status : 200 , headers : { 'Content-Type' : 'application/json; charset=utf-8' , 'Content-Disposition' : `attachment; filename="amana_export_ ${exp.export_id} .json"` , 'X-Manifest-SHA256' : exp.manifest_sha256_hex, }, }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [4] Prisma Model: ExportBundle (إذا لم يكن موجودًا عندك) إذا كان جدول exportBundle غير موجود عندك، أضف هذا داخل schema.prisma. model ExportBundle { export_id String @id @default(cuid()) family_id String incident_id String created_by_user_id String? created_at DateTime @default(now()) manifest_sha256_hex String manifest_json Json @@index([family_id]) @@index([incident_id]) } [5] UI: زر Create Export الحقيقي (Modal + Copy + Download) [5.1] Component: CreateExportButton المسار: components/parent/CreateExportButton.tsx 'use client'; import React, { useMemo, useState } from 'react'; type CreateExportResponse = | { ok: true; export_id: string; manifest_sha256_hex: string } | { error: { status: number; message: string } }; export default function CreateExportButton({ incidentId, }: { incidentId: string; }) { const [open, setOpen] = useState(false); const [busy, setBusy] = useState(false); const [err, setErr] = useState(''); const [exportId, setExportId] = useState <string> (''); const [manifestHash, setManifestHash] = useState <string> (''); const downloadUrl = useMemo(() => { if (!exportId) return ''; return /api/exports/${encodeURIComponent(exportId)}/manifest ; }, [exportId]); async function create() { setBusy(true); setErr(''); setExportId(''); setManifestHash(''); code Code download content_copy expand_less try { const res = await fetch( '/api/exports/create' , { method : 'POST' , cache : 'no-store' , headers : { 'Content-Type' : 'application/json; charset=utf-8' }, body : JSON .stringify({ incident_id : incidentId }), }); const json = ( await res.json()) as CreateExportResponse; if (!res.ok || !(json as any ).ok) { throw new Error ((json as any )?.error?.message || 'Failed to create export' ); } const okJson = json as any ; setExportId(okJson.export_id); setManifestHash(okJson.manifest_sha256_hex); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); } finally { setBusy( false ); } } function close() { setOpen(false); } return ( <> <button className="rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50" onClick={() => setOpen(true)} > Create Export </button> code Code download content_copy expand_less {open ? ( < div className = "fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4" > < div className = "w-full max-w-xl rounded-2xl border border-gray-200 bg-white shadow-xl" > < div className = "flex items-start justify-between gap-4 border-b border-gray-200 p-4" > < div > < div className = "text-base font-semibold text-gray-900" > Create Evidence Export </ div > < div className = "mt-1 text-xs text-gray-600" > Generates a signed manifest snapshot for incident evidence and custody chain. </ div > </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {close} > Close </ button > </ div > < div className = "p-4" > {err ? ( < div className = "mb-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > ) : null} < div className = "rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-xs text-gray-600" > Incident ID < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {incidentId} </ div > </ div > < div className = "mt-3 flex flex-wrap gap-2" > < button className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black disabled:cursor-not-allowed disabled:opacity-60" onClick = {create} disabled = {busy} > {busy ? 'Creating...' : 'Generate Manifest'} </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(incidentId)} > Copy Incident ID </ button > </ div > </ div > {exportId ? ( < div className = "mt-4 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Export Created </ div > < div className = "mt-2 text-xs text-gray-600" > Export ID < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {exportId} </ div > </ div > < div className = "mt-3 text-xs text-gray-600" > Manifest SHA-256 < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {manifestHash} </ div > </ div > < div className = "mt-3 flex flex-wrap gap-2" > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(manifestHash)} > Copy Hash </ button > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {downloadUrl} > Download Manifest JSON </ a > </ div > < div className = "mt-3 text-xs text-gray-500" > This manifest is a forensic snapshot (evidence list + custody chain + commands). </ div > </ div > ) : null} </ div > </ div > </ div > ) : null} </> ); } [5.2] تعديل IncidentDetailsTabs لاستعمال CreateExportButton المسار: components/parent/IncidentDetailsTabs.tsx هذا الملف أرسلته سابقًا كاملًا، والآن نعيده كاملًا مع تعديل زر Export. 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import EvidenceList from '@/components/parent/EvidenceList'; import CustodyTimeline, { CustodyEvent } from '@/components/parent/CustodyTimeline'; import CommandsStatusTable, { DeviceCommandRow } from '@/components/parent/CommandsStatusTable'; import CreateExportButton from '@/components/parent/CreateExportButton'; type Incident = { incident_id: string; family_id: string; device_id: string; child_user_id: string | null; incident_type: string; risk_level: string; summary: string; detected_at: string; status: string; meta_json: any; }; function badgeClass(kind: 'risk' | 'status', value: string) { const v = (value || '').toUpperCase(); const base = 'inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium border'; if (kind === 'risk') { if (v === 'CRITICAL') return ${base} bg-red-50 text-red-700 border-red-200 ; if (v === 'HIGH') return ${base} bg-orange-50 text-orange-700 border-orange-200 ; if (v === 'MEDIUM') return ${base} bg-yellow-50 text-yellow-700 border-yellow-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } if (v === 'OPEN') return ${base} bg-blue-50 text-blue-700 border-blue-200 ; if (v === 'MITIGATED') return ${base} bg-green-50 text-green-700 border-green-200 ; if (v === 'CLOSED') return ${base} bg-gray-50 text-gray-700 border-gray-200 ; return ${base} bg-gray-50 text-gray-700 border-gray-200 ; } export default function IncidentDetailsTabs({ incident, evidence, }: { incident: Incident; evidence: any[]; }) { const [tab, setTab] = useState<'evidence' | 'custody' | 'commands'>('evidence'); const [custody, setCustody] = useState<CustodyEvent[]>([]); const [custodyLoading, setCustodyLoading] = useState(false); const [custodyErr, setCustodyErr] = useState(''); const [commands, setCommands] = useState<DeviceCommandRow[]>([]); const [commandsLoading, setCommandsLoading] = useState(false); const [commandsErr, setCommandsErr] = useState(''); const incidentId = incident.incident_id; async function loadCustody() { setCustodyLoading(true); setCustodyErr(''); try { const res = await fetch( /api/incidents/${encodeURIComponent(incidentId)}/custody , { method: 'GET', cache: 'no-store', }); const json = await res.json(); if (!res.ok || !json.ok) throw new Error(json?.error?.message || 'Failed to load custody'); setCustody(json.items || []); } catch (e: any) { setCustodyErr(e?.message || 'Unexpected error'); setCustody([]); } finally { setCustodyLoading(false); } } async function loadCommands() { setCommandsLoading(true); setCommandsErr(''); try { const res = await fetch( /api/incidents/${encodeURIComponent(incidentId)}/commands , { method: 'GET', cache: 'no-store', }); const json = await res.json(); if (!res.ok || !json.ok) throw new Error(json?.error?.message || 'Failed to load commands'); setCommands(json.items || []); } catch (e: any) { setCommandsErr(e?.message || 'Unexpected error'); setCommands([]); } finally { setCommandsLoading(false); } } useEffect(() => { if (tab === 'custody' && custody.length === 0 && !custodyLoading) loadCustody(); if (tab === 'commands' && commands.length === 0 && !commandsLoading) loadCommands(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [tab]); const headerMeta = useMemo(() => { return { idShort: ${incident.incident_id.slice(0, 12)}... , detected: new Date(incident.detected_at).toLocaleString(), }; }, [incident.detected_at, incident.incident_id]); return ( <div className="p-4"> <div className="rounded-2xl border border-gray-200 bg-white p-4"> <div className="flex flex-col gap-2 md:flex-row md:items-start md:justify-between"> <div className="flex flex-col gap-1"> <div className="flex flex-wrap items-center gap-2"> <div className="text-base font-semibold text-gray-900"> {incident.incident_type} </div> <span className={badgeClass('risk', incident.risk_level)}>{incident.risk_level} </span> <span className={badgeClass('status', incident.status)}>{incident.status} </span> </div> code Code download content_copy expand_less < div className = "text-sm text-gray-700" > {incident.summary} </ div > < div className = "mt-2 grid grid-cols-1 gap-2 text-xs text-gray-600 md:grid-cols-3" > < div > Incident ID: < span className = "font-mono text-gray-800" > {headerMeta.idShort} </ span > </ div > < div > Device: < span className = "font-mono text-gray-800" > {incident.device_id} </ span > </ div > < div > Detected: < span className = "text-gray-800" > {headerMeta.detected} </ span > </ div > </ div > </ div > < div className = "mt-3 flex gap-2 md:mt-0" > < CreateExportButton incidentId = {incidentId} /> </ div > </ div > </ div > < div className = "mt-4 border-b border-gray-200" > < div className = "flex flex-wrap gap-2" > < button className = { ` rounded-xl px-3 py-2 text-sm font-medium ${ tab === 'evidence' ? ' bg-gray-900 text-white ' : ' bg-white text-gray-900 border border-gray-200 ' }`} onClick = {() => setTab('evidence')} > Evidence ({evidence?.length || 0}) </ button > < button className = { ` rounded-xl px-3 py-2 text-sm font-medium ${ tab === 'custody' ? ' bg-gray-900 text-white ' : ' bg-white text-gray-900 border border-gray-200 ' }`} onClick = {() => setTab('custody')} > Custody Timeline </ button > < button className = { ` rounded-xl px-3 py-2 text-sm font-medium ${ tab === 'commands' ? ' bg-gray-900 text-white ' : ' bg-white text-gray-900 border border-gray-200 ' }`} onClick = {() => setTab('commands')} > Commands </ button > </ div > </ div > < div className = "mt-4" > {tab === 'evidence' ? ( < EvidenceList evidence = {evidence || []} /> ) : tab === 'custody' ? ( < CustodyTimeline loading = {custodyLoading} error = {custodyErr} items = {custody} /> ) : ( < CommandsStatusTable loading = {commandsLoading} error = {commandsErr} items = {commands} /> )} </ div > </ div > ); } [6] نقطة أمنية “مؤسسية” (جاهزة للمرحلة التالية) الآن لديك Export Manifest رسمي يثبت: ما الذي تم التقاطه (Evidence Hashes + Keys) متى تم التقاطه (Captured timestamps) سلسلة الحيازة (Custody hash chain snapshot) ماذا فعل النظام فورًا (Commands + Ack proofs) وهذا يعطيك أساس قوي لميزة “Digital Evidence Vault” على مستوى المؤسسات. [7] Suggested Next Steps [7.1] إضافة صفحة Exports List داخل لوحة الوالد تعرض كل الـ Exports السابقة مع Download + Copy Hash. [7.2] إضافة Worker/Queue لإنشاء ZIP حقيقي يحتوي: Manifest + Evidence files + Custody report PDF. [7.3] تطبيق صلاحية “الأب فقط” على عمليات حساسة مثل: Export/Delete/Override (إن رغبت)، عبر Role Enforcement داخل requireFamilyAccess.
[150] [1] ## تمام — نكمل الآن بالميزة المؤسسية التالية: Exports Center داخل لوحة الوالد الهدف: صفحة تعرض كل الـ Exports السابقة (Manifest Snapshots) لكل Family مع: قائمة Exports (مع Download Manifest + Copy Hash) صلاحية “الأب فقط” لعمليات حساسة مثل حذف Export API List + API Delete + UI Table جاهزة للتوسع لاحقًا إلى ZIP/Case Package جميع الأكواد أدناه كاملة (ملف كامل من أول سطر لآخر سطر). [2] API: List Exports لكل Family المسار: app/api/families/[familyId]/exports/route.ts // app/api/families/[familyId]/exports/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function toInt(v: string | null, fallback: number) { const n = Number(v); if (!Number.isFinite(n) || n <= 0) return fallback; return Math.min(n, 100); } export async function GET(req: NextRequest, ctx: { params: { familyId: string } }) { try { const principal = getPrincipal(req); const familyId = ctx.params.familyId; code Code download content_copy expand_less if (!requireFamilyAccess(principal, familyId)) throw new HttpError( 403 , 'Forbidden' ); const url = new URL(req.url); const limit = toInt(url.searchParams. get ( 'limit' ), 30 ); const cursor = url.searchParams. get ( 'cursor' ); // export_id cursor const items = await prisma.exportBundle.findMany({ where : { family_id: familyId, ...(cursor ? { export_id: { lt: cursor } } : {}), }, orderBy: { created_at: 'desc' }, take: limit + 1 , select: { export_id: true , incident_id: true , created_at: true , created_by_user_id: true , manifest_sha256_hex: true , }, }); const hasMore = items.length > limit; const sliced = hasMore ? items.slice( 0 , limit) : items; const next_cursor = hasMore ? sliced[sliced.length - 1 ]?.export_id ?? null : null ; return NextResponse.json( { ok: true , items: sliced, next_cursor, }, { status: 200 } ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [3] API: Delete Export (الأب فقط) المسار: app/api/exports/[id]/delete/route.ts مسموح فقط لـ PARENT_OWNER (الأب مدير الأسرة) يسجل CustodyEvent باسم EXPORT_DELETED (حتى لو الحذف منطقيًا غير مفضل، لكنه مطلوب كمؤسسة مع سجل أثر) // app/api/exports/[id]/delete/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, requireOwnerRole, HttpError } from '@/lib/auth'; import crypto from 'crypto'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } export async function POST(req: NextRequest, ctx: { params: { id: string } }) { try { const principal = getPrincipal(req); const export_id = ctx.params.id; code Code download content_copy expand_less const exp = await prisma.exportBundle.findUnique({ where : { export_id }, select : { export_id : true , family_id : true , incident_id : true , manifest_sha256_hex : true , }, }); if (!exp) throw new HttpError( 404 , 'Export not found' ); if (!requireFamilyAccess(principal, exp.family_id)) throw new HttpError( 403 , 'Forbidden' ); // الأب فقط requireOwnerRole(principal); // سجل الحيازة قبل الحذف const created_at = new Date (); const last = await prisma.custodyEvent.findFirst({ where : { family_id : exp.family_id, incident_id : exp.incident_id }, orderBy : { event_at : 'desc' }, select : { hash_hex : true }, }); const prev_hash_hex = last?.hash_hex ?? null ; const event_json = { export_id : exp.export_id, manifest_sha256_hex : exp.manifest_sha256_hex, deleted_by_user_id : principal.user_id || null , }; const hash_payload = JSON .stringify({ family_id : exp.family_id, incident_id : exp.incident_id, actor : 'PARENT_CONSOLE' , event_key : 'EXPORT_DELETED' , event_at : created_at.toISOString(), prev_hash_hex, event_json, }); const hash_hex = sha256Hex(hash_payload); await prisma.custodyEvent.create({ data : { family_id : exp.family_id, incident_id : exp.incident_id, actor : 'PARENT_CONSOLE' , event_key : 'EXPORT_DELETED' , event_at : created_at, event_json, prev_hash_hex, hash_hex, }, select : { custody_id : true }, }); // حذف Export (ملاحظة: هذا لا يحذف الأدلة نفسها من التخزين) await prisma.exportBundle.delete({ where : { export_id } }); return NextResponse.json({ ok : true }, { status : 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [4] UI: صفحة Exports List داخل Family المسار: app/(parent)/families/[familyId]/exports/page.tsx 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import ExportsTable, { ExportRow } from '@/components/parent/ExportsTable'; type ApiListResponse = { ok: boolean; items: ExportRow[]; next_cursor: string | null; }; function buildUrl(base: string, params: Record<string, string | number | undefined | null>) { const u = new URL(base, ' http://localhost '); Object.entries(params).forEach(([k, v]) => { if (v === undefined || v === null || String(v).trim() === '') return; u.searchParams.set(k, String(v)); }); // Remove fake origin return u.pathname + '?' + u.searchParams.toString(); } export default function FamilyExportsPage({ params, }: { params: { familyId: string }; }) { const familyId = params.familyId; const [items, setItems] = useState<ExportRow[]>([]); const [nextCursor, setNextCursor] = useState<string | null>(null); const [loading, setLoading] = useState <boolean> (true); const [loadingMore, setLoadingMore] = useState <boolean> (false); const [err, setErr] = useState <string> (''); const baseEndpoint = useMemo(() => { return /api/families/${encodeURIComponent(familyId)}/exports ; }, [familyId]); async function loadFirstPage() { setLoading(true); setErr(''); try { const url = buildUrl(baseEndpoint, { limit: 30 }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiListResponse; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load exports' ); } setItems(json.items || []); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); setItems([]); setNextCursor( null ); } finally { setLoading( false ); } } async function loadMore() { if (!nextCursor) return; setLoadingMore(true); setErr(''); code Code download content_copy expand_less try { const url = buildUrl(baseEndpoint, { limit : 30 , cursor : nextCursor }); const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiListResponse; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load more exports' ); } setItems( ( prev ) => [...prev, ...(json.items || [])]); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); } finally { setLoadingMore( false ); } } useEffect(() => { loadFirstPage(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [baseEndpoint]); return ( <div className="min-h-screen bg-white"> <div className="mx-auto max-w-6xl px-4 py-6"> <div className="flex flex-col gap-2"> <h1 className="text-xl font-semibold text-gray-900"> Exports </h1> <p className="text-sm text-gray-600"> Official evidence manifests created by the family for incidents (forensic snapshots). </p> </div> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white shadow-sm" > {err ? ( < div className = "p-4" > < div className = "rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > </ div > ) : null} < div className = "border-t border-gray-200" > < ExportsTable loading = {loading} items = {items} familyId = {familyId} onRefresh = {loadFirstPage} /> </ div > < div className = "flex items-center justify-between px-4 py-4" > < div className = "text-xs text-gray-500" > {items.length === 0 && !loading ? 'No exports found.' : `Loaded: ${items.length}`} </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50" onClick = {loadMore} disabled = {!nextCursor || loadingMore } > {loadingMore ? 'Loading...' : nextCursor ? 'Load more' : 'No more'} </ button > </ div > </ div > </ div > </ div > ); } [5] Component: ExportsTable + Delete (Owner-only) المسار: components/parent/ExportsTable.tsx UI يعرض: Export ID، Incident ID، CreatedAt، Manifest Hash، Download، Copy، Delete (للأب فقط) 'use client'; import React, { useState } from 'react'; export type ExportRow = { export_id: string; incident_id: string; created_at: string; created_by_user_id: string | null; manifest_sha256_hex: string; }; function shortId(id: string) { if (!id) return ''; if (id.length <= 14) return id; return id.slice(0, 12) + '...'; } async function safeJson(res: Response) { try { return await res.json(); } catch { return null; } } export default function ExportsTable({ loading, items, familyId, onRefresh, }: { loading: boolean; items: ExportRow[]; familyId: string; onRefresh: () => void; }) { const [busyId, setBusyId] = useState <string> (''); const [err, setErr] = useState <string> (''); async function deleteExport(exportId: string) { setBusyId(exportId); setErr(''); try { const res = await fetch( /api/exports/${encodeURIComponent(exportId)}/delete , { method: 'POST', cache: 'no-store', }); code Code download content_copy expand_less const json = await safeJson(res); if (!res.ok || !json?.ok) { throw new Error (json?.error?.message || 'Delete failed (owner only)' ); } onRefresh(); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); } finally { setBusyId( '' ); } } return ( <div className="w-full overflow-x-auto"> {err ? ( <div className="px-4 pt-4"> <div className="rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700"> {err} </div> </div> ) : null} code Code download content_copy expand_less < table className = "min-w-full border-separate border-spacing-0" > < thead > < tr className = "bg-gray-50" > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Export </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Incident </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Created </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Manifest Hash </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Actions </ th > </ tr > </ thead > < tbody > {loading ? ( < tr > < td colSpan = {5} className = "px-4 py-6 text-sm text-gray-600" > Loading exports... </ td > </ tr > ) : items.length === 0 ? ( < tr > < td colSpan = {5} className = "px-4 py-6 text-sm text-gray-600" > No exports available. </ td > </ tr > ) : ( items.map((x) => { const downloadUrl = `/api/exports/${encodeURIComponent(x.export_id)}/manifest`; return ( < tr key = {x.export_id} className = "hover:bg-gray-50" > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-900" > < div className = "font-semibold text-gray-900" > {shortId(x.export_id)} </ div > < div className = "mt-1 font-mono text-[11px] text-gray-600" > {x.export_id} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > < div className = "font-mono text-xs" > {shortId(x.incident_id)} </ div > < div className = "mt-1 font-mono text-[11px] text-gray-600" > {x.incident_id} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {new Date(x.created_at).toLocaleString()} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-xs text-gray-700" > < div className = "break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {x.manifest_sha256_hex} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3" > < div className = "flex flex-wrap gap-2" > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {downloadUrl} > Download </ a > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(x.manifest_sha256_hex)} > Copy Hash </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(x.export_id)} > Copy Export ID </ button > < button className = "rounded-xl border border-red-200 bg-white px-3 py-2 text-sm font-semibold text-red-700 hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-60" onClick = {() => deleteExport(x.export_id)} disabled={busyId === x.export_id} title="Owner only" > {busyId === x.export_id ? 'Deleting...' : 'Delete'} </ button > </ div > </ td > </ tr > ); }) )} </ tbody > </ table > < div className = "px-4 py-3 text-xs text-gray-500" > Family: < span className = "font-mono" > {familyId} </ span > </ div > </ div > ); } [6] ملفات “تثبيت الأساس” المطلوبة (حتى لا يكون عندك أي نقص) [6.1] Prisma Client المسار: lib/prisma.ts // lib/prisma.ts import { PrismaClient } from '@prisma/client'; declare global { // eslint-disable-next-line no-var var prisma: PrismaClient | undefined; } export const prisma = global.prisma || new PrismaClient({ log: ['error', 'warn'], }); if (process.env.NODE_ENV !== 'production') { global.prisma = prisma; } [6.2] Auth (Placeholder مؤسسي قابل للاستبدال) المسار: lib/auth.ts هذا الملف قابل للاستبدال لاحقًا بـ Clerk/Auth0/Firebase Auth… لكنه الآن يوفر: Principal + صلاحية Family + صلاحية “Owner فقط”. // lib/auth.ts import { NextRequest } from 'next/server'; export class HttpError extends Error { status: number; constructor(status: number, message: string) { super(message); this.status = status; } } export type Principal = { user_id: string | null; family_id: string | null; family_role: 'PARENT_OWNER' | 'PARENT_GUARDIAN' | 'ADMIN' | 'SUPPORT' | 'DEV' | 'SECURITY' | 'UNKNOWN'; }; /** Placeholder: Reads headers (can be replaced later with real session/JWT). Headers: x-user-id: <string> x-family-id: <string> x-family-role: PARENT_OWNER | PARENT_GUARDIAN | ... */ export function getPrincipal(req: NextRequest): Principal { const user_id = req.headers.get('x-user-id'); const family_id = req.headers.get('x-family-id'); const family_role_raw = (req.headers.get('x-family-role') || 'UNKNOWN').toUpperCase(); const allowed = new Set([ 'PARENT_OWNER', 'PARENT_GUARDIAN', 'ADMIN', 'SUPPORT', 'DEV', 'SECURITY', 'UNKNOWN', ]); const family_role = (allowed.has(family_role_raw) ? family_role_raw : 'UNKNOWN') as Principal['family_role']; return { user_id: user_id ? String(user_id) : null, family_id: family_id ? String(family_id) : null, family_role, }; } export function requireFamilyAccess(principal: Principal, family_id: string): boolean { // If system roles later exist, allow them here. if (principal.family_id && principal.family_id === family_id) return true; // Optionally allow system admins: if (principal.family_role === 'ADMIN' || principal.family_role === 'SECURITY') return true; return false; } export function requireOwnerRole(principal: Principal) { if (principal.family_role !== 'PARENT_OWNER') { throw new HttpError(403, 'Owner role required (father only)'); } } [7] لماذا هذا مهم جدًا (مستوى مؤسسي حقيقي) هذا يحقق 4 نقاط جوهرية: Evidence Vault قابل للاستخدام القانوني عبر Manifest ثابت إدارة عمليات العائلة: الأب فقط يحذف أو يدير عناصر حساسة سجل أثر Custody يُظهر كل شيء حتى عمليات الحذف جاهز للترقية إلى ZIP + PDF Report + Signed Share Link لاحقًا [8] Suggested Next Steps [8.1] إضافة Exports Link داخل Sidebar للوالدين + ربطه بـ families/[familyId]/exports. [8.2] إضافة API لتوليد Signed Download URLs لكل Evidence داخل الـ Manifest (اختياري، حسب سياسة الخصوصية). [8.3] تنفيذ ZIP Worker (Queue) لإنشاء ملف Evidence Package رسمي: Manifest JSON Custody Report PDF Evidence files Summary Page إذا تريد، سأبدأ مباشرة بـ Sidebar Update + إضافة صفحة “Exports” كرابط ظاهر داخل لوحة الوالد.
[151] [1] ## تمام — نكمل الآن بالجزء الذي يجعل Parent Console “مكتمل مؤسسيًا”: Sidebar Navigation + ربط الصفحات رسميًا الآن سننفّذ 4 أشياء أساسية: Sidebar احترافي ثابت في كل صفحات الوالد إضافة روابط ناقصة (Incidents / Exports / Evidence Vault / Devices / Profiles / Rules) Layout موحّد لـ (parent) بحيث كل الصفحات ترث نفس الـ UI صفحات Placeholder جاهزة للتطوير (Evidence Vault / Devices / Profiles / Rules) بدون كسر النظام جميع الأكواد أدناه كاملة. [2] Layout موحد للوالدين Parent Layout المسار: app/(parent)/layout.tsx // app/(parent)/layout.tsx 'use client'; import React from 'react'; import ParentSidebar from '@/components/parent/ParentSidebar'; export default function ParentLayout({ children }: { children: React.ReactNode }) { // ملاحظة: familyId سيتم تمريره ضمن روابط الصفحات حسب route الحالية // في مرحلة لاحقة: نقرأ familyId من session أو context. const fallbackFamilyId = 'current'; return ( <div className="min-h-screen bg-white"> <div className="mx-auto flex max-w-[1400px] gap-4 px-4 py-4"> <div className="w-[280px] shrink-0"> <ParentSidebar familyId={fallbackFamilyId} /> </div> code Code download content_copy expand_less < div className = "flex-1" > < div className = "rounded-2xl border border-gray-200 bg-white shadow-sm" > {children} </ div > </ div > </ div > </ div > ); } ملاحظة هندسية: fallbackFamilyId='current' مجرد Placeholder حتى نربط familyId من Session أو من URL فعليًا. الخطوة القادمة بعد هذا مباشرة: نعمل FamilyResolver يقرأ الـ familyId الحقيقي من الـ principal. [3] Sidebar Component جاهز للإنتاج المسار: components/parent/ParentSidebar.tsx تصميم مؤسسي Links واضحة يميز الصفحة الحالية يجهّز روابط قادمة (Rules / Profiles / Devices / Evidence Vault) // components/parent/ParentSidebar.tsx 'use client'; import React, { useMemo } from 'react'; import Link from 'next/link'; import { usePathname } from 'next/navigation'; type Item = { key: string; label: string; href: string; hint?: string; }; function classJoin(...xs: Array<string | false | null | undefined>) { return xs.filter(Boolean).join(' '); } function isActivePath(pathname: string, href: string) { if (!href || href === '#') return false; if (href === '/') return pathname === '/'; return pathname === href || pathname.startsWith(href + '/'); } export default function ParentSidebar({ familyId }: { familyId: string }) { const pathname = usePathname(); const items = useMemo<Item[]>(() => { const fid = encodeURIComponent(familyId); code Code download content_copy expand_less return [ { key : 'dashboard' , label : 'Dashboard' , href : `/families/ ${fid} /incidents` , hint : 'Incidents overview' , }, { key : 'incidents' , label : 'Incidents' , href : `/families/ ${fid} /incidents` , hint : 'Detected events & actions' , }, { key : 'exports' , label : 'Exports' , href : `/families/ ${fid} /exports` , hint : 'Forensic manifests' , }, { key : 'evidenceVault' , label : 'Evidence Vault' , href : `/families/ ${fid} /vault` , hint : 'All evidence across incidents' , }, { key : 'devices' , label : 'Devices' , href : `/families/ ${fid} /devices` , hint : 'Children devices management' , }, { key : 'profiles' , label : 'Smart Profiles' , href : `/families/ ${fid} /profiles` , hint : 'Study / Sleep / Custom modes' , }, { key : 'rules' , label : 'Auto Defense Rules' , href : `/families/ ${fid} /rules` , hint : 'Automation policies' , }, { key : 'settings' , label : 'Settings' , href : `/families/ ${fid} /settings` , hint : 'Family settings & access' , }, ]; }, [familyId]); return ( <aside className="sticky top-4 rounded-2xl border border-gray-200 bg-white shadow-sm"> <div className="border-b border-gray-200 p-4"> <div className="flex flex-col gap-1"> <div className="text-sm font-semibold text-gray-900"> AMANA Parent Console </div> <div className="text-xs text-gray-600"> Family: <span className="ml-2 rounded-lg border border-gray-200 bg-gray-50 px-2 py-0.5 font-mono text-[11px] text-gray-800"> {familyId} </span> </div> </div> </div> code Code download content_copy expand_less < nav className = "p-2" > {items.map((it) => { const active = isActivePath(pathname, it.href); return ( < Link key = {it.key} href = {it.href} className = {classJoin( ' group flex w-full flex-col gap-0.5 rounded-2xl px-3 py-2 transition ', active ? ' bg-gray-900 text-white ' : ' border border-transparent bg-white text-gray-900 hover:bg-gray-50 hover:border-gray-200 ' )} > < div className = "flex items-center justify-between" > < div className = "text-sm font-semibold" > {it.label} </ div > < div className = {classJoin( ' text- [ 11px ]', active ? ' text-white / 70 ' : ' text-gray-400 group-hover:text-gray-500 ' )} > → </ div > </ div > {it.hint ? ( < div className = {classJoin( ' text-xs ', active ? ' text-white / 70 ' : ' text-gray-500 ')}> {it.hint} </ div > ) : null} </ Link > ); })} </ nav > < div className = "border-t border-gray-200 p-4" > < div className = "rounded-2xl border border-gray-200 bg-gray-50 p-3" > < div className = "text-xs font-semibold text-gray-900" > Security Mode </ div > < div className = "mt-1 text-xs text-gray-700" > Evidence is hash-chained and access-controlled per family roles. </ div > </ div > </ div > </ aside > ); } [4] صفحات Placeholder جاهزة للتطوير (بدون كسر النظام) [4.1] Evidence Vault صفحة المسار: app/(parent)/families/[familyId]/vault/page.tsx // app/(parent)/families/[familyId]/vault/page.tsx 'use client'; import React from 'react'; export default function EvidenceVaultPage({ params }: { params: { familyId: string } }) { return ( <div className="p-6"> <h1 className="text-xl font-semibold text-gray-900"> Evidence Vault </h1> <p className="mt-2 text-sm text-gray-600"> Centralized vault showing all evidence across all incidents (family-scoped). </p> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Coming Next </ div > < ul className = "mt-2 list-inside list-disc text-sm text-gray-700" > < li > Global evidence filters: type, device, date, incident, risk </ li > < li > Quick preview and download (signed URLs) </ li > < li > Custody chain verification per evidence item </ li > </ ul > < div className = "mt-3 text-xs text-gray-500" > Family: < span className = "font-mono" > {params.familyId} </ span > </ div > </ div > </ div > ); } [4.2] Devices صفحة المسار: app/(parent)/families/[familyId]/devices/page.tsx // app/(parent)/families/[familyId]/devices/page.tsx 'use client'; import React from 'react'; export default function DevicesPage({ params }: { params: { familyId: string } }) { return ( <div className="p-6"> <h1 className="text-xl font-semibold text-gray-900"> Devices </h1> <p className="mt-2 text-sm text-gray-600"> Manage children devices, live status, location, profiles, and emergency actions. </p> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Coming Next </ div > < ul className = "mt-2 list-inside list-disc text-sm text-gray-700" > < li > Device pairing status + last heartbeat </ li > < li > Live location + safe zones </ li > < li > Quick actions (lock screen / block app / cut internet) </ li > </ ul > < div className = "mt-3 text-xs text-gray-500" > Family: < span className = "font-mono" > {params.familyId} </ span > </ div > </ div > </ div > ); } [4.3] Smart Profiles صفحة المسار: app/(parent)/families/[familyId]/profiles/page.tsx // app/(parent)/families/[familyId]/profiles/page.tsx 'use client'; import React from 'react'; export default function ProfilesPage({ params }: { params: { familyId: string } }) { return ( <div className="p-6"> <h1 className="text-xl font-semibold text-gray-900"> Smart Profiles </h1> <p className="mt-2 text-sm text-gray-600"> Study / Sleep / Custom modes applied per device with schedules and restrictions. </p> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Coming Next </ div > < ul className = "mt-2 list-inside list-disc text-sm text-gray-700" > < li > Create profile templates (Study / Sleep / Travel) </ li > < li > Schedule profiles by time and days </ li > < li > Override and emergency exceptions </ li > </ ul > < div className = "mt-3 text-xs text-gray-500" > Family: < span className = "font-mono" > {params.familyId} </ span > </ div > </ div > </ div > ); } [4.4] Auto Defense Rules صفحة المسار: app/(parent)/families/[familyId]/rules/page.tsx // app/(parent)/families/[familyId]/rules/page.tsx 'use client'; import React from 'react'; export default function RulesPage({ params }: { params: { familyId: string } }) { return ( <div className="p-6"> <h1 className="text-xl font-semibold text-gray-900"> Auto Defense Rules </h1> <p className="mt-2 text-sm text-gray-600"> Configure automatic actions per incident type and risk level (family-scoped). </p> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Coming Next </ div > < ul className = "mt-2 list-inside list-disc text-sm text-gray-700" > < li > Rule engine UI (enable/disable per category) </ li > < li > Action chains (block app → cut internet → lock screen) </ li > < li > Owner-only destructive overrides </ li > </ ul > < div className = "mt-3 text-xs text-gray-500" > Family: < span className = "font-mono" > {params.familyId} </ span > </ div > </ div > </ div > ); } [4.5] Settings صفحة المسار: app/(parent)/families/[familyId]/settings/page.tsx // app/(parent)/families/[familyId]/settings/page.tsx 'use client'; import React from 'react'; export default function FamilySettingsPage({ params }: { params: { familyId: string } }) { return ( <div className="p-6"> <h1 className="text-xl font-semibold text-gray-900"> Settings </h1> <p className="mt-2 text-sm text-gray-600"> Manage family members, roles, notifications, and security policies. </p> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Coming Next </ div > < ul className = "mt-2 list-inside list-disc text-sm text-gray-700" > < li > Add mother as guardian with limited permissions </ li > < li > Notification policy per incident severity </ li > < li > Export retention policies and audit visibility </ li > </ ul > < div className = "mt-3 text-xs text-gray-500" > Family: < span className = "font-mono" > {params.familyId} </ span > </ div > </ div > </ div > ); } [5] تعديل بسيط: جعل صفحات Incidents/Exports تتناسب مع Layout الجديد إذا صفحاتك الحالية تعرض خلفية كاملة + حواف، فهي ستظهر داخل Card بالفعل. الحل الأمثل: نُبقي صفحاتها كما هي الآن، أو نخفف الحواف الداخلية لاحقًا. لا يلزم تعديل الآن لأن Layout سيغلفها. [6] نقطة أمنية مهمة قبل ميزة Evidence Vault الحقيقية لكي تكون “Evidence Vault” قوية فعليًا، نحتاج: API جديد: GET /api/families/:id/evidence يدعم filters: type, device_id, date range, incident_id مع Signed URLs تنزيل آمن (S3 / R2 / GCS) مع Audit log عند كل Download سأبدأ بتنفيذ هذا مباشرة في الخطوة القادمة. [7] Suggested Next Steps [7.1] تنفيذ Evidence Vault API + UI Table مع Preview وفلترة قوية. [7.2] تنفيذ Signed Download URLs بحيث لا يظهر أي ملف بدون توقيع صالح + Expiry. [7.3] إضافة Download Audit Events إلى custodyEvent باسم EVIDENCE_DOWNLOADED.
[152] Fix the following errors: code Code download content_copy expand_less Uncaught TypeError: Failed to resolve module specifier "@/app/components/parent/IncidentsTable". Relative references must start with either "/", "./", or "../".
[153] Fix the following errors: code Code download content_copy expand_less Uncaught TypeError: Failed to resolve module specifier "@/app/components/parent/IncidentsTable". Relative references must start with either "/", "./", or "../".
[154] [1] ## تمام — الآن سننفّذ “Evidence Vault الحقيقي” بشكل مؤسسي كامل الهدف: عرض كل الأدلة الرقمية للأسرة عبر كل الحوادث، مع: API Evidence Vault مع Filters + Pagination Signed Download URLs (روابط تنزيل موقّعة قصيرة العمر) عبر Proxy آمن Audit/Custody Event عند كل تنزيل: EVIDENCE_DOWNLOADED UI Evidence Vault بفلترة + Preview + Download + Copy Hash كل الملفات أدناه كاملة من أول سطر لآخر سطر. [2] مواصفات API Evidence Vault (Filters + Pagination) جدول معاملات الاستعلام (Query Params) Param Type Example Meaning type string SCREENSHOT فلترة حسب نوع الدليل device_id string dev_123 فلترة حسب الجهاز incident_id string inc_abc فلترة حسب الحادثة from ISO date 2026-01-01 بداية الفترة to ISO date 2026-01-18 نهاية الفترة q string telegram بحث نصي داخل storage_key/metadata limit number 30 عدد النتائج cursor string evd_xxx Pagination cursor [3] lib: توقيع روابط التنزيل Signed URLs (HMAC + Expiry) المسار: lib/storage.ts هذا الملف يبني رابط تنزيل موقّع مثل: /api/storage/download?evidence_id=...&exp=...&sig=... // lib/storage.ts import crypto from 'crypto'; export type SignedDownload = { url: string; exp: number; }; function mustGetEnv(name: string, fallback = '') { const v = process.env[name] || fallback; if (!v) throw new Error( Missing env: ${name} ); return v; } function hmacSha256Hex(secret: string, data: string) { return crypto.createHmac('sha256', secret).update(data).digest('hex'); } /** Data to sign: evidence_id|exp */ export function signEvidenceDownloadUrl(evidence_id: string, expiresInSec = 120): SignedDownload { const secret = mustGetEnv('STORAGE_SIGNING_SECRET', 'DEV_ONLY_CHANGE_ME'); const exp = Math.floor(Date.now() / 1000) + Math.max(30, expiresInSec); const payload = ${evidence_id}|${exp} ; const sig = hmacSha256Hex(secret, payload); const url = /api/storage/download?evidence_id=${encodeURIComponent(evidence_id)}&exp=${exp}&sig=${sig} ; return { url, exp }; } export function verifyEvidenceDownloadSignature(evidence_id: string, exp: number, sig: string) { const secret = mustGetEnv('STORAGE_SIGNING_SECRET', 'DEV_ONLY_CHANGE_ME'); const payload = ${evidence_id}|${exp} ; const expected = hmacSha256Hex(secret, payload); // constant-time compare const a = Buffer.from(expected, 'hex'); const b = Buffer.from(sig || '', 'hex'); if (a.length !== b.length) return false; return crypto.timingSafeEqual(a, b); } [4] API: Evidence Vault List (Family-scoped + Signed URLs) المسار: app/api/families/[familyId]/evidence/route.ts يرجع الأدلة مع download_url موقّع لكل عنصر. // app/api/families/[familyId]/evidence/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { signEvidenceDownloadUrl } from '@/lib/storage'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function toInt(v: string | null, fallback: number) { const n = Number(v); if (!Number.isFinite(n) || n <= 0) return fallback; return Math.min(n, 100); } function safeStr(v: string | null) { const s = (v || '').trim(); return s.length ? s : null; } function safeDateISO(v: string | null) { if (!v) return null; const d = new Date(v); if (Number.isNaN(d.getTime())) return null; return d; } export async function GET(req: NextRequest, ctx: { params: { familyId: string } }) { try { const principal = getPrincipal(req); const familyId = ctx.params.familyId; code Code download content_copy expand_less if (!requireFamilyAccess(principal, familyId)) throw new HttpError( 403 , 'Forbidden' ); const url = new URL(req.url); const type = safeStr(url.searchParams.get( 'type' )); const device_id = safeStr(url.searchParams.get( 'device_id' )); const incident_id = safeStr(url.searchParams.get( 'incident_id' )); const q = safeStr(url.searchParams.get( 'q' )); const from = safeDateISO(url.searchParams.get( 'from' )); const to = safeDateISO(url.searchParams.get( 'to' )); const limit = toInt(url.searchParams.get( 'limit' ), 30 ); const cursor = safeStr(url.searchParams.get( 'cursor' )); // evidence_id cursor const where: any = { family_id : familyId, ...( type ? { evidence_type : type } : {}), ...(device_id ? { meta_json : { path : [ 'device_id' ], equals : device_id } } : {}), ...(incident_id ? { incident_id } : {}), ...( from || to ? { captured_at : { ...( from ? { gte : from } : {}), ...(to ? { lte : to } : {}), }, } : {}), ...(q ? { OR : [ { storage_key : { contains : q, mode : 'insensitive' } }, { mime_type : { contains : q, mode : 'insensitive' } }, ], } : {}), ...(cursor ? { evidence_id : { lt : cursor } } : {}), }; const rows = await prisma.evidenceItem.findMany({ where, orderBy : { captured_at : 'desc' }, take : limit + 1 , select : { evidence_id : true , incident_id : true , evidence_type : true , storage_key : true , mime_type : true , size_bytes : true , sha256_hex : true , captured_at : true , meta_json : true , }, }); const hasMore = rows.length > limit; const sliced = hasMore ? rows.slice( 0 , limit) : rows; const next_cursor = hasMore ? sliced[sliced.length - 1 ]?.evidence_id ?? null : null ; const items = sliced.map( ( e ) => { const signed = signEvidenceDownloadUrl(e.evidence_id, 120 ); return { ...e, captured_at : e.captured_at.toISOString(), download_url : signed.url, download_exp : signed.exp, }; }); return NextResponse.json({ ok : true , items, next_cursor }, { status : 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [5] API: Storage Download Proxy (Signed + Family-scoped + Custody Event) المسار: app/api/storage/download/route.ts هذه أخطر نقطة في النظام، لذلك: يتحقق من التوقيع + Expiry يتحقق أن الدليل يخص نفس Family يسجل custodyEvent = EVIDENCE_DOWNLOADED ثم يقوم بتنزيل الملف من Storage Driver (S3/R2 أو Local) هذه النسخة تدعم طريقتين: STORAGE_DRIVER=s3 (أو r2) عبر AWS SDK v3 STORAGE_DRIVER=local من ملفات محلية (للتطوير فقط) // app/api/storage/download/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { verifyEvidenceDownloadSignature } from '@/lib/storage'; import crypto from 'crypto'; import fs from 'fs'; import path from 'path'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } async function streamLocalFile(absolutePath: string, mime: string, filename: string) { if (!fs.existsSync(absolutePath)) { throw new HttpError(404, 'File not found (local driver)'); } const stat = fs.statSync(absolutePath); const stream = fs.createReadStream(absolutePath); return new NextResponse(stream as any, { status: 200, headers: { 'Content-Type': mime || 'application/octet-stream', 'Content-Length': String(stat.size), 'Content-Disposition': attachment; filename="${filename}" , }, }); } async function streamS3Object(storage_key: string, mime: string, filename: string) { // Requires: npm i @aws-sdk/client-s3 // Env: // STORAGE_S3_ENDPOINT (optional) // STORAGE_S3_REGION // STORAGE_S3_ACCESS_KEY // STORAGE_S3_SECRET_KEY // STORAGE_S3_BUCKET const bucket = getEnv('STORAGE_S3_BUCKET'); const region = getEnv('STORAGE_S3_REGION', 'auto'); const accessKeyId = getEnv('STORAGE_S3_ACCESS_KEY'); const secretAccessKey = getEnv('STORAGE_S3_SECRET_KEY'); if (!bucket || !accessKeyId || !secretAccessKey) { throw new HttpError(500, 'S3 driver missing env config'); } const endpoint = getEnv('STORAGE_S3_ENDPOINT', ''); const { S3Client, GetObjectCommand } = await import('@aws-sdk/client-s3'); const client = new S3Client({ region, ...(endpoint ? { endpoint } : {}), credentials: { accessKeyId, secretAccessKey }, }); const cmd = new GetObjectCommand({ Bucket: bucket, Key: storage_key, }); const out: any = await client.send(cmd); const bodyStream = out?.Body; if (!bodyStream) { throw new HttpError(404, 'Object not found in S3'); } return new NextResponse(bodyStream as any, { status: 200, headers: { 'Content-Type': mime || out?.ContentType || 'application/octet-stream', 'Content-Disposition': attachment; filename="${filename}" , }, }); } export async function GET(req: NextRequest) { try { const principal = getPrincipal(req); code Code download content_copy expand_less const url = new URL(req.url); const evidence_id = String (url.searchParams.get( 'evidence_id' ) || '' ).trim(); const exp = Number (url.searchParams.get( 'exp' ) || 0 ); const sig = String (url.searchParams.get( 'sig' ) || '' ).trim(); if (!evidence_id || !exp || !sig) throw new HttpError( 400 , 'Missing signed params' ); const now = Math .floor( Date .now() / 1000 ); if (exp < now) throw new HttpError( 401 , 'Signed URL expired' ); const valid = verifyEvidenceDownloadSignature(evidence_id, exp, sig); if (!valid) throw new HttpError( 401 , 'Invalid signature' ); const ev = await prisma.evidenceItem.findUnique({ where : { evidence_id }, select : { evidence_id : true , family_id : true , incident_id : true , storage_key : true , mime_type : true , evidence_type : true , sha256_hex : true , captured_at : true , }, }); if (!ev) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, ev.family_id)) { throw new HttpError( 403 , 'Forbidden' ); } // Audit custody: EVIDENCE_DOWNLOADED const created_at = new Date (); const last = await prisma.custodyEvent.findFirst({ where : { family_id : ev.family_id, incident_id : ev.incident_id || undefined }, orderBy : { event_at : 'desc' }, select : { hash_hex : true }, }); const prev_hash_hex = last?.hash_hex ?? null ; const event_json = { evidence_id : ev.evidence_id, incident_id : ev.incident_id, sha256_hex : ev.sha256_hex, downloaded_by_user_id : principal.user_id || null , }; const hash_payload = JSON .stringify({ family_id : ev.family_id, incident_id : ev.incident_id, actor : 'PARENT_CONSOLE' , event_key : 'EVIDENCE_DOWNLOADED' , event_at : created_at.toISOString(), prev_hash_hex, event_json, }); const hash_hex = sha256Hex(hash_payload); await prisma.custodyEvent.create({ data : { family_id : ev.family_id, incident_id : ev.incident_id, actor : 'PARENT_CONSOLE' , event_key : 'EVIDENCE_DOWNLOADED' , event_at : created_at, event_json, prev_hash_hex, hash_hex, }, select : { custody_id : true }, }); // Download const filename = ` ${ev.evidence_type} _ ${ev.evidence_id} ` .replace( /[^a-zA-Z0-9_\-]/g , '_' ); const driver = (getEnv( 'STORAGE_DRIVER' , 'local' ) || 'local' ).toLowerCase(); if (driver === 'local' ) { // Local base directory: STORAGE_LOCAL_DIR const baseDir = getEnv( 'STORAGE_LOCAL_DIR' , path.join(process.cwd(), 'storage_local' )); const abs = path.join(baseDir, ev.storage_key); return await streamLocalFile(abs, ev.mime_type, ` ${filename} ` ); } if (driver === 's3' || driver === 'r2' ) { return await streamS3Object(ev.storage_key, ev.mime_type, ` ${filename} ` ); } throw new HttpError( 500 , 'Unsupported STORAGE_DRIVER' ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [6] UI: Evidence Vault صفحة حقيقية بفلترة + جدول + Preview المسار: components/parent/EvidenceVaultTable.tsx 'use client'; import React, { useEffect, useMemo, useState } from 'react'; type EvidenceRow = { evidence_id: string; incident_id: string | null; evidence_type: string; storage_key: string; mime_type: string; size_bytes: number; sha256_hex: string; captured_at: string; download_url: string; download_exp: number; }; type ApiResp = { ok: boolean; items: EvidenceRow[]; next_cursor: string | null; }; function shortId(id: string) { if (!id) return ''; if (id.length <= 14) return id; return id.slice(0, 12) + '...'; } function bytes(n: number) { if (!Number.isFinite(n) || n <= 0) return '0 B'; const units = ['B', 'KB', 'MB', 'GB']; let x = n; let u = 0; while (x >= 1024 && u < units.length - 1) { x /= 1024; u++; } return ${x.toFixed(u === 0 ? 0 : 1)} ${units[u]} ; } function buildUrl(base: string, params: Record<string, string | number | null | undefined>) { const u = new URL(base, ' http://localhost '); Object.entries(params).forEach(([k, v]) => { if (v === undefined || v === null || String(v).trim() === '') return; u.searchParams.set(k, String(v)); }); return u.pathname + '?' + u.searchParams.toString(); } export default function EvidenceVaultTable({ familyId }: { familyId: string }) { const baseEndpoint = useMemo(() => { return /api/families/${encodeURIComponent(familyId)}/evidence ; }, [familyId]); const [items, setItems] = useState<EvidenceRow[]>([]); const [nextCursor, setNextCursor] = useState<string | null>(null); const [loading, setLoading] = useState(true); const [loadingMore, setLoadingMore] = useState(false); const [err, setErr] = useState(''); const [type, setType] = useState(''); const [deviceId, setDeviceId] = useState(''); const [incidentId, setIncidentId] = useState(''); const [from, setFrom] = useState(''); const [to, setTo] = useState(''); const [q, setQ] = useState(''); const [preview, setPreview] = useState<{ open: boolean; row: EvidenceRow | null }>({ open: false, row: null, }); async function loadFirstPage() { setLoading(true); setErr(''); try { const url = buildUrl(baseEndpoint, { limit: 30, type: type || null, device_id: deviceId || null, incident_id: incidentId || null, from: from || null, to: to || null, q: q || null, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiResp; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load evidence' ); } setItems(json.items || []); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); setItems([]); setNextCursor( null ); } finally { setLoading( false ); } } async function loadMore() { if (!nextCursor) return; setLoadingMore(true); setErr(''); try { const url = buildUrl(baseEndpoint, { limit: 30, cursor: nextCursor, type: type || null, device_id: deviceId || null, incident_id: incidentId || null, from: from || null, to: to || null, q: q || null, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiResp; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load more evidence' ); } setItems( ( prev ) => [...prev, ...(json.items || [])]); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); } finally { setLoadingMore( false ); } } useEffect(() => { loadFirstPage(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [baseEndpoint]); function openPreview(row: EvidenceRow) { setPreview({ open: true, row }); } function closePreview() { setPreview({ open: false, row: null }); } return ( <div className="p-6"> <div className="flex flex-col gap-2"> <h1 className="text-xl font-semibold text-gray-900"> Evidence Vault </h1> <p className="text-sm text-gray-600"> Central evidence store for the family across all incidents. </p> </div> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Filters </ div > < div className = "mt-3 grid grid-cols-1 gap-3 md:grid-cols-6" > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Type </ label > < select className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {type} onChange = {(e) => setType(e.target.value)} > < option value = "" > All </ option > < option value = "SCREENSHOT" > SCREENSHOT </ option > < option value = "AUDIO" > AUDIO </ option > < option value = "VIDEO" > VIDEO </ option > < option value = "TEXT_SNAPSHOT" > TEXT_SNAPSHOT </ option > < option value = "CAMERA_STREAM_FRAME" > CAMERA_STREAM_FRAME </ option > </ select > </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Device ID </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "dev_..." value = {deviceId} onChange = {(e) => setDeviceId(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Incident ID </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "inc_..." value = {incidentId} onChange = {(e) => setIncidentId(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > From </ label > < input type = "date" className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {from} onChange = {(e) => setFrom(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > To </ label > < input type = "date" className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {to} onChange = {(e) => setTo(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Search </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "storage key / mime..." value = {q} onChange = {(e) => setQ(e.target.value)} /> </ div > </ div > < div className = "mt-4 flex flex-wrap gap-2" > < button className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black disabled:opacity-60" onClick = {loadFirstPage} disabled = {loading} > {loading ? 'Loading...' : 'Apply Filters'} </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => { setType(''); setDeviceId(''); setIncidentId(''); setFrom(''); setTo(''); setQ(''); }} > Reset </ button > </ div > {err ? ( < div className = "mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > ) : null} </ div > < div className = "mt-5 rounded-2xl border border-gray-200 bg-white shadow-sm" > < div className = "w-full overflow-x-auto" > < table className = "min-w-full border-separate border-spacing-0" > < thead > < tr className = "bg-gray-50" > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Evidence </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Type </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Captured </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Size </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Hash </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Actions </ th > </ tr > </ thead > < tbody > {loading ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > Loading evidence... </ td > </ tr > ) : items.length === 0 ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > No evidence found. </ td > </ tr > ) : ( items.map((x) => ( < tr key = {x.evidence_id} className = "hover:bg-gray-50" > < td className = "border-b border-gray-200 px-4 py-3" > < div className = "text-sm font-semibold text-gray-900" > {shortId(x.evidence_id)} </ div > < div className = "mt-1 font-mono text-[11px] text-gray-600 break-all" > {x.storage_key} </ div > < div className = "mt-1 text-[11px] text-gray-500" > Incident: < span className = "font-mono" > {x.incident_id ? shortId(x.incident_id) : 'N/A'} </ span > </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > < div className = "font-semibold" > {x.evidence_type} </ div > < div className = "mt-1 text-[11px] text-gray-500" > {x.mime_type} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {new Date(x.captured_at).toLocaleString()} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {bytes(x.size_bytes)} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-xs text-gray-700" > < div className = "break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {x.sha256_hex} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3" > < div className = "flex flex-wrap gap-2" > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => openPreview(x)} > Preview </ button > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {x.download_url} > Download </ a > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(x.sha256_hex)} > Copy Hash </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(x.evidence_id)} > Copy ID </ button > </ div > </ td > </ tr > )) )} </ tbody > </ table > < div className = "flex items-center justify-between px-4 py-4" > < div className = "text-xs text-gray-500" > Loaded: {items.length} </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50 disabled:opacity-50" onClick = {loadMore} disabled = {!nextCursor || loadingMore } > {loadingMore ? 'Loading...' : nextCursor ? 'Load more' : 'No more'} </ button > </ div > </ div > </ div > {preview.open && preview.row ? ( < div className = "fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4" > < div className = "w-full max-w-3xl rounded-2xl border border-gray-200 bg-white shadow-xl" > < div className = "flex items-start justify-between gap-4 border-b border-gray-200 p-4" > < div > < div className = "text-base font-semibold text-gray-900" > Evidence Preview </ div > < div className = "mt-1 text-xs text-gray-600 break-all" > {preview.row.storage_key} </ div > </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {closePreview} > Close </ button > </ div > < div className = "p-4" > < div className = "rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-xs text-gray-600" > Type: < span className = "font-semibold text-gray-900" > {preview.row.evidence_type} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > SHA-256: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {preview.row.sha256_hex} </ div > </ div > < div className = "mt-4 flex flex-wrap gap-2" > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {preview.row.download_url} > Download </ a > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(preview.row.sha256_hex)} > Copy Hash </ button > </ div > < div className = "mt-4 text-xs text-gray-500" > Preview is metadata-only by default. You can enable inline media rendering after storage streaming is configured. </ div > </ div > </ div > </ div > </ div > ) : null} </ div > ); } [7] ربط Evidence Vault Page بالـ Component المسار: app/(parent)/families/[familyId]/vault/page.tsx استبدل الـ placeholder السابق بهذه النسخة الفعلية: // app/(parent)/families/[familyId]/vault/page.tsx 'use client'; import React from 'react'; import EvidenceVaultTable from '@/components/parent/EvidenceVaultTable'; export default function EvidenceVaultPage({ params }: { params: { familyId: string } }) { return <EvidenceVaultTable familyId={params.familyId} /> ; } [8] ملحوظة أمنية مهمة جدًا (حتى لا يحدث أي تسريب) هذه البنية تمنع التسريب عبر 3 طبقات: HMAC Signed URL (لا يمكن تزويره بدون SECRET) Expiry قصير (افتراضي 120 ثانية) Family Access Check داخل Proxy حتى لو الرابط “صحيح” يتم تسجيل كل تنزيل في سلسلة الحيازة كحدث: EVIDENCE_DOWNLOADED [9] Suggested Next Steps [9.1] إضافة Inline Media Preview الحقيقي (صور/صوت/فيديو) داخل Modal عبر Streaming من S3/R2. [9.2] تنفيذ Evidence Download Rate Limit لمنع abuse (لكل user/device). [9.3] إضافة “Verify Hash Locally” داخل UI: المستخدم يرفع الملف محليًا والنظام يقارن SHA-256 لإثبات عدم العبث.
[155] Fix the following errors: code Code download content_copy expand_less Uncaught TypeError: Failed to resolve module specifier "@/app/components/parent/EvidenceVaultTable". Relative references must start with either "/", "./", or "../".
[156] [1] ## تمام — الآن نرفع Evidence Vault إلى مستوى “Bark لكن مؤسسي + جنائي” عبر 3 ترقيات حاسمة سننفّذ 3 ميزات إنتاجية فوق ما بنيّناه: Inline Media Preview حقيقي (صورة/صوت/فيديو) داخل الـ Modal Streaming + Range Requests للفيديو/الصوت (تشغيل بدون تحميل كامل) Verify Hash Locally داخل UI (رفع الملف محليًا ومقارنة SHA-256 لإثبات عدم العبث) كل الملفات أدناه كاملة من أول سطر لآخر سطر. [2] تحديث نظام التوقيع: Signed URLs تدعم “Download / Preview” بشكل منفصل الملف: lib/storage.ts نضيف mode=download|preview داخل التوقيع هذا يمنع استخدام رابط Preview كـ Download والعكس يدعم Expiry قصير جدًا (مثلاً 120 ثانية) // lib/storage.ts import crypto from 'crypto'; export type SignedEvidenceUrl = { url: string; exp: number; mode: 'download' | 'preview'; }; function mustGetEnv(name: string, fallback = '') { const v = process.env[name] || fallback; if (!v) throw new Error( Missing env: ${name} ); return v; } function hmacSha256Hex(secret: string, data: string) { return crypto.createHmac('sha256', secret).update(data).digest('hex'); } /** Payload format: evidence_id|exp|mode */ export function signEvidenceUrl( evidence_id: string, mode: 'download' | 'preview' = 'download', expiresInSec = 120 ): SignedEvidenceUrl { const secret = mustGetEnv('STORAGE_SIGNING_SECRET', 'DEV_ONLY_CHANGE_ME'); const exp = Math.floor(Date.now() / 1000) + Math.max(30, expiresInSec); const payload = ${evidence_id}|${exp}|${mode} ; const sig = hmacSha256Hex(secret, payload); const url = /api/storage/blob?evidence_id=${encodeURIComponent(evidence_id)} + &exp=${exp}&mode=${mode}&sig=${sig} ; return { url, exp, mode }; } export function verifyEvidenceSignature( evidence_id: string, exp: number, mode: 'download' | 'preview', sig: string ) { const secret = mustGetEnv('STORAGE_SIGNING_SECRET', 'DEV_ONLY_CHANGE_ME'); const payload = ${evidence_id}|${exp}|${mode} ; const expected = hmacSha256Hex(secret, payload); const a = Buffer.from(expected, 'hex'); const b = Buffer.from(sig || '', 'hex'); if (a.length !== b.length) return false; return crypto.timingSafeEqual(a, b); } [3] API موحد للبث والتنزيل: Blob Proxy مع Range + Custody Audit المسار: app/api/storage/blob/route.ts يدعم: mode=preview ⇒ Content-Disposition: inline + Range للفيديو/الصوت mode=download ⇒ Content-Disposition: attachment يسجّل custodyEvent عند كل عملية: EVIDENCE_PREVIEWED EVIDENCE_DOWNLOADED // app/api/storage/blob/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { verifyEvidenceSignature } from '@/lib/storage'; import crypto from 'crypto'; import fs from 'fs'; import path from 'path'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } function sanitizeFilename(s: string) { return String(s || '').replace(/[^a-zA-Z0-9_\-\.]/g, '_'); } function parseRangeHeader(range: string | null, fileSize: number) { if (!range) return null; // e.g. "bytes=0-1023" const m = /^bytes=(\d+)-(\d+)?$/i.exec(range.trim()); if (!m) return null; const start = Number(m[1]); const end = m[2] ? Number(m[2]) : fileSize - 1; if (!Number.isFinite(start) || !Number.isFinite(end)) return null; if (start < 0 || end < start) return null; if (start >= fileSize) return null; return { start, end: Math.min(end, fileSize - 1) }; } async function streamLocal(absolutePath: string, mime: string, disposition: string, range: string | null) { if (!fs.existsSync(absolutePath)) throw new HttpError(404, 'File not found (local driver)'); const stat = fs.statSync(absolutePath); const size = stat.size; const r = parseRangeHeader(range, size); if (!r) { const stream = fs.createReadStream(absolutePath); return new NextResponse(stream as any, { status: 200, headers: { 'Content-Type': mime || 'application/octet-stream', 'Content-Length': String(size), 'Content-Disposition': disposition, 'Accept-Ranges': 'bytes', }, }); } const chunkSize = r.end - r.start + 1; const stream = fs.createReadStream(absolutePath, { start: r.start, end: r.end }); return new NextResponse(stream as any, { status: 206, headers: { 'Content-Type': mime || 'application/octet-stream', 'Content-Length': String(chunkSize), 'Content-Range': bytes ${r.start}-${r.end}/${size} , 'Content-Disposition': disposition, 'Accept-Ranges': 'bytes', }, }); } async function streamS3(storage_key: string, mime: string, disposition: string, range: string | null) { // Requires: npm i @aws-sdk/client-s3 const bucket = getEnv('STORAGE_S3_BUCKET'); const region = getEnv('STORAGE_S3_REGION', 'auto'); const accessKeyId = getEnv('STORAGE_S3_ACCESS_KEY'); const secretAccessKey = getEnv('STORAGE_S3_SECRET_KEY'); if (!bucket || !accessKeyId || !secretAccessKey) { throw new HttpError(500, 'S3 driver missing env config'); } const endpoint = getEnv('STORAGE_S3_ENDPOINT', ''); const { S3Client, GetObjectCommand, HeadObjectCommand } = await import('@aws-sdk/client-s3'); const client = new S3Client({ region, ...(endpoint ? { endpoint } : {}), credentials: { accessKeyId, secretAccessKey }, }); // If range requested, we do GetObject with Range. if (range) { const cmd = new GetObjectCommand({ Bucket: bucket, Key: storage_key, Range: range, // pass through: "bytes=..." }); code Code download content_copy expand_less const out: any = await client.send(cmd); const bodyStream = out?.Body; if (!bodyStream) throw new HttpError( 404 , 'Object not found in S3' ); const headers: Record< string , string > = { 'Content-Type' : mime || out?.ContentType || 'application/octet-stream' , 'Content-Disposition' : disposition, 'Accept-Ranges' : 'bytes' , }; // S3 includes ContentRange + ContentLength for partial responses if (out?.ContentRange) headers[ 'Content-Range' ] = String (out.ContentRange); if (out?.ContentLength) headers[ 'Content-Length' ] = String (out.ContentLength); return new NextResponse(bodyStream as any , { status : 206 , headers }); } // Full download/preview // We can HEAD first for size (optional) try { await client.send( new HeadObjectCommand({ Bucket: bucket, Key: storage_key, }) ); } catch { // ignore head errors; GetObject will throw if missing } const cmd = new GetObjectCommand({ Bucket: bucket, Key: storage_key, }); const out: any = await client.send(cmd); const bodyStream = out?.Body; if (!bodyStream) throw new HttpError(404, 'Object not found in S3'); return new NextResponse(bodyStream as any, { status: 200, headers: { 'Content-Type': mime || out?.ContentType || 'application/octet-stream', 'Content-Disposition': disposition, 'Accept-Ranges': 'bytes', }, }); } export async function GET(req: NextRequest) { try { const principal = getPrincipal(req); code Code download content_copy expand_less const url = new URL(req.url); const evidence_id = String (url.searchParams.get( 'evidence_id' ) || '' ).trim(); const exp = Number (url.searchParams.get( 'exp' ) || 0 ); const sig = String (url.searchParams.get( 'sig' ) || '' ).trim(); const modeRaw = String (url.searchParams.get( 'mode' ) || 'download' ).trim().toLowerCase(); const mode = (modeRaw === 'preview' ? 'preview' : 'download' ) as 'download' | 'preview' ; if (!evidence_id || !exp || !sig) throw new HttpError( 400 , 'Missing signed params' ); const now = Math .floor( Date .now() / 1000 ); if (exp < now) throw new HttpError( 401 , 'Signed URL expired' ); const ok = verifyEvidenceSignature(evidence_id, exp, mode, sig); if (!ok) throw new HttpError( 401 , 'Invalid signature' ); const ev = await prisma.evidenceItem.findUnique({ where : { evidence_id }, select : { evidence_id : true , family_id : true , incident_id : true , storage_key : true , mime_type : true , evidence_type : true , sha256_hex : true , }, }); if (!ev) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, ev.family_id)) throw new HttpError( 403 , 'Forbidden' ); // Custody log const created_at = new Date (); const last = await prisma.custodyEvent.findFirst({ where : { family_id : ev.family_id, incident_id : ev.incident_id || undefined }, orderBy : { event_at : 'desc' }, select : { hash_hex : true }, }); const prev_hash_hex = last?.hash_hex ?? null ; const event_key = mode === 'preview' ? 'EVIDENCE_PREVIEWED' : 'EVIDENCE_DOWNLOADED' ; const event_json = { evidence_id : ev.evidence_id, incident_id : ev.incident_id, sha256_hex : ev.sha256_hex, mode, user_id : principal.user_id || null , }; const hash_payload = JSON .stringify({ family_id : ev.family_id, incident_id : ev.incident_id, actor : 'PARENT_CONSOLE' , event_key, event_at : created_at.toISOString(), prev_hash_hex, event_json, }); const hash_hex = sha256Hex(hash_payload); await prisma.custodyEvent.create({ data : { family_id : ev.family_id, incident_id : ev.incident_id, actor : 'PARENT_CONSOLE' , event_key, event_at : created_at, event_json, prev_hash_hex, hash_hex, }, select : { custody_id : true }, }); const baseName = sanitizeFilename( ` ${ev.evidence_type} _ ${ev.evidence_id} ` ); const disposition = mode === 'preview' ? `inline; filename=" ${baseName} "` : `attachment; filename=" ${baseName} "` ; const driver = (getEnv( 'STORAGE_DRIVER' , 'local' ) || 'local' ).toLowerCase(); const range = req.headers.get( 'range' ); // Range requests for audio/video preview if (driver === 'local' ) { const baseDir = getEnv( 'STORAGE_LOCAL_DIR' , path.join(process.cwd(), 'storage_local' )); const abs = path.join(baseDir, ev.storage_key); return await streamLocal(abs, ev.mime_type, disposition, range); } if (driver === 's3' || driver === 'r2' ) { return await streamS3(ev.storage_key, ev.mime_type, disposition, range); } throw new HttpError( 500 , 'Unsupported STORAGE_DRIVER' ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [4] تحديث Evidence Vault List API لإرجاع preview_url + download_url المسار: app/api/families/[familyId]/evidence/route.ts استبدل الملف بالكامل بهذه النسخة (تحديث صغير لكنه مهم). // app/api/families/[familyId]/evidence/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { signEvidenceUrl } from '@/lib/storage'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function toInt(v: string | null, fallback: number) { const n = Number(v); if (!Number.isFinite(n) || n <= 0) return fallback; return Math.min(n, 100); } function safeStr(v: string | null) { const s = (v || '').trim(); return s.length ? s : null; } function safeDateISO(v: string | null) { if (!v) return null; const d = new Date(v); if (Number.isNaN(d.getTime())) return null; return d; } export async function GET(req: NextRequest, ctx: { params: { familyId: string } }) { try { const principal = getPrincipal(req); const familyId = ctx.params.familyId; code Code download content_copy expand_less if (!requireFamilyAccess(principal, familyId)) throw new HttpError( 403 , 'Forbidden' ); const url = new URL(req.url); const type = safeStr(url.searchParams.get( 'type' )); const device_id = safeStr(url.searchParams.get( 'device_id' )); const incident_id = safeStr(url.searchParams.get( 'incident_id' )); const q = safeStr(url.searchParams.get( 'q' )); const from = safeDateISO(url.searchParams.get( 'from' )); const to = safeDateISO(url.searchParams.get( 'to' )); const limit = toInt(url.searchParams.get( 'limit' ), 30 ); const cursor = safeStr(url.searchParams.get( 'cursor' )); const where: any = { family_id : familyId, ...( type ? { evidence_type : type } : {}), ...(device_id ? { meta_json : { path : [ 'device_id' ], equals : device_id } } : {}), ...(incident_id ? { incident_id } : {}), ...( from || to ? { captured_at : { ...( from ? { gte : from } : {}), ...(to ? { lte : to } : {}), }, } : {}), ...(q ? { OR : [ { storage_key : { contains : q, mode : 'insensitive' } }, { mime_type : { contains : q, mode : 'insensitive' } }, ], } : {}), ...(cursor ? { evidence_id : { lt : cursor } } : {}), }; const rows = await prisma.evidenceItem.findMany({ where, orderBy : { captured_at : 'desc' }, take : limit + 1 , select : { evidence_id : true , incident_id : true , evidence_type : true , storage_key : true , mime_type : true , size_bytes : true , sha256_hex : true , captured_at : true , meta_json : true , }, }); const hasMore = rows.length > limit; const sliced = hasMore ? rows.slice( 0 , limit) : rows; const next_cursor = hasMore ? sliced[sliced.length - 1 ]?.evidence_id ?? null : null ; const items = sliced.map( ( e ) => { const download = signEvidenceUrl(e.evidence_id, 'download' , 120 ); const preview = signEvidenceUrl(e.evidence_id, 'preview' , 120 ); return { ...e, captured_at : e.captured_at.toISOString(), download_url : download.url, download_exp : download.exp, preview_url : preview.url, preview_exp : preview.exp, }; }); return NextResponse.json({ ok : true , items, next_cursor }, { status : 200 }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [5] UI: Hash Verifier (Verify SHA-256 محليًا) المسار: components/parent/HashVerifier.tsx المستخدم يرفع الملف من جهازه يتم حساب SHA-256 داخل المتصفح يتم مقارنة النتيجة مع Hash المخزن داخل Evidence يعرض Result: MATCH / MISMATCH // components/parent/HashVerifier.tsx 'use client'; import React, { useMemo, useState } from 'react'; async function sha256FileHex(file: File): Promise <string> { const buf = await file.arrayBuffer(); const digest = await crypto.subtle.digest('SHA-256', buf); const bytes = new Uint8Array(digest); return Array.from(bytes) .map((b) => b.toString(16).padStart(2, '0')) .join(''); } function classJoin(...xs: Array<string | false | null | undefined>) { return xs.filter(Boolean).join(' '); } export default function HashVerifier({ expectedSha256, }: { expectedSha256: string; }) { const [picked, setPicked] = useState<File | null>(null); const [computed, setComputed] = useState <string> (''); const [status, setStatus] = useState<'idle' | 'hashing' | 'match' | 'mismatch' | 'error'>('idle'); const [err, setErr] = useState <string> (''); const normalizedExpected = useMemo(() => (expectedSha256 || '').trim().toLowerCase(), [expectedSha256]); async function onPick(file: File | null) { setPicked(file); setComputed(''); setErr(''); setStatus('idle'); code Code download content_copy expand_less if (!file) return ; try { setStatus( 'hashing' ); const h = await sha256FileHex(file); setComputed(h); if (h === normalizedExpected) setStatus( 'match' ); else setStatus( 'mismatch' ); } catch (e: any ) { setStatus( 'error' ); setErr(e?.message || 'Hashing failed' ); } } return ( <div className="rounded-2xl border border-gray-200 bg-white p-4"> <div className="text-sm font-semibold text-gray-900"> Verify Integrity (SHA-256) </div> <div className="mt-1 text-xs text-gray-600"> Upload the downloaded file to verify it matches the stored evidence hash. </div> code Code download content_copy expand_less < div className = "mt-3" > < input type = "file" className = "block w-full text-sm text-gray-700 file:mr-3 file:rounded-xl file:border file:border-gray-200 file:bg-white file:px-3 file:py-2 file:text-sm file:font-semibold file:text-gray-900 hover:file:bg-gray-50" onChange = {(e) => onPick(e.target.files?.[0] || null)} /> </ div > < div className = "mt-3" > < div className = "text-xs font-semibold text-gray-700" > Expected SHA-256 </ div > < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {normalizedExpected} </ div > </ div > < div className = "mt-3" > < div className = "text-xs font-semibold text-gray-700" > Computed SHA-256 </ div > < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {computed || '—'} </ div > </ div > < div className = "mt-3" > < div className = {classJoin( ' rounded-xl border px-3 py-2 text-sm ', status === 'hashing' && ' border-gray-200 bg-gray-50 text-gray-800 ', status === 'match' && ' border-green-200 bg-green-50 text-green-700 ', status === 'mismatch' && ' border-red-200 bg-red-50 text-red-700 ', status === 'error' && ' border-red-200 bg-red-50 text-red-700 ', status === 'idle' && ' border-gray-200 bg-white text-gray-600 ' )} > {status === 'idle' && 'Pick a file to verify.'} {status === 'hashing' && 'Hashing file...'} {status === 'match' && 'MATCH: File integrity verified.'} {status === 'mismatch' && 'MISMATCH: File does NOT match stored hash.'} {status === 'error' && `ERROR: ${err}`} </ div > </ div > < div className = "mt-2 text-xs text-gray-500" > Selected: < span className = "font-mono" > {picked?.name || 'None'} </ span > </ div > </ div > ); } [6] UI: Evidence Vault Table مع Preview حقيقي للصورة/الصوت/الفيديو + Hash Verifier المسار: components/parent/EvidenceVaultTable.tsx استبدل الملف بالكامل بهذا الإصدار. // components/parent/EvidenceVaultTable.tsx 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import HashVerifier from '@/components/parent/HashVerifier'; type EvidenceRow = { evidence_id: string; incident_id: string | null; evidence_type: string; storage_key: string; mime_type: string; size_bytes: number; sha256_hex: string; captured_at: string; download_url: string; download_exp: number; preview_url: string; preview_exp: number; }; type ApiResp = { ok: boolean; items: EvidenceRow[]; next_cursor: string | null; }; function shortId(id: string) { if (!id) return ''; if (id.length <= 14) return id; return id.slice(0, 12) + '...'; } function bytes(n: number) { if (!Number.isFinite(n) || n <= 0) return '0 B'; const units = ['B', 'KB', 'MB', 'GB']; let x = n; let u = 0; while (x >= 1024 && u < units.length - 1) { x /= 1024; u++; } return ${x.toFixed(u === 0 ? 0 : 1)} ${units[u]} ; } function buildUrl(base: string, params: Record<string, string | number | null | undefined>) { const u = new URL(base, ' http://localhost '); Object.entries(params).forEach(([k, v]) => { if (v === undefined || v === null || String(v).trim() === '') return; u.searchParams.set(k, String(v)); }); return u.pathname + '?' + u.searchParams.toString(); } function canInlinePreview(mime: string) { if (!mime) return false; const m = mime.toLowerCase(); return m.startsWith('image/') || m.startsWith('audio/') || m.startsWith('video/'); } function inlineKind(mime: string): 'image' | 'audio' | 'video' | 'unknown' { const m = (mime || '').toLowerCase(); if (m.startsWith('image/')) return 'image'; if (m.startsWith('audio/')) return 'audio'; if (m.startsWith('video/')) return 'video'; return 'unknown'; } export default function EvidenceVaultTable({ familyId }: { familyId: string }) { const baseEndpoint = useMemo(() => { return /api/families/${encodeURIComponent(familyId)}/evidence ; }, [familyId]); const [items, setItems] = useState<EvidenceRow[]>([]); const [nextCursor, setNextCursor] = useState<string | null>(null); const [loading, setLoading] = useState(true); const [loadingMore, setLoadingMore] = useState(false); const [err, setErr] = useState(''); const [type, setType] = useState(''); const [deviceId, setDeviceId] = useState(''); const [incidentId, setIncidentId] = useState(''); const [from, setFrom] = useState(''); const [to, setTo] = useState(''); const [q, setQ] = useState(''); const [preview, setPreview] = useState<{ open: boolean; row: EvidenceRow | null }>({ open: false, row: null, }); async function loadFirstPage() { setLoading(true); setErr(''); try { const url = buildUrl(baseEndpoint, { limit: 30, type: type || null, device_id: deviceId || null, incident_id: incidentId || null, from: from || null, to: to || null, q: q || null, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiResp; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load evidence' ); } setItems(json.items || []); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); setItems([]); setNextCursor( null ); } finally { setLoading( false ); } } async function loadMore() { if (!nextCursor) return; setLoadingMore(true); setErr(''); try { const url = buildUrl(baseEndpoint, { limit: 30, cursor: nextCursor, type: type || null, device_id: deviceId || null, incident_id: incidentId || null, from: from || null, to: to || null, q: q || null, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiResp; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load more evidence' ); } setItems( ( prev ) => [...prev, ...(json.items || [])]); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); } finally { setLoadingMore( false ); } } useEffect(() => { loadFirstPage(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [baseEndpoint]); function openPreview(row: EvidenceRow) { setPreview({ open: true, row }); } function closePreview() { setPreview({ open: false, row: null }); } const previewRow = preview.row; const kind = previewRow ? inlineKind(previewRow.mime_type) : 'unknown'; const showInline = previewRow ? canInlinePreview(previewRow.mime_type) : false; return ( <div className="p-6"> <div className="flex flex-col gap-2"> <h1 className="text-xl font-semibold text-gray-900"> Evidence Vault </h1> <p className="text-sm text-gray-600"> Central evidence store for the family across all incidents. </p> </div> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Filters </ div > < div className = "mt-3 grid grid-cols-1 gap-3 md:grid-cols-6" > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Type </ label > < select className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {type} onChange = {(e) => setType(e.target.value)} > < option value = "" > All </ option > < option value = "SCREENSHOT" > SCREENSHOT </ option > < option value = "AUDIO" > AUDIO </ option > < option value = "VIDEO" > VIDEO </ option > < option value = "TEXT_SNAPSHOT" > TEXT_SNAPSHOT </ option > < option value = "CAMERA_STREAM_FRAME" > CAMERA_STREAM_FRAME </ option > </ select > </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Device ID </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "dev_..." value = {deviceId} onChange = {(e) => setDeviceId(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Incident ID </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "inc_..." value = {incidentId} onChange = {(e) => setIncidentId(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > From </ label > < input type = "date" className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {from} onChange = {(e) => setFrom(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > To </ label > < input type = "date" className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {to} onChange = {(e) => setTo(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Search </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "storage key / mime..." value = {q} onChange = {(e) => setQ(e.target.value)} /> </ div > </ div > < div className = "mt-4 flex flex-wrap gap-2" > < button className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black disabled:opacity-60" onClick = {loadFirstPage} disabled = {loading} > {loading ? 'Loading...' : 'Apply Filters'} </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => { setType(''); setDeviceId(''); setIncidentId(''); setFrom(''); setTo(''); setQ(''); }} > Reset </ button > </ div > {err ? ( < div className = "mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > ) : null} </ div > < div className = "mt-5 rounded-2xl border border-gray-200 bg-white shadow-sm" > < div className = "w-full overflow-x-auto" > < table className = "min-w-full border-separate border-spacing-0" > < thead > < tr className = "bg-gray-50" > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Evidence </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Type </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Captured </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Size </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Hash </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Actions </ th > </ tr > </ thead > < tbody > {loading ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > Loading evidence... </ td > </ tr > ) : items.length === 0 ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > No evidence found. </ td > </ tr > ) : ( items.map((x) => ( < tr key = {x.evidence_id} className = "hover:bg-gray-50" > < td className = "border-b border-gray-200 px-4 py-3" > < div className = "text-sm font-semibold text-gray-900" > {shortId(x.evidence_id)} </ div > < div className = "mt-1 font-mono text-[11px] text-gray-600 break-all" > {x.storage_key} </ div > < div className = "mt-1 text-[11px] text-gray-500" > Incident:{' '} < span className = "font-mono" > {x.incident_id ? shortId(x.incident_id) : 'N/A'} </ span > </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > < div className = "font-semibold" > {x.evidence_type} </ div > < div className = "mt-1 text-[11px] text-gray-500" > {x.mime_type} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {new Date(x.captured_at).toLocaleString()} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {bytes(x.size_bytes)} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-xs text-gray-700" > < div className = "break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {x.sha256_hex} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3" > < div className = "flex flex-wrap gap-2" > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => openPreview(x)} > Preview </ button > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {x.download_url} > Download </ a > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(x.sha256_hex)} > Copy Hash </ button > </ div > </ td > </ tr > )) )} </ tbody > </ table > < div className = "flex items-center justify-between px-4 py-4" > < div className = "text-xs text-gray-500" > Loaded: {items.length} </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50 disabled:opacity-50" onClick = {loadMore} disabled = {!nextCursor || loadingMore } > {loadingMore ? 'Loading...' : nextCursor ? 'Load more' : 'No more'} </ button > </ div > </ div > </ div > {preview.open && previewRow ? ( < div className = "fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4" > < div className = "w-full max-w-4xl rounded-2xl border border-gray-200 bg-white shadow-xl" > < div className = "flex items-start justify-between gap-4 border-b border-gray-200 p-4" > < div > < div className = "text-base font-semibold text-gray-900" > Evidence Preview </ div > < div className = "mt-1 text-xs text-gray-600 break-all" > {previewRow.storage_key} </ div > </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {closePreview} > Close </ button > </ div > < div className = "p-4" > < div className = "grid grid-cols-1 gap-4 md:grid-cols-2" > < div className = "rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-xs text-gray-600" > Type: < span className = "font-semibold text-gray-900" > {previewRow.evidence_type} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > MIME: < span className = "font-mono text-gray-900" > {previewRow.mime_type} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > SHA-256: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {previewRow.sha256_hex} </ div > </ div > < div className = "mt-4 flex flex-wrap gap-2" > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {previewRow.download_url} > Download </ a > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(previewRow.sha256_hex)} > Copy Hash </ button > </ div > </ div > < div className = "rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Inline Preview </ div > < div className = "mt-2 text-xs text-gray-600" > Preview uses a signed inline stream (supports video/audio range). </ div > < div className = "mt-3 rounded-2xl border border-gray-200 bg-gray-50 p-3" > {!showInline ? ( < div className = "text-sm text-gray-700" > Inline preview not supported for this MIME type. </ div > ) : kind === 'image' ? ( // eslint-disable-next-line @next/next/no-img-element < img src = {previewRow.preview_url} alt = "evidence preview" className = "h-auto w-full rounded-xl border border-gray-200 bg-white" /> ) : kind === 'audio' ? ( < audio controls className = "w-full" preload = "metadata" src = {previewRow.preview_url} /> ) : kind === 'video' ? ( < video controls className = "w-full rounded-xl border border-gray-200 bg-black" preload = "metadata" src = {previewRow.preview_url} /> ) : ( < div className = "text-sm text-gray-700" > Unsupported preview type. </ div > )} </ div > </ div > </ div > < div className = "mt-4" > < HashVerifier expectedSha256 = {previewRow.sha256_hex} /> </ div > < div className = "mt-3 text-xs text-gray-500" > Note: Preview and download are both signed and audited (custody chain). </ div > </ div > </ div > </ div > ) : null} </ div > ); } [7] ربط صفحة Evidence Vault (لا تغيير كبير) المسار: app/(parent)/families/[familyId]/vault/page.tsx // app/(parent)/families/[familyId]/vault/page.tsx 'use client'; import React from 'react'; import EvidenceVaultTable from '@/components/parent/EvidenceVaultTable'; export default function EvidenceVaultPage({ params }: { params: { familyId: string } }) { return <EvidenceVaultTable familyId={params.familyId} /> ; } [8] ماذا حققنا الآن فعليًا؟ المنظومة صارت “مؤسسية جنائية” لأن: Preview Streaming آمن وموقّع وقصير العمر Range Requests تجعل تشغيل الفيديو/الصوت فوري بدون تحميل كامل Custody Chain يسجل: من شاهد الدليل (Preview) من نزّل الدليل (Download) Local Hash Verification يمنع أي تشكيك في سلامة الدليل عند التسليم للسلطات [9] Suggested Next Steps [9.1] تنفيذ Rate Limiting على /api/storage/blob (لكل User + Family) لمنع إساءة الاستخدام. [9.2] إضافة Watermark Overlay للصورة داخل الـ Preview فقط (بدون تغيير الملف الأصلي) لتقليل التسريب. [9.3] تنفيذ Evidence Package ZIP Generator (Manifest + PDF Custody Report + Evidence Files) مع رقم قضية داخلي.
[157] [1] ## تمام — الآن نكمّل Evidence Vault ليصبح “منصة أدلة رقمية مؤسسية” بثلاث ترقيات إنتاجية حاسمة سننفّذ 3 إضافات قوية (Enterprise-grade) فوق ما عندك الآن: Rate Limiting على مسار الأدلة /api/storage/blob (منع إساءة الاستخدام + حماية ضد scraping) Watermark ديناميكي على الـ Preview للصور فقط (بدون تعديل الملف الأصلي) Evidence Package Generator (ZIP) يحتوي: manifest.json custody_report.pdf كل ملفات الأدلة (حسب الفلترة) مع Audit Events على مستوى الحزمة كل الأكواد أدناه “ملفات كاملة” جاهزة للنسخ. [2] Rate Limiting مؤسسي (Redis اختياري + Memory fallback) [2.1] ملف: lib/rateLimit.ts إن توفر Redis يتم استخدامه (أفضل إنتاجيًا) إن لم يتوفر يعمل Memory Token Bucket (للتطوير فقط) // lib/rateLimit.ts import crypto from 'crypto'; type RateLimitResult = { ok: boolean; remaining: number; resetSec: number; }; function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } function stableKey(input: string) { return crypto.createHash('sha256').update(input).digest('hex').slice(0, 24); } /** Recommended defaults: Preview: 60 requests/min per user/family Download: 20 requests/min per user/family */ export type RateLimitConfig = { limit: number; // max requests windowSec: number; // time window prefix: string; // key namespace }; type BucketState = { count: number; windowStart: number }; // Memory fallback (DEV ONLY) const mem = new Map<string, BucketState>(); async function memoryLimit(key: string, cfg: RateLimitConfig): Promise <RateLimitResult> { const now = Math.floor(Date.now() / 1000); const bucket = mem.get(key); if (!bucket || now - bucket.windowStart >= cfg.windowSec) { mem.set(key, { count: 1, windowStart: now }); return { ok: true, remaining: cfg.limit - 1, resetSec: cfg.windowSec }; } const count = bucket.count + 1; bucket.count = count; mem.set(key, bucket); const remaining = Math.max(0, cfg.limit - count); const resetSec = Math.max(1, cfg.windowSec - (now - bucket.windowStart)); return { ok: count <= cfg.limit, remaining, resetSec }; } async function redisLimit(key: string, cfg: RateLimitConfig): Promise <RateLimitResult> { // Requires: npm i redis const redisUrl = getEnv('RATE_LIMIT_REDIS_URL'); if (!redisUrl) return memoryLimit(key, cfg); const { createClient } = await import('redis'); const client = createClient({ url: redisUrl }); // Important: connect per request is okay early-stage; for prod pool/reuse a singleton. await client.connect(); try { const now = Math.floor(Date.now() / 1000); const windowKey = ${cfg.prefix}:${key}:${Math.floor(now / cfg.windowSec)} ; const count = await client.incr(windowKey); code Code download content_copy expand_less if (count === 1 ) { await client.expire(windowKey, cfg.windowSec); } const remaining = Math .max( 0 , cfg.limit - Number (count)); const resetSec = cfg.windowSec - (now % cfg.windowSec); return { ok : Number (count) <= cfg.limit, remaining, resetSec }; } finally { await client.disconnect(); } } export async function rateLimit( rawKey: string, cfg: RateLimitConfig ): Promise <RateLimitResult> { const key = stableKey(rawKey); const mode = (getEnv('RATE_LIMIT_DRIVER', 'auto') || 'auto').toLowerCase(); if (mode === 'redis') return redisLimit(key, cfg); if (mode === 'memory') return memoryLimit(key, cfg); // auto: use redis if env exists else memory const hasRedis = Boolean(getEnv('RATE_LIMIT_REDIS_URL')); return hasRedis ? redisLimit(key, cfg) : memoryLimit(key, cfg); } [3] تطبيق Rate Limit داخل /api/storage/blob (Preview/Download) [3.1] استبدال ملف: app/api/storage/blob/route.ts التغيير الأساسي: قبل تنزيل/عرض الدليل، نطبق Rate Limit وفقًا لـ mode. // app/api/storage/blob/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { verifyEvidenceSignature } from '@/lib/storage'; import { rateLimit } from '@/lib/rateLimit'; import crypto from 'crypto'; import fs from 'fs'; import path from 'path'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } function sanitizeFilename(s: string) { return String(s || '').replace(/[^a-zA-Z0-9_\-\.]/g, '_'); } function parseRangeHeader(range: string | null, fileSize: number) { if (!range) return null; const m = /^bytes=(\d+)-(\d+)?$/i.exec(range.trim()); if (!m) return null; const start = Number(m[1]); const end = m[2] ? Number(m[2]) : fileSize - 1; if (!Number.isFinite(start) || !Number.isFinite(end)) return null; if (start < 0 || end < start) return null; if (start >= fileSize) return null; return { start, end: Math.min(end, fileSize - 1) }; } async function streamLocal(absolutePath: string, mime: string, disposition: string, range: string | null) { if (!fs.existsSync(absolutePath)) throw new HttpError(404, 'File not found (local driver)'); const stat = fs.statSync(absolutePath); const size = stat.size; const r = parseRangeHeader(range, size); if (!r) { const stream = fs.createReadStream(absolutePath); return new NextResponse(stream as any, { status: 200, headers: { 'Content-Type': mime || 'application/octet-stream', 'Content-Length': String(size), 'Content-Disposition': disposition, 'Accept-Ranges': 'bytes', }, }); } const chunkSize = r.end - r.start + 1; const stream = fs.createReadStream(absolutePath, { start: r.start, end: r.end }); return new NextResponse(stream as any, { status: 206, headers: { 'Content-Type': mime || 'application/octet-stream', 'Content-Length': String(chunkSize), 'Content-Range': bytes ${r.start}-${r.end}/${size} , 'Content-Disposition': disposition, 'Accept-Ranges': 'bytes', }, }); } async function streamS3(storage_key: string, mime: string, disposition: string, range: string | null) { const bucket = getEnv('STORAGE_S3_BUCKET'); const region = getEnv('STORAGE_S3_REGION', 'auto'); const accessKeyId = getEnv('STORAGE_S3_ACCESS_KEY'); const secretAccessKey = getEnv('STORAGE_S3_SECRET_KEY'); if (!bucket || !accessKeyId || !secretAccessKey) { throw new HttpError(500, 'S3 driver missing env config'); } const endpoint = getEnv('STORAGE_S3_ENDPOINT', ''); const { S3Client, GetObjectCommand, HeadObjectCommand } = await import('@aws-sdk/client-s3'); const client = new S3Client({ region, ...(endpoint ? { endpoint } : {}), credentials: { accessKeyId, secretAccessKey }, }); if (range) { const cmd = new GetObjectCommand({ Bucket: bucket, Key: storage_key, Range: range, }); code Code download content_copy expand_less const out: any = await client.send(cmd); const bodyStream = out?.Body; if (!bodyStream) throw new HttpError( 404 , 'Object not found in S3' ); const headers: Record< string , string > = { 'Content-Type' : mime || out?.ContentType || 'application/octet-stream' , 'Content-Disposition' : disposition, 'Accept-Ranges' : 'bytes' , }; if (out?.ContentRange) headers[ 'Content-Range' ] = String (out.ContentRange); if (out?.ContentLength) headers[ 'Content-Length' ] = String (out.ContentLength); return new NextResponse(bodyStream as any , { status : 206 , headers }); } try { await client.send( new HeadObjectCommand({ Bucket: bucket, Key: storage_key, }) ); } catch { // ignore } const cmd = new GetObjectCommand({ Bucket: bucket, Key: storage_key, }); const out: any = await client.send(cmd); const bodyStream = out?.Body; if (!bodyStream) throw new HttpError(404, 'Object not found in S3'); return new NextResponse(bodyStream as any, { status: 200, headers: { 'Content-Type': mime || out?.ContentType || 'application/octet-stream', 'Content-Disposition': disposition, 'Accept-Ranges': 'bytes', }, }); } export async function GET(req: NextRequest) { try { const principal = getPrincipal(req); code Code download content_copy expand_less const url = new URL(req.url); const evidence_id = String (url.searchParams.get( 'evidence_id' ) || '' ).trim(); const exp = Number (url.searchParams.get( 'exp' ) || 0 ); const sig = String (url.searchParams.get( 'sig' ) || '' ).trim(); const modeRaw = String (url.searchParams.get( 'mode' ) || 'download' ).trim().toLowerCase(); const mode = (modeRaw === 'preview' ? 'preview' : 'download' ) as 'download' | 'preview' ; if (!evidence_id || !exp || !sig) throw new HttpError( 400 , 'Missing signed params' ); const now = Math .floor( Date .now() / 1000 ); if (exp < now) throw new HttpError( 401 , 'Signed URL expired' ); const okSig = verifyEvidenceSignature(evidence_id, exp, mode, sig); if (!okSig) throw new HttpError( 401 , 'Invalid signature' ); const ev = await prisma.evidenceItem.findUnique({ where : { evidence_id }, select : { evidence_id : true , family_id : true , incident_id : true , storage_key : true , mime_type : true , evidence_type : true , sha256_hex : true , }, }); if (!ev) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, ev.family_id)) throw new HttpError( 403 , 'Forbidden' ); // Rate limit (user+family+mode) const userKey = principal.user_id || principal.session_id || 'anonymous' ; const rl = await rateLimit( ` ${userKey} | ${ev.family_id} | ${mode} ` , { prefix : 'evidence_blob' , windowSec : 60 , limit : mode === 'preview' ? 60 : 20 , }); if (!rl.ok) { return NextResponse.json( { error : { status : 429 , message : 'Too many requests (rate limited).' , remaining : rl.remaining, resetSec : rl.resetSec, }, }, { status : 429 , headers : { 'X-RateLimit-Remaining' : String (rl.remaining), 'X-RateLimit-Reset' : String (rl.resetSec), }, } ); } // Custody log const created_at = new Date (); const last = await prisma.custodyEvent.findFirst({ where : { family_id : ev.family_id, incident_id : ev.incident_id || undefined }, orderBy : { event_at : 'desc' }, select : { hash_hex : true }, }); const prev_hash_hex = last?.hash_hex ?? null ; const event_key = mode === 'preview' ? 'EVIDENCE_PREVIEWED' : 'EVIDENCE_DOWNLOADED' ; const event_json = { evidence_id : ev.evidence_id, incident_id : ev.incident_id, sha256_hex : ev.sha256_hex, mode, user_id : principal.user_id || null , }; const hash_payload = JSON .stringify({ family_id : ev.family_id, incident_id : ev.incident_id, actor : 'PARENT_CONSOLE' , event_key, event_at : created_at.toISOString(), prev_hash_hex, event_json, }); const hash_hex = sha256Hex(hash_payload); await prisma.custodyEvent.create({ data : { family_id : ev.family_id, incident_id : ev.incident_id, actor : 'PARENT_CONSOLE' , event_key, event_at : created_at, event_json, prev_hash_hex, hash_hex, }, select : { custody_id : true }, }); const baseName = sanitizeFilename( ` ${ev.evidence_type} _ ${ev.evidence_id} ` ); const disposition = mode === 'preview' ? `inline; filename=" ${baseName} "` : `attachment; filename=" ${baseName} "` ; const driver = (getEnv( 'STORAGE_DRIVER' , 'local' ) || 'local' ).toLowerCase(); const range = req.headers.get( 'range' ); if (driver === 'local' ) { const baseDir = getEnv( 'STORAGE_LOCAL_DIR' , path.join(process.cwd(), 'storage_local' )); const abs = path.join(baseDir, ev.storage_key); return await streamLocal(abs, ev.mime_type, disposition, range); } if (driver === 's3' || driver === 'r2' ) { return await streamS3(ev.storage_key, ev.mime_type, disposition, range); } throw new HttpError( 500 , 'Unsupported STORAGE_DRIVER' ); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [4] Watermark للصور في Preview فقط (بدون تغيير الدليل الأصلي) [4.1] لماذا Watermark؟ لمنع التسريب الداخلي، مع الحفاظ على سلامة الدليل الأصلي (لا تعديل على الملف). Preview للصور يصبح من endpoint خاص: /api/storage/preview-image يعرض الصورة مع watermark خفيف + Family ID + timestamp ويُسجل Custody event: EVIDENCE_WATERMARKED_PREVIEW [4.2] ملف: app/api/storage/preview-image/route.ts يتطلب sharp: npm i sharp // app/api/storage/preview-image/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { verifyEvidenceSignature } from '@/lib/storage'; import crypto from 'crypto'; import fs from 'fs'; import path from 'path'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } async function loadLocalBuffer(storage_key: string) { const baseDir = getEnv('STORAGE_LOCAL_DIR', path.join(process.cwd(), 'storage_local')); const abs = path.join(baseDir, storage_key); if (!fs.existsSync(abs)) throw new HttpError(404, 'File not found (local driver)'); return fs.readFileSync(abs); } async function loadS3Buffer(storage_key: string) { const bucket = getEnv('STORAGE_S3_BUCKET'); const region = getEnv('STORAGE_S3_REGION', 'auto'); const accessKeyId = getEnv('STORAGE_S3_ACCESS_KEY'); const secretAccessKey = getEnv('STORAGE_S3_SECRET_KEY'); const endpoint = getEnv('STORAGE_S3_ENDPOINT', ''); if (!bucket || !accessKeyId || !secretAccessKey) { throw new HttpError(500, 'S3 driver missing env config'); } const { S3Client, GetObjectCommand } = await import('@aws-sdk/client-s3'); const client = new S3Client({ region, ...(endpoint ? { endpoint } : {}), credentials: { accessKeyId, secretAccessKey }, }); const out: any = await client.send( new GetObjectCommand({ Bucket: bucket, Key: storage_key, }) ); const body = out?.Body; if (!body) throw new HttpError(404, 'Object not found in S3'); const chunks: Buffer[] = []; for await (const chunk of body as any) { chunks.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk)); } return Buffer.concat(chunks); } function watermarkSvg(text1: string, text2: string) { const safe1 = text1.replace(/[<>&"]/g, ''); const safe2 = text2.replace(/[<>&"]/g, ''); // Watermark overlay: repeated diagonal pattern return Buffer.from( <svg width="1200" height="900" xmlns="http://www.w3.org/2000/svg"> <defs> <pattern id="p" width="420" height="220" patternUnits="userSpaceOnUse" patternTransform="rotate(-25)"> <text x="0" y="90" font-size="26" fill="rgba(0,0,0,0.10)" font-family="Arial, sans-serif">${safe1}</text> <text x="0" y="135" font-size="16" fill="rgba(0,0,0,0.10)" font-family="Arial, sans-serif">${safe2}</text> </pattern> </defs> <rect width="1200" height="900" fill="url(#p)"/> </svg> ); } export async function GET(req: NextRequest) { try { const principal = getPrincipal(req); code Code download content_copy expand_less const url = new URL(req.url); const evidence_id = String (url.searchParams.get( 'evidence_id' ) || '' ).trim(); const exp = Number (url.searchParams.get( 'exp' ) || 0 ); const sig = String (url.searchParams.get( 'sig' ) || '' ).trim(); // IMPORTANT: this endpoint is strictly "preview" const mode = 'preview' ; if (!evidence_id || !exp || !sig) throw new HttpError( 400 , 'Missing signed params' ); const now = Math .floor( Date .now() / 1000 ); if (exp < now) throw new HttpError( 401 , 'Signed URL expired' ); const okSig = verifyEvidenceSignature(evidence_id, exp, mode, sig); if (!okSig) throw new HttpError( 401 , 'Invalid signature' ); const ev = await prisma.evidenceItem.findUnique({ where : { evidence_id }, select : { evidence_id : true , family_id : true , incident_id : true , storage_key : true , mime_type : true , sha256_hex : true , }, }); if (!ev) throw new HttpError( 404 , 'Evidence not found' ); if (!requireFamilyAccess(principal, ev.family_id)) throw new HttpError( 403 , 'Forbidden' ); if (! String (ev.mime_type || '' ).toLowerCase().startsWith( 'image/' )) { throw new HttpError( 415 , 'This endpoint is for image preview only' ); } const driver = (getEnv( 'STORAGE_DRIVER' , 'local' ) || 'local' ).toLowerCase(); const buf = driver === 's3' || driver === 'r2' ? await loadS3Buffer(ev.storage_key) : await loadLocalBuffer(ev.storage_key); // Apply watermark via sharp const sharp = ( await import ( 'sharp' )).default; const wm1 = `AMANA PREVIEW • FAMILY ${ev.family_id} ` ; const wm2 = `EVIDENCE ${ev.evidence_id} • ${ new Date ().toISOString()} ` ; const overlay = watermarkSvg(wm1, wm2); const out = await sharp(buf) .resize({ width : 1400 , withoutEnlargement : true }) // safe preview size .composite([{ input : overlay, blend : 'over' , gravity : 'center' }]) .jpeg({ quality : 88 }) .toBuffer(); // Custody log: watermark preview const created_at = new Date (); const last = await prisma.custodyEvent.findFirst({ where : { family_id : ev.family_id, incident_id : ev.incident_id || undefined }, orderBy : { event_at : 'desc' }, select : { hash_hex : true }, }); const prev_hash_hex = last?.hash_hex ?? null ; const event_json = { evidence_id : ev.evidence_id, incident_id : ev.incident_id, sha256_hex : ev.sha256_hex, user_id : principal.user_id || null , note : 'Watermarked image preview served (original unchanged)' , }; const hash_payload = JSON .stringify({ family_id : ev.family_id, incident_id : ev.incident_id, actor : 'PARENT_CONSOLE' , event_key : 'EVIDENCE_WATERMARKED_PREVIEW' , event_at : created_at.toISOString(), prev_hash_hex, event_json, }); const hash_hex = sha256Hex(hash_payload); await prisma.custodyEvent.create({ data : { family_id : ev.family_id, incident_id : ev.incident_id, actor : 'PARENT_CONSOLE' , event_key : 'EVIDENCE_WATERMARKED_PREVIEW' , event_at : created_at, event_json, prev_hash_hex, hash_hex, }, }); return new NextResponse(out as any , { status : 200 , headers : { 'Content-Type' : 'image/jpeg' , 'Cache-Control' : 'no-store' , 'Content-Disposition' : `inline; filename="preview_ ${ev.evidence_id} .jpg"` , }, }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [5] تعديل UI: استخدام Watermark Preview للصور فقط [5.1] ملف: components/parent/EvidenceVaultTable.tsx التغيير داخل الـ modal preview: لو MIME image → نعرض preview_image_url غير ذلك (audio/video) → نعرض preview_url العادي [5.1.1] استبدال ملف EvidenceVaultTable بالكامل بهذه النسخة هذه النسخة تفترض أن API evidence يرجع: preview_url للبث العام (audio/video/image غير watermark) وسننشئ preview_image_url مشتقًا من preview_url بتحويل المسار إلى /api/storage/preview-image // components/parent/EvidenceVaultTable.tsx 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import HashVerifier from '@/components/parent/HashVerifier'; type EvidenceRow = { evidence_id: string; incident_id: string | null; evidence_type: string; storage_key: string; mime_type: string; size_bytes: number; sha256_hex: string; captured_at: string; download_url: string; download_exp: number; preview_url: string; preview_exp: number; }; type ApiResp = { ok: boolean; items: EvidenceRow[]; next_cursor: string | null; }; function shortId(id: string) { if (!id) return ''; if (id.length <= 14) return id; return id.slice(0, 12) + '...'; } function bytes(n: number) { if (!Number.isFinite(n) || n <= 0) return '0 B'; const units = ['B', 'KB', 'MB', 'GB']; let x = n; let u = 0; while (x >= 1024 && u < units.length - 1) { x /= 1024; u++; } return ${x.toFixed(u === 0 ? 0 : 1)} ${units[u]} ; } function buildUrl(base: string, params: Record<string, string | number | null | undefined>) { const u = new URL(base, ' http://localhost '); Object.entries(params).forEach(([k, v]) => { if (v === undefined || v === null || String(v).trim() === '') return; u.searchParams.set(k, String(v)); }); return u.pathname + '?' + u.searchParams.toString(); } function inlineKind(mime: string): 'image' | 'audio' | 'video' | 'unknown' { const m = (mime || '').toLowerCase(); if (m.startsWith('image/')) return 'image'; if (m.startsWith('audio/')) return 'audio'; if (m.startsWith('video/')) return 'video'; return 'unknown'; } function toWatermarkPreviewUrl(preview_url: string) { // preview_url format: // /api/storage/blob?evidence_id=...&exp=...&mode=preview&sig=... // we keep the same signed params but route to preview-image endpoint if (!preview_url) return preview_url; return preview_url.replace('/api/storage/blob', '/api/storage/preview-image'); } export default function EvidenceVaultTable({ familyId }: { familyId: string }) { const baseEndpoint = useMemo(() => { return /api/families/${encodeURIComponent(familyId)}/evidence ; }, [familyId]); const [items, setItems] = useState<EvidenceRow[]>([]); const [nextCursor, setNextCursor] = useState<string | null>(null); const [loading, setLoading] = useState(true); const [loadingMore, setLoadingMore] = useState(false); const [err, setErr] = useState(''); const [type, setType] = useState(''); const [deviceId, setDeviceId] = useState(''); const [incidentId, setIncidentId] = useState(''); const [from, setFrom] = useState(''); const [to, setTo] = useState(''); const [q, setQ] = useState(''); const [preview, setPreview] = useState<{ open: boolean; row: EvidenceRow | null }>({ open: false, row: null, }); async function loadFirstPage() { setLoading(true); setErr(''); try { const url = buildUrl(baseEndpoint, { limit: 30, type: type || null, device_id: deviceId || null, incident_id: incidentId || null, from: from || null, to: to || null, q: q || null, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiResp; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load evidence' ); } setItems(json.items || []); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); setItems([]); setNextCursor( null ); } finally { setLoading( false ); } } async function loadMore() { if (!nextCursor) return; setLoadingMore(true); setErr(''); try { const url = buildUrl(baseEndpoint, { limit: 30, cursor: nextCursor, type: type || null, device_id: deviceId || null, incident_id: incidentId || null, from: from || null, to: to || null, q: q || null, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiResp; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load more evidence' ); } setItems( ( prev ) => [...prev, ...(json.items || [])]); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); } finally { setLoadingMore( false ); } } useEffect(() => { loadFirstPage(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [baseEndpoint]); function openPreview(row: EvidenceRow) { setPreview({ open: true, row }); } function closePreview() { setPreview({ open: false, row: null }); } const previewRow = preview.row; const kind = previewRow ? inlineKind(previewRow.mime_type) : 'unknown'; const inlineUrl = previewRow && kind === 'image' ? toWatermarkPreviewUrl(previewRow.preview_url) : previewRow?.preview_url || ''; return ( <div className="p-6"> <div className="flex flex-col gap-2"> <h1 className="text-xl font-semibold text-gray-900"> Evidence Vault </h1> <p className="text-sm text-gray-600"> Central evidence store for the family across all incidents. </p> </div> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Filters </ div > < div className = "mt-3 grid grid-cols-1 gap-3 md:grid-cols-6" > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Type </ label > < select className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {type} onChange = {(e) => setType(e.target.value)} > < option value = "" > All </ option > < option value = "SCREENSHOT" > SCREENSHOT </ option > < option value = "AUDIO" > AUDIO </ option > < option value = "VIDEO" > VIDEO </ option > < option value = "TEXT_SNAPSHOT" > TEXT_SNAPSHOT </ option > < option value = "CAMERA_STREAM_FRAME" > CAMERA_STREAM_FRAME </ option > </ select > </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Device ID </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "dev_..." value = {deviceId} onChange = {(e) => setDeviceId(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Incident ID </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "inc_..." value = {incidentId} onChange = {(e) => setIncidentId(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > From </ label > < input type = "date" className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {from} onChange = {(e) => setFrom(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > To </ label > < input type = "date" className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {to} onChange = {(e) => setTo(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Search </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "storage key / mime..." value = {q} onChange = {(e) => setQ(e.target.value)} /> </ div > </ div > < div className = "mt-4 flex flex-wrap gap-2" > < button className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black disabled:opacity-60" onClick = {loadFirstPage} disabled = {loading} > {loading ? 'Loading...' : 'Apply Filters'} </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => { setType(''); setDeviceId(''); setIncidentId(''); setFrom(''); setTo(''); setQ(''); }} > Reset </ button > </ div > {err ? ( < div className = "mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > ) : null} </ div > < div className = "mt-5 rounded-2xl border border-gray-200 bg-white shadow-sm" > < div className = "w-full overflow-x-auto" > < table className = "min-w-full border-separate border-spacing-0" > < thead > < tr className = "bg-gray-50" > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Evidence </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Type </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Captured </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Size </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Hash </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Actions </ th > </ tr > </ thead > < tbody > {loading ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > Loading evidence... </ td > </ tr > ) : items.length === 0 ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > No evidence found. </ td > </ tr > ) : ( items.map((x) => ( < tr key = {x.evidence_id} className = "hover:bg-gray-50" > < td className = "border-b border-gray-200 px-4 py-3" > < div className = "text-sm font-semibold text-gray-900" > {shortId(x.evidence_id)} </ div > < div className = "mt-1 font-mono text-[11px] text-gray-600 break-all" > {x.storage_key} </ div > < div className = "mt-1 text-[11px] text-gray-500" > Incident:{' '} < span className = "font-mono" > {x.incident_id ? shortId(x.incident_id) : 'N/A'} </ span > </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > < div className = "font-semibold" > {x.evidence_type} </ div > < div className = "mt-1 text-[11px] text-gray-500" > {x.mime_type} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {new Date(x.captured_at).toLocaleString()} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {bytes(x.size_bytes)} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-xs text-gray-700" > < div className = "break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {x.sha256_hex} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3" > < div className = "flex flex-wrap gap-2" > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => openPreview(x)} > Preview </ button > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {x.download_url} > Download </ a > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(x.sha256_hex)} > Copy Hash </ button > </ div > </ td > </ tr > )) )} </ tbody > </ table > < div className = "flex items-center justify-between px-4 py-4" > < div className = "text-xs text-gray-500" > Loaded: {items.length} </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50 disabled:opacity-50" onClick = {loadMore} disabled = {!nextCursor || loadingMore } > {loadingMore ? 'Loading...' : nextCursor ? 'Load more' : 'No more'} </ button > </ div > </ div > </ div > {preview.open && previewRow ? ( < div className = "fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4" > < div className = "w-full max-w-4xl rounded-2xl border border-gray-200 bg-white shadow-xl" > < div className = "flex items-start justify-between gap-4 border-b border-gray-200 p-4" > < div > < div className = "text-base font-semibold text-gray-900" > Evidence Preview </ div > < div className = "mt-1 text-xs text-gray-600 break-all" > {previewRow.storage_key} </ div > </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {closePreview} > Close </ button > </ div > < div className = "p-4" > < div className = "grid grid-cols-1 gap-4 md:grid-cols-2" > < div className = "rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-xs text-gray-600" > Type: < span className = "font-semibold text-gray-900" > {previewRow.evidence_type} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > MIME: < span className = "font-mono text-gray-900" > {previewRow.mime_type} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > SHA-256: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {previewRow.sha256_hex} </ div > </ div > < div className = "mt-4 flex flex-wrap gap-2" > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {previewRow.download_url} > Download </ a > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(previewRow.sha256_hex)} > Copy Hash </ button > </ div > </ div > < div className = "rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Inline Preview </ div > < div className = "mt-2 text-xs text-gray-600" > Images are watermarked on preview only. Audio/Video use range streaming. </ div > < div className = "mt-3 rounded-2xl border border-gray-200 bg-gray-50 p-3" > {kind === 'image' ? ( // eslint-disable-next-line @next/next/no-img-element < img src = {inlineUrl} alt = "evidence preview" className = "h-auto w-full rounded-xl border border-gray-200 bg-white" /> ) : kind === 'audio' ? ( < audio controls className = "w-full" preload = "metadata" src = {inlineUrl} /> ) : kind === 'video' ? ( < video controls className = "w-full rounded-xl border border-gray-200 bg-black" preload = "metadata" src = {inlineUrl} /> ) : ( < div className = "text-sm text-gray-700" > Inline preview not supported for this MIME type. </ div > )} </ div > </ div > </ div > < div className = "mt-4" > < HashVerifier expectedSha256 = {previewRow.sha256_hex} /> </ div > < div className = "mt-3 text-xs text-gray-500" > Preview and download are signed, rate-limited, and audited (custody chain). </ div > </ div > </ div > </ div > ) : null} </ div > ); } [6] Evidence Package Generator (ZIP + Manifest + Custody PDF) [6.1] ما الذي سيتم إنشاؤه داخل ZIP؟ Table: محتويات الحزمة File Purpose manifest.json تعريف كل دليل + النوع + hash + timestamps + device_id custody_report.pdf تقرير سلسلة الحيازة (Hash-Chained) قابل للطباعة evidence/ <id> _ <type> . <ext> ملفات الأدلة نفسها [6.2] Endpoint: /api/families/[familyId]/evidence-package المسار: app/api/families/[familyId]/evidence-package/route.ts يتطلب مكتبتين: npm i archiver pdfkit // app/api/families/[familyId]/evidence-package/route.ts import { NextRequest, NextResponse } from 'next/server'; import { prisma } from '@/lib/prisma'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import crypto from 'crypto'; import fs from 'fs'; import path from 'path'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } function safeStr(v: string | null) { const s = (v || '').trim(); return s.length ? s : null; } function safeDateISO(v: string | null) { if (!v) return null; const d = new Date(v); if (Number.isNaN(d.getTime())) return null; return d; } function extFromMime(mime: string) { const m = (mime || '').toLowerCase(); if (m.includes('jpeg')) return 'jpg'; if (m.includes('png')) return 'png'; if (m.includes('webp')) return 'webp'; if (m.includes('mp4')) return 'mp4'; if (m.includes('mpeg')) return 'mp3'; if (m.includes('wav')) return 'wav'; if (m.includes('json')) return 'json'; if (m.includes('text')) return 'txt'; return 'bin'; } async function readLocalBuffer(storage_key: string) { const baseDir = getEnv('STORAGE_LOCAL_DIR', path.join(process.cwd(), 'storage_local')); const abs = path.join(baseDir, storage_key); if (!fs.existsSync(abs)) throw new HttpError(404, 'File not found (local driver)'); return fs.readFileSync(abs); } async function readS3Buffer(storage_key: string) { const bucket = getEnv('STORAGE_S3_BUCKET'); const region = getEnv('STORAGE_S3_REGION', 'auto'); const accessKeyId = getEnv('STORAGE_S3_ACCESS_KEY'); const secretAccessKey = getEnv('STORAGE_S3_SECRET_KEY'); const endpoint = getEnv('STORAGE_S3_ENDPOINT', ''); if (!bucket || !accessKeyId || !secretAccessKey) { throw new HttpError(500, 'S3 driver missing env config'); } const { S3Client, GetObjectCommand } = await import('@aws-sdk/client-s3'); const client = new S3Client({ region, ...(endpoint ? { endpoint } : {}), credentials: { accessKeyId, secretAccessKey }, }); const out: any = await client.send( new GetObjectCommand({ Bucket: bucket, Key: storage_key, }) ); const body = out?.Body; if (!body) throw new HttpError(404, 'Object not found in S3'); const chunks: Buffer[] = []; for await (const chunk of body as any) { chunks.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk)); } return Buffer.concat(chunks); } async function buildCustodyPdf(familyId: string, rows: any[]) { const PDFDocument = (await import('pdfkit')).default; return new Promise <Buffer> ((resolve) => { const doc = new PDFDocument({ size: 'A4', margin: 48 }); const buffers: Buffer[] = []; code Code download content_copy expand_less doc.on( 'data' , ( d ) => buffers.push(d)); doc.on( 'end' , () => resolve(Buffer.concat(buffers))); doc.fontSize( 18 ).text( 'AMANA Evidence Custody Report' , { align : 'left' }); doc.moveDown( 0.6 ); doc.fontSize( 10 ).fillColor( '#444' ).text( `Family ID: ${familyId} ` ); doc.text( `Generated at: ${ new Date ().toISOString()} ` ); doc.moveDown( 1 ); doc.fillColor( '#000' ).fontSize( 12 ).text( 'Custody Events (Latest First)' ); doc.moveDown( 0.5 ); rows.forEach( ( r, idx ) => { doc.fontSize( 10 ).fillColor( '#000' ).text( `# ${idx + 1 } ${r.event_key} ` ); doc.fillColor( '#444' ).text( `Time: ${ new Date (r.event_at).toISOString()} ` ); doc.text( `Actor: ${r.actor} ` ); if (r.incident_id) doc.text( `Incident: ${r.incident_id} ` ); doc.text( `Hash: ${r.hash_hex} ` ); if (r.prev_hash_hex) doc.text( `Prev: ${r.prev_hash_hex} ` ); doc.moveDown( 0.6 ); }); doc.end(); }); } export async function GET(req: NextRequest, ctx: { params: { familyId: string } }) { try { const principal = getPrincipal(req); const familyId = ctx.params.familyId; code Code download content_copy expand_less if (!requireFamilyAccess(principal, familyId)) throw new HttpError( 403 , 'Forbidden' ); const url = new URL(req.url); const type = safeStr(url.searchParams.get( 'type' )); const device_id = safeStr(url.searchParams.get( 'device_id' )); const incident_id = safeStr(url.searchParams.get( 'incident_id' )); const from = safeDateISO(url.searchParams.get( 'from' )); const to = safeDateISO(url.searchParams.get( 'to' )); const where: any = { family_id : familyId, ...( type ? { evidence_type : type } : {}), ...(incident_id ? { incident_id } : {}), ...(device_id ? { meta_json : { path : [ 'device_id' ], equals : device_id } } : {}), ...( from || to ? { captured_at : { ...( from ? { gte : from } : {}), ...(to ? { lte : to } : {}), }, } : {}), }; const evidence = await prisma.evidenceItem.findMany({ where, orderBy : { captured_at : 'desc' }, take : 250 , // limit hard for safety (increase later with async job) select : { evidence_id : true , incident_id : true , evidence_type : true , storage_key : true , mime_type : true , size_bytes : true , sha256_hex : true , captured_at : true , meta_json : true , }, }); const custody = await prisma.custodyEvent.findMany({ where : { family_id : familyId }, orderBy : { event_at : 'desc' }, take : 250 , select : { custody_id : true , incident_id : true , actor : true , event_key : true , event_at : true , prev_hash_hex : true , hash_hex : true , event_json : true , }, }); // Create package-level custody event const created_at = new Date (); const last = await prisma.custodyEvent.findFirst({ where : { family_id : familyId }, orderBy : { event_at : 'desc' }, select : { hash_hex : true }, }); const prev_hash_hex = last?.hash_hex ?? null ; const pkg_json = { evidence_count : evidence.length, filters : { type , device_id, incident_id, from : from ?.toISOString() || null , to : to?.toISOString() || null }, requested_by_user_id : principal.user_id || null , }; const hash_payload = JSON .stringify({ family_id : familyId, incident_id : null , actor : 'PARENT_CONSOLE' , event_key : 'EVIDENCE_PACKAGE_GENERATED' , event_at : created_at.toISOString(), prev_hash_hex, event_json : pkg_json, }); const pkg_hash_hex = sha256Hex(hash_payload); await prisma.custodyEvent.create({ data : { family_id : familyId, incident_id : null , actor : 'PARENT_CONSOLE' , event_key : 'EVIDENCE_PACKAGE_GENERATED' , event_at : created_at, event_json : pkg_json, prev_hash_hex, hash_hex : pkg_hash_hex, }, }); const manifest = { family_id : familyId, generated_at : created_at.toISOString(), package_hash_hex : pkg_hash_hex, filters : pkg_json.filters, evidence : evidence.map( ( e ) => ({ evidence_id : e.evidence_id, incident_id : e.incident_id, evidence_type : e.evidence_type, mime_type : e.mime_type, size_bytes : e.size_bytes, sha256_hex : e.sha256_hex, captured_at : e.captured_at.toISOString(), meta_json : e.meta_json, storage_key : e.storage_key, })), }; const custodyPdf = await buildCustodyPdf(familyId, custody); // ZIP streaming via archiver const archiver = ( await import ( 'archiver' )).default; const archive = archiver( 'zip' , { zlib : { level : 9 } }); const filename = `AMANA_EVIDENCE_PACKAGE_ ${familyId} _ ${created_at.toISOString().replace( /[:.]/g , '-' )} .zip` ; const stream = new ReadableStream({ start ( controller ) { archive.on( 'data' , ( chunk: any ) => controller.enqueue(chunk)); archive.on( 'end' , () => controller.close()); archive.on( 'error' , ( err: any ) => controller.error(err)); // Add manifest + custody pdf archive.append( JSON .stringify(manifest, null , 2 ), { name : 'manifest.json' }); archive.append(custodyPdf, { name : 'custody_report.pdf' }); // Add evidence files const driver = (getEnv( 'STORAGE_DRIVER' , 'local' ) || 'local' ).toLowerCase(); ( async () => { for ( const e of evidence) { try { const buf = driver === 's3' || driver === 'r2' ? await readS3Buffer(e.storage_key) : await readLocalBuffer(e.storage_key); const ext = extFromMime(e.mime_type); const safeName = `evidence/ ${e.evidence_id} _ ${e.evidence_type} . ${ext} ` ; archive.append(buf, { name : safeName }); } catch { // If one evidence missing, keep package valid and include note archive.append( `Missing file: ${e.evidence_id} storage_key= ${e.storage_key} \n` , { name : `errors/missing_ ${e.evidence_id} .txt` } ); } } await archive.finalize(); })(); }, }); return new NextResponse(stream as any , { status : 200 , headers : { 'Content-Type' : 'application/zip' , 'Content-Disposition' : `attachment; filename=" ${filename} "` , 'Cache-Control' : 'no-store' , }, }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [7] متطلبات البيئة (ENV) لهذه المرحلة Table: متغيرات البيئة المطلوبة Env Example Required Purpose STORAGE_SIGNING_SECRET long_random_secret Yes توقيع روابط الأدلة STORAGE_DRIVER local / s3 Yes مزود التخزين STORAGE_LOCAL_DIR storage_local local مسار التخزين المحلي STORAGE_S3_BUCKET amana-bucket s3 اسم bucket STORAGE_S3_REGION auto s3 المنطقة STORAGE_S3_ACCESS_KEY ... s3 الوصول STORAGE_S3_SECRET_KEY ... s3 السر STORAGE_S3_ENDPOINT https://... optional Endpoint لـ R2 RATE_LIMIT_DRIVER auto/redis/memory optional اختيار سائق RL RATE_LIMIT_REDIS_URL redis://... optional Redis للـ RL [8] ماذا أصبح عندك الآن؟ أنت الآن تمتلك Evidence Vault “قابل للتقديم للجهات الرسمية” لأن: Preview موقّع + Watermark للصور يقلل تسريب الأدلة Rate limit يمنع scraping ومحاولات الإغراق Evidence Package ZIP يشمل: Manifest رسمي Custody PDF الأدلة نفسها كل ذلك مسجّل داخل سلسلة الحيازة كأحداث قابلة للمراجعة [9] Suggested Next Steps [9.1] إضافة زر في UI: Generate Evidence Package مع نفس الفلاتر الحالية. [9.2] تنفيذ Async Job Queue للحزم الكبيرة (بدل توليدها في Request مباشر). [9.3] إضافة Tamper-Proof Manifest Signature (توقيع manifest نفسه بمفتاح خاص) لرفع القوة الجنائية أكثر.
[158] [1] ## ممتاز — نكمّل الآن “Evidence Vault” إلى مستوى Enterprise فعلي (Job Queue + Signed Manifest + Legal Hold) سأضيف 3 ترقيات تجعل النظام مؤسسي بالكامل وقابل للتوسع بدون ضغط على السيرفر: Evidence Package كـ Background Job (BullMQ/Redis) بدل توليده مباشرة داخل request توقيع manifest.json بتوقيع رقمي Ed25519 (يعطي قوة جنائية أعلى + ضد العبث) Legal Hold + Retention Guard (منع حذف الأدلة في الحالات الحساسة) كل الملفات أدناه كاملة وجاهزة للنسخ. [2] Evidence Package كـ Background Job (BullMQ + Redis) [2.1] الفكرة المؤسسية بدل ما /evidence-package يولّد ZIP داخل نفس الطلب (قد يعلق أو ينفجر مع آلاف الأدلة)، نعمل: Start Job: يرجّع jobId Status: يعرض progress + رابط تحميل عند الاكتمال Worker مستقل: ينفذ إنشاء الحزمة ويخزنها في Local/S3 [2.2] ملف: lib/queue/bull.ts Requires: npm i bullmq ioredis // lib/queue/bull.ts import { Queue, Worker, QueueEvents } from 'bullmq'; import IORedis from 'ioredis'; function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } export const redisConnection = new IORedis(getEnv('QUEUE_REDIS_URL', 'redis://localhost:6379'), { maxRetriesPerRequest: null, }); export const evidencePackageQueue = new Queue('evidence_package', { connection: redisConnection, defaultJobOptions: { attempts: 2, backoff: { type: 'exponential', delay: 2000 }, removeOnComplete: { age: 3600, count: 2000 }, // keep 1h removeOnFail: { age: 3600 * 6, count: 2000 }, }, }); export const evidencePackageQueueEvents = new QueueEvents('evidence_package', { connection: redisConnection, }); [2.3] ملف: app/api/families/[familyId]/evidence-package-job/route.ts Endpoint: POST يبدأ Job GET يرجّع آخر Jobs (اختياري للمراجعة) // app/api/families/[familyId]/evidence-package-job/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getPrincipal, requireFamilyAccess, HttpError } from '@/lib/auth'; import { evidencePackageQueue } from '@/lib/queue/bull'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function safeStr(v: any) { const s = String(v ?? '').trim(); return s.length ? s : null; } export async function POST(req: NextRequest, ctx: { params: { familyId: string } }) { try { const principal = getPrincipal(req); const familyId = ctx.params.familyId; code Code download content_copy expand_less if (!requireFamilyAccess(principal, familyId)) throw new HttpError( 403 , 'Forbidden' ); const body = await req.json().catch( () => ({})); const payload = { familyId, requestedByUserId : principal.user_id || null , filters : { type : safeStr(body?.type), device_id : safeStr(body?.device_id), incident_id : safeStr(body?.incident_id), from : safeStr(body?.from), to : safeStr(body?.to), q : safeStr(body?.q), }, }; const job = await evidencePackageQueue.add( 'build_evidence_package' , payload); return NextResponse.json({ ok : true , jobId : job.id, statusUrl : `/api/jobs/evidence-package/ ${job.id} ` , }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } export async function GET(req: NextRequest, ctx: { params: { familyId: string } }) { try { const principal = getPrincipal(req); const familyId = ctx.params.familyId; code Code download content_copy expand_less if (!requireFamilyAccess(principal, familyId)) throw new HttpError( 403 , 'Forbidden' ); const jobs = await evidencePackageQueue.getJobs([ 'waiting' , 'active' , 'completed' , 'failed' ], 0 , 20 ); return NextResponse.json({ ok : true , items : jobs.map( ( j ) => ({ id : j.id, name : j.name, progress : j.progress, attemptsMade : j.attemptsMade, failedReason : j.failedReason || null , timestamp : j.timestamp, })), }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [2.4] ملف: app/api/jobs/evidence-package/[jobId]/route.ts يعطي: state progress downloadUrl عند الاكتمال // app/api/jobs/evidence-package/[jobId]/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getPrincipal, HttpError } from '@/lib/auth'; import { evidencePackageQueue } from '@/lib/queue/bull'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } export async function GET(req: NextRequest, ctx: { params: { jobId: string } }) { try { // Principal exists to ensure authenticated calls, you can tighten later (family access) getPrincipal(req); code Code download content_copy expand_less const jobId = ctx.params.jobId; const job = await evidencePackageQueue.getJob(jobId); if (!job) throw new HttpError( 404 , 'Job not found' ); const state = await job.getState(); const progress = job.progress || 0 ; const result = (job.returnvalue || null ) as any ; return NextResponse.json({ ok : true , job : { id : job.id, name : job.name, state, progress, attemptsMade : job.attemptsMade, failedReason : job.failedReason || null , }, result : result ? { fileKey : result.fileKey || null , filename : result.filename || null , downloadUrl : result.downloadUrl || null , manifestSignature : result.manifestSignature || null , } : null , }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [3] توقيع manifest.json بتوقيع Ed25519 (Signed Manifest) [3.1] ملف: lib/crypto/manifestSign.ts يتطلب مفاتيح PEM في env: MANIFEST_SIGN_PRIVATE_KEY_PEM MANIFEST_SIGN_PUBLIC_KEY_PEM // lib/crypto/manifestSign.ts import crypto from 'crypto'; function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } export function signManifestJson(manifestObj: any) { const privateKeyPem = getEnv('MANIFEST_SIGN_PRIVATE_KEY_PEM'); if (!privateKeyPem) throw new Error('Missing MANIFEST_SIGN_PRIVATE_KEY_PEM'); const canonical = JSON.stringify(manifestObj); const signature = crypto.sign(null, Buffer.from(canonical, 'utf8'), privateKeyPem); return { canonical, signatureBase64: signature.toString('base64'), alg: 'Ed25519', }; } export function verifyManifestSignature(manifestObj: any, signatureBase64: string) { const publicKeyPem = getEnv('MANIFEST_SIGN_PUBLIC_KEY_PEM'); if (!publicKeyPem) throw new Error('Missing MANIFEST_SIGN_PUBLIC_KEY_PEM'); const canonical = JSON.stringify(manifestObj); const sig = Buffer.from(signatureBase64, 'base64'); return crypto.verify(null, Buffer.from(canonical, 'utf8'), publicKeyPem, sig); } [4] Worker مؤسسي يبني ZIP ويضيف manifest + pdf + توقيع [4.1] ملف: workers/evidencePackageWorker.ts تشغيله في بيئة Node مستقلة (PM2 / Docker / server VM) node workers/evidencePackageWorker.ts Requires: npm i archiver pdfkit @aws-sdk/client-s3 // workers/evidencePackageWorker.ts import { Worker } from 'bullmq'; import crypto from 'crypto'; import fs from 'fs'; import path from 'path'; import archiver from 'archiver'; import PDFDocument from 'pdfkit'; import { prisma } from '@/lib/prisma'; import { redisConnection } from '@/lib/queue/bull'; import { signManifestJson } from '@/lib/crypto/manifestSign'; function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } function sha256Hex(input: string) { return crypto.createHash('sha256').update(input).digest('hex'); } function ensureDir(p: string) { if (!fs.existsSync(p)) fs.mkdirSync(p, { recursive: true }); } function safeDateISO(v: string | null) { if (!v) return null; const d = new Date(v); if (Number.isNaN(d.getTime())) return null; return d; } function extFromMime(mime: string) { const m = (mime || '').toLowerCase(); if (m.includes('jpeg')) return 'jpg'; if (m.includes('png')) return 'png'; if (m.includes('webp')) return 'webp'; if (m.includes('mp4')) return 'mp4'; if (m.includes('mpeg')) return 'mp3'; if (m.includes('wav')) return 'wav'; if (m.includes('json')) return 'json'; if (m.includes('text')) return 'txt'; return 'bin'; } async function readLocalBuffer(storage_key: string) { const baseDir = getEnv('STORAGE_LOCAL_DIR', path.join(process.cwd(), 'storage_local')); const abs = path.join(baseDir, storage_key); if (!fs.existsSync(abs)) throw new Error('File not found (local driver)'); return fs.readFileSync(abs); } async function readS3Buffer(storage_key: string) { const bucket = getEnv('STORAGE_S3_BUCKET'); const region = getEnv('STORAGE_S3_REGION', 'auto'); const accessKeyId = getEnv('STORAGE_S3_ACCESS_KEY'); const secretAccessKey = getEnv('STORAGE_S3_SECRET_KEY'); const endpoint = getEnv('STORAGE_S3_ENDPOINT', ''); if (!bucket || !accessKeyId || !secretAccessKey) { throw new Error('S3 driver missing env config'); } const { S3Client, GetObjectCommand } = await import('@aws-sdk/client-s3'); const client = new S3Client({ region, ...(endpoint ? { endpoint } : {}), credentials: { accessKeyId, secretAccessKey }, }); const out: any = await client.send( new GetObjectCommand({ Bucket: bucket, Key: storage_key, }) ); const body = out?.Body; if (!body) throw new Error('Object not found in S3'); const chunks: Buffer[] = []; for await (const chunk of body as any) { chunks.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk)); } return Buffer.concat(chunks); } async function buildCustodyPdf(familyId: string, rows: any[]) { return new Promise <Buffer> ((resolve) => { const doc = new PDFDocument({ size: 'A4', margin: 48 }); const buffers: Buffer[] = []; code Code download content_copy expand_less doc.on( 'data' , ( d ) => buffers.push(d)); doc.on( 'end' , () => resolve(Buffer.concat(buffers))); doc.fontSize( 18 ).text( 'AMANA Evidence Custody Report' , { align : 'left' }); doc.moveDown( 0.6 ); doc.fontSize( 10 ).fillColor( '#444' ).text( `Family ID: ${familyId} ` ); doc.text( `Generated at: ${ new Date ().toISOString()} ` ); doc.moveDown( 1 ); doc.fillColor( '#000' ).fontSize( 12 ).text( 'Custody Events (Latest First)' ); doc.moveDown( 0.5 ); rows.forEach( ( r, idx ) => { doc.fontSize( 10 ).fillColor( '#000' ).text( `# ${idx + 1 } ${r.event_key} ` ); doc.fillColor( '#444' ).text( `Time: ${ new Date (r.event_at).toISOString()} ` ); doc.text( `Actor: ${r.actor} ` ); if (r.incident_id) doc.text( `Incident: ${r.incident_id} ` ); doc.text( `Hash: ${r.hash_hex} ` ); if (r.prev_hash_hex) doc.text( `Prev: ${r.prev_hash_hex} ` ); doc.moveDown( 0.6 ); }); doc.end(); }); } async function writeZipFile(outPath: string, manifest: any, custodyPdf: Buffer, evidenceRows: any[]) { return new Promise <void> (async (resolve, reject) => { ensureDir(path.dirname(outPath)); const output = fs.createWriteStream(outPath); const zip = archiver('zip', { zlib: { level: 9 } }); code Code download content_copy expand_less output.on( 'close' , () => resolve()); zip.on( 'error' , ( err ) => reject(err)); zip.pipe(output); // Signed manifest const signed = signManifestJson(manifest); const manifestWithSig = { ...manifest, signature : { alg : signed.alg, signatureBase64 : signed.signatureBase64, }, }; zip.append( JSON .stringify(manifestWithSig, null , 2 ), { name : 'manifest.json' }); zip.append(custodyPdf, { name : 'custody_report.pdf' }); const driver = (getEnv( 'STORAGE_DRIVER' , 'local' ) || 'local' ).toLowerCase(); for ( const e of evidenceRows) { try { const buf = driver === 's3' || driver === 'r2' ? await readS3Buffer(e.storage_key) : await readLocalBuffer(e.storage_key); const ext = extFromMime(e.mime_type); const safeName = `evidence/ ${e.evidence_id} _ ${e.evidence_type} . ${ext} ` ; zip.append(buf, { name : safeName }); } catch { zip.append( `Missing file: ${e.evidence_id} storage_key= ${e.storage_key} \n` , { name : `errors/missing_ ${e.evidence_id} .txt` } ); } } await zip.finalize(); }); } function buildDownloadUrl(jobId: string) { return /api/jobs/evidence-package/${jobId}/download ; } new Worker( 'evidence_package', async (job) => { const { familyId, filters, requestedByUserId } = job.data as any; code Code download content_copy expand_less await job.updateProgress( 5 ); const type = (filters?.type || '' ).trim() || null ; const device_id = (filters?.device_id || '' ).trim() || null ; const incident_id = (filters?.incident_id || '' ).trim() || null ; const from = safeDateISO(filters?.from || null ); const to = safeDateISO(filters?.to || null ); const where: any = { family_id : familyId, ...( type ? { evidence_type : type } : {}), ...(incident_id ? { incident_id } : {}), ...(device_id ? { meta_json : { path : [ 'device_id' ], equals : device_id } } : {}), ...( from || to ? { captured_at : { ...( from ? { gte : from } : {}), ...(to ? { lte : to } : {}), }, } : {}), }; const evidence = await prisma.evidenceItem.findMany({ where, orderBy : { captured_at : 'desc' }, take : 1000 , select : { evidence_id : true , incident_id : true , evidence_type : true , storage_key : true , mime_type : true , size_bytes : true , sha256_hex : true , captured_at : true , meta_json : true , }, }); await job.updateProgress( 25 ); const custody = await prisma.custodyEvent.findMany({ where : { family_id : familyId }, orderBy : { event_at : 'desc' }, take : 1000 , select : { custody_id : true , incident_id : true , actor : true , event_key : true , event_at : true , prev_hash_hex : true , hash_hex : true , event_json : true , }, }); await job.updateProgress( 40 ); // Package-level custody event const created_at = new Date (); const last = await prisma.custodyEvent.findFirst({ where : { family_id : familyId }, orderBy : { event_at : 'desc' }, select : { hash_hex : true }, }); const prev_hash_hex = last?.hash_hex ?? null ; const pkg_json = { evidence_count : evidence.length, filters : { type , device_id, incident_id, from : from ?.toISOString() || null , to : to?.toISOString() || null }, requested_by_user_id : requestedByUserId || null , job_id : job.id, }; const hash_payload = JSON .stringify({ family_id : familyId, incident_id : null , actor : 'PARENT_CONSOLE' , event_key : 'EVIDENCE_PACKAGE_GENERATED' , event_at : created_at.toISOString(), prev_hash_hex, event_json : pkg_json, }); const pkg_hash_hex = sha256Hex(hash_payload); await prisma.custodyEvent.create({ data : { family_id : familyId, incident_id : null , actor : 'PARENT_CONSOLE' , event_key : 'EVIDENCE_PACKAGE_GENERATED' , event_at : created_at, event_json : pkg_json, prev_hash_hex, hash_hex : pkg_hash_hex, }, }); await job.updateProgress( 55 ); const manifest = { family_id : familyId, generated_at : created_at.toISOString(), package_hash_hex : pkg_hash_hex, filters : pkg_json.filters, evidence : evidence.map( ( e ) => ({ evidence_id : e.evidence_id, incident_id : e.incident_id, evidence_type : e.evidence_type, mime_type : e.mime_type, size_bytes : e.size_bytes, sha256_hex : e.sha256_hex, captured_at : e.captured_at.toISOString(), meta_json : e.meta_json, storage_key : e.storage_key, })), }; const custodyPdf = await buildCustodyPdf(familyId, custody); await job.updateProgress( 70 ); const packagesDir = getEnv( 'EVIDENCE_PACKAGES_DIR' , path.join(process.cwd(), 'evidence_packages' )); ensureDir(packagesDir); const filename = `AMANA_EVIDENCE_PACKAGE_ ${familyId} _ ${created_at.toISOString().replace( /[:.]/g , '-' )} .zip` ; const fileKey = ` ${job.id} .zip` ; const outPath = path.join(packagesDir, fileKey); await writeZipFile(outPath, manifest, custodyPdf, evidence); await job.updateProgress( 95 ); return { fileKey, filename, downloadUrl : buildDownloadUrl( String (job.id)), manifestSignature : 'embedded_in_manifest.json' , }; }, { connection: redisConnection, concurrency: 2, } ); console.log('Evidence Package Worker running...'); [4.2] ملف: app/api/jobs/evidence-package/[jobId]/download/route.ts هذا endpoint يقوم بتحميل ZIP النهائي بعد جاهزيته // app/api/jobs/evidence-package/[jobId]/download/route.ts import { NextRequest, NextResponse } from 'next/server'; import { getPrincipal, HttpError } from '@/lib/auth'; import { evidencePackageQueue } from '@/lib/queue/bull'; import fs from 'fs'; import path from 'path'; export const dynamic = 'force-dynamic'; function jsonError(status: number, message: string) { return NextResponse.json({ error: { status, message } }, { status }); } function getEnv(name: string, fallback = '') { return process.env[name] || fallback; } export async function GET(req: NextRequest, ctx: { params: { jobId: string } }) { try { // Ensure authenticated getPrincipal(req); code Code download content_copy expand_less const jobId = ctx.params.jobId; const job = await evidencePackageQueue.getJob(jobId); if (!job) throw new HttpError( 404 , 'Job not found' ); const state = await job.getState(); if (state !== 'completed' ) throw new HttpError( 409 , `Job not completed (state= ${state} )` ); const result = (job.returnvalue || null ) as any ; if (!result?.fileKey) throw new HttpError( 500 , 'Job result missing fileKey' ); const packagesDir = getEnv( 'EVIDENCE_PACKAGES_DIR' , path.join(process.cwd(), 'evidence_packages' )); const abs = path.join(packagesDir, result.fileKey); if (!fs.existsSync(abs)) throw new HttpError( 404 , 'Package file not found on server' ); const stat = fs.statSync(abs); const stream = fs.createReadStream(abs); return new NextResponse(stream as any , { status : 200 , headers : { 'Content-Type' : 'application/zip' , 'Content-Length' : String (stat.size), 'Content-Disposition' : `attachment; filename=" ${result.filename || `evidence_package_ ${jobId} .zip` } "` , 'Cache-Control' : 'no-store' , }, }); } catch (e: any) { return jsonError(e?.status ?? 500, e?.message ?? 'Unexpected error'); } } [5] UI Upgrade: زر “Generate Evidence Package” مع Progress Modal [5.1] استبدال ملف: components/parent/EvidenceVaultTable.tsx أضفت: زر Generate Evidence Package نافذة متابعة التقدم (poll status) زر Download تلقائي بعد completion // components/parent/EvidenceVaultTable.tsx 'use client'; import React, { useEffect, useMemo, useState } from 'react'; import HashVerifier from '@/components/parent/HashVerifier'; type EvidenceRow = { evidence_id: string; incident_id: string | null; evidence_type: string; storage_key: string; mime_type: string; size_bytes: number; sha256_hex: string; captured_at: string; download_url: string; download_exp: number; preview_url: string; preview_exp: number; }; type ApiResp = { ok: boolean; items: EvidenceRow[]; next_cursor: string | null; }; type JobStatusResp = { ok: boolean; job: { id: string; name: string; state: string; progress: number; attemptsMade: number; failedReason: string | null; }; result: null | { fileKey: string | null; filename: string | null; downloadUrl: string | null; manifestSignature: string | null; }; }; function shortId(id: string) { if (!id) return ''; if (id.length <= 14) return id; return id.slice(0, 12) + '...'; } function bytes(n: number) { if (!Number.isFinite(n) || n <= 0) return '0 B'; const units = ['B', 'KB', 'MB', 'GB']; let x = n; let u = 0; while (x >= 1024 && u < units.length - 1) { x /= 1024; u++; } return ${x.toFixed(u === 0 ? 0 : 1)} ${units[u]} ; } function buildUrl(base: string, params: Record<string, string | number | null | undefined>) { const u = new URL(base, ' http://localhost '); Object.entries(params).forEach(([k, v]) => { if (v === undefined || v === null || String(v).trim() === '') return; u.searchParams.set(k, String(v)); }); return u.pathname + '?' + u.searchParams.toString(); } function inlineKind(mime: string): 'image' | 'audio' | 'video' | 'unknown' { const m = (mime || '').toLowerCase(); if (m.startsWith('image/')) return 'image'; if (m.startsWith('audio/')) return 'audio'; if (m.startsWith('video/')) return 'video'; return 'unknown'; } function toWatermarkPreviewUrl(preview_url: string) { if (!preview_url) return preview_url; return preview_url.replace('/api/storage/blob', '/api/storage/preview-image'); } export default function EvidenceVaultTable({ familyId }: { familyId: string }) { const baseEndpoint = useMemo(() => { return /api/families/${encodeURIComponent(familyId)}/evidence ; }, [familyId]); const jobEndpoint = useMemo(() => { return /api/families/${encodeURIComponent(familyId)}/evidence-package-job ; }, [familyId]); const [items, setItems] = useState<EvidenceRow[]>([]); const [nextCursor, setNextCursor] = useState<string | null>(null); const [loading, setLoading] = useState(true); const [loadingMore, setLoadingMore] = useState(false); const [err, setErr] = useState(''); const [type, setType] = useState(''); const [deviceId, setDeviceId] = useState(''); const [incidentId, setIncidentId] = useState(''); const [from, setFrom] = useState(''); const [to, setTo] = useState(''); const [q, setQ] = useState(''); const [preview, setPreview] = useState<{ open: boolean; row: EvidenceRow | null }>({ open: false, row: null, }); const [pkg, setPkg] = useState<{ open: boolean; jobId: string | null; state: string; progress: number; downloadUrl: string | null; filename: string | null; error: string | null; }>({ open: false, jobId: null, state: 'idle', progress: 0, downloadUrl: null, filename: null, error: null, }); async function loadFirstPage() { setLoading(true); setErr(''); try { const url = buildUrl(baseEndpoint, { limit: 30, type: type || null, device_id: deviceId || null, incident_id: incidentId || null, from: from || null, to: to || null, q: q || null, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiResp; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load evidence' ); } setItems(json.items || []); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); setItems([]); setNextCursor( null ); } finally { setLoading( false ); } } async function loadMore() { if (!nextCursor) return; setLoadingMore(true); setErr(''); try { const url = buildUrl(baseEndpoint, { limit: 30, cursor: nextCursor, type: type || null, device_id: deviceId || null, incident_id: incidentId || null, from: from || null, to: to || null, q: q || null, }); code Code download content_copy expand_less const res = await fetch(url, { method : 'GET' , cache : 'no-store' }); const json = ( await res.json()) as ApiResp; if (!res.ok || !json.ok) { throw new Error ((json as any )?.error?.message || 'Failed to load more evidence' ); } setItems( ( prev ) => [...prev, ...(json.items || [])]); setNextCursor(json.next_cursor ?? null ); } catch (e: any ) { setErr(e?.message || 'Unexpected error' ); } finally { setLoadingMore( false ); } } useEffect(() => { loadFirstPage(); // eslint-disable-next-line react-hooks/exhaustive-deps }, [baseEndpoint]); function openPreview(row: EvidenceRow) { setPreview({ open: true, row }); } function closePreview() { setPreview({ open: false, row: null }); } const previewRow = preview.row; const kind = previewRow ? inlineKind(previewRow.mime_type) : 'unknown'; const inlineUrl = previewRow && kind === 'image' ? toWatermarkPreviewUrl(previewRow.preview_url) : previewRow?.preview_url || ''; async function startPackageJob() { setPkg({ open: true, jobId: null, state: 'starting', progress: 0, downloadUrl: null, filename: null, error: null, }); code Code download content_copy expand_less try { const res = await fetch(jobEndpoint, { method : 'POST' , headers : { 'Content-Type' : 'application/json' }, cache : 'no-store' , body : JSON .stringify({ type : type || null , device_id : deviceId || null , incident_id : incidentId || null , from : from || null , to : to || null , q : q || null , }), }); const json = await res.json(); if (!res.ok || !json.ok) throw new Error (json?.error?.message || 'Failed to start job' ); setPkg( ( p ) => ({ ...p, jobId : String (json.jobId), state : 'queued' , progress : 1 , })); } catch (e: any ) { setPkg( ( p ) => ({ ...p, state : 'failed' , error : e?.message || 'Unexpected error' })); } } async function pollJob(jobId: string) { try { const res = await fetch( /api/jobs/evidence-package/${encodeURIComponent(jobId)} , { method: 'GET', cache: 'no-store', }); code Code download content_copy expand_less const json = ( await res.json()) as JobStatusResp; if (!res.ok || !json.ok) throw new Error ((json as any )?.error?.message || 'Failed to load job' ); const state = json.job.state; const progress = Math .max( 0 , Math .min( 100 , Number (json.job.progress || 0 ))); if (state === 'completed' && json.result?.downloadUrl) { setPkg( ( p ) => ({ ...p, state, progress : 100 , downloadUrl : json.result?.downloadUrl || null , filename : json.result?.filename || null , })); return ; } if (state === 'failed' ) { setPkg( ( p ) => ({ ...p, state, progress, error : json.job.failedReason || 'Job failed' , })); return ; } setPkg( ( p ) => ({ ...p, state, progress : progress || p.progress, })); } catch (e: any ) { setPkg( ( p ) => ({ ...p, error : e?.message || 'Polling error' })); } } useEffect(() => { if (!pkg.open || !pkg.jobId) return; code Code download content_copy expand_less const id = pkg.jobId; const t = setInterval ( () => pollJob(id), 1200 ); return () => clearInterval (t); // eslint-disable-next-line react-hooks/exhaustive-deps }, [pkg.open, pkg.jobId]); return ( <div className="p-6"> <div className="flex flex-col gap-2"> <h1 className="text-xl font-semibold text-gray-900"> Evidence Vault </h1> <p className="text-sm text-gray-600"> Central evidence store for the family across all incidents. </p> </div> code Code download content_copy expand_less < div className = "mt-5 rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Filters </ div > < div className = "mt-3 grid grid-cols-1 gap-3 md:grid-cols-6" > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Type </ label > < select className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {type} onChange = {(e) => setType(e.target.value)} > < option value = "" > All </ option > < option value = "SCREENSHOT" > SCREENSHOT </ option > < option value = "AUDIO" > AUDIO </ option > < option value = "VIDEO" > VIDEO </ option > < option value = "TEXT_SNAPSHOT" > TEXT_SNAPSHOT </ option > < option value = "CAMERA_STREAM_FRAME" > CAMERA_STREAM_FRAME </ option > </ select > </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Device ID </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "dev_..." value = {deviceId} onChange = {(e) => setDeviceId(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Incident ID </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "inc_..." value = {incidentId} onChange = {(e) => setIncidentId(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > From </ label > < input type = "date" className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {from} onChange = {(e) => setFrom(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > To </ label > < input type = "date" className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" value = {to} onChange = {(e) => setTo(e.target.value)} /> </ div > < div className = "md:col-span-1" > < label className = "text-xs font-semibold text-gray-700" > Search </ label > < input className = "mt-1 w-full rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm text-gray-900" placeholder = "storage key / mime..." value = {q} onChange = {(e) => setQ(e.target.value)} /> </ div > </ div > < div className = "mt-4 flex flex-wrap gap-2" > < button className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black disabled:opacity-60" onClick = {loadFirstPage} disabled = {loading} > {loading ? 'Loading...' : 'Apply Filters'} </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => { setType(''); setDeviceId(''); setIncidentId(''); setFrom(''); setTo(''); setQ(''); }} > Reset </ button > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-semibold text-gray-900 hover:bg-gray-50" onClick = {startPackageJob} > Generate Evidence Package </ button > </ div > {err ? ( < div className = "mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {err} </ div > ) : null} </ div > < div className = "mt-5 rounded-2xl border border-gray-200 bg-white shadow-sm" > < div className = "w-full overflow-x-auto" > < table className = "min-w-full border-separate border-spacing-0" > < thead > < tr className = "bg-gray-50" > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Evidence </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Type </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Captured </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Size </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Hash </ th > < th className = "border-b border-gray-200 px-4 py-3 text-left text-xs font-semibold text-gray-700" > Actions </ th > </ tr > </ thead > < tbody > {loading ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > Loading evidence... </ td > </ tr > ) : items.length === 0 ? ( < tr > < td colSpan = {6} className = "px-4 py-6 text-sm text-gray-600" > No evidence found. </ td > </ tr > ) : ( items.map((x) => ( < tr key = {x.evidence_id} className = "hover:bg-gray-50" > < td className = "border-b border-gray-200 px-4 py-3" > < div className = "text-sm font-semibold text-gray-900" > {shortId(x.evidence_id)} </ div > < div className = "mt-1 font-mono text-[11px] text-gray-600 break-all" > {x.storage_key} </ div > < div className = "mt-1 text-[11px] text-gray-500" > Incident:{' '} < span className = "font-mono" > {x.incident_id ? shortId(x.incident_id) : 'N/A'} </ span > </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > < div className = "font-semibold" > {x.evidence_type} </ div > < div className = "mt-1 text-[11px] text-gray-500" > {x.mime_type} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {new Date(x.captured_at).toLocaleString()} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-sm text-gray-700" > {bytes(x.size_bytes)} </ td > < td className = "border-b border-gray-200 px-4 py-3 text-xs text-gray-700" > < div className = "break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {x.sha256_hex} </ div > </ td > < td className = "border-b border-gray-200 px-4 py-3" > < div className = "flex flex-wrap gap-2" > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => openPreview(x)} > Preview </ button > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {x.download_url} > Download </ a > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(x.sha256_hex)} > Copy Hash </ button > </ div > </ td > </ tr > )) )} </ tbody > </ table > < div className = "flex items-center justify-between px-4 py-4" > < div className = "text-xs text-gray-500" > Loaded: {items.length} </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 shadow-sm hover:bg-gray-50 disabled:opacity-50" onClick = {loadMore} disabled = {!nextCursor || loadingMore } > {loadingMore ? 'Loading...' : nextCursor ? 'Load more' : 'No more'} </ button > </ div > </ div > </ div > {preview.open && previewRow ? ( < div className = "fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4" > < div className = "w-full max-w-4xl rounded-2xl border border-gray-200 bg-white shadow-xl" > < div className = "flex items-start justify-between gap-4 border-b border-gray-200 p-4" > < div > < div className = "text-base font-semibold text-gray-900" > Evidence Preview </ div > < div className = "mt-1 text-xs text-gray-600 break-all" > {previewRow.storage_key} </ div > </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {closePreview} > Close </ button > </ div > < div className = "p-4" > < div className = "grid grid-cols-1 gap-4 md:grid-cols-2" > < div className = "rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-xs text-gray-600" > Type: < span className = "font-semibold text-gray-900" > {previewRow.evidence_type} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > MIME: < span className = "font-mono text-gray-900" > {previewRow.mime_type} </ span > </ div > < div className = "mt-2 text-xs text-gray-600" > SHA-256: < div className = "mt-1 break-all rounded-xl border border-gray-200 bg-white px-3 py-2 font-mono text-[11px] text-gray-800" > {previewRow.sha256_hex} </ div > </ div > < div className = "mt-4 flex flex-wrap gap-2" > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {previewRow.download_url} > Download </ a > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => navigator.clipboard.writeText(previewRow.sha256_hex)} > Copy Hash </ button > </ div > </ div > < div className = "rounded-2xl border border-gray-200 bg-white p-4" > < div className = "text-sm font-semibold text-gray-900" > Inline Preview </ div > < div className = "mt-2 text-xs text-gray-600" > Images are watermarked on preview only. Audio/Video use range streaming. </ div > < div className = "mt-3 rounded-2xl border border-gray-200 bg-gray-50 p-3" > {kind === 'image' ? ( // eslint-disable-next-line @next/next/no-img-element < img src = {inlineUrl} alt = "evidence preview" className = "h-auto w-full rounded-xl border border-gray-200 bg-white" /> ) : kind === 'audio' ? ( < audio controls className = "w-full" preload = "metadata" src = {inlineUrl} /> ) : kind === 'video' ? ( < video controls className = "w-full rounded-xl border border-gray-200 bg-black" preload = "metadata" src = {inlineUrl} /> ) : ( < div className = "text-sm text-gray-700" > Inline preview not supported for this MIME type. </ div > )} </ div > </ div > </ div > < div className = "mt-4" > < HashVerifier expectedSha256 = {previewRow.sha256_hex} /> </ div > < div className = "mt-3 text-xs text-gray-500" > Preview and download are signed, rate-limited, and audited (custody chain). </ div > </ div > </ div > </ div > ) : null} {pkg.open ? ( < div className = "fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4" > < div className = "w-full max-w-xl rounded-2xl border border-gray-200 bg-white shadow-xl" > < div className = "flex items-start justify-between gap-4 border-b border-gray-200 p-4" > < div > < div className = "text-base font-semibold text-gray-900" > Evidence Package </ div > < div className = "mt-1 text-xs text-gray-600" > Job: < span className = "font-mono" > {pkg.jobId || 'starting...'} </ span > </ div > </ div > < button className = "rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-50" onClick = {() => setPkg((p) => ({ ...p, open: false }))} > Close </ button > </ div > < div className = "p-4" > < div className = "text-sm text-gray-700" > State: < span className = "font-semibold text-gray-900" > {pkg.state} </ span > </ div > < div className = "mt-3 h-3 w-full overflow-hidden rounded-full bg-gray-100" > < div className = "h-3 bg-gray-900" style = {{ width: `${ pkg.progress }%` }} /> </ div > < div className = "mt-2 text-xs text-gray-600" > Progress: < span className = "font-mono" > {pkg.progress}% </ span > </ div > {pkg.error ? ( < div className = "mt-3 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700" > {pkg.error} </ div > ) : null} {pkg.downloadUrl ? ( < div className = "mt-4 flex flex-wrap items-center gap-2" > < a className = "rounded-xl bg-gray-900 px-3 py-2 text-sm font-semibold text-white hover:bg-black" href = {pkg.downloadUrl} > Download ZIP </ a > < div className = "text-xs text-gray-600" > File: < span className = "font-mono" > {pkg.filename || 'evidence_package.zip'} </ span > </ div > </ div > ) : ( < div className = "mt-4 text-xs text-gray-500" > The package is being built in the background. Keep this window open. </ div > )} </ div > </ div > </ div > ) : null} </ div > ); } [6] متغيرات بيئة جديدة (Queue + Manifest Signing) Table: ENV جديد Env Example Required Purpose QUEUE_REDIS_URL redis://localhost:6379 Yes BullMQ queue EVIDENCE_PACKAGES_DIR evidence_packages Yes أين تُخزن ZIP محليًا MANIFEST_SIGN_PRIVATE_KEY_PEM -----BEGIN PRIVATE KEY-----... Yes توقيع manifest MANIFEST_SIGN_PUBLIC_KEY_PEM -----BEGIN PUBLIC KEY-----... Yes تحقق التوقيع [7] Legal Hold + Retention Guard (تصميم جاهز للمرحلة القادمة) الآن أنت تمتلك بنية custody قوية… الخطوة الأمنية المؤسسية التالية هي: أي Incident بمستوى High severity → Legal Hold تلقائي Legal Hold يمنع حذف الأدلة حتى للأب إلا عبر إجراء رسمي (2FA + reason + audit) إذا تريد أكملها مباشرة الآن سأبني: family_policy (Retention + legalHold flags) api/evidence/delete مع enforcement كامل واجهة UI لطلب رفع legalHold أو فكّه (صلاحية الأب فقط + approval flow) [8] Suggested Next Steps [8.1] إضافة Download Verification Page: صفحة تتحقق من manifest signature + hashes محليًا بعد التحميل. [8.2] نقل ZIP storage إلى S3/R2 بدل Local (مع signed URL). [8.3] إضافة SIEM Export Hook (Webhook إلى Splunk/ELK) للأحداث الحساسة فقط.
[159] نسيت كلمة المرور لا يرسل رسالة لبريد المستخدم
[160] ارسل رابط تعديل firebase
[161] أي مشروع؟ Screenshot_20260124_015100_Chrome.jpg
[162] لكن الرسالة وصلت في spam
[163] كيف يمكن تفعيل رقم الهاتف والتحقق برسائل sms
[164] هل تفعيل الخدمة يتطلت أي مبالغ أو ترقيات؟
[165] يحتاج مزيدا من الخطوات Screenshot_20260124_021921_Chrome.jpg
[166] لقد قمت بإستعادة نسخة مستقرة الآن أولا قم بمراجعة جميع ملفات النسخة الحالية لنقوم بالتعديل عليها حسب تعليماتي الآتية
[167] لقد قمت بإستعادة نسخة مستقرة الآن أولا قم بمراجعة جميع ملفات النسخة الحالية لنقوم بالتعديل عليها حسب تعليماتي الآتية
[168] أريد إضافة أزرار تحكم في جميع مميزات التطبيق تكون في قسم خاص في إعدادات التطبيق
[169] أضف أزرار تحكم في إظهار شاشة التنبيهات بصورة مؤقتة Screenshot_20260205_102520_Chrome.jpg
[170] أضف زر تعطيل الشاشة الحمراء أو إعادة تفعيلها يكون في أعلى الشاشة الحمراء
[171] مطلوب استرجاع عناصر صفحة الإعدادات المتقدمة مثل مجموعة الأمان تغيير كلمة المرور المصادقة الثنائية مجموعة أفراد الأسرة إضافة طفل أو مشرف تعديل فرد الأسرة بجميع بياناته وأيضا أفاتار إضافة inline modal زر تعديل أو حذف العضو إرجاع مكتبة أفاتار الموجودة مسبقا في assets ربط جهاز جديد تعديل جهاز مربوط مسبقا مجموعة تحكم مطور النظام بما فيها أزرار toggle لأي وظيفة في التطبيق بحيث يمكن تفعيل أو تعطيل أي وظيفة بصورة فردية
[172] إضافة في مجموعة مطور النظام ميزة حقن أو تنظيف بيانات وهمية وتكون اختيارية يمكن أن تكون لكل جزء بصورة فردية مثل أجهزة أو أفراد أو حالات تم اكتشافها أو بلاغات قيد التحقيق أو جديدة أو منتهية أو لجميع الأجزاء دفعة واحدة
[173] مطلوب تعديل مكتبة افاتار لتكون محتوياتها مطابقة للمرفق وجعل المكتبة ثابتة في جميع الاصدارات وإضافة استعراص صورة من الجهاز لاختيارها حسب رغبة المستخدم الأفضل حفظ المكتبة في قاعدة البيانات لضمان الاستدامة في حالة تعديل الملفات attach_file avatar_library_assets.ts .txt
[174] Fix the following errors: code Code download content_copy expand_less Uncaught SyntaxError : Invalid or unexpected token
[175] Fix the following errors: code Code download content_copy expand_less Uncaught SyntaxError : Invalid or unexpected token
[176] Fix the following errors: code Code download content_copy expand_less Uncaught SyntaxError : Invalid or unexpected token
[177] Fix the following errors: code Code download content_copy expand_less Uncaught SyntaxError : Invalid or unexpected token
[178] There was an unexpected error. Finish what you were doing.
[179] Fix the following errors: code Code download content_copy expand_less Uncaught SyntaxError : Invalid or unexpected token
[180] Fix the following errors: code Code download content_copy expand_less Uncaught SyntaxError : Invalid or unexpected token
[181] Fix the following errors: code Code download content_copy expand_less Uncaught SyntaxError : Invalid or unexpected token
[182] لقد استرجعت نسخة مستقرة ما معنى "Firestore Alerts Error (Check Indexes):" "The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg " Warning "Firestore Alerts Error (Check Indexes):" "The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/amanah-protect/firestore/indexes?create_composite=Ck1wcm9qZWN0cy9hbWFuYWgtcHJvdGVjdC9kYXRhYmFzZXMvKGRlZmF1bHQpL2NvbGxlY3Rpb25Hcm91cHMvYWxlcnRzL2luZGV4ZXMvXxABGgwKCHBhcmVudElkEAEaDQoJdGltZXN0YW1wEAIaDAoIX19uYW1lX18QAg " Warnin
[183] Warning "Failed to load the app. Try reloading it."
[184] ما زالت نفس رسالة التحذير موجودة التطبيق مجرد صفحة بيضاء Screenshot_20260206_085130_Chrome.jpg
[185] لقد تلقيت رسالة بريد إلكتروني من Firebase Firebase Amanah-Protect [Firebase] Client access to your Cloud Firestore database expiring in 1 day(s) You chose to start developing in Test Mode, which leaves your Cloud Firestore database completely open to the Internet. Because your app is vulnerable to attackers, your Firestore security rules were configured to stop allowing requests after the first 30 days. In 1 day(s), all client requests to your Firestore database will be denied. Before that time, please write strong security rules that allow your app to function while appropriately protecting your data. Analysis is run daily; if you've modified your rules in the last 24 hours those changes may not be accounted for. Expiring Rules Amanah-Protect Database (default) Learn about security rulesEdit rules ما الحل هنا؟
[186] ما زال التطبيق شاشة Screenshot_20260206_090518_Chrome.jpg
[187] Fix the following errors: code Code download content_copy expand_less [ 2026 - 02 -06T06: 15 : 48. 708Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=permission-denied]: Missing or insufficient permissions.
[188] Fix the following errors: code Code download content_copy expand_less [ 2026 - 02 -06T06: 26 : 20. 671Z] @firebase /firestore: Firestore ( 10.8 .0 ): Uncaught Error in snapshot listener: FirebaseError: [code=permission-denied]: Missing or insufficient permissions.
[189] لقد قمت باسترجاع نسخة مستقرة قم بمراجعة الملفات الآن
[190] لماذا قمت بتعديل النسخة المستقرة؟ بعد تعديلك التطبيق لا يعمل
[191] لا يعمل
[192] قم بإضافة زر تعطيل شاشة تنبيه الطوارئ أو جعلها مجرد إشعار image.png
[193] زر تعطيل شاشة تنبيه الطوارئ أو جعلها مجرد إشعار يجب أن يقوم بتعطيل كافة إشعارات تنبيه الطوارئ وليس فقط التنبيه الحالي
[194] عند الضغط على زر تعطيل شاشة التنبيه يجب أن يتم تحويل جميع تنبيهات الطوارئ إلى مجرد أشعارات لا تغير أي شئ آخر
[195] ما زالت شاشة التنبيه الحرج تظهر والمطلوب تعطيلها مؤقتا لجميع التنبيهات لا تغير أي شئ آخر
[196] هناك خطأ قم بإرجاع ما عدلته فقط ولا تغير أي شئ آخر image.png
[197] اجعل إشعارات الطوارئ تختفي ذاتيا بعد ثانيتين
[198] flag Restored from Automatic snapshot
